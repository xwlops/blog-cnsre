---
title: "ä½¿ç”¨kubeadmå®‰è£…kubernetes 1.21"
date: 2021-06-02T10:36:12+08:00
description: ä½¿ç”¨kubeadmå®‰è£…kubernetes 1.21
draft: false
#true ä¸ºéšè—æ–‡ç«  falseå±•ç¤º
#hideToc: false
#å¦‚ true åˆ™ä¼šéšè—ç›®å½•
#enableToc: true
#å¦‚ true åˆ™ä¼šç”Ÿæˆç›®å½•
#enableTocContent: true
#å¦‚ true åˆ™ä¼šç”Ÿæˆç›®å½•å†…å®¹
#pinned: true  
#å›ºå®šæ–‡ç« 
#weight: 10000
#æ–‡ç« æ’åºæƒé‡
keywords:
#å…³é”®è¯
- kubeadmå®‰è£…kubernetes 1.21
- å®‰è£…kubernetes 1.21
author: CNSRE    
#ä½œè€…
authorEmoji: âœ
tags:
- kubeadm
- kubernetes
categories:
- kubernetes
#series:
#- ç³»åˆ—
image: https://cn-north-1-image.s3.cn-north-1.amazonaws.com.cn/cnsre/cnsre/kubernetes.png
#æ ‡é¢˜å›¾ç‰‡åœ°å€
---

---
> ä½œè€…ï¼š[SREè¿ç»´åšå®¢](https://www.cnsre.cn/)
> åšå®¢åœ°å€ï¼š[https://www.cnsre.cn](https://www.cnsre.cn/)
> æ–‡ç« åœ°å€ï¼š[https://www.cnsre.cn/posts/210602036084/](https://www.cnsre.cn/posts/210602036084/)
> ç›¸å…³è¯é¢˜ï¼š[https://www.cnsre.cn/tags/kubernetes/](https://www.cnsre.cn/tags/kubernetes/)
---

## é…ç½®è¦æ±‚
- è‡³å°‘2å° 2æ ¸4G çš„æœåŠ¡å™¨
- æœ¬æ–‡æ¡£ä¸­ï¼ŒCPUå¿…é¡»ä¸º x86æ¶æ„
- CentOS 7.8 æˆ– CentOS Stream 8
### å®‰è£…åçš„è½¯ä»¶ç‰ˆæœ¬ä¸º
- Kubernetes v1.21.x
  * calico 3.17.1
  * nginx-ingress 1.9.1
- Containerd.io  1.4.3
### æ“ä½œç³»ç»Ÿå…¼å®¹æ€§
CentOSç‰ˆæœ¬	|æœ¬æ–‡æ¡£æ˜¯å¦å…¼å®¹	|å¤‡æ³¨
---|---|---
CentOS Stream 8	|ğŸ˜„|	å·²éªŒè¯
CentOS 7.8	|ğŸ˜„|	å·²éªŒè¯
CentOS 7.7|	ğŸ˜	|æœªéªŒè¯
CentOS 7.6	|ğŸ˜|	æœªéªŒè¯

![cnsreè¿ç»´åšå®¢|Linuxç³»ç»Ÿè¿ç»´|è‡ªåŠ¨åŒ–è¿ç»´|äº‘è®¡ç®—|è¿ç»´ç›‘æ§](https://cn-north-1-image.s3.cn-north-1.amazonaws.com.cn/cnsre/cnsre/20210602145933.png)

{{< notice success "Container Runtime" >}} 
 
- Kubernetes v1.21 å¼€å§‹ï¼Œé»˜è®¤ç§»é™¤ docker çš„ä¾èµ–ï¼Œå¦‚æœå®¿ä¸»æœºä¸Šå®‰è£…äº† docker å’Œ containerdï¼Œå°†ä¼˜å…ˆä½¿ç”¨ docker ä½œä¸ºå®¹å™¨è¿è¡Œå¼•æ“ï¼Œå¦‚æœå®¿ä¸»æœºä¸Šæœªå®‰è£… docker åªå®‰è£…äº† containerdï¼Œå°†ä½¿ç”¨ containerd ä½œä¸ºå®¹å™¨è¿è¡Œå¼•æ“ï¼›
- æœ¬æ–‡ä½¿ç”¨ containerd ä½œä¸ºå®¹å™¨è¿è¡Œå¼•æ“ï¼›
{{< /notice >}}

{{< notice success "å…³äºäºŒè¿›åˆ¶å®‰" >}}  
- kubeadm æ˜¯ Kubernetes å®˜æ–¹æ”¯æŒçš„å®‰è£…æ–¹å¼ï¼Œâ€œäºŒè¿›åˆ¶â€ ä¸æ˜¯ã€‚æœ¬æ–‡æ¡£é‡‡ç”¨ kubernetes.io å®˜æ–¹æ¨èçš„ kubeadm å·¥å…·å®‰è£… kubernetes é›†ç¾¤ã€‚
{{< /notice >}}
## æ£€æŸ¥ centos / hostname
``` shell
# åœ¨ master èŠ‚ç‚¹å’Œ worker èŠ‚ç‚¹éƒ½è¦æ‰§è¡Œ
cat /etc/redhat-release

# æ­¤å¤„ hostname çš„è¾“å‡ºå°†ä¼šæ˜¯è¯¥æœºå™¨åœ¨ Kubernetes é›†ç¾¤ä¸­çš„èŠ‚ç‚¹åå­—
# ä¸èƒ½ä½¿ç”¨ localhost ä½œä¸ºèŠ‚ç‚¹çš„åå­—
hostname

# è¯·ä½¿ç”¨ lscpu å‘½ä»¤ï¼Œæ ¸å¯¹ CPU ä¿¡æ¯
# Architecture: x86_64    æœ¬å®‰è£…æ–‡æ¡£ä¸æ”¯æŒ arm æ¶æ„
# CPU(s):       2         CPU å†…æ ¸æ•°é‡ä¸èƒ½ä½äº 2
lscpu
```
### ä¿®æ”¹ hostname
``` shell
# ä¿®æ”¹ hostname
hostnamectl set-hostname your-new-host-name
# æŸ¥çœ‹ä¿®æ”¹ç»“æœ
hostnamectl status
# è®¾ç½® hostname è§£æ
echo "127.0.0.1   $(hostname)" >> /etc/hosts

```
## æ£€æŸ¥ç½‘ç»œ
åœ¨æ‰€æœ‰èŠ‚ç‚¹æ‰§è¡Œå‘½ä»¤
``` shell
[root@demo-master-a-1 ~]$ ip route show
default via 172.21.0.1 dev eth0 
169.254.0.0/16 dev eth0 scope link metric 1002 
172.21.0.0/20 dev eth0 proto kernel scope link src 172.21.0.12 

[root@demo-master-a-1 ~]$ ip address
1: lo: <LOOPBACK,UP,LOWER_UP> mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000
    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
    inet 127.0.0.1/8 scope host lo
       valid_lft forever preferred_lft forever
2: eth0: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc pfifo_fast state UP group default qlen 1000
    link/ether 00:16:3e:12:a4:1b brd ff:ff:ff:ff:ff:ff
    inet 172.17.216.80/20 brd 172.17.223.255 scope global dynamic eth0
       valid_lft 305741654sec preferred_lft 305741654sec
```
{{< notice info "kubeletä½¿ç”¨çš„IPåœ°å€" >}}  
- `ip route show` å‘½ä»¤ä¸­ï¼Œå¯ä»¥çŸ¥é“æœºå™¨çš„é»˜è®¤ç½‘å¡ï¼Œé€šå¸¸æ˜¯ `eth0`ï¼Œå¦‚ default via 172.21.0.23 dev eth0
- `ip address` å‘½ä»¤ä¸­ï¼Œå¯æ˜¾ç¤ºé»˜è®¤ç½‘å¡çš„ IP åœ°å€ï¼ŒKubernetes å°†ä½¿ç”¨æ­¤ IP åœ°å€ä¸é›†ç¾¤å†…çš„å…¶ä»–èŠ‚ç‚¹é€šä¿¡ï¼Œå¦‚ `172.17.216.80`
- æ‰€æœ‰èŠ‚ç‚¹ä¸Š Kubernetes æ‰€ä½¿ç”¨çš„ IP åœ°å€å¿…é¡»å¯ä»¥äº’é€šï¼ˆæ— éœ€ NAT æ˜ å°„ã€æ— å®‰å…¨ç»„æˆ–é˜²ç«å¢™éš”ç¦»ï¼‰
{{< /notice >}}
## å®‰è£…
{{< notice warning "" >}} 
**ä½¿ç”¨ root èº«ä»½åœ¨æ‰€æœ‰èŠ‚ç‚¹æ‰§è¡Œå¦‚ä¸‹ä»£ç ï¼Œä»¥å®‰è£…è½¯ä»¶ï¼š**
- containerd
- nfs-utils
- kubectl / kubeadm / kubelet
{{< /notice >}}
{{< tabs å¿«é€Ÿå®‰è£… æ‰‹åŠ¨å®‰è£…  >}}
{{< tab >}}
_è¯·å°†è„šæœ¬æœ€åçš„ 1.21.0 æ›¿æ¢æˆæ‚¨éœ€è¦çš„ç‰ˆæœ¬å·ï¼ˆå¿…é¡»æ˜¯ 1.21 çš„å°ç‰ˆæœ¬ï¼Œä¸èƒ½æ˜¯ 1.19.1 ç­‰ï¼‰_ **è„šæœ¬ä¸­é—´çš„ v1.21.x ä¸è¦æ›¿æ¢**

**docker hub é•œåƒè¯·æ ¹æ®è‡ªå·±ç½‘ç»œçš„æƒ…å†µä»»é€‰ä¸€ä¸ª**
- ç¬¬å››è¡Œä¸ºè…¾è®¯äº‘ docker hub é•œåƒ
- ç¬¬å…­è¡Œä¸ºDaoCloud docker hub é•œåƒ
- ç¬¬å…«è¡Œä¸ºåä¸ºäº‘ docker hub é•œåƒ
- ç¬¬åè¡Œä¸ºé˜¿é‡Œäº‘ docker hub é•œåƒ
```shell
# åœ¨ master èŠ‚ç‚¹å’Œ worker èŠ‚ç‚¹éƒ½è¦æ‰§è¡Œ
# æœ€åä¸€ä¸ªå‚æ•° 1.21.0 ç”¨äºæŒ‡å®š kubenetes ç‰ˆæœ¬ï¼Œæ”¯æŒæ‰€æœ‰ 1.21.x ç‰ˆæœ¬çš„å®‰è£…
# è…¾è®¯äº‘ docker hub é•œåƒ
# export REGISTRY_MIRROR="https://mirror.ccs.tencentyun.com"
# DaoCloud é•œåƒ
# export REGISTRY_MIRROR="http://f1361db2.m.daocloud.io"
# åä¸ºäº‘é•œåƒ
# export REGISTRY_MIRROR="https://05f073ad3c0010ea0f4bc00b7105ec20.mirror.swr.myhuaweicloud.com"
# é˜¿é‡Œäº‘ docker hub é•œåƒ
export REGISTRY_MIRROR=https://registry.cn-hangzhou.aliyuncs.com
curl -sSL https://kuboard.cn/install-script/v1.21.x/install_kubelet.sh | sh -s 1.21.0
```
{{< /tab >}}
{{< tab >}}
_æ‰‹åŠ¨æ‰§è¡Œä»¥ä¸‹ä»£ç ï¼Œç»“æœä¸å¿«é€Ÿå®‰è£…ç›¸åŒã€‚_ **è¯·å°†è„šæœ¬ç¬¬79è¡Œï¼ˆå·²é«˜äº®ï¼‰çš„ ${1} æ›¿æ¢æˆæ‚¨éœ€è¦çš„ç‰ˆæœ¬å·ï¼Œä¾‹å¦‚ 1.21.0**

**docker hub é•œåƒè¯·æ ¹æ®è‡ªå·±ç½‘ç»œçš„æƒ…å†µä»»é€‰ä¸€ä¸ª**

- ç¬¬å››è¡Œä¸ºè…¾è®¯äº‘ docker hub é•œåƒ
- ç¬¬å…­è¡Œä¸ºDaoCloud docker hub é•œåƒ
- ç¬¬å…«è¡Œä¸ºé˜¿é‡Œäº‘ docker hub é•œåƒ
```shell
# åœ¨ master èŠ‚ç‚¹å’Œ worker èŠ‚ç‚¹éƒ½è¦æ‰§è¡Œ
# æœ€åä¸€ä¸ªå‚æ•° 1.21.0 ç”¨äºæŒ‡å®š kubenetes ç‰ˆæœ¬ï¼Œæ”¯æŒæ‰€æœ‰ 1.21.x ç‰ˆæœ¬çš„å®‰è£…
# è…¾è®¯äº‘ docker hub é•œåƒ
# export REGISTRY_MIRROR="https://mirror.ccs.tencentyun.com"
# DaoCloud é•œåƒ
# export REGISTRY_MIRROR="http://f1361db2.m.daocloud.io"
# é˜¿é‡Œäº‘ docker hub é•œåƒ
export REGISTRY_MIRROR=https://registry.cn-hangzhou.aliyuncs.com
```
``` shell
#!/bin/bash

# åœ¨ master èŠ‚ç‚¹å’Œ worker èŠ‚ç‚¹éƒ½è¦æ‰§è¡Œ

# å®‰è£… containerd
# å‚è€ƒæ–‡æ¡£å¦‚ä¸‹
# https://kubernetes.io/docs/setup/production-environment/container-runtimes/#containerd

cat <<EOF | sudo tee /etc/modules-load.d/containerd.conf
overlay
br_netfilter
EOF

sudo modprobe overlay
sudo modprobe br_netfilter

# Setup required sysctl params, these persist across reboots.
cat <<EOF | sudo tee /etc/sysctl.d/99-kubernetes-cri.conf
net.bridge.bridge-nf-call-iptables  = 1
net.ipv4.ip_forward                 = 1
net.bridge.bridge-nf-call-ip6tables = 1
EOF

# Apply sysctl params without reboot
sysctl --system

# å¸è½½æ—§ç‰ˆæœ¬
yum remove -y containerd.io

# è®¾ç½® yum repository
yum install -y yum-utils device-mapper-persistent-data lvm2
yum-config-manager --add-repo https://download.docker.com/linux/centos/docker-ce.repo

# å®‰è£… containerd
yum install -y containerd.io-1.4.3

mkdir -p /etc/containerd
containerd config default > /etc/containerd/config.toml

sed -i "s#k8s.gcr.io#registry.aliyuncs.com/k8sxio#g"  /etc/containerd/config.toml
sed -i '/containerd.runtimes.runc.options/a\ \ \ \ \ \ \ \ \ \ \ \ SystemdCgroup = true' /etc/containerd/config.toml
sed -i "s#https://registry-1.docker.io#${REGISTRY_MIRROR}#g"  /etc/containerd/config.toml


systemctl daemon-reload
systemctl enable containerd
systemctl restart containerd


# å®‰è£… nfs-utils
# å¿…é¡»å…ˆå®‰è£… nfs-utils æ‰èƒ½æŒ‚è½½ nfs ç½‘ç»œå­˜å‚¨
yum install -y nfs-utils
yum install -y wget

# å…³é—­ é˜²ç«å¢™
systemctl stop firewalld
systemctl disable firewalld

# å…³é—­ SeLinux
setenforce 0
sed -i "s/SELINUX=enforcing/SELINUX=disabled/g" /etc/selinux/config

# å…³é—­ swap
swapoff -a
yes | cp /etc/fstab /etc/fstab_bak
cat /etc/fstab_bak |grep -v swap > /etc/fstab

# é…ç½®K8Sçš„yumæº
cat <<EOF > /etc/yum.repos.d/kubernetes.repo
[kubernetes]
name=Kubernetes
baseurl=http://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64
enabled=1
gpgcheck=0
repo_gpgcheck=0
gpgkey=http://mirrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg
       http://mirrors.aliyun.com/kubernetes/yum/doc/rpm-package-key.gpg
EOF

# å¸è½½æ—§ç‰ˆæœ¬
yum remove -y kubelet kubeadm kubectl

# å®‰è£…kubeletã€kubeadmã€kubectl
# å°† ${1} æ›¿æ¢ä¸º kubernetes ç‰ˆæœ¬å·ï¼Œä¾‹å¦‚ 1.20.1
yum install -y kubelet-${1} kubeadm-${1} kubectl-${1}

crictl config runtime-endpoint /run/containerd/containerd.sock

# é‡å¯ dockerï¼Œå¹¶å¯åŠ¨ kubelet
systemctl daemon-reload
systemctl enable kubelet && systemctl start kubelet

containerd --version
kubelet --version
```
{{< notice warning "æ³¨æ„" >}}  
å¦‚æœæ­¤æ—¶æ‰§è¡Œ systemctl status kubelet å‘½ä»¤ï¼Œå°†å¾—åˆ° kubelet å¯åŠ¨å¤±è´¥çš„é”™è¯¯æç¤ºï¼Œè¯·å¿½ç•¥æ­¤é”™è¯¯ï¼Œå› ä¸ºå¿…é¡»å®Œæˆåç»­æ­¥éª¤ä¸­ kubeadm init çš„æ“ä½œï¼Œkubelet æ‰èƒ½æ­£å¸¸å¯åŠ¨
{{< /notice >}}
{{< /tab >}}
{{< /tabs >}}

## åˆå§‹åŒ– master èŠ‚ç‚¹
{{< notice warning "å…³äºåˆå§‹åŒ–æ—¶ç”¨åˆ°çš„ç¯å¢ƒå˜é‡" >}}  
- APISERVER_NAME ä¸èƒ½æ˜¯ master çš„ hostname
- APISERVER_NAME å¿…é¡»å…¨ä¸ºå°å†™å­—æ¯ã€æ•°å­—ã€å°æ•°ç‚¹ï¼Œä¸èƒ½åŒ…å«å‡å·
- POD_SUBNET æ‰€ä½¿ç”¨çš„ç½‘æ®µä¸èƒ½ä¸ masterèŠ‚ç‚¹/workerèŠ‚ç‚¹ æ‰€åœ¨çš„ç½‘æ®µé‡å ã€‚è¯¥å­—æ®µçš„å–å€¼ä¸ºä¸€ä¸ª CIDR å€¼ï¼Œå¦‚æœæ‚¨å¯¹ CIDR è¿™ä¸ªæ¦‚å¿µè¿˜ä¸ç†Ÿæ‚‰ï¼Œè¯·ä»ç„¶æ‰§è¡Œ export POD_SUBNET=10.100.0.1/16 å‘½ä»¤ï¼Œä¸åšä¿®æ”¹
{{< /notice >}}

{{< tabs å¿«é€Ÿåˆå§‹åŒ– æ‰‹åŠ¨åˆå§‹åŒ–  >}}
{{< tab >}}
_è¯·å°†è„šæœ¬æœ€åçš„ 1.21.0 æ›¿æ¢æˆæ‚¨éœ€è¦çš„ç‰ˆæœ¬å·ï¼ˆå¿…é¡»æ˜¯ 1.21 çš„å°ç‰ˆæœ¬ï¼Œä¸èƒ½æ˜¯ 1.19.1 ç­‰ï¼‰_ **è„šæœ¬ä¸­é—´çš„ v1.21.x ä¸è¦æ›¿æ¢**
```shell
# åªåœ¨ master èŠ‚ç‚¹æ‰§è¡Œ
# æ›¿æ¢ x.x.x.x ä¸º master èŠ‚ç‚¹å®é™… IPï¼ˆè¯·ä½¿ç”¨å†…ç½‘ IPï¼‰
# export å‘½ä»¤åªåœ¨å½“å‰ shell ä¼šè¯ä¸­æœ‰æ•ˆï¼Œå¼€å¯æ–°çš„ shell çª—å£åï¼Œå¦‚æœè¦ç»§ç»­å®‰è£…è¿‡ç¨‹ï¼Œè¯·é‡æ–°æ‰§è¡Œæ­¤å¤„çš„ export å‘½ä»¤
export MASTER_IP=x.x.x.x
# æ›¿æ¢ apiserver.demo ä¸º æ‚¨æƒ³è¦çš„ dnsName
export APISERVER_NAME=apiserver.demo
# Kubernetes å®¹å™¨ç»„æ‰€åœ¨çš„ç½‘æ®µï¼Œè¯¥ç½‘æ®µå®‰è£…å®Œæˆåï¼Œç”± kubernetes åˆ›å»ºï¼Œäº‹å…ˆå¹¶ä¸å­˜åœ¨äºæ‚¨çš„ç‰©ç†ç½‘ç»œä¸­
export POD_SUBNET=10.100.0.1/16
echo "${MASTER_IP}    ${APISERVER_NAME}" >> /etc/hosts
curl -sSL https://kuboard.cn/install-script/v1.21.x/init_master.sh | sh -s 1.21.0
```
{{< /tab >}}
{{< tab >}}
_æ‰‹åŠ¨æ‰§è¡Œä»¥ä¸‹ä»£ç ï¼Œç»“æœä¸å¿«é€Ÿå®‰è£…ç›¸åŒã€‚_ **è¯·å°†è„šæœ¬ç¬¬79è¡Œï¼ˆå·²é«˜äº®ï¼‰çš„ ${1} æ›¿æ¢æˆæ‚¨éœ€è¦çš„ç‰ˆæœ¬å·ï¼Œä¾‹å¦‚ 1.21.0**
```shell
# åªåœ¨ master èŠ‚ç‚¹æ‰§è¡Œ
# æ›¿æ¢ x.x.x.x ä¸º master èŠ‚ç‚¹çš„å†…ç½‘IP
# export å‘½ä»¤åªåœ¨å½“å‰ shell ä¼šè¯ä¸­æœ‰æ•ˆï¼Œå¼€å¯æ–°çš„ shell çª—å£åï¼Œå¦‚æœè¦ç»§ç»­å®‰è£…è¿‡ç¨‹ï¼Œè¯·é‡æ–°æ‰§è¡Œæ­¤å¤„çš„ export å‘½ä»¤
export MASTER_IP=x.x.x.x
# æ›¿æ¢ apiserver.demo ä¸º æ‚¨æƒ³è¦çš„ dnsName
export APISERVER_NAME=apiserver.demo
# Kubernetes å®¹å™¨ç»„æ‰€åœ¨çš„ç½‘æ®µï¼Œè¯¥ç½‘æ®µå®‰è£…å®Œæˆåï¼Œç”± kubernetes åˆ›å»ºï¼Œäº‹å…ˆå¹¶ä¸å­˜åœ¨äºæ‚¨çš„ç‰©ç†ç½‘ç»œä¸­
export POD_SUBNET=10.100.0.1/16
echo "${MASTER_IP}    ${APISERVER_NAME}" >> /etc/hosts
```
``` shell
#!/bin/bash

# åªåœ¨ master èŠ‚ç‚¹æ‰§è¡Œ

# è„šæœ¬å‡ºé”™æ—¶ç»ˆæ­¢æ‰§è¡Œ
set -e

if [ ${#POD_SUBNET} -eq 0 ] || [ ${#APISERVER_NAME} -eq 0 ]; then
  echo -e "\033[31;1mè¯·ç¡®ä¿æ‚¨å·²ç»è®¾ç½®äº†ç¯å¢ƒå˜é‡ POD_SUBNET å’Œ APISERVER_NAME \033[0m"
  echo å½“å‰POD_SUBNET=$POD_SUBNET
  echo å½“å‰APISERVER_NAME=$APISERVER_NAME
  exit 1
fi


# æŸ¥çœ‹å®Œæ•´é…ç½®é€‰é¡¹ https://godoc.org/k8s.io/kubernetes/cmd/kubeadm/app/apis/kubeadm/v1beta2
rm -f ./kubeadm-config.yaml
cat <<EOF > ./kubeadm-config.yaml
---
apiVersion: kubeadm.k8s.io/v1beta2
kind: ClusterConfiguration
kubernetesVersion: v${1}
imageRepository: registry.aliyuncs.com/k8sxio
controlPlaneEndpoint: "${APISERVER_NAME}:6443"
networking:
  serviceSubnet: "10.96.0.0/16"
  podSubnet: "${POD_SUBNET}"
  dnsDomain: "cluster.local"
dns:
  type: CoreDNS
  imageRepository: swr.cn-east-2.myhuaweicloud.com${2}
  imageTag: 1.8.0

---
apiVersion: kubelet.config.k8s.io/v1beta1
kind: KubeletConfiguration
cgroupDriver: systemd
EOF

# kubeadm init
# æ ¹æ®æ‚¨æœåŠ¡å™¨ç½‘é€Ÿçš„æƒ…å†µï¼Œæ‚¨éœ€è¦ç­‰å€™ 3 - 10 åˆ†é’Ÿ
echo ""
echo "æŠ“å–é•œåƒï¼Œè¯·ç¨å€™..."
kubeadm config images pull --config=kubeadm-config.yaml
echo ""
echo "åˆå§‹åŒ– Master èŠ‚ç‚¹"
kubeadm init --config=kubeadm-config.yaml --upload-certs

# é…ç½® kubectl
rm -rf /root/.kube/
mkdir /root/.kube/
cp -i /etc/kubernetes/admin.conf /root/.kube/config

# å®‰è£… calico ç½‘ç»œæ’ä»¶
# å‚è€ƒæ–‡æ¡£ https://docs.projectcalico.org/v3.13/getting-started/kubernetes/self-managed-onprem/onpremises
echo ""
echo "å®‰è£…calico-3.17.1"
rm -f calico-3.17.1.yaml
kubectl create -f https://kuboard.cn/install-script/v1.21.x/calico-operator.yaml
wget https://kuboard.cn/install-script/v1.21.x/calico-custom-resources.yaml
sed -i "s#192.168.0.0/16#${POD_SUBNET}#" calico-custom-resources.yaml
kubectl create -f calico-custom-resources.yaml
```
{{< /tab >}}
{{< /tabs >}}
### æ£€æŸ¥ master åˆå§‹åŒ–ç»“æœ
``` shell
# åªåœ¨ master èŠ‚ç‚¹æ‰§è¡Œ

# æ‰§è¡Œå¦‚ä¸‹å‘½ä»¤ï¼Œç­‰å¾… 3-10 åˆ†é’Ÿï¼Œç›´åˆ°æ‰€æœ‰çš„å®¹å™¨ç»„å¤„äº Running çŠ¶æ€
watch kubectl get pod -n kube-system -o wide

# æŸ¥çœ‹ master èŠ‚ç‚¹åˆå§‹åŒ–ç»“æœ
kubectl get nodes -o wide
```
## åˆå§‹åŒ– workerèŠ‚ç‚¹
### è·å¾— joinå‘½ä»¤å‚æ•°
åœ¨ master èŠ‚ç‚¹ä¸Šæ‰§è¡Œ
``` shell
# åªåœ¨ master èŠ‚ç‚¹æ‰§è¡Œ
kubeadm token create --print-join-command
# è¿”å›å¦‚ä¸‹
kubeadm join apiserver.demo:6443 --token 9ukzcs.qp4ozxbn1knc13sx --discovery-token-ca-cert-hash sha256:0cb945ea0c6329b4df58cf358e2be697fd31a85f55c23d47356f06f69a27283d 
```

{{< notice success "æœ‰æ•ˆæ—¶é—´" >}}  
è¯¥ token çš„æœ‰æ•ˆæ—¶é—´ä¸º 2 ä¸ªå°æ—¶ï¼Œ2å°æ—¶å†…ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨æ­¤ token åˆå§‹åŒ–ä»»æ„æ•°é‡çš„ worker èŠ‚ç‚¹ã€‚
{{< /notice >}}
### åˆå§‹åŒ–worker
**é’ˆå¯¹æ‰€æœ‰çš„ worker èŠ‚ç‚¹æ‰§è¡Œ**
``` shell
# åªåœ¨ worker èŠ‚ç‚¹æ‰§è¡Œ
# æ›¿æ¢ x.x.x.x ä¸º master èŠ‚ç‚¹çš„å†…ç½‘ IP
export MASTER_IP=x.x.x.x
# æ›¿æ¢ apiserver.demo ä¸ºåˆå§‹åŒ– master èŠ‚ç‚¹æ—¶æ‰€ä½¿ç”¨çš„ APISERVER_NAME
export APISERVER_NAME=apiserver.demo
echo "${MASTER_IP}    ${APISERVER_NAME}" >> /etc/hosts

# æ›¿æ¢ä¸º master èŠ‚ç‚¹ä¸Š kubeadm token create å‘½ä»¤çš„è¾“å‡º
kubeadm join apiserver.demo:6443 --token 9ukzcs.qp4ozxbn1knc13sx --discovery-token-ca-cert-hash sha256:0cb945ea0c6329b4df58cf358e2be697fd31a85f55c23d47356f06f69a27283d 
```
### æ£€æŸ¥åˆå§‹åŒ–ç»“æœ
åœ¨ master èŠ‚ç‚¹ä¸Šæ‰§è¡Œ
``` shell
# åªåœ¨ master èŠ‚ç‚¹æ‰§è¡Œ
kubectl get nodes -o wide
# è¾“å‡ºç»“æœå¦‚ä¸‹æ‰€ç¤º
[root@master ~]# kubectl get nodes
NAME     STATUS   ROLES                  AGE   VERSION
master   Ready    control-plane,master   54m   v1.21.0
node1    Ready    <none>                 35m   v1.21.0
```
## å®‰è£… Ingress Controller
{{< tabs å¿«é€Ÿå®‰è£… å¸è½½IngressController  >}}
{{< tab >}}
**åœ¨ master èŠ‚ç‚¹ä¸Šæ‰§è¡Œ**
éƒ¨åˆ†æƒ…å†µä¸‹ï¼Œä¸‹é¢çš„è¿™æ¡æŒ‡ä»¤ï¼Œæ‚¨éœ€è¦æ‰§è¡Œä¸¤æ¬¡æ‰èƒ½æˆåŠŸã€‚
``` shell
# åªåœ¨ master èŠ‚ç‚¹æ‰§è¡Œ
kubectl apply -f https://kuboard.cn/install-script/v1.21.x/nginx-ingress.yaml
```
{{< /tab >}}
{{< tab >}}
**åœ¨ master èŠ‚ç‚¹ä¸Šæ‰§è¡Œ**

åªåœ¨æ‚¨æƒ³é€‰æ‹©å…¶ä»– Ingress Controller çš„æƒ…å†µä¸‹å¸è½½
``` shell
# åªåœ¨ master èŠ‚ç‚¹æ‰§è¡Œ
kubectl delete -f https://kuboard.cn/install-script/v1.21.x/nginx-ingress.yaml
```
{{< /tab >}}
{{< /tabs >}}
### é…ç½®åŸŸåè§£æ
å°†åŸŸå [cnsre.cn](https://www.cnsre.cn/posts/210602036084/) è§£æåˆ° demo-worker-a-2 çš„ IP åœ°å€ z.z.z.z ï¼ˆä¹Ÿå¯ä»¥æ˜¯ demo-worker-a-1 çš„åœ°å€ y.y.y.yï¼‰

### éªŒè¯é…ç½®
åœ¨æµè§ˆå™¨è®¿é—® [cnsre.cn](https://www.cnsre.cn/posts/210602036084/)ï¼Œå°†å¾—åˆ° 404 NotFound é”™è¯¯é¡µé¢

---
> ä½œè€…ï¼š[SREè¿ç»´åšå®¢](https://www.cnsre.cn/)
> åšå®¢åœ°å€ï¼š[https://www.cnsre.cn](https://www.cnsre.cn/)
> æ–‡ç« åœ°å€ï¼š[https://www.cnsre.cn/posts/210602036084/](https://www.cnsre.cn/posts/210602036084/)
> ç›¸å…³è¯é¢˜ï¼š[https://www.cnsre.cn/tags/kubernetes/](https://www.cnsre.cn/tags/kubernetes/)
---