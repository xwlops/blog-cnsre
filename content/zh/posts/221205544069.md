---
title: "ä½¿ç”¨ Lambda å‡½æ•°å°† CloudWatch Log ä¸­çš„æ—¥å¿—å½’æ¡£åˆ° S3 æ¡¶ä¸­"
date: 2022-12-06T11:48:12+08:00
description: ä½¿ç”¨ Lambda å‡½æ•°å°† cloudwatchlog ä¸­çš„æ—¥å¿—å½’æ¡£åˆ°S3 æ¡¶ä¸­
draft: false
#true ä¸ºéšè—æ–‡ç«  falseå±•ç¤º
#hideToc: false
#å¦‚ true åˆ™ä¼šéšè—ç›®å½•
#enableToc: true
#å¦‚ true åˆ™ä¼šç”Ÿæˆç›®å½•
#enableTocContent: true
#å¦‚ true åˆ™ä¼šç”Ÿæˆç›®å½•å†…å®¹
#pinned: true  
#å›ºå®šæ–‡ç« 
#weight: 10000
#æ–‡ç« æ’åºæƒé‡
password: 
#æ–‡ç« å¯†ç 
keywords: 
#å…³é”®è¯
- Lambda
- cloudwatchlog
- cloudwatchlogå½’æ¡£
- Lambda å‡½æ•°
author: CNSRE    
#ä½œè€…
authorEmoji: âœ
tags:
- aws
- lambda
- cloudwatch
categories:
- aws
- lambda
#series:
#- ç³»åˆ—
image: https://cn-north-1-image.s3.cn-north-1.amazonaws.com.cn/cnsre/logo/lambda.png
---

---
> ä½œè€…ï¼š[SREè¿ç»´åšå®¢](https://www.cnsre.cn/)
> åšå®¢åœ°å€ï¼š[https://www.cnsre.cn/](https://www.cnsre.cn/) 
> æ–‡ç« åœ°å€ï¼š[https://www.cnsre.cn/posts/221205544069/](https://www.cnsre.cn/posts/221205544069/)
> ç›¸å…³è¯é¢˜ï¼š[https://www.cnsre.cn/tags/aws/](https://www.cnsre.cn/tags/aws/)
---
èººäº†å¥½ä¹…ï¼Œè¯ˆå°¸äº†ã€‚å› ä¸ºæ¢äº†å·¥ä½œï¼Œæ‰€ä»¥æ¯”è¾ƒå¿™ä¸€ç›´æ²¡æœ‰æ—¶é—´å»æ›´æ–°åšå®¢çš„å†…å®¹ï¼ˆä¸»è¦è¿˜æ˜¯å› ä¸ºæ‡’ğŸ¤”ï¼‰
![](https://media1.giphy.com/media/P8WZZ0NYdbXAA/giphy.gif?cid=b4cf699d3clr6qwrgzfeya3tzswbivhlflyolhyiooah0k0y&rid=giphy.gif&ct=g)
è¯ä¸å¤šè¯´ ç›´æ¥ä¸Šå¹²è´§ã€‚

## éœ€æ±‚èƒŒæ™¯
æœ€è¿‘åœ¨çœ‹è´¹ç”¨çš„æ—¶å€™å‘ç°æœ‰å¾ˆå¤§ä¸€éƒ¨åˆ†è´¹ç”¨éƒ½æ˜¯ cloudwatch logä¸­å­˜å‚¨äº†å¤§é‡çš„æ•°æ®ï¼Œæ˜¯å› ä¸ºec2 å°†æ—¥å¿—ä¼ è¾“åˆ°äº†å­˜å‚¨åˆ°äº†cloudwatchä¸­ã€‚è¿™ä¸ªå­˜å‚¨çš„å¤šçš„æŸ¥è¯¢æ—¥å¿—çš„æ—¶å€™æ”¶è´¹ç‰¹åˆ«çš„é«˜ã€‚å¦å¤–ä¸€ä¸ªæ˜¯å› ä¸ºæ•°æ®åˆ†æç”¨é€”ï¼Œå¤§æ•°æ®åˆ†æçš„åŒäº‹å¦‚æœæƒ³é‚£åˆ°æ•°æ®çš„è¯ï¼Œè¿˜æ˜¯å­˜å‚¨åœ¨ S3 ä¸­æ˜¯æ¯”è¾ƒåˆ’ç®—å’Œæ–¹ä¾¿çš„ï¼Œä¸€ä¸ªæ˜¯æ‹¿å–æ•°æ®æ¯”è¾ƒæ–¹ä¾¿ï¼Œå¦å¤–ä¸€ä¸ªæ˜¯S3 å¯ä»¥æœ€å½’æ¡£å­˜å‚¨ï¼Œåé¢çš„å¤§é‡æ•°æ®å¯ä»¥åˆ†å±‚å‚¨å­˜ï¼Œä»¥æ­¤æ¥é™ä½è´¹ç”¨ã€‚
å¦‚æœä½ ä¹Ÿæƒ³å°†ä½ çš„cloudwatch ä¸­æ—¥å¿—ç»„ä¸­çš„æ—¥å¿—å­˜å‚¨åˆ°S3ä¸­çš„è¯å¯ä»¥å‚è€ƒä¸‹è¿™ç¯‡æ–‡ç« ã€‚

## å‰ç½®æ¡ä»¶
 - åˆ›å»º ä¸€ä¸ª S3 æ¡¶ï¼Œå¹¶ä¿®æ”¹æƒé™ 
 - åˆ›å»º lambda å‡½æ•°
 - æœ‰ä¸€ä¸ªCloudwatch æ—¥å¿—ç»„å¹¶ä¸”æœ‰ä¸€å¤©ä»¥ä¸Šçš„æ—¥å¿—
 - ç»™ lambdaåˆ†é…æ‰€éœ€çš„æƒé™

## åˆ›å»º S3 æ¡¶å¹¶ä¿®æ”¹æƒé™

![sreè¿ç»´|Linuxè¿ç»´|å…³é”®è¯](https://cn-north-1-image.s3.cn-north-1.amazonaws.com.cn/cnsre/cnsre/fe1735857fa4d0c1041cc85ceaa7c4c9.png)


{{< tabs å›½å†…S3æ¡¶æƒé™é…ç½® å›½å¤–S3æ¡¶æƒé™é…ç½® >}}
{{< tab >}}
### å›½å†…S3æ¡¶æƒé™é…ç½®
```yaml
{
    "Version": "2012-10-17",
    "Statement": [
        {
            "Effect": "Allow",
            "Principal": {
                "Service": "logs.cn-north-1.amazonaws.com.cn"
            },
            "Action": "s3:GetBucketAcl",
            "Resource": "arn:aws-cn:s3:::<bucket name>"
        },
        {
            "Effect": "Allow",
            "Principal": {
                "Service": "logs.cn-north-1.amazonaws.com.cn"
            },
            "Action": "s3:PutObject",
            "Resource": "arn:aws-cn:s3:::<bucket name>/*",
            "Condition": {
                "StringEquals": {
                    "s3:x-amz-acl": "bucket-owner-full-control"
                }
            }
        }
    ]
}
```
{{< /tab >}}
{{< tab >}}
### å›½å¤–S3æ¡¶æƒé™é…ç½®
```yaml
{
    "Version": "2012-10-17",
    "Statement": [
      {
          "Action": "s3:GetBucketAcl",
          "Effect": "Allow",
          "Resource": "arn:aws:s3:::<bucket name>",
          "Principal": { "Service": "logs.us-west-2.amazonaws.com" }
      },
      {
          "Action": "s3:PutObject" ,
          "Effect": "Allow",
          "Resource": "arn:aws:s3:::<bucket name>*",
          "Condition": { "StringEquals": { "s3:x-amz-acl": "bucket-owner-full-control" } },
          "Principal": { "Service": "logs.us-west-2.amazonaws.com" }
      }
    ]
}
```
{{< /tab >}}
{{< /tabs >}}

[S3 æ¡¶æƒé™æ–‡æ¡£é“¾æ¥](https://docs.aws.amazon.com/zh_cn/AmazonCloudWatch/latest/logs/S3ExportTasks.html#S3Permissions)


<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-4855142804875926"
     crossorigin="anonymous"></script>
<ins class="adsbygoogle"
     style="display:block; text-align:center;"
     data-ad-layout="in-article"
     data-ad-format="fluid"
     data-ad-client="ca-pub-4855142804875926"
     data-ad-slot="5670838583"></ins>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script>

## åˆ›å»º lambda å‡½æ•°
### åˆ›å»º lambda
```python
import boto3
import logging
import time
import datetime
import json

logger = logging.getLogger()
logger.setLevel(logging.INFO)

def export_s3_logs(bucket_name, log_group_name, log_stream_name, days_of_logs=1, timeout=1000):
    '''
    today = datetime.datetime.combine(datetime.datetime.utcnow(), datetime.datetime.min.time())
    day_end = today
    day_start = today - datetime.timedelta(days=days_of_logs)
    '''
    today = datetime.datetime.combine(datetime.datetime.utcnow() + datetime.timedelta(hours=8),
                                      datetime.datetime.min.time()) # UTC+8 

    day_end = today - datetime.timedelta(hours=8) # UTC
    day_start = today - datetime.timedelta(days=days_of_logs, hours=8) # UTC    
   
    #print(day_start)
    ts_start = '{0:.0f}'.format(((day_start - datetime.datetime(1970, 1, 1)).total_seconds())*1000)
    ts_end = '{0:.0f}'.format(((day_end - datetime.datetime(1970, 1, 1)).total_seconds())*1000)
    the_date = '/'.join([str(today.year), '0'+str(today.month)[-2:], '0'+str(today.day)[-2:]]) 
    #folder_name = '/'.join([log_group_name, log_stream_name, the_date])
    folder_name = '/'.join([log_group_name,the_date])
    client = boto3.client('logs')
    
    #print (ts_start, ts_end)#, day_start, day_end,the_date
    
    task_id = client.create_export_task(
        logGroupName=log_group_name,
        #logStreamNamePrefix=log_stream_name,
        fromTime=int(ts_start),
        to=int(ts_end),
        destination=bucket_name,
        destinationPrefix=folder_name
    )['taskId']

    i = 1
    while i<timeout:
        response = client.describe_export_tasks(
            taskId=task_id
        )

        status = response['exportTasks'][0]['status']
        if status == 'COMPLETED':
            result = True
            break
        elif status != 'RUNNING':
            result = False
            break
        i += 1
        time.sleep(interval)
    
    return result

def lambda_handler(event, context):
    region = 'cn-northwest-1' # æ—¥å¿—ç»„æ‰€åœ¨åŒºåŸŸ
    bucket_name = '<bucket name>' #åŒåŒºåŸŸå†…çš„S3æ¡¶åç§°
    log_group_name = '<log group name>' #æ—¥å¿—ç»„åç§°
    log_stream_name = '1' #é»˜è®¤å³å¯
    log_export_days = 1   #é»˜è®¤å³å¯
    export_s3_logs(bucket_name, log_group_name, log_stream_name, log_export_days)
```
### ç»™ lambda åˆ†é…æƒé™
- AmazonS3çš„è¯»å†™æƒé™
- CloudWatchLogsFullAccess

## éªŒè¯æ¡¶å†…çš„æ–‡ä»¶
æœ€åä¼šä»¥æ—¥æœŸçš„ç›®å½•å°†æ—¥å¿—å½’æ¡£èµ·æ¥ï¼Œä»¥æ–¹ä¾¿æ—¥åå¯¹å½’æ¡£æ–‡ä»¶è¿›è¡Œæ¢³ç†ã€‚
![sreè¿ç»´|Linuxè¿ç»´|å…³é”®è¯](https://cn-north-1-image.s3.cn-north-1.amazonaws.com.cn/cnsre/cnsre/b1b86970fe109d73d7bb447f505a32ca.png)

---
> ä½œè€…ï¼š[SREè¿ç»´åšå®¢](https://www.cnsre.cn/)
> åšå®¢åœ°å€ï¼š[https://www.cnsre.cn/](https://www.cnsre.cn/) 
> æ–‡ç« åœ°å€ï¼š[https://www.cnsre.cn/posts/221205544069/](https://www.cnsre.cn/posts/221205544069/)
> ç›¸å…³è¯é¢˜ï¼š[https://www.cnsre.cn/tags/aws/](https://www.cnsre.cn/tags/aws/)
---
