[{"content":" ä½œè€…ï¼šSREè¿ç»´åšå®¢\nåšå®¢åœ°å€ï¼š https://www.cnsre.cn/\næ–‡ç« åœ°å€ï¼šhttps://www.cnsre.cn/posts/211119132529/\nç›¸å…³è¯é¢˜ï¼šhttps://www.cnsre.cn/tags/k3s/\nåŒåä¸€è–…äº†å‡ ä¸ªäº‘å‚å•†çš„ç¾Šæ¯›ï¼Œä¸€å¼€å§‹æ­å»ºäº†k3sçš„å•æœºç‰ˆï¼Œåé¢å°±æƒ³ç€èƒ½ä¸èƒ½æ­å»ºä¸€ä¸ªk3sé›†ç¾¤ï¼Œç„¶åå‚è€ƒäº†è¿™ä½å¤§ä½¬çš„æ–‡ç« ï¼Œå°±è¯•ç€ç”¨ WireGuard æ¥è¿›è¡Œç»„ç½‘ã€‚å®ƒè½»é‡ã€ä¾¿æ·ã€é«˜æ•ˆï¼Œè€Œä¸”æ•°æ®å…¨ç¨‹åŠ å¯†ä¼ è¾“ï¼Œæ˜¯ä¾æ‰˜å…¬ç½‘ç»„å»ºè™šæ‹Ÿå±€åŸŸç½‘çš„ä¼˜ç§€é€‰æ‹©ã€‚\nç¯å¢ƒä»‹ç» æœåŠ¡å™¨ä»‹ç»\näº‘å‚å•† å…¬ç½‘IPåœ°å€ å†…ç½‘IPåœ°å€ è™šæ‹Ÿç½‘ç»œIPåœ°å€ æ“ä½œç³»ç»Ÿ å†…æ ¸ç‰ˆæœ¬ è…¾è®¯äº‘1 42.xx.xx.12 10.0.16.8 192.168.1.1 CentOS Linux release 7.9.2009 (Core) 5.15.2-1 è…¾è®¯äº‘2 122.xx.xxx.111 10.0.0.6 192.168.1.2 CentOS Linux release 7.9.2009 (Core) 5.15.2-1 é˜¿é‡Œäº‘ 122.xx.xx.155 172.17.0.3 192.168.1.3 CentOS Linux release 7.9.2009 (Core) 5.15.2-1 æ­å»ºå‰å‡†å¤‡ åœ¨æ­å»ºè·¨äº‘çš„ k3s é›†ç¾¤å‰ï¼Œæˆ‘ä»¬éœ€è¦æŠŠ WireGuard å®‰è£…å¥½ï¼ŒWireGuard å¯¹å†…æ ¸æ˜¯æœ‰è¦æ±‚çš„ï¼Œæ‰€ä»¥å†…æ ¸å·²ç»è¦å‡çº§åˆ° 5.15.2-1.el7.elrepo.x86_64\nåœ¨æ‰€æœ‰èŠ‚ç‚¹å¼€å¯ IP åœ°å€è½¬å‘ 1 2 3 echo \u0026#34;net.ipv4.ip_forward = 1\u0026#34; \u0026gt;\u0026gt; /etc/sysctl.conf echo \u0026#34;net.ipv4.conf.all.proxy_arp = 1\u0026#34; \u0026gt;\u0026gt; /etc/sysctl.conf sysctl -p /etc/sysctl.conf æ‰€æœ‰èŠ‚ç‚¹å¼€å¯ä¿®æ”¹ä¸»æœºåç§° 1 2 3 4 5 6 # è…¾è®¯äº‘1æ‰§è¡Œ hostnamectl set-hostname k3s-master # è…¾è®¯äº‘2æ‰§è¡Œ hostnamectl set-hostname k3s-node1 # é˜¿é‡Œäº‘æ‰§è¡Œ hostnamectl set-hostname k3s-node2 å‡çº§å†…æ ¸ å‡ ä¸ªæœåŠ¡å™¨é»˜è®¤çš„å†…æ ¸éƒ½æ˜¯ 3.10 çš„ï¼Œå®‰è£…WireGuard éœ€è¦å§å†…æ ¸å‡çº§åˆ°æ¯”è¾ƒé«˜çš„ç‰ˆæœ¬ã€‚\nå‡çº§å†…æ ¸å‰ å…ˆå‡çº§è½¯ä»¶åŒ…ï¼ˆéå¿…è¦ï¼‰\n1 yum update -y æ·»åŠ  iptables è§„åˆ™ï¼Œå…è®¸æœ¬æœºçš„ NAT è½¬æ¢ï¼š\næ‰€æœ‰èŠ‚ç‚¹éƒ½è¦æ‰§è¡Œ 1 2 3 4 iptables -A INPUT -m conntrack --ctstate RELATED,ESTABLISHED -j ACCEPT iptables -A FORWARD -m conntrack --ctstate RELATED,ESTABLISHED -j ACCEPT iptables -A FORWARD -i wg0 -o wg0 -m conntrack --ctstate NEW -j ACCEPT iptables -t nat -A POSTROUTING -s 192.168.1.1/24 -o eth0 -j MASQUERADE wg0:ä¸ºä½ å®šä¹‰çš„è™šæ‹Ÿç½‘å¡\n192.168.1.1: ä¸ºä½ çš„è™šæ‹ŸIPåœ°å€æ®µ\neth0:ä¸ºä½ çš„ç‰©ç†ç½‘å¡\nå‡çº§å†…æ ¸ æ‰€æœ‰èŠ‚ç‚¹éƒ½è¦æ‰§è¡Œ æ–¹æ³•1 æ–¹æ³•2 æ–¹æ³•3 æ–¹æ³•1ï¼š\nç›´æ¥ä¸‹è½½RPMåŒ…è¿›è¡Œå®‰è£…ã€‚\nå¦‚æœä½ æƒ³å®‰è£…å…¶ä»–å†…æ ¸ï¼Œä½ ä¹Ÿå¯ä»¥åœ¨ è¿™é‡Œä¸‹è½½\n1 2 wget https://pan.cnsre.cn/d/Package/Linux/kernel/kernel-ml-5.15.2-1.el7.elrepo.x86_64.rpm rpm -ivh kernel-ml-5.15.2-1.el7.elrepo.x86_64.rpm æ–¹æ³• 2ï¼š\nåˆ©ç”¨åŒ…ç®¡ç†å·¥å…·æ›´æ–°\n1 2 3 4 5 6 7 8 9 10 # è½½å…¥å…¬é’¥ rpm --import https://www.elrepo.org/RPM-GPG-KEY-elrepo.org # å‡çº§å®‰è£… elrepo rpm -Uvh http://www.elrepo.org/elrepo-release-7.0-5.el7.elrepo.noarch.rpm # è½½å…¥ elrepo-kernel å…ƒæ•°æ® yum --disablerepo=\\* --enablerepo=elrepo-kernel repolist # å®‰è£…æœ€æ–°ç‰ˆæœ¬çš„å†…æ ¸ yum --disablerepo=\\* --enablerepo=elrepo-kernel install kernel-ml.x86_64 -y # åˆ é™¤æ—§ç‰ˆæœ¬å·¥å…·åŒ… yum remove kernel-tools-libs.x86_64 kernel-tools.x86_64 -y æ–¹æ³•3ï¼š\né€šè¿‡æºç åŒ…ç¼–è¯‘å®‰è£….\nè¿™ç§æ–¹å¼å¯å®šåˆ¶æ€§å¼ºï¼Œä½†ä¹Ÿæ¯”è¾ƒå¤æ‚ï¼Œæœ‰éœ€è¦çš„å¯è‡ªè¡ŒæŸ¥æ‰¾èµ„æ–™å®‰è£…ï¼Œä¸‹é¢åªç»™å‡ºå„ç³»ç»Ÿç‰ˆæœ¬å†…æ ¸æºç åŒ…çš„ä¸‹è½½åœ°å€\nä¿®æ”¹é»˜è®¤å†…æ ¸ç‰ˆæœ¬ 1 2 3 4 5 6 7 8 9 10 11 12 # æŸ¥çœ‹å½“å‰å®é™…å¯åŠ¨é¡ºåº grub2-editenv list # æŸ¥çœ‹å†…æ ¸æ’å…¥é¡ºåº grep \u0026#34;^menuentry\u0026#34; /boot/grub2/grub.cfg | cut -d \u0026#34;\u0026#39;\u0026#34; -f2 # è®¾ç½®é»˜è®¤å¯åŠ¨ grub2-set-default \u0026#39;CentOS Linux (5.15.2-1.el7.elrepo.x86_64) 7 (Core)\u0026#39; # é‡æ–°åˆ›å»ºå†…æ ¸é…ç½® grub2-mkconfig -o /boot/grub2/grub.cfg # é‡å¯æœåŠ¡å™¨ reboot # éªŒè¯å½“å‰å†…æ ¸ç‰ˆæœ¬ uname -r å†…æ ¸ç‰ˆæœ¬ä¸€å®šè¦æ˜¯æ¯”è¾ƒé«˜çš„ï¼Œä¸ç„¶å¯åŠ¨WireGuardä¼šæœ‰å¦‚ä¸‹æŠ¥é”™ã€‚\n1 2 3 4 5 [#] ip link add wg0 type wireguard RTNETLINK answers: Operation not supported Unable to access interface: Protocol not supported [#] ip link delete dev wg0 Cannot find device \u0026#34;wg0\u0026#34; å®‰è£… WireGuard æ‰€æœ‰èŠ‚ç‚¹æ‰§è¡Œ å®‰è£…æµç¨‹éå¸¸ç®€å•ï¼Œæˆ‘è¿™é‡Œæ˜¯ç›´æ¥å°† CentOS å†…æ ¸æ›´æ–°åˆ°ç›®å‰æœ€æ–°çš„ 5.15.2 ç‰ˆæœ¬ï¼Œå…¶ä¸­å°±å·²ç»åŒ…å«äº† WireGuard çš„å†…æ ¸æ¨¡å—ï¼Œåªéœ€è¦å®‰è£… wireguard-tools è¿™ä¸ª yum åŒ…å°±è¡Œäº†ã€‚\n1 2 yum install epel-release https://www.elrepo.org/elrepo-release-7.el7.elrepo.noarch.rpm yum install yum-plugin-elrepo kmod-wireguard wireguard-tools -y é…ç½® WireGuard wireguard-tools åŒ…æä¾›äº†æˆ‘ä»¬æ‰€éœ€çš„å·¥å…· wg å’Œ wg-quickï¼Œå¯ä»¥ä½¿ç”¨å®ƒä»¬æ¥åˆ†åˆ«å®Œæˆæ‰‹åŠ¨éƒ¨ç½²å’Œè‡ªåŠ¨éƒ¨ç½²ã€‚\nå…ˆæŒ‰ç…§å®˜æ–¹æ–‡æ¡£æè¿°çš„å½¢å¼ï¼Œç”Ÿæˆè…¾è®¯äº‘1ç”¨äºåŠ å¯†è§£å¯†çš„å¯†é’¥\n1 wg genkey | tee privatekey | wg pubkey \u0026gt; publickey ç„¶ååœ¨å½“å‰ç›®å½•ä¸‹å°±ç”Ÿæˆäº† privatekey å’Œ publickey ä¸¤ä¸ªæ–‡ä»¶\nå¯†é’¥æ˜¯é…ç½®åˆ°æœ¬æœºçš„ï¼Œè€Œå…¬é’¥æ˜¯é…ç½®åˆ°å…¶å®ƒæœºå™¨é‡Œçš„ã€‚ 1 2 3 cat privatekey publickey EMWcI01iqM4zkb7xfbaaxxxxxxxxDo2GJUA= 0ay8WfGOIHndWklSIVBqrsp5LDWxxxxxxxxxxxxxxQ= ç°åœ¨æˆ‘ä»¬éœ€è¦ä¸ä¸Šè¿°ä¸»æœºå¯¹ç­‰è”ç½‘çš„ è…¾è®¯äº‘2 é˜¿é‡Œäº‘ ï¼Œå…¶å…¬ç½‘IPï¼ˆè¿™è¾¹éœ€è¦å¡«å†™çš„æ˜¯èƒ½ä¸ä¸»æœºé€šä¿¡çš„IPï¼‰æ˜¯ 122.xx.xxx.111ï¼Œ122.xx.xx.155\næˆ‘ä»¬é¦–å…ˆä¾ç…§ä¸Šé¢çš„æµç¨‹å®‰è£… WireGuard å¹¶ç”Ÿæˆå¥½ è…¾è®¯äº‘2 é˜¿é‡Œäº‘ çš„å¯†é’¥ã€‚\nç„¶åç¼–å†™ è…¾è®¯äº‘1 å®Œæ•´çš„é…ç½®æ–‡ä»¶ï¼Œä»¥ä¾› wg-quick ä½¿ç”¨ï¼Œåœ¨ä¸»æœºAçš„ /etc/wireguard/wg0.conf ä¸­å†™å…¥\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 [Interface] PrivateKey = EMWcI01iqM4zkb7xfbaaxxxxxxxxDo2GJUA= Address = 192.168.1.1 ListenPort = 5418 [Peer] PublicKey = è…¾è®¯äº‘2 publickey EndPoint = 122.xx.xxx.111:5418 AllowedIPs = 192.168.1.2/32 [Peer] PublicKey = é˜¿é‡Œäº‘publickey EndPoint = 122.xx.xx.155:5418 AllowedIPs = 192.168.1.3/32 é…ç½®è¯´æ˜ Interface: å°èŠ‚æ˜¯å±äºè…¾è®¯äº‘1ï¼ˆä¹Ÿå°±æ˜¯æœ¬æœºï¼‰çš„é…ç½®.\nAddress: æ˜¯åˆ†é…ç»™ è…¾è®¯äº‘1 è™šæ‹ŸIPï¼Œ\nListenPort: æ˜¯ä¸»æœºä¹‹é—´é€šè®¯ä½¿ç”¨çš„ç«¯å£ï¼Œæ˜¯ UDP åè®®çš„ã€‚\nPeer: æ˜¯å±äºéœ€è¦é€šä¿¡çš„ è…¾è®¯äº‘2 ã€é˜¿é‡Œäº‘ çš„ä¿¡æ¯ï¼Œæœ‰å¤šå°‘éœ€è¦é€šä¿¡çš„ä¸»æœºï¼Œå°±æ·»åŠ å¤šå°‘ä¸ª Peer å°èŠ‚ã€‚\nEndPoint: æ˜¯ è…¾è®¯äº‘2 ã€é˜¿é‡Œäº‘çš„å…¬ç½‘IPä¸ WireGuard ç›‘å¬çš„ UDP ç«¯å£ï¼Œè¿™ä¸ª IP ä¸ä¸€å®šæ˜¯å…¬ç½‘ï¼Œ\nå¦‚æœä½ çš„æœºå™¨é€šè¿‡å†…ç½‘ä¹Ÿèƒ½é€šä¿¡ï¼Œç›´æ¥ç”¨å†…ç½‘ IP ä¹Ÿå¯ä»¥ï¼Œå½“ç„¶è¦æ³¨æ„è¿™ä¸ªIPéœ€è¦æ‰€æœ‰åŠ å…¥å±€åŸŸç½‘çš„ä¸»æœºéƒ½èƒ½é€šä¿¡æ‰è¡Œã€‚ AllowedIPs: æ˜¯æŒ‡æœ¬æœºå‘èµ·è¿æ¥çš„å“ªäº›IPåº”è¯¥å°†æµé‡è½¬å‘åˆ°è¿™ä¸ªèŠ‚ç‚¹å»ï¼Œæ¯”å¦‚æˆ‘ä»¬ç»™ä¸»æœºBåˆ†é…äº†å†…ç½‘IP 192.168.1.2ï¼Œé‚£ä¹ˆåœ¨ä¸»æœºAä¸Šå‘é€åˆ° 192.168.1.2 çš„æ•°æ®åŒ…ï¼Œéƒ½åº”è¯¥è½¬å‘åˆ°è¿™ä¸ª EndPoint ä¸Šï¼Œå®ƒå…¶å®èµ·çš„æ˜¯ä¸€ä¸ªè¿‡æ»¤ä½œç”¨ã€‚è€Œä¸”å¤šä¸ª Peer æ—¶ï¼Œè¿™é‡Œé…ç½®çš„IPåœ°å€ä¸èƒ½æœ‰å†²çªã€‚\nå„ä¸ªèŠ‚ç‚¹ç”Ÿäº§çš„ privatekey å’Œpublickey åˆ†åˆ«å¦‚ä¸‹\n1 2 3 4 5 6 7 8 9 10 11 12 # master èŠ‚ç‚¹ [root@k3s-master ~]# cat privatekey publickey EMWcI01iqM4zkb7xfbaaxxxxxxxxDo2GJUA= 0ay8WfGOIHndWklSIVBqrsp5LDWxxxxxxxxxxxxxxQ= # node1 èŠ‚ç‚¹ [root@k3s-node1 ~]# cat privatekey publickey QGdNkzpnIkuvUU+00C6XYxxxxxxxxxK0D82qJVc= 3izpVbZgPhlM+S5szOogTDTxxxxxxxxxuKuDGn4= # node2 èŠ‚ç‚¹ [root@k3s-node2 ~]# cat privatekey publickey WOOObkWINkW/hqaAME9r+xxxxxxxxxm+r2Q= 0f0dn60+tBUfYgzw7rIihKbqxxxxxxxxa6Wo= å„èŠ‚ç‚¹é…ç½® masteré…ç½® node1é…ç½® node2é…ç½® 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 # master èŠ‚ç‚¹ cat /etc/wireguard/wg0.conf [Interface] PrivateKey = EMWcI01iqM4zkb7xfbaaxxxxxxxxDo2GJUA= Address = 192.168.1.1 ListenPort = 5418 [Peer] PublicKey = 3izpVbZgPhlM+S5szOogTDTxxxxxxxxxuKuDGn4= EndPoint = 122.xx.xxx.111:5418 AllowedIPs = 192.168.1.2/32 [Peer] PublicKey = 0f0dn60+tBUfYgzw7rIihKbqxxxxxxxxa6Wo= EndPoint = 122.xx.xx.155:5418 AllowedIPs = 192.168.1.3/32 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 # node1 èŠ‚ç‚¹ cat /etc/wireguard/wg0.conf [Interface] PrivateKey = QGdNkzpnIkuvUU+00C6XYxxxxxxxxxK0D82qJVc= Address = 192.168.1.2 ListenPort = 5418 [Peer] PublicKey = 0ay8WfGOIHndWklSIVBqrsp5LDWxxxxxxxxxxxxxxQ= EndPoint = 42.xxx.xx.16:5418 AllowedIPs = 192.168.1.1/32 [Peer] PublicKey = 0f0dn60+tBUfYgzw7rIihKbqxxxxxxxxa6Wo= EndPoint = 122.xx.xx.155:5418 AllowedIPs = 192.168.1.3/32 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 # node2 èŠ‚ç‚¹ cat /etc/wireguard/wg0.conf [Interface] PrivateKey = WOOObkWINkW/hqaAME9r+xxxxxxxxxm+r2Q= Address = 192.168.1.3 ListenPort = 5418 [Peer] PublicKey = 0ay8WfGOIHndWklSIVBqrsp5LDWxxxxxxxxxxxxxxQ= EndPoint = 42.xxx.xx.16:5418 AllowedIPs = 192.168.1.1/32 [Peer] PublicKey = 3izpVbZgPhlM+S5szOogTDTxxxxxxxxxuKuDGn4= EndPoint = 122.xx.xx.155:5418 AllowedIPs = 192.168.1.2/32 å¯åŠ¨ WireGuard é…ç½®æ–‡ä»¶å†™å¥½åï¼Œä½¿ç”¨ wg-quick å·¥å…·æ¥åˆ›å»ºè™šæ‹Ÿç½‘å¡ï¼Œ\n1 wg-quick up wg0 ä¸Šé¢å‘½ä»¤ä¸­çš„ wg0 å¯¹åº”çš„æ˜¯ /etc/wireguard/wg0.conf è¿™ä¸ªé…ç½®æ–‡ä»¶ï¼Œå…¶è‡ªåŠ¨åˆ›å»ºçš„ç½‘å¡è®¾å¤‡ï¼Œåå­—å°±æ˜¯ wg0ï¼Œè¿™å¯¹åº”å…³ç³»è‡ªä¸å¿…å¤šè¨€ã€‚\nå°†è…¾è®¯äº‘2 ã€é˜¿é‡Œäº‘ çš„ç½‘å¡è®¾å¤‡éƒ½å®‰è£…é…ç½®å¥½åï¼Œå°±èƒ½ä½¿ç”¨ wg å‘½ä»¤æ¥è§‚å¯Ÿç»„ç½‘æƒ…å†µäº†\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 [root@k3s-master ~]# wg interface: wg0 public key: 0ay8WfGOIHndWklSIVBqrsp5LDWxxxxxxxxxxxxxxQ= private key: (hidden) listening port: 5418 peer: 0f0dn60+tBUfYgzw7rIihKbqxxxxxxxxa6Wo= endpoint: 122.xx.xx.155:5418 allowed ips: 192.168.1.3/32 latest handshake: 3 minutes, 3 seconds ago transfer: 35.40 KiB received, 47.46 KiB sent peer: 3izpVbZgPhlM+S5szOogTDTxxxxxxxxxuKuDGn4= endpoint: 122.xx.xxx.111:5418 allowed ips: 192.168.1.2/32 latest handshake: 5 minutes, 6 seconds ago transfer: 24.84 KiB received, 35.21 KiB sent å¯ä»¥çœ‹åˆ°åˆ—å‡ºäº†å¯¹ç­‰è”ç½‘çš„èŠ‚ç‚¹ä¿¡æ¯ï¼Œè¿˜æœ‰é€šä¿¡æµ‹é‡æ•°æ®ã€‚ç„¶åå¯ä»¥é€šè¿‡ ping å…¶ä»–ä¸»æœºçš„è™šæ‹ŸIPæˆ–è€… ssh å…¶ä»–ä¸»æœºçš„IPåœ°å€ï¼Œæ¥æ£€æŸ¥ç½‘ç»œé€šä¿¡æ˜¯å¦æ­£å¸¸ã€‚\nè‡ªåŠ¨åŒ– ç³»ç»Ÿé‡å¯åï¼ŒWireGuard åˆ›å»ºçš„ç½‘å¡è®¾å¤‡å°±ä¼šä¸¢å¤±ï¼Œæœ‰è‡ªåŠ¨åŒ–çš„è„šæœ¬\n1 systemctl enable wg-quick@wg0 ä½¿ç”¨ä¸Šè¿°å‘½ä»¤ç”Ÿæˆsystemdå®ˆæŠ¤è„šæœ¬ï¼Œå¼€æœºä¼šè‡ªåŠ¨è¿è¡ŒupæŒ‡ä»¤ã€‚\né…ç½®çƒ­é‡è½½ wg-quickå¹¶æœªæä¾›é‡è½½ç›¸å…³çš„æŒ‡ä»¤ï¼Œä½†æ˜¯æä¾›äº† strip æŒ‡ä»¤ï¼Œå¯ä»¥å°† conf æ–‡ä»¶è½¬æ¢ä¸º wg æŒ‡ä»¤å¯ä»¥è¯†åˆ«çš„æ ¼å¼ã€‚\n1 wg syncconf wg0 \u0026lt;(wg-quick strip wg0) å³å¯å®ç°çƒ­é‡è½½ã€‚\nå®Œæˆ WireGuard çš„å®‰è£…é…ç½®ä»¥åï¼Œæˆ‘ä»¬å°±å¯ä»¥æ¥ä¸‹æ¥å®‰è£… k3s çš„é›†ç¾¤äº†ã€‚\nå®‰è£… K3S é›†ç¾¤ masterèŠ‚ç‚¹å®‰è£… 1 curl -sfL http://rancher-mirror.cnrancher.com/k3s/k3s-install.sh | INSTALL_K3S_MIRROR=cn sh -s - --node-external-ip 42.xx.xx.12--advertise-address 42.xx.xx.12--node-ip 192.168.1.1 --flannel-iface wg0 å‚æ•°è¯´æ˜ï¼š\n--node-external-ip 42.xxx.xx.16 ä¸ºèŠ‚ç‚¹è®¾ç½®å¤–éƒ¨IPï¼Œé˜¿é‡Œäº‘VPCçš„å¤–ç½‘IPå¹¶æœªç›´æ¥ç»‘å®šåˆ°è™šæ‹Ÿæœºç½‘å¡ä¸Šï¼Œæ‰€ä»¥æˆ‘è¦è®¾ç½®è¿™ä¸ªå‚æ•°ï¼Œé¿å…k3sç»„ä»¶åœ¨è®¾ç½®loadbalanceæ—¶ï¼Œå°†å†…ç½‘IPå½“ä½œå…¬ç½‘IPä½¿ç”¨ã€‚ --advertise-address 42.xxx.xx.16 ç”¨äºè®¾ç½®kubectlå·¥å…·ä»¥åŠå­èŠ‚ç‚¹è¿›è¡Œé€šè®¯ä½¿ç”¨çš„åœ°å€ï¼Œå¯ä»¥æ˜¯IPï¼Œä¹Ÿå¯ä»¥æ˜¯åŸŸåï¼Œåœ¨åˆ›å»ºapiserverè¯ä¹¦æ—¶ä¼šå°†æ­¤è®¾ç½®åˆ°æœ‰æ•ˆåŸŸä¸­ã€‚ --node-ip 10.20.30.1 å¦‚æœä¸è®¾ç½®è¿™ä¸ªå‚æ•°ï¼Œé‚£ä¹ˆç¬¬ä¸€å¼ ç½‘å¡è®¾å¤‡ä¸Šçš„IPå°±ä¼šè¢«é€‰ä¸­ï¼Œæ‰€ä»¥è¿™ä¸ªIPå¸¸æ˜¯å†…ç½‘IPã€‚ä½†æˆ‘è‡ªè¡Œç»„å»ºäº†è™šæ‹Ÿå±€åŸŸç½‘ï¼Œæ‰€ä»¥éœ€è¦æŒ‡å®šè™šæ‹Ÿå±€åŸŸç½‘çš„IPï¼ˆä¹Ÿå°±æ˜¯WireGuardçš„IPï¼‰ã€‚ --flannel-iface wg0 wg0æ˜¯WireGuardåˆ›å»ºçš„ç½‘å¡è®¾å¤‡ï¼Œæˆ‘éœ€è¦ä½¿ç”¨è™šæ‹Ÿå±€åŸŸç½‘æ¥è¿›è¡ŒèŠ‚ç‚¹é—´çš„é€šä¿¡ï¼Œæ‰€ä»¥è¿™é‡Œéœ€è¦æŒ‡å®šä¸ºwg0ã€‚ å¦å¤–å°±æ˜¯ï¼Œç”±äºWireGuardçš„æ‰€æœ‰æµé‡éƒ½æ˜¯åŠ å¯†ä¼ è¾“çš„ï¼Œé€šè¿‡å®ƒæ¥è¿›è¡ŒèŠ‚ç‚¹é—´çš„é€šä¿¡ï¼Œå°±å·²ç»èƒ½å¤Ÿä¿è¯é€šä¿¡å®‰å…¨ï¼Œä¹Ÿå°±æ²¡æœ‰å¿…è¦æ”¹ç”¨å…¶å®ƒçš„CNIé©±åŠ¨ï¼Œä½¿ç”¨é»˜è®¤çš„å°±å¯ä»¥äº†ã€‚\nåœ¨ä¸»èŠ‚ç‚¹æ‰§è¡Œä¸Šè¿°å‘½ä»¤åï¼Œä¸€åˆ†é’Ÿä¸åˆ°å°±å¯ä»¥çœ‹åˆ°è„šæœ¬æç¤ºå®‰è£…å®Œæˆã€‚é€šè¿‡å‘½ä»¤æŸ¥çœ‹ä¸‹ä¸»æ§ç«¯çš„è¿è¡Œæƒ…å†µ\n1 systemctl status k3s å¦‚æœè¿è¡Œæ­£å¸¸ï¼Œé‚£ä¹ˆå°±çœ‹çœ‹å®¹å™¨çš„è¿è¡ŒçŠ¶æ€æ˜¯å¦æ­£å¸¸\n1 kubectl get pods -A -A å‚æ•°ç”¨äºæŸ¥çœ‹æ‰€æœ‰å‘½åç©ºé—´ï¼Œå¦‚æœå®¹å™¨éƒ½å¤„äº running çŠ¶æ€ï¼Œé‚£ä¹ˆå®‰è£…å°±æˆåŠŸäº†ï¼Œæ¥ä¸‹æ¥è¦å¯ä»¥æ·»åŠ è¢«æ§èŠ‚ç‚¹ã€‚\nAgent å®‰è£… æœ‰äº†ä¸Šè¿°å®‰è£…ä¸»æ§çš„ç»éªŒï¼Œå®‰è£…workèŠ‚ç‚¹æ›´åŠ ç®€å•ï¼Œå‚æ•°éœ€è¦ä¸€å®šçš„è°ƒæ•´\nè…¾è®¯äº‘2æ‰§è¡Œ é˜¿é‡Œäº‘æ‰§è¡Œ è…¾è®¯äº‘2æ‰§è¡Œ\n1 curl -sfL http://rancher-mirror.cnrancher.com/k3s/k3s-install.sh | INSTALL_K3S_MIRROR=cn K3S_URL=https://192.168.1.1:6443 K3S_TOKEN=K107xxxxxxxxxxxxxxxx2cf95048d6a3cd85f15717edfbe5::server:xxxxxxxxxxxxxxxxxxxx4da1b7e701f67e sh -s - --node-external-ip 122.xx.xxx.111 --node-ip 192.168.1.2 --flannel-iface wg0 é˜¿é‡Œäº‘æ‰§è¡Œ\n1 curl -sfL http://rancher-mirror.cnrancher.com/k3s/k3s-install.sh | INSTALL_K3S_MIRROR=cn K3S_URL=https://192.168.1.1:6443 K3S_TOKEN=K10720eda8a278bdc7b9b6d787c9676a92119bb2cf95048d6a3cd85f15717edfbe5::server:e98b986e8202885cb54da1b7e701f67e sh -s - --node-external-ip 122.xx.xx.155 --node-ip 192.168.1.3 --flannel-iface wg0 å‚æ•°ä¸å¿…è¿‡å¤šè§£é‡Š\nK3S_Token å» cat /var/lib/rancher/k3s/server/node-token è·å–å³å¯ã€‚ K3S_URL éœ€è¦è®¾ç½®masterçš„é€šä¿¡åœ°å€ç«¯å£ï¼Œç«¯å£é»˜è®¤æ˜¯6443ï¼ŒIPåœ°å€å°±æ˜¯è™šæ‹Ÿç½‘åŸŸçš„IPï¼Œè¿™æ ·æµé‡å°±ä¼šé€šè¿‡WireGuardåŠ å¯†ä¼ è¾“ã€‚ node-external-ip ä¸ºèŠ‚ç‚¹å…¬ç½‘åœ°å€ node-ip èŠ‚ç‚¹è™šæ‹ŸIPåœ°å€\næ‰§è¡Œå®Œç¨ç­‰ä¸€ä¼šï¼Œå®‰è£…æˆåŠŸåï¼ŒæŸ¥çœ‹æœåŠ¡è¿è¡ŒçŠ¶æ€ã€‚ 1 systemctl status k3s-agent å¦‚æœæœ‰æŠ¥é”™å°±æ ¹æ®æŠ¥é”™æŸ¥æ‰¾è§£å†³æ–¹æ¡ˆã€‚\néƒ½å®‰è£…å¥½ä»¥å åœ¨masterèŠ‚ç‚¹æ£€æŸ¥ã€‚\n1 kubectl get nodes -o wide è‡³æ­¤ å¤šäº‘ K3S é›†ç¾¤å·²ç»æ­å»ºå®Œæ¯•ã€‚\nä½œè€…ï¼šSREè¿ç»´åšå®¢\nåšå®¢åœ°å€ï¼š https://www.cnsre.cn/\næ–‡ç« åœ°å€ï¼šhttps://www.cnsre.cn/posts/211119132529/\nç›¸å…³è¯é¢˜ï¼šhttps://www.cnsre.cn/tags/k3s/\n","description":"ä¿å§†çº§æ•™å­¦ã€‚æ‰‹æŠŠæ‰‹æ•™æŠŠå¤šä¸ªäº‘å‚å•†çš„æœåŠ¡å™¨å¿«é€Ÿæ­å»ºä¸€ä¸ªk3sé›†ç¾¤|å¤šäº‘æ­å»ºK3Sé›†ç¾¤|å…¬ç½‘æ­å»ºK3Sé›†ç¾¤|è·¨äº‘æ­å»ºK3Sé›†ç¾¤","id":0,"section":"posts","tags":["k3s","kubernetes","wireguard"],"title":"å¤šäº‘æ­å»º K3S é›†ç¾¤","uri":"http://www.cnsre.cn:80/posts/211119132529/"},{"content":" ä½œè€…ï¼šSREè¿ç»´åšå®¢\nåšå®¢åœ°å€ï¼šhttps://www.cnsre.cn/\næ–‡ç« åœ°å€ï¼šhttps://www.cnsre.cn/posts/231208094411/\nç›¸å…³è¯é¢˜ï¼šhttps://www.cnsre.cn/tags/é˜¿é‡Œäº‘/\nç”³è¯·å‰é¡»çŸ¥ ç¤¾åŒºé•œåƒå‰ï¼Œè¯·å…ˆäº†è§£ä»¥ä¸‹æ³¨æ„äº‹é¡¹ï¼š\nåªæœ‰é€šè¿‡ä¼ä¸šè®¤è¯çš„æ‰å¯ä»¥ç”³è¯·ä½¿ç”¨ç¤¾åŒºé•œåƒå‘å¸ƒåŠŸèƒ½ã€‚ åŠ å¯†é•œåƒä¸å…è®¸å‘å¸ƒä¸ºç¤¾åŒºé•œåƒã€‚ ç¤¾åŒºé•œåƒå®Œå…¨å…¬å¼€ï¼Œåœ¨é•œåƒæ‰€å±åœ°åŸŸä¸‹ï¼Œæ‰€æœ‰çš„é˜¿é‡Œäº‘è´¦å·å‡å¯ä½¿ç”¨ã€‚ ç¤¾åŒºé•œåƒä¸æ”¯æŒå…±äº«ã€å¯¼å‡ºä¸å¤åˆ¶ã€‚ ç”³è¯·æµç¨‹ ç”³è¯·ä¼ä¸šè®¤è¯ å› ä¸ºåªæœ‰é€šè¿‡ä¼ä¸šè®¤è¯çš„ç”¨æˆ·æ‰æœ‰æƒé™ç”³è¯·å‘å¸ƒç¤¾åŒºé•œåƒï¼Œæ‰€ä»¥è¦å…ˆè¿›è¡Œç¤¾åŒºè®¤è¯ã€‚\næœ¬æ–‡ä¸»è¦ä»¥ç”³è¯·ç¤¾åŒºé•œåƒå‘å¸ƒæƒé™ä¸ºä¸»ï¼Œä¸å†ä»‹ç»ä¼ä¸šè®¤è¯æ–¹æ³•ã€‚ æ²¡æœ‰ç¤¾åŒºè®¤è¯çš„ç”¨æˆ·å¯ä»¥å‚è€ƒé“¾æ¥ é˜¿é‡Œäº‘ä¼ä¸šè®¤è¯\nåˆ›å»ºè‡ªå®šä¹‰é•œåƒ åœ¨ç”³è¯·å‘å¸ƒç¤¾åŒºé•œåƒä¹‹å‰ï¼Œé¦–å…ˆè¦æŠŠé•œåƒåˆ¶ä½œå¥½ã€‚\nå‘å¸ƒç¤¾åŒºé•œåƒçš„é•œåƒæ¥æºä¸»è¦æœ‰æ§åˆ¶å°åˆ›å»ºè‡ªå®šä¹‰é•œåƒã€OpenAPIã€é•œåƒæ„å»ºImage Builderã€Packerç­‰ã€‚æœ¬åœ°ä»¥æ§åˆ¶å°åˆ›å»ºè‡ªåŠ¨ä»¥é•œåƒä¸ºä¾‹ã€‚\nç™»å½•åˆ°æ§åˆ¶å°ï¼ŒæŒ‰ç…§ä¸‹å›¾è¿›è¡Œæ“ä½œã€‚è¿›è¡Œé•œåƒçš„åˆ¶ä½œã€‚\nç‚¹å‡»åˆ›å»ºè‡ªå®šä¹‰é•œåƒåï¼Œå‡ºç°å¦‚ä¸‹ç•Œé¢\nç‚¹å‡»åˆ›å»ºåï¼Œéœ€è¦ç­‰å¾…ä¸€æ®µæ—¶é—´ã€‚åˆ›å»ºæ—¶é—´ä¸»è¦çœ‹ç£ç›˜å’Œæ•°æ®é‡çš„å¤§å°å†³å®šçš„ã€‚\næ”¶é›†é•œåƒä¿¡æ¯ åˆ›å»ºå®Œè‡ªåŠ¨ä»¥é•œåƒåï¼Œéœ€è¦æ”¶é›†ä¸€äº›é•œåƒçš„ä¿¡æ¯ï¼Œä»¥å¤‡ç”³è¯·æƒé™æ—¶ä½¿ç”¨ã€‚\nå…·ä½“ä¿¡æ¯å¦‚ä¸‹ï¼š\n**é•œåƒåç§°ï¼š**Wrodpress **æ“ä½œç³»ç»ŸåŠç‰ˆæœ¬ï¼š**CentOS 7.9 64ä½ UEFIç‰ˆ é•œåƒå¤§å°ï¼š 40GB **åº”ç”¨åœºæ™¯ï¼š**å‘å¸ƒçš„ç¤¾åŒºé•œåƒå°†åº”ç”¨äºCloudIaCæ¨¡æ¿ä¸­,ç”¨æ¥åˆ›å»ºå¯¹åº”çš„äº‘æœåŠ¡ã€‚åç»­è¿˜ä¼šæ¨å‡ºæ›´å¤šåº”ç”¨å’Œé•œåƒã€‚ **å¦‚ä½•å¼•æµã€ç”¨æˆ·ç¾¤ï¼š**é€šè¿‡å®˜ç½‘CloudIaCæ¨¡æ¿å¼•æµä½¿ç”¨ç¤¾åŒºé•œåƒã€‚ä¸»è¦ç”¨æˆ·ç¾¤æ˜¯å­¦ç”Ÿå’Œé«˜æ ¡ã€‚ **è®¡åˆ’å‘å¸ƒã€æ›´æ–°ï¼š**åœ¨å¤šä¸ªåœ°åŸŸå‘å¸ƒç¤¾åŒºé•œåƒ,å¹¶é•¿æœŸæ›´æ–°ç»´æŠ¤ã€‚ **é•œåƒåˆ¶ä½œæ–¹å¼ï¼š**é€šè¿‡æ§åˆ¶å°åˆ›å»ºè‡ªå®šä¹‰é•œåƒçš„æ–¹å¼åˆ¶ä½œé•œåƒã€‚ æäº¤å·¥å•ç”³è¯·æƒé™ å‡†å¤‡å®Œä»¥ä¸Šä¿¡æ¯åï¼Œå°±å¯ä»¥æå·¥å•ç”³è¯·äº†ã€‚æˆ‘è¿™è¾¹ä¹Ÿç»™å¤§å®¶å‡†å¤‡äº†ç”³è¯·è¯æœ¯ä¾›å¤§å®¶å‚è€ƒï¼š\nå°Šæ•¬çš„é˜¿é‡Œäº‘æ”¯æŒå›¢é˜Ÿï¼Œ æˆ‘äº‘éœç§‘æŠ€çš„è´¦æˆ·ç®¡ç†å‘˜é›ªæ–‡é¾™ï¼Œæˆ‘ä»£è¡¨æ­å·äº‘éœç§‘æŠ€æœ‰é™å…¬å¸ã€‚ æˆ‘ä»¬è¿‘æœŸå¼€å‘äº†ä¸€æ¬¾åŸºäºCentOS 7.9 å®šåˆ¶äº†WordPressçš„ç³»ç»Ÿé•œåƒï¼Œç»è¿‡å†…éƒ¨æµ‹è¯•å’Œä¼˜åŒ–ï¼Œæˆ‘ä»¬ç›¸ä¿¡è¿™ä¸ªé•œåƒå¯¹é˜¿é‡Œäº‘ç¤¾åŒºçš„ç”¨æˆ·ä¼šæœ‰å¾ˆå¤§çš„ä»·å€¼ã€‚ ä¸ºäº†åˆ†äº«æˆ‘ä»¬çš„å·¥ä½œï¼Œå¹¶è®©æ›´å¤šçš„ç”¨æˆ·å—ç›Šï¼Œæˆ‘ä»¬å¸Œæœ›èƒ½å¤Ÿå°†è¿™ä¸ªè‡ªå®šä¹‰ç³»ç»Ÿé•œåƒå‘å¸ƒåˆ°é˜¿é‡Œäº‘ç¤¾åŒºé•œåƒä¸­ã€‚åœ¨æ­¤ï¼Œæˆ‘ä»¬è¯šæ³åœ°ç”³è¯·è·å¾—å‘å¸ƒé•œåƒçš„æƒé™ã€‚ ä»¥ä¸‹æ˜¯æœ‰å…³æˆ‘ä»¬è‡ªå®šä¹‰ç³»ç»Ÿé•œåƒçš„ä¸€äº›åŸºæœ¬ä¿¡æ¯ï¼š 1. å‘å¸ƒè€…è®¤è¯åç§°ï¼š Yunjikeji Ampere Computing 2. é•œåƒåç§°ï¼šWrodpress 3. æ“ä½œç³»ç»ŸåŠç‰ˆæœ¬ï¼šCentOS 7.9 64ä½ UEFIç‰ˆ 4. é•œåƒå¤§å°ï¼š 40GB 5. åº”ç”¨åœºæ™¯ï¼šå‘å¸ƒçš„ç¤¾åŒºé•œåƒå°†åº”ç”¨äºCloudIaCæ¨¡æ¿ä¸­,ç”¨æ¥åˆ›å»ºå¯¹åº”çš„äº‘æœåŠ¡ã€‚åç»­è¿˜ä¼šæ¨å‡ºæ›´å¤šåº”ç”¨å’Œé•œåƒã€‚ 6. å¦‚ä½•å¼•æµã€ç”¨æˆ·ç¾¤ï¼šé€šè¿‡å®˜ç½‘CloudIaCæ¨¡æ¿å¼•æµä½¿ç”¨ç¤¾åŒºé•œåƒã€‚ä¸»è¦ç”¨æˆ·ç¾¤æ˜¯å­¦ç”Ÿå’Œé«˜æ ¡ã€‚ 7. è®¡åˆ’å‘å¸ƒã€æ›´æ–°ï¼šåœ¨å¤šä¸ªåœ°åŸŸå‘å¸ƒç¤¾åŒºé•œåƒ,å¹¶é•¿æœŸæ›´æ–°ç»´æŠ¤ã€‚ 8. é•œåƒåˆ¶ä½œæ–¹å¼ï¼šé€šè¿‡æ§åˆ¶å°åˆ›å»ºè‡ªå®šä¹‰é•œåƒçš„æ–¹å¼åˆ¶ä½œé•œåƒã€‚ æˆ‘ä»¬ç›¸ä¿¡è¿™ä¸ªç³»ç»Ÿé•œåƒå°†ä¸ºé˜¿é‡Œäº‘ç¤¾åŒºçš„ç”¨æˆ·æä¾›æ›´ä¸°å¯Œçš„é€‰æ‹©ï¼Œå¹¶æœ‰åŠ©äºæ¨åŠ¨äº‘è®¡ç®—ç¤¾åŒºçš„å‘å±•ã€‚ æˆ‘ä»¬ç†è§£é˜¿é‡Œäº‘ç¤¾åŒºå¯¹é•œåƒçš„è´¨é‡å’Œå®‰å…¨æ€§æœ‰ä¸¥æ ¼çš„è¦æ±‚ï¼Œå› æ­¤æˆ‘ä»¬å·²ç»é‡‡å–äº†ä¸€ç³»åˆ—æªæ–½æ¥ç¡®ä¿æˆ‘ä»¬çš„é•œåƒç¬¦åˆæœ€é«˜æ ‡å‡†ã€‚ åœ¨æ­¤ï¼Œæˆ‘ä»¬çœŸè¯šåœ°æœŸå¾…èƒ½å¤Ÿå¾—åˆ°æ‚¨çš„æ”¯æŒå’Œæ‰¹å‡†ï¼Œä»¥ä¾¿æˆ‘ä»¬çš„ç³»ç»Ÿé•œåƒèƒ½å¤Ÿä¸ºæ›´å¤šçš„ç”¨æˆ·æœåŠ¡ã€‚ è°¢è°¢æ‚¨çš„æ—¶é—´å’Œè€ƒè™‘ã€‚ é’ˆå¯¹æäº¤å·¥å•ç”³è¯·æƒé™çš„ä¸€äº›ç–‘é—®ï¼š\næäº¤å·¥å•ç”³è¯·æƒé™å®¡æ ¸çš„æ—¶é—´æ˜¯å¤šä¹…?\nç”³è¯·æƒé™çš„å®¡æ ¸æ—¶é—´æ²¡æœ‰çš„åˆ°å…·ä½“çš„å›å¤ã€‚ä¸è¿‡åœ¨å‚¬å·¥å•çš„æƒ…å†µä¸‹ï¼Œæˆ‘æ˜¯ä»ç”³è¯·åˆ°å¾—åˆ°æƒé™ç”¨äº†24ä¸ªå°æ—¶ã€‚ æäº¤å·¥å•ç”³è¯·æƒé™å®¡æ ¸çš„æµç¨‹æ˜¯ä»€ä¹ˆ?\nç”³è¯·æƒé™çš„æµç¨‹ã€‚å‡†å¤‡ç”³è¯·å‘å¸ƒé•œåƒçš„ææ–™ \u0026ndash; æäº¤ç”³è¯·å·¥å• \u0026ndash; å®¡æ ¸å›¢é˜Ÿæ ¸å¯¹æäº¤ç”³è¯·ææ–™ \u0026ndash; è¡¥å……ç”³è¯·ææ–™ï¼ˆå¦‚æœéœ€è¦ï¼‰\u0026ndash; å®¡æ ¸é•œåƒ \u0026ndash; å¼€é€šæƒé™ã€‚å› ä¸ºæ²¡æœ‰å…¬å¸ƒå…·ä½“çš„å®¡æ ¸æµç¨‹ï¼Œä½†æ˜¯ä»æ²Ÿé€šä¸Šæˆ‘çŒœæƒ³å¯ä»¥è¿™æ ·å»ç†è§£ æœ‰æ²¡æœ‰ä¸€äº›å¿«æ·çš„æ–¹å¼å¯ä»¥å°½å¿«é€šè¿‡å®¡æ ¸ï¼Ÿ\næœ‰çš„ã€‚å€¼å¾—ä¸€æçš„æ˜¯ï¼Œåœ¨æˆ‘åç»­ç”³è¯·åˆ°äº†æƒé™ä»¥åï¼Œæˆ‘ä¹Ÿå¯ä»¥å‘å¸ƒæ²¡æœ‰è¿›è¡Œå®¡æ ¸çš„é•œåƒå‘å¸ƒåˆ°ç¤¾åŒºé•œåƒä¸­ã€‚æ‰€ä»¥å¤§å®¶åœ¨ç”³è¯·ç¤¾åŒºé•œåƒæƒé™çš„æ—¶å€™ï¼Œå¯ä»¥é€‰æ‹©ç”³è¯·ä¸€ä¸ªå°½é‡ç¬¦åˆè§„åˆ™æ ‡å‡†çš„é•œåƒå»ç”³è¯·ã€‚ å‘å¸ƒç¤¾åŒºé•œåƒ ç»å†24å°æ—¶çš„æ¥å›æ‹‰æ‰¯ã€‚å¾—åˆ°äº†å›å¤ æ‚¨å¥½ : åå°å·²ç»å®¡æ ¸å®Œæ¯•ï¼Œæ‚¨åœ¨é…ç½®å‘å¸ƒé•œåƒçœ‹ä¸‹å‘¢ã€‚\næ‹¿åˆ°æƒé™ã€‚å‘å¸ƒæµ‹è¯•ã€‚\nè¿›å…¥é•œåƒåŠŸèƒ½é¡µé¢ã€‚\nç™»å½•ECSç®¡ç†æ§åˆ¶å°ã€‚ åœ¨å·¦ä¾§å¯¼èˆªæ ï¼Œé€‰æ‹©å®ä¾‹ä¸é•œåƒ \u0026gt; é•œåƒã€‚ åœ¨é¡¶éƒ¨èœå•æ å·¦ä¸Šè§’å¤„ï¼Œé€‰æ‹©åœ°åŸŸã€‚ åœ¨è‡ªå®šä¹‰é•œåƒé¡µç­¾ï¼Œæ‰¾åˆ°å¾…å‘å¸ƒä¸ºç¤¾åŒºé•œåƒçš„å¯ç”¨è‡ªå®šä¹‰é•œåƒï¼Œç„¶ååœ¨æ“ä½œåˆ—é€‰æ‹©... \u0026gt;å‘å¸ƒä¸ºç¤¾åŒºé•œåƒã€‚\nåœ¨å‘å¸ƒä¸ºç¤¾åŒºé•œåƒå¯¹è¯æ¡†ï¼Œå®Œæˆç¤¾åŒºé•œåƒçš„å‘å¸ƒã€‚\nå‘å¸ƒæˆåŠŸåï¼Œæ‚¨å¯ä»¥åœ¨é•œåƒé¡µé¢ï¼Œå•å‡»ç¤¾åŒºé•œåƒé¡µç­¾ï¼ŒæŸ¥çœ‹å·²å‘å¸ƒçš„ç¤¾åŒºé•œåƒä¿¡æ¯ã€‚\nç›¸å…³é—®ç­” æäº¤å·¥å•ç”³è¯·æƒé™å®¡æ ¸çš„æ—¶é—´æ˜¯å¤šä¹…?\nç”³è¯·æƒé™çš„å®¡æ ¸æ—¶é—´æ²¡æœ‰çš„åˆ°å…·ä½“çš„å›å¤ã€‚ä¸è¿‡åœ¨å‚¬å·¥å•çš„æƒ…å†µä¸‹ï¼Œæˆ‘æ˜¯ä»ç”³è¯·åˆ°å¾—åˆ°æƒé™ç”¨äº†24ä¸ªå°æ—¶ã€‚ æäº¤å·¥å•ç”³è¯·æƒé™å®¡æ ¸çš„æµç¨‹æ˜¯ä»€ä¹ˆ?\nç”³è¯·æƒé™çš„æµç¨‹ã€‚å‡†å¤‡ç”³è¯·å‘å¸ƒé•œåƒçš„ææ–™ \u0026ndash; æäº¤ç”³è¯·å·¥å• \u0026ndash; å®¡æ ¸å›¢é˜Ÿæ ¸å¯¹æäº¤ç”³è¯·ææ–™ \u0026ndash; è¡¥å……ç”³è¯·ææ–™ï¼ˆå¦‚æœéœ€è¦ï¼‰\u0026ndash; å®¡æ ¸é•œåƒ \u0026ndash; å¼€é€šæƒé™ã€‚å› ä¸ºæ²¡æœ‰å…¬å¸ƒå…·ä½“çš„å®¡æ ¸æµç¨‹ï¼Œä½†æ˜¯ä»æ²Ÿé€šä¸Šæˆ‘çŒœæƒ³å¯ä»¥è¿™æ ·å»ç†è§£ æœ‰æ²¡æœ‰ä¸€äº›å¿«æ·çš„æ–¹å¼å¯ä»¥å°½å¿«é€šè¿‡å®¡æ ¸ï¼Ÿ\næœ‰çš„ã€‚å€¼å¾—ä¸€æçš„æ˜¯ï¼Œåœ¨æˆ‘åç»­ç”³è¯·åˆ°äº†æƒé™ä»¥åï¼Œæˆ‘ä¹Ÿå¯ä»¥å‘å¸ƒæ²¡æœ‰è¿›è¡Œå®¡æ ¸çš„é•œåƒå‘å¸ƒåˆ°ç¤¾åŒºé•œåƒä¸­ã€‚æ‰€ä»¥å¤§å®¶åœ¨ç”³è¯·ç¤¾åŒºé•œåƒæƒé™çš„æ—¶å€™ï¼Œå¯ä»¥é€‰æ‹©ç”³è¯·ä¸€ä¸ªå°½é‡ç¬¦åˆè§„åˆ™æ ‡å‡†çš„é•œåƒå»ç”³è¯·ã€‚ å‚è€ƒé“¾æ¥ https://help.aliyun.com/zh/ecs/user-guide/overview-12\nhttps://help.aliyun.com/zh/pnp/l6821168?spm=5176.22414175.sslink.1.638a753bYT0ivM\nä½œè€…ï¼šSREè¿ç»´åšå®¢\nåšå®¢åœ°å€ï¼šhttps://www.cnsre.cn/\næ–‡ç« åœ°å€ï¼šhttps://www.cnsre.cn/posts/postsid/\nç›¸å…³è¯é¢˜ï¼šhttps://www.cnsre.cn/tags/é˜¿é‡Œäº‘/\n","description":"åœ¨é˜¿é‡Œäº‘ä¸­æ— æ³•å‘å¸ƒé•œåƒåˆ°ç¤¾åŒºï¼Œè®©æ›´å¤šçš„äººä½¿ç”¨ï¼Ÿ","id":1,"section":"posts","tags":["é˜¿é‡Œäº‘"],"title":"é˜¿é‡Œäº‘ç”³è¯·å‘å¸ƒç¤¾åŒºé•œåƒæƒé™","uri":"http://www.cnsre.cn:80/posts/231208094411/"},{"content":" ä½œè€…ï¼šSREè¿ç»´åšå®¢\nåšå®¢åœ°å€ï¼šhttps://www.cnsre.cn/\næ–‡ç« åœ°å€ï¼šhttps://www.cnsre.cn/posts/230506425079/\nç›¸å…³è¯é¢˜ï¼šhttps://www.cnsre.cn/tags/lambda/\nåˆ©ç”¨Lambdaè½»æ¾å®ç°EC2å®ä¾‹ç›‘æ§ æœ€è¿‘æ–°å¢äº†ä¸€äº›æœåŠ¡å™¨ï¼Œå› ä¸ºæ¯ä¸ªæœåŠ¡å™¨çš„åŸºç¡€ç›‘æ§éƒ½æ˜¯è¦åšçš„ã€‚æˆ‘å°±æƒ³ï¼Œå¦‚ä½•èƒ½å¤Ÿå¿«é€Ÿä¾¿æ·çš„æ–¹å¼æŠŠè¿™äº›åŸºç¡€æŒ‡æ ‡éƒ½ç›‘æ§ä¸Šå‘¢ï¼Ÿæœ¬æ–‡å°†è¯¦ç»†ä»‹ç»å¦‚ä½•é€šè¿‡Lambdaè‡ªåŠ¨ä¸ºæ‰€æœ‰EC2å®ä¾‹æ·»åŠ CloudWatchç£ç›˜å‘Šè­¦,å¹¶åœ¨ç£ç›˜åˆ©ç”¨ç‡è¶…è¿‡é˜ˆå€¼æ—¶,é€šè¿‡SNSä¸»é¢˜å‘é€é€šçŸ¥ã€‚\nå‡†å¤‡å·¥ä½œ åœ¨å¼€å§‹å‰,æˆ‘ä»¬éœ€è¦å‡†å¤‡:\nAWSè´¦å·:å¼€é€šä¸€ä¸ªAWSè´¦å·ã€‚ SNSä¸»é¢˜:åœ¨SNSä¸Šåˆ›å»ºä¸€ä¸ªä¸»é¢˜,å¹¶æ·»åŠ è®¢é˜…è€…ã€‚è®¢é˜…æ–¹å¼å¯ä»¥æ˜¯é‚®ä»¶ã€çŸ­ä¿¡ç­‰ã€‚ VPC ID:ç™»å½•VPCæ§åˆ¶å°è·å–VPC IDã€‚ Lambdaï¼šéœ€è¦åˆ›å»ºä¸€ä¸ªLambdaã€‚ åˆ›å»ºSNSä¸»é¢˜ æ¥ä¸‹æ¥,æˆ‘ä»¬éœ€è¦åœ¨AWS SNSä¸Šåˆ›å»ºä¸€ä¸ªä¸»é¢˜,å¹¶å°†è®¢é˜…è€…æ·»åŠ åˆ°ä¸»é¢˜ä¸­ã€‚è¿™äº›è®¢é˜…è€…å°†ä¼šæ¥æ”¶ç£ç›˜ä½¿ç”¨è¶…è¿‡é˜ˆå€¼æ—¶çš„é€šçŸ¥ã€‚æˆ‘ä»¬å¯ä»¥é€‰æ‹©ç”µå­é‚®ä»¶ã€çŸ­ä¿¡ç­‰é€šçŸ¥æ–¹å¼ã€‚\nç™»å½•åˆ° Amazon SNS æ§åˆ¶å°ã€‚ å•å‡»å·¦ä¾§é¢æ¿ä¸Šçš„â€œä¸»é¢˜â€,ç„¶åå•å‡»â€œåˆ›å»ºä¸»é¢˜â€ã€‚ è¾“å…¥ä¸»é¢˜åç§°å’Œä¸»é¢˜æ˜¾ç¤ºåç§°,å•å‡»â€œåˆ›å»ºä¸»é¢˜â€ã€‚ åœ¨ä¸»é¢˜é¡µé¢ä¸Š,å•å‡»â€œè®¢é˜…â€,é€‰æ‹©å¸Œæœ›æ¥æ”¶é€šçŸ¥çš„é€šçŸ¥æ–¹å¼ã€‚ æ ¹æ®é€‰å®šçš„è®¢é˜…ç±»å‹è¾“å…¥ç›¸å…³ä¿¡æ¯,å•å‡»â€œåˆ›å»ºè®¢é˜…â€ã€‚ åœ¨ä¸»é¢˜é¡µé¢ä¸Š,æ‚¨å°†çœ‹åˆ°å·²åˆ›å»ºçš„è®¢é˜…ã€‚\nä¸¾ä¸ªä¾‹å­,å¦‚æœæˆ‘ä»¬é€‰æ‹©â€œé‚®ä»¶â€ä½œä¸ºè®¢é˜…æ–¹å¼: åœ¨â€œç”µå­é‚®ä»¶è®¢é˜…â€ä¸‹,è¾“å…¥æ¥æ”¶é€šçŸ¥çš„ç”µå­é‚®ä»¶åœ°å€ã€‚ å•å‡»â€œåˆ›å»ºè®¢é˜…â€ã€‚ æ‚¨åº”ä¼šæ”¶åˆ°ä¸€å°æ¥è‡ªAWSé€šçŸ¥çš„éªŒè¯ç”µå­é‚®ä»¶ã€‚è¯·æŒ‰ç…§ç”µå­é‚®ä»¶ä¸­çš„è¯´æ˜è¿›è¡ŒéªŒè¯ã€‚ ä¸€æ—¦éªŒè¯é€šè¿‡,è¯¥è®¢é˜…å°†å˜ä¸ºâ€œå·²éªŒè¯â€çŠ¶æ€ã€‚ ç°åœ¨,å½“CloudWatchå‘Šè­¦è§¦å‘å¹¶è°ƒç”¨SNSä¸»é¢˜æ—¶,éªŒè¯çš„ç”µå­é‚®ä»¶åœ°å€å°†æ”¶åˆ°æœ‰å…³è­¦æŠ¥çš„ç”µå­é‚®ä»¶é€šçŸ¥ã€‚æˆ‘ä»¬ä¹Ÿå¯ä»¥æ·»åŠ å¤šä¸ªè®¢é˜…ä»¥æ¥æ”¶é€šè¿‡ä¸åŒæ¸ é“çš„é€šçŸ¥,ä¾‹å¦‚ç”µå­é‚®ä»¶ã€çŸ­ä¿¡ç­‰ã€‚ æ·»åŠ è®¢é˜…è€…å,æˆ‘ä»¬å¯ä»¥åœ¨SNSä¸»é¢˜çš„â€œæ¦‚è¿°â€é¡µæŸ¥çœ‹è®¢é˜…çš„è¯¦ç»†ä¿¡æ¯å’ŒçŠ¶æ€ã€‚åœ¨æµ‹è¯•Lambdaå‡½æ•°æ—¶,è¿™æœ‰åŠ©äºç¡®ä¿è®¢é˜…è®¾ç½®æ­£ç¡®å’Œé€šçŸ¥èƒ½æ­£å¸¸å‘é€ã€‚\nåˆ›å»ºLambdaå‡½æ•° æ¥ä¸‹æ¥,æˆ‘ä»¬å¯ä»¥åœ¨Lambdaæ§åˆ¶å°åˆ›å»ºä¸€ä¸ªæ–°çš„Lambdaå‡½æ•°ã€‚\nè®¿é—® Amazon Lambda æ§åˆ¶å°,ç‚¹å‡»â€œåˆ›å»ºå‡½æ•°â€ã€‚ é€‰æ‹©â€œä»å¤´å¼€å§‹â€ ,è¾“å…¥å‡½æ•°åç§°,å¦‚â€œcreate_cloudwatch_alarm_for_ec2_disk_usageâ€ã€‚ é€‰æ‹©Pythonä½œä¸ºè¿è¡Œç¯å¢ƒ,é€‰æ‹© åˆ›å»ºå…·æœ‰åŸºæœ¬ Lambda æƒé™çš„æ–°è§’è‰²ã€‚ ç‚¹å‡»â€œåˆ›å»ºå‡½æ•°â€ã€‚ ç¼–å†™Lambdaå‡½æ•°ä»£ç  ä»£ç æˆ‘å·²ç»å†™å¥½äº†ï¼Œå„ä½å¤§ä½¬æ”¶å¥½ã€‚ä»£ç åŠŸèƒ½æ˜¯ä¸ºæ‰€æœ‰EC2å®ä¾‹è®¾ç½®CloudWatchç£ç›˜å‘Šè­¦,å½“ç£ç›˜åˆ©ç”¨ç‡è¶…è¿‡é˜ˆå€¼æ—¶,é€šè¿‡SNSä¸»é¢˜å‘é€é€šçŸ¥ã€‚\nè¿æ¥EC2å®¢æˆ·ç«¯ã€‚ è·å–VPCä¸­è¿è¡Œçš„EC2å®ä¾‹åˆ—è¡¨ã€‚ éå†å®ä¾‹åˆ›å»ºCloudWatchç£ç›˜ä½¿ç”¨ç™¾åˆ†æ¯”å‘Šè­¦ã€‚é»˜è®¤é˜ˆå€¼æ˜¯80%ã€‚ å‘Šè­¦è§¦å‘SNSä¸»é¢˜â€œyou_sns_arnâ€ã€‚ å°†ä¸‹é¢ä»£ç å¤åˆ¶åè¿›è¡Œéƒ¨åˆ†ä¿®æ”¹ã€‚ç„¶åæ›¿æ¢æ‰åŸæœ‰ä»£ç åï¼Œç„¶åä¿å­˜å¹¶éƒ¨ç½²ã€‚\nä¸‹é¢æ˜¯å…·ä½“ä»£ç å†…å®¹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 \u0026#39;\u0026#39;\u0026#39; Author : Wenlong Xue Date : 2023-02-27 13:35 LastEditors : Wenlong Xue LastEditTime : 2023-02-27 17:52 Description : ä¸º VPC ä¸­çš„ EC2 å®ä¾‹åˆ›å»ºç£ç›˜ä½¿ç”¨ç™¾åˆ†æ¯”çš„ CloudWatch å‘Šè­¦ï¼Œå¹¶åœ¨ç£ç›˜ä½¿ç”¨è¶…è¿‡é˜ˆå€¼æ—¶å‘é€é€šçŸ¥åˆ° SNS ä¸»é¢˜ \u0026#39;\u0026#39;\u0026#39; import boto3 def lambda_handler(event, context): # è¿æ¥åˆ° EC2 å®¢æˆ·ç«¯ ec2 = boto3.client(\u0026#39;ec2\u0026#39;) # è·å– VPC ä¸­è¿è¡Œä¸­çš„å®ä¾‹åˆ—è¡¨ response = ec2.describe_instances( Filters=[ { \u0026#39;Name\u0026#39;: \u0026#39;vpc-id\u0026#39;, \u0026#39;Values\u0026#39;: [\u0026#39;vpc-xxxxxx\u0026#39;] # ä¿®æ”¹VPC ID }, { \u0026#39;Name\u0026#39;: \u0026#39;instance-state-name\u0026#39;, \u0026#39;Values\u0026#39;: [\u0026#39;running\u0026#39;] } ] ) # éå†å®ä¾‹å¹¶ä¸ºç£ç›˜ä½¿ç”¨ç™¾åˆ†æ¯”åˆ›å»º CloudWatch å‘Šè­¦ for reservation in response[\u0026#39;Reservations\u0026#39;]: for instance in reservation[\u0026#39;Instances\u0026#39;]: # è·å–å®ä¾‹ ID å’Œ Name æ ‡ç­¾ instance_id = instance[\u0026#39;InstanceId\u0026#39;] instance_name = \u0026#39;\u0026#39; for tag in instance[\u0026#39;Tags\u0026#39;]: if tag[\u0026#39;Key\u0026#39;] == \u0026#39;Name\u0026#39;: instance_name = tag[\u0026#39;Value\u0026#39;] break # åˆ›å»ºç£ç›˜ä½¿ç”¨ç™¾åˆ†æ¯”çš„ CloudWatch å‘Šè­¦ cloudwatch = boto3.client(\u0026#39;cloudwatch\u0026#39;) cloudwatch.put_metric_alarm( AlarmName=\u0026#39;{}-ç£ç›˜ä½¿ç”¨ç™¾åˆ†æ¯”\u0026#39;.format(instance_name), AlarmDescription=\u0026#39;{} - ç£ç›˜ä½¿ç”¨ç™¾åˆ†æ¯”\u0026#39;.format(instance_name), ActionsEnabled=True, AlarmActions=[\u0026#39;you_sns_arn\u0026#39;], # ä¿®æ”¹snsä¸»é¢˜,å¦‚:arn:aws-cn:sns:cn-north-1:xxxxx:HighDiskUsed MetricName=\u0026#39;disk_used_percent\u0026#39;, # æ ¹æ®æƒ…å†µä¿®æ”¹ Namespace=\u0026#39;CWAgent\u0026#39;, # æ ¹æ®æƒ…å†µä¿®æ”¹ Dimensions=[ { \u0026#39;Name\u0026#39;: \u0026#39;InstanceId\u0026#39;, \u0026#39;Value\u0026#39;: instance_id } ], Statistic=\u0026#39;Maximum\u0026#39;, Period=300, EvaluationPeriods=1, Threshold=80.0, ComparisonOperator=\u0026#39;GreaterThanOrEqualToThreshold\u0026#39; ) ç»™IAMè§’è‰²æ·»åŠ æƒé™ å› ä¸º åˆ›å»ºå…·æœ‰åŸºæœ¬ Lambda æƒé™çš„æ–°è§’è‰² çš„æƒé™å¹¶ä¸å®Œæ•´ï¼Œæ‰€ä»¥æˆ‘ä»¬è¦æŠŠä»£ç ä¸­æ‰€è¦ç”¨åˆ°çš„æƒé™ç»™åˆ°è¿™ä¸ªæ–°è§’è‰²ã€‚\né¦–å…ˆ,Lambdaä¸­æ‰¾åˆ°è¿™ä¸ªè§‰å¾—ç„¶åç»™ä»–æ·»åŠ å¯¹åº”çš„æƒé™ã€‚\næ‰¾åˆ°åˆ›å»ºçš„Lambda å‡½æ•°ã€‚ é€‰æ‹©å‡½æ•°æ±‡æ€»çš„é…ç½®\u0026ndash;æƒé™ã€‚ æ‰¾åˆ°æ‰§è¡Œè§’è‰²ï¼Œå¹¶ç‚¹å‡»è§’è‰²åç§°è¿æ¥ã€‚ ç‚¹å‡»æ·»åŠ æƒé™ï¼Œé€‰æ‹©é™„åŠ ç­–ç•¥ã€‚ æ·»åŠ  CloudWatchFullAccess å’Œ AmazonEC2ReadOnlyAccess æƒé™ æœ€åæƒé™å¦‚ä¸‹ï¼š\næ³¨æ„\nâš ï¸ è‹¥æç¤ºç¡®å°‘ä»€ä¹ˆæƒé™å°±è¡¥å……ä»€ä¹ˆæƒé™ã€‚ æµ‹è¯•å‡½æ•° ç°åœ¨,æˆ‘ä»¬å·²ç»åˆ›å»ºLambdaå‡½æ•°å’ŒSNSä¸»é¢˜,å¹¶å°†è®¢é˜…è€…æ·»åŠ åˆ°ä¸»é¢˜ã€‚æˆ‘ä»¬å¯ä»¥æµ‹è¯•Lambdaå‡½æ•°åŠŸèƒ½ã€‚\næˆ‘ä»¬å¯ä»¥æ‰‹åŠ¨è¿è¡Œæµ‹è¯•æ¥è§‚å¯Ÿ CloudWatchå‘Šè­¦é¡¹æœ‰æ²¡æœ‰è¢«æ·»åŠ ã€‚ æˆ‘ä»¬ä¹Ÿå¯ä»¥è¿›è¡Œæ·»åŠ è§¦å‘å™¨ã€‚å¦‚ï¼šå›ºå®šæ—¶é—´æ®µè¿è¡Œä¸€æ¬¡ï¼Œæ¥éå†æ–°åŠ çš„æœåŠ¡å™¨ã€‚ç„¶åæ·»åŠ å‘Šè­¦é¡¹ã€‚ å¸¸è§é—®é¢˜åŠè§£å†³æ–¹æ¡ˆ Q1: æ²¡æ”¶åˆ°SNSé€šçŸ¥æ€ä¹ˆåŠ?\nA1: ç¡®è®¤è®¢é˜…é‚®ç®±æ˜¯å¦æ­£ç¡®ã€‚æ£€æŸ¥AWSè´¦å·æ˜¯å¦æœ‰æƒé™å‘SNSå‘é€é€šçŸ¥ã€‚\nQ2: å¦‚ä½•ä¿®æ”¹ç£ç›˜ä½¿ç”¨é˜ˆå€¼?\nA2: ç¼–è¾‘Lambdaå‡½æ•°ä»£ç ,æ›´æ”¹\u0026quot;Threshold\u0026quot;çš„å€¼ã€‚\nQ3: CloudWatchçš„å‘Šè­¦é¡¹ä¸­æ˜¾ç¤ºæ•°æ®ä¸è¶³æ€ä¹ˆåŠ?\nA3: æŸ¥çœ‹CloudWatchä¸­åŸæœ¬ç£ç›˜çš„æŒ‡æ ‡åç§°ï¼Œå¹¶ä¿®æ”¹Lambdaå‡½æ•°ä»£ç å¯¹åº”çš„å€¼ï¼šMetricName=\u0026lsquo;disk_used_percent\u0026rsquo;ï¼›Namespace=\u0026lsquo;CWAgent\u0026rsquo; å‚è€ƒèµ„æ–™ AWS Lambdaæ–‡æ¡£: https://docs.aws.amazon.com/lambda/ AWS CloudWatchæ–‡æ¡£: https://docs.aws.amazon.com/AmazonCloudWatch/latest/monitoring/ AWS SNSæ–‡æ¡£: https://docs.aws.amazon.com/sns/index.html ä½œè€…ï¼šSREè¿ç»´åšå®¢\nåšå®¢åœ°å€ï¼šhttps://www.cnsre.cn/\næ–‡ç« åœ°å€ï¼šhttps://www.cnsre.cn/posts/230506425079/\nç›¸å…³è¯é¢˜ï¼šhttps://www.cnsre.cn/tags/lambda/\n","description":"æœ¬æ–‡ä»‹ç»å¦‚ä½•ä½¿ç”¨ AWS Lambda æ¥è‡ªåŠ¨æ·»åŠ  CloudWatch ç£ç›˜å‘Šè­¦å¹¶é€šè¿‡ SNS å‘é€é€šçŸ¥ã€‚","id":2,"section":"posts","tags":["lambda","aws","cloudwatch","sns","python"],"title":"å¦‚ä½•ä½¿ç”¨ Lambda è‡ªåŠ¨æ·»åŠ CloudWatchæ‰€æœ‰å®ä¾‹ç£ç›˜å‘Šè­¦åŠ SNS é€šçŸ¥","uri":"http://www.cnsre.cn:80/posts/230506425079/"},{"content":" ä½œè€…ï¼šSREè¿ç»´åšå®¢\nåšå®¢åœ°å€ï¼šhttps://www.cnsre.cn/\næ–‡ç« åœ°å€ï¼šhttps://www.cnsre.cn/posts/230410659053/\nç›¸å…³è¯é¢˜ï¼šhttps://www.cnsre.cn/tags/lambda/\nLambdaå‡½æ•°æ£€æŸ¥S3æ–‡ä»¶å¤¹æ˜¯å¦å­˜åœ¨ ä½œä¸º AWS ä¸­æœ€å¸¸ç”¨çš„å¯¹è±¡å­˜å‚¨æœåŠ¡ï¼ŒS3 å¯ä»¥ç”¨äºå­˜å‚¨å„ç§ç±»å‹çš„æ–‡ä»¶ï¼ŒåŒ…æ‹¬ç½‘ç«™æ–‡ä»¶ã€åª’ä½“æ–‡ä»¶ã€å¤‡ä»½æ–‡ä»¶ç­‰ç­‰ã€‚åœ¨ S3 ä¸­å­˜å‚¨çš„æ–‡ä»¶å¯ä»¥é€šè¿‡ä¸åŒçš„æ–¹å¼è®¿é—®ï¼Œä¾‹å¦‚åœ¨ Web åº”ç”¨ç¨‹åºä¸­ã€é€šè¿‡ç§»åŠ¨åº”ç”¨ç¨‹åºæˆ–ç›´æ¥ä½¿ç”¨ AWS SDK è®¿é—®ç­‰ã€‚\nåœ¨è¿›è¡Œ S3 å­˜å‚¨æ—¶ï¼Œå¦‚æœæˆ‘ä»¬éœ€è¦å°†å­˜å‚¨çš„æ—¥å¿—åŒæ­¥åˆ°å¦ä¸€ä¸ªæ¡¶æˆ–åŒºåŸŸä¸­ï¼Œåˆ™å¯ä»¥ä½¿ç”¨ AWS çš„ S3 æ—¥å¿—åŒæ­¥ä»»åŠ¡åŠŸèƒ½ã€‚é€šè¿‡å°†æ—¥å¿—åŒæ­¥åˆ°å…¶ä»–å­˜å‚¨æ¡¶æˆ–åŒºåŸŸä¸­ï¼Œæˆ‘ä»¬å¯ä»¥æ›´æ–¹ä¾¿åœ°å¯¹æ—¥å¿—è¿›è¡Œåˆ†æã€ç›‘æ§å’Œç®¡ç†ã€‚\nä½†æ˜¯ï¼Œå¦‚æœ S3 æ—¥å¿—åŒæ­¥ä»»åŠ¡å‡ºç°æ•…éšœï¼Œæˆ‘ä»¬å¯èƒ½æ— æ³•åŠæ—¶è·å–ç›¸å…³çš„æ—¥å¿—ä¿¡æ¯ã€‚å› æ­¤ï¼Œä¸ºäº†ç¡®ä¿æ—¥å¿—åŒæ­¥ä»»åŠ¡çš„æ­£å¸¸è¿è¡Œï¼Œæˆ‘ä»¬éœ€è¦å¯¹ä»»åŠ¡è¿›è¡Œç›‘æ§ã€‚åœ¨æœ¬æ–‡ä¸­ï¼Œæˆ‘ä»¬å°†ä»‹ç»å¦‚ä½•ä½¿ç”¨ AWS Lambda ç›‘æ§ S3 æ—¥å¿—åŒæ­¥ä»»åŠ¡ã€‚\nä»‹ç» AWS Lambda æ˜¯ä¸€ç§æ— æœåŠ¡å™¨è®¡ç®—æœåŠ¡ï¼Œå¯ä½¿æ‚¨åœ¨äº‘ä¸­è¿è¡Œä»£ç ï¼Œè€Œæ— éœ€è‡ªå·±ç®¡ç†æœåŠ¡å™¨ã€‚é€šè¿‡ä½¿ç”¨ Lambdaï¼Œæ‚¨å¯ä»¥å°†ä»£ç ä¸Šä¼ åˆ°äº‘ä¸­ï¼Œç„¶å Lambda ä¼šæ ¹æ®éœ€è¦è‡ªåŠ¨æ‰©å±•å’Œç¼©å‡è®¡ç®—èµ„æºï¼Œä»¥æ»¡è¶³æ‚¨çš„åº”ç”¨ç¨‹åºçš„è¯·æ±‚ã€‚Lambda è¿˜æ”¯æŒè®¸å¤šç¼–ç¨‹è¯­è¨€å’Œåº“ï¼Œä½¿æ‚¨èƒ½å¤Ÿç¼–å†™åŠŸèƒ½å¼ºå¤§çš„åº”ç”¨ç¨‹åºå’ŒæœåŠ¡ã€‚\nåœ¨æœ¬æ–‡ä¸­ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨ Lambda ç¼–å†™ä¸€ä¸ªå‡½æ•°ï¼Œè¯¥å‡½æ•°å°†å®šæœŸæ£€æŸ¥ S3 å­˜å‚¨æ¡¶ä¸­çš„æ–‡ä»¶å¤¹æ˜¯å¦å­˜åœ¨ã€‚å¦‚æœä¸å­˜åœ¨ä»»ä½•æ–‡ä»¶å¤¹ï¼Œåˆ™ Lambda å°†å‘æŒ‡å®šçš„ SNS ä¸»é¢˜å‘é€ä¸€æ¡æ¶ˆæ¯ï¼Œä»¥ä¾¿ç®¡ç†å‘˜å¯ä»¥åŠæ—¶é‡‡å–æªæ–½ã€‚é€šè¿‡ä½¿ç”¨ Lambda ç›‘æ§ S3 å­˜å‚¨æ¡¶ä¸­çš„æ–‡ä»¶å¤¹ï¼Œæˆ‘ä»¬å¯ä»¥ç¡®ä¿æ—¥å¿—åŒæ­¥ä»»åŠ¡çš„æ­£å¸¸è¿è¡Œã€‚\n1. å‡†å¤‡å·¥ä½œ åœ¨å¼€å§‹ä¹‹å‰ï¼Œæˆ‘ä»¬éœ€è¦å…ˆå‡†å¤‡å¥½ä»¥ä¸‹å·¥ä½œï¼š\nä¸€ä¸ªS3æ¡¶ï¼Œç”¨äºå­˜å‚¨æˆ‘ä»¬è¦æ£€æŸ¥çš„æ–‡ä»¶å¤¹ã€‚ ä¸€ä¸ªSNSä¸»é¢˜ï¼Œç”¨äºå‘é€æ¶ˆæ¯æé†’ã€‚ 2. åˆ›å»ºLambdaå‡½æ•° åœ¨AWSæ§åˆ¶å°ä¸Šåˆ›å»ºä¸€ä¸ªPython Lambdaå‡½æ•°ï¼Œåç§°ä¸ºs3-folder-exist-checkerï¼Œå¹¶ä½¿ç”¨ä»¥ä¸‹ä»£ç ï¼š\nimport boto3 from datetime import datetime, timedelta from dateutil import tz def lambda_handler(event, context): print(\u0026#39;Lambda å‡½æ•°å·²å¯åŠ¨.\u0026#39;) s3 = boto3.resource(\u0026#39;s3\u0026#39;) bucket_name = \u0026#39;my_s3_bucket_name\u0026#39; local_tz = tz.gettz(\u0026#39;Asia/Shanghai\u0026#39;) now = datetime.now() date_prefix = now.strftime(\u0026#39;%Y/%m/%d/\u0026#39;) folder_prefixes = [\u0026#39;my_prefixes/\u0026#39; + date_prefix, \u0026#39;my_prefixes/\u0026#39; + date_prefix, \u0026#39;RGC-Prod-3in1oven/\u0026#39; + date_prefix] folder_prefixes = [prefix + \u0026#39;/\u0026#39; if not prefix.endswith(\u0026#39;/\u0026#39;) else prefix for prefix in folder_prefixes] # ç¡®ä¿æ¯ä¸ªå‰ç¼€ä»¥æ–œæ ç»“å°¾ print(\u0026#39;æ­£åœ¨æ£€æŸ¥ä»¥ä¸‹ S3 æ–‡ä»¶å¤¹ï¼š\u0026#39;, folder_prefixes) sns = boto3.client(\u0026#39;sns\u0026#39;) topic_arn = \u0026#39;arn:aws-cn:sns:cn-north-1:1234567890:s3-logs-monitoring\u0026#39; for prefix in folder_prefixes: resp = s3.meta.client.list_objects_v2(Bucket=bucket_name, Prefix=prefix, Delimiter=\u0026#39;/\u0026#39;) subfolders = [p[\u0026#39;Prefix\u0026#39;] for p in resp.get(\u0026#39;CommonPrefixes\u0026#39;, [])] if len(subfolders) \u0026gt; 0: print(f\u0026#34;å­æ–‡ä»¶å¤¹ \u0026#39;{prefix}\u0026#39; å­˜åœ¨:\u0026#34;) for folder in subfolders: print(f\u0026#34;å‘ç°å­æ–‡ä»¶å¤¹: {folder}\u0026#34;) else: message = f\u0026#34;S3æ¡¶\u0026#39;{bucket_name}ä¸­\u0026#39;{prefix}\u0026#39;ä¸‹ä¸å­˜åœ¨æ–°å¢æ–‡ä»¶å¤¹,å³æ—¥å¿—åŒæ­¥S3æ¡¶ä»»åŠ¡å¤±è´¥.è¯·æ£€æŸ¥.\u0026#39;\u0026#34; sns.publish(TopicArn=topic_arn, Message=message) print(f\u0026#34;å·²å‘é€ SNS æ¶ˆæ¯: {message}\u0026#34;) print(\u0026#39;Lambda å‡½æ•°å·²å®Œæˆ.\u0026#39;) return { \u0026#39;statusCode\u0026#39;: 200, \u0026#39;body\u0026#39;: \u0026#39;S3 æ–‡ä»¶å¤¹å­˜åœ¨æ€§æ£€æŸ¥å·²å®Œæˆ.\u0026#39; } æ¥ä¸‹æ¥æ˜¯å¯¹ Lambda å‡½æ•°ä¸­çš„ä¸€äº›ç»†èŠ‚è¿›è¡Œè®²è§£ã€‚é¦–å…ˆï¼Œæˆ‘ä»¬å®šä¹‰äº† S3 çš„èµ„æºï¼Œå¹¶ä¸”æŒ‡å®šäº† S3 æ¡¶çš„åç§°ï¼š\ns3 = boto3.resource(\u0026#39;s3\u0026#39;) bucket_name = \u0026#39;my_bucket_name\u0026#39; æ¥ç€ï¼Œæˆ‘ä»¬è·å–å½“å‰çš„æ—¶é—´ï¼Œå¹¶ä¸”æ ¹æ®å½“å‰æ—¶é—´ç”Ÿæˆä¸€ä¸ªç›®å½•å‰ç¼€ã€‚æˆ‘ä»¬ä½¿ç”¨ dateutil æ¨¡å—ä¸­çš„ tz.gettz å‡½æ•°æ¥è·å–ä¸€ä¸ªæœ¬åœ°çš„æ—¶åŒºä¿¡æ¯ã€‚ä¸ºäº†ç¡®ä¿æ—¶åŒºçš„å‡†ç¡®æ€§ï¼Œæˆ‘ä»¬å»ºè®®åœ¨ä½¿ç”¨ Lambda å‡½æ•°æ—¶ï¼Œæ˜¾å¼åœ°è®¾ç½®æ—¶åŒºä¿¡æ¯ï¼š\nlocal_tz = tz.gettz(\u0026#39;Asia/Shanghai\u0026#39;) now = datetime.now(local_tz) date_prefix = now.strftime(\u0026#39;%Y/%m/%d/\u0026#39;) åœ¨ Lambda å‡½æ•°ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨äº† list_objects_v2 æ–¹æ³•æ¥åˆ—ä¸¾æŒ‡å®šçš„æ–‡ä»¶å¤¹ã€‚å…·ä½“æ¥è¯´ï¼Œæˆ‘ä»¬ä½¿ç”¨äº† CommonPrefixes å‚æ•°ï¼Œè¯¥å‚æ•°å¯ä»¥è¿”å›æŒ‡å®šå‰ç¼€ä¸‹çš„å­æ–‡ä»¶å¤¹åˆ—è¡¨ã€‚å¦‚æœè¿”å›çš„å­æ–‡ä»¶å¤¹åˆ—è¡¨ä¸ºç©ºï¼Œåˆ™è¯´æ˜æŒ‡å®šçš„æ–‡ä»¶å¤¹ä¸å­˜åœ¨ã€‚å¦‚æœå­æ–‡ä»¶å¤¹åˆ—è¡¨ä¸ä¸ºç©ºï¼Œåˆ™è¯´æ˜æ–‡ä»¶å¤¹å­˜åœ¨ï¼Œå¹¶ä¸”æˆ‘ä»¬å¯ä»¥å°†æ¯ä¸ªå­æ–‡ä»¶å¤¹çš„è·¯å¾„æ‰“å°å‡ºæ¥ï¼š\nresp = s3.meta.client.list_objects_v2(Bucket=bucket_name, Prefix=prefix, Delimiter=\u0026#39;/\u0026#39;) subfolders = [p[\u0026#39;Prefix\u0026#39;] for p in resp.get(\u0026#39;CommonPrefixes\u0026#39;, [])] if len(subfolders) \u0026gt; 0: print(f\u0026#34;å­æ–‡ä»¶å¤¹ \u0026#39;{prefix}\u0026#39; å­˜åœ¨:\u0026#34;) for folder in subfolders: print(f\u0026#34;å‘ç°å­æ–‡ä»¶å¤¹: {folder}\u0026#34;) å¦‚æœå­æ–‡ä»¶å¤¹åˆ—è¡¨ä¸ºç©ºï¼Œåˆ™è¯´æ˜æ–‡ä»¶å¤¹ä¸å­˜åœ¨ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ SNS æœåŠ¡å‘é€ä¸€æ¡æ¶ˆæ¯æ¥é€šçŸ¥ç®¡ç†å‘˜ï¼š\nif len(subfolders) == 0: message = f\u0026#34;S3æ¡¶\u0026#39;{bucket_name}ä¸­\u0026#39;{prefix}\u0026#39;ä¸‹ä¸å­˜åœ¨æ–°å¢æ–‡ä»¶å¤¹,å³æ—¥å¿—åŒæ­¥S3æ¡¶ä»»åŠ¡å¤±è´¥.è¯·æ£€æŸ¥.\u0026#39;\u0026#34; sns.publish(TopicArn=topic_arn, Message=message) print(f\u0026#34;å·²å‘é€ SNS æ¶ˆæ¯: {message}\u0026#34;) æœ€åï¼Œæˆ‘ä»¬è¿”å›äº†ä¸€ä¸ªåŒ…å«çŠ¶æ€ç å’Œæ¶ˆæ¯çš„å­—å…¸ï¼Œä»¥ä¾¿å¯ä»¥åœ¨ Lambda å‡½æ•°æ‰§è¡Œè¿‡ç¨‹ä¸­ç›‘æ§æ‰§è¡ŒçŠ¶æ€ï¼š\nreturn { \u0026#39;statusCode\u0026#39;: 200, \u0026#39;body\u0026#39;: \u0026#39;S3 æ–‡ä»¶å¤¹å­˜åœ¨æ€§æ£€æŸ¥å·²å®Œæˆ.\u0026#39; } ç¡®ä¿æ‚¨çš„ Lambda å‡½æ•°æœ‰æƒé™è®¿é—® S3 å’Œ SNS\nåœ¨ AWS Lambda æ§åˆ¶å°ä¸­ï¼Œåˆ›å»ºä¸€ä¸ªæ–°çš„ Lambda å‡½æ•°ã€‚åœ¨å‡½æ•°ä»£ç ä¸­å°† Python ä»£ç ç²˜è´´åˆ°ä»£ç ç¼–è¾‘å™¨ä¸­ã€‚è¯·ç¡®ä¿æ‚¨é€‰æ‹©äº†æ­£ç¡®çš„è¿è¡Œæ—¶ç¯å¢ƒï¼Œå¹¶è®¾ç½®ä»¥ä¸‹ç¯å¢ƒå˜é‡ï¼š\nBUCKET_NAMEï¼šæ‚¨çš„ S3 æ¡¶åç§° SNS_TOPIC_ARNï¼šSNS ä¸»é¢˜çš„ ARN é…ç½® Lambda å‡½æ•°çš„åŸºæœ¬è®¾ç½®å’Œé«˜çº§è®¾ç½®ï¼ŒåŒ…æ‹¬å†…å­˜å’Œè¶…æ—¶ã€‚\nåœ¨ Lambda æ§åˆ¶å°ä¸­ï¼Œæµ‹è¯• Lambda å‡½æ•°ï¼Œä»¥ç¡®ä¿ Lambda å‡½æ•°èƒ½å¤Ÿè®¿é—® S3 æ¡¶å’Œ SNS ä¸»é¢˜ã€‚ä¸ºäº†æµ‹è¯•è¯¥å‡½æ•°ï¼Œæ‚¨å¯ä»¥åˆ›å»ºä¸€ä¸ªæµ‹è¯•äº‹ä»¶ï¼Œè¯¥äº‹ä»¶éœ€è¦ä¸€ä¸ªç©ºçš„ JSON å¯¹è±¡ï¼Œä¾‹å¦‚ï¼š\næœ€åï¼Œæ‚¨éœ€è¦åœ¨ Amazon CloudWatch ä¸­è®¾ç½® CloudWatch Events è§„åˆ™ä»¥å®šæœŸè§¦å‘ Lambda å‡½æ•°ã€‚è¿™æ ·æ‚¨çš„ Lambda å‡½æ•°å°±èƒ½åœ¨æ‚¨é¢„å®šçš„æ—¶é—´æ£€æŸ¥ S3 æ–‡ä»¶å¤¹æ˜¯å¦å­˜åœ¨å¹¶å‘é€é€šçŸ¥ã€‚\næ€»ç»“ åœ¨è¿™ç¯‡æ–‡ç« ä¸­ï¼Œæˆ‘ä»¬ä»‹ç»äº†ä¸€ä¸ªä½¿ç”¨ AWS Lambdaã€S3 å’Œ SNS çš„è‡ªåŠ¨åŒ–ä»»åŠ¡ï¼Œè¯¥ä»»åŠ¡å®šæœŸæ£€æŸ¥ S3 æ–‡ä»¶å¤¹æ˜¯å¦å­˜åœ¨å¹¶å‘é€é€šçŸ¥ã€‚æˆ‘ä»¬è§£é‡Šäº†å¦‚ä½•ç¼–å†™ Python ä»£ç æ¥å®ç°æ­¤ä»»åŠ¡ï¼Œå¹¶æä¾›äº†ä¸€ä¸ªè¯¦ç»†çš„ä»£ç ç¤ºä¾‹ã€‚æˆ‘ä»¬è¿˜ä»‹ç»äº†å¦‚ä½•åœ¨ AWS Lambda å’Œ Amazon SNS æ§åˆ¶å°ä¸Šé…ç½® Lambda å‡½æ•°å’Œ SNS ä¸»é¢˜ï¼Œå¹¶åœ¨ Amazon CloudWatch ä¸­åˆ›å»ºå®šæœŸè§¦å‘å™¨æ¥è§¦å‘ Lambda å‡½æ•°ã€‚æœ€åï¼Œæˆ‘ä»¬æä¾›äº†ä¸€äº›æœ€ä½³å®è·µå’Œæ³¨æ„äº‹é¡¹ï¼Œä»¥ç¡®ä¿æ‚¨çš„ Lambda å‡½æ•°å’Œ SNS ä¸»é¢˜èƒ½å¤Ÿæ­£å¸¸å·¥ä½œã€‚\nå¸Œæœ›è¿™ç¯‡æ–‡ç« å¯¹æ‚¨æœ‰æ‰€å¸®åŠ©ï¼å¦‚æœæ‚¨æœ‰ä»»ä½•ç–‘é—®æˆ–å»ºè®®ï¼Œè¯·åœ¨ä¸‹é¢çš„è¯„è®ºåŒºç•™è¨€ã€‚\nå‚è€ƒæ–‡çŒ® AWS Lambda æ–‡æ¡£ AWS S3 æ–‡æ¡£ AWS SNS æ–‡æ¡£ ä½œè€…ï¼šSREè¿ç»´åšå®¢\nåšå®¢åœ°å€ï¼šhttps://www.cnsre.cn/\næ–‡ç« åœ°å€ï¼šhttps://www.cnsre.cn/posts/230410659053/\nç›¸å…³è¯é¢˜ï¼šhttps://www.cnsre.cn/tags/lambda/\n","description":"ä½¿ç”¨ Lambda å‡½æ•°æ£€æŸ¥å½“å‰æ—¥æœŸï¼ˆä¸Šæµ·æ—¶åŒºï¼‰çš„ S3 æ–‡ä»¶å¤¹æ˜¯å¦å­˜åœ¨ï¼Œå¦‚æœä¸å­˜åœ¨ä»»ä½•æ–‡ä»¶å¤¹ï¼Œåˆ™å‘é€ SNS æ¶ˆæ¯ã€‚","id":3,"section":"posts","tags":["lambda","python","aws"],"title":"Lambdaå‡½æ•°æ£€æŸ¥S3æ–‡ä»¶å¤¹æ˜¯å¦å­˜åœ¨","uri":"http://www.cnsre.cn:80/posts/230410659053/"},{"content":" ä½œè€…ï¼šSREè¿ç»´åšå®¢\nåšå®¢åœ°å€ï¼šhttps://www.cnsre.cn/\næ–‡ç« åœ°å€ï¼šhttps://www.cnsre.cn/posts/230129126154/\nç›¸å…³è¯é¢˜ï¼šhttps://www.cnsre.cn/tags/aws/\nèƒŒæ™¯éœ€æ±‚ å› ä¸ºé¡¹ç›®çš„å®‰å…¨æ€§ã€‚ä¸ºäº†é¿å…é¡¹ç›®çš„æœåŠ¡å™¨æš´éœ²åœ¨å…¬ç½‘ä¸­ã€‚å¾ˆå¤šæ—¶å€™æˆ‘ä»¬ä¼šä½¿ç”¨è·³æ¿æœºæˆ–è€…æ˜¯ä¸€äº›ä¸‰æ–¹çš„è¿œç¨‹å·¥å…·ï¼Œæ¥è¿›è¡Œä¸€äº›å®‰å…¨æ€§æ¯”è¾ƒé«˜çš„æ–¹å¼æ¥è¿›è¡Œè¿œç¨‹é¡¹ç›®çš„æœåŠ¡å™¨ï¼Œä½†æ˜¯å¾€å¾€è¶Šå®‰å…¨çš„æ–¹å¼å°±è¶Šéº»çƒ¦ã€‚é‚£æœ‰æ²¡æœ‰ä¸€ç§æ—¢å®‰å…¨ï¼Œæœ‰ä¾¿æ·çš„è¿æ¥æ–¹å¼å‘¢ï¼Ÿå½“ç„¶æœ‰ï¼Œä»Šå¤©å°±ä»‹ç»ä¸‹AWS Session Managerã€‚\nå‰ç½®éœ€æ±‚ ä¸€å° EC2 æœåŠ¡å™¨ï¼ˆéœ€è¦å¼€å¯ SSM è¿œç¨‹æœåŠ¡å¹¶åˆ†é…æƒé™ï¼‰ ä¸€ä¸ª AWS è´¦æˆ· å®‰è£…é…ç½® SSM Agent åœ¨ Amazon Linux 2 ä¸­å®‰è£…SSM Agent x86_64\n1 sudo yum install -y https://s3.amazonaws.com/ec2-downloads-windows/SSMAgent/latest/linux_amd64/amazon-ssm-agent.rpm ARM64\n1 sudo yum install -y https://s3.amazonaws.com/ec2-downloads-windows/SSMAgent/latest/linux_arm64/amazon-ssm-agent.rpm åœ¨ CentOS 7.x ä¸Šå®‰è£… SSM Agent x86_64\n1 sudo yum install -y https://s3.amazonaws.com/ec2-downloads-windows/SSMAgent/latest/linux_amd64/amazon-ssm-agent.rpm ARM64\n1 sudo yum install -y https://s3.amazonaws.com/ec2-downloads-windows/SSMAgent/latest/linux_arm64/amazon-ssm-agent.rpm å¯åŠ¨æœåŠ¡å¹¶è®¾ç½®ä¸ºå¼€æœºå¯åŠ¨ 1 2 sudo systemctl status amazon-ssm-agent sudo systemctl enable amazon-ssm-agent å¦‚å…¶ä»–ç³»ç»Ÿå®‰è£…è¯·å‚è€ƒ åœ¨é€‚ç”¨äº Linux çš„ EC2 å®ä¾‹ä¸Šæ‰‹åŠ¨å®‰è£… SSM Agent ç»™ EC2 åˆ†é…å¯¹åº”æƒé™ åœ¨è§’è‰²ç®¡ç†ä¸­é€‰æ‹©åˆ›å»ºè§’è‰²ã€‚\nå¦‚ä¸‹å¦‚å›¾æ‰€ç¤ºé€‰æ‹©å¯¹åº”é€‰é¡¹ã€‚\næœç´¢AmazonSSMFullAccess é€‰æ‹©ä¸‹ä¸€æ­¥\nå¡«å…¥è§’è‰²åç§°ï¼Œç„¶ååˆ›å»ºè§’è‰²\nåœ¨ AWS EC2 æ§åˆ¶å°ä¸­æ‰¾åˆ°å¯¹åº”çš„æœåŠ¡å™¨ï¼Œç„¶åç‚¹å‡»æ“ä½œ``å®‰å…¨ ä¿®æ”¹IAMè§’è‰²\nåœ¨æ¡†å†…æœç´¢åˆšæ‰åˆ›å»ºçš„è§’è‰²åç§°ã€‚ç„¶åç¡®å®šé€‰æ‹©ã€‚\nAWS ä¸­çš„è¿œç¨‹é“¾æ¥æ–¹å¼ Session Manager å®‰è£…å®Œä»¥åå¯ä»¥åœ¨AWS ä¸­æˆ‘ä»¬å¯ä»¥ç›´æ¥é€šè¿‡æ§åˆ¶å°å»é“¾æ¥ Linux æœåŠ¡å™¨ï¼Œå¦‚ä¸‹å›¾ã€‚åœ¨é€‰ä¸­å®ä¾‹ä»¥å åœ¨å³ä¸Šè§’ä¸­é€‰æ‹©è¿æ¥ã€‚ç„¶åå†æ¬¡è¿›è¡Œè¿œç¨‹ç™»å½•æœåŠ¡ã€‚\nå¦‚é‡åˆ°æ— æ³•è¿œç¨‹çš„æƒ…å†µè¯·æŒ‰ç…§ä¸‹é¢çš„æ–¹æ³•å°†å®‰è£…ssmæœåŠ¡ã€‚\nåœ¨ SSM ä¸­è¿›è¡Œè¿œç¨‹é“¾æ¥ åœ¨æ§åˆ¶å° Amazon Systems Manager ä¸­é€‰æ‹© Session Manager\né€‰æ‹©å¯åŠ¨ä¼šè¯ã€‚\né€‰æ‹©å¯¹åº”çš„å®ä¾‹ ç„¶åç‚¹å‡»å¯åŠ¨ä¼šè¯ã€‚\nç„¶åå°±è¿›å…¥åˆ°äº†ç³»ç»Ÿç•Œé¢ã€‚\nå¦‚ä½•é€šè¿‡IAMè®©ä¸åŒçš„ aws ç”¨æˆ·æ‹¥æœ‰ä¸åŒçš„è¿œç¨‹æœåŠ¡å™¨æƒé™ï¼Ÿä¸‹ç¯‡æ–‡ç« å°†ä¼šä»‹ç» Session Manager çš„è¿›é˜¶ç”¨æ³• ä½œè€…ï¼šSREè¿ç»´åšå®¢\nåšå®¢åœ°å€ï¼šhttps://www.cnsre.cn/\næ–‡ç« åœ°å€ï¼šhttps://www.cnsre.cn/posts/230129126154/\nç›¸å…³è¯é¢˜ï¼šhttps://www.cnsre.cn/tags/aws/\n","description":"å› ä¸ºä¸€äº›é¡¹ç›®çš„åŸå› ï¼Œä¸èƒ½å¼€æ”¾ SSH ç«¯å£ã€‚è¿™å°±éœ€è¦ç”¨å…¶ä»–çš„æ–¹å¼æ¥è¿œç¨‹AWSä¸­çš„EC2ï¼Œé€šè¿‡SSMä¸­çš„Session Managerèƒ½å®Œç¾è§£å†³è¿™ä¸ªé—®é¢˜ã€‚","id":4,"section":"posts","tags":["aws","ssm"],"title":"AWS ä¸­çš„å¦å¤–ä¸€ç§è¿œç¨‹å·¥å…· AWS Session Manager","uri":"http://www.cnsre.cn:80/posts/230129126154/"},{"content":" ä½œè€…ï¼šSREè¿ç»´åšå®¢\nåšå®¢åœ°å€ï¼šhttps://www.cnsre.cn/\næ–‡ç« åœ°å€ï¼šhttps://www.cnsre.cn/posts/221207116004/\nç›¸å…³è¯é¢˜ï¼šhttps://www.cnsre.cn/tags/k3s/\nå»å¹´åŒåä¸€ä¹°çš„æœåŠ¡å™¨ï¼Œä½†æ˜¯åˆ›å»ºäº† K3S é›†ç¾¤ã€‚ä»Šå¤©ç™»å½•çš„æ—¶å€™å‘ç°å‡ºç°äº†ä»¥ä¸‹é”™è¯¯ã€‚ç®€å•è®°å½•ä¸‹ã€‚\næ•…éšœç°è±¡ ç™»å½•æœåŠ¡å™¨æ‰§è¡Œç›¸å…³å‘½ä»¤å‡ºç°ä»¥ä¸‹é”™è¯¯\n1 2 [root@k3s-master ~]# kubectl get pods error: You must be logged in to the server (Unauthorized) æ‰§è¡Œ doker å‘½ä»¤åˆ¤æ–­å¤§æ¦‚é—®é¢˜\n1 2 [root@k3s-master ~]# docker run -it ubuntu /bin/echo \u0026#34;cnsre\u0026#34; cnsre docker å‘½ä»¤å¯ä»¥æ‰§è¡Œé‚£å¤§æ¦‚ç‡åº”è¯¥æ˜¯ k3s çš„é—®é¢˜,æŸ¥çœ‹ k3s æœåŠ¡æ—¥å¿—\n1 2 [root@k3s-master ~]# journalctl -r -u k3s 1466 authentication.go:63] \u0026#34;Unable to authenticate the request\u0026#34; err=\u0026#34;[x509: certificate has expired or is not yet valid: current time å‘ç°æœ‰ä»¥ä¸Šé”™è¯¯ï¼Œé‚£ç¡®å®šæ˜¯è¯ä¹¦çš„é—®é¢˜äº†ã€‚\nè§£å†³æ–¹æ³• å¯¹äºK3S æ¥è¯´è§£å†³è¯ä¹¦çš„é—®é¢˜å…¶å®å¾ˆç®€å•ã€‚\nå¯ä»¥é€šè¿‡é‡å¯K3S æœåŠ¡çš„æ¥è§£å†³é—®é¢˜\n1 sudo systemctl restart k3s éªŒè¯ æ‰§è¡Œå‘½ä»¤éªŒè¯é—®é¢˜\n[root@k3s-master ~]# kubectl get node NAME STATUS ROLES AGE VERSION k3s-node1 Ready \u0026lt;none\u0026gt; 370d v1.21.5+k3s2 k3s-node2 Ready \u0026lt;none\u0026gt; 370d v1.21.5+k3s2 k3s-node3 Ready \u0026lt;none\u0026gt; 370d v1.21.5+k3s2 k3s-master Ready control-plane,master 370d v1.21.5+k3s2 é—®é¢˜è§£å†³ã€‚\nä½œè€…ï¼šSREè¿ç»´åšå®¢\nåšå®¢åœ°å€ï¼šhttps://www.cnsre.cn/\næ–‡ç« åœ°å€ï¼šhttps://www.cnsre.cn/posts/221207116004/\nç›¸å…³è¯é¢˜ï¼šhttps://www.cnsre.cn/tags/k3s/\n","description":"k3s é›†ç¾¤æç¤º \"error You must be logged in to the server (Unauthorized)\"","id":5,"section":"posts","tags":["k3s","æ•…éšœé›†"],"title":"k3s è¯ä¹¦è¿‡æœŸä¿®æ”¹","uri":"http://www.cnsre.cn:80/posts/221207116004/"},{"content":" ä½œè€…ï¼šSREè¿ç»´åšå®¢\nåšå®¢åœ°å€ï¼šhttps://www.cnsre.cn/\næ–‡ç« åœ°å€ï¼šhttps://www.cnsre.cn/posts/221205544069/\nç›¸å…³è¯é¢˜ï¼šhttps://www.cnsre.cn/tags/aws/\nèººäº†å¥½ä¹…ï¼Œè¯ˆå°¸äº†ã€‚å› ä¸ºæ¢äº†å·¥ä½œï¼Œæ‰€ä»¥æ¯”è¾ƒå¿™ä¸€ç›´æ²¡æœ‰æ—¶é—´å»æ›´æ–°åšå®¢çš„å†…å®¹ï¼ˆä¸»è¦è¿˜æ˜¯å› ä¸ºæ‡’ğŸ¤”ï¼‰\nè¯ä¸å¤šè¯´ ç›´æ¥ä¸Šå¹²è´§ã€‚\néœ€æ±‚èƒŒæ™¯ æœ€è¿‘åœ¨çœ‹è´¹ç”¨çš„æ—¶å€™å‘ç°æœ‰å¾ˆå¤§ä¸€éƒ¨åˆ†è´¹ç”¨éƒ½æ˜¯ cloudwatch logä¸­å­˜å‚¨äº†å¤§é‡çš„æ•°æ®ï¼Œæ˜¯å› ä¸ºec2 å°†æ—¥å¿—ä¼ è¾“åˆ°äº†å­˜å‚¨åˆ°äº†cloudwatchä¸­ã€‚è¿™ä¸ªå­˜å‚¨çš„å¤šçš„æŸ¥è¯¢æ—¥å¿—çš„æ—¶å€™æ”¶è´¹ç‰¹åˆ«çš„é«˜ã€‚å¦å¤–ä¸€ä¸ªæ˜¯å› ä¸ºæ•°æ®åˆ†æç”¨é€”ï¼Œå¤§æ•°æ®åˆ†æçš„åŒäº‹å¦‚æœæƒ³é‚£åˆ°æ•°æ®çš„è¯ï¼Œè¿˜æ˜¯å­˜å‚¨åœ¨ S3 ä¸­æ˜¯æ¯”è¾ƒåˆ’ç®—å’Œæ–¹ä¾¿çš„ï¼Œä¸€ä¸ªæ˜¯æ‹¿å–æ•°æ®æ¯”è¾ƒæ–¹ä¾¿ï¼Œå¦å¤–ä¸€ä¸ªæ˜¯S3 å¯ä»¥æœ€å½’æ¡£å­˜å‚¨ï¼Œåé¢çš„å¤§é‡æ•°æ®å¯ä»¥åˆ†å±‚å‚¨å­˜ï¼Œä»¥æ­¤æ¥é™ä½è´¹ç”¨ã€‚\nå¦‚æœä½ ä¹Ÿæƒ³å°†ä½ çš„cloudwatch ä¸­æ—¥å¿—ç»„ä¸­çš„æ—¥å¿—å­˜å‚¨åˆ°S3ä¸­çš„è¯å¯ä»¥å‚è€ƒä¸‹è¿™ç¯‡æ–‡ç« ã€‚\nå‰ç½®æ¡ä»¶ åˆ›å»º ä¸€ä¸ª S3 æ¡¶ï¼Œå¹¶ä¿®æ”¹æƒé™ åˆ›å»º lambda å‡½æ•° æœ‰ä¸€ä¸ªCloudwatch æ—¥å¿—ç»„å¹¶ä¸”æœ‰ä¸€å¤©ä»¥ä¸Šçš„æ—¥å¿— ç»™ lambdaåˆ†é…æ‰€éœ€çš„æƒé™ åˆ›å»º S3 æ¡¶å¹¶ä¿®æ”¹æƒé™ å›½å†…S3æ¡¶æƒé™é…ç½® å›½å¤–S3æ¡¶æƒé™é…ç½® å›½å†…S3æ¡¶æƒé™é…ç½® 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 { \u0026#34;Version\u0026#34;: \u0026#34;2012-10-17\u0026#34;, \u0026#34;Statement\u0026#34;: [ { \u0026#34;Effect\u0026#34;: \u0026#34;Allow\u0026#34;, \u0026#34;Principal\u0026#34;: { \u0026#34;Service\u0026#34;: \u0026#34;logs.cn-north-1.amazonaws.com.cn\u0026#34; }, \u0026#34;Action\u0026#34;: \u0026#34;s3:GetBucketAcl\u0026#34;, \u0026#34;Resource\u0026#34;: \u0026#34;arn:aws-cn:s3:::\u0026lt;bucket name\u0026gt;\u0026#34; }, { \u0026#34;Effect\u0026#34;: \u0026#34;Allow\u0026#34;, \u0026#34;Principal\u0026#34;: { \u0026#34;Service\u0026#34;: \u0026#34;logs.cn-north-1.amazonaws.com.cn\u0026#34; }, \u0026#34;Action\u0026#34;: \u0026#34;s3:PutObject\u0026#34;, \u0026#34;Resource\u0026#34;: \u0026#34;arn:aws-cn:s3:::\u0026lt;bucket name\u0026gt;/*\u0026#34;, \u0026#34;Condition\u0026#34;: { \u0026#34;StringEquals\u0026#34;: { \u0026#34;s3:x-amz-acl\u0026#34;: \u0026#34;bucket-owner-full-control\u0026#34; } } } ] } å›½å¤–S3æ¡¶æƒé™é…ç½® 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 { \u0026#34;Version\u0026#34;: \u0026#34;2012-10-17\u0026#34;, \u0026#34;Statement\u0026#34;: [ { \u0026#34;Action\u0026#34;: \u0026#34;s3:GetBucketAcl\u0026#34;, \u0026#34;Effect\u0026#34;: \u0026#34;Allow\u0026#34;, \u0026#34;Resource\u0026#34;: \u0026#34;arn:aws:s3:::\u0026lt;bucket name\u0026gt;\u0026#34;, \u0026#34;Principal\u0026#34;: { \u0026#34;Service\u0026#34;: \u0026#34;logs.us-west-2.amazonaws.com\u0026#34; } }, { \u0026#34;Action\u0026#34;: \u0026#34;s3:PutObject\u0026#34; , \u0026#34;Effect\u0026#34;: \u0026#34;Allow\u0026#34;, \u0026#34;Resource\u0026#34;: \u0026#34;arn:aws:s3:::\u0026lt;bucket name\u0026gt;*\u0026#34;, \u0026#34;Condition\u0026#34;: { \u0026#34;StringEquals\u0026#34;: { \u0026#34;s3:x-amz-acl\u0026#34;: \u0026#34;bucket-owner-full-control\u0026#34; } }, \u0026#34;Principal\u0026#34;: { \u0026#34;Service\u0026#34;: \u0026#34;logs.us-west-2.amazonaws.com\u0026#34; } } ] } S3 æ¡¶æƒé™æ–‡æ¡£é“¾æ¥\nåˆ›å»º lambda å‡½æ•° åˆ›å»º lambda 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 import boto3 import logging import time import datetime import json logger = logging.getLogger() logger.setLevel(logging.INFO) def export_s3_logs(bucket_name, log_group_name, log_stream_name, days_of_logs=1, timeout=1000): \u0026#39;\u0026#39;\u0026#39; today = datetime.datetime.combine(datetime.datetime.utcnow(), datetime.datetime.min.time()) day_end = today day_start = today - datetime.timedelta(days=days_of_logs) \u0026#39;\u0026#39;\u0026#39; today = datetime.datetime.combine(datetime.datetime.utcnow() + datetime.timedelta(hours=8), datetime.datetime.min.time()) # UTC+8 day_end = today - datetime.timedelta(hours=8) # UTC day_start = today - datetime.timedelta(days=days_of_logs, hours=8) # UTC #print(day_start) ts_start = \u0026#39;{0:.0f}\u0026#39;.format(((day_start - datetime.datetime(1970, 1, 1)).total_seconds())*1000) ts_end = \u0026#39;{0:.0f}\u0026#39;.format(((day_end - datetime.datetime(1970, 1, 1)).total_seconds())*1000) the_date = \u0026#39;/\u0026#39;.join([str(today.year), \u0026#39;0\u0026#39;+str(today.month)[-2:], \u0026#39;0\u0026#39;+str(today.day)[-2:]]) #folder_name = \u0026#39;/\u0026#39;.join([log_group_name, log_stream_name, the_date]) folder_name = \u0026#39;/\u0026#39;.join([log_group_name,the_date]) client = boto3.client(\u0026#39;logs\u0026#39;) #print (ts_start, ts_end)#, day_start, day_end,the_date task_id = client.create_export_task( logGroupName=log_group_name, #logStreamNamePrefix=log_stream_name, fromTime=int(ts_start), to=int(ts_end), destination=bucket_name, destinationPrefix=folder_name )[\u0026#39;taskId\u0026#39;] i = 1 while i\u0026lt;timeout: response = client.describe_export_tasks( taskId=task_id ) status = response[\u0026#39;exportTasks\u0026#39;][0][\u0026#39;status\u0026#39;] if status == \u0026#39;COMPLETED\u0026#39;: result = True break elif status != \u0026#39;RUNNING\u0026#39;: result = False break i += 1 time.sleep(interval) return result def lambda_handler(event, context): region = \u0026#39;cn-northwest-1\u0026#39; # æ—¥å¿—ç»„æ‰€åœ¨åŒºåŸŸ bucket_name = \u0026#39;\u0026lt;bucket name\u0026gt;\u0026#39; #åŒåŒºåŸŸå†…çš„S3æ¡¶åç§° log_group_name = \u0026#39;\u0026lt;log group name\u0026gt;\u0026#39; #æ—¥å¿—ç»„åç§° log_stream_name = \u0026#39;1\u0026#39; #é»˜è®¤å³å¯ log_export_days = 1 #é»˜è®¤å³å¯ export_s3_logs(bucket_name, log_group_name, log_stream_name, log_export_days) ç»™ lambda åˆ†é…æƒé™ AmazonS3çš„è¯»å†™æƒé™ CloudWatchLogsFullAccess éªŒè¯æ¡¶å†…çš„æ–‡ä»¶ æœ€åä¼šä»¥æ—¥æœŸçš„ç›®å½•å°†æ—¥å¿—å½’æ¡£èµ·æ¥ï¼Œä»¥æ–¹ä¾¿æ—¥åå¯¹å½’æ¡£æ–‡ä»¶è¿›è¡Œæ¢³ç†ã€‚\nä½œè€…ï¼šSREè¿ç»´åšå®¢\nåšå®¢åœ°å€ï¼šhttps://www.cnsre.cn/\næ–‡ç« åœ°å€ï¼šhttps://www.cnsre.cn/posts/221205544069/\nç›¸å…³è¯é¢˜ï¼šhttps://www.cnsre.cn/tags/aws/\n","description":"ä½¿ç”¨ Lambda å‡½æ•°å°† cloudwatchlog ä¸­çš„æ—¥å¿—å½’æ¡£åˆ°S3 æ¡¶ä¸­","id":6,"section":"posts","tags":["aws","lambda","cloudwatch"],"title":"ä½¿ç”¨ Lambda å‡½æ•°å°† CloudWatch Log ä¸­çš„æ—¥å¿—å½’æ¡£åˆ° S3 æ¡¶ä¸­","uri":"http://www.cnsre.cn:80/posts/221205544069/"},{"content":" ä½œè€…ï¼šSREè¿ç»´åšå®¢\nåšå®¢åœ°å€ï¼šhttps://www.cnsre.cn/\næ–‡ç« åœ°å€ï¼šhttps://www.cnsre.cn/posts/220125450139/\nç›¸å…³è¯é¢˜ï¼šhttps://www.cnsre.cn/tags/eks/\nå‰è¨€ ä¹‹å‰åœ¨ aws ä¸­åˆ›å»ºäº† eksï¼Œåœ¨æ•°æ®å­˜å‚¨è¿™ä¸€å—ä¸­ï¼Œæˆ‘é€‰æ‹©äº†ä½¿ç”¨ AWS çš„ EFS å…·ä½“éƒ¨ç½²é…ç½®å‚è€ƒAmazon EKS ä¸­ EFS æŒä¹…æ€§å­˜å‚¨ã€‚æ–‡ç« ä¸­çš„åŠ¨æ€ä¾›ç»™æ˜¯ AWS å®˜æ–¹ç»™çš„ç¤ºä¾‹ï¼Œä½¿ç”¨çš„æ˜¯rootç”¨æˆ·å¯åŠ¨çš„å®¹å™¨ã€‚åœ¨æˆ‘åé¢çš„æµ‹è¯•ä¸­å‘ç°ï¼Œæˆ‘åœ¨ä½¿ç”¨érootç”¨æˆ·å¯åŠ¨å®¹å™¨çš„æ—¶å€™ï¼Œå‘ç°ä½¿ç”¨é™æ€ä¾›ç»™æ˜¯æœ‰æƒé™å¹¶ä¸”æ²¡æœ‰æŠ¥é”™çš„ã€‚ä½†æ˜¯åœ¨ä½¿ç”¨é™è½½ä¾›ç»™çš„æ—¶å€™å‡ºç°äº† Operation not permitted çš„æŠ¥é”™ã€‚\né—®é¢˜æè¿° æˆ‘æ ¹æ®efs dynamic_provisioning åˆ›å»ºäº† dynamic provisioning\nrootç”¨æˆ·çš„å®¹å™¨è¿è¡Œæ²¡æœ‰é—®é¢˜ï¼Œä½†æ˜¯érootç”¨æˆ·å®¹å™¨è¿è¡Œæ—¶æç¤º â€œOperation not permittedâ€\npodé…ç½®æ¸…å•ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 apiVersion: v1 kind: Service metadata: name: wordpress-mysql labels: app: wordpress spec: ports: - port: 3306 selector: app: wordpress tier: mysql clusterIP: None --- apiVersion: v1 kind: PersistentVolumeClaim metadata: name: mysql-pv-claim labels: app: wordpress spec: accessModes: - ReadWriteOnce resources: requests: storage: 5Gi --- apiVersion: apps/v1 # for versions before 1.9.0 use apps/v1beta2 kind: Deployment metadata: name: wordpress-mysql labels: app: wordpress spec: selector: matchLabels: app: wordpress tier: mysql strategy: type: Recreate template: metadata: labels: app: wordpress tier: mysql spec: containers: - image: mysql:5.6 name: mysql env: - name: MYSQL_ROOT_PASSWORD valueFrom: secretKeyRef: name: mysql-pass key: password ports: - containerPort: 3306 name: mysql volumeMounts: - name: mysql-persistent-storage mountPath: /var/lib/mysql volumes: - name: mysql-persistent-storage persistentVolumeClaim: claimName: mysql-pv-claim StorageClassé…ç½®æ¸…å•ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 kind: StorageClass apiVersion: storage.k8s.io/v1 metadata: name: efs-sc provisioner: efs.csi.aws.com parameters: provisioningMode: efs-ap fileSystemId: fs-xxxxx directoryPerms: \u0026#34;700\u0026#34; gidRangeStart: \u0026#34;1000\u0026#34; # optional gidRangeEnd: \u0026#34;2000\u0026#34; # optional basePath: \u0026#34;/dynamic_provisioning\u0026#34; # optional åˆ†æå’Œæ£€æŸ¥ è¯¥æŠ¥é”™æ˜¯ç”±äºé‡‡ç”¨äº†dynamic provisioning PVéƒ¨ç½²æ–¹å¼ï¼Œè¿™ç§æ¨¡å¼çš„å®ç°éœ€è¦åˆ©ç”¨ efs-apï¼šaccess pointè®¿é—®ç‚¹ æ¨¡å¼åš EFS æŒ‚è½½ã€‚ä» EFS çš„è§’åº¦æ¥è®²ï¼ŒEFS çš„ access point æ¨¡å¼æŒ‚è½½çš„ EFS å·ï¼Œå®¢æˆ·ç«¯ä¸å¯ä¿®æ”¹ uid/gid ï¼Œåªæ‹¥æœ‰ä½¿ç”¨æƒï¼ˆè¯»å†™ï¼‰è¯¦æƒ…ç‚¹å‡»æŸ¥çœ‹ã€‚ä»è‡ªå·±çš„podç¯å¢ƒä¹Ÿå¯ä»¥çœ‹åˆ°ï¼Œå®¢æˆ·ç«¯æŒ‚è½½ç›®å½•/dynamic_provisioning çš„uidè·Ÿgidéƒ½æ˜¯ä¸€ä¸ªéšæœºæ•°å­—ã€‚ ls -l /dynamic_provisioningå¯ä»¥çœ‹åˆ°æ˜¯ `1018 ï¼ˆä¸åŒç¯å¢ƒuidä¼šä¸åŒï¼‰ã€‚\nEFS-APæ¨¡å¼æŒ‡çš„æ˜¯access pointè®¿é—®ç‚¹æ¨¡å¼ã€‚å…³äºè®¿é—®ç‚¹çš„ä»‹ç»ï¼š\nEFS Access Pointsï¼š\nAn access point applies an operating system user, group, and file system path to any file system request made using the access point. The access point\u0026rsquo;s operating system user and group override any identity information provided by the NFS client.\nç®€å•æ¥è®²ï¼ŒEFS-APä¹Ÿå°±æ˜¯access pointè®¿é—®ç‚¹æŒ‚è½½æ¨¡å¼ä¸‹ï¼Œefså®¢æˆ·ç«¯çš„è·¯å¾„user/gidæ˜¯ä¸å¯è¢«ä¿®æ”¹çš„ã€‚çš„å®¢æˆ·ç«¯ç”¨æˆ·åªæœ‰ä½¿ç”¨æƒï¼ˆè¯»å†™ï¼‰ï¼Œä½†æ˜¯ä¸å¯ä»¥ä¿®æ”¹ownerã€‚å› æ­¤é‡åˆ°çš„æŠ¥é”™æ˜¯è¯¥é…ç½®çš„é¢„æœŸè¡¨ç°ã€‚\nEFS-APæ¨¡å¼çš„é…ç½®æ˜¯åœ¨storageclassä¸­å®šä¹‰çš„ï¼šprovisioningMode: efs-apï¼Œæ¯”å¦‚ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 kind: StorageClass apiVersion: storage.k8s.io/v1 metadata: name: efs-sc-dynamic provisioner: efs.csi.aws.com parameters: provisioningMode: efs-ap \u0026lt;\u0026lt;\u0026lt;\u0026lt;\u0026lt;\u0026lt;\u0026lt;\u0026lt;\u0026lt;\u0026lt;\u0026lt;\u0026lt;\u0026lt;\u0026lt;------------------------------EFSè®¿é—®ç‚¹æŒ‚è½½æ¨¡å¼ fileSystemId: fs-xxxxxx directoryPerms: \u0026#34;700\u0026#34; gidRangeStart: \u0026#34;1000\u0026#34; # optional gidRangeEnd: \u0026#34;2000\u0026#34; # optional basePath: \u0026#34;/dynamic_provisioning\u0026#34; # optional ç›®å‰AWS EFSçš„ dynamic provisioning æ¨¡å¼çš„å®ç°å°±æ˜¯ä½¿ç”¨ storageclass çš„ efs-sc-dynamic æ¨¡å¼ã€‚\nè¿™ç§æ¨¡å¼çš„å¼Šç«¯å·²ç»åœ¨ github ä¸­æœ‰issueåœ¨è·Ÿè¸ª,è¯¦æƒ…ç‚¹å‡»æŸ¥çœ‹ï¼Œä½†æ˜¯ç”±äºè¯¥æ¨¡å¼ä¹Ÿæœ‰ä¸€å®šçš„è®¾è®¡æ„ä¹‰ è¯¦æƒ…ç‚¹å‡»æŸ¥çœ‹ï¼Œæ‰€ä»¥ç›®å‰è¿˜æ²¡æœ‰æ˜ç¡®çš„ç»“è®ºã€‚\nä¸´æ—¶è§£å†³æ–¹æ³• ä½¿ç”¨é™æ€æ¨¡å¼åˆ›å»º å¯ä»¥åˆ›å»ºEKS pv/pvcæ—¶ä½¿ç”¨staticæ¨¡å¼éƒ¨ç½²PVï¼Œä¸ä¼šä½¿ç”¨access pointæ¨¡å¼æŒ‚è½½EFSå·ï¼Œé‚£ä¹ˆå¯ä»¥é¡ºåˆ©ä¿®æ”¹uid/gidã€‚\nè¯¦æƒ…å‚è€ƒAmazon EKS ä¸­ EFS æŒä¹…æ€§å­˜å‚¨\nåœ¨podä¸­æŒ‡å®š uid å’Œ gid åœ¨åˆ›å»ºpodä¹‹å‰ï¼Œå…ˆåˆ›å»º pvcåœ¨åˆ›å»ºå®ŒpvcåæŸ¥çœ‹uid å’Œgid\n1 2 3 4 5 [root@ip-10-0-100-206 ~]# ls -l /efs/dynamic_provisioning/ total 12 drwxr-xr-x 5 1015 1015 6144 Jan 20 02:44 pvc-40b922c7-8d4d-47d9-8783-60d25abe123 drwxr-xr-x 5 1017 1017 6144 Jan 20 04:22 pvc-4ee000a8-7ab2-4ffc-8fd3-72ef31b7123 drwx------ 5 1014 1014 6144 Jan 20 01:08 pvc-f6622cb3-7c24-4172-a427-d4b9a996122 å°†è¾“å‡ºå†…å®¹çš„pvcçš„uid gid è®°ä¸‹å¹¶åœ¨podçš„yamlæ¸…å•ä¸­æŒ‡å®šuidå·²ç»gidè®©podæ‹¥æœ‰è¯¥ç›®å½•çš„æƒé™ã€‚\npodé…ç½®æ¸…å•ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 apiVersion: v1 kind: Service metadata: name: wordpress-mysql labels: app: wordpress spec: ports: - port: 3306 selector: app: wordpress tier: mysql clusterIP: None --- apiVersion: v1 kind: PersistentVolumeClaim metadata: name: mysql-pv-claim labels: app: wordpress spec: accessModes: - ReadWriteMany resources: requests: storage: 5Gi --- apiVersion: apps/v1 # for versions before 1.9.0 use apps/v1beta2 kind: Deployment metadata: name: wordpress-mysql labels: app: wordpress spec: selector: matchLabels: app: wordpress tier: mysql strategy: type: Recreate template: metadata: labels: app: wordpress tier: mysql spec: securityContext: fsGroup: 1014 runAsUser: 1014 runAsGroup: 1014 containers: - image: mysql:5.6 name: mysql env: - name: MYSQL_ROOT_PASSWORD valueFrom: secretKeyRef: name: mysql-pass key: password ports: - containerPort: 3306 name: mysql volumeMounts: - name: mysql-persistent-storage mountPath: /var/lib/mysql volumes: - name: mysql-persistent-storage persistentVolumeClaim: claimName: mysql-pv-claim æ£€æŸ¥ 1 2 3 4 5 6 7 8 9 10 kubectl get pv|grep mysql pvc-f6622cb3-7c24-4172-a427-d4b9a9962cd8 5Gi RWX Delete Bound default/mysql-pv-claim efs-sc 5d23h kubectl get pvc NAME STATUS VOLUME CAPACITY ACCESS MODES STORAGECLASS AGE mysql-pv-claim Bound pvc-f6622cb3-7c24-4172-a427-d4b9a9962cd8 5Gi RWX efs-sc 5d23h kubectl get pod NAME READY STATUS RESTARTS AGE wordpress-mysql-6f6455f449-52zrp 1/1 Running 0 5d7h ä½œè€…ï¼šSREè¿ç»´åšå®¢\nåšå®¢åœ°å€ï¼šhttps://www.cnsre.cn/\næ–‡ç« åœ°å€ï¼šhttps://www.cnsre.cn/posts/220125450139/\nç›¸å…³è¯é¢˜ï¼šhttps://www.cnsre.cn/tags/eks/\n","description":"aws eksä½¿ç”¨efs dynamic provisioning æŒ‚è½½åˆ°érootå®¹å™¨æç¤º Operation not permittedçš„é—®é¢˜ã€‚","id":7,"section":"posts","tags":["efs","eks","æ•…éšœé›†"],"title":"eksä½¿ç”¨efs dynamic provisioning åˆ›å»ºérootå®¹å™¨æç¤º Operation not permitted","uri":"http://www.cnsre.cn:80/posts/220125450139/"},{"content":" ä½œè€…ï¼šSREè¿ç»´åšå®¢\nåšå®¢åœ°å€ï¼šhttps://www.cnsre.cn/\næ–‡ç« åœ°å€ï¼šhttps://www.cnsre.cn/posts/220110850573/\nç›¸å…³è¯é¢˜ï¼šhttps://www.cnsre.cn/tags/eks/\nå­¦ä¹ ç›®æ ‡ åœ¨ EKS ä¸­éƒ¨ç½² Amazon EFS CSI é©±åŠ¨ç¨‹åºåˆ° éªŒè¯ EFS å¹¶éªŒè¯å®ƒæ˜¯å¦æ­£å¸¸å·¥ä½œ åˆ›å»ºåŸºäº EFS çš„é™æ€ã€åŠ¨æ€å­˜å‚¨ å‰ææ¡ä»¶ EKS é›†ç¾¤ AWS CLI å¦‚æœä½ æ²¡æœ‰å®‰è£…è¯·æŸ¥çœ‹å®‰è£…ã€æ›´æ–°å’Œå¸è½½ AWS CLIã€‚åœ¨å®‰è£… AWS CLI åï¼Œè¿˜è¦å¯¹å…¶è¿›è¡Œé…ç½®ã€‚ kubectl å¦‚æœæ²¡æœ‰å®‰è£… è¯·æŸ¥çœ‹å®‰è£… kubectlã€‚ åˆ›å»º IAM ç­–ç•¥ åˆ›å»º IAM ç­–ç•¥å¹¶å°†å…¶åˆ†é…ç»™ IAM è§’è‰²ã€‚è¯¥ç­–ç•¥å°†å…è®¸ Amazon EFS é©±åŠ¨ç¨‹åºä¸æ–‡ä»¶ç³»ç»Ÿäº¤äº’ã€‚\n1.ä» æŸ¥çœ‹ä¸‹æ–¹ IAM ç­–ç•¥æ–‡æ¡£æˆ–è€…æŸ¥çœ‹ç­–ç•¥æ–‡æ¡£ã€‚\næ¨èä½¿ç”¨ æŸ¥çœ‹ ç­–ç•¥æ–‡æ¡£ã€‚è·å–ç­–ç•¥æ–‡æ¡£ã€‚ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 { \u0026#34;Version\u0026#34;: \u0026#34;2012-10-17\u0026#34;, \u0026#34;Statement\u0026#34;: [ { \u0026#34;Effect\u0026#34;: \u0026#34;Allow\u0026#34;, \u0026#34;Action\u0026#34;: [ \u0026#34;elasticfilesystem:DescribeAccessPoints\u0026#34;, \u0026#34;elasticfilesystem:DescribeFileSystems\u0026#34; ], \u0026#34;Resource\u0026#34;: \u0026#34;*\u0026#34; }, { \u0026#34;Effect\u0026#34;: \u0026#34;Allow\u0026#34;, \u0026#34;Action\u0026#34;: [ \u0026#34;elasticfilesystem:CreateAccessPoint\u0026#34; ], \u0026#34;Resource\u0026#34;: \u0026#34;*\u0026#34;, \u0026#34;Condition\u0026#34;: { \u0026#34;StringLike\u0026#34;: { \u0026#34;aws:RequestTag/efs.csi.aws.com/cluster\u0026#34;: \u0026#34;true\u0026#34; } } }, { \u0026#34;Effect\u0026#34;: \u0026#34;Allow\u0026#34;, \u0026#34;Action\u0026#34;: \u0026#34;elasticfilesystem:DeleteAccessPoint\u0026#34;, \u0026#34;Resource\u0026#34;: \u0026#34;*\u0026#34;, \u0026#34;Condition\u0026#34;: { \u0026#34;StringEquals\u0026#34;: { \u0026#34;aws:ResourceTag/efs.csi.aws.com/cluster\u0026#34;: \u0026#34;true\u0026#34; } } } ] } 2.åœ¨IAM-ç­–ç•¥ ä¸­åˆ›å»ºç­–ç•¥\nåœ¨Identity and Access Management (IAM)ä¸­ç‚¹å‡» ç­–ç•¥ ç„¶ååœ¨ä¸‹ä¸€æ­¥ä¸­ç‚¹å‡» åˆ›å»ºç­–ç•¥\nç‚¹å‡» json ç„¶åå°† IAM ç­–ç•¥ å¡«å…¥ï¼Œ ç„¶åç‚¹å‡» ä¸‹ä¸€æ­¥:æ ‡ç­¾\nåœ¨ä¸‹ä¸€æ­¥çš„æ ‡ç­¾ä¸­ï¼Œå¯ä»¥æ ¹æ®è‡ªå·±çš„æƒ…å†µè‡ªè¡Œå¡«å†™,ç„¶åç‚¹å‡» ä¸‹ä¸€æ­¥:å®¡æ ¸\nåç§°ä¸­å¡«å†™ AmazonEKS_EFS_CSI_Driver_Policy\nä½ å¯ä»¥å°† AmazonEKS_EFS_CSI_Driver_Policy æ›´æ”¹ä¸ºå…¶ä»–åç§°ï¼Œä½†å¦‚æœæ›´æ”¹ï¼Œè¯·ç¡®ä¿åœ¨åç»­æ­¥éª¤ä¸­ä¹Ÿåšå‡ºç›¸åº”æ›´æ”¹ã€‚ å°† efs ç­–ç•¥ é™„ä»¶åˆ° eks node è§’è‰²ä¸­ å°†æˆ‘ä»¬åˆšæ‰åˆ›å»ºçš„ efs ç­–ç•¥ AmazonEKS_EFS_CSI_Driver_Policy é™„åŠ åœ¨ eks_node çš„è§’è‰²ä¸­ï¼Œç¡®ä¿eks nodeæ‹¥æœ‰efsçš„æƒé™ã€‚\nå¦‚æœä½ ä¹‹å‰åˆ›å»ºäº† eks é‚£ä¹ˆåœ¨ä½ çš„è§’è‰²ä¸­ä¼šæœ‰ä¸€ä¸ªåä¸º eksctl-\u0026lt;eks-name\u0026gt;-nodegrou-NodeInstanceRole-xxxxxxxxx çš„è§’è‰²ã€‚ åœ¨è§’è‰²ä¸­æœç´¢ node ç„¶åç‚¹å‡» eksctl-\u0026lt;eks-name\u0026gt;-nodegrou-NodeInstanceRole-xxxxxxxxx\nåœ¨è§’è‰²ä¸­ç‚¹å‡» é™„åŠ ç­–ç•¥\næœç´¢ä¹‹å‰åˆ›å»ºçš„ EFS ç­–ç•¥ ä¹Ÿå°±æ˜¯ AmazonEKS_EFS_CSI_Driver_Policy ç„¶åé€‰ä¸­ï¼Œç‚¹å‡»æœ€ä¸‹æ–¹çš„é™„åŠ ç­–ç•¥ã€‚\nå®‰è£… Amazon EFS é©±åŠ¨ç¨‹åº ä½¿ç”¨ Helm æˆ– yaml æ¸…å•å®‰è£… Amazon EFS CSI é©±åŠ¨ç¨‹åºã€‚\nè¿™è¾¹ä¸è¯¦ç»†è¯´ helm éƒ¨ç½²æ–¹å¼ä¸»è¦ä»‹ç» yaml æ¸…å•éƒ¨ç½²\nä¸€å®šè¦ä¿®æ”¹é•œåƒåœ°å€ä¸ºä½ æ‰€åœ¨çš„åœ°åŒº Amazon EKS é™„åŠ ç»„ä»¶å®¹å™¨é•œåƒåœ°å€ yaml æ¸…å•éƒ¨ç½² å› ä¸ºgithubç½‘ç»œçš„é—®é¢˜ã€‚å¦‚æœå†æ‰§è¡Œçš„æ—¶å€™éƒ¨ç½²æ²¡æœ‰ååº”ï¼Œè¯·ç»ˆæ­¢è¿è¡Œï¼Œå¤šè¿è¡Œå‡ æ¬¡å°è¯•éƒ¨ç½² 1 kubectl apply -k \u0026#34;github.com/kubernetes-sigs/aws-efs-csi-driver/deploy/kubernetes/overlays/stable/?ref=release-1.3\u0026#34; è¾“å‡ºå¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 serviceaccount/efs-csi-controller-sa created serviceaccount/efs-csi-node-sa created clusterrole.rbac.authorization.k8s.io/efs-csi-external-provisioner-role created clusterrolebinding.rbac.authorization.k8s.io/efs-csi-provisioner-binding created deployment.apps/efs-csi-controller created daemonset.apps/efs-csi-node created csidriver.storage.k8s.io/efs.csi.aws.com created æ£€æŸ¥é©±åŠ¨è¿è¡Œæ˜¯å¦æ­£å¸¸\n1 2 3 4 5 kubectl get pods -A|grep efs kube-system efs-csi-controller-56f6dc4c76-2lvqf 3/3 Running 0 3m32s kube-system efs-csi-controller-56f6dc4c76-dxkwl 3/3 Running 0 3m32s kube-system efs-csi-node-9ttxp 3/3 Running 0 3m32s kube-system efs-csi-node-hsn94 3/3 Running 0 3m32s è™½ç„¶è¿™è¾¹æ˜¾ç¤ºè¿è¡Œæ­£å¸¸ï¼Œä½†æ˜¯è¿˜æ˜¯è¦ä¿®æ”¹é•œåƒåœ°å€ã€‚ä¸ç„¶åœ¨åˆ›å»ºpvï¼Œpvcä»¥ååœ¨podä¸­æŒ‚è½½ä¼šå‡ºç°é”™è¯¯ã€‚ï¼ˆåé¢ä¼šå•ç‹¬è®°å½•è¿™ä¸ªé”™è¯¯ï¼‰ ä¿®æ”¹ efs-csi-node é©±åŠ¨\n1 kubectl edit daemonsets.apps -n kube-system efs-csi-node æ‰¾åˆ° aws-efs-csi-driver é©±åŠ¨æ‰€åœ¨çš„ä½ç½®\nç„¶åå°†é•œåƒä¿®æ”¹ä¸º 918309763551.dkr.ecr.cn-north-1.amazonaws.com.cn/eks/aws-efs-csi-driver:v1.3.3\nå…·ä½“å¦‚ä¸‹\nåˆ›å»º Amazon EFS æ–‡ä»¶ç³»ç»Ÿ ä¸º Amazon EKS é›†ç¾¤åˆ›å»º Amazon EFS æ–‡ä»¶ç³»ç»Ÿ åœ¨æ§åˆ¶å°ä¸­æœç´¢ efs ç‚¹å‡»ç¡®è®¤ç„¶åè¿›å…¥ EFS æ§åˆ¶å°\nåœ¨æ§åˆ¶å°ä¸­ç‚¹å‡» åˆ›å»ºæ–‡ä»¶ç³»ç»Ÿ\nåç§°ï¼š æ ¹æ®è‡ªå·±çš„æƒ…å†µå¡«å†™\nvpcï¼š ä¸€å®šè¦åˆ›å»ºåœ¨è·Ÿ eks åŒä¸€ VPC ä¸‹\nå¯ç”¨æ€§å’ŒæŒä¹…æ€§: æ ¹æ®æç¤ºè¯´æ˜åˆ›å»ºè‡ªå·±æ‰€éœ€è¦çš„\nå¦‚æœæœ‰æ›´å¤šéœ€æ±‚å¯ä»¥ç‚¹å‡» è‡ªå®šä¹‰æ¥è®¾ç½®æ›´å¤š å¦‚ï¼šååé‡ã€åŠ å¯†ã€å¤‡ä»½ç­‰ç­–ç•¥\næœ€åç‚¹å‡» åˆ›å»º\nåˆ›å»ºå…¥ç«™è§„åˆ™ å…è®¸æ¥è‡ª EKS é›†ç¾¤ VPC çš„ CIDR çš„å…¥ç«™ NFS æµé‡\nåœ¨åˆšåˆšåˆ›å»ºçš„ EFS ä¸­é€‰æ‹© ç½‘ç»œ \u0026ndash;\u0026gt; å®‰å…¨ç»„ ç„¶åå¤åˆ¶å®‰å…¨ç»„çš„ID sg-152XXX\nåœ¨ EC2 ä¸­æ‰¾åˆ° ç½‘ç»œä¸å®‰å…¨ é€‰æ‹© å®‰å…¨ç»„ ç„¶ååœ¨æœç´¢æ¡†ä¸­æœç´¢ sg-152XXX é€‰ä¸­å®‰å…¨ç»„ã€‚å¹¶é€‰æ‹© å…¥ç«™è§„åˆ™\nåœ¨å…¥ç«™è§„åˆ™ä¸­å…è®¸æ¥ EKS é›†ç¾¤æ¥è®¿é—® NFS(2049)ç«¯å£æµé‡ã€‚\néƒ¨ç½²ç¤ºä¾‹åº”ç”¨ç¨‹åº éƒ¨ç½²é™æ€ä¾›ç»™ å†…å®¹éƒ¨ç½²åŠ¨æ€ä¾›ç»™ éƒ¨ç½²é™æ€ä¾›ç»™ éƒ¨ç½²ä½¿ç”¨ä½ åˆ›å»ºçš„æŒä¹…æ€§å·çš„ç¤ºä¾‹åº”ç”¨ç¨‹åº\næ­¤è¿‡ç¨‹åˆ©ç”¨æ¥è‡ª Amazon EFS Container Storage Interface (CSI) é©±åŠ¨ç¨‹åº GitHub å­˜å‚¨åº“çš„å¤šä¸ª Pod è¯»å†™è®¸å¤šç¤ºä¾‹æ¥ä½¿ç”¨é™æ€é¢„ç½®çš„ Amazon EFS æŒä¹…æ€§å·ï¼Œå¹¶ä½¿ç”¨ ReadWriteMany è®¿é—®æ¨¡å¼ä»å¤šä¸ª Pod è®¿é—®å®ƒã€‚\nå°† Amazon EFS Container Storage Interface (CSI) é©±åŠ¨ç¨‹åº GitHub å­˜å‚¨åº“å…‹éš†åˆ°ä½ çš„æœ¬åœ°ç³»ç»Ÿã€‚\ngit clone https://github.com/kubernetes-sigs/aws-efs-csi-driver.git å¯¼èˆªåˆ° multiple_pods ç¤ºä¾‹ç›®å½•ã€‚\ncd aws-efs-csi-driver/examples/kubernetes/multiple_pods/ æ£€ç´¢ä½ çš„ Amazon EFS æ–‡ä»¶ç³»ç»Ÿ IDã€‚ä½ å¯ä»¥åœ¨ Amazon EFS æ§åˆ¶å°ä¸­æŸ¥æ‰¾æ­¤ä¿¡æ¯ï¼Œæˆ–è€…ä½¿ç”¨ä»¥ä¸‹ AWS CLI å‘½ä»¤ã€‚\naws efs describe-file-systems --query \u0026#34;FileSystems[*].FileSystemId\u0026#34; --output text è¾“å‡ºï¼š\nfs-\u0026lt;582a03f3\u0026gt; ç¼–è¾‘ specs/pv.yaml æ–‡ä»¶å¹¶å°† volumeHandle å€¼æ›¿æ¢ä¸ºä½ çš„ Amazon EFS æ–‡ä»¶ç³»ç»Ÿ IDã€‚\napiVersion: v1 kind: PersistentVolume metadata: name: efs-pv spec: capacity: storage: 5Gi volumeMode: Filesystem accessModes: - ReadWriteMany persistentVolumeReclaimPolicy: Retain storageClassName: efs-sc csi: driver: efs.csi.aws.com volumeHandle: fs-\u0026lt;582a03f3\u0026gt; æ³¨æ„\nç”±äº Amazon EFS æ˜¯å¼¹æ€§æ–‡ä»¶ç³»ç»Ÿï¼Œå› æ­¤å®ƒä¸ä¼šå¼ºåˆ¶å®æ–½ä»»ä½•æ–‡ä»¶ç³»ç»Ÿå®¹é‡é™åˆ¶ã€‚åœ¨åˆ›å»ºç³»ç»Ÿæ—¶ï¼Œä¸ä½¿ç”¨æŒä¹…æ€§å·å’ŒæŒä¹…æ€§å·å£°æ˜ä¸­çš„å®é™…å­˜å‚¨å®¹é‡å€¼ã€‚ä½†æ˜¯ï¼Œç”±äºå­˜å‚¨å®¹é‡æ˜¯ Kubernetes ä¸­çš„å¿…éœ€å­—æ®µï¼Œä½ å¿…é¡»æŒ‡å®šæœ‰æ•ˆå€¼ï¼Œä¾‹å¦‚ï¼Œåœ¨æ­¤ç¤ºä¾‹ä¸­ä¸º 5Giã€‚æ­¤å€¼ä¸ä¼šé™åˆ¶ Amazon EFS æ–‡ä»¶ç³»ç»Ÿçš„å¤§å°ã€‚\nä» specs ç›®å½•éƒ¨ç½² efs-sc å­˜å‚¨ç±»ã€efs-claim æŒä¹…æ€§å·å£°æ˜ä»¥åŠ efs-pv æŒä¹…æ€§å·ã€‚\nkubectl apply -f specs/pv.yaml kubectl apply -f specs/claim.yaml kubectl apply -f specs/storageclass.yaml åˆ—å‡ºé»˜è®¤å‘½åç©ºé—´ä¸­çš„æŒä¹…æ€§å·ã€‚æŸ¥æ‰¾å…·æœ‰ default/efs-claim å£°æ˜çš„æŒä¹…æ€§å·ã€‚\nkubectl get pv -w è¾“å‡ºï¼š\nNAME CAPACITY ACCESS MODES RECLAIM POLICY STATUS CLAIM STORAGECLASS REASON AGE efs-pv 5Gi RWX Retain Bound default/efs-claim efs-sc 2m50s åœ¨ STATUS å˜ä¸º Bound ä¹‹å‰ï¼Œè¯·å‹¿ç»§ç»­æ‰§è¡Œä¸‹ä¸€æ­¥ã€‚\nä» specs ç›®å½•éƒ¨ç½² app1 å’Œ app2 ç¤ºä¾‹åº”ç”¨ç¨‹åºã€‚\nkubectl apply -f specs/pod1.yaml kubectl apply -f specs/pod2.yaml æŸ¥çœ‹é»˜è®¤å‘½åç©ºé—´ä¸­çš„ Pod å¹¶ç­‰å¾… app1 å’Œ app2 Pod çš„ STATUS å˜ä¸º Running çŠ¶æ€ã€‚\nkubectl get pods --watch æ³¨æ„\nå¯èƒ½éœ€è¦å‡ åˆ†é’Ÿ Pod æ‰èƒ½è¾¾åˆ° Running çŠ¶æ€ã€‚\næè¿°æŒä¹…æ€§å·ã€‚\nkubectl describe pv efs-pv è¾“å‡ºï¼š\nName: efs-pv Labels: none Annotations: kubectl.kubernetes.io/last-applied-configuration: {\u0026#34;apiVersion\u0026#34;:\u0026#34;v1\u0026#34;,\u0026#34;kind\u0026#34;:\u0026#34;PersistentVolume\u0026#34;,\u0026#34;metadata\u0026#34;:{\u0026#34;annotations\u0026#34;:{},\u0026#34;name\u0026#34;:\u0026#34;efs-pv\u0026#34;},\u0026#34;spec\u0026#34;:{\u0026#34;accessModes\u0026#34;:[\u0026#34;ReadWriteMany\u0026#34;],\u0026#34;capaci... pv.kubernetes.io/bound-by-controller: yes Finalizers: [kubernetes.io/pv-protection] StorageClass: efs-sc Status: Bound Claim: default/efs-claim Reclaim Policy: Retain Access Modes: RWX VolumeMode: Filesystem Capacity: 5Gi Node Affinity: none Message: Source: Type: CSI (a Container Storage Interface (CSI) volume source) Driver: efs.csi.aws.com VolumeHandle: fs-582a03f3 ReadOnly: false VolumeAttributes: none Events: none Amazon EFS æ–‡ä»¶ç³»ç»Ÿ ID å°†ä½œä¸º VolumeHandle åˆ—å‡ºã€‚\néªŒè¯ app1 Pod æ˜¯å¦æˆåŠŸå°†æ•°æ®å†™å…¥å·ã€‚\nkubectl exec -ti app1 -- tail /data/out1.txt è¾“å‡ºï¼š\n... Mon Mar 22 18:18:22 UTC 2021 Mon Mar 22 18:18:27 UTC 2021 Mon Mar 22 18:18:32 UTC 2021 Mon Mar 22 18:18:37 UTC 2021 ... éªŒè¯ app2 Pod åœ¨å·ä¸­æ˜¾ç¤ºçš„æ•°æ®ä¸ app1 å†™å…¥å·çš„æ•°æ®ç›¸åŒã€‚\nkubectl exec -ti app2 -- tail /data/out1.txt è¾“å‡ºï¼š\n... Mon Mar 22 18:18:22 UTC 2021 Mon Mar 22 18:18:27 UTC 2021 Mon Mar 22 18:18:32 UTC 2021 Mon Mar 22 18:18:37 UTC 2021 ... å®Œæˆè¯•éªŒæ—¶ï¼Œè¯·åˆ é™¤æ­¤ç¤ºä¾‹åº”ç”¨ç¨‹åºçš„èµ„æºä»¥è¿›è¡Œæ¸…ç†ã€‚\nkubectl delete -f specs/ ä½ è¿˜å¯ä»¥æ‰‹åŠ¨åˆ é™¤ä½ åˆ›å»ºçš„æ–‡ä»¶ç³»ç»Ÿå’Œå®‰å…¨ç»„ã€‚\néƒ¨ç½²åŠ¨æ€ä¾›ç»™ Prerequisite\næ‚¨å¿…é¡»ä½¿ç”¨ 1.2x ç‰ˆæˆ–æ›´é«˜ç‰ˆæœ¬çš„ Amazon EFS CSI é©±åŠ¨ç¨‹åºï¼Œè¯¥é©±åŠ¨ç¨‹åºéœ€è¦ 1.17 æˆ–æ›´é«˜ç‰ˆæœ¬çš„é›†ç¾¤ã€‚è¦æ›´æ–°é›†ç¾¤ï¼Œè¯·å‚é˜… æ›´æ–°é›†ç¾¤ã€‚\néƒ¨ç½²ä½¿ç”¨æ§åˆ¶å™¨æ‰€åˆ›å»ºçš„æŒä¹…æ€§å·çš„ç¤ºä¾‹åº”ç”¨ç¨‹åº\næ­¤è¿‡ç¨‹åˆ©ç”¨æ¥è‡ª Amazon EFS Container Storage Interface (CSI) é©±åŠ¨ç¨‹åº GitHub å­˜å‚¨åº“çš„åŠ¨æ€é¢„ç½®ç¤ºä¾‹ã€‚å®ƒé€šè¿‡ Amazon EFS æ¥å…¥ç‚¹å’Œ Pod ä½¿ç”¨çš„æŒä¹…æ€§å·ç”³é¢† (PVC) åŠ¨æ€åˆ›å»ºä¸€ä¸ªæŒä¹…æ€§å·ã€‚\nä¸º EFS åˆ›å»ºå­˜å‚¨ç±»ã€‚æœ‰å…³æ‰€æœ‰å‚æ•°å’Œé…ç½®é€‰é¡¹ï¼Œè¯·å‚é˜… GitHub ä¸Šçš„ Amazon EFS CSI é©±åŠ¨ç¨‹åºã€‚\nä¸‹è½½ Amazon EFS çš„ StorageClass æ¸…å•ã€‚\ncurl -o storageclass.yaml https://raw.githubusercontent.com/kubernetes-sigs/aws-efs-csi-driver/master/examples/kubernetes/dynamic_provisioning/specs/storageclass.yaml ç¼–è¾‘ç›¸åº”æ–‡ä»¶ï¼Œå°† fileSystemId çš„å€¼æ›¿æ¢ä¸ºæ‚¨çš„æ–‡ä»¶ç³»ç»Ÿ IDã€‚\néƒ¨ç½²å­˜å‚¨ç±»ã€‚\nkubectl apply -f storageclass.yaml é€šè¿‡éƒ¨ç½²åˆ©ç”¨ PersistentVolumeClaim çš„ Pod æ¥æµ‹è¯•è‡ªåŠ¨é¢„ç½®ï¼š\nä¸‹è½½ä¸€ä¸ªæ¸…å•ï¼Œè¯¥æ¸…å•å°†éƒ¨ç½²ä¸€ä¸ª Pod å’Œä¸€ä¸ª PersistentVolumeClaimã€‚\ncurl -o pod.yaml https://raw.githubusercontent.com/kubernetes-sigs/aws-efs-csi-driver/master/examples/kubernetes/dynamic_provisioning/specs/pod.yaml ä½¿ç”¨ç¤ºä¾‹åº”ç”¨ç¨‹åºå’Œ Pod ä½¿ç”¨çš„ PersistentVolumeClaim æ¥éƒ¨ç½² Podã€‚\nkubectl apply -f pod.yaml ç¡®å®šè¿è¡Œæ§åˆ¶å™¨çš„ Pod çš„åç§°ã€‚\nkubectl get pods -n kube-system | grep efs-csi-controller è¾“å‡º\nefs-csi-controller-74ccf9f566-q5989 3/3 Running 0 40m efs-csi-controller-74ccf9f566-wswg9 3/3 Running 0 40m å‡ ç§’é’Ÿåï¼Œæ‚¨å¯ä»¥è§‚å¯Ÿåˆ°æ§åˆ¶å™¨å¼€å§‹æ¥å—æ›´æ”¹ï¼ˆå·²ç¼–è¾‘ï¼Œæ—¨åœ¨æé«˜å¯è¯»æ€§ï¼‰ã€‚å°† 74ccf9f566-q5989 æ›¿æ¢æˆæ¥è‡ªä¸Šä¸€ä¸ªå‘½ä»¤è¾“å‡ºä¸­çš„ä¸€ä¸ª Pod çš„å€¼ã€‚\nkubectl logs efs-csi-controller-74ccf9f566-q5989 \\ -n kube-system \\ -c csi-provisioner \\ --tail 10 è¾“å‡º\n... 1 controller.go:737] successfully created PV pvc-5983ffec-96cf-40c1-9cd6-e5686ca84eca for PVC efs-claim and csi volume name fs-95bcec92::fsap-02a88145b865d3a87 å¦‚æœæœªçœ‹åˆ°ä¸Šä¸€ä¸ªè¾“å‡ºï¼Œè¯·ä½¿ç”¨å…¶ä»–æ§åˆ¶å™¨ Pod ä¹‹ä¸€è¿è¡Œä¸Šä¸€ä¸ªå‘½ä»¤ã€‚\nç¡®è®¤å·²åˆ›å»ºçŠ¶æ€ä¸º Bound è‡³ PersistentVolumeClaim çš„æŒä¹…æ€§å·ï¼š\nkubectl get pv è¾“å‡º\nNAME CAPACITY ACCESS MODES RECLAIM POLICY STATUS CLAIM STORAGECLASS REASON AGE pvc-5983ffec-96cf-40c1-9cd6-e5686ca84eca 20Gi RWX Delete Bound default/efs-claim efs-sc 7m57s æŸ¥çœ‹æœ‰å…³æ‰€åˆ›å»ºçš„ PersistentVolumeClaim çš„è¯¦ç»†ä¿¡æ¯ã€‚\nkubectl get pvc è¾“å‡º\nNAME STATUS VOLUME CAPACITY ACCESS MODES STORAGECLASS AGE efs-claim Bound pvc-5983ffec-96cf-40c1-9cd6-e5686ca84eca 20Gi RWX efs-sc 9m7s æŸ¥çœ‹ç¤ºä¾‹åº”ç”¨ç¨‹åº Pod çš„çŠ¶æ€ã€‚\nkubectl get pods -o wide è¾“å‡º\nNAME READY STATUS RESTARTS AGE IP NODE NOMINATED NODE READINESS GATES efs-example 1/1 Running 0 10m 192.168.78.156 ip-192-168-73-191.us-west-2.compute.internal \u0026lt;none\u0026gt; \u0026lt;none\u0026gt; ç¡®è®¤æ•°æ®å·²å†™å…¥åˆ°å·ã€‚\nkubectl exec efs-app -- bash -c \u0026#34;cat data/out\u0026#34; è¾“å‡º\n... Tue Mar 23 14:29:16 UTC 2021 Tue Mar 23 14:29:21 UTC 2021 Tue Mar 23 14:29:26 UTC 2021 Tue Mar 23 14:29:31 UTC 2021 ... ï¼ˆå¯é€‰ï¼‰ç»ˆæ­¢è¿è¡Œ Pod çš„ Amazon EKS èŠ‚ç‚¹å¹¶ç­‰å¾…é‡æ–°å®‰æ’è¿è¡Œ Podã€‚æˆ–è€…ï¼Œæ‚¨ä¹Ÿå¯ä»¥åˆ é™¤ Pod å¹¶é‡æ–°éƒ¨ç½²å®ƒã€‚å†æ¬¡å®Œæˆæ­¥éª¤ 7ï¼Œç¡®è®¤è¾“å‡ºåŒ…å«å…ˆå‰çš„è¾“å‡ºã€‚\nä½œè€…ï¼šSREè¿ç»´åšå®¢\nåšå®¢åœ°å€ï¼šhttps://www.cnsre.cn/\næ–‡ç« åœ°å€ï¼šhttps://www.cnsre.cn/posts/220110850573/\nç›¸å…³è¯é¢˜ï¼šhttps://www.cnsre.cn/tags/eks/\n","description":"å¦‚ä½•åœ¨ Amazon Elastic Kubernetes Service (Amazon EKS) ä¸­ä½¿ç”¨ EFS å®ç°æŒä¹…æ€§å­˜å‚¨ã€‚","id":8,"section":"posts","tags":["eks","kubernetes","efs","aws"],"title":"Amazon EKS ä¸­ EFS æŒä¹…æ€§å­˜å‚¨","uri":"http://www.cnsre.cn:80/posts/220110850573/"},{"content":" ä½œè€…ï¼šSREè¿ç»´åšå®¢\nåšå®¢åœ°å€ï¼šhttps://www.cnsre.cn/\næ–‡ç« åœ°å€ï¼šhttps://www.cnsre.cn/posts/220107906441/\nç›¸å…³è¯é¢˜ï¼šhttps://www.cnsre.cn/tags/eks/\nä»‹ç» æœ€è¿‘ä¸€ç›´åœ¨ç©EKSï¼ˆElastic Kubernetes Service \u0026ndash; Amazon EKSï¼‰ å’Œ kubesphereã€‚ å› ä¸ºä¹‹å‰æ²¡æœ‰ä½¿ç”¨è¿‡EKS å’Œ kubesphere æ‰€ä»¥è¿™ä¸ªè¿‡ç¨‹ä¹Ÿæ˜¯ä¸€ä¸ªè¯•é”™çš„è¿‡ç¨‹ï¼Œåœ¨æˆ‘ä½¿ç”¨ kubesphere çš„æ—¶å€™å‘ç°æœ‰ä¸€ä¸ªæ—¥å¿—æœåŠ¡ï¼Œåœ¨å¥½å¥‡å¿ƒçš„é©±ä½¿ä¸‹ï¼Œæˆ‘åˆ›å»ºäº†å®ƒã€‚\nåœ¨æˆ‘åˆ›å»ºäº†æ—¥å¿—æœåŠ¡ï¼ˆKubeSphere Logging Systemï¼‰ä»¥åï¼Œæˆ‘å‘ç°æˆ‘å¹¶ä¸æƒ³ä½¿ç”¨å®ƒã€‚ï¼ˆå¯èƒ½æˆ‘åªæ˜¯æƒ³çœ‹çœ‹å®ƒåˆ°åº•æ˜¯ä»€ä¹ˆå§ã€‚ï¼‰å¼ºè¿«ç—‡æˆ‘çš„ï¼Œå°±æƒ³æŠŠå®ƒç»™åˆ é™¤æ‰ã€‚äºæ˜¯æˆ‘åœ¨æˆ‘çš„ EKS ä¸­å¯¹ä»–è¿›è¡Œäº†å¼ºåˆ¶åˆ é™¤ kubectl delete ns kubesphere-logging-system --force --grace-period=0\nè®©äººå°´å°¬çš„æ˜¯ï¼Œè¿™ä¸ª Namespace å¹¶æ²¡æœ‰ç«‹é©¬åˆ é™¤ï¼Œæˆ‘è‡ªæˆ‘å®‰æ…°åˆ°ï¼Œå¯èƒ½ Namespace ä¸‹è¾¹æœ‰å…¶ä»–æ²¡æœ‰åˆ é™¤çš„èµ„æºåœ¨ç­‰å¾…åˆ é™¤ï¼Œæˆ‘åœ¨ç­‰ç­‰ã€‚ã€‚ã€‚\nè¿‡äº†åŠä¸ªå°æ—¶ï¼Œæˆ‘å»æŸ¥çœ‹çš„æ—¶å€™\n[root@ip-10-0-100-206 ~]# kubectl get ns kubesphere-logging-system NAME STATUS AGE kubesphere-logging-system Terminating 6d19h å®ƒå¥½åƒè¿™åœ°å¡åœ¨äº† Terminating çš„çŠ¶æ€ã€‚\næˆ‘è¯•ç€å¯»æ‰¾è§£å†³æ–¹æ³•ï¼Œhttp://github.com/kubernetes/kubernetes/issues/60807 ä½†æ˜¯è¿™ä¸­æ–¹æ³•è¦é€šè¿‡ API æ‰å¯ä»¥å®ç°ã€‚EKS æ˜¯æ‰˜ç®¡åœ¨ AWS ä¸­çš„ï¼Œæˆ‘æ ¹æœ¬æ²¡æœ‰åŠæ³•å»æ“ä½œeksçš„åå°ã€‚\næˆ‘å¼€å§‹åæ‚”æˆ‘ä¸ºä»€ä¹ˆè¦å»å®‰è£…å®ƒï¼Œæˆ‘æœ¬å¯ä»¥ä¸æŠ˜è…¾çš„ã€‚ä½†æ˜¯å›æƒ³å¦‚æœæˆ‘ä¸å»å®‰è£…å®ƒçš„è¯ï¼Œæˆ‘è‚¯å®šä¼šåƒæƒ³åœ¨è¿™æ ·éš¾è¿‡ï¼Œå› ä¸ºæˆ‘æ— æ³•äº†è§£å®ƒï¼ˆKubeSphere Logging Systemï¼‰åˆ°åº•æ˜¯ä»€ä¹ˆæ ·çš„ã€‚\nç»ˆäºæˆ‘æ‰¾åˆ°äº† commented https://github.com/kubernetes/kubernetes/issues/60807#issuecomment-663853215\nå¦‚ä½•å½»åº•åˆ é™¤ namespace è·å–namespaceçš„è¯¦æƒ…ä¿¡æ¯å¹¶è½¬ä¸ºjson 1 kubectl get namespace kubesphere-logging-system -o json \u0026gt; kubesphere-logging-system.json æ‰“å¼€ json æ–‡ä»¶ç¼–è¾‘ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 148 149 150 151 152 153 154 155 156 157 158 159 160 161 162 163 164 165 166 167 168 169 170 { \u0026#34;apiVersion\u0026#34;: \u0026#34;v1\u0026#34;, \u0026#34;kind\u0026#34;: \u0026#34;Namespace\u0026#34;, \u0026#34;metadata\u0026#34;: { \u0026#34;creationTimestamp\u0026#34;: \u0026#34;2021-12-31T05:03:58Z\u0026#34;, \u0026#34;deletionTimestamp\u0026#34;: \u0026#34;2022-01-05T08:05:40Z\u0026#34;, \u0026#34;labels\u0026#34;: { \u0026#34;kubesphere.io/namespace\u0026#34;: \u0026#34;kubesphere-logging-system\u0026#34;, \u0026#34;kubesphere.io/workspace\u0026#34;: \u0026#34;system-workspace\u0026#34; }, \u0026#34;managedFields\u0026#34;: [ { \u0026#34;apiVersion\u0026#34;: \u0026#34;v1\u0026#34;, \u0026#34;fieldsType\u0026#34;: \u0026#34;FieldsV1\u0026#34;, \u0026#34;fieldsV1\u0026#34;: { \u0026#34;f:metadata\u0026#34;: { \u0026#34;f:labels\u0026#34;: { \u0026#34;.\u0026#34;: {}, \u0026#34;f:kubesphere.io/namespace\u0026#34;: {} }, \u0026#34;f:ownerReferences\u0026#34;: { \u0026#34;.\u0026#34;: {}, \u0026#34;k:{\\\u0026#34;uid\\\u0026#34;:\\\u0026#34;6d535470-2592-4f3c-a155-eabc362c339d\\\u0026#34;}\u0026#34;: { \u0026#34;.\u0026#34;: {}, \u0026#34;f:apiVersion\u0026#34;: {}, \u0026#34;f:blockOwnerDeletion\u0026#34;: {}, \u0026#34;f:controller\u0026#34;: {}, \u0026#34;f:kind\u0026#34;: {}, \u0026#34;f:name\u0026#34;: {}, \u0026#34;f:uid\u0026#34;: {} } } } }, \u0026#34;manager\u0026#34;: \u0026#34;controller-manager\u0026#34;, \u0026#34;operation\u0026#34;: \u0026#34;Update\u0026#34;, \u0026#34;time\u0026#34;: \u0026#34;2021-12-31T05:04:01Z\u0026#34; }, { \u0026#34;apiVersion\u0026#34;: \u0026#34;v1\u0026#34;, \u0026#34;fieldsType\u0026#34;: \u0026#34;FieldsV1\u0026#34;, \u0026#34;fieldsV1\u0026#34;: { \u0026#34;f:metadata\u0026#34;: { \u0026#34;f:labels\u0026#34;: { \u0026#34;f:kubesphere.io/workspace\u0026#34;: {} } }, \u0026#34;f:status\u0026#34;: { \u0026#34;f:phase\u0026#34;: {} } }, \u0026#34;manager\u0026#34;: \u0026#34;kubectl\u0026#34;, \u0026#34;operation\u0026#34;: \u0026#34;Update\u0026#34;, \u0026#34;time\u0026#34;: \u0026#34;2021-12-31T05:04:01Z\u0026#34; }, { \u0026#34;apiVersion\u0026#34;: \u0026#34;v1\u0026#34;, \u0026#34;fieldsType\u0026#34;: \u0026#34;FieldsV1\u0026#34;, \u0026#34;fieldsV1\u0026#34;: { \u0026#34;f:status\u0026#34;: { \u0026#34;f:conditions\u0026#34;: { \u0026#34;.\u0026#34;: {}, \u0026#34;k:{\\\u0026#34;type\\\u0026#34;:\\\u0026#34;NamespaceContentRemaining\\\u0026#34;}\u0026#34;: { \u0026#34;.\u0026#34;: {}, \u0026#34;f:lastTransitionTime\u0026#34;: {}, \u0026#34;f:message\u0026#34;: {}, \u0026#34;f:reason\u0026#34;: {}, \u0026#34;f:status\u0026#34;: {}, \u0026#34;f:type\u0026#34;: {} }, \u0026#34;k:{\\\u0026#34;type\\\u0026#34;:\\\u0026#34;NamespaceDeletionContentFailure\\\u0026#34;}\u0026#34;: { \u0026#34;.\u0026#34;: {}, \u0026#34;f:lastTransitionTime\u0026#34;: {}, \u0026#34;f:message\u0026#34;: {}, \u0026#34;f:reason\u0026#34;: {}, \u0026#34;f:status\u0026#34;: {}, \u0026#34;f:type\u0026#34;: {} }, \u0026#34;k:{\\\u0026#34;type\\\u0026#34;:\\\u0026#34;NamespaceDeletionDiscoveryFailure\\\u0026#34;}\u0026#34;: { \u0026#34;.\u0026#34;: {}, \u0026#34;f:lastTransitionTime\u0026#34;: {}, \u0026#34;f:message\u0026#34;: {}, \u0026#34;f:reason\u0026#34;: {}, \u0026#34;f:status\u0026#34;: {}, \u0026#34;f:type\u0026#34;: {} }, \u0026#34;k:{\\\u0026#34;type\\\u0026#34;:\\\u0026#34;NamespaceDeletionGroupVersionParsingFailure\\\u0026#34;}\u0026#34;: { \u0026#34;.\u0026#34;: {}, \u0026#34;f:lastTransitionTime\u0026#34;: {}, \u0026#34;f:message\u0026#34;: {}, \u0026#34;f:reason\u0026#34;: {}, \u0026#34;f:status\u0026#34;: {}, \u0026#34;f:type\u0026#34;: {} }, \u0026#34;k:{\\\u0026#34;type\\\u0026#34;:\\\u0026#34;NamespaceFinalizersRemaining\\\u0026#34;}\u0026#34;: { \u0026#34;.\u0026#34;: {}, \u0026#34;f:lastTransitionTime\u0026#34;: {}, \u0026#34;f:message\u0026#34;: {}, \u0026#34;f:reason\u0026#34;: {}, \u0026#34;f:status\u0026#34;: {}, \u0026#34;f:type\u0026#34;: {} } } } }, \u0026#34;manager\u0026#34;: \u0026#34;kube-controller-manager\u0026#34;, \u0026#34;operation\u0026#34;: \u0026#34;Update\u0026#34;, \u0026#34;time\u0026#34;: \u0026#34;2022-01-05T08:05:47Z\u0026#34; } ], \u0026#34;name\u0026#34;: \u0026#34;kubesphere-logging-system\u0026#34;, \u0026#34;ownerReferences\u0026#34;: [ { \u0026#34;apiVersion\u0026#34;: \u0026#34;tenant.kubesphere.io/v1alpha1\u0026#34;, \u0026#34;blockOwnerDeletion\u0026#34;: true, \u0026#34;controller\u0026#34;: true, \u0026#34;kind\u0026#34;: \u0026#34;Workspace\u0026#34;, \u0026#34;name\u0026#34;: \u0026#34;system-workspace\u0026#34;, \u0026#34;uid\u0026#34;: \u0026#34;6d535470-2592-4f3c-a155-eabc362c339d\u0026#34; } ], \u0026#34;resourceVersion\u0026#34;: \u0026#34;7376520\u0026#34;, \u0026#34;uid\u0026#34;: \u0026#34;2b76e9b1-75f2-4a2e-a819-73b36aea188e\u0026#34; }, \u0026#34;spec\u0026#34;: { \u0026#34;finalizers\u0026#34;: [ \u0026#34;kubernetes\u0026#34; # å°†æ­¤è¡Œåˆ é™¤ ] }, \u0026#34;status\u0026#34;: { \u0026#34;conditions\u0026#34;: [ { \u0026#34;lastTransitionTime\u0026#34;: \u0026#34;2022-01-05T08:05:47Z\u0026#34;, \u0026#34;message\u0026#34;: \u0026#34;All resources successfully discovered\u0026#34;, \u0026#34;reason\u0026#34;: \u0026#34;ResourcesDiscovered\u0026#34;, \u0026#34;status\u0026#34;: \u0026#34;False\u0026#34;, \u0026#34;type\u0026#34;: \u0026#34;NamespaceDeletionDiscoveryFailure\u0026#34; }, { \u0026#34;lastTransitionTime\u0026#34;: \u0026#34;2022-01-05T08:05:47Z\u0026#34;, \u0026#34;message\u0026#34;: \u0026#34;All legacy kube types successfully parsed\u0026#34;, \u0026#34;reason\u0026#34;: \u0026#34;ParsedGroupVersions\u0026#34;, \u0026#34;status\u0026#34;: \u0026#34;False\u0026#34;, \u0026#34;type\u0026#34;: \u0026#34;NamespaceDeletionGroupVersionParsingFailure\u0026#34; }, { \u0026#34;lastTransitionTime\u0026#34;: \u0026#34;2022-01-05T08:05:47Z\u0026#34;, \u0026#34;message\u0026#34;: \u0026#34;All content successfully deleted, may be waiting on finalization\u0026#34;, \u0026#34;reason\u0026#34;: \u0026#34;ContentDeleted\u0026#34;, \u0026#34;status\u0026#34;: \u0026#34;False\u0026#34;, \u0026#34;type\u0026#34;: \u0026#34;NamespaceDeletionContentFailure\u0026#34; }, { \u0026#34;lastTransitionTime\u0026#34;: \u0026#34;2022-01-05T08:05:47Z\u0026#34;, \u0026#34;message\u0026#34;: \u0026#34;Some resources are remaining: fluentbits.logging.kubesphere.io has 1 resource instances\u0026#34;, \u0026#34;reason\u0026#34;: \u0026#34;SomeResourcesRemain\u0026#34;, \u0026#34;status\u0026#34;: \u0026#34;True\u0026#34;, \u0026#34;type\u0026#34;: \u0026#34;NamespaceContentRemaining\u0026#34; }, { \u0026#34;lastTransitionTime\u0026#34;: \u0026#34;2022-01-05T08:05:47Z\u0026#34;, \u0026#34;message\u0026#34;: \u0026#34;Some content in the namespace has finalizers remaining: fluentbit.logging.kubesphere.io in 1 resource instances\u0026#34;, \u0026#34;reason\u0026#34;: \u0026#34;SomeFinalizersRemain\u0026#34;, \u0026#34;status\u0026#34;: \u0026#34;True\u0026#34;, \u0026#34;type\u0026#34;: \u0026#34;NamespaceFinalizersRemaining\u0026#34; } ], \u0026#34;phase\u0026#34;: \u0026#34;Terminating\u0026#34; } } æ‰¾åˆ° spec å°† finalizers ä¸‹çš„ kubernetes åˆ é™¤\nå…·ä½“å¦‚ä¸‹\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 148 149 150 151 152 153 154 155 156 157 158 159 160 161 162 163 164 165 166 167 168 169 { \u0026#34;apiVersion\u0026#34;: \u0026#34;v1\u0026#34;, \u0026#34;kind\u0026#34;: \u0026#34;Namespace\u0026#34;, \u0026#34;metadata\u0026#34;: { \u0026#34;creationTimestamp\u0026#34;: \u0026#34;2021-12-31T05:03:58Z\u0026#34;, \u0026#34;deletionTimestamp\u0026#34;: \u0026#34;2022-01-05T08:05:40Z\u0026#34;, \u0026#34;labels\u0026#34;: { \u0026#34;kubesphere.io/namespace\u0026#34;: \u0026#34;kubesphere-logging-system\u0026#34;, \u0026#34;kubesphere.io/workspace\u0026#34;: \u0026#34;system-workspace\u0026#34; }, \u0026#34;managedFields\u0026#34;: [ { \u0026#34;apiVersion\u0026#34;: \u0026#34;v1\u0026#34;, \u0026#34;fieldsType\u0026#34;: \u0026#34;FieldsV1\u0026#34;, \u0026#34;fieldsV1\u0026#34;: { \u0026#34;f:metadata\u0026#34;: { \u0026#34;f:labels\u0026#34;: { \u0026#34;.\u0026#34;: {}, \u0026#34;f:kubesphere.io/namespace\u0026#34;: {} }, \u0026#34;f:ownerReferences\u0026#34;: { \u0026#34;.\u0026#34;: {}, \u0026#34;k:{\\\u0026#34;uid\\\u0026#34;:\\\u0026#34;6d535470-2592-4f3c-a155-eabc362c339d\\\u0026#34;}\u0026#34;: { \u0026#34;.\u0026#34;: {}, \u0026#34;f:apiVersion\u0026#34;: {}, \u0026#34;f:blockOwnerDeletion\u0026#34;: {}, \u0026#34;f:controller\u0026#34;: {}, \u0026#34;f:kind\u0026#34;: {}, \u0026#34;f:name\u0026#34;: {}, \u0026#34;f:uid\u0026#34;: {} } } } }, \u0026#34;manager\u0026#34;: \u0026#34;controller-manager\u0026#34;, \u0026#34;operation\u0026#34;: \u0026#34;Update\u0026#34;, \u0026#34;time\u0026#34;: \u0026#34;2021-12-31T05:04:01Z\u0026#34; }, { \u0026#34;apiVersion\u0026#34;: \u0026#34;v1\u0026#34;, \u0026#34;fieldsType\u0026#34;: \u0026#34;FieldsV1\u0026#34;, \u0026#34;fieldsV1\u0026#34;: { \u0026#34;f:metadata\u0026#34;: { \u0026#34;f:labels\u0026#34;: { \u0026#34;f:kubesphere.io/workspace\u0026#34;: {} } }, \u0026#34;f:status\u0026#34;: { \u0026#34;f:phase\u0026#34;: {} } }, \u0026#34;manager\u0026#34;: \u0026#34;kubectl\u0026#34;, \u0026#34;operation\u0026#34;: \u0026#34;Update\u0026#34;, \u0026#34;time\u0026#34;: \u0026#34;2021-12-31T05:04:01Z\u0026#34; }, { \u0026#34;apiVersion\u0026#34;: \u0026#34;v1\u0026#34;, \u0026#34;fieldsType\u0026#34;: \u0026#34;FieldsV1\u0026#34;, \u0026#34;fieldsV1\u0026#34;: { \u0026#34;f:status\u0026#34;: { \u0026#34;f:conditions\u0026#34;: { \u0026#34;.\u0026#34;: {}, \u0026#34;k:{\\\u0026#34;type\\\u0026#34;:\\\u0026#34;NamespaceContentRemaining\\\u0026#34;}\u0026#34;: { \u0026#34;.\u0026#34;: {}, \u0026#34;f:lastTransitionTime\u0026#34;: {}, \u0026#34;f:message\u0026#34;: {}, \u0026#34;f:reason\u0026#34;: {}, \u0026#34;f:status\u0026#34;: {}, \u0026#34;f:type\u0026#34;: {} }, \u0026#34;k:{\\\u0026#34;type\\\u0026#34;:\\\u0026#34;NamespaceDeletionContentFailure\\\u0026#34;}\u0026#34;: { \u0026#34;.\u0026#34;: {}, \u0026#34;f:lastTransitionTime\u0026#34;: {}, \u0026#34;f:message\u0026#34;: {}, \u0026#34;f:reason\u0026#34;: {}, \u0026#34;f:status\u0026#34;: {}, \u0026#34;f:type\u0026#34;: {} }, \u0026#34;k:{\\\u0026#34;type\\\u0026#34;:\\\u0026#34;NamespaceDeletionDiscoveryFailure\\\u0026#34;}\u0026#34;: { \u0026#34;.\u0026#34;: {}, \u0026#34;f:lastTransitionTime\u0026#34;: {}, \u0026#34;f:message\u0026#34;: {}, \u0026#34;f:reason\u0026#34;: {}, \u0026#34;f:status\u0026#34;: {}, \u0026#34;f:type\u0026#34;: {} }, \u0026#34;k:{\\\u0026#34;type\\\u0026#34;:\\\u0026#34;NamespaceDeletionGroupVersionParsingFailure\\\u0026#34;}\u0026#34;: { \u0026#34;.\u0026#34;: {}, \u0026#34;f:lastTransitionTime\u0026#34;: {}, \u0026#34;f:message\u0026#34;: {}, \u0026#34;f:reason\u0026#34;: {}, \u0026#34;f:status\u0026#34;: {}, \u0026#34;f:type\u0026#34;: {} }, \u0026#34;k:{\\\u0026#34;type\\\u0026#34;:\\\u0026#34;NamespaceFinalizersRemaining\\\u0026#34;}\u0026#34;: { \u0026#34;.\u0026#34;: {}, \u0026#34;f:lastTransitionTime\u0026#34;: {}, \u0026#34;f:message\u0026#34;: {}, \u0026#34;f:reason\u0026#34;: {}, \u0026#34;f:status\u0026#34;: {}, \u0026#34;f:type\u0026#34;: {} } } } }, \u0026#34;manager\u0026#34;: \u0026#34;kube-controller-manager\u0026#34;, \u0026#34;operation\u0026#34;: \u0026#34;Update\u0026#34;, \u0026#34;time\u0026#34;: \u0026#34;2022-01-05T08:05:47Z\u0026#34; } ], \u0026#34;name\u0026#34;: \u0026#34;kubesphere-logging-system\u0026#34;, \u0026#34;ownerReferences\u0026#34;: [ { \u0026#34;apiVersion\u0026#34;: \u0026#34;tenant.kubesphere.io/v1alpha1\u0026#34;, \u0026#34;blockOwnerDeletion\u0026#34;: true, \u0026#34;controller\u0026#34;: true, \u0026#34;kind\u0026#34;: \u0026#34;Workspace\u0026#34;, \u0026#34;name\u0026#34;: \u0026#34;system-workspace\u0026#34;, \u0026#34;uid\u0026#34;: \u0026#34;6d535470-2592-4f3c-a155-eabc362c339d\u0026#34; } ], \u0026#34;resourceVersion\u0026#34;: \u0026#34;7376520\u0026#34;, \u0026#34;uid\u0026#34;: \u0026#34;2b76e9b1-75f2-4a2e-a819-73b36aea188e\u0026#34; }, \u0026#34;spec\u0026#34;: { \u0026#34;finalizers\u0026#34;: [ ] }, \u0026#34;status\u0026#34;: { \u0026#34;conditions\u0026#34;: [ { \u0026#34;lastTransitionTime\u0026#34;: \u0026#34;2022-01-05T08:05:47Z\u0026#34;, \u0026#34;message\u0026#34;: \u0026#34;All resources successfully discovered\u0026#34;, \u0026#34;reason\u0026#34;: \u0026#34;ResourcesDiscovered\u0026#34;, \u0026#34;status\u0026#34;: \u0026#34;False\u0026#34;, \u0026#34;type\u0026#34;: \u0026#34;NamespaceDeletionDiscoveryFailure\u0026#34; }, { \u0026#34;lastTransitionTime\u0026#34;: \u0026#34;2022-01-05T08:05:47Z\u0026#34;, \u0026#34;message\u0026#34;: \u0026#34;All legacy kube types successfully parsed\u0026#34;, \u0026#34;reason\u0026#34;: \u0026#34;ParsedGroupVersions\u0026#34;, \u0026#34;status\u0026#34;: \u0026#34;False\u0026#34;, \u0026#34;type\u0026#34;: \u0026#34;NamespaceDeletionGroupVersionParsingFailure\u0026#34; }, { \u0026#34;lastTransitionTime\u0026#34;: \u0026#34;2022-01-05T08:05:47Z\u0026#34;, \u0026#34;message\u0026#34;: \u0026#34;All content successfully deleted, may be waiting on finalization\u0026#34;, \u0026#34;reason\u0026#34;: \u0026#34;ContentDeleted\u0026#34;, \u0026#34;status\u0026#34;: \u0026#34;False\u0026#34;, \u0026#34;type\u0026#34;: \u0026#34;NamespaceDeletionContentFailure\u0026#34; }, { \u0026#34;lastTransitionTime\u0026#34;: \u0026#34;2022-01-05T08:05:47Z\u0026#34;, \u0026#34;message\u0026#34;: \u0026#34;Some resources are remaining: fluentbits.logging.kubesphere.io has 1 resource instances\u0026#34;, \u0026#34;reason\u0026#34;: \u0026#34;SomeResourcesRemain\u0026#34;, \u0026#34;status\u0026#34;: \u0026#34;True\u0026#34;, \u0026#34;type\u0026#34;: \u0026#34;NamespaceContentRemaining\u0026#34; }, { \u0026#34;lastTransitionTime\u0026#34;: \u0026#34;2022-01-05T08:05:47Z\u0026#34;, \u0026#34;message\u0026#34;: \u0026#34;Some content in the namespace has finalizers remaining: fluentbit.logging.kubesphere.io in 1 resource instances\u0026#34;, \u0026#34;reason\u0026#34;: \u0026#34;SomeFinalizersRemain\u0026#34;, \u0026#34;status\u0026#34;: \u0026#34;True\u0026#34;, \u0026#34;type\u0026#34;: \u0026#34;NamespaceFinalizersRemaining\u0026#34; } ], \u0026#34;phase\u0026#34;: \u0026#34;Terminating\u0026#34; } } æ‰§è¡Œæ¸…ç†å‘½ä»¤ ç°åœ¨æˆ‘ä»¬åªéœ€è¦ä¸€æ¡å‘½ä»¤ å°±å¯ä»¥å½»åº•åˆ é™¤è¿™ä¸ª Namespace\n1 kubectl replace --raw \u0026#34;/api/v1/namespaces/kubesphere-logging-system/finalize\u0026#34; -f ./kubesphere-logging-system.json æ‰§è¡Œå®Œä»¥åï¼Œä½ éœ€è¦ç­‰å¾…ä¸€ä¼š\nå†æ¬¡æ‰§è¡Œå‘½ä»¤æ£€æŸ¥ namespaces\n1 kubectl replace --raw \u0026#34;/api/v1/namespaces/kubesphere-logging-system/finalize\u0026#34; -f ./kubesphere-logging-system.json æœ€åçš„æ£€æŸ¥ 1 2 3 4 5 6 7 8 9 10 11 12 13 kubectl get ns kubesphere-logging-system Error from server (NotFound): namespaces \u0026#34;kubesphere-logging-system\u0026#34; not found [root@ip-10-0-100-206 ~]# kubectl get ns NAME STATUS AGE default Active 23d kubesphere-controls-system Active 9d kubesphere-devops-system Active 9d kubesphere-devops-worker Active 16h kubesphere-monitoring-federated Active 9d kubesphere-monitoring-system Active 9d kubesphere-sample-dev Active 8d kubesphere-system Active 9d åœ¨æ­¤æŸ¥çœ‹çš„æ—¶å€™ï¼Œå®ƒå·²ç»ä¸å­˜åœ¨äº†ã€‚\nä½œè€…ï¼šSREè¿ç»´åšå®¢\nåšå®¢åœ°å€ï¼šhttps://www.cnsre.cn/\næ–‡ç« åœ°å€ï¼šhttps://www.cnsre.cn/posts/220107906441/\nç›¸å…³è¯é¢˜ï¼šhttps://www.cnsre.cn/tags/eks/\n","description":"åˆ é™¤ Namespace å¤±è´¥ Namespace ä¸€ç›´å¤„äºTerminating çš„çŠ¶æ€ å¦‚ä½•å½»åº•åˆ é™¤EKSä¸­ä¸€ç›´å¡åœ¨Terminatingçš„Namespace","id":9,"section":"posts","tags":["eks","æ•…éšœé›†","kubernetes"],"title":"å¦‚ä½•å½»åº•åˆ é™¤EKSä¸­ä¸€ç›´å¡åœ¨Terminatingçš„Namespace","uri":"http://www.cnsre.cn:80/posts/220107906441/"},{"content":" ä½œè€…ï¼šSREè¿ç»´åšå®¢\nåšå®¢åœ°å€ï¼šhttps://www.cnsre.cn/\næ–‡ç« åœ°å€ï¼šhttps://www.cnsre.cn/posts/211217431135/\nç›¸å…³è¯é¢˜ï¼šhttps://www.cnsre.cn/tags/aws/\næœ€è¿‘åœ¨AWS å¹³å°åˆ›å»ºäº†EKS ç”¨äºæµ‹è¯•ç¯å¢ƒé¡¹ç›®ï¼ŒEKS åˆ›å»ºå®Œä»¥åæˆ‘æ‰“ç®—ä½¿ç”¨ Ingress æ§åˆ¶å™¨ æ¥æš´éœ²æœåŠ¡ï¼Œingress å‰åœ¨æ·»åŠ ä¸€ä¸ªALB è´Ÿè½½å‡è¡¡å™¨ï¼Œè¿™æ ·å°±å¯ä»¥å®ç°å®Œå…¨çš„é«˜å¯ç”¨äº†ã€‚ä½†æ˜¯åœ¨åˆ›å»ºå¥½ ingress å´å‘ç°æ— æ³•è°ƒé€šæœåŠ¡ï¼ŒæŸ¥çœ‹ aws å®˜æ–¹æ–‡æ¡£ Amazon EKS ä¸Šçš„åº”ç”¨ç¨‹åºè´Ÿè½½å‡è¡¡ å‘ç°éœ€è¦ä½¿ç”¨ aws-load-balancer-controller.\næœ¬æ–‡æ¡£çš„ç›®æ ‡ï¼š\nåˆ›å»º EKS ALB æ‰€éœ€è¦çš„è§’è‰²ã€‚\nåˆ›å»º EKS aws-load-balancer-controller\nåˆ›å»º EKS pod æœåŠ¡\nä½¿ç”¨ ALB å°† pod æœåŠ¡æš´éœ²å‡ºå»\nAWS Load Balancer Controller ä»‹ç» AWS Load Balancer Controller çš„å·¥ä½œåŸç† AWS Load Balancer Controller æ˜¯å¸®åŠ©ç®¡ç† Kubernetes é›†ç¾¤çš„å¼¹æ€§è´Ÿè½½å‡è¡¡å™¨çš„æ§åˆ¶å™¨ã€‚\nå®ƒé€šè¿‡ä¾›åº”åº”ç”¨ç¨‹åºè´Ÿè½½å‡è¡¡å™¨æ¥æ»¡è¶³ Kubernetes Ingress èµ„æºã€‚ å®ƒé€šè¿‡æä¾› ç½‘ç»œè´Ÿè½½å‡è¡¡å™¨æ¥æ»¡è¶³ Kubernetes Service èµ„æºã€‚ ä¸‹å›¾è¯¦ç»†è¯´æ˜äº†æ­¤æ§åˆ¶å™¨åˆ›å»ºçš„ AWS ç»„ä»¶ã€‚å®ƒè¿˜æ¼”ç¤ºäº†ä» ALB åˆ° Kubernetes é›†ç¾¤çš„è·¯ç”±å…¥å£æµé‡ã€‚\n[1]ï¼šæ§åˆ¶å™¨ç›‘è§†æ¥è‡ª API æœåŠ¡å™¨çš„å…¥å£äº‹ä»¶ã€‚å½“å®ƒæ‰¾åˆ°æ»¡è¶³å…¶è¦æ±‚çš„å…¥å£èµ„æºæ—¶ï¼Œå®ƒå¼€å§‹åˆ›å»º AWS èµ„æºã€‚\n[2]ï¼šåœ¨ AWS ä¸­ä¸ºæ–°çš„å…¥å£èµ„æºåˆ›å»ºäº†ä¸€ä¸ª ALB (ELBv2)ã€‚æ­¤ ALB å¯ä»¥é¢å‘ Internet æˆ–å†…éƒ¨ã€‚æ‚¨è¿˜å¯ä»¥ä½¿ç”¨æ³¨é‡ŠæŒ‡å®šå®ƒåœ¨å…¶ä¸­åˆ›å»ºçš„å­ç½‘ã€‚\n[3]ï¼šåœ¨ AWS ä¸­ä¸ºå…¥å£èµ„æºä¸­æè¿°çš„æ¯ä¸ªç‹¬ç‰¹çš„ Kubernetes æœåŠ¡åˆ›å»ºç›®æ ‡ç»„ã€‚\n[4]ï¼šä¸ºå…¥å£èµ„æºæ³¨é‡Šä¸­è¯¦è¿°çš„æ¯ä¸ªç«¯å£åˆ›å»ºä¾¦å¬å™¨ã€‚å¦‚æœæœªæŒ‡å®šç«¯å£ï¼Œåˆ™ä½¿ç”¨åˆç†çš„é»˜è®¤å€¼ (80æˆ–443)ã€‚è¯ä¹¦ä¹Ÿå¯ä»¥é€šè¿‡æ³¨é‡Šé™„åŠ ã€‚\n[5]ï¼šä¸ºå…¥å£èµ„æºä¸­æŒ‡å®šçš„æ¯ä¸ªè·¯å¾„åˆ›å»ºè§„åˆ™ã€‚è¿™å¯ç¡®ä¿å°†ç‰¹å®šè·¯å¾„çš„æµé‡è·¯ç”±åˆ°æ­£ç¡®çš„ Kubernetes æœåŠ¡ã€‚\nå®‰è£…å‰çš„å‡†å¤‡ EKS å·²ç»åˆ›å»ºå®Œæ¯• å‡†å¤‡ ä¸¤ä¸ª Public å­ç½‘ èƒ½å¤Ÿåˆ›å»º IAM ç­–ç•¥ çš„è´¦æˆ· å…³äºå­ç½‘çš„è¯´æ˜ï¼š\næ ¹æ®EKS æœ€ä½³å®è·µã€‚EKS çš„ worker nodeï¼Œå®ƒä»¬åªéœ€è¦æ¥æ”¶æ¥è‡ª alb ingressï¼ˆé€šè¿‡å†…ç½‘è½¬å‘ï¼‰çš„æµé‡ï¼Œå®‰å…¨èµ·è§å°±éœ€è¦æŠŠä»–ä»¬æ”¾åœ¨ç§æœ‰å­ç½‘ã€‚ä½†æ˜¯å®ƒä»¬åˆéœ€è¦å»å…¬ç½‘ä¸Šæ‹‰ä¸€äº›é•œåƒï¼Œæ‰€ä»¥å®ƒä»¬æœ¬èº«ä¹Ÿéœ€è¦æ”¾é—®å…¬ç½‘çš„èƒ½åŠ›ï¼Œè¿™ä¸ªæ—¶å€™å®ƒä»¬çš„å­ç½‘é‡Œé…ç½®ä¸ª natï¼Œè®¿é—®å¤–ç½‘çš„æ—¶å€™ç”± NAT åšä¸€ä¸ªå‡ºå‘çš„è½¬å‘ï¼Œå°±å¯ä»¥å®ç°äº†ï¼Œä½†æ˜¯å› ä¸º nat æ˜¯å•å‘çš„ï¼Œå¤–ç•Œæ˜¯æ— æ³•é€šè¿‡NATè®¿é—®åˆ°eksçš„èŠ‚ç‚¹çš„ï¼Œæ‰€ä»¥æˆ‘å°±éœ€è¦å°†ALB æ”¾åœ¨ public å­ç½‘é‡Œã€‚æœ€åå°±æ˜¯ ALB æ”¾åœ¨ public æ¥æ¥å—æµé‡ï¼Œworker node åœ¨ç§æœ‰å­ç½‘å¤„ç†ä¸šåŠ¡ã€‚\nåˆ›å»ºAWS Load Balancer Controller çš„ IAM ç­–ç•¥ æ‰“å¼€ ç­–ç•¥ ç‚¹å‡» åˆ›å»ºç­–ç•¥ æ‰“å¼€ IAM_Policy.json å¤åˆ¶å†…å®¹ç²˜è´´åˆ° json\nç‚¹å‡»ä¸‹ä¸€æ­¥:æ ‡ç­¾\nç„¶åä¸€ç›´ä¸‹ä¸€æ­¥ åœ¨ä¸‹å›¾ä¸­åç§°å¡«å†™ AWSLoadBalancerControllerIAMPolicy ä½ ä¹Ÿå¯ä»¥è‡ªå®šä¹‰åç§°ã€‚ç„¶ååˆ›å»ºç­–ç•¥ã€‚\nå¦‚æœä»¥å®˜æ–¹æä¾›çš„ IAM_Policy.json ä¿å­˜æœ‰é”™çš„è¯ä½ å¯ä»¥ä½¿ç”¨ä¸€ä¸‹ç­–ç•¥ï¼ˆæƒé™ä¼šå¤§ä¸€äº›ï¼‰ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 148 149 150 151 152 153 154 155 156 157 158 159 160 161 162 163 164 165 166 167 168 169 170 171 172 173 174 175 176 177 178 179 180 181 182 183 184 185 186 187 188 189 190 191 192 193 194 195 196 197 198 199 200 201 202 203 204 205 206 207 { \u0026#34;Version\u0026#34;: \u0026#34;2012-10-17\u0026#34;, \u0026#34;Statement\u0026#34;: [ { \u0026#34;Effect\u0026#34;: \u0026#34;Allow\u0026#34;, \u0026#34;Action\u0026#34;: [ \u0026#34;iam:CreateServiceLinkedRole\u0026#34;, \u0026#34;ec2:DescribeAccountAttributes\u0026#34;, \u0026#34;ec2:DescribeAddresses\u0026#34;, \u0026#34;ec2:DescribeAvailabilityZones\u0026#34;, \u0026#34;ec2:DescribeInternetGateways\u0026#34;, \u0026#34;ec2:DescribeVpcs\u0026#34;, \u0026#34;ec2:DescribeSubnets\u0026#34;, \u0026#34;ec2:DescribeSecurityGroups\u0026#34;, \u0026#34;ec2:DescribeInstances\u0026#34;, \u0026#34;ec2:DescribeNetworkInterfaces\u0026#34;, \u0026#34;ec2:DescribeTags\u0026#34;, \u0026#34;ec2:GetCoipPoolUsage\u0026#34;, \u0026#34;ec2:DescribeCoipPools\u0026#34;, \u0026#34;elasticloadbalancing:DescribeLoadBalancers\u0026#34;, \u0026#34;elasticloadbalancing:DescribeLoadBalancerAttributes\u0026#34;, \u0026#34;elasticloadbalancing:DescribeListeners\u0026#34;, \u0026#34;elasticloadbalancing:DescribeListenerCertificates\u0026#34;, \u0026#34;elasticloadbalancing:DescribeSSLPolicies\u0026#34;, \u0026#34;elasticloadbalancing:DescribeRules\u0026#34;, \u0026#34;elasticloadbalancing:DescribeTargetGroups\u0026#34;, \u0026#34;elasticloadbalancing:DescribeTargetGroupAttributes\u0026#34;, \u0026#34;elasticloadbalancing:DescribeTargetHealth\u0026#34;, \u0026#34;elasticloadbalancing:DescribeTags\u0026#34; ], \u0026#34;Resource\u0026#34;: \u0026#34;*\u0026#34; }, { \u0026#34;Effect\u0026#34;: \u0026#34;Allow\u0026#34;, \u0026#34;Action\u0026#34;: [ \u0026#34;cognito-idp:DescribeUserPoolClient\u0026#34;, \u0026#34;acm:ListCertificates\u0026#34;, \u0026#34;acm:DescribeCertificate\u0026#34;, \u0026#34;iam:ListServerCertificates\u0026#34;, \u0026#34;iam:GetServerCertificate\u0026#34;, \u0026#34;waf-regional:GetWebACL\u0026#34;, \u0026#34;waf-regional:GetWebACLForResource\u0026#34;, \u0026#34;waf-regional:AssociateWebACL\u0026#34;, \u0026#34;waf-regional:DisassociateWebACL\u0026#34;, \u0026#34;wafv2:GetWebACL\u0026#34;, \u0026#34;wafv2:GetWebACLForResource\u0026#34;, \u0026#34;wafv2:AssociateWebACL\u0026#34;, \u0026#34;wafv2:DisassociateWebACL\u0026#34;, \u0026#34;shield:GetSubscriptionState\u0026#34;, \u0026#34;shield:DescribeProtection\u0026#34;, \u0026#34;shield:CreateProtection\u0026#34;, \u0026#34;shield:DeleteProtection\u0026#34; ], \u0026#34;Resource\u0026#34;: \u0026#34;*\u0026#34; }, { \u0026#34;Effect\u0026#34;: \u0026#34;Allow\u0026#34;, \u0026#34;Action\u0026#34;: [ \u0026#34;ec2:AuthorizeSecurityGroupIngress\u0026#34;, \u0026#34;ec2:RevokeSecurityGroupIngress\u0026#34; ], \u0026#34;Resource\u0026#34;: \u0026#34;*\u0026#34; }, { \u0026#34;Effect\u0026#34;: \u0026#34;Allow\u0026#34;, \u0026#34;Action\u0026#34;: [ \u0026#34;ec2:CreateSecurityGroup\u0026#34; ], \u0026#34;Resource\u0026#34;: \u0026#34;*\u0026#34; }, { \u0026#34;Effect\u0026#34;: \u0026#34;Allow\u0026#34;, \u0026#34;Action\u0026#34;: [ \u0026#34;ec2:CreateTags\u0026#34; ], \u0026#34;Resource\u0026#34;: \u0026#34;arn:aws-cn:ec2:*:*:security-group/*\u0026#34;, \u0026#34;Condition\u0026#34;: { \u0026#34;StringEquals\u0026#34;: { \u0026#34;ec2:CreateAction\u0026#34;: \u0026#34;CreateSecurityGroup\u0026#34; }, \u0026#34;Null\u0026#34;: { \u0026#34;aws:RequestTag/elbv2.k8s.aws/cluster\u0026#34;: \u0026#34;false\u0026#34; } } }, { \u0026#34;Effect\u0026#34;: \u0026#34;Allow\u0026#34;, \u0026#34;Action\u0026#34;: [ \u0026#34;ec2:CreateTags\u0026#34;, \u0026#34;ec2:DeleteTags\u0026#34; ], \u0026#34;Resource\u0026#34;: \u0026#34;arn:aws-cn:ec2:*:*:security-group/*\u0026#34;, \u0026#34;Condition\u0026#34;: { \u0026#34;Null\u0026#34;: { \u0026#34;aws:RequestTag/elbv2.k8s.aws/cluster\u0026#34;: \u0026#34;true\u0026#34;, \u0026#34;aws:ResourceTag/elbv2.k8s.aws/cluster\u0026#34;: \u0026#34;false\u0026#34; } } }, { \u0026#34;Effect\u0026#34;: \u0026#34;Allow\u0026#34;, \u0026#34;Action\u0026#34;: [ \u0026#34;ec2:AuthorizeSecurityGroupIngress\u0026#34;, \u0026#34;ec2:RevokeSecurityGroupIngress\u0026#34;, \u0026#34;ec2:DeleteSecurityGroup\u0026#34; ], \u0026#34;Resource\u0026#34;: \u0026#34;*\u0026#34;, \u0026#34;Condition\u0026#34;: { \u0026#34;Null\u0026#34;: { \u0026#34;aws:ResourceTag/elbv2.k8s.aws/cluster\u0026#34;: \u0026#34;false\u0026#34; } } }, { \u0026#34;Effect\u0026#34;: \u0026#34;Allow\u0026#34;, \u0026#34;Action\u0026#34;: [ \u0026#34;elasticloadbalancing:CreateLoadBalancer\u0026#34;, \u0026#34;elasticloadbalancing:CreateTargetGroup\u0026#34; ], \u0026#34;Resource\u0026#34;: \u0026#34;*\u0026#34;, \u0026#34;Condition\u0026#34;: { \u0026#34;Null\u0026#34;: { \u0026#34;aws:RequestTag/elbv2.k8s.aws/cluster\u0026#34;: \u0026#34;false\u0026#34; } } }, { \u0026#34;Effect\u0026#34;: \u0026#34;Allow\u0026#34;, \u0026#34;Action\u0026#34;: [ \u0026#34;elasticloadbalancing:CreateListener\u0026#34;, \u0026#34;elasticloadbalancing:DeleteListener\u0026#34;, \u0026#34;elasticloadbalancing:CreateRule\u0026#34;, \u0026#34;elasticloadbalancing:DeleteRule\u0026#34; ], \u0026#34;Resource\u0026#34;: \u0026#34;*\u0026#34; }, { \u0026#34;Effect\u0026#34;: \u0026#34;Allow\u0026#34;, \u0026#34;Action\u0026#34;: [ \u0026#34;elasticloadbalancing:AddTags\u0026#34;, \u0026#34;elasticloadbalancing:RemoveTags\u0026#34; ], \u0026#34;Resource\u0026#34;: [ \u0026#34;arn:aws-cn:elasticloadbalancing:*:*:targetgroup/*/*\u0026#34;, \u0026#34;arn:aws-cn:elasticloadbalancing:*:*:loadbalancer/net/*/*\u0026#34;, \u0026#34;arn:aws-cn:elasticloadbalancing:*:*:loadbalancer/app/*/*\u0026#34; ], \u0026#34;Condition\u0026#34;: { \u0026#34;Null\u0026#34;: { \u0026#34;aws:RequestTag/elbv2.k8s.aws/cluster\u0026#34;: \u0026#34;true\u0026#34;, \u0026#34;aws:ResourceTag/elbv2.k8s.aws/cluster\u0026#34;: \u0026#34;false\u0026#34; } } }, { \u0026#34;Effect\u0026#34;: \u0026#34;Allow\u0026#34;, \u0026#34;Action\u0026#34;: [ \u0026#34;elasticloadbalancing:AddTags\u0026#34;, \u0026#34;elasticloadbalancing:RemoveTags\u0026#34; ], \u0026#34;Resource\u0026#34;: [ \u0026#34;arn:aws-cn:elasticloadbalancing:*:*:listener/net/*/*/*\u0026#34;, \u0026#34;arn:aws-cn:elasticloadbalancing:*:*:listener/app/*/*/*\u0026#34;, \u0026#34;arn:aws-cn:elasticloadbalancing:*:*:listener-rule/net/*/*/*\u0026#34;, \u0026#34;arn:aws-cn:elasticloadbalancing:*:*:listener-rule/app/*/*/*\u0026#34; ] }, { \u0026#34;Effect\u0026#34;: \u0026#34;Allow\u0026#34;, \u0026#34;Action\u0026#34;: [ \u0026#34;elasticloadbalancing:ModifyLoadBalancerAttributes\u0026#34;, \u0026#34;elasticloadbalancing:SetIpAddressType\u0026#34;, \u0026#34;elasticloadbalancing:SetSecurityGroups\u0026#34;, \u0026#34;elasticloadbalancing:SetSubnets\u0026#34;, \u0026#34;elasticloadbalancing:DeleteLoadBalancer\u0026#34;, \u0026#34;elasticloadbalancing:ModifyTargetGroup\u0026#34;, \u0026#34;elasticloadbalancing:ModifyTargetGroupAttributes\u0026#34;, \u0026#34;elasticloadbalancing:DeleteTargetGroup\u0026#34; ], \u0026#34;Resource\u0026#34;: \u0026#34;*\u0026#34;, \u0026#34;Condition\u0026#34;: { \u0026#34;Null\u0026#34;: { \u0026#34;aws:ResourceTag/elbv2.k8s.aws/cluster\u0026#34;: \u0026#34;false\u0026#34; } } }, { \u0026#34;Effect\u0026#34;: \u0026#34;Allow\u0026#34;, \u0026#34;Action\u0026#34;: [ \u0026#34;elasticloadbalancing:RegisterTargets\u0026#34;, \u0026#34;elasticloadbalancing:DeregisterTargets\u0026#34; ], \u0026#34;Resource\u0026#34;: \u0026#34;arn:aws-cn:elasticloadbalancing:*:*:targetgroup/*/*\u0026#34; }, { \u0026#34;Effect\u0026#34;: \u0026#34;Allow\u0026#34;, \u0026#34;Action\u0026#34;: [ \u0026#34;elasticloadbalancing:SetWebAcl\u0026#34;, \u0026#34;elasticloadbalancing:ModifyListener\u0026#34;, \u0026#34;elasticloadbalancing:AddListenerCertificates\u0026#34;, \u0026#34;elasticloadbalancing:RemoveListenerCertificates\u0026#34;, \u0026#34;elasticloadbalancing:ModifyRule\u0026#34; ], \u0026#34;Resource\u0026#34;: \u0026#34;*\u0026#34; } ] } èµ‹äºˆ EKS node æƒé™ åœ¨ è§’è‰² ä¸­æœç´¢ nodegrou-NodeInstanceRole æ‰¾åˆ°ä½ å¯¹åº”çš„ EKS é›†ç¾¤ å¦‚ä¸‹å›¾\nç„¶åç‚¹å‡»è¯¥è§’è‰²\u0026ndash; ç‚¹å‡»é™„åŠ ç­–ç•¥\nåœ¨æœç´¢æ¡†å†… è¾“å…¥åˆšæ‰åˆ›å»ºçš„ç­–ç•¥åç§° ç„¶åé€‰ä¸­ï¼Œç‚¹å‡»æœ€ä¸‹è¾¹çš„é™„åŠ ç­–ç•¥ã€‚\næˆ‘çš„ç­–ç•¥åç§°ä¸ºï¼šAWSLoadBalancerControllerIAMPolicy\nåœ¨ EKS ä¸­å®‰è£… AWS Load Balancer Controller å®‰è£…è¯ä¹¦ç®¡ç†å™¨ 1 kubectl apply --validate=false -f https://github.com/jetstack/cert-manager/releases/download/v1.5.3/cert-manager.yaml éƒ¨ç½² YAML ä¸‹è½½è´Ÿè½½å¹³è¡¡å™¨æ§åˆ¶å™¨çš„è§„èŒƒã€‚\n1 wget https://github.com/kubernetes-sigs/aws-load-balancer-controller/releases/download/v2.3.1/v2_3_1_full.yaml ç¼–è¾‘ä¿å­˜çš„ yaml æ–‡ä»¶ï¼Œè½¬åˆ°éƒ¨ç½²è§„èŒƒï¼Œå¹¶å°†æ§åˆ¶å™¨ \u0026ndash;cluster-name arg å€¼è®¾ç½®ä¸ºæ‚¨çš„ EKS é›†ç¾¤åç§°\n1 2 3 4 5 6 7 8 9 10 11 12 apiVersion: apps/v1 kind: Deployment . . . name: aws-load-balancer-controller namespace: kube-system spec: . . . template: spec: containers: - args: - --cluster-name=\u0026lt;INSERT_CLUSTER_NAME\u0026gt; å¦‚æœæ‚¨ä¸ºæœåŠ¡è´¦æˆ·ä½¿ç”¨ IAM è§’è‰²ï¼Œæˆ‘ä»¬å»ºè®®æ‚¨ä» yaml è§„èŒƒä¸­åˆ é™¤ ServiceAccountã€‚å¦‚æœæ‚¨ä» yaml è§„èŒƒä¸­åˆ é™¤å®‰è£…éƒ¨åˆ†ï¼Œè¿™å°†ä¿ç•™ eksctl åˆ›å»ºçš„ iamserviceaccountã€‚\n1 2 apiVersion: v1 kind: ServiceAccount åº”ç”¨ yaml æ–‡ä»¶\n1 kubectl apply -f v2_3_1_full.yaml éƒ¨ç½²ç¤ºä¾‹åº”ç”¨ç¨‹åº å°†æ¸¸æˆ 2048 éƒ¨ç½²ä¸ºç¤ºä¾‹åº”ç”¨ç¨‹åºï¼Œä»¥ç¡®è®¤ä½œä¸ºå…¥å£å¯¹è±¡çš„ç»“æœï¼ŒAmazonè´Ÿè½½å‡è¡¡å™¨æ§åˆ¶å™¨æ˜¯å¦ä¼šåˆ›å»º Amazon ALBã€‚\n1 kubectl apply -f https://raw.githubusercontent.com/kubernetes-sigs/aws-load-balancer-controller/v2.2.0/docs/examples/2048/2048_full.yaml å‡ åˆ†é’Ÿåï¼ŒéªŒè¯æ˜¯å¦å·²ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤åˆ›å»ºå…¥å£èµ„æºã€‚\n1 kubectl get ingress/ingress-2048 -n game-2048 è¾“å‡ºï¼š\n1 2 NAME CLASS HOSTS ADDRESS PORTS AGE ingress-2048 \u0026lt;none\u0026gt; * k8s-game2048-ingress2-xxxxxxxxxx-yyyyyyyyyy.cn-north-1.elb.amazonaws.com.cn 80 3h42m å¦‚æœåœ¨å‡ åˆ†é’Ÿåå°šæœªåˆ›å»ºå…¥å£ï¼Œè¯·è¿è¡Œä»¥ä¸‹å‘½ä»¤ä»¥æŸ¥çœ‹è´Ÿè½½å‡è¡¡å™¨æ§åˆ¶å™¨æ—¥å¿—ã€‚è¿™äº›æ—¥å¿—åŒ…å«å¯å¸®åŠ©æ‚¨è¯Šæ–­éƒ¨ç½²ä¸­ä»»ä½•é—®é¢˜çš„é”™è¯¯æ¶ˆæ¯ã€‚ 1 kubectl logs -n kube-system deployment.apps/aws-load-balancer-controller æ‰“å¼€æµè§ˆå™¨å¹¶ä»ä¸Šä¸€å‘½ä»¤è¾“å‡ºå¯¼èˆªåˆ° ADDRESS URL ä»¥æŸ¥çœ‹ç¤ºä¾‹åº”ç”¨ç¨‹åºã€‚å¦‚æœæ‚¨æ²¡æœ‰çœ‹åˆ°ä»»ä½•å†…å®¹ï¼Œè¯·ç­‰å¾…å‡ åˆ†é’Ÿï¼Œå¹¶åˆ·æ–°æ‚¨çš„æµè§ˆå™¨ã€‚\nä½œè€…ï¼šSREè¿ç»´åšå®¢\nåšå®¢åœ°å€ï¼šhttps://www.cnsre.cn/\næ–‡ç« åœ°å€ï¼šhttps://www.cnsre.cn/posts/211217431135/\nç›¸å…³è¯é¢˜ï¼šhttps://www.cnsre.cn/tags/aws/\n","description":"eks æ€ä¹ˆé…åˆalb ä½¿ç”¨ingress? ekså®‰è£…ç»‘å®šalb ingress.","id":10,"section":"posts","tags":["kubernetes","aws","eks","ingress","alb"],"title":"AWS eksç»‘å®šalb ä½¿ç”¨aws-load-balancer-controller(Ingress Controller)æä¾›æœåŠ¡","uri":"http://www.cnsre.cn:80/posts/211217431135/"},{"content":" ä½œè€…ï¼šSREè¿ç»´åšå®¢\nåšå®¢åœ°å€ï¼šhttps://www.cnsre.cn/\næ–‡ç« åœ°å€ï¼šhttps://www.cnsre.cn/posts/211213210004/\nç›¸å…³è¯é¢˜ï¼šhttps://www.cnsre.cn/tags/log4j/\nè¿‘æ—¥çš„Log4j2ï¼Œå¯æ˜¯éå¸¸çš„ç«å•Šï¼Œæˆ‘ä¹Ÿæ˜¯åŠ ç­åŠ ç‚¹æŠŠè¡¥ä¸ç»™æ‰“ä¸Šäº†æ¬¡å®‰å¿ƒã€‚Apache Log4j2å­˜åœ¨è¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´ï¼Œç»éªŒè¯ï¼Œè¯¥æ¼æ´å…è®¸æ”»å‡»è€…åœ¨ç›®æ ‡æœåŠ¡å™¨ä¸Šæ‰§è¡Œä»»æ„ä»£ç ï¼Œå¯å¯¼è‡´æœåŠ¡å™¨è¢«é»‘å®¢æ§åˆ¶ã€‚ç”±äºApache Log4j 2åº”ç”¨è¾ƒä¸ºå¹¿æ³›ï¼Œå»ºè®®ä½¿ç”¨è¯¥ç»„ä»¶çš„ç”¨æˆ·å°½å¿«é‡‡å–å®‰å…¨æªæ–½ã€‚\nå½±å“èŒƒå›´ æ¼æ´å½±å“ç‰ˆæœ¬ï¼š\n2.0 \u0026lt;= Apache Log4j 2 \u0026lt;= log4j-2.15.0-rc1\næ¼æ´æè¿° Apache Log4j 2æ˜¯ä¸€ä¸ªåŸºäºJavaçš„æ—¥å¿—è®°å½•å·¥å…·ï¼Œæ˜¯å¯¹ Log4j çš„å‡çº§ã€‚è¿‘æ—¥å®‰æ’ä¿¡æ¯åº”æ€¥å“åº”ä¸­å¿ƒç›‘æµ‹åˆ°Apache Log4j 2å­˜åœ¨è¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´ï¼Œæ”»å‡»è€…å¯é€šè¿‡æ„é€ æ¶æ„è¯·æ±‚åˆ©ç”¨è¯¥æ¼æ´å®ç°åœ¨ç›®æ ‡æœåŠ¡å™¨ä¸Šæ‰§è¡Œä»»æ„ä»£ç ã€‚\næ¼æ´ä¿®å¤ ç”±äºLog4j2 ä½œä¸ºæ—¥å¿—è®°å½•åŸºç¡€ç¬¬ä¸‰æ–¹åº“ï¼Œè¢«å¤§é‡Javaæ¡†æ¶åŠåº”ç”¨ä½¿ç”¨ï¼Œåªè¦ç”¨åˆ° Log4j2 è¿›è¡Œæ—¥å¿—è¾“å‡ºä¸”æ—¥å¿—å†…å®¹èƒ½è¢«æ”»å‡»è€…éƒ¨åˆ†å¯æ§ï¼Œå³å¯èƒ½ä¼šå—åˆ°æ¼æ´æ”»å‡»å½±å“ã€‚å› æ­¤ï¼Œè¯¥æ¼æ´ä¹ŸåŒæ—¶å½±å“å…¨çƒå¤§é‡é€šç”¨åº”ç”¨åŠç»„ä»¶ï¼Œä¾‹å¦‚ ï¼š\nApache Struts2ã€Apache Solrã€Apache Druidã€Apache Flinkã€Apache Flumeã€Apache Dubboã€Apache Kafkaã€Spring-boot-starter-log4j2ã€ElasticSearchã€Redisã€Logstashç­‰\nå»ºè®®åŠæ—¶æ£€æŸ¥å¹¶å‡çº§æ‰€æœ‰ä½¿ç”¨äº† Log4j ç»„ä»¶çš„ç³»ç»Ÿæˆ–åº”ç”¨ã€‚\nç´§æ€¥ï¼š ç›®å‰æ¼æ´POCå·²è¢«å…¬å¼€ï¼Œå®˜æ–¹å·²å‘å¸ƒå®‰å…¨ç‰ˆæœ¬ï¼Œå»ºè®®ä½¿ç”¨è¯¥ç»„ä»¶çš„ç”¨æˆ·å°½å¿«é‡‡å–å®‰å…¨æªæ–½ã€‚\nä¸´æ—¶æ€§ç¼“è§£æªæ–½ï¼š 1ã€åœ¨ jvm å‚æ•°ä¸­æ·»åŠ  -Dlog4j2.formatMsgNoLookups=true\n2ã€ç³»ç»Ÿç¯å¢ƒå˜é‡ä¸­å°†LOG4J_FORMAT_MSG_NO_LOOKUPS è®¾ç½®ä¸º true\n3ã€åˆ›å»º log4j2.component.properties æ–‡ä»¶ï¼Œæ–‡ä»¶ä¸­å¢åŠ é…ç½® log4j2.formatMsgNoLookups=true\n4ã€è‹¥ç›¸å…³ç”¨æˆ·æš‚æ—¶æ— æ³•è¿›è¡Œå‡çº§æ“ä½œï¼Œä¹Ÿå¯é€šè¿‡ç¦æ­¢Log4jä¸­SocketServerç±»æ‰€å¯ç”¨çš„socketç«¯å¯¹å…¬ç½‘å¼€æ”¾æ¥è¿›è¡Œé˜²æŠ¤\n5ã€ç¦æ­¢å®‰è£…log4jçš„æœåŠ¡å™¨è®¿é—®å¤–ç½‘ï¼Œå¹¶åœ¨è¾¹ç•Œå¯¹dnslogç›¸å…³åŸŸåè®¿é—®è¿›è¡Œæ£€æµ‹ã€‚éƒ¨åˆ†å…¬å…±dnslogå¹³å°å¦‚ä¸‹\nceye.io dnslog.link dnslog.cn dnslog.io tu4.org awvsscan119.autoverify.cn burpcollaborator.net s0x.cn å½»åº•ä¿®å¤æ¼æ´ï¼š å»ºè®®æ‚¨åœ¨å‡çº§å‰åšå¥½æ•°æ®å¤‡ä»½å·¥ä½œï¼Œé¿å…å‡ºç°æ„å¤–\nç ”å‘ä»£ç ä¿®å¤ï¼šå‡çº§åˆ°å®˜æ–¹æä¾›çš„ log4j-2.15.0-rc2 ç‰ˆæœ¬\nhttps://github.com/apache/logging-log4j2/releases/tag/log4j-2.15.1-rc1\næ¼æ´æ£€æµ‹å·¥å…· æ£€æµ‹å·¥å…·ä¸‹è½½åœ°å€ https://pan.cnsre.cn/d/Package/Linux/360log4j2.zip\næ¼æ´æ£€æµ‹ æµè§ˆå™¨è¢«åŠ¨å¼æ‰«ææ£€æµ‹æ–¹æ¡ˆ åŸç†\nå·¥ç¨‹å¸ˆå¯è®¾ç½®è¯¥ä»£ç†é€šè¿‡æµè§ˆå™¨è¢«åŠ¨æ‰«æç›®æ ‡ï¼ŒæŸ¥çœ‹ DNS Log æ£€æµ‹æ˜¯å¦å­˜åœ¨ log4j æ¼æ´ã€‚ ä½¿ç”¨æ–¹æ³•\n1.æµè§ˆå™¨æˆ–æ“ä½œç³»ç»Ÿé…ç½® HTTP/HTTPS ä»£ç†ï¼š219.141.219.69:18080 2.æµè§ˆå™¨æˆ–æ“ä½œç³»ç»Ÿå°†ä¸‹åˆ—è¯ä¹¦æ·»åŠ åˆ°ä¿¡ä»»åå•ï¼šé™„ä»¶sqli-hunter.pem\n3.ä½¿ç”¨æµè§ˆå™¨æ­£å¸¸è¿›è¡Œç›®æ ‡æµè§ˆï¼Œå½“ç»“æŸæ‰«æåï¼Œåœ¨http://219.141.219.69:18000/ ä¸‹æ£€æŸ¥æ˜¯å¦å­˜åœ¨ä»¥ç›®æ ‡åŸŸåä¸ºåçš„ txt æ–‡ä»¶ï¼Œå¦‚ http://219.141.219.69/360.cn.txt\n4.è‹¥å­˜åœ¨ï¼Œåˆ™è¯´æ˜ç›®æ ‡ç½‘ç«™å­˜åœ¨æ¼æ´ï¼Œç»†èŠ‚å¦‚ä¸‹ï¼š\nå¯çœ‹åˆ°å®Œæ•´ HTTP è¯·æ±‚ç»†èŠ‚ï¼Œparamså‚æ•°ä¸ºå­˜åœ¨ log4j æ³¨å…¥æ¼æ´çš„å‚æ•°\nä½¿ç”¨é™åˆ¶ ä¸»æœºå¤–ç½‘ IP æ— æ³•è®¿é—® 360 IPï¼Œè¯·ä¸è¦ä½¿ç”¨è¯¥ä»£ç†æ‰«æ 360 ç›®å‰åªèƒ½æ£€æµ‹ POST body ä¸­çš„å‚æ•° ä¸å…è®¸ä»»ä½•æ¶æ„æ”»å‡» æœ¬åœ°æ‰«æå¸¸è§„æ£€æµ‹æ–¹æ¡ˆ ä¸‹è½½æœ¬åœ°æ£€æµ‹å·¥å…·\næ‰«ææºç ï¼š./log4j-discoverer \u0026ndash;src\u0026quot;æºç ç›®å½•\u0026quot;\næ‰«æjaråŒ…ï¼š./log4j-discoverer\u0026ndash;jar \u0026ldquo;jaråŒ…æ–‡ä»¶\u0026rdquo;\næ‰«æç³»ç»Ÿè¿›ç¨‹ï¼š./log4j-discoverer â€“scan\nLog4jæ¼æ´è¡¥ä¸æ–¹æ¡ˆ å¦‚æœæ£€æµ‹åˆ°ç›¸å…³æ¼æ´çš„åº”ç”¨æˆ–ç»„ä»¶ï¼Œå»ºè®®ç«‹å³å¯¹è¯¥åº”ç”¨æˆ–ç»„ä»¶è¿›è¡Œæ‰“è¡¥ä¸ä¿®å¤ï¼Œ Log4jè¡¥ä¸æ–¹æ¡ˆå¦‚ä¸‹ï¼š\nå·¥å…·åŸç† Hookå‰å—åˆ°log4j jndiæ³¨å…¥æ”»å‡»\næ‰§è¡Œ java -jar PatchLog4j.jar\næ‰“å…¥è¡¥ä¸å log4jä¸å†å¤„ç†JNDIé€»è¾‘ç›´æ¥å°†JNDIå­—ç¬¦ä¸²è¾“å‡º\nå·¥å…·æ¥æºã€360æ”¿ä¼å®‰æœé«˜æ”»å®éªŒå®¤ã€‘\nä½œè€…ï¼šSREè¿ç»´åšå®¢\nåšå®¢åœ°å€ï¼šhttps://www.cnsre.cn/\næ–‡ç« åœ°å€ï¼šhttps://www.cnsre.cn/posts/211213210004/\nç›¸å…³è¯é¢˜ï¼šhttps://www.cnsre.cn/tags/log4j/\n","description":"Apache Log4j 2æ˜¯ä¸€ä¸ªåŸºäºJavaçš„æ—¥å¿—è®°å½•å·¥å…·ï¼Œæ˜¯å¯¹ Log4j çš„å‡çº§ã€‚è¿‘æ—¥å®‰æ’ä¿¡æ¯åº”æ€¥å“åº”ä¸­å¿ƒç›‘æµ‹åˆ°Apache Log4j 2å­˜åœ¨è¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´ï¼Œæ”»å‡»è€…å¯é€šè¿‡æ„é€ æ¶æ„è¯·æ±‚åˆ©ç”¨è¯¥æ¼æ´å®ç°åœ¨ç›®æ ‡æœåŠ¡å™¨ä¸Šæ‰§è¡Œä»»æ„ä»£ç ã€‚","id":11,"section":"posts","tags":["å®‰å…¨","log4j"],"title":"Log4j æ¼æ´ä¿®å¤æ£€æµ‹ é™„æ£€æµ‹å·¥å…·","uri":"http://www.cnsre.cn:80/posts/211213210004/"},{"content":" ä½œè€…ï¼šSREè¿ç»´åšå®¢\nåšå®¢åœ°å€ï¼š https://www.cnsre.cn/\næ–‡ç« åœ°å€ï¼šhttps://www.cnsre.cn/posts/211210952578/\nç›¸å…³è¯é¢˜ï¼šhttps://www.cnsre.cn/tags/kubernetes/\nkubecolor æ˜¯ä»€ä¹ˆï¼Ÿ kubecolor ä¸ºæ‚¨çš„kubectlå‘½ä»¤è¾“å‡ºç€è‰²ï¼Œä¸æ‰§è¡Œä»»ä½•å…¶ä»–æ“ä½œã€‚kubecolor åœ¨å†…éƒ¨è°ƒç”¨kubectlcommand å¹¶å°è¯•å¯¹è¾“å‡ºè¿›è¡Œç€è‰²ï¼Œä»¥ä¾¿ä½ å¯ä»¥ä½¿ç”¨ kubecolor ä½œä¸º kubectl çš„å®Œæ•´æ›¿ä»£æ–¹æ¡ˆã€‚\nkubecoloré¡¹ç›®åœ°å€\nå®‰è£… é€šè¿‡ GitHub å‘å¸ƒä¸‹è½½ git clone https://github.com/dty1er/kubecolor.git é€šè¿‡ go å‘½ä»¤æ‰‹åŠ¨æ„å»º cd kubecolor/ go build -o kubecolor cmd/kubecolor/main.go æ„å»ºåï¼Œå¾—åˆ°ä¸€ä¸ª kubecolor çš„æ–‡ä»¶\nè®¾ç½®é»˜è®¤ kubectl ä½¿ç”¨ kubecolor echo \u0026#34;alias kubectl=\u0026#39;/root/kubecolor/kubecolor\u0026#34; \u0026gt;\u0026gt; ~/.bashrc # ä½¿é…ç½®ç”Ÿæ•ˆ source .bashrc æ•ˆæœå±•ç¤º kubectl get pods\nkubectl describe\nä½œè€…ï¼šSREè¿ç»´åšå®¢\nåšå®¢åœ°å€ï¼š https://www.cnsre.cn/\næ–‡ç« åœ°å€ï¼šhttps://www.cnsre.cn/posts/211210952578/\nç›¸å…³è¯é¢˜ï¼šhttps://www.cnsre.cn/tags/kubernetes/\n","description":"kubecolor ä¸ºæ‚¨çš„kubectlå‘½ä»¤è¾“å‡ºç€è‰²ï¼Œä¸æ‰§è¡Œä»»ä½•å…¶ä»–æ“ä½œã€‚","id":12,"section":"posts","tags":["kubernetes","kubecolor"],"title":"kubectl å½©è‰²è¾“å‡º -- kubecolor","uri":"http://www.cnsre.cn:80/posts/211210952578/"},{"content":" ä½œè€…ï¼šSREè¿ç»´åšå®¢\nåšå®¢åœ°å€ï¼š https://www.cnsre.cn/\næ–‡ç« åœ°å€ï¼šhttps://www.cnsre.cn/posts/211208038353/\nç›¸å…³è¯é¢˜ï¼šhttps://www.cnsre.cn/tags/kubernetes/\nä¸€ã€kubernetes é›†ç¾¤æ¶æ„å›¾ äºŒã€Openshift or Kubernetes é›†ç¾¤æ¶æ„å›¾ ä¸‰ã€å¸¸è§çš„ CI/CD æ¶æ„å›¾ 1ã€Gitlab Webhook + Jenkins SharedLibraries/Kubernetes + SonarScanner Maven Plugin 2ã€Gitlab CI/CD Workflow 3ã€Logging 4ã€Loggingä¸Metrics åŸæ–‡å‡ºå¤„\nä½œè€…ï¼šSREè¿ç»´åšå®¢\nåšå®¢åœ°å€ï¼š https://www.cnsre.cn/\næ–‡ç« åœ°å€ï¼šhttps://www.cnsre.cn/posts/211208038353/\nç›¸å…³è¯é¢˜ï¼šhttps://www.cnsre.cn/tags/kubernetes/\n","description":"kubernetesç”Ÿæ€æ¶æ„å›¾ï¼Œdevopsæ¶æ„å›¾","id":13,"section":"posts","tags":["kubernetes"],"title":"kubernetesæ¶æ„å›¾","uri":"http://www.cnsre.cn:80/posts/211208038353/"},{"content":" ä½œè€…ï¼šSREè¿ç»´åšå®¢\nåšå®¢åœ°å€ï¼š https://www.cnsre.cn/\næ–‡ç« åœ°å€ï¼šhttps://www.cnsre.cn/posts/211206944174/\nç›¸å…³è¯é¢˜ï¼šhttps://www.cnsre.cn/tags/aws/\nä»€ä¹ˆæ˜¯ Amazon Elastic Container Registryï¼ˆECRï¼‰ï¼Ÿ Amazon Elastic Container Registry (Amazon ECR) æ˜¯ Amazon æ‰˜ç®¡å®¹å™¨æ˜ åƒæ³¨å†Œè¡¨æœåŠ¡ï¼Œå®ƒå®‰å…¨ã€å¯æ‰©å±•ä¸”å¯é ã€‚Amazon ECR æ”¯æŒç§æœ‰å­˜å‚¨åº“ï¼Œå…¶å…·æœ‰ä½¿ç”¨ Amazon IAM çš„åŸºäºèµ„æºçš„æƒé™ã€‚è¿™æ ·ï¼ŒæŒ‡å®šç”¨æˆ·æˆ– Amazon EC2 å®ä¾‹å¯ä»¥è®¿é—®æ‚¨çš„å®¹å™¨å­˜å‚¨åº“å’Œæ˜ åƒã€‚æ‚¨å¯ä»¥ä½¿ç”¨é¦–é€‰ CLI æ¨é€ã€æå–å’Œç®¡ç† Docker æ˜ åƒã€Open Container Itistry (OCI) æ˜ åƒå’Œ OCI å…¼å®¹æ„ä»¶ã€‚\nAmazon ECR çš„åŠŸèƒ½ Amazon ECR æä¾›ä»¥ä¸‹åŠŸèƒ½ï¼š\nç”Ÿå‘½å‘¨æœŸç­–ç•¥æœ‰åŠ©äºç®¡ç†å­˜å‚¨åº“ä¸­æ˜ åƒçš„ç”Ÿå‘½å‘¨æœŸã€‚æ‚¨å¯ä»¥å®šä¹‰å¯¼è‡´æ¸…ç†æœªä½¿ç”¨æ˜ åƒçš„è§„åˆ™ã€‚æ‚¨å¯ä»¥åœ¨å°†è§„åˆ™åº”ç”¨åˆ°å­˜å‚¨åº“ä¹‹å‰å¯¹å…¶è¿›è¡Œæµ‹è¯•ã€‚æœ‰å…³æ›´å¤šä¿¡æ¯ï¼Œè¯·å‚é˜… ç”Ÿå‘½å‘¨æœŸç­–ç•¥ã€‚ æ˜ åƒæ‰«ææœ‰åŠ©äºè¯†åˆ«å®¹å™¨æ˜ åƒä¸­çš„è½¯ä»¶æ¼æ´ã€‚æ¯ä¸ªå­˜å‚¨åº“éƒ½å¯ä»¥é…ç½®ä¸ºåœ¨æ¨é€æ—¶æ‰«æã€‚è¿™å¯ç¡®ä¿æ‰«ææ¨é€åˆ°å­˜å‚¨åº“çš„æ¯ä¸ªæ–°æ˜ åƒã€‚ç„¶åï¼Œæ‚¨å¯ä»¥æ£€ç´¢æ˜ åƒæ‰«æçš„ç»“æœã€‚æœ‰å…³æ›´å¤šä¿¡æ¯ï¼Œè¯·å‚é˜… æ˜ åƒæ‰«æã€‚ è·¨åŒºåŸŸå’Œè·¨è´¦æˆ·å¤åˆ¶ä½¿æ‚¨å¯ä»¥æ›´è½»æ¾åœ°å°†æ˜ åƒæ”¾ç½®åœ¨éœ€è¦çš„ä½ç½®ã€‚å®ƒé…ç½®ä¸ºæ³¨å†Œè¡¨è®¾ç½®ï¼Œå¹¶åŸºäºæ¯ä¸ªåŒºåŸŸã€‚æœ‰å…³æ›´å¤šä¿¡æ¯ï¼Œè¯·å‚é˜… ç§æœ‰æ³¨å†Œè¡¨è®¾ç½®ã€‚ æ¨é€ Docker æ˜ åƒåˆ° Amazon ECR å­˜å‚¨åº“ æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ docker push å‘½ä»¤å°†å®¹å™¨æ˜ åƒæ¨é€åˆ° Amazon ECR å­˜å‚¨åº“ã€‚Amazon ECR è¿˜æ”¯æŒåˆ›å»ºå’Œæ¨é€ç”¨äºå¤šæ¶æ„æ˜ åƒçš„ Docker æ¸…å•åˆ—è¡¨ã€‚æ¸…å•åˆ—è¡¨ä¸­å¼•ç”¨çš„æ¯ä¸ªæ˜ åƒéƒ½å¿…é¡»å·²ç»è¢«æ¨é€åˆ°æˆ‘ä»¬çš„å­˜å‚¨åº“ã€‚\nåœ¨æ¨é€æ˜ åƒä¹‹å‰ï¼ŒAmazon ECR å­˜å‚¨åº“å¿…é¡»å­˜åœ¨ã€‚ å‘è¦å‘å…¶æ¨é€æ˜ åƒçš„ Amazon ECR æ³¨å†Œè¡¨éªŒè¯ Docker å®¢æˆ·ç«¯çš„èº«ä»½ã€‚å¿…é¡»é’ˆå¯¹æ¯ä¸ªæ³¨å†Œè¡¨è·å¾—æˆæƒä»¤ç‰Œï¼Œä»¤ç‰Œæœ‰æ•ˆæœŸä¸º 12 å°æ—¶ã€‚\nè¦å¯¹ Amazon ECR æ³¨å†Œè¡¨éªŒè¯ Dockerï¼Œè¯·è¿è¡Œ aws ecr get-login-password å‘½ä»¤ã€‚å°†èº«ä»½éªŒè¯ä»¤ç‰Œä¼ é€’ç»™ docker login å‘½ä»¤æ—¶ï¼Œå°†å€¼ AWS ç”¨ä½œç”¨æˆ·åï¼Œå¹¶æŒ‡å®šè¦å¯¹å…¶è¿›è¡Œèº«ä»½éªŒè¯çš„ Amazon ECR æ³¨å†Œè¡¨ URIã€‚å¦‚æœå¯¹å¤šä¸ªæ³¨å†Œè¡¨è¿›è¡Œèº«ä»½éªŒè¯ï¼Œåˆ™å¿…é¡»é’ˆå¯¹æ¯ä¸ªæ³¨å†Œè¡¨é‡å¤è¯¥å‘½ä»¤ã€‚\nå¦‚æœæ”¶åˆ°é”™è¯¯ï¼Œè¯·å®‰è£…æˆ–æ›´æ–°åˆ°æœ€æ–°ç‰ˆæœ¬çš„ Amazon CLIã€‚æœ‰å…³æ›´å¤šä¿¡æ¯ï¼Œè¯·å‚é˜… Amazon Command Line Interface ç”¨æˆ·æŒ‡å—ä¸­çš„å®‰è£… Amazon Command Line Interfaceã€‚ æ£€ç´¢èº«ä»½éªŒè¯ä»¤ç‰Œå¹¶å‘æ³¨å†Œè¡¨éªŒè¯ Docker å®¢æˆ·ç«¯èº«ä»½ã€‚ ä½¿ç”¨ äºšé©¬é€Šäº‘ç§‘æŠ€ CLI:\naws ecr get-login-password --region cn-north-1 | docker login --username AWS --password-stdin 12345678.dkr.ecr.cn-north-1.amazonaws.com.cn å¦‚æœæ‚¨åœ¨ä½¿ç”¨ äºšé©¬é€Šäº‘ç§‘æŠ€ CLI æ—¶é‡åˆ°é”™è¯¯ï¼Œè¯·ç¡®ä¿æ‚¨å·²å®‰è£…æœ€æ–°ç‰ˆæœ¬çš„ äºšé©¬é€Šäº‘ç§‘æŠ€ CLI å’Œ Dockerã€‚ æ„å»º Docker æ˜ åƒ å¦‚æœæ‚¨å·²ç”Ÿæˆæ˜ åƒï¼Œåˆ™å¯è·³è¿‡æ­¤æ­¥éª¤:\ndocker build -t cnsre-test . æ ‡è®°æ˜ åƒ ç”Ÿæˆå®Œæˆåï¼Œæ ‡è®°æ‚¨çš„æ˜ åƒï¼Œä»¥ä¾¿å°†æ˜ åƒæ¨é€åˆ°æ­¤å­˜å‚¨åº“:\ndocker tag cnsre-test:latest 12345678.dkr.ecr.cn-north-1.amazonaws.com.cn/cnsre-test:latest æ¨é€é•œåƒ è¿è¡Œä»¥ä¸‹å‘½ä»¤å°†æ­¤æ˜ åƒæ¨é€åˆ°æ–°åˆ›å»ºçš„ äºšé©¬é€Šäº‘ç§‘æŠ€ å­˜å‚¨åº“:\ndocker push 12345678.dkr.ecr.cn-north-1.amazonaws.com.cn/cnsre-test:latest å‡ºç° Head https://registry-1.docker.io/v2/library/node/manifests/14-alpine çš„è§£å†³æ–¹æ³• vim /etc/docker/daemon.json # æ·»åŠ å›½å†…çš„é•œåƒ é˜¿é‡Œäº‘é•œåƒ { \u0026#34;registry-mirrors\u0026#34;:[\u0026#34;https://6kx4zyno.mirror.aliyuncs.com\u0026#34;] } # æˆ–è€…ä¸­ç§‘é™¢é•œåƒ \u0026#34;registry-mirrors\u0026#34;:[\u0026#34;https://docker.mirrors.ustc.edu.cn\u0026#34;] } é‡å¯Docker\nsystemctl daemon-reload systemctl restart docker æ‹‰å–é•œåƒ ä½¿ç”¨ docker pull å‘½ä»¤æå–æ˜ åƒã€‚æ˜ åƒåç§°æ ¼å¼åº”ä¸º registry/repository[:tag] ä»¥ä¾¿æŒ‰æ ‡ç­¾æ‹‰å–ï¼Œæˆ–ä¸º registry/repository[@digest] ä»¥ä¾¿æŒ‰æ‘˜è¦æ‹‰å–ã€‚\ndocker pull 12345678.dkr.ecr.cn-north-1.amazonaws.com.cn/cnsre-test:latest å¦‚æœæ‚¨æ”¶åˆ° repository-url not found: does not exist or no pull access é”™è¯¯ï¼Œæ‚¨å¯èƒ½éœ€è¦å‘ Amazon ECR éªŒè¯æ‚¨çš„ Docker å®¢æˆ·ç«¯ã€‚æœ‰å…³æ›´å¤šä¿¡æ¯ï¼Œè¯·å‚é˜… ç§æœ‰æ³¨å†Œè¡¨èº«ä»½éªŒè¯ã€‚ ä½œè€…ï¼šSREè¿ç»´åšå®¢\nåšå®¢åœ°å€ï¼š https://www.cnsre.cn/\næ–‡ç« åœ°å€ï¼šhttps://www.cnsre.cn/posts/211206944174/\nç›¸å…³è¯é¢˜ï¼šhttps://www.cnsre.cn/tags/aws/\n","description":"æœ¬æ–‡å­¦ä¹ ç›®æ ‡æ˜¯äº†è§£aws ECRä»“åº“ï¼Œå¹¶å­¦ä¼šAWSç§æœ‰ä»“åº“ECRçš„é•œåƒæ¨é€å’Œæ‹‰å–ã€‚","id":14,"section":"posts","tags":["aws","ecr","docker"],"title":"AWSç§æœ‰ä»“åº“ECRæ¨é€æ‹‰å–é•œåƒ","uri":"http://www.cnsre.cn:80/posts/211206944174/"},{"content":" ä½œè€…ï¼šSREè¿ç»´åšå®¢\nåšå®¢åœ°å€ï¼š https://www.cnsre.cn/\næ–‡ç« åœ°å€ï¼šhttps://www.cnsre.cn/posts/211203931498/\nç›¸å…³è¯é¢˜ï¼šhttps://www.cnsre.cn/tags/aws/\nå› ä¸ºåˆ›å»º Amazon EKS é›†ç¾¤æ—¶ï¼ŒIAM ç”¨æˆ·æˆ–è§’è‰²ä¼šè‡ªåŠ¨åœ¨é›†ç¾¤çš„ RBAC é…ç½®ä¸­è¢«æˆäºˆ system:masters æƒé™ã€‚ä¾‹å¦‚ï¼ŒIAM ç”¨æˆ·æˆ–è§’è‰²å¯ä»¥æ˜¯åˆ›å»ºé›†ç¾¤çš„è”åˆèº«ä»½ç”¨æˆ·ã€‚å¦‚æœä½¿ç”¨ä¸å±äº aws-auth ConfigMap çš„ IAM ç”¨æˆ·æˆ–è§’è‰²è®¿é—® Amazon EKS æ§åˆ¶å°ï¼Œåˆ™æ— æ³•çœ‹åˆ° Kubernetes å·¥ä½œè´Ÿè½½ã€‚ä¹Ÿä¸ä¼šçœ‹åˆ°é›†ç¾¤çš„æ¦‚è§ˆè¯¦ç»†ä¿¡æ¯ã€‚æ‰€ä»¥è¦å‘å…¶ä»– AWS ç”¨æˆ·æˆ–è§’è‰²æˆäºˆä¸é›†ç¾¤äº¤äº’çš„èƒ½åŠ›ï¼Œæ‚¨å¿…é¡»åœ¨ Kubernetes ä¸­ç¼–è¾‘ aws-auth ConfigMapã€‚\nå› ä¸ºéƒ¨é—¨æœ‰ä¸é€šçš„è§’è‰²ï¼Œæ‰€ä»¥æƒ³åŸºäºä¸é€šçš„è§’è‰²åˆ†é…ä¸åŒçš„æƒé™ï¼Œä¸‹é¢æ˜¯è®°å½•æ·»åŠ ä¸€ä¸ªå¯¹ EKS åªæœ‰åªè¯»æƒé™çš„ AIM ç”¨æˆ·ã€‚\nå¦‚æœæ‚¨åœ¨è¿è¡Œ AWS å‘½ä»¤è¡Œç•Œé¢ (AWS CLI) å‘½ä»¤æ—¶é‡åˆ°é”™è¯¯ï¼Œè¯·ç¡®ä¿æ‚¨ä½¿ç”¨çš„æ˜¯æœ€æ–°ç‰ˆçš„ AWS CLIã€‚ ä¸º IAM ç”¨æˆ·æˆ–è§’è‰²é…ç½®æƒé™ è¦æŸ¥æ‰¾å…·æœ‰ä¸»è¦é›†ç¾¤é…ç½®æƒé™çš„é›†ç¾¤åˆ›å»ºè€…æˆ–ç®¡ç†å‘˜è§’è‰²ï¼Œè¯·åœ¨ AWS CloudTrail ä¸­æœç´¢ CreateCluster API è°ƒç”¨ã€‚ç„¶åï¼Œæ£€æŸ¥æ­¤ API è°ƒç”¨çš„ UserIdentity éƒ¨åˆ†ã€‚ è¯†åˆ«éœ€è¦æƒé™çš„ IAM ç”¨æˆ·æˆ–è§’è‰²ã€‚ ç¡®è®¤å·²è¯†åˆ«çš„ IAM ç”¨æˆ·æˆ–è§’è‰²æœ‰æƒåœ¨ AWS ç®¡ç†æ§åˆ¶å°ä¸­æŸ¥çœ‹æ‰€æœ‰é›†ç¾¤çš„èŠ‚ç‚¹å’Œå·¥ä½œè´Ÿè½½ã€‚ ä½¿ç”¨ aws-auth ConfigMap å°† IAM ç”¨æˆ·æˆ–è§’è‰²æ˜ å°„åˆ° RBAC è§’è‰²å’Œç»„ åœ¨è¿æ¥ Amazon EKS API æœåŠ¡å™¨ä¹‹å‰ï¼Œå®‰è£…å¹¶é…ç½®æœ€æ–°ç‰ˆæœ¬çš„ AWS CLIã€‚ è·å– AWS CLI ç”¨æˆ·æˆ–è§’è‰²çš„é…ç½®ï¼š\naws sts get-caller-identity è¾“å‡ºå°†è¿”å› IAM ç”¨æˆ·æˆ–è§’è‰²çš„ Amazon èµ„æºåç§° (ARN)ã€‚ä¾‹å¦‚ï¼š\n{ \u0026#34;UserId\u0026#34;: \u0026#34;XXXXXXXXXXXXXXXXXXXXX\u0026#34;, \u0026#34;Account\u0026#34;: \u0026#34;XXXXXXXXXXXX\u0026#34;, \u0026#34;Arn\u0026#34;: \u0026#34;arn:aws:iam::XXXXXXXXXXXX:user/testuser\u0026#34; } ç¡®è®¤ ARN ä¸å…·æœ‰ä¸»è¦é›†ç¾¤é…ç½®è®¿é—®æƒé™çš„é›†ç¾¤åˆ›å»ºè€…æˆ–ç®¡ç†å‘˜ç›¸åŒ¹é…ã€‚å¦‚æœ ARN ä¸é›†ç¾¤åˆ›å»ºè€…æˆ–ç®¡ç†å‘˜ä¸åŒ¹é…ï¼Œè¯·è”ç³»é›†ç¾¤åˆ›å»ºè€… aws-auth ConfigMapã€‚\næ·»åŠ å¯¹ EKS é›†ç¾¤å…·æœ‰åªè¯»è®¿é—®æƒé™çš„ IAM ç”¨æˆ· è¦å…è®¸è¶…çº§ç”¨æˆ·è®¿é—®æƒé™ä»¥å¯¹ä»»ä½•èµ„æºæ‰§è¡Œä»»ä½•æ“ä½œï¼Œè¯·æ·»åŠ  system:masters è€Œé system:bootstrappers å’Œ system:nodesã€‚æœ‰å…³æ›´å¤šä¿¡æ¯ï¼Œè¯·å‚é˜… Kubernetes ç½‘ç«™ä¸Šçš„é»˜è®¤è§’è‰²å’Œè§’è‰²ç»‘å®šã€‚ åˆ›å»º rbac.yaml\n--- apiVersion: rbac.authorization.k8s.io/v1 kind: ClusterRole metadata: name: reader rules: - apiGroups: [\u0026#34;*\u0026#34;] resources: [\u0026#34;deployments\u0026#34;, \u0026#34;configmaps\u0026#34;, \u0026#34;pods\u0026#34;, \u0026#34;secrets\u0026#34;, \u0026#34;services\u0026#34;] verbs: [\u0026#34;get\u0026#34;, \u0026#34;list\u0026#34;, \u0026#34;watch\u0026#34;] --- apiVersion: rbac.authorization.k8s.io/v1 kind: ClusterRoleBinding metadata: name: reader subjects: - kind: Group name: reader apiGroup: rbac.authorization.k8s.io roleRef: kind: ClusterRole name: reader apiGroup: rbac.authorization.k8s.io è¦æ·»åŠ  IAM ç”¨æˆ·æˆ–è§’è‰²ï¼Œè¯·å®Œæˆä»¥ä¸‹æ­¥éª¤ä¹‹ä¸€ã€‚\næ·»åŠ  IAM ç”¨æˆ·åˆ° mapUsersã€‚\n... mapUsers: | - userarn: arn:aws:iam::424432388155:user/developer username: developer groups: - reader ... åˆ›å»º RBAC\nkubectl apply -f rbac.yaml åœ¨AWS ä¸­åˆ›å»º AmazonEKSDeveloperPolicy ç­–ç•¥ä»¥è®©ç”¨æˆ·åœ¨ AWS ç®¡ç†æ§åˆ¶å°ä¸­æŸ¥çœ‹æ‰€æœ‰é›†ç¾¤çš„èŠ‚ç‚¹å’Œå·¥ä½œè´Ÿè½½\n{ \u0026#34;Version\u0026#34;: \u0026#34;2012-10-17\u0026#34;, \u0026#34;Statement\u0026#34;: [ { \u0026#34;Effect\u0026#34;: \u0026#34;Allow\u0026#34;, \u0026#34;Action\u0026#34;: [ \u0026#34;eks:DescribeNodegroup\u0026#34;, \u0026#34;eks:ListNodegroups\u0026#34;, \u0026#34;eks:DescribeCluster\u0026#34;, \u0026#34;eks:ListClusters\u0026#34;, \u0026#34;eks:AccessKubernetesApi\u0026#34;, \u0026#34;ssm:GetParameter\u0026#34;, \u0026#34;eks:ListUpdates\u0026#34;, \u0026#34;eks:ListFargateProfiles\u0026#34; ], \u0026#34;Resource\u0026#34;: \u0026#34;*\u0026#34; } ] } åˆ›å»ºeks-developerIAM ç»„å¹¶é™„åŠ AmazonEKSDeveloperPolicyç­–ç•¥ åˆ›å»ºdeveloperç”¨æˆ· æ·»åŠ developerä¸ªäººèµ„æ–™aws configure --profile developer æ·»åŠ åˆ°aws-authconfigmapdeveloperç”¨æˆ· ARNã€‚ kubectl edit -n kube-system configmap/aws-auth ... mapUsers: | - userarn: arn:aws:iam::424432388155:user/developer username: developer groups: - reader ... ä¸ºdeveloperç”¨æˆ·é…ç½® kubectl ä¸Šä¸‹æ–‡ 1 aws eks --region us-east-1 update-kubeconfig --name eks --profile developer æ£€æŸ¥ kubeconfig 1 kubectl config view --minify æ£€æŸ¥æƒé™ 1 2 3 kubectl auth can-i get pods kubectl auth can-i create pods kubectl run nginx --image=nginx åˆ›å»ºå…·æœ‰ç®¡ç†å‘˜è®¿é—®æƒé™çš„ IAM è§’è‰²å¹¶ç”± IAM ç”¨æˆ·ä»£å…¥æ­¤è§’è‰²ã€‚ åˆ›å»ºAmazonEKSAdminPolicyç­–ç•¥ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 { \u0026#34;Version\u0026#34;: \u0026#34;2012-10-17\u0026#34;, \u0026#34;Statement\u0026#34;: [ { \u0026#34;Effect\u0026#34;: \u0026#34;Allow\u0026#34;, \u0026#34;Action\u0026#34;: [ \u0026#34;eks:*\u0026#34; ], \u0026#34;Resource\u0026#34;: \u0026#34;*\u0026#34; }, { \u0026#34;Effect\u0026#34;: \u0026#34;Allow\u0026#34;, \u0026#34;Action\u0026#34;: \u0026#34;iam:PassRole\u0026#34;, \u0026#34;Resource\u0026#34;: \u0026#34;*\u0026#34;, \u0026#34;Condition\u0026#34;: { \u0026#34;StringEquals\u0026#34;: { \u0026#34;iam:PassedToService\u0026#34;: \u0026#34;eks.amazonaws.com\u0026#34; } } } ] } åˆ›å»ºeks-adminè§’è‰²å¹¶é™„åŠ AmazonEKSAdminPolicyç­–ç•¥ æè¿°eks-adminè§’è‰² 1 aws iam get-role --profile terraform --role-name eks-admin åˆ›å»ºAmazonEKSAssumePolicyå…è®¸æ‰¿æ‹…è§’è‰²çš„ç­–ç•¥ 1 2 3 4 5 6 7 8 9 10 11 12 { \u0026#34;Version\u0026#34;: \u0026#34;2012-10-17\u0026#34;, \u0026#34;Statement\u0026#34;: [ { \u0026#34;Effect\u0026#34;: \u0026#34;Allow\u0026#34;, \u0026#34;Action\u0026#34;: [ \u0026#34;sts:AssumeRole\u0026#34; ], \u0026#34;Resource\u0026#34;: \u0026#34;arn:aws:iam::424432388155:role/eks-admin\u0026#34; } ] } åˆ›å»ºmanagerç”¨æˆ·ä»¥ä½¿ç”¨eks-adminè§’è‰² æ·»åŠ managerä¸ªäººèµ„æ–™aws configure --profile manager æ£€æŸ¥managerç”¨æˆ·æ˜¯å¦å¯ä»¥æ‰¿æ‹…eks-adminè§’è‰² 1 aws sts assume-role --role-arn arn:aws:iam::424432388155:role/eks-admin --role-session-name manager-session --profile manager ä¸ºåˆ›å»º EKS é›†ç¾¤çš„ç”¨æˆ·æ›´æ–° kubeconfig 1 aws eks --region us-east-1 update-kubeconfig --name eks --profile terraform æ·»åŠ åˆ°aws-authconfigmapeks-adminè§’è‰² ARNã€‚ 1 2 3 4 5 6 7 kubectl edit -n kube-system configmap/aws-auth ... - rolearn: arn:aws:iam::424432388155:role/eks-admin username: eks-admin groups: - system:masters ... åˆ›å»ºeks-adminé…ç½®æ–‡ä»¶ä»¥æ‰¿æ‹…è§’è‰²vim ~/.aws/config [profile eks-admin] role_arn = arn:aws:iam::424432388155:role/eks-admin source_profile = manager ä¸ºmanagerç”¨æˆ·é…ç½® kubectl ä¸Šä¸‹æ–‡ä»¥è‡ªåŠ¨æ‰¿æ‹…eks-adminè§’è‰² 1 aws eks --region us-east-1 update-kubeconfig --name eks --profile eks-admin æ£€æŸ¥ kubeconfig 1 kubectl config view --minify æ£€æŸ¥ç»ç†æ˜¯å¦å…·æœ‰ EKS é›†ç¾¤çš„ç®¡ç†å‘˜è®¿é—®æƒé™ 1 kubectl auth can-i \u0026#34;*\u0026#34; \u0026#34;*\u0026#34; ä½œè€…ï¼šSREè¿ç»´åšå®¢\nåšå®¢åœ°å€ï¼š https://www.cnsre.cn/\næ–‡ç« åœ°å€ï¼šhttps://www.cnsre.cn/posts/211203931498/\nç›¸å…³è¯é¢˜ï¼šhttps://www.cnsre.cn/tags/aws/\n","description":"æ·»åŠ å¯¹ EKS é›†ç¾¤å…·æœ‰åªè¯»è®¿é—®æƒé™çš„ IAM ç”¨æˆ·,æ·»åŠ å…·æœ‰æ ¹è®¿é—®æƒé™çš„ IAM è§’è‰²å¹¶ç”± IAM ç”¨æˆ·ä»£å…¥æ­¤è§’è‰²","id":15,"section":"posts","tags":["aws","eks","kubernetes"],"title":"AWS  EKS æ·»åŠ IAMç”¨æˆ·è§’è‰²","uri":"http://www.cnsre.cn:80/posts/211203931498/"},{"content":" ä½œè€…ï¼šSREè¿ç»´åšå®¢\nåšå®¢åœ°å€ï¼š https://www.cnsre.cn/\næ–‡ç« åœ°å€ï¼šhttps://www.cnsre.cn/posts/211201955418/\nç›¸å…³è¯é¢˜ï¼šhttps://www.cnsre.cn/tags/split/\n1. åˆ†å‰²æ–‡ä»¶ æ–‡ä»¶åˆ†å‰²å¯ä»¥ä½¿ç”¨splitå‘½ä»¤ï¼Œè¯¥å³æ”¯æŒæ–‡æœ¬æ–‡ä»¶åˆ†å‰²ï¼Œåˆæ”¯æŒäºŒè¿›åˆ¶æ–‡ä»¶åˆ†å‰²ï¼›è€Œåˆå¹¶æ–‡ä»¶å¯ä»¥ä½¿ç”¨catå‘½ä»¤ã€‚\n1.1 æ–‡æœ¬æ–‡ä»¶åˆ†å‰² åˆ†å‰²æ–‡æœ¬æ–‡ä»¶æ—¶ï¼Œå¯ä»¥æŒ‰æ–‡ä»¶å¤§å°åˆ†å‰²ï¼Œä¹Ÿå¯ä»¥æŒ‰æ–‡æœ¬è¡Œæ•°åˆ†å‰²ã€‚\næŒ‰æ–‡ä»¶å¤§å°åˆ†å‰²\næŒ‰æ–‡ä»¶å¤§å°åˆ†å‰²æ–‡ä»¶æ—¶ï¼Œéœ€è¦ä»¥-Cå‚æ•°æŒ‡å®šåˆ†å‰²åçš„æ–‡ä»¶å¤§å°ï¼š\n$ split -C 100M large_file.txt stxt å¦‚ä¸Šæ‰€ç¤ºï¼Œæˆ‘ä»¬å°†å¤§æ–‡ä»¶large_file.txtæŒ‰100Må¤§å°è¿›è¡Œåˆ†å‰²ï¼Œå¹¶æŒ‡å®šäº†åˆ†å‰²åæ–‡ä»¶å‰ç¼€stxtï¼›å½“ä¸æŒ‡å®šå‰ç¼€æ—¶ï¼Œsplitä¼šè‡ªåŠ¨å¯¹åˆ†å‰²æ–‡ä»¶è¿›è¡Œå‘½åï¼Œä¸€èˆ¬ä¼šä»¥xå¼€å¤´ã€‚\næŒ‰è¡Œåˆ†å‰²\næ–‡æœ¬æ–‡ä»¶è¿˜å¯ä»¥ä»¥è¡Œä¸ºå•ä½è¿›è¡Œåˆ†å‰²ï¼Œä»¥è¡Œæ•°è¿›è¡Œåˆ†å‰²æ—¶ä¼šå¿½ç•¥æ–‡ä»¶å¤§å°ï¼Œå¹¶ä»¥-lå‚æ•°æŒ‡å®šåˆ†å‰²åæ–‡ä»¶çš„è¡Œæ•°ï¼š\n$ split -l 1000 large_file.txt stxt 1.2 äºŒè¿›åˆ¶æ–‡ä»¶åˆ†å‰² äºŒè¿›åˆ¶æ–‡ä»¶åˆ†å‰²ç±»ä¼¼äºæŒ‰å¤§å°åˆ†å‰²æ–‡æœ¬æ–‡ä»¶ï¼Œä¸åŒçš„æ˜¯ä»¥-bå‚æ•°æ¥æŒ‡å®šåˆ†å‰²åçš„æ–‡ä»¶å¤§å°ï¼š\n$ split -b 100M data.bak sdata 2. æ–‡ä»¶åˆå¹¶ æ–‡ä»¶åˆå¹¶ä½¿ç”¨catå‘½ä»¤ï¼Œä¸Šé¢å‡ ç§æ–¹å¼åˆ†å‰²çš„æ–‡ä»¶éƒ½å¯ä»¥ä½¿ç”¨catå‘½ä»¤åˆå¹¶ã€‚\ncatå‘½ä»¤åˆå¹¶åˆ†å‰²æ–‡ä»¶ï¼š\n$ cat stxt* \u0026gt; new_file.txt 3. å‘½ä»¤æ ¼å¼ 3.1 splitå‘½ä»¤è¯´æ˜ splitå‘½ä»¤æ ¼å¼å¦‚ä¸‹ï¼š\nsplit [é€‰é¡¹]... [è¦åˆ‡å‰²çš„æ–‡ä»¶ [è¾“å‡ºæ–‡ä»¶å‰ç¼€]] å‘½ä»¤å‚æ•°\n-a, --suffix-length=N ä½¿ç”¨é•¿åº¦ä¸º N çš„åç¼€ (é»˜è®¤ 2) -b, --bytes=SIZE è®¾ç½®è¾“å‡ºæ–‡ä»¶çš„å¤§å°ã€‚æ”¯æŒå•ä½ï¼šm,k -C, --line-bytes=SIZE è®¾ç½®è¾“å‡ºæ–‡ä»¶çš„æœ€å¤§è¡Œæ•°ã€‚ä¸ -b ç±»ä¼¼ï¼Œä½†ä¼šå°½é‡ç»´æŒæ¯è¡Œçš„å®Œæ•´æ€§ -d, --numeric-suffixes ä½¿ç”¨æ•°å­—åç¼€ä»£æ›¿å­—æ¯ -l, --lines=NUMBER è®¾å¤‡è¾“å‡ºæ–‡ä»¶çš„è¡Œæ•° --help æ˜¾ç¤ºç‰ˆæœ¬ä¿¡æ¯ --version è¾“å‡ºç‰ˆæœ¬ä¿¡æ¯ 3.2 catå‘½ä»¤è¯´æ˜ catå‘½ä»¤çš„å¸¸è§ä½¿ç”¨åœºæ™¯æœ‰ï¼š\næ˜¾ç¤ºæ–‡ä»¶å†…å®¹ï¼š\n$ cat filename åˆ›å»ºä¸€ä¸ªç©ºæ–‡ä»¶ï¼š\n$ cat \u0026gt; filename æ–‡ä»¶åˆå¹¶ï¼š\n$ cat file1 file2 \u0026gt; file ä½œè€…ï¼šSREè¿ç»´åšå®¢\nåšå®¢åœ°å€ï¼š https://www.cnsre.cn/\næ–‡ç« åœ°å€ï¼šhttps://www.cnsre.cn/posts/211201955418/\nç›¸å…³è¯é¢˜ï¼šhttps://www.cnsre.cn/tags/split/\n","description":"Linuxä¸‹ä½¿ç”¨ split è¿›è¡Œå¤§æ–‡ä»¶çš„åˆ†å‰²ä¸åˆå¹¶","id":16,"section":"posts","tags":["split"],"title":"Linux å¤§æ–‡ä»¶åˆ†å‰²åˆå¹¶","uri":"http://www.cnsre.cn:80/posts/211201955418/"},{"content":" ä½œè€…ï¼šSREè¿ç»´åšå®¢\nåšå®¢åœ°å€ï¼š https://www.cnsre.cn/\næ–‡ç« åœ°å€ï¼šhttps://www.cnsre.cn/posts/211129946481/\nç›¸å…³è¯é¢˜ï¼šhttps://www.cnsre.cn/kubernetes/\nTaint å’Œ Tolerationï¼ˆæ±¡ç‚¹å’Œå®¹å¿ï¼‰ åœ¨ k8s é›†ç¾¤ä¸­ï¼ŒèŠ‚ç‚¹äº²å’Œæ€§ NodeAffinity æ˜¯ä¸€ç§ Pod ä¸Šå®šä¹‰çš„å±æ€§ï¼Œèƒ½å¤Ÿè®© Pod å¯ä»¥æŒ‰æ‰¾æˆ‘ä»¬çš„éœ€æ±‚è°ƒåº¦åˆ°æŒ‡å®šèŠ‚ç‚¹ä¸Šï¼Œè€Œ Taints (æ±¡ç‚¹) åˆ™äºNodeAffinity (èŠ‚ç‚¹äº²å’Œæ€§)æ˜¯ç›¸åçš„ï¼Œå®ƒæ˜¯ä¸€ç§ Node ä¸Šå®šä¹‰çš„å±æ€§ï¼Œå¯ä»¥è®© Pod ä¸è¢«è°ƒåº¦åˆ°å¸¦æ±¡ç‚¹çš„èŠ‚ç‚¹ä¸Šï¼Œç”šè‡³ä¼šå¯¹å¸¦æ±¡ç‚¹èŠ‚ç‚¹ä¸Šå·²æœ‰çš„ Pod è¿›è¡Œé©±é€ã€‚å¯¹åº”çš„ k8s å¯ä»¥ç»™ Pod è®¾ç½® Tolerations(å®¹å¿) è®© Pod èƒ½å¤Ÿå¯¹æœ‰æ±¡ç‚¹çš„èŠ‚ç‚¹è®¾ç½®å®¹å¿ï¼Œå°† Pod è°ƒåº¦åˆ°è¯¥èŠ‚ç‚¹ã€‚ Taints ä¸€èˆ¬æ˜¯é…åˆ Tolerations ä½¿ç”¨çš„ã€‚\nä¸º node è®¾ç½®æ±¡ç‚¹å’Œå®¹å¿ NoSchedule: ä¸€å®šä¸èƒ½è¢«è°ƒåº¦ PreferNoSchedule: å°½é‡ä¸è¦è°ƒåº¦ NoExecute: ä¸ä»…ä¸ä¼šè°ƒåº¦, è¿˜ä¼šé©±é€Nodeä¸Šå·²æœ‰çš„Pod ä¸º node1 è®¾ç½® taintï¼š\n1 2 3 kubectl taint nodes k8s-node1 key1=value1:NoSchedule kubectl taint nodes k8s-node1 key1=value1:NoExecute kubectl taint nodes k8s-node1 key2=value2:NoSchedule æŸ¥çœ‹ node1 ä¸Šçš„ taintï¼š\n1 kubectl describe nodes k8s-node1 |grep Taint åˆ é™¤ä¸Šé¢çš„ taintï¼š\n1 2 3 4 kubectl taint nodes k8s-node1 key1:NoSchedule- kubectl taint nodes k8s-node1 key1:NoExecute- kubectl taint nodes k8s-node1 key2:NoSchedule- kubectl taint nodes k8s-node1 key1- # åˆ é™¤æŒ‡å®škeyæ‰€æœ‰çš„effect ä¸º pod è®¾ç½® toleration åªè¦åœ¨ pod çš„ spec ä¸­è®¾ç½® tolerations å­—æ®µå³å¯ï¼Œå¯ä»¥æœ‰å¤šä¸ª keyï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 tolerations: - key: \u0026#34;key1\u0026#34; operator: \u0026#34;Equal\u0026#34; value: \u0026#34;value1\u0026#34; effect: \u0026#34;NoSchedule\u0026#34; - key: \u0026#34;key1\u0026#34; operator: \u0026#34;Equal\u0026#34; value: \u0026#34;value1\u0026#34; effect: \u0026#34;NoExecute\u0026#34; - key: \u0026#34;node.alpha.kubernetes.io/unreachable\u0026#34; operator: \u0026#34;Exists\u0026#34; effect: \u0026#34;NoExecute\u0026#34; tolerationSeconds: 4000 tolerations å’Œ containers åŒçº§ã€‚ key èƒ½å®¹å¿çš„æ±¡ç‚¹ keyã€‚ operator Equal ç­‰äºè¡¨ç¤º key=value ï¼Œ Exists ä¸ç­‰äºï¼Œè¡¨ç¤ºå½“å€¼ä¸ç­‰äºä¸‹é¢ value æ­£å¸¸ value å¯ä»¥è®¾ç½®ä¸º NoScheduleã€PreferNoSchedule æˆ– NoExecuteã€‚ effect effect ç­–ç•¥ tolerationSeconds æ˜¯å½“ pod éœ€è¦è¢«é©±é€æ—¶ï¼Œå¯ä»¥ç»§ç»­åœ¨ node ä¸Šè¿è¡Œçš„æ—¶é—´ã€‚ å…·ä½“çš„ä½¿ç”¨æ–¹æ³•è¯·å‚è€ƒå®˜æ–¹æ–‡æ¡£ã€‚\nä½œè€…ï¼šSREè¿ç»´åšå®¢\nåšå®¢åœ°å€ï¼š https://www.cnsre.cn/\næ–‡ç« åœ°å€ï¼šhttps://www.cnsre.cn/posts/211129946481/\nç›¸å…³è¯é¢˜ï¼šhttps://www.cnsre.cn/tags/kubernetes/\n","description":"Kubernetes æ±¡ç‚¹ Taint å’Œå®¹å¿ Tolerationã€‚","id":17,"section":"posts","tags":["kubernetes","taint","toleration"],"title":"Kubernetes çš„ Taint å’Œ Tolerationï¼ˆæ±¡ç‚¹å’Œå®¹å¿ï¼‰","uri":"http://www.cnsre.cn:80/posts/211129946481/"},{"content":" ä½œè€…ï¼šSREè¿ç»´åšå®¢\nåšå®¢åœ°å€ï¼š https://www.cnsre.cn/\næ–‡ç« åœ°å€ï¼šhttps://www.cnsre.cn/posts/211126003074/\nç›¸å…³è¯é¢˜ï¼šhttps://www.cnsre.cn/tags/k3s/\nå®‰è£…äº† k3s ä»¥åï¼Œå‘ç° traefik å¹¶æ²¡æœ‰ ingress ç”¨çš„ä¹ æƒ¯ï¼Œäºæ˜¯æˆ‘å°±æ‰“ç®—å§ traefik å¸è½½äº†å®‰è£…ä¸Šingressã€‚\nåˆ é™¤traefik åˆ é™¤traefikèˆµå›¾èµ„æºï¼š 1 2 kubectl -n kube-system delete helmcharts.helm.cattle.io traefik kubectl -n kube-system delete helmcharts.helm.cattle.io traefik-crd ä¿®æ”¹ k3s.service é…ç½®æ–‡ä»¶ åœæ­¢k3sæœåŠ¡ï¼š systemctl stop k3s ç¼–è¾‘æœåŠ¡æ–‡ä»¶vim /etc/systemd/system/k3s.serviceå¹¶å°†æ­¤è¡Œæ·»åŠ åˆ°ExecStart ï¼š\n--disable traefik \\ é‡æ–°åŠ è½½æœåŠ¡æ–‡ä»¶ï¼š systemctl daemon-reload\nä»è‡ªåŠ¨éƒ¨ç½²æ–‡ä»¶å¤¹ä¸­åˆ é™¤æ¸…å•æ–‡ä»¶ï¼š rm /var/lib/rancher/k3s/server/manifests/traefik.yaml\nå¯åŠ¨k3sæœåŠ¡ï¼š systemctl start k3s\nå®‰è£…ingress å®‰è£… ingress çš„è¯ å‚è€ƒæˆ‘ä¹‹å‰çš„æ–‡ç«  kubernetes å®‰è£… ingress controller\nä½œè€…ï¼šSREè¿ç»´åšå®¢\nåšå®¢åœ°å€ï¼š https://www.cnsre.cn/\næ–‡ç« åœ°å€ï¼šhttps://www.cnsre.cn/posts/211126003074/\nç›¸å…³è¯é¢˜ï¼šhttps://www.cnsre.cn/tags/k3s/\n","description":"k3s å®‰è£…ä»¥åæƒ³å¸è½½ traefik","id":18,"section":"posts","tags":["k3s","traefik"],"title":"k3s å¸è½½ traefik","uri":"http://www.cnsre.cn:80/posts/211126003074/"},{"content":" ä½œè€…ï¼šSREè¿ç»´åšå®¢\nåšå®¢åœ°å€ï¼š https://www.cnsre.cn/\næ–‡ç« åœ°å€ï¼šhttps://www.cnsre.cn/posts/211124953028/\nç›¸å…³è¯é¢˜ï¼šhttps://www.cnsre.cn/tags/zabbix/\næ•…éšœè¡¨ç° serverç«¯æ‰§è¡Œzabbix_getæç¤ºæŠ¥é”™:æ²¡æœ‰æƒé™\næ•…éšœåˆ†æ zabbixè‡ªå®šä¹‰keyç›‘æ§æ—¥å¿—\nè„šæœ¬å¦‚ä¸‹\n#!/bin/bash Path=/home/xxx/logs/AspectLog/aspect.log api1=xxxxxx/login if [ $# -ne 1 ];then echo \u0026#34;Follow the script name with an argument\u0026#34; fi case $1 in AccountLogin) cat $Path |grep $api1 |awk -F \u0026#39;,\u0026#39; \u0026#39;{print $23}\u0026#39;|awk -F\u0026#39;:\u0026#39; \u0026#39;END {print $2}\u0026#39; ;; *) echo -e \u0026#34;\\e[033mUsage: sh -bash [è¯·è¾“å…¥APIåç§°|å¦‚:AccountLogin]\\e[0m\u0026#34; esac agentçš„é…ç½®æ–‡ä»¶\n[root@ip-10-0-11-39 zabbix]# cat zabbix_agentd.conf |grep usedtime.sh UserParameter=used.time[*],/etc/zabbix/usedtime.sh $1 serverç«¯æ‰§è¡Œzabbix_getæç¤ºæŠ¥é”™:æ²¡æœ‰æƒé™\n[root@zabbix ~]# zabbix_get -s 10.0.10.243 -p 10050 -k usedtime.sh { [cat: /home/ec2-user/homeconnect/logs/AspectLog/aspect.log : Permission denied ] } æ•…éšœåˆ†æ åˆ†æç»“æœï¼šagentç«¯çš„selinuxå’Œfirewalldå·²ç»å…³é—­\né€šè¿‡zabbix_get å‘ç°æ˜¯å› ä¸º zabbix_agent æ²¡æœ‰æ—¥å¿—çš„æƒé™ã€‚\nè§£å†³æ–¹æ³• éœ€è¦æ›´æ”¹agentçš„é…ç½®æ–‡ä»¶\nä¿®æ”¹ä¸º AllowRoot=1\né‡å¯agent å³å¯\nsystemctl restart zabbix-agent ä½œè€…ï¼šSREè¿ç»´åšå®¢\nåšå®¢åœ°å€ï¼š https://www.cnsre.cn/\næ–‡ç« åœ°å€ï¼šhttps://www.cnsre.cn/posts/211124953028/\nç›¸å…³è¯é¢˜ï¼šhttps://www.cnsre.cn/tags/zabbix/\n","description":"zabbix-agentæ‰§è¡Œè„šæœ¬æç¤ºï¼šPermission denied","id":19,"section":"posts","tags":["zabbix","æ•…éšœé›†"],"title":"zabbix-agentæ‰§è¡Œè„šæœ¬æç¤ºï¼šPermission denied","uri":"http://www.cnsre.cn:80/posts/211124953028/"},{"content":" ä½œè€…ï¼šSREè¿ç»´åšå®¢\nåšå®¢åœ°å€ï¼š https://www.cnsre.cn/\næ–‡ç« åœ°å€ï¼šhttps://www.cnsre.cn/posts/211122846494/\nç›¸å…³è¯é¢˜ï¼šhttps://www.cnsre.cn/tags/shell/\n1ã€åˆ¤æ–­curlè¿”å›çŠ¶æ€ç  1 2 3 4 5 6 7 #!/bin/bash response=$(curl -sL -o /dev/null -w %{http_code} https://baidu.com) if [[ $response -ge 200 \u0026amp;\u0026amp; $response -le 299 ]] ;then echo \u0026#39;check point success\u0026#39; else echo \u0026#39;check point fail\u0026#39; fi 2ã€è¯»å–æ–‡ä»¶ä¸­çš„é…ç½®åˆ°å˜é‡ä¸­ 1 2 3 4 5 6 #!/bin/bash # é…ç½®æ–‡ä»¶ä¸­çš„é…ç½®é¡¹æ ¼å¼ä¸ºkey1=value1ï¼Œä¸€è¡Œä¸€ä¸ªé…ç½®é¡¹ while read line;do eval \u0026#34;$line\u0026#34; done \u0026lt; /etc/openvpn/server/smtp.conf echo $key1 3ã€æ ¹æ®consoleè¾“å…¥æ¡ä»¶æ‰§è¡Œ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 #!/bin/bash echo \u0026#34;é€‰æ‹©ä»¥ä¸‹åŠŸèƒ½:\u0026#34; echo \u0026#34; 0) åŠŸèƒ½0\u0026#34; echo \u0026#34; 1) åŠŸèƒ½1\u0026#34; echo \u0026#34; 2) åŠŸèƒ½2\u0026#34; echo \u0026#34; 3) åŠŸèƒ½3\u0026#34; echo \u0026#34; 4) åŠŸèƒ½4\u0026#34; read -p \u0026#34;åŠŸèƒ½é€‰é¡¹[4]: \u0026#34; option until [[ -z \u0026#34;$option\u0026#34; || \u0026#34;$option\u0026#34; =~ ^[0-4]$ ]]; do read -p \u0026#34;$optionä¸ºæ— æ•ˆçš„é€‰é¡¹ï¼Œè¯·é‡æ–°è¾“å…¥åŠŸèƒ½é€‰é¡¹: \u0026#34; option done case \u0026#34;$option\u0026#34; in 0) echo \u0026#34;åŠŸèƒ½0å·²æ‰§è¡Œ!\u0026#34; ;; 1) echo \u0026#34;åŠŸèƒ½1å·²æ‰§è¡Œ!\u0026#34; exit ;; 2) echo \u0026#34;åŠŸèƒ½2å·²æ‰§è¡Œ!\u0026#34; exit ;; 3) echo \u0026#34;åŠŸèƒ½3å·²æ‰§è¡Œ!\u0026#34; exit ;; # é»˜è®¤é€‰é¡¹ 4|\u0026#34;\u0026#34;) echo \u0026#34;åŠŸèƒ½4å·²æ‰§è¡Œ!\u0026#34; exit ;; esac 4ã€å°†æŒ‡å®šè¾“å‡ºå†…å®¹å†™å…¥æ–‡ä»¶ 1 2 3 4 { echo \u0026#34;hahh\u0026#34; echo \u0026#34;lalal\u0026#34; } \u0026gt; /tmp/test 5ã€åˆ¤æ–­å˜é‡æ˜¯å¦å­˜åœ¨æˆ–ä¸ºç©º 1 2 3 4 5 if [ -z ${var+x} ]; then echo \u0026#34;var is unset\u0026#34;; else echo \u0026#34;var is set to \u0026#39;$var\u0026#39;\u0026#34;; fi 6ã€æ¢ç®—ç§’ä¸ºåˆ†é’Ÿã€å°æ—¶ 1 2 3 4 5 6 7 8 9 10 11 12 13 #!/bin/bash a=60100 swap_seconds () { SEC=$1 (( SEC \u0026lt; 60 )) \u0026amp;\u0026amp; echo -e \u0026#34;æŒç»­æ—¶é—´: $SECç§’\\c\u0026#34; (( SEC \u0026gt;= 60 \u0026amp;\u0026amp; SEC \u0026lt; 3600 )) \u0026amp;\u0026amp; echo -e \u0026#34;æŒç»­æ—¶é—´: $(( SEC / 60 ))åˆ†é’Ÿ$(( SEC % 60 ))ç§’\\c\u0026#34; (( SEC \u0026gt; 3600 )) \u0026amp;\u0026amp; echo -e \u0026#34;æŒç»­æ—¶é—´: $(( SEC / 3600 ))å°æ—¶$(( (SEC % 3600) / 60 ))åˆ†é’Ÿ$(( (SEC % 3600) % 60 ))ç§’\\c\u0026#34; } b=`swap_seconds $a` echo $b è¾“å‡º\n1 æŒç»­æ—¶é—´: 16å°æ—¶41åˆ†é’Ÿ40ç§’ 7ã€è„šæœ¬å‘½ä»¤è¡Œå‚æ•°çš„ä¼ é€’ä¸åˆ¤æ–­ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 #!/bin/bash main() { if [[ $# == 1 ]]; then case $1 in \u0026#34;-h\u0026#34;) echo \u0026#34;è„šæœ¬ä½¿ç”¨æ–¹æ³•: \u0026#34; echo \u0026#34; ./gitlab-pipeline.sh gitä»“åº“å1 gitä»“åº“å2 ... tagå(tagå‘½åè§„åˆ™ä¸º: *-våŠ æ•°å­—)\u0026#34; exit ;; \u0026#34;--help\u0026#34;) echo \u0026#34;è„šæœ¬ä½¿ç”¨æ–¹æ³•: \u0026#34; echo \u0026#34; ./gitlab-pipeline.sh gitä»“åº“å1 gitä»“åº“å2 ... tagå(tagå‘½åè§„åˆ™ä¸º: *-våŠ æ•°å­—)\u0026#34; exit ;; *) echo \u0026#34;å‚æ•°é”™è¯¯ï¼\u0026#34; exit ;; esac fi } main $* 8ã€æ£€æµ‹docker å®¹å™¨çš„å¯åŠ¨çŠ¶æ€ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 # ç¬¬ä¸€æ­¥ï¼šåˆ¤æ–­é•œåƒæ˜¯å¦å­˜åœ¨ if [ `docker images --format {{.Repository}}:{{.Tag}} |grep -Fx 192.168.1.7:32772/applications/$CI_PROJECT_NAME:${CI_COMMIT_SHORT_SHA};echo $?` -eq 0 ];then docker pull 192.168.1.7:32772/applications/$CI_PROJECT_NAME:$CI_COMMIT_SHORT_SHA ; fi; # ç¬¬äºŒæ­¥ï¼šåˆ¤æ–­æ˜¯å¦å·²ç»æœ‰é‡åçš„å®¹å™¨åœ¨è¿è¡Œæˆ–è€…å¤„åœ¨å…¶ä»–çŠ¶æ€ã€‚é‡åçš„ï¼Œå…ˆåˆ æ‰ï¼Œåœ¨å¯åŠ¨ï¼›ä¸é‡åçš„ç›´æ¥å¯åŠ¨ if [ `docker ps -a --format {{.Names}} |grep -Fx $CI_PROJECT_NAME \u0026gt; /dev/null ;echo $?` -eq 0 ] ;then docker rm -f $CI_PROJECT_NAME ; docker run -d --name $CI_PROJECT_NAME -p 30088:8080 192.168.1.7:32772/applications/$CI_PROJECT_NAME:$CI_COMMIT_SHORT_SHA ; else docker run -d --name $CI_PROJECT_NAME -p 30088:8080 192.168.1.7:32772/applications/$CI_PROJECT_NAME:$CI_COMMIT_SHORT_SHA ; fi; # ç¬¬ä¸‰æ­¥ï¼šå¾ªç¯äº”æ¬¡åˆ¤æ–­å®¹å™¨çš„ç›‘æ§æ£€æµ‹æ˜¯å¦å¤„äºä»€ä¹ˆçŠ¶æ€ã€‚å¥åº·çŠ¶æ€å°±ç›´æ¥é€€å‡ºå¾ªç¯ï¼Œä¸å¥åº·æ˜¾ç¤ºå¥åº·æ£€æŸ¥æ—¥å¿—ï¼Œæ­£åœ¨å¯åŠ¨çš„ç›´æ¥æ˜¾ç¤ºã€‚å¤„äºå…¶ä»–çŠ¶æ€çš„ç›´æ¥æ˜¾ç¤ºçŠ¶æ€ n=0; while true ;do container_state=`docker inspect --format=\u0026#39;{{json .State.Health.Status}}\u0026#39; $CI_PROJECT_NAME`; case $container_state in \u0026#39;\u0026#34;starting\u0026#34;\u0026#39; ) echo \u0026#34;åº”ç”¨å®¹å™¨æ­£åœ¨å¯åŠ¨ï¼\u0026#34;; ;; \u0026#39;\u0026#34;healthy\u0026#34;\u0026#39; ) echo \u0026#34;åº”ç”¨å®¹å™¨å·²å¯åŠ¨ï¼ŒçŠ¶æ€å¥åº·ï¼\u0026#34;; break; ;; \u0026#39;\u0026#34;unhealthy\u0026#34;\u0026#39; ) echo \u0026#34;åº”ç”¨å®¹å™¨å¥åº·æ£€æµ‹å¤±è´¥ï¼\u0026#34;; docker inspect --format=\u0026#39;{{json .State.Health.Log}}\u0026#39; $CI_PROJECT_NAME; ;; * ) echo \u0026#34;æœªçŸ¥çš„çŠ¶æ€:$container_state\u0026#34;; ;; esac; sleep 1s; n=$(($n+1)); if [ $n -eq 5 ]; then break ; fi ; done 9ã€æ£€æŸ¥å¸¸è§ç³»ç»Ÿå‘½ä»¤æ˜¯å¦å®‰è£… 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 check_command() { if ! command -v ifconfig \u0026gt;/dev/null 2\u0026gt;\u0026amp;1; then echo -e \u0026#34;\\033[31mifconfigå‘½ä»¤ä¸å­˜åœ¨ï¼Œæ­£åœ¨ä¸‹è½½å®‰è£…ï¼\\033[0m\u0026#34; if os=\u0026#34;ubuntu\u0026#34;; then apt install -y net-tools \u0026gt;/dev/null 2\u0026gt;\u0026amp;1 elif os=\u0026#34;centos\u0026#34;; then yum install -y net-tools \u0026gt;/dev/null 2\u0026gt;\u0026amp;1 elif os=\u0026#34;fedora\u0026#34;; then dnf install -y net-tools \u0026gt;/dev/null 2\u0026gt;\u0026amp;1 fi elif ! command -v ip \u0026gt;/dev/null 2\u0026gt;\u0026amp;1; then echo -e \u0026#34;\\033[31mipå‘½ä»¤ä¸å­˜åœ¨ï¼Œæ­£åœ¨ä¸‹è½½å®‰è£…ï¼\\033[0m\u0026#34; if os=\u0026#34;ubuntu\u0026#34;; then apt install -y iproute2 \u0026gt;/dev/null 2\u0026gt;\u0026amp;1 elif os=\u0026#34;centos\u0026#34;; then yum install -y iproute2 \u0026gt;/dev/null 2\u0026gt;\u0026amp;1 elif os=\u0026#34;fedora\u0026#34;; then dnf install -y iproute2 \u0026gt;/dev/null 2\u0026gt;\u0026amp;1 fi elif ! command -v curl \u0026gt;/dev/null 2\u0026gt;\u0026amp;1; then echo -e \u0026#34;\\033[31mcurlå‘½ä»¤ä¸å­˜åœ¨ï¼Œæ­£åœ¨ä¸‹è½½å®‰è£…ï¼\\033[0m\u0026#34; if os=\u0026#34;ubuntu\u0026#34;; then apt install -y curl \u0026gt;/dev/null 2\u0026gt;\u0026amp;1 elif os=\u0026#34;centos\u0026#34;; then yum install -y curl \u0026gt;/dev/null 2\u0026gt;\u0026amp;1 elif os=\u0026#34;fedora\u0026#34;; then dnf install -y curl \u0026gt;/dev/null 2\u0026gt;\u0026amp;1 fi elif ! command -v wget \u0026gt;/dev/null 2\u0026gt;\u0026amp;1; then echo -e \u0026#34;\\033[31mawkå‘½ä»¤ä¸å­˜åœ¨ï¼Œæ­£åœ¨ä¸‹è½½å®‰è£…ï¼\\033[0m\u0026#34; if os=\u0026#34;ubuntu\u0026#34;; then apt install -y wget \u0026gt;/dev/null 2\u0026gt;\u0026amp;1 elif os=\u0026#34;centos\u0026#34;; then yum install -y wget \u0026gt;/dev/null 2\u0026gt;\u0026amp;1 elif os=\u0026#34;fedora\u0026#34;; then dnf install -y wget \u0026gt;/dev/null 2\u0026gt;\u0026amp;1 fi elif ! command -v tail \u0026gt;/dev/null 2\u0026gt;\u0026amp;1; then echo -e \u0026#34;\\033[31mcoreutilså‘½ä»¤ä¸å­˜åœ¨ï¼Œæ­£åœ¨ä¸‹è½½å®‰è£…ï¼\\033[0m\u0026#34; if os=\u0026#34;ubuntu\u0026#34;; then apt install -y coreutils \u0026gt;/dev/null 2\u0026gt;\u0026amp;1 elif os=\u0026#34;centos\u0026#34;; then yum install -y coreutils \u0026gt;/dev/null 2\u0026gt;\u0026amp;1 elif os=\u0026#34;fedora\u0026#34;; then dnf install -y coreutils \u0026gt;/dev/null 2\u0026gt;\u0026amp;1 fi elif ! command -v sed \u0026gt;/dev/null 2\u0026gt;\u0026amp;1; then echo -e \u0026#34;\\033[31msedå‘½ä»¤ä¸å­˜åœ¨ï¼Œæ­£åœ¨ä¸‹è½½å®‰è£…ï¼\\033[0m\u0026#34; if os=\u0026#34;ubuntu\u0026#34;; then apt install -y sed \u0026gt;/dev/null 2\u0026gt;\u0026amp;1 elif os=\u0026#34;centos\u0026#34;; then yum install -y sed \u0026gt;/dev/null 2\u0026gt;\u0026amp;1 elif os=\u0026#34;fedora\u0026#34;; then dnf install -y sed \u0026gt;/dev/null 2\u0026gt;\u0026amp;1 fi elif ! command -v grep \u0026gt;/dev/null 2\u0026gt;\u0026amp;1; then echo -e \u0026#34;\\033[31mgrepå‘½ä»¤ä¸å­˜åœ¨ï¼Œæ­£åœ¨ä¸‹è½½å®‰è£…ï¼\\033[0m\u0026#34; if os=\u0026#34;ubuntu\u0026#34;; then apt install -y grep \u0026gt;/dev/null 2\u0026gt;\u0026amp;1 elif os=\u0026#34;centos\u0026#34;; then yum install -y grep \u0026gt;/dev/null 2\u0026gt;\u0026amp;1 elif os=\u0026#34;fedora\u0026#34;; then dnf install -y grep \u0026gt;/dev/null 2\u0026gt;\u0026amp;1 fi fi } 10ã€æ£€æŸ¥ç³»ç»Ÿç½‘ç»œ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 check_network() { check_command ping -c 4 114.114.114.114 \u0026gt;/dev/null if [ ! $? -eq 0 ]; then echo -e \u0026#34;\\033[31mIPåœ°å€æ— æ³•pingé€šï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥ï¼ï¼ï¼\\033[0m\u0026#34; exit fi ping -c 4 www.baidu.com \u0026gt;/dev/null if [ ! $? -eq 0 ]; then echo -e \u0026#34;\\033[31måŸŸåæ— æ³•Pingé€šï¼Œè¯·æ£€æŸ¥DNSé…ç½®ï¼ï¼ï¼\\033[0m\u0026#34; exit fi curl -s --retry 2 --connect-timeout 2 www.baidu.com \u0026gt;/dev/null if [ ! $? -eq 0 ]; then echo -e \u0026#34;\\033[31måŸŸåæ— æ³•Pingé€šï¼Œè¯·æ£€æŸ¥DNSé…ç½®ï¼ï¼ï¼\\033[0m\u0026#34; exit fi } åŸæ–‡å‡ºå¤„ï¼šhttps://gitbook.curiouser.top/origin/bash-scirpts.html#\nä½œè€…ï¼šSREè¿ç»´åšå®¢\nåšå®¢åœ°å€ï¼š https://www.cnsre.cn/\næ–‡ç« åœ°å€ï¼šhttps://www.cnsre.cn/posts/211122846494/\nç›¸å…³è¯é¢˜ï¼šhttps://www.cnsre.cn/tags/shell/\n","description":"10ä¸ªå¸¸ç”¨shellè„šæœ¬ï¼Œåˆ¤æ–­curlè¿”å›çŠ¶æ€ç ï¼Œè¯»å–æ–‡ä»¶ä¸­çš„é…ç½®åˆ°å˜é‡ä¸­ï¼Œæ ¹æ®consoleè¾“å…¥æ¡ä»¶æ‰§è¡Œï¼Œå°†æŒ‡å®šè¾“å‡ºå†…å®¹å†™å…¥æ–‡ä»¶ï¼Œåˆ¤æ–­å˜é‡æ˜¯å¦å­˜åœ¨æˆ–ä¸ºç©ºï¼Œè„šæœ¬å‘½ä»¤è¡Œå‚æ•°çš„ä¼ é€’ä¸åˆ¤æ–­ ...","id":20,"section":"posts","tags":["shell"],"title":"10ä¸ª shell å¸¸ç”¨è„šæœ¬","uri":"http://www.cnsre.cn:80/posts/211122846494/"},{"content":" ä½œè€…ï¼šSREè¿ç»´åšå®¢\nåšå®¢åœ°å€ï¼š https://www.cnsre.cn/\næ–‡ç« åœ°å€ï¼šhttps://www.cnsre.cn/posts/211117937177/\nç›¸å…³è¯é¢˜ï¼šhttps://www.cnsre.cn/tags/kvm/\nWebVirtMgræ˜¯è¿‘ä¸¤å¹´æ¥å‘å±•è¾ƒå¿«ï¼Œæ¯”è¾ƒæ´»è·ƒï¼Œéå¸¸æ¸…æ–°çš„ä¸€ä¸ªKVMç®¡ç†å¹³å°ï¼Œæä¾›å¯¹å®¿ä¸»æœºå’Œè™šæœºçš„ç»Ÿä¸€ç®¡ç†ï¼Œå®ƒæœ‰åˆ«äºkvmè‡ªå¸¦çš„å›¾å½¢ç®¡ç†å·¥å…·ï¼ˆvirtual machine managerï¼‰ï¼Œè®©kvmç®¡ç†å˜å¾—æ›´ä¸ºå¯è§†åŒ–ï¼Œå¯¹ä¸­å°å‹kvmåº”ç”¨åœºæ™¯å¸¦æ¥äº†æ›´å¤šæ–¹ä¾¿ã€‚\nWebVirtMgrä»‹ç» WebVirtMgré‡‡ç”¨å‡ ä¹çº¯Pythonå¼€å‘ï¼Œå…¶å‰ç«¯æ˜¯åŸºäºPythonçš„Djangoï¼Œåç«¯æ˜¯åŸºäºLibvirtçš„Pythonæ¥å£ï¼Œå°†æ—¥å¸¸kvmçš„ç®¡ç†æ“ä½œå˜çš„æ›´åŠ çš„å¯è§†åŒ–ã€‚\nWebVirtMgr ç‰¹ç‚¹ æ“ä½œç®€å•ï¼Œæ˜“äºä½¿ç”¨\tã€é€šè¿‡libvirtçš„APIæ¥å£å¯¹kvmè¿›è¡Œç®¡ç†ã€æä¾›å¯¹è™šæ‹Ÿæœºç”Ÿå‘½å‘¨æœŸç®¡ç†\nWebVirtMgr åŠŸèƒ½ å®¿ä¸»æœºç®¡ç†æ”¯æŒä»¥ä¸‹åŠŸèƒ½ã€CPUåˆ©ç”¨ç‡ã€å†…å­˜åˆ©ç”¨ç‡ã€ç½‘ç»œèµ„æºæ± ç®¡ç†ã€å­˜å‚¨èµ„æºæ± ç®¡ç†ã€è™šæ‹Ÿæœºé•œåƒã€è™šæ‹Ÿæœºå…‹éš†ã€å¿«ç…§ç®¡ç†ã€æ—¥å¿—ç®¡ç†ã€è™šæœºè¿ç§»ã€è™šæ‹Ÿæœºç®¡ç†æ”¯æŒä»¥ä¸‹åŠŸèƒ½ã€CPUåˆ©ç”¨ç‡ã€å†…å­˜åˆ©ç”¨ç‡ã€å…‰ç›˜ç®¡ç†ã€å…³/å¼€/æš‚åœè™šæ‹Ÿæœºã€å®‰è£…è™šæ‹Ÿæœºã€VNC consoleè¿æ¥ã€åˆ›å»ºå¿«ç…§\nå®˜æ–¹æ–‡æ¡£ https://github.com/retspen/webvirtmgr/wiki/Install-WebVirtMgr\nå®‰è£…å‰çš„éƒ¨ç½² å®‰è£…ä¸€äº›ä¾èµ–åŒ…\n1 yum -y install git python-pip libvirt-python libxml2-python python-websockify supervisor nginx gcc python-devel wget vim net-tools lrzsz å®‰è£…pip 1 2 3 wget https://bootstrap.pypa.io/get-pip.py python get-pip.py pip -Vã€€1 pip install numpy å®‰è£…pythonçš„éœ€è¦åŒ…å’Œé…ç½®Djangoç¯å¢ƒ 1 git clone git://github.com/retspen/webvirtmgr.git å®‰è£…nginx 1 2 rpm -Uvh http://nginx.org/packages/centos/7/noarch/RPMS/nginx-release-centos-7-0.el7.ngx.noarch.rpm yum install nginx -y å®‰è£…supervisor å®‰è£…å‚è€ƒ\nhttps://www.2cto.com/kf/201712/702837.html\nå¼€æœºè‡ªå¯å‚è€ƒ\nhttps://blog.csdn.net/binggoogle/article/details/53203991\n1 cat /etc/supervisord.conf âš ï¸ æ³¨æ„\nå¦‚æœæ²¡æœ‰è¿™ä¸ªæ–‡ä»¶æŒ‰ç…§ä¸€ä¸‹æ­¥éª¤å®‰è£…\næœ‰çš„è¯å¿½ç•¥æ­¤æ­¥éª¤\n1 2 3 pip install supervisor mkdir /etc/supervisord.d/ echo_supervisord_conf \u0026gt; /etc/supervisord.conf æ–°å»ºæ–‡ä»¶å¤¹\n1 vim /etc/supervisord.d/app.conf é…ç½®æ–‡ä»¶ app.conf\nå†…å®¹ä¸º\n1 2 3 4 5 6 7 8 [program:appname] command=/root/soft/push.api directory=/root/soft/push.api autostart=true autorestart=true user=root stdout_logfile = /var/log/supervisor/pushapi.log stderr_logfile = /var/log/supervisor/pushapi-error.log ä¿®æ”¹ åœ¨é…ç½®æ–‡ä»¶æœ€ä¸‹æ–¹ä¿®æ”¹ä¸º\n1 2 3 vim /etc/supervisord.conf [include] files = /etc/supervisord.d/*.ini 1 2 3 supervisord -c /etc/supervisord.conf /usr/bin/supervisorctl start all /usr/bin/supervisorctl stop all å®‰è£…ç¯å¢ƒ 1 2 cd webvirtmgr pip install -r requirements.txt 1 ./manage.py syncdb åˆ›å»ºç”¨æˆ· è¾“å…¥ä»¥ä¸‹ç”¨æˆ·ä¿¡æ¯\n1 2 3 4 5 6 7 8 9 10 11 You just installed Django\u0026#39;s auth system, which means you don\u0026#39;t have any superusers defined. Would you like to create one now? (yes/no): yes Username (leave blank to use \u0026#39;root\u0026#39;): admin Email address: 275301281@qq.com Password: admin Password (again):admin Superuser created successfully. Installing custom SQL ... Installing indexes ... Installed 6 object(s) from 1 fixture(s) ./manage.py collectstatic é…ç½®ä¸€ä¸ªè¶…çº§ç”¨æˆ· 1 ./manage.py createsuperuser 1 2 3 4 5 6 WARNING:root:No local_settings file found. Username (leave blank to use \u0026#39;root\u0026#39;): yes Email address: 275301281@qq.com Password: Lenovo@123 Password (again): Lenovo@123 Superuser created successfully. è®¾ç½®nginx aã€ä½¿ç”¨:8000ç«¯å£\nç§»åŠ¨è¿™ä¸ª webvirtmgr ç›®å½•åˆ° /var/www ä¸‹ 1 2 cd .. mv webvirtmgr /var/www/ âš ï¸ æ³¨æ„ï¼š\nwebvirtmgr ç›®å½•ä¸‹è¿˜æœ‰ä¸€ä¸ªåç§°ä¸ºwebvirtmgr çš„æ–‡ä»¶å¤¹\nä¸è¦å•ç‹¬ç§»åŠ¨ webvirtmgr/webvirtmgr æ–‡ä»¶ ç¼–è¾‘é…ç½®æ–‡ä»¶ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 vim /etc/nginx/conf.d/webvirtmgr.conf server { listen 80 default_server; server_name $hostname; #access_log /var/log/nginx/webvirtmgr_access_log; location /static/ { root /var/www/webvirtmgr/webvirtmgr; # or /srv instead of /var expires max; } location / { proxy_pass http://127.0.0.1:8000; proxy_set_header X-Real-IP $remote_addr; proxy_set_header X-Forwarded-for $proxy_add_x_forwarded_for; proxy_set_header Host $host:$server_port; proxy_set_header X-Forwarded-Proto $scheme; proxy_connect_timeout 600; proxy_read_timeout 600; proxy_send_timeout 600; client_max_body_size 1024M; # Set higher depending on your needs } } å¯åŠ¨nginxå¹¶è®¾ç½®å¼€æœºè‡ªå¯åŠ¨ (å¦‚æœä¸è®¾ç½®å¼€æœºè‡ªå¯åŠ¨ï¼Œé‡å¯æœåŠ¡å™¨supervisoræ— æ³•ç®¡ç†Djangoè¿›ç¨‹)ï¼Œå¹¶å¼€æœºè‡ªå¯åŠ¨supervisord\n1 /etc/init.d/nginx start æˆ–è€…\n1 2 systemctl restart nginx systemctl enable supervisord åˆ†é…æƒé™\n1 chown nginx.nginx /var/www/webvirtmgr è®¾ç½®supervisor åœ¨/etc/supervisord.confæœ«å°¾åŠ å…¥ä¸‹é¢çš„é…ç½®ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 vi /etc/supervisord.conf [program:webvirtmgr] command=/usr/bin/python /var/www/webvirtmgr/manage.py run_gunicorn -c /var/www/webvirtmgr/conf/gunicorn.conf.py directory=/var/www/webvirtmgr autostart=true autorestart=true logfile=/var/log/supervisor/webvirtmgr.log log_stderr=true user=nginx [program:webvirtmgr-console] command=/usr/bin/python /var/www/webvirtmgr/console/webvirtmgr-console directory=/var/www/webvirtmgr autostart=true autorestart=true #stdout_logfile=/var/log/supervisor/webvirtmgr-console.log redirect_stderr=true user=nginx\tâš ï¸ æ³¨æ„\nè¿›ç¨‹æ— æ³•å¯åŠ¨æˆ–è€…æŠ¥é”™ å¯ä»¥é€‰æ‹©å§ log æ³¨é‡Šå–æ¶ˆ\né‡å¯supervisord å¼€æœºè‡ªå¯å‚è€ƒ\nhttps://blog.csdn.net/binggoogle/article/details/53203991\nè®¾ç½®å®Œä¹‹åé‡å¯å³å¯\n1 2 3 systemctl restart supervisord.service systemctl enable supervisord.service systemctl status supervisord.service æ›´æ–° 1 cd /var/www/webvirtmgr git pull 1 ./manage.py collectstatic 1 systemctl restart supervisord å¦‚æœæœ‰é”™è¯¯æˆ–ä¸è¿è¡Œ 1 2 3 4 ./manage.py runserver 0:8000 #æˆ–è€…åå°è¿è¡Œè„šæœ¬ nohup python /var/www/webvirtmgr/manage.py runserver 0:8000 \u0026gt;/dev/null \u0026amp; nohup python /var/www/console/webvirtmgr-console \u0026gt;/dev/null \u0026amp; è®¿é—®ï¼šhttp://x.x.x.x:8000(x.x.x.x - your server IP address )ï¼Œè¾“å…¥åˆ›å»ºçš„ç”¨æˆ·å’Œå¯†ç ï¼Œå¦‚æœæ²¡æœ‰åˆ›å»ºï¼Œè¯·ç”¨python manager.py createsuperuser,å‘½ä»¤åˆ›å»ºã€‚ç™»å½•åå¦‚ä¸‹å›¾æ‰€ç¤º\né…ç½®è™šæ‹Ÿæœºæ‰€åœ¨å®¿ä¸»æœº\nwebvirtmgrå®¢æˆ·ç«¯å°±è¿™æ ·æ­å»ºå®Œäº†ï¼Œæ¥ä¸‹æ¥éœ€è¦é…ç½®è™šæ‹Ÿæœºæ‰€åœ¨å®¿ä¸»æœºçš„ï¼Œå‚è€ƒgitåœ°å€.\né…ç½®å®¿ä¸»æœº ä¸‹è½½å¹¶æ‰§è¡Œè„šæœ¬ å¦‚æœè™šæ‹Ÿæœºæ¯”è¾ƒå¤šï¼Œè¯¥è„šæœ¬æ‰§è¡Œæ—¶é—´ä¼šæ¯”è¾ƒé•¿ï¼Œå› ä¸ºä¼šæ‰§è¡Œ service libvirt-guests restartï¼Œä¼šå°†æ‰€æœ‰è¿è¡Œçš„è™šæ‹ŸæœºæŒ‚èµ·ç„¶åå†æ¢å¤ï¼Œæ„Ÿè§‰è¿™ä¸€æ­¥ä¸æ˜¯å¿…é¡»çš„ï¼Œå› ä¸ºæˆ‘æœ‰ä¸€å°åªè®¾ç½®sshè®¤è¯ï¼Œä¹Ÿå¯ä»¥æ­£å¸¸è¿æ¥ã€‚\n1 curl http://retspen.github.io/libvirt-bootstrap.sh | sudo sh å¦‚æœæ²¡æœ‰curlå°±ç”¨wget\n1 wget -O - http://retspen.github.io/libvirt-bootstrap.sh | sudo sh é…ç½®é˜²ç«å¢™ 1 iptables -I INPUT -m state --state NEW -m tcp -p tcp --dport 16509 -j ACCEPT è®¾ç½®TCPæˆæƒ å‚è€ƒï¼šhttps://github.com/retspen/webvirtmgr/wiki/Setup-TCP-authorization\nwebvirtmgræ–°å»ºæœåŠ¡å™¨è¿æ¥æ—¶éœ€è¦æ­¤è´¦å·\nç”¨saslpasswd2å‘½ä»¤ç»™libvirtçš„ç”¨æˆ·cnsreè®¾ç½®å¯†ç  1 2 3 saslpasswd2 -a libvirt cnsre Password: cnsre Again (for verification): cnsre ç”Ÿæˆä¸€ä¸ªå¯†ç åº“ 1 2 3 sasldblistusers2 -f /etc/libvirt/passwd.db cnsre@webvirtmgr.cn: userPassword è®¾ç½®sshæˆæƒ 1 ssh-keygen -t rsa # äº§ç”Ÿå…¬ç§é’¥ ç›´æ¥å›è½¦ï¼Œå›è½¦ï¼Œå›è½¦\n1 ssh-copy-id 192.168.1.120 âš ï¸ æ³¨æ„\nç”±äºè¿™é‡Œwebvirtmgrå’ŒkvmæœåŠ¡éƒ¨ç½²åœ¨åŒä¸€å°æœºå™¨ï¼Œæ‰€ä»¥è¿™é‡Œæœ¬åœ°ä¿¡ä»»ã€‚\nå¦‚æœkvméƒ¨ç½²åœ¨å…¶ä»–æœºå™¨ï¼Œé‚£ä¹ˆè¿™ä¸ªæ˜¯å…¶ä»–å®ƒçš„ip åŒæ—¶ä¹Ÿè¦è®¾ç½®ssh keyå¯†é’¥\næç¤ºè¾“å…¥å¯†ç çš„æ—¶å€™ç›´æ¥è¾“å…¥ä¹‹å‰1.120çš„å¯†ç \n1 ssh 192.168.1.120 -L localhost:8000:localhost:8000 -L localhost:6080:localhost:6080 web å¹³å°åŠ å…¥å…¶ä»–kvmå®¿ä¸»æœº åœ¨éƒ¨ç½²webç®¡ç†çš„ä¸»æœºä¸Šæ‰§è¡Œå‘½ä»¤\n1 ssh-keygen -t rsa ç„¶ååœ¨æ‰§è¡Œ\n1 ssh-copy-id 192.168.1.165 æ·»åŠ æ–°çš„kvmå®¿ä¸»æœº\næŸ¥çœ‹æ–°åŠ çš„kvmå®¿ä¸»æœºçŠ¶æ€ çœ‹æœ‰æ— æŠ¥é”™\nåˆ é™¤æ–°åŠ çš„è´¦å· 1 sudo saslpasswd2 -a libvirt -d cnsre ç¡®è®¤éªŒè¯æ–°åŠ çš„è´¦å·é…ç½® 1 2 3 4 5 6 7 8 9 10 11 12 virsh -c qemu+tcp://IP_address/system nodeinfo (virsh -c qemu+tcp://192.168.1.50/system nodeinfo) Please enter your authentication name: cnsre Please enter your password: xxxxxx CPU model: x86_64 CPU(s): 2 CPU frequency: 2611 MHz CPU socket(s): 1 Core(s) per socket: 2 Thread(s) per core: 1 NUMA cell(s): 1 Memory size: 2019260 kB âš ï¸ æ³¨æ„\nè´¦å·å…¨åå¸¦hostnameï¼Œå¦‚ cnsre@webvirtmgr.cn\næµ‹è¯•çš„æ—¶å€™è¿™ä¸€æ­¥æµ‹è¯•æ²¡æœ‰æˆåŠŸ ä½†æ˜¯å¯ä»¥é“¾æ¥\nè®¾ç½®sshè®¤è¯ sshå’Œtcpè®¾ç½®ä¸€ç§å³å¯ï¼Œå…¶å®å°±æ˜¯è®¾ç½®æ— å¯†ç ç™»å½•ï¼Œè¦æ³¨æ„çš„æ˜¯ä»webvirtmgrçš„ä»€ä¹ˆç”¨æˆ·åˆ°å®¿ä¸»æœºçš„ä»€ä¹ˆç”¨æˆ·çš„æ— å¯†ç ç™»å½•ï¼Œæ¯”å¦‚æˆ‘ç”¨rootè·‘çš„django webvirtmgrï¼Œè€Œå®¿ä¸»æœºä¹Ÿæ˜¯rootè·‘çš„virshï¼Œæ‰€ä»¥éœ€è¦è®¾ç½®rootåˆ°rootçš„æ— å¯†ç ç™»å½•ã€‚è€Œgitå®˜ç½‘æ¨èçš„æ˜¯ç”¨nginxç”¨æˆ·è·‘django webvirtmgrï¼Œwebvirtmgrç”¨æˆ·è·‘çš„virshï¼Œæ‰€ä»¥è®¾ç½®çš„æ˜¯nginxç”¨æˆ·åˆ°å®¿ä¸»æœºwebvirtmgrç”¨æˆ·çš„æ— å¯†ç ç™»å½•ã€‚ å‚è€ƒï¼šhttps://github.com/retspen/webvirtmgr/wiki/Setup-SSH-Authorizatio\nä½¿ç”¨tcpè®¤è¯è¿æ¥æœåŠ¡å™¨ è®¿é—®ï¼šhttp://192.168.1.120:8000ï¼Œxxxxæ˜¯webvirtmgrçš„ipåœ°å€ï¼Œç‚¹å‡»new connection\nå¡«å†™kvmå®¿ä¸»æœºçš„ä¸€äº›ä¿¡æ¯ åŸºç¡€æ¶æ„å¯ä»¥çœ‹åˆ°ä¸€äº›vmè™šæ‹Ÿæœº\nKVM WEBç®¡ç†å¸¸è§æŠ¥é”™ ç½‘é¡µæ§åˆ¶å° è¿œç¨‹é“¾æ¥æŠ¥é”™1006\nå®‰è£…vncå³å¯\n1 yum install -y novnc ç½‘é¡µæ§åˆ¶å° è¿œç¨‹é“¾æ¥æŠ¥é”™505\n1 2 cd /var/www/console/ ./webvirtmgr-console \u0026amp; åå°è¿è¡Œè„šæœ¬\n1 2 nohup python /var/www/webvirtmgr/manage.py runserver 0:8000 \u0026gt;/dev/null \u0026amp; nohup python /var/www/console/webvirtmgr-console \u0026gt;/dev/null \u0026amp; å…¶ä»–webç®¡ç† webvirtcloud webvirtcloud çš„ä½œè€…è¿˜æ˜¯ webvirtmgrçš„ä½œè€…ï¼Œä½†æ˜¯ webvirtmgr å·²ç»æœ‰å¥½ä¹…æ²¡æœ‰ç»´æŠ¤äº†ã€‚å¦‚æœä½ æƒ³ä½“éªŒ webvirtcloud ä½ å¯ä»¥å®‰è£…webvirtcloudã€‚\nwebvirtcloud ç‰¹å¾ QEMU/KVM ç®¡ç†ç¨‹åºç®¡ç† QEMU/KVM å®ä¾‹ç®¡ç† - åˆ›å»ºã€åˆ é™¤ã€æ›´æ–° è™šæ‹Ÿæœºç®¡ç†ç¨‹åºå’Œå®ä¾‹åŸºäº Web çš„ç»Ÿè®¡ä¿¡æ¯ ç®¡ç†å¤šä¸ª QEMU/KVM ç®¡ç†ç¨‹åº ç®¡ç†ç®¡ç†ç¨‹åºæ•°æ®å­˜å‚¨æ±  ç®¡ç†ç®¡ç†ç¨‹åºç½‘ç»œ ä½¿ç”¨æµè§ˆå™¨è®¿é—®å®ä¾‹æ§åˆ¶å° åŸºäº Libvirt API çš„ Web ç®¡ç† UI åŸºäºç”¨æˆ·çš„æˆæƒå’Œè®¤è¯ ç”¨æˆ·å¯ä»¥åœ¨å®ä¾‹ä¸­å°† SSH å…¬é’¥æ·»åŠ åˆ° rootï¼ˆä»…æµ‹è¯• Ubuntuï¼‰ ç”¨æˆ·å¯ä»¥åœ¨å®ä¾‹ä¸­æ›´æ”¹ root å¯†ç ï¼ˆä»…æµ‹è¯• Ubuntuï¼‰ æ”¯æŒ cloud-init æ•°æ®æºæ¥å£\nwebvirtcloudå…·ä½“æ–‡æ¡£è¯·æŸ¥çœ‹ webvirtcloud é¡¹ç›® webvirtcloud çš„ä½œè€…ä¹Ÿè´´å¿ƒçš„æä¾›äº†ä¸€é”®è„šæœ¬\n1 2 3 wget https://raw.githubusercontent.com/retspen/webvirtcloud/master/install.sh chmod 744 install.sh #ä»¥ sudo æˆ– root ç”¨æˆ·è¿è¡Œ ./install.sh ä½œè€…ï¼šSREè¿ç»´åšå®¢\nåšå®¢åœ°å€ï¼š https://www.cnsre.cn/\næ–‡ç« åœ°å€ï¼šhttps://www.cnsre.cn/posts/211117937177/\nç›¸å…³è¯é¢˜ï¼šhttps://www.cnsre.cn/tags/kvm/\n","description":"WebVirtMgræ˜¯è¿‘ä¸¤å¹´æ¥å‘å±•è¾ƒå¿«ï¼Œæ¯”è¾ƒæ´»è·ƒï¼Œéå¸¸æ¸…æ–°çš„ä¸€ä¸ªKVMç®¡ç†å¹³å°ï¼Œæä¾›å¯¹å®¿ä¸»æœºå’Œè™šæœºçš„ç»Ÿä¸€ç®¡ç†ï¼Œå®ƒæœ‰åˆ«äºkvmè‡ªå¸¦çš„å›¾å½¢ç®¡ç†å·¥å…·ï¼ˆvirtual machine managerï¼‰ï¼Œè®©kvmç®¡ç†å˜å¾—æ›´ä¸ºå¯è§†åŒ–ï¼Œå¯¹ä¸­å°å‹ kvm åº”ç”¨åœºæ™¯å¸¦æ¥äº†æ›´å¤šæ–¹ä¾¿ã€‚","id":21,"section":"posts","tags":["kvm"],"title":"å¿«é€Ÿæ­å»º kvm web ç®¡ç†å·¥å…· WebVirtMgr","uri":"http://www.cnsre.cn:80/posts/211117937177/"},{"content":" ä½œè€…ï¼šSREè¿ç»´åšå®¢\nåšå®¢åœ°å€ï¼š https://www.cnsre.cn/\næ–‡ç« åœ°å€ï¼šhttps://www.cnsre.cn/posts/211115903260/\nç›¸å…³è¯é¢˜ï¼šhttps://www.cnsre.cn/tags/kvm/\nvirshå‘½ä»¤å¸¸ç”¨å‚æ•° å‚æ•° å‚æ•°è¯´æ˜ åŸºç¡€æ“ä½œ list æŸ¥çœ‹è™šæ‹Ÿæœºåˆ—è¡¨ï¼Œåˆ—å‡ºåŸŸ start å¯åŠ¨è™šæ‹Ÿæœºï¼Œå¼€å§‹ä¸€ä¸ªï¼ˆä»¥å‰å®šä¹‰çš„ï¼‰éæ´»è·ƒçš„åŸŸ shutdown å…³é—­è™šæ‹Ÿæœºï¼Œå…³é—­ä¸€ä¸ªåŸŸ destroy(å±é™©) å¼ºåˆ¶å…³é—­è™šæ‹Ÿæœºï¼Œé”€æ¯ï¼ˆåœæ­¢ï¼‰åŸŸ vncdisplay æŸ¥è¯¢è™šæ‹Ÿæœºvncç«¯å£å· é…ç½®ç®¡ç†æ“ä½œ dumpxml å¯¼å‡ºä¸»æœºé…ç½®ä¿¡æ¯ undefine åˆ é™¤ä¸»æœº define å¯¼å…¥ä¸»æœºé…ç½® domrename å¯¹è™šæ‹Ÿæœºè¿›è¡Œé‡å‘½å æŒ‚èµ·ä¸æ¢å¤ suspend æŒ‚èµ·è™šæ‹Ÿæœº resume æ¢å¤è™šæ‹Ÿæœº è‡ªå¯åŠ¨ç®¡ç† autostart è™šæ‹Ÿæœºå¼€æœºå¯åŠ¨ autostart \u0026ndash;disable å–æ¶ˆè™šæ‹Ÿæœºå¼€æœºå¯åŠ¨ ä»¥ä¸Šå‚æ•°é€šè¿‡ â€œvirsh \u0026ndash;helpâ€ è·å¾—ã€‚ åˆ é™¤è™šæ‹Ÿæœº 1 2 3 4 5 6 7 8 9 10 11 12 13 virsh destroy njvm01 #å¼ºåˆ¶å…³é—­ç”µæº virsh undefine njvm01 #åˆ é™¤è™šæ‹Ÿæœº [root@nkgtsv01 data]# virsh shutdown njvm01 åŸŸ njvm01 è¢«å…³é—­ [root@nkgtsv01 data]# virsh start njvm01 åŸŸ njvm02 å·²å¼€å§‹ [root@nkgtsv01 data]# virsh list --all æŸ¥çœ‹è™šæ‹ŸæœºçŠ¶æ€ è®¾ç½®è™šæ‹Ÿæœºè‡ªå¯åŠ¨ 1 2 3 virsh autostart njvm01 virsh autostart --disable njvm02 å¯åŠ¨ï¼Œå…³é—­å’Œé‡å¯ä¸€ä¸ªè™šæ‹Ÿæœº 1 2 3 4 5 virsh start njvm01 virsh shutdown njvm01 virsh reboot njvm01 å®¿ä¸»æœºé“¾æ¥åˆ°kvmè™šæ‹Ÿæœº 1 virsh console njvm01 å…‹éš†è™šæ‹Ÿæœº 1 virt-clone -o njvm01-n njvm02-f /data/kvm-img/njvm02.img ä¿®æ”¹njvm05 é…ç½® 1 virsh edit njvm01 æŒ‚èµ·åŠæ¢å¤è™šæ‹Ÿæœº 1 2 3 4 5 6 7 æŒ‚èµ·ï¼š virsh suspend njvm01 æ¢å¤ï¼š virsh resume njvm01 åˆ›å»ºKVM linux 1 virt-install --name njvm01 --boot network,cdrom,menu=on --ram 8000 --vcpus=2 --os-variant=rhel6 --accelerate --cdrom=/home/iso/CentOS-7-x86-64-DVD-1708.iso --disk path=/data/kvm-i/njvm01.img,size=200,bus=virtio --bridge=br0,model=virtio --autostart --vnc --vncport=5930 --vnclisten=0.0.0.0 åˆ›å»ºKVM Windows 1 2 3 4 virt-install --name njvmwin --boot network,cdrom,menu=on --ram 6411 --os-type=windows --vcpus=1 --os-variant=rhel6 --accelerate --cdrom=/data/BBackup/ --disk path=/data/kvm-images/njvmwin.img,size=200,bus=virtio --bridge=br0, --autostart --vnc --vncport=5910 --vnclisten=0.0.0.0 virt-install -n njvmwin --vcpus=1 --ram=6411--os-type=windows --os-variant=win2k8 -c /vm/iso/cn_windows_server_2012_r2_sp1_x64.iso --disk path=/usr/share/virtio-win/virtio-win-0.1.126_amd64.vfd,device=floppy --disk path=/vm/win2012.img,format=qcow2,bus=virtio --graphics vnc,listen=0.0.0.0 --noautoconsole vmæ·»åŠ vncç«¯å£ https://www.cnblogs.com/chenjiahe/p/5919742.html\n1 2 3 4 5 \u0026lt;graphics type=\u0026#39;vnc\u0026#39; port=\u0026#39;5900\u0026#39; autoport=\u0026#39;no\u0026#39; listen=\u0026#39;0.0.0.0\u0026#39;\u0026gt; \u0026lt;listen type=\u0026#39;address\u0026#39; address=\u0026#39;0.0.0.0\u0026#39;/\u0026gt; \u0026lt;/graphics\u0026gt; æ³¨æ„\nè¦ç”¨ virsh edit viå‘½ä»¤ä¸ä¼šç”Ÿæ•ˆ\n--name njvm01 \\ #è™šæ‹Ÿæœºå --ram=1024 \\ #åˆ†é…å†…å­˜å¤§å°ï¼ŒMB --vcpus=1 \\ #é…ç½®è™šæ‹Ÿæœºçš„vcpu æ•°ç›® --check-cpu \\ #æ£€æŸ¥ç¡®å®švcpuæ˜¯å¦è¶…è¿‡ç‰©ç† CPUæ•°ç›®ï¼Œå¦‚æœè¶…è¿‡åˆ™å‘å‡ºè­¦å‘Šã€‚ --os-type=linux \\ #è¦å®‰è£…çš„æ“ä½œç³»ç»Ÿç±»å‹ï¼Œä¾‹å¦‚ï¼š\u0026#39;linux\u0026#39;ã€\u0026#39;unix\u0026#39;ã€\u0026#39;windows\u0026#39; --os-variant=rhel6 \\ #æ“ä½œç³»ç»Ÿç‰ˆæœ¬ï¼Œå¦‚ï¼š\u0026#39;Fedora6\u0026#39;, \u0026#39;rhel5\u0026#39;, \u0026#39;solaris10\u0026#39;, \u0026#39;win2k\u0026#39; --disk path=/virhost/node7.img,device=disk,bus=virtio,size=20,sparse=true \\ #è™šæ‹Ÿ æœºæ‰€ç”¨ç£ç›˜æˆ–é•œåƒæ–‡ä»¶ï¼Œsizeå¤§å°G --bridge=br0 \\ #æŒ‡å®šç½‘ç»œï¼Œé‡‡ç”¨é€æ˜ç½‘æ¡¥ --noautoconsole \\ #ä¸è‡ªåŠ¨å¼€å¯æ§åˆ¶å° --pxe #ç½‘ç»œå®‰è£… virsh start njvm01 #å¼€æœº virsh destroy njvm01 #å¼ºåˆ¶å…³é—­ç”µæº virsh shutdown njvm01 #å…³æœº virsh list --all #æŸ¥çœ‹è™šæ‹ŸæœºçŠ¶æ€ virsh reboot njvm01 #é‡å¯ virt-viewer name #æŸ¥çœ‹å®‰è£…çŠ¶æ€ xmlæ–‡ä»¶è¯¦è§£ ä½¿ç”¨virt-install å·¥å…·å®‰è£…è™šæ‹Ÿæœºåï¼Œåœ¨ç›®å½• /etc/libvirt/qemu/ ä¸‹ç”Ÿæˆ xml é…ç½®æ–‡ä»¶\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 \u0026lt;domain type=\u0026#39;kvm\u0026#39;\u0026gt; # è™šæ‹Ÿæœºç±»å‹ \u0026lt;name\u0026gt;centos\u0026lt;/name\u0026gt; è™šæ‹Ÿæœºåç§° \u0026lt;uuid\u0026gt;78dx24ef-1d2d-810x-9213-2c02df529cx\u0026lt;/uuid\u0026gt; uuidå”¯ä¸€æ ‡ç¤º \u0026lt;memory unit=\u0026#39;KiB\u0026#39;\u0026gt;2048576\u0026lt;/memory\u0026gt; æŒ‡å®šè™šæ‹Ÿæœºå†…å­˜å¤§å°ï¼Œç»™å‡ºäº†å•ä½ \u0026lt;vcpu placement=\u0026#39;static\u0026#39;\u0026gt;2\u0026lt;/vcpu\u0026gt; è™šæ‹Ÿæœºå ç”¨è™šæ‹Ÿcpuä¸ªæ•°ï¼Œè¿™é‡ŒæŒ‡ç‰©ç†cpuçš„æ ¸å¿ƒæ•°é‡ \u0026lt;os\u0026gt; \u0026lt;type arch=\u0026#39;x86_64\u0026#39; machine=\u0026#39;rhel6.3.0\u0026#39;\u0026gt;hvm\u0026lt;/type\u0026gt; æŒ‡å®šè™šæ‹Ÿç³»ç»Ÿæ¶æ„ \u0026lt;boot dev=\u0026#39;hd\u0026#39;/\u0026gt; å¯åŠ¨ç±»å‹ï¼Œä»ç¡¬ç›˜å¯åŠ¨ \u0026lt;/os\u0026gt; \u0026lt;devices\u0026gt; \u0026lt;emulator\u0026gt;/usr/libexec/qemu-kvm\u0026lt;/emulator\u0026gt; é©±åŠ¨ç¨‹åºï¼ŒåŒä¸Šï¼Œä½¿ç”¨çš„æ˜¯qemu-kvm \u0026lt;disk type=\u0026#39;file\u0026#39; device=\u0026#39;disk\u0026#39;\u0026gt; æŒ‡å®šç£ç›˜ç±»å‹ \u0026lt;driver name=\u0026#39;qemu\u0026#39; type=\u0026#39;raw\u0026#39; cache=\u0026#39;none\u0026#39;/\u0026gt; æŒ‡å®šç£ç›˜æ ¼å¼ï¼Œè¿™é‡Œæ˜¯rawï¼Œä¹Ÿæ”¯æŒqcow2. \u0026lt;source file=\u0026#39;/home/data/img/centos.img\u0026#39;/\u0026gt; imgæ–‡ä»¶è·¯å¾„ \u0026lt;target dev=\u0026#39;hda\u0026#39; bus=\u0026#39;ide\u0026#39;/\u0026gt; ç£ç›˜æ–‡ä»¶æ ‡ç¤ºï¼Œé©±åŠ¨ç±»å‹ \u0026lt;address type=\u0026#39;drive\u0026#39; controller=\u0026#39;0\u0026#39; bus=\u0026#39;0\u0026#39; target=\u0026#39;0\u0026#39; unit=\u0026#39;0\u0026#39;/\u0026gt; \u0026lt;interface type=\u0026#39;bridge\u0026#39;\u0026gt; \u0026lt;mac address=\u0026#39;34:72:00:15:65:e6\u0026#39;/\u0026gt; è‡ªåŠ¨ç”Ÿæˆï¼Œå¯ä»¥æ‰‹åŠ¨æŒ‡å®šã€‚ \u0026lt;source bridge=\u0026#39;br0\u0026#39;/\u0026gt; æ¡¥æ¥åˆ°å“ªä¸€ä¸ªæ¥å£ \u0026lt;/interface\u0026gt; \u0026lt;/devices\u0026gt; \u0026lt;/domain\u0026gt; åˆ—å‡ºè™šæ‹Ÿæœºçš„æ‰€æœ‰ç½‘å£ virsh domiflist njvm01 ç»“æœå¦‚ä¸‹ï¼š Interface Type Source Model MAC ------------------------------------------------------- vnet0 bridge br0 virtio 34:72:00:15:65:e6 vnet1 bridge br1 virtio 52:54:10:f5:c5:6c æ–°å¢ä¸€ä¸ªç½‘å£ 1 2 3 4 5 6 7 virsh attach-interface domain --type bridge --source br1 --model virtio --config # ä¸‹æ¬¡å¯åŠ¨ç”Ÿæ•ˆ virsh attach-interface domain --type bridge --source br1 --model virtio --current # ç«‹å³ç”Ÿæ•ˆ virsh detach-interface domain --type bridge --mac 34:72:00:15:65:e6 --config # ä¸‹æ¬¡å¯åŠ¨ç”Ÿæ•ˆ virsh detach-interface domain --type bridge --mac 34:72:00:15:65:e6 --current # ç«‹å³ç”Ÿæ•ˆ åˆ é™¤ç½‘å¡å‘½ä»¤ 1 virsh detach-interface njvm01 --type network --mac 34:72:00:15:65:e6 æ°¸ä¹…æ·»åŠ ç½‘å¡ 1 virsh attach-interface domain --type network --source default --model virtio --config ä¸´æ—¶æ·»åŠ ç½‘å¡ virsh attach-interface njvm01 --type network --source default virsh attach-interface njvm01 --type network --source default --config å…³é—­æˆ–æ‰“å¼€æŸä¸ªç½‘å£ 1 2 3 virsh domif-setlink domain vnet0 down virsh domif-setlink domain vnet0 up è·å–æŸä¸ªç½‘å£çŠ¶æ€ 1 virsh domif-getlink win2k8 vnet1 åˆ—å‡ºæ‰€æœ‰çš„å—è®¾å¤‡ 1 virsh domblklist win2k8 ä½œè€…ï¼šSREè¿ç»´åšå®¢\nåšå®¢åœ°å€ï¼š https://www.cnsre.cn/\næ–‡ç« åœ°å€ï¼šhttps://www.cnsre.cn/posts/211115903260/\nç›¸å…³è¯é¢˜ï¼šhttps://www.cnsre.cn/tags/kvm/\n","description":"kvmç®€å•ä½¿ç”¨,kvmå‘½ä»¤è¯¦è§£,kvmé…ç½®æ–‡ä»¶å‚æ•°è¯¦è§£,kvmé…ç½®æ–‡ä»¶","id":22,"section":"posts","tags":["kvm"],"title":"kvmç®€å•ä½¿ç”¨","uri":"http://www.cnsre.cn:80/posts/211115903260/"},{"content":" ä½œè€…ï¼šSREè¿ç»´åšå®¢\nåšå®¢åœ°å€ï¼š https://www.cnsre.cn/\næ–‡ç« åœ°å€ï¼šhttps://www.cnsre.cn/posts/211112839379/\nç›¸å…³è¯é¢˜ï¼šhttps://www.cnsre.cn/tags/shell/\nå‰è¨€ æœ€è¿‘æœ‰å‡ å°æ–°ä¸Šçš„è®¾å¤‡ï¼Œéœ€è¦å®‰è£…jdkå’Œtomcatã€‚ä¸ºäº†é¿å…ä»¥åè¿™ç§é‡å¤çš„åŠ³åŠ¨åŠ›ï¼Œæˆ‘å†³å®šå†™ä¸€ä¸ªè„šæœ¬ï¼Œç›´æ¥æ‰§è¡Œè„šæœ¬å°±å¯ä»¥è‡ªåŠ¨é€‰æ‹©ä½ å®‰è£…çš„jdkä»¥åŠtomcatçš„è„šæœ¬ï¼Œæ¥é¿å…è¿™ç§é—®é¢˜ã€‚\nè„šæœ¬å†…å®¹ æ­¤è„šæœ¬åªé’ˆå¯¹äºcentos7å®Œæˆæµ‹è¯•ï¼Œå…¶ä»–ç‰ˆæœ¬æœªæµ‹è¯•ã€‚ä½¿ç”¨æ—¶è¯·æ³¨æ„ã€‚\nè„šæœ¬å†…å®¹å¦‚ä¸‹\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 #!/bin/bash PATH=/bin:/sbin:/usr/bin:/usr/sbin:/usr/local/bin:/usr/local/sbin:~/bin export PATH LANG=en_US.UTF-8 RD=\u0026#34;\\033[31m\u0026#34; # é”™è¯¯æ¶ˆæ¯ GR=\u0026#34;\\033[32m\u0026#34; # æˆåŠŸæ¶ˆæ¯ YL=\u0026#34;\\033[33m\u0026#34; # å‘Šè­¦æ¶ˆæ¯ BL=\u0026#34;\\033[36m\u0026#34; # æ—¥å¿—æ¶ˆæ¯ PL=\u0026#39;\\033[0m\u0026#39; clear echo -e \u0026#34;${YL}##################################################${PL}\u0026#34; echo -e \u0026#34;${YL}#${PL}${GR}è„šæœ¬åç§°${PL}: ä¸€é”®å®‰è£…javaã€tomcatè„šæœ¬ ${YL}#${PL}\u0026#34; echo -e \u0026#34;${YL}#${PL}${GR}ä½œ è€…${PL}: sreè¿ç»´åšå®¢ ${YL}#${PL}\u0026#34; echo -e \u0026#34;${YL}#${PL}${GR}ç½‘ å€${PL}: www.cnsre.cn ${YL}#${PL}\u0026#34; echo -e \u0026#34;${YL}#${PL}${GR}æ–‡ç« åœ°å€${PL}: https://cnsre.cn/posts/211112839379/ ${YL}#${PL}\u0026#34; echo -e \u0026#34;${YL}##################################################${PL}\u0026#34; sleep 0.5 echo -e \u0026#34;${RD}æœ¬è„šæœ¬å°†ä¼šè‡ªåŠ¨å®‰è£…1.8.0_221ç‰ˆæœ¬jdkä»¥åŠ8.5.23ç‰ˆæœ¬tomcatï¼Œè¯·ç¡®è®¤æ˜¯å¦å®‰è£…ï¼Ÿ${PL}\u0026#34; read -r -p \u0026#34;ç¡®å®šè¯·æŒ‰ y ä»»æ„é”®åˆ™é€€å‡ºï¼è¯·é€‰æ‹©ï¼š[y/n]\u0026#34; input if [[ $input != \u0026#34;y\u0026#34; ]]; then exit 1 else echo -e \u0026#34;${GR}æ­£åœ¨ä¸‹è½½java tomcatå®‰è£…åŒ…,è¯·ç¨å${PL}\u0026#34; fi wget -q -c https://pan.cnsre.cn/d/Package/Linux/jdk/tomcat-8.5.23_jdk1.8.0_221.tar.gz tar -zxf tomcat-8.5.23_jdk1.8.0_221.tar.gz sleep 0.5 echo -e \u0026#34;${RD}æ˜¯å¦ç¡®å®šå®‰è£… 1.8.0_221 ç‰ˆæœ¬ jdk? ${PL}\u0026#34; read -r -p \u0026#34;ç¡®å®šè¯·æŒ‰ y ä»»æ„é”®åˆ™é€€å‡ºï¼è¯·é€‰æ‹©ï¼š[y/n]\u0026#34; input if [[ $input != \u0026#34;y\u0026#34; ]]; then exit 1 else echo -e \u0026#34;${GR}ä½ å·²ç»é€‰æ‹©å®‰è£…1.8.0_221ç‰ˆæœ¬ jdk${PL}\u0026#34; fi read -r -p \u0026#34;è¯·é€‰æ‹©å®‰è£…jdkçš„ç»å¯¹è·¯å¾„ï¼Œè¯·ä¸è¦è¾“å…¥æœ€åçš„\u0026#34;/\u0026#34;:\u0026#34; input if [ ! -d $input ]; then echo -e \u0026#34;${RD}ä½ è¾“å…¥çš„è·¯å¾„ä¸å­˜åœ¨ï¼Œè¯·é‡æ–°è¾“å…¥æˆ–è€…åˆ›å»ºåå†æ¬¡æ‰§è¡Œè„šæœ¬${PL}\u0026#34; exit 1 fi echo -e \u0026#34;${GR}æ­£åœ¨å®‰è£… 1.8.0_221 ç‰ˆæœ¬ jdk${PL}\u0026#34; mv jdk1.8.0_221 $input/jdk cat \u0026lt;\u0026lt; EOF \u0026gt;\u0026gt; /etc/profile ############## JAVA ############## export JAVA_HOME=$input/jdk export JAVA_BIN=$JAVA_HOME/bin export JAVA_LIB=$JAVA_HOME/lib export CLASSPATH=.:$JAVA_LIB/tools.jar:$JAVA_LIB/dt.jar export PATH=$JAVA_BIN:$PATH EOF echo -e \u0026#34;${GR}éªŒJAVA homeåŠç‰ˆæœ¬${PL}\u0026#34; sleep 2 chmod +x $input/jdk/bin/java chmod +x $input/jdk/jre/bin/java source /etc/profile echo -e\u0026#34;${GR}ä½ çš„javaå®‰è£…è·¯å¾„ä¸ºï¼š$JAVA_HOME ${PL}\u0026#34; java -version echo -e \u0026#34;${RD}æ˜¯å¦ç¡®å®šå®‰è£… 8.5.23 ç‰ˆæœ¬ tomcat ? ${PL}\u0026#34; read -r -p \u0026#34;ç¡®å®šè¯·æŒ‰ y ä»»æ„é”®åˆ™é€€å‡ºï¼è¯·é€‰æ‹©ï¼š[y/n]\u0026#34; input if [[ $input != \u0026#34;y\u0026#34; ]]; then exit 1 else echo -e \u0026#34;${GR}ä½ å·²ç»é€‰æ‹©å®‰è£… 8.5.23 ç‰ˆæœ¬ tomcat ${PL}\u0026#34; fi read -r -p \u0026#34;è¯·é€‰æ‹©å®‰è£…tomcatçš„ç»å¯¹è·¯å¾„ï¼Œè¯·ä¸è¦è¾“å…¥æœ€åçš„\u0026#34;/\u0026#34;:\u0026#34; input if [ ! -d $input ]; then echo -e \u0026#34;${RD}ä½ è¾“å…¥çš„è·¯å¾„ä¸å­˜åœ¨ï¼Œè¯·é‡æ–°è¾“å…¥æˆ–è€…åˆ›å»ºåå†æ¬¡æ‰§è¡Œè„šæœ¬${PL}\u0026#34; exit 1 fi echo -e \u0026#34;${GR}æ­£åœ¨å®‰è£… 8.5.23 ç‰ˆæœ¬ tomcat${PL}\u0026#34; mv apache-tomcat-8.5.23 $input/tomcat chmod +x $input/tomcat/bin/*.sh echo -e \u0026#34;${GR}æ­£åœ¨å°†tomcatåŠ å…¥ç³»ç»ŸæœåŠ¡${PL}\u0026#34; sleep 2 touch /usr/lib/systemd/system/tomcat.service cat \u0026lt;\u0026lt; EOF \u0026gt;\u0026gt; /usr/lib/systemd/system/tomcat.service [Unit] Description=Tomcat After=syslog.target network.target remote-fs.target nss-lookup.target [Service] Type=forking ExecStart=$input/tomcat/bin/startup.sh ExecReload=$input/tomcat/bin/startup.sh ExecStop=$input/tomcat/bin/shutdown.sh [Install] WantedBy=multi-user.target EOF sed -i \u0026#39;2i\\export JAVA_HOME=\u0026#39;$JAVA_HOME\u0026#39;\u0026#39; $input/tomcat/bin/catalina.sh systemctl daemon-reload systemctl restart tomcat.service systemctl status tomcat.service echo -e \u0026#34;${RD}è¯·ç¡®è®¤æ˜¯å¦é€‰æ‹©å¼€æœºå¯åŠ¨tomcat ? ${PL}\u0026#34; read -r -p \u0026#34;ç¡®å®šè¯·æŒ‰ y ä»»æ„é”®åˆ™é€€å‡ºï¼è¯·é€‰æ‹©ï¼š[y/n]\u0026#34; input if [[ $input != \u0026#34;y\u0026#34; ]]; then systemctl disable tomcat.service echo -e \u0026#34;${GR}å·²ä¸ºä½ å…³é—­tomcatå¼€æœºå¯åŠ¨ ${PL}\u0026#34; else systemctl enable tomcat.service echo -e \u0026#34;${GR}å·²ä¸ºä½ å¼€å¯tomcatå¼€æœºå¯åŠ¨ ${PL}\u0026#34; fi echo -e \u0026#34;${YL}==================================================================${PL}\u0026#34; echo -e \u0026#34;${GR}tomcatéƒ¨ç½²å®Œæˆå¹¶å¯åŠ¨${PL}\u0026#34; echo -e \u0026#34;${YL}==================================================================${PL}\u0026#34; echo -e \u0026#34;${GR}å¤–ç½‘tomcatåœ°å€: http://$(curl -sS --connect-timeout 10 -m 60 cip.cc |grep IP|awk -F \u0026#39;:[ ]\u0026#39; \u0026#39;{print $2}\u0026#39;):8080${PL}\u0026#34; echo -e \u0026#34;${GR}å†…ç½‘tomcatåœ°å€: http://$(ip addr | grep -E -o \u0026#39;[0-9]{1,3}\\.[0-9]{1,3}\\.[0-9]{1,3}\\.[0-9]{1,3}\u0026#39; | grep -E -v \u0026#34;^127\\.|^255\\.|^0\\.\u0026#34; | head -n 1):8080${PL}\u0026#34; echo -e \u0026#34;${GR}ä½ å¯ä»¥é€šè¿‡ä»¥ä¸‹å‘½ä»¤æ¥ç®¡ç†tomcatæœåŠ¡${PL}\u0026#34; echo -e \u0026#34;${GR}å¯åŠ¨tomcatæœåŠ¡ï¼šsystemctl start tomcat.service${PL}\u0026#34; echo -e \u0026#34;${RD}åœæ­¢tomcatæœåŠ¡ï¼šsystemctl stop tomcat.service${PL}\u0026#34; echo -e \u0026#34;${YL}é‡å¯tomcatæœåŠ¡ï¼šsystemctl restart tomcat.service${PL}\u0026#34; echo -e \u0026#34;${GR}è‹¥æ— æ³•è®¿é—®tomcatï¼Œè¯·æ£€æŸ¥é˜²ç«å¢™/å®‰å…¨ç»„æ˜¯å¦æœ‰æ”¾è¡Œtomcat 8080 ç«¯å£${PL}\u0026#34; echo -e \u0026#34;${GR}==================================================================${PL}\u0026#34; ä½œè€…ï¼šSREè¿ç»´åšå®¢\nåšå®¢åœ°å€ï¼š https://www.cnsre.cn/\næ–‡ç« åœ°å€ï¼šhttps://www.cnsre.cn/posts/211112839379/\nç›¸å…³è¯é¢˜ï¼šhttps://www.cnsre.cn/tags/shell/\n","description":"ä¸€é”®å®‰è£…jdkå’Œtomcatã€‚ç›´æ¥æ‰§è¡Œè„šæœ¬å°±å¯ä»¥è‡ªåŠ¨é€‰æ‹©ä½ å®‰è£…çš„jdkä»¥åŠtomcatçš„è„šæœ¬ï¼Œæ¥é¿å…é¿å…ä»¥åè¿™ç§é‡å¤çš„åŠ³åŠ¨åŠ›è¿™ç§é—®é¢˜ã€‚","id":23,"section":"posts","tags":["shell"],"title":"ä¸€é”®å®‰è£…javaã€tomcatè„šæœ¬","uri":"http://www.cnsre.cn:80/posts/211112839379/"},{"content":" ä½œè€…ï¼šSREè¿ç»´åšå®¢\nåšå®¢åœ°å€ï¼š https://www.cnsre.cn/\næ–‡ç« åœ°å€ï¼šhttps://www.cnsre.cn/posts/211109907029/\nç›¸å…³è¯é¢˜ï¼šhttps://www.cnsre.cn/tags/k3s/\nåŒåä¸€å„å¤§äº‘å‚å•†çº·çº·æ’’ç§å­ç§éŸ­èœï¼ˆæŠ¢ç”¨æˆ·ï¼‰ï¼Œè‰¯å¿ƒäº‘ ä¹Ÿæ˜¯ä¸€å¦‚æ—¢å¾€çš„è‰¯å¿ƒï¼Œæ–°ç”¨æˆ·æ›´æ˜¯é€šè¿‡æŸå® 148 å°±å¯ä»¥ä¹°åˆ°ä¸‰å¹´ 2C4G8M çš„è½»é‡åº”ç”¨æœåŠ¡å™¨ã€‚äºæ˜¯æˆ‘ä¹Ÿå‡ºå”®è–…äº†ç¾Šæ¯›å…¥æ‰‹äº†ä¸€å°ã€‚\nä½†æ˜¯å¯¹äºå„ç§ç»„ä»¶æœ¬èº«å°±å¯¹èµ„æºæ¶ˆè€—æ¯”è¾ƒå¤§çš„ k8s æ¥è¯´ï¼Œè·‘èµ·æ¥è¿˜æ˜¯æœ‰ç‚¹è´¹åŠ›çš„ï¼Œäºæ˜¯æˆ‘æ‰“ç®—å°†è¿™å°å®ä¾‹éƒ¨ç½²ä¸€å°è½»é‡çº§çš„ Kubernetes: k3s\nk8s VS k3s k3s æ˜¯ Rancher æ¨å‡ºçš„è½»é‡çº§ k8sã€‚k3s æœ¬èº«åŒ…å«äº† k8s çš„æºç ï¼Œè€ŒäºŒè¿›åˆ¶åŒ…å´åªæœ‰ 60M ä½†æ˜¯æœ¬è´¨ä¸Šå’Œ k8s æ²¡æœ‰åŒºåˆ«ã€‚ä½†ä¸ºäº†é™ä½èµ„æºå ç”¨ï¼Œk3s å’Œ k8s è¿˜æ˜¯æœ‰ä¸€äº›åŒºåˆ«çš„ï¼Œä¸»è¦æ˜¯ï¼š\nä½¿ç”¨äº†ç›¸æ¯” Docker æ›´è½»é‡çš„ containerd ä½œä¸ºå®¹å™¨è¿è¡Œæ—¶ï¼ˆDocker å¹¶ä¸æ˜¯å”¯ä¸€çš„å®¹å™¨é€‰æ‹©ï¼‰ã€‚ å»æ‰äº† k8s çš„ Legacy, alpha, non-default featuresã€‚ ç”¨ sqlite3 ä½œä¸ºé»˜è®¤çš„å­˜å‚¨ï¼Œè€Œä¸æ˜¯ etcdã€‚ å…¶ä»–çš„ä¸€äº›ä¼˜åŒ–ï¼Œæœ€ç»ˆ k3s åªæ˜¯ä¸€ä¸ª binary æ–‡ä»¶ï¼Œéå¸¸æ˜“äºéƒ¨ç½²ã€‚ã€ æ‰€ä»¥ k3s é€‚ç”¨äºè¾¹ç¼˜è®¡ç®—ï¼ŒIoT ç­‰èµ„æºç´§å¼ çš„åœºæ™¯ã€‚åŒæ—¶ k3s ä¹Ÿæ˜¯éå¸¸å®¹æ˜“éƒ¨ç½²çš„ï¼Œå®˜ç½‘ä¸Šæä¾›äº†ä¸€é”®éƒ¨ç½²çš„è„šæœ¬ã€‚\nk3sçš„ä¼˜ç‚¹ k3så°†å®‰è£…Kubernetesæ‰€éœ€çš„ä¸€åˆ‡æ‰“åŒ…è¿›ä»…æœ‰60MBå¤§å°çš„äºŒè¿›åˆ¶æ–‡ä»¶ä¸­ï¼Œå¹¶ä¸”å®Œå…¨å®ç°äº†Kubernetes APIã€‚ä¸ºäº†å‡å°‘è¿è¡ŒKubernetesæ‰€éœ€çš„å†…å­˜ï¼ŒRancheråˆ é™¤äº†å¾ˆå¤šä¸å¿…è¦çš„é©±åŠ¨ç¨‹åºï¼Œå¹¶ç”¨é™„åŠ ç»„ä»¶å¯¹å…¶è¿›è¡Œæ›¿æ¢ã€‚ k3sæ˜¯ä¸€æ¬¾å®Œå…¨é€šè¿‡CNCFè®¤è¯çš„Kuberneteså‘è¡Œç‰ˆï¼Œè¿™æ„å‘³ç€ä½ å¯ä»¥ç¼–å†™YAMLæ¥å¯¹å®Œæ•´ç‰ˆçš„Kubernetesè¿›è¡Œæ“ä½œï¼Œå¹¶ä¸”å®ƒä»¬ä¹Ÿå°†é€‚ç”¨äºk3sé›†ç¾¤ã€‚ ç”±äºå®ƒåªéœ€è¦æä½çš„èµ„æºå°±å¯ä»¥è¿è¡Œï¼Œå› æ­¤å®ƒèƒ½å¤Ÿåœ¨ä»»ä½•512MB RAMä»¥ä¸Šçš„è®¾å¤‡ä¸Šè¿è¡Œé›†ç¾¤ï¼Œæ¢è¨€ä¹‹ï¼Œæˆ‘ä»¬å¯ä»¥è®©podåœ¨masterå’ŒèŠ‚ç‚¹ä¸Šè¿è¡Œã€‚ k3sçš„ç¼ºç‚¹ é¦–å…ˆï¼Œå½“å‰k3sçš„ç‰ˆæœ¬ï¼ˆk3s v0.8.1ï¼‰ä»…èƒ½è¿è¡Œå•ä¸ªmasterï¼Œè¿™æ„å‘³ç€å¦‚æœä½ çš„masterå®•æœºï¼Œé‚£ä¹ˆä½ å°±æ— æ³•ç®¡ç†ä½ çš„é›†ç¾¤ï¼Œå³ä¾¿å·²æœ‰é›†ç¾¤è¦ç»§ç»­è¿è¡Œã€‚ä½†æ˜¯åœ¨k3s v0.10çš„ç‰ˆæœ¬ä¸­ï¼Œå¤šä¸»æ¨¡å¼å·²ç»æ˜¯å®éªŒæ€§åŠŸèƒ½ï¼Œä¹Ÿè®¸åœ¨ä¸‹ä¸€ä¸ªç‰ˆæœ¬ä¸­èƒ½å¤ŸGAã€‚ å…¶æ¬¡ï¼Œåœ¨å•ä¸ªmasterçš„k3sä¸­ï¼Œé»˜è®¤çš„æ•°æ®å­˜å‚¨æ˜¯SQLiteï¼Œè¿™å¯¹äºå°å‹æ•°æ®åº“ååˆ†å‹å¥½ï¼Œä½†æ˜¯å¦‚æœé­å—é‡å‡»ï¼Œé‚£ä¹ˆSQLiteå°†æˆä¸ºä¸»è¦ç—›ç‚¹ã€‚ä½†æ˜¯ï¼ŒKubernetesæ§åˆ¶å¹³é¢ä¸­å‘ç”Ÿçš„æ›´æ”¹æ›´å¤šæ˜¯ä¸é¢‘ç¹æ›´æ–°éƒ¨ç½²ã€è°ƒåº¦Podç­‰æœ‰å…³ï¼Œå› æ­¤å¯¹äºå°å‹å¼€å‘/æµ‹è¯•é›†ç¾¤è€Œè¨€ï¼Œæ•°æ®åº“ä¸ä¼šé€ æˆå¤ªå¤§è´Ÿè½½ã€‚ ç»“è®º K8så’Œk3så„æœ‰ä¼˜åŠ£ï¼Œä½¿ç”¨åœºæ™¯ä¹Ÿæœ‰æ‰€åŒºåˆ«ï¼Œå› æ­¤ä¸èƒ½ä¸€æ¦‚è€Œè®ºã€‚å¦‚æœä½ è¦è¿›è¡Œå¤§å‹çš„é›†ç¾¤éƒ¨ç½²ï¼Œé‚£ä¹ˆæˆ‘å»ºè®®ä½ é€‰æ‹©ä½¿ç”¨K8sï¼›\nå¦‚æœä½ åƒæˆ‘ä¸€æ ·åªæ˜¯ä¸ºäº†å¼€å‘æˆ–è€…æµ‹è¯•ï¼Œé‚£ä¹ˆé€‰æ‹©k3såˆ™æ˜¯æ€§ä»·æ¯”æ›´é«˜çš„é€‰æ‹©ã€‚\nå®‰è£… k3s ç¡®ä¿ä½ æ˜¯ä¸€å°å¹²å‡€çš„ CentOS7 æœåŠ¡å™¨ã€‚\næŒ‰ç…§æƒ¯ä¾‹å…ˆæ›´æ–°,æ›´æ–°å‰é¡ºä¾¿æŠŠæºæ¢ä¸ºå›½å†…çš„yumæºã€‚\n1 2 3 4 5 # æ”¹å›½å†…yumæº curl -o /etc/yum.repos.d/CentOS-Base.repo http://mirrors.aliyun.com/repo/Centos-7.repo curl -o /etc/yum.repos.d/epel.repo http://mirrors.aliyun.com/repo/epel-7.repo # æ›´æ–° yum update -y ä¿®æ”¹ä¸»æœºå\n1 hostnamectl set-hostname k3s-master ä¿®æ”¹å®Œæ¯•åï¼Œæ–­å¼€é‡è¿ä¸€ä¸‹ã€‚\nâš ï¸ æ³¨æ„\nK3s é»˜è®¤å°†ä½¿ç”¨ containerd ä½œä¸ºå®¹å™¨ç¯å¢ƒï¼Œè¯·åœ¨ä¸‹è¾¹é€‰æ‹© ä½¿ç”¨Dockerå®‰è£… æˆ–è€…ä½¿ç”¨Containerdå®‰è£…ã€‚\nä½¿ç”¨dockerå®‰è£… ä½¿ç”¨containerdå®‰è£… ä½¿ç”¨ docker å®‰è£… 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 # å®‰è£… docker-ce yum remove -y docker docker-client docker-client-latest docker-common docker-latest docker-latest-logrotate docker-logrotate docker-engine yum install -y yum-utils yum-config-manager --add-repo https://download.docker.com/linux/centos/docker-ce.repo yum install -y docker-ce docker-ce-cli containerd.io # è§£å†³å†…æ ¸æ£€æŸ¥é—®é¢˜ é‡å¯ç”Ÿæ•ˆ grubby --args=\u0026#34;user_namespace.enable=1\u0026#34; --update-kernel=\u0026#34;$(grubby --default-kernel)\u0026#34; systemctl enable docker systemctl start docker # ä¿®æ”¹ docker æº cat \u0026lt;\u0026lt; EOF \u0026gt; /etc/docker/daemon.json { \u0026#34;registry-mirrors\u0026#34;:[\u0026#34;https://3laho3y3.mirror.aliyuncs.com\u0026#34;] } EOF systemctl daemon-reload systemctl restart docker # å®‰è£… docker ç»“æŸ # å…³ firewalld é˜²ç«å¢™ systemctl stop firewalld systemctl disable firewalld # å®‰è£… k3s curl -sfL http://rancher-mirror.cnrancher.com/k3s/k3s-install.sh | INSTALL_K3S_MIRROR=cn sh -s - --docker ä½¿ç”¨ containerd å®‰è£… 1 curl -sfL http://rancher-mirror.cnrancher.com/k3s/k3s-install.sh | INSTALL_K3S_MIRROR=cn sh - å®‰è£…å®Œæ£€æŸ¥ å®‰è£…å®Œæˆåï¼Œå¯ä»¥æ‰§è¡Œä»¥ä¸‹å‘½ä»¤è¿›è¡Œä¸»æœºæ£€æŸ¥ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 # è¿è¡Œé…ç½®æ£€æŸ¥ k3s check-config # æŸ¥çœ‹èŠ‚ç‚¹çŠ¶æ€ä»¥åŠ k3s ç‰ˆæœ¬ [root@k3s-master ~]# kubectl get node NAME STATUS ROLES AGE VERSION vm-16-8-centos Ready control-plane,master 52m v1.21.5+k3s2 # æŸ¥çœ‹æ‰€æœ‰ pod ä¿¡æ¯ [root@k3s-master ~]# kubectl get pods -A NAMESPACE NAME READY STATUS RESTARTS AGE kube-system local-path-provisioner-5ff76fc89d-bbps4 1/1 Running 0 52m kube-system coredns-7448499f4d-42v9x 1/1 Running 0 52m kube-system metrics-server-86cbb8457f-xqlrg 1/1 Running 0 52m kube-system helm-install-traefik-crd-9wk9v 0/1 Completed 0 52m kube-system helm-install-traefik-d8llf 0/1 Completed 3 52m kube-system svclb-traefik-jqxvf 2/2 Running 0 49m kube-system traefik-97b44b794-wv6zv 1/1 Running 0 49m æˆªæ­¢åˆ°è¿™é‡Œ k3s å·²ç»å®‰è£…å®Œæ¯•ã€‚\nå®‰è£… nfs å®‰è£… nfs æœåŠ¡ 1 2 yum -y install nfs-utils systemctl start nfs \u0026amp;\u0026amp; systemctl enable nfs åˆ›å»ºnfsç›®å½• 1 mkdir -p /home/k8s/nfs ä¿®æ”¹æƒé™ 1 chmod -R 755 /home/k8s/nfs ç¼–è¾‘exportæ–‡ä»¶ 1 2 3 cat \u0026gt;\u0026gt;/etc/exports \u0026lt;\u0026lt; EOF /home/k8s/nfs *(rw,no_root_squash,sync) EOF é…ç½®ç”Ÿæ•ˆ 1 exportfs -r å¯åŠ¨rpcbindã€nfsæœåŠ¡ 1 2 systemctl restart rpcbind \u0026amp;\u0026amp; systemctl enable rpcbind systemctl restart nfs \u0026amp;\u0026amp; systemctl enable nfs åˆ°è¿™é‡Œ k3s ä»¥åŠ nfs å·²ç»å®‰è£…å®Œæˆï¼Œä¸‹é¢å°±å¯ä»¥å»ä½“éªŒäº†ã€‚\nå¦‚æœæƒ³ä»¥ä¸Šéƒ½æ¯”è¾ƒéº»çƒ¦ï¼Œä½ å¯ä»¥ç”¨ä¸‹é¢çš„ä¸€é”®å®‰è£…è„šæœ¬æ¥æ‰§è¡Œ\nä¸€é”®å®‰è£… k3s è„šæœ¬ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 #!/bin/bash PATH=/bin:/sbin:/usr/bin:/usr/sbin:/usr/local/bin:/usr/local/sbin:~/bin export PATH LANG=en_US.UTF-8 RD=\u0026#34;\\033[31m\u0026#34; # é”™è¯¯æ¶ˆæ¯ GR=\u0026#34;\\033[32m\u0026#34; # æˆåŠŸæ¶ˆæ¯ YL=\u0026#34;\\033[33m\u0026#34; # å‘Šè­¦æ¶ˆæ¯ BL=\u0026#34;\\033[36m\u0026#34; # æ—¥å¿—æ¶ˆæ¯ PL=\u0026#39;\\033[0m\u0026#39; clear echo -e \u0026#34;${YL}##################################################${PL}\u0026#34; echo -e \u0026#34;${YL}#${PL} ${GR}è„šæœ¬åç§°${PL}: ä¸€é”®å®‰è£… k3s è„šæœ¬ ${YL}#${PL}\u0026#34; echo -e \u0026#34;${YL}#${PL} ${GR}ä½œ è€…${PL}: sreè¿ç»´åšå®¢ ${YL}#${PL}\u0026#34; echo -e \u0026#34;${YL}#${PL} ${GR}ç½‘ å€${PL}: https:www.cnsre.cn ${YL}#${PL}\u0026#34; echo -e \u0026#34;${YL}#${PL} ${GR}æ–‡ç« åœ°å€${PL}: https://cnsre.cn/posts/211109907029/ ${YL}#${PL}\u0026#34; echo -e \u0026#34;${YL}##################################################${PL}\u0026#34; sleep 0.5 set -e echo echo echo echo -e \u0026#34;${RD}æ˜¯å¦ç¡®å®šå®‰è£… dockerbç‰ˆæœ¬çš„ k3s? ${PL}\u0026#34; read -r -p \u0026#34;ç¡®å®šè¯·æŒ‰ y ä»»æ„é”®åˆ™é€€å‡ºï¼è¯·é€‰æ‹©ï¼š[y/n]\u0026#34; input if [[ $input != \u0026#34;y\u0026#34; ]]; then exit 1 else echo -e \u0026#34;$GRæ­£åœ¨å¼€å§‹å®‰è£… dockerbç‰ˆæœ¬çš„ k3s$PL\u0026#34; fi if [ `command -v docker` ];then echo -e \u0026#34;${YL}docker å·²ç»å®‰è£…,æ­£åœ¨æ·»åŠ dockeråŠ é€Ÿæº${PL}\u0026#34; else echo -e \u0026#34;${GR}install docker${PL}\u0026#34; curl https://download.daocloud.io/docker/linux/centos/docker-ce.repo -o /etc/yum.repos.d/docker-ce.repo yum -y install https://download.daocloud.io/docker/linux/centos/7/x86_64/stable/Packages/containerd.io-1.2.6-3.3.el7.x86_64.rpm curl -fsSL https://get.daocloud.io/docker | bash -s docker --mirror Aliyun fi sudo mkdir -p /etc/docker tee /etc/docker/daemon.json \u0026lt;\u0026lt;-\u0026#39;EOF\u0026#39; { \u0026#34;registry-mirrors\u0026#34;: [\u0026#34;http://f1361db2.m.daocloud.io\u0026#34;] } EOF grubby --args=\u0026#34;user_namespace.enable=1\u0026#34; --update-kernel=\u0026#34;$(grubby --default-kernel)\u0026#34; sudo systemctl daemon-reload sudo systemctl restart docker sudo systemctl enable docker if [ `command -v k3s` ];then echo -e \u0026#34;${YL}k3s å·²ç»å®‰è£…${PL}\u0026#34; exit 1 else export K3S_NODE_NAME=${HOSTNAME//_/-} export INSTALL_K3S_EXEC=\u0026#34;--docker --kube-apiserver-arg service-node-port-range=1-65000 --no-deploy traefik --write-kubeconfig ~/.kube/config --write-kubeconfig-mode 666\u0026#34; curl -sfL http://rancher-mirror.cnrancher.com/k3s/k3s-install.sh | INSTALL_K3S_MIRROR=cn sh - fi echo -e \u0026#34;${GR}export K3S_TOKEN=$(cat /var/lib/rancher/k3s/server/node-token)${PL}\u0026#34; echo -e \u0026#34;${GR}export K3S_URL=https://$(ip addr | grep -E -o \u0026#39;[0-9]{1,3}\\.[0-9]{1,3}\\.[0-9]{1,3}\\.[0-9]{1,3}\u0026#39; | grep -E -v \u0026#34;^127\\.|^255\\.|^0\\.\u0026#34; | head -n 1):6443${PL}\u0026#34; echo -e \u0026#34;${GR}å®‰è£…ç»“æŸï¼Œè¯·é‡å¯æœåŠ¡å™¨${PL}\u0026#34; read -r -p \u0026#34;ç¡®å®šè¯·æŒ‰ y ä»»æ„é”®åˆ™é€€å‡ºï¼è¯·é€‰æ‹©ï¼š[y/n]\u0026#34; input if [[ $input != \u0026#34;y\u0026#34; ]]; then reboot else exit 1 fi ä½œè€…ï¼šSREè¿ç»´åšå®¢\nåšå®¢åœ°å€ï¼š https://www.cnsre.cn/\næ–‡ç« åœ°å€ï¼šhttps://www.cnsre.cn/posts/211109907029/\nç›¸å…³è¯é¢˜ï¼šhttps://www.cnsre.cn/tags/k3s/\n","description":"k3så•æœºç‰ˆå®‰è£…éƒ¨ç½²ï¼Œé™„ä¸€é”®å®‰è£…è„šæœ¬","id":24,"section":"posts","tags":["k3s","shell","kubernetes"],"title":"k3så•æœºç‰ˆå®‰è£…éƒ¨ç½² é™„ä¸€é”®å®‰è£…è„šæœ¬","uri":"http://www.cnsre.cn:80/posts/211109907029/"},{"content":" ä½œè€…ï¼šSREè¿ç»´åšå®¢\nåšå®¢åœ°å€ï¼š https://www.cnsre.cn/\næ–‡ç« åœ°å€ï¼šhttps://www.cnsre.cn/posts/211108848062/\nç›¸å…³è¯é¢˜ï¼šhttps://www.cnsre.cn/tags/kvm/\nå®‰è£…å‰å‡†å¤‡ éªŒè¯CPUæ˜¯å¦æ”¯æŒKVM å¦‚æœç»“æœä¸­æœ‰vmxï¼ˆIntelï¼‰æˆ–svm(AMD)å­—æ ·ï¼Œå°±è¯´æ˜CPUçš„æ”¯æŒçš„ã€‚\n1 egrep \u0026#39;(vmx|svm)\u0026#39; /proc/cpuinfo å…³é—­SELinux å°† /etc/sysconfig/selinux ä¸­çš„ SELinux=enforcing ä¿®æ”¹ä¸º SELinux=disabled å®‰è£…ä¸€äº›æœ€åŸºæœ¬çš„æœåŠ¡ å¯é€‰é¡¹ï¼Œå› ä¸ºæˆ‘æ˜¯åˆšå®‰è£…å¥½çš„CentOSï¼Œæ‰€ä»¥ä¸ºäº†ä¸‹é¢æ–¹ä¾¿ç‚¹ï¼Œå…ˆæŠŠä¸€äº›å¿…è¦çš„å·¥å…·å®‰è£…ä¸‹\n1 yum install epel-release net-tools vim unzip zip wget ftp -y å®‰è£…KVMåŠå…¶ä¾èµ–é¡¹ 1 yum install qemu-kvm libvirt virt-install bridge-utils -y éªŒè¯å®‰è£…ç»“æœ ä¸‹å›¾è¯´æ˜å·²ç»æˆåŠŸå®‰è£…äº†\n1 lsmod | grep kvm å¼€å¯kvmæœåŠ¡ å¹¶ä¸”è®¾ç½®å…¶å¼€æœºè‡ªåŠ¨å¯åŠ¨\n1 systemctl start libvirtd systemctl enable libvirtd æŸ¥çœ‹çŠ¶æ€æ“ä½œç»“æœ å¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œè¯´æ˜è¿è¡Œæƒ…å†µè‰¯å¥½\n1 systemctl status libvirtd 1 systemctl is-enabled libvirtd é…ç½®ç½‘æ¡¥æ¨¡å¼ å…ˆå°† /etc/sysconfig/network-scripts/ ç›®å½•ä¸‹çš„ç½‘å¡é…ç½®æ–‡ä»¶å¤‡ä»½ä¸€ä»½\nåˆ›å»º ifcfg-br0 æ–‡ä»¶ åˆ›å»ºçš„ br0æ–‡ä»¶çš„IPåœ°å€è¦å’Œç‰©ç†ç½‘å¡çš„IPåœ°å€ä¸€è‡´ï¼Œå‘½ä»¤ ipconfig æŸ¥çœ‹ç‰©ç†ç½‘å¡å°†ä¸ä¼šæ˜¾ç¤ºIP\nå†…å®¹å¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 [root@bogon ~]*# vim /etc/sysconfig/network-scripts/ifcfg-br0* DEVICE=br0 BOOTPROTO=none DEFROUTE=yes ONBOOT=yes TYPE=Bridge IPV4_FAILURE_FATAL=yes IPADDR=192.168.1.130 NETMASK=255.255.255.0 GATEWAY=192.168.1.254 DNS1=221.6.4.66 DELAY=0 USERCE=no ä¿®æ”¹åŸç½‘å¡é…ç½® 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 vim /etc/sysconfig/network-scripts/ifcfg-eno1s TYPE=\u0026#34;Ethernet\u0026#34; PROXY_METHOD=\u0026#34;none\u0026#34; BROWSER_ONLY=\u0026#34;no\u0026#34; BOOTPROTO=\u0026#34;static\u0026#34; DEFROUTE=\u0026#34;yes\u0026#34; IPV4_FAILURE_FATAL=\u0026#34;YES\u0026#34; IPV6INIT=\u0026#34;yes\u0026#34; IPV6_AUTOCONF=\u0026#34;yes\u0026#34; IPV6_DEFROUTE=\u0026#34;yes\u0026#34; IPV6_FAILURE_FATAL=\u0026#34;no\u0026#34; IPV6_ADDR_GEN_MODE=\u0026#34;stable-privacy\u0026#34; NAME=\u0026#34;eno1\u0026#34; UUID=\u0026#34;bb40d726-8d67-4187-90c3-eb61e1b42d61\u0026#34; DEVICE=\u0026#34;eno1\u0026#34; ONBOOT=\u0026#34;yes\u0026#34; IPADDR=\u0026#34;192.168.1.130\u0026#34; NETAMSK=255.255.255.0 GATEWAY=\u0026#34;192.168.1.254\u0026#34; DNS1=\u0026#34;221.6.4.66\u0026#34; IPV6_PRIVACY=\u0026#34;no\u0026#34; BRIDGE=br0 é‡å¯ç½‘ç»œæœåŠ¡ 1 systemctl restart network ä½¿ç”¨ ifconfig éªŒè¯æ“ä½œç»“æœ,å¤šäº†ä¸€å—ç½‘å¡ br0 ï¼Œç°åœ¨è®¿é—®å®¿ä¸»æœº ä½¿ç”¨ 192.168.1.130 å°±å¯ä»¥äº†ã€‚\n\u0026lt;scriptÂ asyncÂ src=\u0026ldquo;","description":"kvmå®‰è£…windowsè™šæ‹Ÿæœºï¼Œkvmå®‰è£…windowsè™šæ‹Ÿæœºæ‰¾ä¸åˆ°ç¡¬ç›˜ï¼Œkvmå®‰è£…windowsè™šæ‹Ÿæœºæ‰¾ä¸åˆ°ç½‘å¡ï¼Œkvmå®‰è£…windowsè™šæ‹ŸæœºæŠ¥é”™ï¼Œkvmå®‰è£…widnows2012","id":25,"section":"posts","tags":["kvm","vnc"],"title":"kvm å®‰è£… windows è™šæ‹Ÿæœº","uri":"http://www.cnsre.cn:80/posts/211108848062/"},{"content":" ä½œè€…ï¼šSREè¿ç»´åšå®¢\nåšå®¢åœ°å€ï¼š https://www.cnsre.cn/\næ–‡ç« åœ°å€ï¼šhttps://www.cnsre.cn/posts/211105852095/\nç›¸å…³è¯é¢˜ï¼šhttps://www.cnsre.cn/tags/kvm/\næœ¬æ–‡å°†ä»‹ç»centos7 ç¯å¢ƒå¦‚ä½•æ­å»ºä¸€ä¸ªkvm ç¯å¢ƒå¹¶ä¸”åˆ›å»ºwindowsï¼Œlinuxç­‰è™šæ‹Ÿæœºã€‚\nå®‰è£…å‰å‡†å¤‡ éªŒè¯CPUæ˜¯å¦æ”¯æŒKVM å¦‚æœç»“æœä¸­æœ‰vmxï¼ˆIntelï¼‰æˆ–svm(AMD)å­—æ ·ï¼Œå°±è¯´æ˜CPUçš„æ”¯æŒçš„ã€‚\n1 egrep \u0026#39;(vmx|svm)\u0026#39; /proc/cpuinfo å…³é—­SELinux å°† /etc/sysconfig/selinux ä¸­çš„ SELinux=enforcing ä¿®æ”¹ä¸º SELinux=disabled å®‰è£…ä¸€äº›æœ€åŸºæœ¬çš„æœåŠ¡ å¯é€‰é¡¹ï¼Œå› ä¸ºæˆ‘æ˜¯åˆšå®‰è£…å¥½çš„CentOSï¼Œæ‰€ä»¥ä¸ºäº†ä¸‹é¢æ–¹ä¾¿ç‚¹ï¼Œå…ˆæŠŠä¸€äº›å¿…è¦çš„å·¥å…·å®‰è£…ä¸‹\n1 yum install epel-release net-tools vim unzip zip wget ftp -y å®‰è£…KVMåŠå…¶ä¾èµ–é¡¹ 1 yum install qemu-kvm libvirt virt-install bridge-utils -y éªŒè¯å®‰è£…ç»“æœ ä¸‹å›¾è¯´æ˜å·²ç»æˆåŠŸå®‰è£…äº†\n1 lsmod | grep kvm å¼€å¯kvmæœåŠ¡ å¹¶ä¸”è®¾ç½®å…¶å¼€æœºè‡ªåŠ¨å¯åŠ¨\n1 systemctl start libvirtd systemctl enable libvirtd æŸ¥çœ‹çŠ¶æ€æ“ä½œç»“æœ å¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œè¯´æ˜è¿è¡Œæƒ…å†µè‰¯å¥½\n1 systemctl status libvirtd 1 systemctl is-enabled libvirtd é…ç½®ç½‘æ¡¥æ¨¡å¼ å…ˆå°† /etc/sysconfig/network-scripts/ ç›®å½•ä¸‹çš„ç½‘å¡é…ç½®æ–‡ä»¶å¤‡ä»½ä¸€ä»½\nåˆ›å»º ifcfg-br0 æ–‡ä»¶ åˆ›å»ºçš„ br0æ–‡ä»¶çš„IPåœ°å€è¦å’Œç‰©ç†ç½‘å¡çš„IPåœ°å€ä¸€è‡´ï¼Œå‘½ä»¤ ipconfig æŸ¥çœ‹ç‰©ç†ç½‘å¡å°†ä¸ä¼šæ˜¾ç¤ºIP\nå†…å®¹å¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 [root@bogon ~]# vim /etc/sysconfig/network-scripts/ifcfg-br0 DEVICE=br0 BOOTPROTO=none DEFROUTE=yes ONBOOT=yes TYPE=Bridge IPV4_FAILURE_FATAL=yes IPADDR=192.168.1.130 NETMASK=255.255.255.0 GATEWAY=192.168.1.254 DNS1=221.6.4.66 DELAY=0 USERCE=no ä¿®æ”¹åŸç½‘å¡é…ç½® 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 vim /etc/sysconfig/network-scripts/ifcfg-eno1s TYPE=\u0026#34;Ethernet\u0026#34; PROXY_METHOD=\u0026#34;none\u0026#34; BROWSER_ONLY=\u0026#34;no\u0026#34; BOOTPROTO=\u0026#34;static\u0026#34; DEFROUTE=\u0026#34;yes\u0026#34; IPV4_FAILURE_FATAL=\u0026#34;YES\u0026#34; IPV6INIT=\u0026#34;yes\u0026#34; IPV6_AUTOCONF=\u0026#34;yes\u0026#34; IPV6_DEFROUTE=\u0026#34;yes\u0026#34; IPV6_FAILURE_FATAL=\u0026#34;no\u0026#34; IPV6_ADDR_GEN_MODE=\u0026#34;stable-privacy\u0026#34; NAME=\u0026#34;eno1\u0026#34; UUID=\u0026#34;bb40d726-8d67-4187-90c3-eb61e1b42d61\u0026#34; DEVICE=\u0026#34;eno1\u0026#34; ONBOOT=\u0026#34;yes\u0026#34; IPADDR=\u0026#34;192.168.1.130\u0026#34; NETAMSK=255.255.255.0 GATEWAY=\u0026#34;192.168.1.254\u0026#34; DNS1=\u0026#34;221.6.4.66\u0026#34; IPV6_PRIVACY=\u0026#34;no\u0026#34; BRIDGE=br0 é‡å¯ç½‘ç»œæœåŠ¡ 1 systemctl restart network ä½¿ç”¨ ifconfig éªŒè¯æ“ä½œç»“æœ,å¤šäº†ä¸€å—ç½‘å¡ br0 ï¼Œç°åœ¨è®¿é—®å®¿ä¸»æœº ä½¿ç”¨ 192.168.1.130 å°±å¯ä»¥äº†ã€‚\nå®‰è£…è™šæ‹Ÿæœº å‡†å¤‡æ“ä½œç³»ç»Ÿå®‰è£…é•œåƒæ–‡ä»¶ åœ¨æœ¬æ–‡ä¸­å°†ä½¿ç”¨å’Œå®¿ä¸»ç¯å¢ƒä¸€æ ·çš„ CentOS7.2ï¼ŒæŠŠè¯¥æ–‡ä»¶æ”¾åˆ° /home/iso ç›®å½•ä¸‹\næŒ‚è½½Uç›˜\n1 2 3 4 5 6 7 8 9 10 [root@nkgtsv01 ~]# yum install fuse-ntfs-3g -y [root@nkgtsv01 ~]# ls /mnt/ udisk usb [root@nkgtsv01 ~]# ls /mnt/udisk/ CentOS-7.2-x86_64-DVD-1611.iso CentOS-7-x86_64-DVD-1708.iso maven_storey2.zip [root@bogon data]# mkdir -p /data/iso [root@bogon data]# ls iso kvm-bak network [root@nkgtsv01 ~]# mount -o loop /mnt/udisk/CentOS-7-x86_64-DVD-1708.iso /data/iso/ mount: /dev/loop0 å†™ä¿æŠ¤ï¼Œå°†ä»¥åªè¯»æ–¹å¼æŒ‚è½½ åˆ›å»ºè™šæ‹Ÿæœºæ–‡ä»¶å­˜æ”¾çš„ç›®å½• 1 mkdir -p /data/kvm-images ä½¿ç”¨ virt-install åˆ›å»ºè™šæ‹Ÿæœº 1 virt-install --virt-type=kvm --name=njkvm07 --vcpus=4 --memory=6000 --location=/data/iso/CentOS-7-x86-64-DVD-1708.iso --disk path=/data/kvm-images/njkvm07.qcow2,size=200,format=qcow2 --network bridge=br0 --graphics none --extra-args=\u0026#39;console=ttyS0\u0026#39; --force æ‰§è¡Œå®Œè¿™æ®µå‘½ä»¤\næ„Ÿå¹å·ä¸ºå¾…é€‰é¡¹\ncä¿å­˜ qé€€å‡º bå¼€å§‹æ‰§è¡Œå®‰è£…\né€‰æ‹©åœ°åŒºæ—¶é—´\né€‰åˆ™ä¹‹åcä¿å­˜\nè‡ªåŠ¨è¿”å›ä¸»é¡µé¢\né€‰æ‹©ç¡¬ç›˜\né€‰æ‹©åˆ°ç¡¬ç›˜ cä¿å­˜\nå…¨æ–°å®‰è£… Cä¿å­˜\né€‰åˆ™æ·»åŠ IPåœ°å€å’Œæ·»åŠ ä¸»æœºåç§°\nè¾“å…¥ å›è½¦\næ·»åŠ IPåœ°å€\né€‰åˆ™ipv4\næ·»åŠ IPåœ°å€å›è½¦\næ·»åŠ netmask gateway c ä¿å­˜\næ·»åŠ å¯†ç \nBå¼€å§‹æ‰§è¡Œå®‰è£…\nå®‰è£…å®Œæˆ\nå®¿ä¸»æœºç›´æ¥è¿æ¥åˆ°è™šæ‹Ÿæœº\nç­‰å¾…é‡å¯è™šæ‹Ÿæœºï¼Œè™šæ‹Ÿæœºèµ·å¼€ä¹‹åç›´æ¥è¿œç¨‹å°±okäº† ã€‚\nvirt-cloneå…‹éš†è™šæ‹Ÿæœº ä½¿ç”¨ virt-clone å…‹éš†æ–°çš„è™šæ‹Ÿæœº ï¼ˆè™šæ‹Ÿæœºéœ€è¦å…ˆå…³é—­ï¼‰\n1 virt-clone -o njvm02 -n njvm03 -f /data/kvm-img/njvm03.img å…‹éš†å®ŒæŸ¥çœ‹ æ‰€æœ‰çš„è™šæ‹Ÿæœºä»¥åŠçŠ¶æ€\n1 virsh list --all åˆ é™¤è™šæ‹Ÿæœº njvm01\n1 2 virsh undefine njvm01 virsh destroy njvm01 âš ï¸ æ³¨æ„\nå–æ¶ˆå®šä¹‰ åˆ é™¤ä»¥åè¦æ‰¾åˆ°è™šæ‹Ÿæœºæ–‡ä»¶è·¯å¾„å§è™šæ‹Ÿæœºæ–‡ä»¶ä¹Ÿåˆ é™¤æ‰\n1 2 3 4 5 [root@nkgtsv01 data]# virsh shutdown njvm01 åŸŸ njvm01 è¢«å…³é—­ [root@nkgtsv01 data]# virsh start njvm02 åŸŸ njvm02 å·²å¼€å§‹ [root@nkgtsv01 data]# virsh list --all âš ï¸ æ³¨æ„\nå…‹éš†å®Œä»¥åå› ä¸ºIPåœ°å€è¿˜æ˜¯njvm01çš„IPåœ°å€æ‰€ä»¥æˆ‘ä»¬è¦ä¿®æ”¹IPåœ°å€\nå¼€å¯æˆ‘ä»¬å…‹éš†çš„è™šæ‹Ÿæœº\nè¿œç¨‹ç™»é™†ä¸Šå»\n1 2 3 4 5 6 7 8 9 10 11 12 [root@nkgtsv-vm01 ~]# cd /etc/sysconfig/network-scripts/ [root@nkgtsv-vm01 network-scripts]# ls ifcfg-eth0 ifdown-ppp ifup-eth ifup-sit ifcfg-lo ifdown-routes ifup-ippp ifup-Team ifdown ifdown-sit ifup-ipv6 ifup-TeamPort ifdown-bnep ifdown-Team ifup-isdn ifup-tunnel ifdown-eth ifdown-TeamPort ifup-plip ifup-wireless ifdown-ippp ifdown-tunnel ifup-plusb init.ipv6-global ifdown-ipv6 ifup ifup-post network-functions ifdown-isdn ifup-aliases ifup-ppp network-functions-ipv6 ifdown-post ifup-bnep ifup-routes [root@nkgtsv-vm01 network-scripts]# vim ifcfg-eth0 IPADDR=192.168.1.121 æ”¹ä¸ºæˆ‘ä»¬æƒ³è¦çš„IPåœ°å€\nä¿å­˜é€€å‡º\nService network restart\né‡å¯ç½‘ç»œ\né‡æ–°é“¾æ¥\nå‚è€ƒæ–‡æ¡£ï¼š\nhttp://www.linuxidc.com/Linux/2017-01/140007.htm\nhttp://blog.csdn.net/u011414200/article/details/47310827\nhttps://www.cnblogs.com/5201351/p/4445199.html\nhttp://blog.51cto.com/7834466/2064277\nhttps://www.cnblogs.com/Yemilice/p/8080688.html\nä½œè€…ï¼šSREè¿ç»´åšå®¢\nåšå®¢åœ°å€ï¼š https://www.cnsre.cn/\næ–‡ç« åœ°å€ï¼šhttps://www.cnsre.cn/posts/211105852095/\nç›¸å…³è¯é¢˜ï¼šhttps://www.cnsre.cn/tags/kvm/\n","description":"æœ¬æ–‡å°†ä»‹ç»centos7 ç¯å¢ƒå¦‚ä½•æ­å»ºä¸€ä¸ªkvm ç¯å¢ƒå¹¶ä¸”åˆ›å»ºè™šæ‹Ÿæœºç­‰ã€‚","id":26,"section":"posts","tags":["kvm"],"title":"Centos7æ­å»º KVM å‘½ä»¤è¡Œå®‰è£…è™šæ‹Ÿæœº","uri":"http://www.cnsre.cn:80/posts/211105852095/"},{"content":" ä½œè€…ï¼šSREè¿ç»´åšå®¢\nåšå®¢åœ°å€ï¼š https://www.cnsre.cn/\næ–‡ç« åœ°å€ï¼šhttps://www.cnsre.cn/posts/211103006342/\nç›¸å…³è¯é¢˜ï¼šhttps://www.cnsre.cn/tags/zabbix/\nç¯å¢ƒå‡†å¤‡ zabbix-agent python2.7 pip å®‰è£…python æ¨¡å— pip2.7 install boto3 pip install awscli éƒ¨ç½²pyè„šæœ¬ gitåœ°å€ ï¼šhttps://github.com/datorama/zabbix_rds_template\n# å…‹éš†æ¨¡æ¿ git clone https://github.com/datorama/zabbix_rds_template.git # è¿›å…¥æ¨¡æ¿ç›®å½• cd zabbix_rds_template # å¯ä»¥çœ‹åˆ°ä¸€ä¸‹å†…å®¹ zabbixç”¨çš„pyä¸ºè„šæœ¬ xml ä¸ºzabbix webç«¯çš„æ¨¡æ¿ rds_stats.py rds_template.xml README.md # æŠŠzabbixéœ€è¦ç”¨çš„è„šæœ¬æ”¾åœ¨zabbix æ‰§è¡Œè„šæœ¬çš„ç›®å½• cp rds_stats.py usr/local/share/zabbix/externalscripts cd usr/local/share/zabbix/externalscripts chmod +x rds_stats.py # ç»™æ‰§è¡Œæƒé™ å‡†å¤‡å¯†é’¥ID å’Œè®¿é—®å¯†é’¥ Access key ID Secret access key AKxxxxxxxxxxxxxxxxx SKxxxxxxxxxxxxxxxxx # æ‰§è¡Œå‘½ä»¤ aws configure # é…ç½®è®¿é—®ç§˜é’¥ã€ç§æœ‰è®¿é—®ç§˜é’¥ã€å¯ç”¨åŒºåŸŸç­‰ï¼Œæœ€åçš„æ ¼å¼ä¸ºjsonæ ¼å¼ æ·»åŠ ä¸»æœºæ¨¡æ¿ å…ˆå¯¼å…¥æ¨¡æ¿rds_template.xml\næ·»åŠ ä¸»æœº å¡«å…¥ä¸»æœºåç§° dns åç§°ä¸ºRDSçš„ Endpoint\næ·»åŠ æ¨¡æ¿\nåœ¨æ¨¡æ¿çš„å®éƒ¨åˆ†{$ AWS_ACCESS_KEY} ï¼Œ{$ AWS_SECRET_KEY}ä¸­è¾“å…¥awsçš„akskæˆ–å°†å…¶ç•™ç©ºä»¥ä½¿ç”¨IAMè§’è‰²\nåœ¨æ¨¡æ¿çš„å®éƒ¨åˆ†{$ REGION}ä¸­è®¾ç½®é»˜è®¤çš„AWSåŒºåŸŸ\n{$ AWS_ACCESS_KEY} = AKxxxxxxxxxxxxxxxxx {$ AWS_SECRET_KEY} = SKxxxxxxxxxxxxxxxxx {$ REGION} = cn-north-1 ç‚¹å‡»æ·»åŠ  ç­‰å¾…æ•°æ®\nâš ï¸ æ³¨æ„\néœ€è¦æ³¨æ„çš„ç‚¹æ˜¯ è¦å®‰è£…pyçš„ä¸€äº›æ¨¡å—ã€‚\nä½œè€…ï¼šSREè¿ç»´åšå®¢\nåšå®¢åœ°å€ï¼š https://www.cnsre.cn/\næ–‡ç« åœ°å€ï¼šhttps://www.cnsre.cn/posts/211103006342/\nç›¸å…³è¯é¢˜ï¼šhttps://www.cnsre.cn/tags/zabbix/\n","description":"å…¬å¸ç”¨äº†zabbixç›‘æ§ï¼Œä¸»è¦ç›‘æ§ä¹Ÿæ˜¯zabbixï¼Œä¸ºäº†èƒ½åœ¨åŒä¸€ä¸ªå¹³å°ä¸Šçœ‹åˆ°æ‰€æœ‰çš„æœåŠ¡ä¿¡æ¯ï¼Œéœ€è¦ç”¨zabbix ç›‘æ§ aws rds æ•°æ®åº“ã€‚","id":27,"section":"posts","tags":["aws","zabbix"],"title":"zabbix ç›‘æ§ aws rds æ•°æ®åº“","uri":"http://www.cnsre.cn:80/posts/211103006342/"},{"content":" ä½œè€…ï¼šSREè¿ç»´åšå®¢\nåšå®¢åœ°å€ï¼š https://www.cnsre.cn/\næ–‡ç« åœ°å€ï¼šhttps://www.cnsre.cn/posts/211101950005/\nç›¸å…³è¯é¢˜ï¼šhttps://www.cnsre.cn/tags/zabbix/\nå‰è¨€ä»‹ç» éœ€è¦å¯¹é¡µé¢ url å¯¹é¡µé¢çš„å»¶è¿Ÿï¼Œè®¿é—®æ—¶é—´è¿›è¡Œç›‘æ§ã€‚å¦‚æœé¡µé¢ä¸æ˜¯æ­£å¸¸çš„çŠ¶æ€å°±å‘é€å‘Šè­¦ã€‚åŸºäºè¿™ä¸ªéœ€æ±‚ï¼Œä½¿ç”¨zabbix å¯¹url çš„è¿›è¡Œç›‘æ§ï¼Œä½¿ç”¨çš„æ˜¯zabbix çš„webç›‘æ§åŠŸèƒ½ã€‚\né€‰æ‹©ä¸»æœºæ·»åŠ åº”ç”¨é›† é€‰åœ¨ç›¸åº”ä¸»æœºï¼Œå¹¶æ·»åŠ Webç›‘æ§ æŒ‰ç…§æ–¹å¼æ–°å»ºWebåœºæ™¯\næ³¨æ„ï¼š\nåç§°ç»Ÿä¸€è§„åˆ™ï¼šç›¸åº”çš„åŸŸå\nåº”ç”¨é›†ï¼šé€‰æ‹©ä¹‹å‰åˆ›å»ºçš„ æˆ–è€… æ–°å»ºä¸€ä¸ªï¼Œåç§°ä¸ºURL å‘Šè­¦\næ›´æ–°é—´éš”ï¼šé»˜è®¤ä¸º1m\nå°è¯•æ¬¡æ•°ï¼šé»˜è®¤1æ¬¡\nå®¢æˆ·ç«¯ï¼šé€‰æ‹©IE 11.0\nâ€‹ æ·»åŠ \næ·»åŠ æ­¥éª¤ âš ï¸æ³¨æ„ï¼š åç§°ä½¿ç”¨å’Œåœºæ™¯åç§°ä¸€æ ·å³å¯ï¼šåŸŸååœ°å€\nURLï¼šå¤åˆ¶nagiosçš„URLåœ°å€ï¼Œå°†åŸŸåæ›¿æ¢ä¸ºzabbixä¸Šçš„å®:ç«¯å£{HOST.IP}:80\nå¦‚ï¼šhttp://http://download.tujia.com/monitor.html\nå†™ä¸ºï¼šhttp://http://{HOST.IP}/monitor.html\nPSï¼šå¦‚æœåœ°å€ä¸º https è®¿é—®ï¼Œæ­¤å¤„ç›´æ¥å†™httpå³å¯\nå¤´éƒ¨ï¼š\nåç§°ï¼šhost\nå€¼ï¼šå¡«å†™ä¸ºç›‘æ§é¡µé¢çš„åŸŸåï¼Œå¦‚æ­¤ä¾‹ä¸­çš„ download.tujia.com\nè¦æ±‚çš„å­—ç¬¦ä¸²ï¼šå¡«å†™ä¹‹å‰è®¿é—®æµ‹è¯•é¡µé¢åŒ…å«çš„å­—ç¬¦ä¸²ï¼Œå¦‚okã€IsSuccess:trueç­‰ï¼Œæ­¤ä¾‹ä¸º{\u0026quot;status\u0026quot;:\u0026quot;failure\u0026quot;,\u0026quot;message\u0026quot;:\u0026quot;-1 å‚æ•°ä¸å…¨\u0026quot;}\nURLåœ°å€\næ·»åŠ å®Œæˆï¼Œå¹¶ä¸”æ£€æµ‹æˆåŠŸåï¼Œå¯è§‚å¯Ÿå¦‚ä¸‹\nä¸»æœºä¸­æ²¡æœ‰æŠ¥é”™ä¿¡æ¯\næ·»åŠ å‘Šè­¦ï¼Œè§¦å‘æŠ¥è­¦ 1ï¼‰åˆ‡å›åŸä¸»æœºç•Œé¢ï¼Œæ·»åŠ è§¦å‘å™¨ 2ï¼‰åˆ›å»ºè§¦å‘å™¨ï¼š âš ï¸æ³¨æ„ï¼š è§¦å‘å™¨åç§°ï¼šè§„åˆ™ä¸ºåŸŸå+æ— æ³•å“åº”ï¼Œå¦‚æ­¤ä¾‹ä¸­çš„download.tujia.com+æ— æ³•å“åº”\nä¸¥é‡æ€§ï¼šé€‰æ‹©ä¸€èˆ¬ä¸¥é‡\nè¡¨è¾¾å¼ï¼š å»ºç«‹è¿‡ç¨‹å¦‚ä¸‹\nå¦‚ä¸‹å›¾ä¸­ï¼Œå½“å»ºç«‹å®Œwebæ£€æµ‹åï¼Œä¸»æœºä¸­ä¼šç”Ÿæˆå“åº”çš„ç›‘æ§é¡¹ï¼Œå…¶ä¸­ä¸€é¡¹web.test.fail[web_check_download.tujia.com],\nè‹¥webæ£€æµ‹å¤±è´¥ï¼Œæ­¤ç›‘æ§é¡¹çš„å€¼ä¸º1ï¼Œè‹¥æ­£å¸¸ï¼Œåˆ™ä¸º0\nç”¨äºæ£€æµ‹æ­¤webæ£€æµ‹æ˜¯å¦æˆåŠŸï¼Œæ­¤ä¾‹ä¸­çš„triggerå«ä¹‰ä¸ºï¼Œå½“æ­¤webæ£€æµ‹è¿ç»­3minæ£€æµ‹å¤±è´¥ï¼ˆé€‰æ‹©å‘¨æœŸTçš„æœ€å°å€¼\u0026gt;Nï¼ŒTä¸º3mï¼‰ï¼Œåˆ™è§¦å‘ï¼Œè¡¨è¾¾å¼çš„æ„å»ºå¦‚ä¸‹ï¼š\n{ä¸»æœºåç§°:ç›‘æ§é¡¹åç§°.æ¡ä»¶}+æ¯”è¾ƒç¬¦å·+æ•°å€¼ï¼Œå¦‚ä¸‹ä¸ºæ­¤ä¾‹ä¸­çš„è¡¨è¾¾å¼\n{HZ 3A 150:web.test.fail[URLapi.phpå‘Šè­¦].min(3m)}\u0026lt;0\n{ ä¸»æœºå :ç›‘æ§é¡¹ï¼ˆæ­¤webæ£€æµ‹å¤±è´¥ï¼‰ .æ¡ä»¶ï¼ˆä¸‰åˆ†é’Ÿå†…ï¼‰}\u0026gt;0\nè¡¨è¾¾å¼ï¼šå¦‚æœæœ€è¿‘è¿ç»­4æ¬¡å–åˆ°çš„response_code å€¼ä¸æ˜¯200ï¼ˆç½‘ç«™å“åº”ä»£ç ï¼‰ï¼Œåˆ™è§¦å‘æŠ¥è­¦\n{192.168.3.86:web.test.rspcode[3.86_http_status,3.86_http_status].last(0)}\u0026lt;\u0026gt;200 and {192.168.3.86:web.test.rspcode[3.86_http_status,3.86_http_status].last(1)}\u0026lt;\u0026gt;200 and {192.168.3.86:web.test.rspcode[3.86_http_status,3.86_http_status].last(2)}\u0026lt;\u0026gt;200 and {192.168.3.86:web.test.rspcode[3.86_http_status,3.86_http_status].last(3)}\u0026lt;\u0026gt;200\nä½œè€…ï¼šSREè¿ç»´åšå®¢\nåšå®¢åœ°å€ï¼š https://www.cnsre.cn/\næ–‡ç« åœ°å€ï¼šhttps://www.cnsre.cn/posts/211101950005/\nç›¸å…³è¯é¢˜ï¼šhttps://www.cnsre.cn/tags/zabbix/\n","description":"éœ€è¦å¯¹é¡µé¢ url å¯¹é¡µé¢çš„å»¶è¿Ÿï¼Œè®¿é—®æ—¶é—´è¿›è¡Œç›‘æ§ã€‚å¦‚æœé¡µé¢ä¸æ˜¯æ­£å¸¸çš„çŠ¶æ€å°±å‘é€å‘Šè­¦ã€‚","id":28,"section":"posts","tags":["zabbix"],"title":"zabbix ä½¿ç”¨ web ç›‘æ§åŠŸèƒ½ç›‘æ§ url","uri":"http://www.cnsre.cn:80/posts/211101950005/"},{"content":" ä½œè€…ï¼šSREè¿ç»´åšå®¢\nåšå®¢åœ°å€ï¼š https://www.cnsre.cn/\næ–‡ç« åœ°å€ï¼šhttps://www.cnsre.cn/posts/211029955133/\nç›¸å…³è¯é¢˜ï¼šhttps://www.cnsre.cn/tags/æ•…éšœé›†/\nå‰è¨€ Linux ç£ç›˜ç©ºé—´æ€»æ˜¯æŠ¥è­¦ï¼ŒæŸ¥åˆ°åˆ°å¤§æ–‡ä»¶ï¼Œåˆ é™¤ä¹‹åï¼Œdfçœ‹åˆ°ç£ç›˜ç©ºé—´å¹¶æ²¡æœ‰é‡Šæ”¾ã€‚\nç”¨ du -sh ./* | sort -nr ï¼ˆæŸ¥çœ‹å½“å‰ç›®å½•ä¸‹æ–‡ä»¶çš„å¤§å°ï¼‰é€šè¿‡æŸ¥æ‰¾äº†ä¸‹å‘ç°æ–‡ä»¶è¢«mysql çš„zabbixåº“å ç”¨äº† zabbix å·²ç»è¿ç§»å¯ä»¥åˆ é™¤\nrm åˆ é™¤ä¹‹å df æŸ¥çœ‹ å‘ç°ç£ç›˜ç©ºé—´å¹¶æ²¡æœ‰å¾—åˆ°é‡Šæ”¾\næ‰§è¡Œ lsof | grep deleted å‘ç°æœ‰å¤§é‡åˆšåˆšåˆ é™¤æ–‡ä»¶çš„è¿›ç¨‹å­˜åœ¨\nkillæ‰è¿›ç¨‹ï¼ˆæˆ–è€…é‡å¯è¿›ç¨‹ï¼‰ OK\né—®é¢˜åˆ†æ ä¸€èˆ¬è¯´æ¥ä¸ä¼šå‡ºç°åˆ é™¤æ–‡ä»¶åç©ºé—´ä¸é‡Šæ”¾çš„æƒ…å†µï¼Œä½†æ˜¯ä¹Ÿå­˜åœ¨ä¾‹å¤–ï¼Œæ¯”å¦‚æ–‡ä»¶è¢«è¿›ç¨‹é”å®šï¼Œæˆ–è€…æœ‰è¿›ç¨‹ä¸€ç›´åœ¨å‘è¿™ä¸ªæ–‡ä»¶å†™æ•°æ®ç­‰ç­‰ï¼Œè¦ç†è§£è¿™ä¸ªé—®é¢˜ï¼Œå°±éœ€è¦çŸ¥é“Linuxä¸‹æ–‡ä»¶çš„å­˜å‚¨æœºåˆ¶å’Œå­˜å‚¨ç»“æ„ã€‚\nä¸€ä¸ªæ–‡ä»¶åœ¨æ–‡ä»¶ç³»ç»Ÿä¸­çš„å­˜æ”¾åˆ†ä¸ºä¸¤ä¸ªéƒ¨åˆ†ï¼šæ•°æ®éƒ¨åˆ†å’ŒæŒ‡é’ˆéƒ¨åˆ†ï¼ŒæŒ‡é’ˆä½äºæ–‡ä»¶ç³»ç»Ÿçš„ meta-data ä¸­ï¼Œæ•°æ®è¢«åˆ é™¤åï¼Œè¿™ä¸ªæŒ‡é’ˆå°±ä» meta-data ä¸­æ¸…é™¤äº†ï¼Œè€Œæ•°æ®éƒ¨åˆ†å­˜å‚¨åœ¨ç£ç›˜ä¸­ï¼Œæ•°æ®å¯¹åº”çš„æŒ‡é’ˆä» meta-data ä¸­æ¸…é™¤åï¼Œæ–‡ä»¶æ•°æ®éƒ¨åˆ†å ç”¨çš„ç©ºé—´å°±å¯ä»¥è¢«è¦†ç›–å¹¶å†™å…¥æ–°çš„å†…å®¹ï¼Œä¹‹æ‰€ä»¥å‡ºç°åˆ é™¤ access_log æ–‡ä»¶åï¼Œç©ºé—´è¿˜æ²¡é‡Šæ”¾ï¼Œå°±æ˜¯å› ä¸º httpd è¿›ç¨‹è¿˜åœ¨ä¸€ç›´å‘è¿™ä¸ªæ–‡ä»¶å†™å…¥å†…å®¹ï¼Œå¯¼è‡´è™½ç„¶åˆ é™¤äº† access_log æ–‡ä»¶ï¼Œä½†æ–‡ä»¶å¯¹åº”çš„æŒ‡é’ˆéƒ¨åˆ†ç”±äºè¿›ç¨‹é”å®šï¼Œå¹¶æœªä» meta-data ä¸­æ¸…é™¤ï¼Œè€Œç”±äºæŒ‡é’ˆå¹¶æœªè¢«åˆ é™¤ï¼Œé‚£ä¹ˆç³»ç»Ÿå†…æ ¸å°±è®¤ä¸ºæ–‡ä»¶å¹¶æœªè¢«åˆ é™¤ï¼Œå› æ­¤é€šè¿‡ df å‘½ä»¤æŸ¥è¯¢ç©ºé—´å¹¶æœªé‡Šæ”¾ä¹Ÿå°±ä¸è¶³ä¸ºå¥‡äº†ã€‚\nå¤„ç†é—®é¢˜ æ—¢ç„¶æœ‰äº†è§£å†³é—®é¢˜çš„æ€è·¯ï¼Œé‚£ä¹ˆæ¥ä¸‹æ¥çœ‹çœ‹æ˜¯å¦æœ‰è¿›ç¨‹ä¸€ç›´åœ¨å‘æ–‡ä»¶ä¸­å†™ï¼Œè¿™é‡Œéœ€è¦ç”¨åˆ° Linux ä¸‹çš„ lsof å‘½ä»¤ï¼Œé€šè¿‡è¿™ä¸ªå‘½ä»¤å¯ä»¥è·å–ä¸€ä¸ªå·²ç»è¢«åˆ é™¤ä½†ä»ç„¶è¢«åº”ç”¨ç¨‹åºå ç”¨çš„æ–‡ä»¶åˆ—è¡¨ï¼Œå‘½ä»¤æ‰§è¡Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š\nä½œè€…ï¼šSREè¿ç»´åšå®¢\nåšå®¢åœ°å€ï¼š https://www.cnsre.cn/\næ–‡ç« åœ°å€ï¼šhttps://www.cnsre.cn/posts/211029955133/\nç›¸å…³è¯é¢˜ï¼šhttps://www.cnsre.cn/tags/æ•…éšœé›†/\n","description":"linuxæœåŠ¡å™¨åˆ é™¤æ–‡ä»¶å df æŸ¥çœ‹ç£ç›˜ç©ºé—´å¹¶æ²¡æœ‰é‡Šæ”¾","id":29,"section":"posts","tags":["æ•…éšœé›†"],"title":"åˆ é™¤æ–‡ä»¶å df æŸ¥çœ‹ç£ç›˜ç©ºé—´å¹¶æ²¡æœ‰é‡Šæ”¾","uri":"http://www.cnsre.cn:80/posts/211029955133/"},{"content":" ä½œè€…ï¼šSREè¿ç»´åšå®¢\nåšå®¢åœ°å€ï¼šhttps://www.cnsre.cn\næ–‡ç« åœ°å€ï¼šhttps://www.cnsre.cn/posts/211027957506/\nç›¸å…³è¯é¢˜ï¼šhttps://www.cnsre.cn/tags/æ•…éšœé›†/\næœ€è¿‘æ¥åˆ°ä¸€ä¸ªcase æ¶‰åŠåˆ°Linuxä¸‹é¢å¤§ç¡¬ç›˜(å¤§äº2T)çš„ä½¿ç”¨,ä»¥åå¤§å®¶é‡åˆ°å¤§ç¡¬ç›˜çš„å¯èƒ½æ€§ä¼šè¶Šæ¥è¶Šå¤š,ç‰¹æŠŠå¤„ç†è¿‡ç¨‹åˆ†äº«å‡ºæ¥,ä»¥ä¾›å¤§å®¶å‚è€ƒ\né—®é¢˜èƒŒæ™¯ Dell r85 æœºæ¶å¼æœåŠ¡å™¨ é…ç½®6ä¸ª1Tç¡¬ç›˜, åšå®Œåº•å±‚raidå,æ“ä½œç³»ç»Ÿå¯ä»¥è®¤åˆ°3T\né—®é¢˜ åœ¨å®é™…ä½¿ç”¨ä¸­,ç³»ç»Ÿåªç”¨åˆ°2Tçš„ç©ºé—´,æœ€å1Tå§‹ç»ˆæ— æ³•åˆ†åŒº,æŠ¥é”™å¦‚ä¸‹:\nåŸå› åˆ†æ å®‰è£…Linuxæ—¶,ä½¿ç”¨äº†æ™®é€šçš„MBRæ¨¡å¼ ,å¯¹ä¸»æµä¸»æ¿BIOSè€Œè¨€ï¼ŒMBRåˆ†åŒºå®šä¹‰æ¯ä¸ªæ‰‡åŒº512å­—èŠ‚ï¼Œç£ç›˜å¯»å€32ä½åœ°å€ï¼Œæ‰€èƒ½è®¿é—®çš„ç£ç›˜å®¹é‡æœ€å¤§æ˜¯2.19TBï¼ˆ512 * 232ï¼‰,å› æ­¤ç³»ç»Ÿèƒ½ä½¿ç”¨çš„æœ€å¤§ç©ºé—´ä¹Ÿä¸º2T\nè§£å†³æ–¹æ¡ˆ é€šè¿‡å’¨è¯¢Dell åŸå‚,æä¾›äº†ä¸¤ä¸ªè§£å†³æ–¹æ¡ˆ\n1.å®‰è£…Linux ç³»ç»Ÿæ—¶é‡æ–°æ›´æ”¹ BIOSçš„å¯åŠ¨æ¨¡å¼ä¸ºUEFI\n2.é‡æ–°åˆ’åˆ†åº•å±‚ raid åˆ’åˆ†ä¸ºä¸€ä¸ªå°äº 2T çš„ç›˜åšä¸ºå®‰è£…ç³»ç»Ÿçš„ç›˜,å¦ä¸€ä¸ªå¤§äº2Tçš„ç›˜åšä¸ºæ•°æ®ç›˜ä½¿ç”¨.\nå®æ“è¿‡ç¨‹ åœ¨é‡åˆ°å¤§ç¡¬ç›˜å,æœ€å¥½ç”µè¯¢åŸå‚,çœ‹æ˜¯å¦æ”¯æŒUEFI\nå¦å¤–: åœ¨åˆ’åˆ†åŒºæ—¶,å¦‚æœé€‰æ‹©è‡ªå®šä¹‰,åœ¨redhat 6.X ä¹‹åè¦å¿…é¡»è¦æ–°å»º /boot/efi åˆ†åŒº.å¤§å°ä¸èƒ½å°äº 100M æˆ‘åœ¨å®é™…æ“ä½œæ—¶è®¾ç½®äº†200M\nåŸå‚çš„è§£é‡Šæ˜¯:\n/boot/efi/ partition (100 MB minimum) â€” the partition mounted on /boot/efi/ contains all the installed kernels, the initrd images, and ELILO configuration files.\nä¿®æ”¹BIOSä¸­è®¾ç½®,ä¸‹é¢ä»¥Dell R815 ä¸ºä¾‹è¯´æ˜ä¿®æ”¹\n1.é‡å¯ä¸»æœº,æŒ‰F2 è¿›å…¥BIOS è®¾ç½® (æˆ–æŒ‰å„å‚å•†æç¤º),\nå‡ºç°è¯¥ç•Œé¢å,æŒ‰ F2 ,\nç”Ÿæ•ˆåå¦‚ä¸‹å›¾\nåœ¨å¼•å¯¼åˆ°ä¸€å®šé˜¶æ®µåä¼šè‡ªåŠ¨è¿›å…¥BIOS è®¾ç½®,æŒ‰æ–¹å‘é”®ä¸Š,ä¸‹é€‰æ‹© [Boot Settings] å,å›è½¦\nåœ¨å°çª—å£ç”¨æ–¹å‘é”®é€‰æ‹© [Boot Mode] ä½¿ç”¨ -/+ é€‰æ‹©å¯åŠ¨æ–¹å¼ä¸º [UEFI]\nä¿®æ”¹åESCé€€å‡ºæ—¶ä¿å­˜\nnote: uEFI does not read from legacy mbr labels\n2.æ›´æ”¹ç£ç›˜çš„ disk lable æ›´æ”¹ä¸º GPT\nå› ä¸ºOn hardware where uEFI is enabled, the boot disk must have a GPT partition label\nåœ¨å®‰è£…ä»»æ„ä»‹é¢,è¾“å…¥ Ctrl+Alt+F2 åˆ‡æ¢åˆ°å‘½ä»¤è¡Œä»‹é¢,ä½¿ç”¨ parted æ›´æ”¹ disk lableä¸º gpt\nnote: å¦‚æœæ˜¯å·²ç»å®‰è£…è¿‡ç³»ç»Ÿçš„ä¸»æœº,è¿™ä¸€æ­¥æ—¶å¿…é¡»è¦å…ˆå°†æ—§åˆ†åŒºå…¨éƒ¨åˆ é™¤,æ‰èƒ½æ›´æ”¹æˆåŠŸ\nå› ä¸ºæ˜¯é‡è£…,æ‰€ä»¥è¦å…ˆæŠŠæ—§åˆ†åŒºåˆ é™¤,çº¢æ¡†æ ‡ç¤ºå‡ºæ¥çš„å°±æ˜¯ä¼ ç»Ÿçš„ mbr æ¨¡å¼,åªèƒ½æ”¯æŒæœ€å¤§2T çš„ç¡¬ç›˜\nåˆ é™¤æ—§åˆ†åŒº\næ›´æ”¹ disk label ä¸º gpt\næ›´æ”¹å®Œæˆå,ä½¿ç”¨ Ctrl+Alt+F6 å›åˆ‡è‡³å®‰è£…ç•Œé¢,æŒ‰æ­£å¸¸æ­¥éª¤å®‰è£…å³å¯\nä½œè€…ï¼šSREè¿ç»´åšå®¢\nåšå®¢åœ°å€ï¼šhttps://www.cnsre.cn\næ–‡ç« åœ°å€ï¼šhttps://www.cnsre.cn/posts/211027957506/\nç›¸å…³è¯é¢˜ï¼šhttps://www.cnsre.cn/tags/æ•…éšœé›†/\n","description":"Linuxä¸‹é¢å¤§ç¡¬ç›˜(å¤§äº2T)çš„ä½¿ç”¨,ä»¥åå¤§å®¶é‡åˆ°å¤§ç¡¬ç›˜çš„å¯èƒ½æ€§ä¼šè¶Šæ¥è¶Šå¤š,ç‰¹æŠŠå¤„ç†è¿‡ç¨‹åˆ†äº«å‡ºæ¥,ä»¥ä¾›å¤§å®¶å‚è€ƒ","id":30,"section":"posts","tags":["æ•…éšœé›†"],"title":"å¤§äº2Tç¡¬ç›˜å®‰è£… Redhat ç³»ç»Ÿ","uri":"http://www.cnsre.cn:80/posts/211027957506/"},{"content":" ä½œè€…ï¼šSREè¿ç»´åšå®¢\nåšå®¢åœ°å€ï¼šhttps://www.cnsre.cn\næ–‡ç« åœ°å€ï¼šhttps://www.cnsre.cn/posts/211025912047/\nç›¸å…³è¯é¢˜ï¼šhttps://www.cnsre.cn/tags/zabbix/\nç¯å¢ƒä»‹ç» æ“ä½œç³»ç»Ÿï¼šcentos 7.4\nzabbixç‰ˆæœ¬ï¼šzabbix server 3.4.7\nå®¢æˆ·ç«¯ï¼šzabbix-agent 3.4.7\nç›‘æ§è¿›ç¨‹ï¼šmysqld\nç›‘æ§ç«¯å£ï¼š3306 tcp\nè¿›ç¨‹ç›‘æ§ ç¡®è®¤å®¢æˆ·ç«¯å·²ç»å®‰è£…ä¸”è¿è¡Œagent\næŸ¥çœ‹è¿›ç¨‹\næŸ¥çœ‹å±äºé‚£ä¸ªç”¨æˆ·çš„ å‡ ä¸ªè¿›ç¨‹\nmysql çš„è¿›ç¨‹ä¸ºrootç”¨æˆ· ä¸¤ä¸ªè¿›ç¨‹\næ·»åŠ ç›‘æ§é¡¹\nåç§°éšä¾¿å†™\nç±»å‹zabbixå®¢æˆ·ç«¯\né”®å€¼é€‰åˆ™è¿›ç¨‹æ•°è¿”å›æ•°\nåº”ç”¨é›†é€‰åˆ™prosesses è¿›ç¨‹\nproc.num[\u0026lt;name\u0026gt;,\u0026lt;user\u0026gt;,\u0026lt;state\u0026gt;,\u0026lt;cmdline\u0026gt;]\nä»¥ä¸‹æ˜¯å¯¹mysqlè¿›ç¨‹çš„ç›‘æ§é…ç½®ï¼Œkeyä¸­çš„å‚æ•°è¯´æ˜ï¼Œ\n\u0026lt;name\u0026gt;ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯è¿›ç¨‹åå­—ï¼Œæ²¡å¿…è¦å¡«å†™ï¼Œå¡«äº†åè€Œä¼šä½¿ç›‘æ§ä¸å¤ªå‡†ç¡®ï¼ˆä»…ä¸ªäººæµ‹è¯•ï¼‰\n\u0026lt;user\u0026gt;ç¬¬äºŒä¸ªå‚æ•°æ˜¯è¿è¡Œè¿›ç¨‹çš„ç”¨æˆ·å\n\u0026lt;state\u0026gt;ç¬¬ä¸‰ä¸ªä¸ºè¿›ç¨‹çš„çŠ¶æ€ ï¼Œä¸€èˆ¬é€‰åˆ™all åŒ…æ‹¬ï¼šall (default), run, sleep, zomb\n\u0026lt;cmdline\u0026gt;ç¬¬å››ä¸ªå‚æ•°ç”¨æ¥æŒ‡å®šè¿›ç¨‹åä¸­åŒ…å«çš„å­—ç¬¦ï¼Œå¯¹è¿›ç¨‹è¿›è¡Œè¿‡æ»¤ã€‚\nç¡®è®¤æ›´æ–°\nåˆ›å»ºè§¦å‘å™¨\né€‰æ‹©åˆšæ‰åˆ›å»ºçš„ç›‘æ§é¡¹\næ’å…¥\nä¿®æ”¹{hgh3a01:proc.num[,root,all,mysqld].last()}=0\nä¸º\n{hgh3a01:proc.num[,root,all,mysqld].max(#2)}=2\nhgh3a01ï¼šä¸»æœºåç§°\nproc.num[,root,all,mysqld]ï¼šç›‘æ§é¡¹\nmax(#2)}=2 ï¼šè¡¨ç¤ºæœ€åä¸¤æ¬¡çš„æ¥æ”¶åˆ°çš„å€¼éƒ½æ˜¯2ä¸ªè¿›ç¨‹ï¼ˆps -ef çœ‹åˆ° mysqld çš„è¿›ç¨‹ä¸ºä¸¤ä¸ªæ‰€ä»¥=2 ï¼‰ï¼Œè¯´æ˜mysqldè¿›ç¨‹åœ¨è¿è¡Œï¼Œåˆ™å‡ºå‘æŠ¥è­¦ã€‚\nå› ä¸ºæˆ‘ä»¬è¦æµ‹è¯•æ˜¯å¦èƒ½å‡ºå‘å‘Šè­¦ï¼Œæ‰€ä»¥è¦é€‰åˆ™ =2 æ­£å¸¸çš„\u0026lt;1 å°±æ˜¯æ²¡æœ‰è¿è¡Œã€‚\nç¨ç­‰å‡ åˆ†é’Ÿè§‚å¯Ÿçœ‹çœ‹èƒ½ä¸èƒ½è§¦å‘è§¦å‘å™¨\næ”¶åˆ°é‚®ç®±è­¦å‘Š\nå§æµ‹è¯•çš„è¿›ç¨‹æ”¹ä¸ºæ­£å¸¸çš„ï¼ˆå› ä¸ºmysql è¿è¡Œçš„è¿›ç¨‹ä¸ºä¸¤ä¸ªæˆ‘è¿™å˜è®¾ç½®çš„è§¦å‘å™¨ä¸ºè¿›ç¨‹å°äºä¸¤ä¸ªè¿›ç¨‹å°±å‘å‡ºå‘Šè­¦ï¼‰\nä¿å­˜æ›´æ–°è§‚å¯Ÿæ˜¯å¦å›å¤æ­£å¸¸\nç›‘æ§ç«¯å£ æ·»åŠ ç›‘æ§é¡¹\nä¿®æ”¹ç«¯å£ ä¿å­˜æ›´æ–°\nåŒç›‘æ§è¿›ç¨‹ä¸€æ ·ï¼ˆå…ˆæµ‹è¯•ï¼‰\næ”¶åˆ°è§¦å‘è­¦å‘Š\nå§ä¹‹å‰çš„å€¼è°ƒæ•´ä¸º0\næµ‹è¯•å›å¤æ­£å¸¸\nä½œè€…ï¼šSREè¿ç»´åšå®¢\nåšå®¢åœ°å€ï¼šhttps://www.cnsre.cn\næ–‡ç« åœ°å€ï¼šhttps://www.cnsre.cn/posts/211025912047/\nç›¸å…³è¯é¢˜ï¼šhttps://www.cnsre.cn/tags/zabbix/\n","description":"zabbix é€šè¿‡ zabbix_agent å¯¹åº”ç”¨çš„è¿›ç¨‹ã€ç«¯å£è¿›è¡Œè‡ªå®šä¹‰ç›‘æ§å‘Šè­¦ã€‚","id":31,"section":"posts","tags":["zabbix"],"title":"zabbix é€šè¿‡ agent ç›‘æ§è¿›ç¨‹ã€ç«¯å£","uri":"http://www.cnsre.cn:80/posts/211025912047/"},{"content":" ä½œè€…ï¼šSREè¿ç»´åšå®¢\nåšå®¢åœ°å€ï¼šhttps://www.cnsre.cn\næ–‡ç« åœ°å€ï¼šhttps://www.cnsre.cn/posts/211021950307/\nç›¸å…³è¯é¢˜ï¼šhttps://www.cnsre.cn/tags/zabbix/\nç³»ç»Ÿç¯å¢ƒ Zabbix ç‰ˆæœ¬ï¼š3.4\næ“ä½œç³»ç»Ÿç‰ˆæœ¬ï¼šcentos7.4\nç›‘æ§åˆ†åŒº / ã€/boot ã€/home\nå…ˆåˆ›å»ºç›‘æ§é¡¹çš„æ¨¡æ¿ ç‚¹å‡»åˆ›å»ºç›‘æ§é¡¹ åç§°éšæ„å¡«å†™ï¼Œé”®å€¼çš„è¯å› ä¸ºæˆ‘ä»¬ç›‘æ§è½¦çš„æ˜¯ç£ç›˜å‰©ä½™çš„ç™¾åˆ†æ¯”æ‰€æœ‰é€‰åˆ™æ¬¡é”®å€¼ï¼Œåº”ç”¨é›†åˆ™é€‰åˆ™filsystems\né€‰åˆ™é”®å€¼ é€‰åˆ™æ·»åŠ æˆ‘ä»¬çš„ç›‘æ§é¡¹å·²ç»åˆ›å»ºã€‚\næŸ¥çœ‹ç›‘æ§é¡¹çœ‹ä¸‹åˆ›å»ºæµ‹ç›‘æ§é¡¹æ˜¯å¦å¼‚å¸¸ã€‚ é€‰åˆ™éœ€è¦ç›‘æ§çš„ä¸»æœº æ¥ä¸‹æ¥æˆ‘ä»¬æ¥åˆ›å»ºç›‘æ§é¡¹ã€‚\nç›‘æ§é¡¹åç§°éšæ„å¡«å†™ã€‚\nç„¶åå§ä¸¥é‡æ€§é€‰åˆ™ä¸ºä¸€èˆ¬å‘Šè­¦ï¼ˆå› ä¸ºæˆ‘ä»¬çŸ­ä¿¡é‚®ç®±å‘Šè­¦ç­‰çº§æ˜¯ä¸€èˆ¬å‘Šè­¦ä»¥ä¸Šçš„å‘Šè­¦ç­‰çº§æ¨é€ï¼‰\né€‰åˆ™æˆ‘ä»¬åˆšæ‰åˆ›å»ºçš„ç›‘æ§é¡¹\nä¿®æ”¹è¡¨è¾¾å¼ å†™å‡ºç›‘æ§çš„åˆ†åŒºæˆ‘ä»¬è¿™ä»¥homeåˆ†åŒºä¸ºä¾‹ã€‚\nå®Œæˆä»¥åæ·»åŠ å³å¯ã€‚\nä½œè€…ï¼šSREè¿ç»´åšå®¢\nåšå®¢åœ°å€ï¼šhttps://www.cnsre.cn\næ–‡ç« åœ°å€ï¼šhttps://www.cnsre.cn/posts/211021950307/\nç›¸å…³è¯é¢˜ï¼šhttps://www.cnsre.cn/tags/zabbix/\n","description":"","id":32,"section":"posts","tags":["zabbix"],"title":"zabbixè‡ªå®šä¹‰ç›‘æ§ç£ç›˜åˆ†åŒº","uri":"http://www.cnsre.cn:80/posts/211021950307/"},{"content":" ä½œè€…ï¼šSREè¿ç»´åšå®¢\nåšå®¢åœ°å€ï¼šhttps://www.cnsre.cn\næ–‡ç« åœ°å€ï¼šhttps://www.cnsre.cn/posts/211012054181/\nç›¸å…³è¯é¢˜ï¼šhttps://www.cnsre.cn/tags/aws/\næ–‡ç« é“¾æ¥\nåœ¨ /etc/resolv.conf ä¸­é…ç½®äº† DNS åªèƒ½ä¸´æ—¶ç”Ÿæ•ˆï¼Œé‡å¯å°±ä¸¢å¤±äº†ï¼Œè¿™ç§æƒ…å†µä¸‹å¦‚ä½•æ°¸ä¹…ä¿®æ”¹ä¿ç•™ NDS å‘¢ï¼Ÿ\nç®€çŸ­æè¿° é»˜è®¤æƒ…å†µä¸‹ï¼Œä¸ Amazon Virtual Private Cloud (Amazon VPC) å…³è”çš„ Amazon EC2 å®ä¾‹åœ¨å¯åŠ¨æ—¶ä½¿ç”¨åŠ¨æ€ä¸»æœºé…ç½®åè®® (DHCP) è¯·æ±‚ DNS æœåŠ¡å™¨åœ°å€ã€‚DHCP å“åº”è¿”å›å†™å…¥åˆ°æœ¬åœ° /etc/resolv.conf æ–‡ä»¶çš„ DNS æœåŠ¡å™¨åœ°å€ã€‚é‡æ–°å¯åŠ¨å®ä¾‹æ—¶ï¼Œå¯¹å…·æœ‰è‡ªå®šä¹‰ DNS æœåŠ¡å™¨åœ°å€çš„ resolv.conf æ–‡ä»¶çš„æ‰‹åŠ¨ä¿®æ”¹å°†ä¸¢å¤±ã€‚æ‚¨ç”¨äºè§£å†³æ­¤é—®é¢˜çš„æ–¹æ³•å–å†³äºæ‚¨çš„ Linux å‘è¡Œç‰ˆã€‚æœ‰å…³ VPC å’Œ DNS æœåŠ¡å™¨çš„æ›´å¤šä¿¡æ¯ï¼Œè¯·å‚é˜… Amazon DNS æœåŠ¡å™¨ã€‚\nè§£å†³æ–¹æ³• âš ï¸ é‡è¦æç¤ºï¼š\næ›´æ”¹ Amazon EC2 å®ä¾‹ä¹‹å‰ï¼Œä½¿ç”¨ Amazon ç³»ç»Ÿæ˜ åƒ (AMI) æˆ– Amazon Elastic Block Store (Amazon EBS) å¿«ç…§åˆ›å»ºå¤‡ä»½ã€‚æ›´æ”¹å®ä¾‹çš„è”ç½‘é…ç½®å¯èƒ½ä¼šå¯¼è‡´å®ä¾‹æ— æ³•è®¿é—®ã€‚ Amazon Linuxã€Amazon Linux 2 ä½¿ç”¨ä»¥ä¸‹é€‰é¡¹ä¹‹ä¸€æ¥é…ç½® Amazon EC2 å®ä¾‹ã€‚å¦‚æœæ‚¨åŒæ—¶åº”ç”¨è¿™ä¸¤ä¸ªé€‰é¡¹ï¼Œåˆ™åœ¨ ifcfg-eth0 æ–‡ä»¶ä¸­æŒ‡å®šçš„ DNS æœåŠ¡å™¨ä¼šä¼˜å…ˆï¼ˆé€‰é¡¹ 2ï¼‰ã€‚\nè¦ä½¿ä»»ä¸€é€‰é¡¹æ­£å¸¸è¿è¡Œï¼Œå¿…é¡»å°† ifcfg-eth0 æ–‡ä»¶ä¸­çš„ PEERDNS å‚æ•°å€¼è®¾ç½®ä¸º yesã€‚å°† PEERDNS å‚æ•°è®¾ç½®ä¸º no æ„å‘³ç€ï¼Œifcfg-* æ–‡ä»¶ä¸­æŒ‡å®šçš„æˆ– DHCP æä¾›çš„ DNS æœåŠ¡å™¨ä¼šè¢«å¿½ç•¥ã€‚\né€‰é¡¹1 é€‰é¡¹2 é€‰é¡¹ 1ï¼š\nç¼–è¾‘æˆ–åˆ›å»º /etc/dhcp/dhclient.conf æ–‡ä»¶ã€‚ âš ï¸ æ³¨æ„ï¼š æ‚¨å¿…é¡»æ‹¥æœ‰æ ¹ç”¨æˆ·æƒé™æ‰èƒ½ç¼–è¾‘æ­¤æ–‡ä»¶ã€‚æ‚¨å¯ä»¥ä½¿ç”¨ sudo -i æˆä¸ºæ ¹ç”¨æˆ·ï¼Œæˆ–è€…ä½¿ç”¨ sudo æ‰§è¡Œæ‰€æœ‰å‘½ä»¤ã€‚ 2. å°† **supersede** å‘½ä»¤æ·»åŠ åˆ°æ–‡ä»¶ä»¥è¦†ç›– domain-name-serversã€‚åœ¨ä»¥ä¸‹ç¤ºä¾‹ä¸­ï¼Œå°† **xxx.xxx.xxx.xxx** æ›¿æ¢ä¸ºæ‚¨å¸Œæœ›å®ä¾‹ä½¿ç”¨çš„ DNS æœåŠ¡å™¨çš„ IP åœ°å€ï¼š 1 supersede domain-name-servers xxx.xxx.xxx.xxx, xxx.xxx.xxx.xxx; åœ¨ä¸Šè¿°ä¿®æ”¹ä¹‹åï¼Œresolv.conf æ–‡ä»¶å°†åœ¨å®ä¾‹é‡å¯æ—¶æ›´æ–°ï¼Œä»¥ä»…åŒ…å«æ‚¨åœ¨ dhclient æ–‡ä»¶ä¸­æŒ‡å®šçš„ DNS æœåŠ¡å™¨ã€‚æœ‰å…³ supersede å‘½ä»¤çš„æ›´å¤šä¿¡æ¯ï¼Œè¯·å‚é˜… Linux æ‰‹å†Œé¡µä¸Šçš„ dhclient.conf(5)ã€‚\nåœ¨æ¯ä¸ªæ¥å£çš„é…ç½®æ–‡ä»¶ (/etc/sysconfig/network-scripts/ifcfg-*) ä¸­å°† PEERDNS å‚æ•°è®¾ç½®ä¸º yesã€‚\né‡å¯ EC2 å®ä¾‹ã€‚\né€‰é¡¹ 2ï¼š\nè¦è¦†ç›– /etc/dhcp/dhclient.conf æ–‡ä»¶ä¸­çš„ DNS æœåŠ¡å™¨å€¼ï¼Œè¯·åœ¨æ¯ä¸ªæ¥å£çš„é…ç½®æ–‡ä»¶ (/etc/sysconfig/network-scripts/ifcfg-*) ä¸­æŒ‡å®šè‡ªå®šä¹‰ DNS æœåŠ¡å™¨ã€‚ ä¾‹å¦‚ï¼Œä¸‹ä¾‹ä¸­æ˜¾ç¤ºæ¥è‡ª Amazon Linux å®ä¾‹çš„ /etc/sysconfig/network-scripts/ifcfg-eth0 æ–‡ä»¶ä¿®æ”¹ä¸ºåŒ…å«ä¸¤ä¸ªè‡ªå®šä¹‰ DNS æœåŠ¡å™¨ï¼ˆDNS1 å’Œ DNS2ï¼‰ï¼š\nDEVICE=eth0 BOOTPROTO=dhcp ONBOOT=yes TYPE=Ethernet USERCTL=yes PEERDNS=yes IPV6INIT=no PERSISTENT_DHCLIENT=yes RES_OPTIONS=\u0026#34;timeout:2 attempts:5\u0026#34; DHCP_ARP_CHECK=no MTU=\u0026#34;9001\u0026#34; DNS1=8.8.8.8 DNS2=8.8.4.4 åœ¨æ¯ä¸ªæ¥å£çš„é…ç½®æ–‡ä»¶ (/etc/sysconfig/network-scripts/ifcfg-*) ä¸­å°† PEERDNS å‚æ•°è®¾ç½®ä¸º yesã€‚ Ubuntu 16.04 ç¼–è¾‘æˆ–åˆ›å»º /etc/dhcp/dhclient.conf æ–‡ä»¶ã€‚ âš ï¸ æ³¨æ„ï¼š æ‚¨å¿…é¡»æ‹¥æœ‰æ ¹ç”¨æˆ·æƒé™æ‰èƒ½ç¼–è¾‘æ­¤æ–‡ä»¶ã€‚æ‚¨å¯ä»¥ä½¿ç”¨ sudo -i æˆä¸ºæ ¹ç”¨æˆ·ï¼Œæˆ–è€…ä½¿ç”¨ sudo æ‰§è¡Œæ‰€æœ‰å‘½ä»¤ã€‚\n2. å°† supersede å‘½ä»¤æ·»åŠ åˆ°æ–‡ä»¶ä»¥è¦†ç›– domain-name-serversã€‚åœ¨ä»¥ä¸‹ç¤ºä¾‹ä¸­ï¼Œå°† xxx.xxx.xxx.xxx æ›¿æ¢ä¸ºæ‚¨å¸Œæœ›å®ä¾‹ä½¿ç”¨çš„ DNS æœåŠ¡å™¨çš„ IP åœ°å€ï¼š\nsupersede domain-name-servers xxx.xxx.xxx.xxx, xxx.xxx.xxx.xxx; åœ¨æ­¤ä¿®æ”¹ä¹‹åï¼Œresolv.conf æ–‡ä»¶å°†åœ¨å®ä¾‹é‡å¯æ—¶æ›´æ–°ï¼Œä»¥ä»…åŒ…å«æ‚¨åœ¨ dhclient æ–‡ä»¶ä¸­æŒ‡å®šçš„ DNS æœåŠ¡å™¨ã€‚æœ‰å…³ supersede å‘½ä»¤çš„æ›´å¤šä¿¡æ¯ï¼Œè¯·å‚é˜… Linux æ‰‹å†Œé¡µä¸Šçš„ dhclient.conf(5)ã€‚\né‡å¯å®ä¾‹ã€‚ Ubuntu 18.04 é»˜è®¤æƒ…å†µä¸‹ï¼Œåœ¨ Ubuntu 18.04 ä¸Šï¼Œç”± netplan.io è½¯ä»¶åŒ…å¤„ç†ç½‘ç»œæ¥å£é…ç½®ï¼Œä¸”ç”±å¯ç”¨ç³»ç»Ÿè§£æçš„æœåŠ¡ä½¿ç”¨å­˜æ ¹è§£æç¨‹åºå¤„ç† DNS æŸ¥è¯¢ã€‚å­˜æ ¹è§£æç¨‹åº IP ä½äº /etc/resolv.confã€‚\nåè¿‡æ¥ï¼Œ/etc/resolv.conf æ–‡ä»¶æ˜¯ /run/systemd/resolve/stub-resolv.conf æ–‡ä»¶çš„ç¬¦å·é“¾æ¥ã€‚å¦‚æœä»¥ä¸‹ä»»ä¸€é¡¹å¯¹äº /etc/resolv.conf æ–‡ä»¶ä¸ºçœŸï¼Œ/etc/dhcp/dhclient.conf ä¸­çš„ supersede è¯­å¥å¯èƒ½æ— æ³•æŒ‰é¢„æœŸèµ·ä½œç”¨ï¼š\næ–‡ä»¶ä¸æ˜¯æ‚¨çš„å®ä¾‹ä¸Šçš„ç¬¦å·é“¾æ¥ã€‚ æ–‡ä»¶æ˜¯ä¸€ä¸ªæŒ‡å‘ä¸åŒæ–‡ä»¶çš„ç¬¦å·é“¾æ¥ï¼Œå¦‚ /run/systemd/resolve/resolv.confã€‚ ä¸Šè¿°ä»»ä¸€æ¡ä»¶éƒ½è¡¨ç¤ºè‡ªå®šä¹‰äº†é»˜è®¤çš„ Ubuntu 18.04 é…ç½®ã€‚\nè¿è¡Œä»¥ä¸‹æ­¥éª¤ä»¥è¦†ç›– DNS æœåŠ¡å™¨å€¼ï¼š\nNetplan é€šå¸¸å°†é…ç½®æ–‡ä»¶å­˜å‚¨åœ¨ /etc/netplan ç›®å½•ä¸­ã€‚åˆ›å»ºåä¸º /etc/netplan/99-custom-dns.yaml çš„æ–‡ä»¶ï¼Œç„¶åé€šè¿‡ä»¥ä¸‹è¡Œå¡«å……æ­¤æ–‡ä»¶ã€‚è¯·åŠ¡å¿…å°†å ä½ç¬¦ DNS æœåŠ¡å™¨ IP åœ°å€æ›¿æ¢ä¸ºé¦–é€‰åœ°å€ï¼š network: version: 2 ethernets: eth0: nameservers: addresses: [1.2.3.4, 5.6.7.8] dhcp4-overrides: use-dns: false åœ¨è¿›è¡Œè¿™äº›æ›´æ”¹åï¼Œæ‚¨å°†ä»ç„¶å¯ä»¥åœ¨ /etc/resolv.conf ä¸­çœ‹åˆ°å­˜æ ¹è§£æç¨‹åº IPã€‚è¿™æ˜¯æ­£å¸¸çš„ã€‚å­˜æ ¹è§£æç¨‹åº IP å¯¹äºæ‚¨çš„æ“ä½œç³»ç»Ÿæ¥è¯´æ˜¯æœ¬åœ°çš„ï¼Œåœ¨åå°ä¸­ï¼Œå­˜æ ¹è§£æç¨‹åºå°†ä½¿ç”¨æ‚¨åœ¨å‰è¿° 99-custom-dns.yaml æ–‡ä»¶ä¸­æŒ‡å®šçš„ DNS æœåŠ¡å™¨ã€‚\né‡å¯å®ä¾‹ã€‚\nè¿è¡Œ systemd-resolve å‘½ä»¤ä»¥ç¡®è®¤ç³»ç»Ÿæ­£ç¡®åœ°æå–é¢„æœŸçš„ DNS æœåŠ¡å™¨ IP åœ°å€ï¼š\n1 systemd-resolve --status RHEL 7.5 é»˜è®¤æƒ…å†µä¸‹ï¼Œç”± NetworkManager æœåŠ¡ç®¡ç† resolv.conf æ–‡ä»¶ã€‚ç„¶åï¼Œè¯¥æœåŠ¡ä¼šé€šè¿‡ DHCP æä¾›çš„ DNS æœåŠ¡å™¨å¡«å……æ­¤æ–‡ä»¶ã€‚é˜»æ­¢ NetworkManager ç®¡ç† resolv.conf æ–‡ä»¶ï¼Œä»¥ä½¿ resolv.conf æ–‡ä»¶å¿½ç•¥ DHCP æä¾›çš„ DNS æœåŠ¡å™¨ã€‚\né€‰é¡¹1 é€‰é¡¹2 é€‰é¡¹ 1ï¼š\nç¼–è¾‘æˆ–åˆ›å»º /etc/dhcp/dhclient.conf æ–‡ä»¶ã€‚ âš ï¸ æ³¨æ„ï¼š æ‚¨å¿…é¡»æ‹¥æœ‰æ ¹ç”¨æˆ·æƒé™æ‰èƒ½ç¼–è¾‘æ­¤æ–‡ä»¶ã€‚æ‚¨å¯ä»¥ä½¿ç”¨ sudo -i æˆä¸ºæ ¹ç”¨æˆ·ï¼Œæˆ–è€…ä½¿ç”¨ sudo æ‰§è¡Œæ‰€æœ‰å‘½ä»¤ã€‚ 2. å°† **supersede** å‘½ä»¤æ·»åŠ åˆ°æ–‡ä»¶ä»¥è¦†ç›– domain-name-serversã€‚åœ¨ä»¥ä¸‹ç¤ºä¾‹ä¸­ï¼Œå°† **xxx.xxx.xxx.xxx** æ›¿æ¢ä¸ºæ‚¨å¸Œæœ›å®ä¾‹ä½¿ç”¨çš„ DNS æœåŠ¡å™¨çš„ IP åœ°å€ï¼š 1 supersede domain-name-servers xxx.xxx.xxx.xxx, xxx.xxx.xxx.xxx; åœ¨æ­¤ä¿®æ”¹ä¹‹åï¼Œresolv.conf æ–‡ä»¶å°†åœ¨å®ä¾‹é‡å¯æ—¶æ›´æ–°ï¼Œä»¥ä»…åŒ…å«æ‚¨åœ¨ dhclient æ–‡ä»¶ä¸­æŒ‡å®šçš„ DNS æœåŠ¡å™¨ã€‚æœ‰å…³ supersede å‘½ä»¤çš„æ›´å¤šä¿¡æ¯ï¼Œè¯·å‚é˜… Linux æ‰‹å†Œé¡µä¸Šçš„ dhclient.conf(5)ã€‚\nåœ¨æ¯ä¸ªæ¥å£çš„é…ç½®æ–‡ä»¶ (/etc/sysconfig/network-scripts/ifcfg-*) ä¸­å°† PEERDNS å‚æ•°è®¾ç½®ä¸º yesã€‚\né‡å¯å®ä¾‹ã€‚\né€‰é¡¹ 2ï¼š\nä½¿ç”¨ä»¥ä¸‹å†…å®¹åˆ›å»º /etc/NetworkManager/conf.d/disable-resolve.conf-managing.conf æ–‡ä»¶ï¼š [main] dns=none é‡å¯å®ä¾‹ï¼Œç„¶åæ‰‹åŠ¨å¡«å…… /etc/resolv.conf æ–‡ä»¶ã€‚ ç›¸å…³è§†é¢‘\nPooja æ¼”ç¤ºäº†å¦‚ä½•å°†é‡å¯æœŸé—´ä¿ç•™çš„è‡ªå®šä¹‰ DNS æœåŠ¡å™¨åˆ†é…ç»™ Amazon EC2 å®ä¾‹\nä½œè€…ï¼šSREè¿ç»´åšå®¢\nåšå®¢åœ°å€ï¼šhttps://www.cnsre.cn\næ–‡ç« åœ°å€ï¼šhttps://www.cnsre.cn/posts/211012054181/\nç›¸å…³è¯é¢˜ï¼šhttps://www.cnsre.cn/tags/aws/\n","description":"","id":33,"section":"posts","tags":["aws"],"title":"Amazon EC2 æ°¸ä¹…ä¿®æ”¹é™æ€ DNS","uri":"http://www.cnsre.cn:80/posts/211012054181/"},{"content":" ä½œè€…ï¼šSREè¿ç»´åšå®¢\nåšå®¢åœ°å€ï¼šhttps://www.cnsre.cn\næ–‡ç« åœ°å€ï¼šhttps://www.cnsre.cn/posts/211009115571/\nç›¸å…³è¯é¢˜ï¼šhttps://www.cnsre.cn/tags/zabbix/\nç®€ä»‹ â€‹ Orabbix æ˜¯è®¾è®¡ç”¨æ¥ä¸º zabbix ç›‘æ§ Oracle æ•°æ®åº“çš„æ’ä»¶ï¼Œå®ƒæä¾›å¤šå±‚æ¬¡çš„ç›‘æ§ï¼ŒåŒ…æ‹¬å¯ç”¨æ€§å’ŒæœåŠ¡å™¨æ€§èƒ½æŒ‡æ ‡ã€‚\nâ€‹ å®ƒæä¾›äº†ä»ä¼—å¤š oracle å®ä¾‹é‡‡é›†æ•°æ®çš„æœ‰æ•ˆæœºåˆ¶ï¼Œè¿›è€Œæä¾›æ­¤ä¿¡æ¯çš„ç›‘æ§å’Œæ€§èƒ½æŒ‡æ ‡ã€‚ç„¶åï¼Œæ‚¨å¯ä»¥åˆ©ç”¨çš„ zabbix çš„æŠ¥å‘ŠåŠŸèƒ½ä¸ºæ”¶é›†çš„æ‰€æœ‰æ•°æ®ï¼Œå¹¶æä¾›åˆ†æã€‚ç›®å‰çš„å‘è¡Œç‰ˆä¸­åŒ…å«äº†ä¸€ç»„é¢„å…ˆå®šä¹‰çš„æ¨¡æ¿ï¼ŒåŒ…æ‹¬ä»åˆå§‹éƒ¨ç½²è­¦æŠ¥å’Œå›¾å½¢åŠŸèƒ½ã€‚ç„¶è€Œï¼Œè¿™äº›å¯ä»¥è¿›è¡Œå¾®è°ƒï¼Œä»¥æ»¡è¶³æ‚¨çš„éœ€æ±‚å’Œæ•°æ®/ç›‘æ§è¦æ±‚\nç¯å¢ƒä»‹ç» ç³»ç»Ÿç¯å¢ƒï¼š\nlinux Centos 7.4\n3.10.0-693.21.1.el7.x86_64\nzabbixç‰ˆæœ¬\nzabbix 3.4.7\nOrabbix ç›‘æ§ä»€ä¹ˆï¼Ÿ æ•°æ®åº“ç‰ˆæœ¬\nå½’æ¡£æ—¥å¿—ä¸ç”Ÿäº§è¶‹åŠ¿åˆ†æ\nè§¦å‘å™¨ï¼Œè¡¨/è¿‡ç¨‹ç­‰å‘½ä¸­ç‡\né€»è¾‘ I/O æ€§èƒ½\nç‰©ç† I/O æ€§èƒ½\nPGA\nSGA\nå…±äº«æ± \nSessions\næ•°æ®åº“å¤§å°\nè¡¨ç©ºé—´\nå®‰è£…é…ç½® zabbix server ç«¯æ“ä½œ\nOrabbixæ’ä»¶çš„ä¸‹è½½ http://www.smartmarmot.com/product/orabbix/download/\nå®‰è£… orabbix åˆ›å»ºç›®å½•\n1 2 3 mkdir -p /opt/orabbix mv orabbix-1.2.3.zip /opt/orabbix cd /opt/orabbix yumå®‰è£…unzip\n1 2 3 yum install unzip -y # è§£å‹oeabbix unzip orabbix-1.2.3.zip åˆ›å»ºorabbixå¤‡ä»½\ncp conf/config.props.sample conf/config.props å¯åŠ¨ç¨‹åºæ‹·è´è‡³/etx/init.d/\ncp init.d/orabbix /etc/init.d/ åˆ†é…æƒé™\nchmod +x /etc/init.d/orabbix chmod +x /opt/orabbix/run.sh å®‰è£…jdk\nyum install java -y åˆ›å»ºæ•°æ®åº“è´¦å· ## oracle æœåŠ¡å™¨ç«¯æ“ä½œ ##\nç™»å½• oracle å‘½ä»¤è¡Œ\n1 2 3 4 5 6 7 8 9 10 11 su - oracle # åˆ‡æ¢åˆ° oracle ç”¨æˆ· sqlplus /nolog # ä¸è¿æ¥ä»»ä½•æ•°æ®åº“ conn /as sysdba # ç”¨sysdba ç™»é™† # æˆ–è€… conn ç”¨æˆ·å/å¯†ç  select instance_name from v$instance; # æŸ¥çœ‹å®ä¾‹ é¦–å…ˆæˆ‘ä»¬éœ€è¦åœ¨è¢«ç›‘æ§çš„Oracleä¸Šé¢åˆ›å»ºä¸€ä¸ªè´¦å·ï¼Œç”¨äºzabbixçš„æ•°æ®è·å–ï¼Œåœ¨oracleçš„sqlplusé‡Œé¢æ‰§è¡Œ\n1 2 3 4 5 6 7 8 9 10 11 CREATE USER ZABBIX IDENTIFIED BY \u0026#34;zabbix\u0026#34; DEFAULT TABLESPACE SYSTEM TEMPORARY TABLESPACE TEMP PROFILE DEFAULT ACCOUNT UNLOCKï¼› èµ‹äºˆè§’è‰²æƒé™\n1 2 3 4 5 GRANT CONNECT TO ZABBIX; GRANT RESOURCE TO ZABBIX; ALTER USER ZABBIX DEFAULT ROLE ALL; èµ‹äºˆç³»ç»Ÿæƒé™\n1 2 3 4 5 6 7 8 9 GRANT SELECT ANY TABLE TO ZABBIX; GRANT CREATE SESSION TO ZABBIX; GRANT SELECT ANY DICTIONARY TO ZABBIX; GRANT UNLIMITED TABLESPACE TO ZABBIX; GRANT SELECT ANY DICTIONARY TO ZABBIX; å¦‚æœæˆ‘ä»¬çš„æ•°æ®åº“æ˜¯Oracle 11gï¼Œæˆ‘ä»¬è¿˜éœ€è¦æ‰§è¡Œä¸‹é¢çš„è¯­å¥\næ³¨é‡Šï¼šå®˜æ–¹æ–‡æ¡£æ˜¯éœ€è¦æ‰§è¡Œè¿™ä¸ªè¯­å¥çš„ï¼Œæµ‹è¯•æ²¡æœ‰æ‰§è¡Œä¹Ÿä¸€æ ·å¯ä»¥ç”¨ï¼Œç›®å‰æ²¡æœ‰å‘ç°é—®é¢˜ï¼ˆå¯å‚è€ƒï¼‰\nexec dbms_network_acl_admin.create_acl(acl =\u0026gt; \u0026#39;resolve.xml\u0026#39;,description =\u0026gt; \u0026#39;resolve acl\u0026#39;, principal =\u0026gt;\u0026#39;ZABBIX\u0026#39;, is_grant =\u0026gt; true, privilege =\u0026gt; \u0026#39;resolve\u0026#39;); exec dbms_network_acl_admin.assign_acl(acl =\u0026gt; \u0026#39;resolve.xml\u0026#39;, host =\u0026gt;\u0026#39;*\u0026#39;); commit; å‚è€ƒå®˜ç½‘æ–‡æ¡£\nhttp://www.smartmarmot.com/wiki/index.php/Orabbix\nç¼–è¾‘åˆšåˆšç”Ÿæˆçš„config.propsæ–‡ä»¶ zabbix server ç«¯æ“ä½œ\nvi /opt/orabbix/conf/config.props ** ä¿®æ”¹åå†…å®¹å¦‚ä¸‹ ** #comma separed list of Zabbix servers ZabbixServerList=ZabbixServer ZabbixServer.Address=192.168.2.145 **#zabbix server IPåœ°å€** ZabbixServer.Port=10051 **#ç«¯å£** ZabbixServer2.Address=IP_ADDRESS_OF_ZABBIX_SERVER ZabbixServer2.Port=PORT_OF_ZABBIX_SERVER #pidFile OrabbixDaemon.PidFile=./logs/orabbix.pid #frequency of item\u0026#39;s refresh OrabbixDaemon.Sleep=300 #MaxThreadNumber should be \u0026gt;= than the number of your databases OrabbixDaemon.MaxThreadNumber=100 #put here your databases in a comma separated list DatabaseList=192.168.2.142 **# åç§°ä¸è¯¥æœºåœ¨ zabbix ä¸­ç›‘æ§çš„ä¸»æœºåç§°ä¿æŒä¸€è‡´** #Configuration of Connection pool #if not specified Orabbis is going to use default values (hardcoded) #Maximum number of active connection inside pool DatabaseList.MaxActive=10 #The maximum number of milliseconds that the pool will wait #(when there are no available connections) for a connection to be returned #before throwing an exception, or \u0026lt;= 0 to wait indefinitely. DatabaseList.MaxWait=100 DatabaseList.MaxIdle=1 #define here your connection string for each database 192.168.2.142.Url=jdbc:oracle:thin:@192.168.2.142:1521:orcl **# éœ€è¦ jdk ç¯å¢ƒï¼Œå› ä¸ºè¿™é‡Œæ˜¯é€šè¿‡ JDBC è¿æ¥çš„ï¼Œ** â€‹ **#orcl ä¸ºæ•°æ®åº“å®ä¾‹åç§°** 192.168.2.142.User=ZABBIX **# ç”¨æ¥ç›‘æ§ oracle æ•°æ®åº“çš„ç”¨æˆ·åå’Œå¯†ç ï¼Œéœ€è¦åœ¨ oracle ä¸­åˆ›å»ºå¹¶èµ‹äºˆä¸€å®šçš„æƒé™** 192.168.2.142.Password=ZABBIX #Those values are optionals if not specified Orabbix is going to use the general values 192.168.2.142.MaxActive=10 192.168.2.142.MaxWait=100 192.168.2.142.MaxIdle=1 192.168.2.142.QueryListFile=./conf/query.props #DB2.Url=jdbc:oracle:thin:@server2.domain.example.com:\u0026lt;LISTENER_PORT\u0026gt;:DB2 #DB2.User=zabbix #DB2.Password=zabbix_password #DB2.QueryListFile=./conf/query.props #DB3.Url=jdbc:oracle:thin:@server3.domain.example.com:\u0026lt;LISTENER_PORT\u0026gt;:DB3 #DB3.User=zabbix #DB3.Password=zabbix_password #DB3.QueryListFile=./conf/query.props â€”â€”â€”â€”â€”â€”åˆ†â€”â€”â€”â€”â€”â€”â€”â€”â€”å‰²â€”â€”â€”â€”â€”â€”â€”â€”â€”çº¿â€”â€”â€”â€”â€”â€”â€”â€”\n**æ³¨ï¼š**ä»¥ä¸Šç«¯å£å·ä¸ºä¸Zabbix Serveré€šè®¯çš„ç«¯å£ï¼Œæˆ‘è¿™é‡Œæ˜¯å°†Orabbixä¸Zabbix server è£…åœ¨åŒä¸€å°æœºå™¨ä¸Šçš„ï¼Œå¦‚æœä¸åœ¨åŒä¸€å°æœºå™¨ï¼Œé‚£è£…Orabbixçš„æœºå™¨éœ€è¦å…ˆè£…Zabbix Agentï¼Œå¦åˆ™æ•°æ®å°†æ— æ³•ä¼ é€åˆ°Zabbix Serverã€‚\næ³¨ï¼š\nZabbixServerListï¼šå¯ä»¥è®¾ç½®å¤šä¸ªï¼Œç”¨\u0026quot;,\u0026ldquo;è¿›è¡Œåˆ†å‰²ï¼›\nDatabaseListï¼šå¯ä»¥è®¾ç½®å¤šä¸ªè¢«ç›‘æ§çš„Oracleæ•°æ®åº“æœåŠ¡å™¨ï¼Œç”¨\u0026rdquo;,\u0026ldquo;è¿›è¡Œåˆ†å‰²ï¼Œè¯¥åç§°è¦å’Œzabbix serverç•Œé¢ä¸­çš„Host nameä¿æŒä¸€è‡´ï¼Œè¯¥é…ç½®æ–‡ä»¶ä¸­åç»­æ‰€å¼•ç”¨çš„è®¾å®šéƒ½ä»¥è¯¥åç§°ä¸ºå‡†ã€‚\nå…³äº JDBC å¯å‚è€ƒï¼š\nOracle = jdbc:oracle:thin:@\u0026lt;host\u0026gt;:\u0026lt;LISTENER_PORT\u0026gt;:\u0026lt;instance\u0026gt; PostgreSQL = jdbc:postgresql://\u0026lt;host\u0026gt;:\u0026lt;port\u0026gt;/\u0026lt;database\u0026gt; MS Sql Server = jdbc:jtds:sqlserver://\u0026lt;host\u0026gt;:\u0026lt;port\u0026gt;/\u0026lt;instancename\u0026gt; [MySQL](http://lib.csdn.net/base/mysql) Server = jdbc:[mysql](http://lib.csdn.net/base/mysql)://[host:port],[host:port].../[database] DB2 = jdbc:db2://\u0026lt;servername\u0026gt;:\u0026lt;port\u0026gt;/\u0026lt;installation\u0026gt; å¯åŠ¨æœåŠ¡ /etc/init.d/orabbix start # æˆ– systemctl start orabbix é…ç½®zabbixæ·»åŠ ç›‘æ§ zabbix web ç«¯æ“ä½œ å¯¼å…¥æ¨¡æ¿ æ¨¡æ¿åœ¨/opt/orabbix/template/ ç›®å½•ä¸‹é¢ï¼Œå…¨éƒ¨å¯¼å…¥zabbix web å³å¯\næ·»åŠ ä¸»æœº ä¸»æœºåç§°å¿…é¡»è¦å’Œé…è‡³æ–‡ä»¶ä¸­çš„databaseLst ä¸­çš„åç§°ä¸€è‡´\næ·»åŠ oracle æ¨¡æ¿ éªŒè¯ ç›‘æ§åº“çš„å¤§å° é…ç½® query.props é»˜è®¤æŒ‰ç…§ä¸Šé¢çš„æ­¥éª¤å°±å·®ä¸å¤šäº†ï¼Œä½†æ˜¯ä½ å¯¼å…¥æ¨¡æ¿ä¹‹åå°±ä¼šå‘ç°ç›‘æ§é¡¹ç›®ä¸å…¨ï¼Œå¦‚dbsizeåŠdbfilesizeè¿™äº›ç±»ç›®ï¼Œorabbixé»˜è®¤æƒ…å†µä¸‹æœªå¼€å¯æ•°æ®åº“å¤§å°ï¼Œéœ€è¦é…ç½®query.props\ncp /opt/orabbix/conf/query.props /opt/orabbix/conf/query.props.bak vi /opt/orabbix/conf/query.props åœ¨QueryList=ç±»ç›®ä¸‹å¢åŠ dbfilesize,dbsizeï¼Œå¦‚å›¾æ‰€ç¤º\nç„¶ååœ¨è¯¥æ–‡ä»¶çš„æœ«å°¾æ·»åŠ  dbfilesize.Query=select to_char(sum(bytes/1024/1024/10), \u0026#39;FM99999999999999990\u0026#39;) retvalue from dba_data_files dbsize.Query=SELECT to_char(sum( NVL(a.bytes/1024/1024/10 - NVL(f.bytes/1024/1024/10, 0), 0)), \u0026#39;FM99999999999999990\u0026#39;) retvalue \\ FROM sys.dba_tablespaces d, \\ (select tablespace_name, sum(bytes) bytes from dba_data_files group by tablespace_name) a, \\ (select tablespace_name, sum(bytes) bytes from dba_free_space group by tablespace_name) f \\ WHERE d.tablespace_name = a.tablespace_name(+) AND d.tablespace_name = f.tablespace_name(+) \\ AND NOT (d.extent_management like \u0026#39;LOCAL\u0026#39; AND d.contents like \u0026#39;TEMPORARY\u0026#39;) ç”¨ä»¥å®šä¹‰æŸ¥è¯¢dbfilesize,dbsizeçš„SQLè¯­å¥\næ·»åŠ å†…å®¹å¦‚å›¾æ‰€ç¤º\næ³¨é‡Šï¼šè¯­å¥è¿‡é•¿çš„è¯è¦ç”¨ \\ æ¥åˆ†éš”\nè¿™ä¸ªæ—¶å€™å°±å¯ä»¥å¯åŠ¨orabbixæœåŠ¡äº†\nsystemctl restart orabbix æ£€æŸ¥æœåŠ¡ps aux |grep orabbix|wc -l å¦‚æœç­‰äº2å°±è¯´æ˜å¯åŠ¨é‚£ä¸ªæˆåŠŸäº†\næŸ¥çœ‹æ—¥å¿—çœ‹æ˜¯å¦æœ‰æŠ¥é”™\n/opt/orabbix/logs/orabbix.log è¡¨ç©ºé—´ç›‘æ§çš„ä¼˜åŒ– è‡ªå®šä¹‰SQLæ£€æŸ¥ Orabbixæä¾›äº†è¡¨ç©ºé—´çš„ç›‘æ§ï¼Œç›‘æ§é¡¹å¯¹åº”çš„SQL:\nvi /opt/orabbix/conf/query.props tbl_space.Query=SELECT * FROM ( \\ select \u0026#39;- Tablespace -\u0026gt;\u0026#39;,t.tablespace_name ktablespace, \\ \u0026#39;- Type-\u0026gt;\u0026#39;,substr(t.contents, 1, 1) tipo, \\ \u0026#39;- Used(MB)-\u0026gt;\u0026#39;,trunc((d.tbs_size-nvl(s.free_space, 0))/1024/1024) ktbs_em_uso, \\ \u0026#39;- ActualSize(MB)-\u0026gt;\u0026#39;,trunc(d.tbs_size/1024/1024) ktbs_size, \\ \u0026#39;- MaxSize(MB)-\u0026gt;\u0026#39;,trunc(d.tbs_maxsize/1024/1024) ktbs_maxsize, \\ \u0026#39;- FreeSpace(MB)-\u0026gt;\u0026#39;,trunc(nvl(s.free_space, 0)/1024/1024) kfree_space, \\ \u0026#39;- Space-\u0026gt;\u0026#39;,trunc((d.tbs_maxsize - d.tbs_size + nvl(s.free_space, 0))/1024/1024) kspace, \\ \u0026#39;- Perc-\u0026gt;\u0026#39;,decode(d.tbs_maxsize, 0, 0, trunc((d.tbs_size-nvl(s.free_space, 0))*100/d.tbs_maxsize)) kperc \\ from \\ ( select SUM(bytes) tbs_size, \\ SUM(decode(sign(maxbytes - bytes), -1, bytes, maxbytes)) tbs_maxsize, tablespace_name tablespace \\ from ( select nvl(bytes, 0) bytes, nvl(maxbytes, 0) maxbytes, tablespace_name \\ from dba_data_files \\ union all \\ select nvl(bytes, 0) bytes, nvl(maxbytes, 0) maxbytes, tablespace_name \\ from dba_temp_files \\ ) \\ group by tablespace_name \\ ) d, \\ ( select SUM(bytes) free_space, \\ tablespace_name tablespace \\ from dba_free_space \\ group by tablespace_name \\ ) s, \\ dba_tablespaces t \\ where t.tablespace_name = d.tablespace(+) and \\ t.tablespace_name = s.tablespace(+) \\ order by 8) \\ where kperc \u0026gt; 93 \\ and tipo \u0026lt;\u0026gt;\u0026#39;T\u0026#39; \\ and tipo \u0026lt;\u0026gt;\u0026#39;U\u0026#39; tbl_space.NoDataFound=none è¿™ä¸ªSQLä¼šè¿”å›93%æ»¡çš„è¡¨ç©ºé—´ä¿¡æ¯ï¼Œè€Œå¯¹åº”è¿™ä¸ªç›‘æ§é¡¹ï¼Œorabbixä¹Ÿå®šä¹‰äº†è§¦å‘å™¨ï¼Œå› ä¸ºç›‘æ§é¡¹çš„è¿”å›å€¼æ˜¯æ–‡æœ¬ï¼Œè€Œæ²¡æœ‰æ»¡è¶³æ¡ä»¶çš„è®°å½•æ—¶è¿”å›å­—ç¬¦ä¸²â€œnoneâ€œï¼Œæ‰€ä»¥ç›‘æ§é¡¹å¯¹åº”çš„è§¦å‘å™¨ä¼šæ£€æŸ¥è¿”å›å€¼å¼€å¤´æ˜¯ä¸æ˜¯noneï¼Œå¦‚æœä¸æ˜¯ï¼Œå°±æŠ¥è­¦ï¼Œè¿™æ ·ï¼Œç”¨æˆ·é™¤äº†æ”¶åˆ°é¢„è­¦ä¿¡æ¯ï¼Œè¿˜èƒ½ä»è¿”å›å€¼çš„å…·ä½“å€¼ä¸­çœ‹åˆ°å…·ä½“æ—¶å“ªä¸ªè¡¨ç©ºé—´å¿«æ»¡äº†ã€‚\nå½“ç„¶ï¼Œå¤§éƒ¨åˆ†æ—¶é—´ç›‘æ§é¡¹ä¼šè¿”å›noneï¼Œæ‰€ä»¥æˆ‘ä»¬æ— æ³•ç”»å‡ºæ­£å¸¸æœªæ»¡çš„è¡¨ç©ºé—´çš„ç©ºé—´å ç”¨æ—¶é—´æ›²çº¿ã€‚åªæœ‰è¶…è¿‡93%æ…¢æ—¶ï¼Œæˆ‘ä»¬æ‰çŸ¥é“å…·ä½“çš„å ç”¨æƒ…å†µã€‚\næµ‹è¯• æŠŠå€¼è°ƒä¸º5çš„è§¦å‘æ•ˆæœ\nå‚è€ƒæ–‡æ¡£\nhttps://www.cnblogs.com/dujiaxiaoK/p/7719049.html\nhttps://blog.csdn.net/frank0521/article/details/7469457\nhttp://www.zhimengzhe.com/shujuku/other/182171.html\nå®˜æ–¹æ–‡æ¡£\nhttp://www.smartmarmot.com/wiki/index.php/Orabbix\nä½œè€…ï¼šSREè¿ç»´åšå®¢\nåšå®¢åœ°å€ï¼šhttps://www.cnsre.cn\næ–‡ç« åœ°å€ï¼šhttps://www.cnsre.cn/posts/211009115571/\nç›¸å…³è¯é¢˜ï¼šhttps://www.cnsre.cn/tags/zabbix/\n","description":"","id":34,"section":"posts","tags":["zabbix","oracle"],"title":"zabbix ç›‘æ§ oracle æ•°æ®åº“","uri":"http://www.cnsre.cn:80/posts/211009115571/"},{"content":" ä½œè€…ï¼šSREè¿ç»´åšå®¢\nåšå®¢åœ°å€ï¼šhttps://www.cnsre.cn\næ–‡ç« åœ°å€ï¼šhttps://www.cnsre.cn/posts/210930010174/\nç›¸å…³è¯é¢˜ï¼šhttps://www.cnsre.cn/tags/nginx/\nä¸ºäº†å°†å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨ä¹‹é—´çš„è¿æ¥ä» HTTP/1.1 è½¬æ¢ä¸º WebSocketï¼Œä½¿ç”¨äº† HTTP/1.1 ä¸­å¯ç”¨çš„åè®®åˆ‡æ¢æœºåˆ¶ã€‚\nä½†æ˜¯ç”±äº Upgrade æ˜¯ä¸€ä¸ª hop-by-hop æ ‡å¤´ï¼Œå®ƒä¸ä¼šä»å®¢æˆ·ç«¯ä¼ é€’åˆ°ä»£ç†æœåŠ¡å™¨ã€‚é€šè¿‡æ­£å‘ä»£ç†ï¼Œå®¢æˆ·ç«¯å¯ä»¥ä½¿ç”¨è¯¥CONNECT æ–¹æ³•æ¥è§„é¿æ­¤é—®é¢˜ã€‚ç„¶è€Œï¼Œè¿™ä¸é€‚ç”¨äºåå‘ä»£ç†ï¼Œå› ä¸ºå®¢æˆ·ç«¯ä¸çŸ¥é“ä»»ä½•ä»£ç†æœåŠ¡å™¨ï¼Œå¹¶ä¸”éœ€è¦åœ¨ä»£ç†æœåŠ¡å™¨ä¸Šè¿›è¡Œç‰¹æ®Šå¤„ç†ã€‚\nä» 1.3.13 ç‰ˆæœ¬å¼€å§‹ï¼Œnginx å®ç°äº†ç‰¹æ®Šçš„æ“ä½œæ¨¡å¼ï¼Œå¦‚æœä»£ç†æœåŠ¡å™¨è¿”å›ä»£ç ä¸º 101ï¼ˆåˆ‡æ¢åè®®ï¼‰çš„å“åº”ï¼Œå¹¶ä¸”å®¢æˆ·ç«¯é€šè¿‡è¯·æ±‚ä¸­çš„ Upgrade æ ‡å¤´ã€‚\nå¦‚ä¸Šæ‰€è¿°ï¼ŒåŒ…æ‹¬ Upgrade å’Œ Connection åœ¨å†…çš„é€è·³æ ‡å¤´ä¸ä¼šä»å®¢æˆ·ç«¯ä¼ é€’åˆ°ä»£ç†æœåŠ¡å™¨ï¼Œå› æ­¤ä¸ºäº†è®©ä»£ç†æœåŠ¡å™¨äº†è§£å®¢æˆ·ç«¯å°†åè®®åˆ‡æ¢åˆ° WebSocket çš„æ„å›¾ï¼Œè¿™äº›æ ‡å¤´å¿…é¡»æ˜ç¡®ä¼ é€’ï¼š\n1 2 3 4 5 6 location /chat/ { proxy_pass http://backend; proxy_http_version 1.1; proxy_set_header Upgrade $http_upgrade; proxy_set_header Connection \u0026#34;upgrade\u0026#34;; } ä¸€ä¸ªæ›´å¤æ‚çš„ç¤ºä¾‹ï¼Œå…¶ä¸­å¯¹ä»£ç†æœåŠ¡å™¨çš„è¯·æ±‚ä¸­â€œConnectionâ€æ ‡å¤´å­—æ®µçš„å€¼å–å†³äºå®¢æˆ·ç«¯è¯·æ±‚æ ‡å¤´ä¸­â€œUpgradeâ€å­—æ®µçš„å­˜åœ¨ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 http { map $http_upgrade $connection_upgrade { default upgrade; \u0026#39;\u0026#39; close; } server { ... location /chat/ { proxy_pass http://backend; proxy_http_version 1.1; proxy_set_header Upgrade $http_upgrade; proxy_set_header Connection $connection_upgrade; } } é»˜è®¤æƒ…å†µä¸‹ï¼Œå¦‚æœä»£ç†æœåŠ¡å™¨åœ¨ 60 ç§’å†…æ²¡æœ‰ä¼ è¾“ä»»ä½•æ•°æ®ï¼Œè¿æ¥å°†è¢«å…³é—­ã€‚å¯ä»¥ä½¿ç”¨proxy_read_timeoutæŒ‡ä»¤å¢åŠ æ­¤è¶…æ—¶ ã€‚æˆ–è€…ï¼Œå¯ä»¥å°†ä»£ç†æœåŠ¡å™¨é…ç½®ä¸ºå®šæœŸå‘é€ WebSocket ping å¸§ä»¥é‡ç½®è¶…æ—¶å¹¶æ£€æŸ¥è¿æ¥æ˜¯å¦ä»ç„¶æœ‰æ•ˆã€‚\nä½œè€…ï¼šSREè¿ç»´åšå®¢\nåšå®¢åœ°å€ï¼šhttps://www.cnsre.cn\næ–‡ç« åœ°å€ï¼šhttps://www.cnsre.cn/posts/210930010174/\nç›¸å…³è¯é¢˜ï¼šhttps://www.cnsre.cn/tags/nginx/\n","description":"","id":35,"section":"posts","tags":["websocket","nginx"],"title":"Nginx WebSocket ä»£ç†","uri":"http://www.cnsre.cn:80/posts/210930010174/"},{"content":" ä½œè€…ï¼šSREè¿ç»´åšå®¢\nåšå®¢åœ°å€ï¼šhttps://www.cnsre.cn\næ–‡ç« åœ°å€ï¼šhttps://www.cnsre.cn/posts/210928957081/\nç›¸å…³è¯é¢˜ï¼šhttps://www.cnsre.cn/tags/æ•…éšœé›†/\nå‰è¨€ çº¿ä¸ŠæœåŠ¡å™¨ç£ç›˜å‘Šè­¦\nç™»å½•æœåŠ¡å™¨æ£€æŸ¥ç£ç›˜å‘ç°ä¸€ä¸ªå«åš journal çš„æ–‡ä»¶å¤¹å ç”¨äº†å¤§é‡ç©ºé—´ã€‚\né—®é¢˜åˆ†æ Journaldæ˜¯ä»€ä¹ˆ journal æ˜¯ centos7 ä¸­ systemd çš„ä¸€ä¸ªç»„ä»¶ï¼Œç”± journaldå¤„ç†ã€‚æ•è·ç³»ç»Ÿæ—¥å¿—ä¿¡æ¯ã€å†…æ ¸æ—¥å¿—ä¿¡æ¯ï¼Œä»¥åŠæ¥è‡ªåŸå§‹RAMç£ç›˜çš„ä¿¡æ¯ï¼Œæ—©æœŸå¯åŠ¨ä¿¡æ¯ä»¥åŠæ‰€æœ‰æœåŠ¡ä¸­å†™å…¥ STDOUT å’Œ STDERR æ•°æ®æµçš„ä¿¡æ¯ã€‚å¯ä»¥è¯´æ˜¯ä¸º Linux æœåŠ¡å™¨æ‰“é€ çš„ä¸€ç§æ–°ç³»ç»Ÿæ—¥å¿—æ–¹å¼ï¼Œè¿™äº›æ—¥å¿—ä¿¡æ¯å†™å…¥åˆ°äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œä½¿ç”¨ journalctl é˜…è¯»ï¼Œé»˜è®¤å­˜æ”¾åœ¨ /run/log/ ä¸‹ã€‚ Journaldç³»ç»Ÿä¸»è¦ç”±ä¸‰ä¸ªä¸»è¦çš„ç³»ç»Ÿæ—¥è®°æœåŠ¡ç»„ä»¶ç»„æˆï¼š\nå®ˆæŠ¤ç¨‹åºï¼šsystemd æ—¥å¿—æœåŠ¡ç”± systemd-journald å®ˆæŠ¤ç¨‹åºå¤„ç†ã€‚ é…ç½®æ–‡ä»¶ï¼šæ—¥å¿—æœåŠ¡çš„é…ç½®åœ¨ /etc/systemd/journald.conf é‡Œé¢è®¾ç½®ã€‚ æ—¥å¿—æœç´¢ç¨‹åºï¼šç”¨äºæœç´¢æ—¥è®°æ—¥å¿—æ–‡ä»¶çš„ç¨‹åºæ˜¯ journalctlã€‚ journalctlä½¿ç”¨ journalctl å¸¸ç”¨å‘½ä»¤\n1 2 3 4 5 6 7 8 9 10 11 journalctl #æŸ¥çœ‹æ‰€æœ‰æ—¥å¿— journalctl -n 5 #æŸ¥çœ‹æœ€å5æ¡æ—¥å¿— journalctl -p err #æŸ¥çœ‹errç±»å‹çš„æ—¥å¿— journalctl -f #ä¸æ–­è¾“å‡ºæœ€å10æ¡æ—¥å¿— journalctl --since today #æŸ¥çœ‹ä»Šå¤©çš„æ—¥å¿— journalctl --since \u0026#34;2021-9-28 08:00:00\u0026#34; --until \u0026#34;2021-9-28 09:00:00\u0026#34; journalctl -o verbose #æŸ¥çœ‹æ—¥å¿—è¯¦ç»†ä¿¡æ¯ journalctl --disk-usage #æ£€æŸ¥å½“å‰journalä½¿ç”¨ç£ç›˜é‡ journalctl --vacuum-time=2d #åªä¿å­˜2å¤©çš„æ—¥å¿— journalctl --vacuum-size=500M #æœ€å¤§500M journalctl --verify #æ£€æŸ¥journalæ˜¯å¦è¿è¡Œæ­£å¸¸ä»¥åŠæ—¥å¿—æ–‡ä»¶æ˜¯å¦å®Œæ•´æ— æŸå æŒä¹…ä¿å­˜æ—¥å¿—\nç”±äº journald é»˜è®¤æ˜¯ä¿å­˜åœ¨å†…å­˜ä¸­ï¼Œä¸€æ—¦æœåŠ¡å™¨é‡å¯ï¼Œå°±ä¼šä¸¢å¤±ï¼Œä½œä¸ºç”Ÿæˆç¯å¢ƒï¼Œç®¡ç†å‘˜å¿…é¡»ä¿è¯ç³»ç»Ÿä»»ä½•æ—¥å¿—ä¸èƒ½ä¸¢å¤±ï¼Œé€šè¿‡ä¿®æ”¹é…ç½®æ–‡ä»¶åšæŒä¹…ä¿å­˜ã€‚\nåŒæ—¶ï¼Œsystemd-journald.service çš„é…ç½®æ–‡ä»¶ä¸»è¦å‚è€ƒ /etc/systemd/journald.conf çš„å†…å®¹ï¼Œè¯¦ç»†çš„å‚æ•°å¯ä»¥å‚è€ƒå¦‚ä¸‹\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 [Journal] #æ—¥å¿—å­˜å‚¨åˆ°ç£ç›˜ Storage=persistent #å‹ç¼©æ—¥å¿— Compress=yes #ä¸ºæ—¥å¿—æ·»åŠ åºåˆ—å· Seal=yes #æ¯ä¸ªç”¨æˆ·åˆ†åˆ«è®°å½•æ—¥å¿— SplitMode=uid #æ—¥å¿—åŒæ­¥åˆ°ç£ç›˜çš„é—´éš”ï¼Œé«˜çº§åˆ«çš„æ—¥å¿—ï¼Œå¦‚ï¼šCRITã€ALERTã€EMERG ä¸‰ç§æ€»æ˜¯å®æ—¶åŒæ­¥ SyncIntervalSec=1m #å³åˆ¶æ—¥å¿—çš„æœ€å¤§æµé‡ï¼Œæ­¤å¤„æŒ‡ 30s å†…æœ€å¤šè®°å½• 100000 æ¡æ—¥å¿—ï¼Œè¶…å‡ºçš„å°†è¢«ä¸¢å¼ƒ RateLimitInterval=30s #ä¸ RateLimitInterval é…åˆä½¿ç”¨ RateLimitBurst=100000 #é™åˆ¶å…¨éƒ¨æ—¥å¿—æ–‡ä»¶åŠ åœ¨ä¸€èµ·æœ€å¤šå¯ä»¥å ç”¨å¤šå°‘ç©ºé—´ï¼Œé»˜è®¤å€¼æ˜¯10%ç©ºé—´ä¸4Gç©ºé—´ä¸¤è€…ä¸­çš„è¾ƒå°è€… SystemMaxUse=64G #é»˜è®¤å€¼æ˜¯15%ç©ºé—´ä¸4Gç©ºé—´ä¸¤è€…ä¸­çš„è¾ƒå¤§è€… SystemKeepFree=1G #å•ä¸ªæ—¥å¿—æ–‡ä»¶çš„å¤§å°é™åˆ¶ï¼Œè¶…è¿‡æ­¤é™åˆ¶å°†è§¦å‘æ»šåŠ¨ä¿å­˜ SystemMaxFileSize=128M #æ—¥å¿—æ»šåŠ¨çš„æœ€å¤§æ—¶é—´é—´éš”ï¼Œè‹¥ä¸è®¾ç½®åˆ™å®Œå…¨ä»¥å¤§å°é™åˆ¶ä¸ºå‡† MaxFileSec=1day #æ—¥å¿—æœ€å¤§ä¿ç•™æ—¶é—´ï¼Œè¶…è¿‡æ—¶é™çš„æ—§æ—¥å¿—å°†è¢«åˆ é™¤ MaxRetentionSec=100year #æ˜¯å¦è½¬å‘ç¬¦åˆæ¡ä»¶çš„æ—¥å¿—è®°å½•åˆ°æœ¬æœºçš„å…¶å®ƒæ—¥å¿—ç®¡ç†ç³»ç»Ÿï¼Œå¦‚ï¼šrsyslog ForwardToSyslog=yes ForwardToKMsg=no #æ˜¯å¦è½¬å‘ç¬¦åˆæ¡ä»¶çš„æ—¥å¿—åˆ°æ‰€æœ‰ç™»é™†ç”¨æˆ·çš„ç»ˆç«¯ ForwardToWall=yes MaxLevelStore=debug MaxLevelSyslog=err MaxLevelWall=emerg ForwardToConsole=no #TTYPath=/dev/console #MaxLevelConsole=info #MaxLevelKMsg=notice å¤„ç†è¿‡ç¨‹ çŸ¥é“äº†è¿™äº›ï¼Œå°±å¯ä»¥è½»æ¾çš„å¤„ç†è¿™äº›æ—¥å¿—äº†ã€‚\næ£€æŸ¥å½“å‰journalä½¿ç”¨ç£ç›˜é‡\n1 journalctl --disk-usage æ¸…ç†æ–¹æ³•å¯ä»¥é‡‡ç”¨æŒ‰ç…§æ—¥æœŸæ¸…ç†ï¼Œæˆ–è€…æŒ‰ç…§å…è®¸ä¿ç•™çš„å®¹é‡æ¸…ç†ï¼Œåªä¿å­˜2å¤©çš„æ—¥å¿—ï¼Œæœ€å¤§500M\n1 2 journalctl --vacuum-time=2d journalctl --vacuum-size=500M è¦å¯ç”¨æ—¥å¿—é™åˆ¶æŒä¹…åŒ–é…ç½®ï¼Œå¯ä»¥ä¿®æ”¹\n1 2 3 4 5 6 vim /etc/systemd/journald.conf SystemMaxUse=16M ForwardToSyslog=no # é‡å¯ systemctl restart systemd-journald.service æ£€æŸ¥journalæ˜¯å¦è¿è¡Œæ­£å¸¸ä»¥åŠæ—¥å¿—æ–‡ä»¶æ˜¯å¦å®Œæ•´æ— æŸå\n1 journalctl --verify ä½œè€…ï¼šSREè¿ç»´åšå®¢\nåšå®¢åœ°å€ï¼šhttps://www.cnsre.cn\næ–‡ç« åœ°å€ï¼šhttps://www.cnsre.cn/posts/210928957081/\nç›¸å…³è¯é¢˜ï¼šhttps://www.cnsre.cn/tags/æ•…éšœé›†/\n","description":"","id":36,"section":"posts","tags":["journal","æ•…éšœé›†"],"title":"journal logæ—¥å¿—çš„é—®é¢˜","uri":"http://www.cnsre.cn:80/posts/210928957081/"},{"content":" ä½œè€…ï¼šSREè¿ç»´åšå®¢\nåšå®¢åœ°å€ï¼šhttps://www.cnsre.cn\næ–‡ç« åœ°å€ï¼šhttps://www.cnsre.cn/posts/210924925541/\nç›¸å…³è¯é¢˜ï¼šhttps://www.cnsre.cn/tags/docker/\næ–‡ç« é“¾æ¥\nåœ¨å­¦ä¹ K8S çš„è¿‡ç¨‹ä¸­æ€»ï¼Œéƒ¨åˆ†é•œåƒéœ€è¦ä» k8s.grc.io ä»“åº“ä¸­æ‹‰æ‹‰å–ã€‚ä½†æ˜¯å› ä¸ºç½‘ç»œçš„é—®é¢˜å¯¼è‡´æ— æ³•æ‹‰å–ç‹—æ­Œçš„é•œåƒï¼Œä¹Ÿå°±å¯¼è‡´äº†åˆ›å»º pod æ‹‰å–é•œåƒå¤±è´¥ã€‚\nä»Šå¤©å°±è·Ÿå¤§å®¶åˆ†äº«ä¸‹æˆ‘ä»å›½å¤–æ‹‰åˆ°å›½å†…çš„é•œåƒã€‚\næ›¿æ¢è§„åˆ™ åŒç†ï¼Œå…¶ä»–é•œåƒåœ°å€ä¹Ÿå¯ä»¥ç”¨è¯¥ dockerhub çš„åœ°å€ã€‚\nå…·ä½“æ›¿æ¢è§„åˆ™ï¼š\nk8s.gcr.io æ›¿æ¢ä¸º cnsre\ningress-nginx/controller æ›¿æ¢ä¸º ingress-nginx-controller\n1 2 3 k8s.gcr.io/ingress-nginx/controller:v1.0.0 # ç­‰åŒäº cnsre/ingress-nginx-controller:v1.0.0 ä¸¾ä¾‹ æ¯”å¦‚ ingress ä¸­çš„é•œåƒåœ°å€ä¸º k8s.gcr.io/ingress-nginx/controller:v1.0.0\néœ€è¦å°†é•œåƒåœ°å€æ›´æ”¹ä¸ºï¼šcnsre/ingress-nginx-controller:v1.0.0\ndocker pull k8s.gcr.io/ingress-nginx/controller:v1.0.0 # ç­‰åŒäº docker pull cnsre/ingress-nginx-controller:v1.0.0 dockerhub ä¸­æ²¡æœ‰çš„é•œåƒ å¦‚æœ cnsre ä»“åº“ä¸­æ²¡æœ‰çš„ä¸€äº›å›½å¤–é•œåƒéœ€è¦ä¸‹è½½çš„è¯ï¼Œä½ å¯ä»¥åœ¨åœ°å€ç•™è¨€(æœ€å¥½åœ¨ç•™è¨€ä¸­è¡¥å……é‚®ç®±ä¿¡æ¯ï¼Œè¿™æ ·ä½ å°±å¯ä»¥æ”¶åˆ°é€šçŸ¥ã€‚)\nä½œè€…ï¼šSREè¿ç»´åšå®¢\nåšå®¢åœ°å€ï¼šhttps://www.cnsre.cn\næ–‡ç« åœ°å€ï¼šhttps://www.cnsre.cn/posts/210924925541/\nç›¸å…³è¯é¢˜ï¼šhttps://www.cnsre.cn/tags/docker/\n","description":"","id":37,"section":"posts","tags":["docker","kubernetes"],"title":"å›½å¤–é•œåƒæ‹‰å–åˆ°docker hub","uri":"http://www.cnsre.cn:80/posts/210924925541/"},{"content":" ä½œè€…ï¼šSREè¿ç»´åšå®¢\nåšå®¢åœ°å€ï¼šhttps://www.cnsre.cn\næ–‡ç« åœ°å€ï¼šhttps://www.cnsre.cn/posts/210922013357/\nç›¸å…³è¯é¢˜ï¼šhttps://www.cnsre.cn/tags/kubernetes/\nK8S ä½¿ç”¨ kubectl top çœ‹K8Sç›‘æ§\nkubectl top æ˜¯åŸºç¡€å‘½ä»¤ï¼Œä½†æ˜¯éœ€è¦éƒ¨ç½²é…å¥—çš„ç»„ä»¶æ‰èƒ½è·å–åˆ°ç›‘æ§å€¼\néƒ¨ç½² metric-server\nKubernetes Metrics Server æ˜¯ Cluster çš„æ ¸å¿ƒç›‘æ§æ•°æ®çš„èšåˆå™¨ï¼Œkubeadm é»˜è®¤æ˜¯ä¸éƒ¨ç½²çš„ã€‚\nMetrics Server ä¾› Dashboard ç­‰å…¶ä»–ç»„ä»¶ä½¿ç”¨ï¼Œæ˜¯ä¸€ä¸ªæ‰©å±•çš„ APIServerï¼Œä¾èµ–äº API Aggregatorã€‚æ‰€ä»¥ï¼Œåœ¨å®‰è£… Metrics Server ä¹‹å‰éœ€è¦å…ˆåœ¨ kube-apiserver ä¸­å¼€å¯ API Aggregatorã€‚\nMetrics API åªå¯ä»¥æŸ¥è¯¢å½“å‰çš„åº¦é‡æ•°æ®ï¼Œå¹¶ä¸ä¿å­˜å†å²æ•°æ®ã€‚\nMetrics API URI ä¸º /apis/metrics.k8s.io/ï¼Œåœ¨ k8s.io/metrics ä¸‹ç»´æŠ¤ã€‚\nå¿…é¡»éƒ¨ç½² metrics-server æ‰èƒ½ä½¿ç”¨è¯¥ APIï¼Œmetrics-server é€šè¿‡è°ƒç”¨ kubelet Summary API è·å–æ•°æ®.\nä¸æŒ‡å®špod åç§°ï¼Œåˆ™æ˜¾ç¤ºå‘½åç©ºé—´ä¸‹æ‰€æœ‰ podï¼Œ\u0026ndash;containerså¯ä»¥æ˜¾ç¤º pod å†…æ‰€æœ‰çš„container\næŒ‡æ ‡å«ä¹‰ï¼š\nå’Œk8sä¸­çš„requestã€limitä¸€è‡´ï¼ŒCPUå•ä½100m=0.1 å†…å­˜å•ä½1Mi=1024Ki\npodçš„å†…å­˜å€¼æ˜¯å…¶å®é™…ä½¿ç”¨é‡ï¼Œä¹Ÿæ˜¯åšlimité™åˆ¶æ—¶åˆ¤æ–­oomçš„ä¾æ®ã€‚podçš„ä½¿ç”¨é‡ç­‰äºå…¶æ‰€æœ‰ä¸šåŠ¡å®¹å™¨çš„æ€»å’Œï¼Œä¸åŒ…æ‹¬ pause å®¹å™¨ï¼Œå€¼ç­‰äºcadvisrä¸­çš„container_memory_working_set_bytesæŒ‡æ ‡\nnodeçš„å€¼å¹¶ä¸ç­‰äºè¯¥node ä¸Šæ‰€æœ‰ pod å€¼çš„æ€»å’Œï¼Œä¹Ÿä¸ç­‰äºç›´æ¥åœ¨æœºå™¨ä¸Šè¿è¡Œ top æˆ– free çœ‹åˆ°çš„å€¼\nè¦æ±‚ æ³¨æ„ï¼šä½¿ç”¨ Metrics Server æœ‰å¿…å¤‡ä¸¤ä¸ªæ¡ä»¶ï¼š\nAPI Server å¯ç”¨ Aggregator Routing æ”¯æŒ API Server èƒ½è®¿é—® Metrics Server Pod IP å¯ç”¨API Aggregator å®‰è£… metric-server ä¸‹è½½yamlæ–‡ä»¶ å¯ä»¥é€šè¿‡è¿è¡Œä»¥ä¸‹å‘½ä»¤ä¸‹è½½æœ€æ–°çš„ Metrics Server ç‰ˆæœ¬ï¼š\n1 wget https://github.com/kubernetes-sigs/metrics-server/releases/latest/download/components.yaml å…¼å®¹æ€§ï¼š\næŒ‡æ ‡æœåŠ¡å™¨ æŒ‡æ ‡ API ç»„/ç‰ˆæœ¬ æ”¯æŒçš„ Kubernetes ç‰ˆæœ¬ 0.6.x metrics.k8s.io/v1beta1 *1.19+ 0.5.x metrics.k8s.io/v1beta1 *1.8+ 0.4.x metrics.k8s.io/v1beta1 *1.8+ 0.3.x metrics.k8s.io/v1beta1 1.8-1.21 å¯¹äº \u0026lt;1.16 éœ€è¦--authorization-always-allow-paths=/livez,/readyz ä¿®æ”¹é•œåƒåœ°å€ å›½å†…æ— æ³•ä¸‹è½½ k8s.gcr.io/metrics-server/metrics-server:v0.4.1é•œåƒ\néœ€è¦ä¿®æ”¹ä¸ºä¸€ä¸‹é•œåƒåœ°å€\n1 cnsre/metrics-server-metrics-server:v0.4.1 æ·»åŠ  \u0026ndash;kubelet-insecure-tlså‚æ•° 1 2 3 4 5 6 7 8 spec: containers: - args: - --cert-dir=/tmp - --secure-port=4443 - --kubelet-preferred-address-types=InternalIP,ExternalIP,Hostname - --kubelet-use-node-status-port - --kubelet-insecure-tls # æ–°å¢å†…å®¹ éƒ¨ç½²metrics-serveræœåŠ¡ 1 kubectl apply -f components.yaml æŸ¥çœ‹çŠ¶æ€ 1 2 3 [root@master ~]# kubectl -n kube-system get deploy metrics-server NAME READY UP-TO-DATE AVAILABLE AGE metrics-server 1/1 1 1 9m39s æµ‹è¯• 1 2 3 4 5 6 7 8 9 10 11 12 [root@master ~]# kubectl top node NAME CPU(cores) CPU% MEMORY(bytes) MEMORY% master 294m 8% 5971Mi 41% node1 198m 5% 3800Mi 26% [root@master ~]# kubectl top pods NAME CPU(cores) MEMORY(bytes) cnsre-deployment-cf6fddb9f-bvfdk 1m 1Mi cnsre-deployment-cf6fddb9f-d8spc 1m 1Mi cnsre-deployment-cf6fddb9f-nrrhz 1m 1Mi nfs-client-provisioner-fd74f99b4-gk8l4 4m 8Mi tomcat-deployment-66dc86bb8f-6xj28 2m 974Mi tomcat-deployment-66dc86bb8f-db66l 2m 884Mi ä½œè€…ï¼šSREè¿ç»´åšå®¢\nåšå®¢åœ°å€ï¼šhttps://www.cnsre.cn\næ–‡ç« åœ°å€ï¼šhttps://www.cnsre.cn/posts/210922013357/\nç›¸å…³è¯é¢˜ï¼šhttps://www.cnsre.cn/tags/kubernetes/\n","description":"","id":38,"section":"posts","tags":["kubernetes","metric-server"],"title":"kubernetes éƒ¨ç½² metric-server","uri":"http://www.cnsre.cn:80/posts/210922013357/"},{"content":" ä½œè€…ï¼šSREè¿ç»´åšå®¢\nåšå®¢åœ°å€ï¼šhttps://www.cnsre.cn\næ–‡ç« åœ°å€ï¼šhttps://www.cnsre.cn/posts/210917128049/\nç›¸å…³è¯é¢˜ï¼šhttps://www.cnsre.cn/tags/kubernetes/\nä¸‹è½½deployment æˆ‘è¿™é‡Œä¿å­˜æˆkube-event.yaml\n# cat kube-event.yaml --- apiVersion: apps/v1 kind: Deployment metadata: labels: name: kube-eventer name: kube-eventer namespace: kube-system spec: replicas: 1 selector: matchLabels: app: kube-eventer template: metadata: labels: app: kube-eventer annotations: scheduler.alpha.kubernetes.io/critical-pod: \u0026#39;\u0026#39; spec: dnsPolicy: ClusterFirstWithHostNet serviceAccount: kube-eventer containers: - image: registry.aliyuncs.com/acs/kube-eventer-amd64:v1.2.0-484d9cd-aliyun name: kube-eventer command: - \u0026#34;/kube-eventer\u0026#34; - \u0026#34;--source=kubernetes:https://kubernetes.default\u0026#34; ## .e.g,dingtalk sink demo #- --sink=dingtalk:[your_webhook_url]\u0026amp;label=[your_cluster_id]\u0026amp;level=[Normal or Warning(default)] - --sink=dingtalk:https://oapi.dingtalk.com/robot/send?access_token=355cf0156xxxxxxxxxxxxxxxxxx\u0026amp;level=Warning env: # If TZ is assigned, set the TZ value as the time zone - name: TZ value: \u0026#34;Asia/Shanghai\u0026#34; volumeMounts: - name: localtime mountPath: /etc/localtime readOnly: true - name: zoneinfo mountPath: /usr/share/zoneinfo readOnly: true resources: requests: cpu: 100m memory: 100Mi limits: cpu: 500m memory: 250Mi volumes: - name: localtime hostPath: path: /etc/localtime - name: zoneinfo hostPath: path: /usr/share/zoneinfo --- apiVersion: rbac.authorization.k8s.io/v1 kind: ClusterRole metadata: name: kube-eventer rules: - apiGroups: - \u0026#34;\u0026#34; resources: - configmaps - events verbs: - get - list - watch --- apiVersion: rbac.authorization.k8s.io/v1 kind: ClusterRoleBinding metadata: name: kube-eventer roleRef: apiGroup: rbac.authorization.k8s.io kind: ClusterRole name: kube-eventer subjects: - kind: ServiceAccount name: kube-eventer namespace: kube-system --- apiVersion: v1 kind: ServiceAccount metadata: name: kube-eventer namespace: kube-system é’‰é’‰ç¾¤é‡Œåˆ›å»ºè‡ªå®šä¹‰webhook è®¾ç½®\u0026ndash;æ™ºèƒ½ç¾¤åŠ©æ‰‹\u0026ndash;æ·»åŠ æœºå™¨äºº\u0026ndash;é€‰æ‹©WeebHookã€‚å®šä¹‰æœºå™¨äººåç§°å’Œå®‰å…¨è®¾ç½®\nå®‰å…¨è®¾ç½®è¿™é‡Œæˆ‘å®šä¹‰äº†å…³é”®å­—ï¼ŒWaringã€‚åˆ›å»ºåå¤åˆ¶webhookåœ°å€ã€‚ç„¶åæ›´æ”¹ä¸Šé¢deploymentä¸­çš„sinkå¤„ã€‚\næˆ‘æŠŠä¸Šé¢çš„labelåˆ æ‰äº†ï¼Œåªç•™ä¸‹äº†level=Waringï¼Œåˆšå¥½å¯¹åº”äº†æˆ‘å…³é”®å­—çš„Waringã€‚åªæœ‰å¸¦æœ‰å…³é”®å­—çš„æ‰ä¼šè§¦å‘å‘Šè­¦ã€‚\næµ‹è¯•å‘Šè­¦ ç„¶ååˆ›å»ºä¸€ä¸ªæµ‹è¯•çš„Tomcatçš„deploymentï¼Œæ•…æ„æŠŠimageé•œåƒçš„tagå†™é”™ï¼Œè®©ä»–æ— æ³•æ‹‰å–é•œåƒ\n[root@master allenjol]# kubectl apply -f deploy-tomcat-test.yaml deployment.apps/tomcat-deployment-allenjol created service/tomcat-service-allenjol created [root@master allenjol]# kubectl get po NAME READY STATUS RESTARTS AGE tomcat-deployment-allenjol-b6687f99-l5vj9 0/1 ImagePullBackOff 0 45s éƒ¨ç½²kube-event.yamlå¹¶æŸ¥çœ‹æ—¥å¿—ã€‚å¯ä»¥çœ‹åˆ°éš”30så»æ£€æµ‹ä¸€æ¬¡\n]# kubectl apply -f kube-event.yaml ]# kubectl get po -n kube-system | grep kube-event [root@master allenjol]# kubectl logs -f kube-eventer-648f64c985-zfkkg -n kube-system I0708 09:26:36.409034 1 eventer.go:67] /kube-eventer --source=kubernetes:https://kubernetes.default --sink=dingtalk:https://oapi.dingtalk.com/robot/send?access_token=355cf01569aef206dc6c05681aaf3ed0ea19ed3597db4c26c565dbeb69ce1303\u0026amp;level=Warning I0708 09:26:36.409191 1 eventer.go:68] kube-eventer version: v1.2.0 commit: 484d9cd I0708 09:26:36.411557 1 eventer.go:94] Starting with DingTalkSink sink I0708 09:26:36.411596 1 eventer.go:108] Starting eventer I0708 09:26:36.411678 1 eventer.go:116] Starting eventer http service I0708 09:27:00.000163 1 manager.go:102] Exporting 5 events I0708 09:27:30.000130 1 manager.go:102] Exporting 9 events I0708 09:28:00.000147 1 manager.go:102] Exporting 1 events I0708 09:28:30.000150 1 manager.go:102] Exporting 4 events I0708 09:29:00.000138 1 manager.go:102] Exporting 1 events ... å¯ä»¥çœ‹åˆ°è¿™é‡Œå·²ç»çœ‹åˆ°äº†é’‰é’‰çš„webhookåœ°å€äº†ï¼Œå¹¶ä¸”è¿˜æ”¶é›†åˆ°äº†eventsã€‚\næŸ¥çœ‹é’‰é’‰ç¾¤ï¼Œå°±ä¼šçœ‹åˆ°å·²ç»å‡ºç°äº†å‘Šè­¦äº†ã€‚\nå…¶å®è¿™ä¸ªå‘Šè­¦å½“å‰è¿˜å­˜åœ¨ç‚¹é—®é¢˜ã€‚ä¸ªäººè®¤ä¸ºä¸åº”è¯¥è¿™ä¹ˆé¢‘ç¹å‘é€ï¼Œåº”è¯¥åƒprometheusä¸€æ ·å¯ä»¥é…ç½®æŠ‘åˆ¶å’Œé™é»˜ã€‚ç„¶åç›‘æ§æ—¶é—´å¯ä»¥æ›´æ”¹ã€‚å½“ç„¶ç†Ÿæ‚‰goè¯­è¨€å¯ä»¥è‡ªå·±æ”¹æºç ç„¶åæ„å»ºæˆé•œåƒã€‚\nä½œè€…ï¼šSREè¿ç»´åšå®¢\nåšå®¢åœ°å€ï¼šhttps://www.cnsre.cn\næ–‡ç« åœ°å€ï¼šhttps://www.cnsre.cn/posts/210917128049/\nç›¸å…³è¯é¢˜ï¼šhttps://www.cnsre.cn/tags/kubernetes/\n","description":"kube-eventeräº‹ä»¶ç›‘æ§é€šè¿‡é’‰é’‰å‘Šè­¦","id":39,"section":"posts","tags":["kubernetes","kube-eventer"],"title":"kube-eventeräº‹ä»¶ç›‘æ§","uri":"http://www.cnsre.cn:80/posts/210917128049/"},{"content":" ä½œè€…ï¼šSREè¿ç»´åšå®¢\nåšå®¢åœ°å€ï¼šhttps://www.cnsre.cn\næ–‡ç« åœ°å€ï¼šhttps://www.cnsre.cn/posts/210915154434/\nç›¸å…³è¯é¢˜ï¼šhttps://www.cnsre.cn/tags/æ•…éšœé›†/\næƒ…å†µä»‹ç» è´Ÿè´£çš„é¡¹ç›®ä¸‹æœ‰ä¸€æ‰¹ ubuntu 18.04 çš„æœåŠ¡å™¨åœ¨ AWS ä¸Šï¼Œå› ä¸ºå®‰å…¨çš„é—®é¢˜ï¼Œéœ€è¦æŠŠå†…æ ¸ä» 5.3.0 å‡çº§åˆ° 5.4.0ã€‚\né¦–æ¬¡å‡çº§ä¸ºæµ‹è¯•ç¯å¢ƒæµ‹ä¸¤å°éƒ½æ˜¯ubuntu 18.04 çš„ç‰ˆæœ¬ å†…æ ¸ä¹Ÿéƒ½ä¸º5.3.0ã€‚ç¬¬ä¸€å°å‡çº§è¿›å±•å¾ˆé¡ºåˆ©ã€‚è½¯ä»¶æ›´æ–°ï¼Œç„¶åå†…æ ¸è¿›è¡Œå•ç‹¬å‡çº§ã€‚ç­‰åˆ°éœ€è¦é‡å¯çš„æ—¶å€™å‡ºç°äº†é—®é¢˜ã€‚\nå¤„ç†é—®é¢˜åŠè§£å†³æ€è·¯ é—®é¢˜1 æ— æ³•æŒ‚è½½ç£ç›˜\né¦–å…ˆé‡åˆ°çš„ç¬¬ä¸€ä¸ªé—®é¢˜\nè§£å†³æ€è·¯ï¼š\nå‡çº§å†…æ ¸å¯¼è‡´ boot ç©ºé—´è¶Šæ¥è¶Šå°ï¼Œç„¶åå¯¼è‡´æ— æ³•å¼•å¯¼è¿›å…¥ç³»ç»Ÿã€‚å› ä¸ºä¹‹å‰é‡åˆ°è¿‡bootç©ºé—´å æ»¡çš„æƒ…å†µã€‚ä½†æ˜¯é‚£æ˜¯åœ¨ kvm çš„ vm ä¸­ï¼Œå¯ä»¥é€šè¿‡ VNC è¿›è¡Œé“¾æ¥ä¿®å¤ã€‚è¿™åœ¨ aws ä¸Šæ€ä¹ˆåŠï¼Ÿ\nè§£å†³æ–¹æ³•ï¼š\nä¸€å¼€å§‹æˆ‘é€‰æ‹©äº†å°†æ”¹æœåŠ¡å™¨çš„æ ¹ç£ç›˜å–æ¶ˆæŒ‚è½½ã€‚ç„¶åæŒ‚è½½åˆ°åŒä¸€å¯ç”¨åŒºçš„å…¶ä»–æœåŠ¡å™¨ä¸Šï¼Œè¿›è¡Œä¿®å¤ã€‚å› ä¸ºç£ç›˜æ ¼å¼çš„é—®é¢˜ï¼Œå§‹ç»ˆæŒ‚è½½ä¸ä¸Šï¼Œä¸ºäº†é¿å…æµªè´¹æ—¶é—´ï¼Œåªèƒ½ä»¥å¿«ç…§æ¢å¤çš„æ–¹å¼å°†æ ¹ç£ç›˜è¿›è¡Œæ‰©å®¹ã€‚\nä»¥å¿«ç…§çš„æ–¹å¼æ¢å¤äº†å›å¤ï¼Œåœ¨å¿«ç…§æ¢å¤çš„è¿‡ç¨‹ä¸­å°†æ ¹ç£ç›˜æ‰©å®¹çš„æ–¹æ³•æœç„¶å°†æœåŠ¡å™¨è¿è¡Œèµ·æ¥äº†ã€‚\nåé¢å°±æ¥ç€å°è¯•è¿›è¡Œå†…æ ¸å‡çº§\u0026hellip;.\né—®é¢˜2 å†…æ ¸å‡çº§æ•°æ®åº“ä¾èµ–æŠ¥é”™ï¼Ÿ\nå…·ä½“å†…å®¹å¦‚ä¸‹ï¼š\nè§£å†³æ€è·¯ï¼š\nè¿™ä¸ªé—®é¢˜ï¼ŒçœŸçš„æ˜¯æ²¡æœ‰æ€è·¯ã€‚å¤„ç†äº†å¾ˆä¹…ï¼Œéƒ½æ²¡æœ‰è§£å†³è¿™ä¸ªé—®é¢˜ã€‚è¿˜å¸Œæœ›æœ‰æ€è·¯çš„èƒ½åˆ°æŒ‡å¯¼ä¸‹ã€‚\nè§£å†³æ–¹æ³•:\nä¸ºäº†å¿«é€Ÿè§£å†³å†…æ ¸å‡çº§çš„é—®é¢˜ï¼Œæˆ‘å°† mysql ä»¥åŠç›¸å…³çš„ä¾èµ–éƒ½å¸è½½æ‰äº†ã€‚\né—®é¢˜3 å‡çº§å®Œé‡å¯å¤±è´¥ï¼Ÿ\nè¿™ä¸ªé—®é¢˜ä¹Ÿæ˜¯æœ€å¤§çš„é—®é¢˜ï¼Œæœ€æ˜æ˜¾çš„è¡¨ç°å°±æ˜¯ã€‚å‡çº§æ²¡æœ‰æŠ¥é”™ï¼Œä½†æ˜¯å‡çº§å®Œéœ€è¦é‡å¯ï¼ŒæœåŠ¡å™¨è¿›è¡Œé‡å¯çš„æ—¶å€™æ— æ³•è¿›å…¥æ“ä½œç³»ç»Ÿã€‚\næ­¤æ—¶å·²ç»æ˜¯å‡Œæ™¨4ç‚¹å¤šé’Ÿäº†ï¼Œå·²ç»å¾ˆè¿·ç³Šäº†ã€‚ç„¶åå°±æŠŠæœåŠ¡å™¨æ¢å¤åˆ°å‡çº§å†…æ ¸å‰çš„æ ·å­ã€‚æ‰“ç®—æ˜å¤©å¯åŠ¨å¿«ç…§è¿›è¡Œå¤ç°ã€‚\nè§£å†³æ€è·¯ï¼š\nåˆæ˜¯æŒ‚è½½å¤±è´¥ï¼Ÿæ€ä¹ˆåˆä¼šé‡åˆ°æŒ‚è½½å¤±è´¥å‘¢ï¼Ÿæœ€åå‘ç°é‡å¯è‡ªåŠ¨æŒ‚è½½ç£ç›˜çš„é…ç½®å¹¶æ²¡æœ‰æŒ‰ç…§å®˜æ–¹çš„æŒ‡ç¤ºå»åšä½¿ç”¨UUIDçš„é…ç½®å¼€å¯æŒ‚è½½ç›˜ç¬¦ã€‚ä»è€Œç³»ç»Ÿä¼šæ£€æµ‹ç£ç›˜çš„è¿‡ç¨‹ä¸­ä¼šæ£€æµ‹åˆ°è¯¥é”™è¯¯ã€‚æ— æ³•æ­£å¸¸è¿›å¦‚ç³»ç»Ÿã€‚\nè§£å†³æ–¹æ³•ï¼š\nå¦‚æœæ˜¯ç‰©ç†æœºï¼Œæˆ–è€…æ˜¯å¯ä»¥é€šè¿‡å…¶ä»–æ–¹å¼è¿›è¡Œæ§åˆ¶å¼•å¯¼çš„è¯è¿˜å¯ä»¥ä¿®å¤ã€‚ä½†æ˜¯äº‘ä¸»æœºæ€ä¹ˆä¿®å¤å‘¢ï¼Ÿåªèƒ½å»ä¿®å¤ç£ç›˜äº†\nåœ¨äº‘ä¸»æœºä¸Šæœ‰ä¸¤ç§è®¿é—®ç£ç›˜å·çš„æ–¹æ³•\næ–¹æ³• 1ï¼šä½¿ç”¨ EC2 æ§åˆ¶å°\nï¼ˆæ‘˜è‡ª AWS æ–‡æ¡£ï¼‰\nå¦‚æœæ‚¨ä¸º Linux å¯ç”¨äº† EC2 ä¸²è¡Œæ§åˆ¶å°ï¼Œåˆ™å¯ä»¥ä½¿ç”¨å®ƒæ¥æ’æŸ¥å—æ”¯æŒçš„åŸºäº Nitro çš„å®ä¾‹ç±»å‹é—®é¢˜ã€‚ä¸²è¡Œæ§åˆ¶å°å¯å¸®åŠ©æ‚¨æ’æŸ¥å¯åŠ¨é—®é¢˜ã€ç½‘ç»œé…ç½®å’Œ SSH é…ç½®é—®é¢˜ã€‚ä¸²è¡Œæ§åˆ¶å°æ— éœ€ç½‘ç»œè¿æ¥å³å¯è¿æ¥åˆ°æ‚¨çš„å®ä¾‹ã€‚æ‚¨å¯ä»¥ä½¿ç”¨ Amazon EC2 æ§åˆ¶å°æˆ– AWS å‘½ä»¤è¡Œç•Œé¢ (AWS CLI) è®¿é—®ä¸²è¡Œæ§åˆ¶å°ã€‚\nåœ¨ä½¿ç”¨ä¸²è¡Œæ§åˆ¶å°ä¹‹å‰ï¼Œè¯·åœ¨è´¦æˆ·å±‚é¢æˆäºˆå¯¹ä¸²è¡Œæ§åˆ¶å°çš„è®¿é—®æƒé™ã€‚ç„¶åï¼Œåˆ›å»º AWS Identity and Access Management (IAM) ç­–ç•¥ï¼Œæˆäºˆå¯¹ IAM ç”¨æˆ·çš„è®¿é—®æƒé™ã€‚æ­¤å¤–ï¼Œæ¯ä¸ªä½¿ç”¨ä¸²è¡Œæ§åˆ¶å°çš„å®ä¾‹éƒ½å¿…é¡»è‡³å°‘åŒ…å«ä¸€ä¸ªåŸºäºå¯†ç çš„ç”¨æˆ·ã€‚å¦‚æœæ‚¨çš„å®ä¾‹æ— æ³•è®¿é—®ï¼Œå¹¶ä¸”å°šæœªé…ç½®å¯¹ä¸²è¡Œæ§åˆ¶å°çš„è®¿é—®æƒé™ï¼Œè¯·æŒ‰ç…§æ–¹æ³• 2 ä¸­çš„è¯´æ˜è¿›è¡Œæ“ä½œã€‚æœ‰å…³ä¸º Linux é…ç½® EC2 ä¸²è¡Œæ§åˆ¶å°çš„ä¿¡æ¯ï¼Œè¯·å‚é˜…é…ç½®å¯¹ EC2 ä¸²è¡Œæ§åˆ¶å°çš„è®¿é—®æƒé™ã€‚\næ³¨æ„ï¼šå¦‚æœåœ¨è¿è¡Œ AWS CLI å‘½ä»¤æ—¶é‡åˆ°é”™è¯¯ï¼Œè¯·ç¡®ä¿æ‚¨ä½¿ç”¨çš„æ˜¯æœ€æ–°ç‰ˆæœ¬çš„ AWS CLIã€‚\næ–¹æ³• 2ï¼šæŒ‚è½½åˆ°å…¶ä»–å®ä¾‹ä¸Š\nåˆ›å»ºä¸€ä¸ªä¸´æ—¶æ•‘æ´å®ä¾‹ï¼Œç„¶åå°†æ‚¨çš„ Amazon Elastic Block Store (Amazon EBS) å·é‡æ–°æŒ‚è½½åˆ°è¯¥æ•‘æ´å®ä¾‹ä¸Šã€‚ä»è¯¥æ•‘æ´å®ä¾‹ä¸­ï¼Œæ‚¨å¯ä»¥å°† GRUB é…ç½®ä¸ºä½¿ç”¨ä»¥å‰çš„å†…æ ¸è¿›è¡Œå¯åŠ¨ã€‚\n**é‡è¦æç¤ºï¼š**è¯·å‹¿åœ¨å®ä¾‹å­˜å‚¨æ”¯æŒçš„å®ä¾‹ä¸Šæ‰§è¡Œæ­¤æ“ä½œã€‚ç”±äºæ­¤æ¢å¤æ–¹æ³•éœ€è¦é¦–å…ˆåœæ­¢ç„¶åå†é‡å¯å®ä¾‹ï¼Œè¯¥å®ä¾‹ä¸Šçš„ä»»ä½•æ•°æ®éƒ½å°†ä¸¢å¤±ã€‚æœ‰å…³æ›´å¤šä¿¡æ¯ï¼Œè¯·å‚é˜…ç¡®å®šå®ä¾‹çš„æ ¹è®¾å¤‡ç±»å‹ã€‚\nä¸ºæ ¹å·åˆ›å»º EBS å¿«ç…§ã€‚æœ‰å…³æ›´å¤šä¿¡æ¯ï¼Œè¯·å‚é˜…åˆ›å»º Amazon EBS å¿«ç…§ã€‚ æ‰“å¼€ Amazon EC2 æ§åˆ¶å°ã€‚ æ³¨æ„ï¼š è¯·ç¡®ä¿æ‚¨ä½äºæ­£ç¡®çš„åŒºåŸŸã€‚ ä»å¯¼èˆªçª—æ ¼ä¸­é€‰æ‹© å®ä¾‹ï¼Œç„¶åé€‰æ‹©å—æŸçš„å®ä¾‹ã€‚ é€‰æ‹© Instance Stateï¼ˆå®ä¾‹çŠ¶æ€ï¼‰ã€Stop Instanceï¼ˆåœæ­¢å®ä¾‹ï¼‰ï¼Œç„¶åé€‰æ‹© Stopï¼ˆåœæ­¢ï¼‰ã€‚ åœ¨ **Storageï¼ˆå­˜å‚¨ï¼‰**é€‰é¡¹å¡çš„ **Block devicesï¼ˆå—å‚¨å­˜è®¾å¤‡ï¼‰**ä¸‹ï¼Œä¸º /dev/sda1 æˆ– /dev/xvda é€‰æ‹© Volume IDï¼ˆå· IDï¼‰ã€‚ ä¾æ¬¡é€‰æ‹© æ“ä½œ ã€ æ–­å¼€å· ï¼Œç„¶åé€‰æ‹© æ˜¯ï¼Œè¯·åˆ†ç¦» ã€‚è®°ä¸‹å¯ç”¨åŒºã€‚ åœ¨åŒä¸€å¯ç”¨åŒºä¸­å¯åŠ¨ä¸€ä¸ªæ•‘æ´ EC2 å®ä¾‹ã€‚ å¯åŠ¨æ•‘æ´å®ä¾‹åï¼Œä»å¯¼èˆªçª—æ ¼ä¸­é€‰æ‹© å·ï¼Œç„¶åé€‰æ‹©å—æŸå®ä¾‹å·²åˆ†ç¦»çš„æ ¹å·ã€‚ ä¾æ¬¡é€‰æ‹© æ“ä½œã€é™„åŠ å· ã€‚ é€‰æ‹©æ•‘æ´å®ä¾‹ ID (id-xxxxx)ï¼Œç„¶åè®¾ç½®ä¸€ä¸ªæœªä½¿ç”¨çš„è®¾å¤‡ã€‚åœ¨æœ¬ç¤ºä¾‹ä¸­ä¸º /dev/sdfã€‚ ä½¿ç”¨ SSH è¿æ¥åˆ°æ•‘æ´å®ä¾‹ã€‚ è¿è¡Œ lsblk å‘½ä»¤ä»¥æŸ¥çœ‹å¯ç”¨çš„ç£ç›˜è®¾å¤‡ï¼š lsblk # è¾“å‡ºå¦‚ä¸‹ï¼š xvda 202:0 0 20G 0 disk â””â”€xvda1 202:1 0 20G 0 part / xvdb 202:16 0 100G 0 disk xvdf 202:80 0 15G 0 disk â””â”€xvdf1 202:81 0 15G 0 part # è¯¥ç£ç›˜ä¸ºæ•…éšœé›†æœåŠ¡å™¨æ ¹ç£ç›˜ æŸ¥çœ‹ç£ç›˜æ ¼å¼\nlsblk -f NAME FSTYPE LABEL UUID MOUNTPOINT xvda â””â”€xvda1 ext4 cloudimg-rootfs d32458a7-7f4c-415f-9a66-b579f14fb82d / xvdb ext4 eb0e325a-471c-4a99-a9be-a3ee296c2405 xvdf â””â”€xvdf1 ext4 cloudimg-rootfs d32458a7-7f4c-415f-9a66-b579f14fb82d æŒ‚è½½ç£ç›˜\nsudo -i mount /dev/xvdf1 /mnt ç„¶åæŸ¥çœ‹æŒ‚è½½ç›®å½•ï¼Œå‘ç°æ ¹ç£ç›˜å·²ç»æŒ‚è½½åˆ°äº†mntä¸‹\næŸ¥çœ‹é…ç½®æ–‡ä»¶\nubuntu@ip-10-0-20-27:~$ cat /etc/fstab LABEL=cloudimg-rootfs / ext4 defaults,discard 0 0 /dev/nvme0n1 /data ext4 defaults 0 0 æŸ¥çœ‹å®˜ç½‘æŒ‚è½½æ–‡æ¡£å¦‚ä¸‹ï¼š\né‡å¯åè‡ªåŠ¨æŒ‚è½½é™„åŠ çš„å· (æ‘˜è‡ªAWS å®˜æ–¹æ–‡æ¡£)\nè¦åœ¨æ¯æ¬¡ç³»ç»Ÿé‡å¯æ—¶é™„åŠ é™„åŠ çš„ EBS å·ï¼Œå¯åœ¨ /etc/fstab æ–‡ä»¶ä¸­ä¸ºè¯¥è®¾å¤‡æ·»åŠ ä¸€ä¸ªæ¡ç›®ã€‚\næ‚¨å¯ä»¥åœ¨ /dev/xvdf ä¸­ä½¿ç”¨è®¾å¤‡åç§°ï¼ˆå¦‚ /etc/fstabï¼‰ï¼Œä½†å»ºè®®æ”¹ä¸ºä½¿ç”¨è®¾å¤‡çš„ 128 ä½é€šç”¨å”¯ä¸€æ ‡è¯†ç¬¦ (UUID)ã€‚è®¾å¤‡åç§°å¯ä»¥æ›´æ”¹ï¼Œä½† UUID ä¼šåœ¨æ•´ä¸ªåˆ†åŒºçš„ä½¿ç”¨å¯¿å‘½æœŸé—´ä¿ç•™ã€‚é€šè¿‡ä½¿ç”¨ UUIDï¼Œæ‚¨å¯ä»¥å‡å°‘ç³»ç»Ÿåœ¨ç¡¬ä»¶é‡æ–°é…ç½®åæ— æ³•å¯åŠ¨çš„æœºä¼šã€‚æœ‰å…³æ›´å¤šä¿¡æ¯ï¼Œè¯·å‚é˜…è¯†åˆ« EBS è®¾å¤‡ã€‚\né‡å¯åè‡ªåŠ¨é™„åŠ é™„åŠ å·\nï¼ˆå¯é€‰ï¼‰åˆ›å»º /etc/fstab æ–‡ä»¶çš„å¤‡ä»½ï¼Œä»¥ä¾¿åœ¨ç¼–è¾‘æ—¶è¯¯æŸåæˆ–åˆ é™¤æ­¤æ–‡ä»¶æ—¶ä½¿ç”¨ã€‚\n[ec2-user ~]$ sudo cp /etc/fstab /etc/fstab.orig ä½¿ç”¨ blkid å‘½ä»¤æŸ¥æ‰¾è®¾å¤‡çš„ UUIDã€‚è®°ä¸‹è¦åœ¨é‡æ–°å¯åŠ¨åæŒ‚è½½çš„è®¾å¤‡çš„ UUIDã€‚åœ¨ä¸‹ä¸€æ­¥ä¸­æ‚¨å°†éœ€è¦ç”¨åˆ°å®ƒã€‚\nä¾‹å¦‚ï¼Œä»¥ä¸‹å‘½ä»¤æ˜¾ç¤ºæœ‰ä¸¤ä¸ªè®¾å¤‡æŒ‚è½½åˆ°å®ä¾‹ä¸Šï¼Œå¹¶æ˜¾ç¤ºäº†ä¸¤ä¸ªè®¾å¤‡çš„ UUIDã€‚\n[ec2-user ~]$ sudo blkid /dev/xvda1: LABEL=\u0026#34;/\u0026#34; UUID=\u0026#34;ca774df7-756d-4261-a3f1-76038323e572\u0026#34; TYPE=\u0026#34;xfs\u0026#34; PARTLABEL=\u0026#34;Linux\u0026#34; PARTUUID=\u0026#34;02dcd367-e87c-4f2e-9a72-a3cf8f299c10\u0026#34; /dev/xvdf: UUID=\u0026#34;aebf131c-6957-451e-8d34-ec978d9581ae\u0026#34; TYPE=\u0026#34;xfs\u0026#34; å¯¹äº Ubuntu 18.04ï¼Œè¯·ä½¿ç”¨ lsblk å‘½ä»¤ã€‚\n[ec2-user ~]$ sudo lsblk -o +UUID ä½¿ç”¨ä»»ä½•æ–‡æœ¬ç¼–è¾‘å™¨ï¼ˆå¦‚ /etc/fstab å’Œ nanoï¼‰æ‰“å¼€ vim æ–‡ä»¶ã€‚\n[ec2-user ~]$ sudo vim /etc/fstab å°†ä»¥ä¸‹æ¡ç›®æ·»åŠ åˆ° /etc/fstab ä»¥åœ¨æŒ‡å®šçš„æŒ‚è½½ç‚¹æŒ‚è½½è®¾å¤‡ã€‚è¿™äº›å­—æ®µæ˜¯ blkidï¼ˆæˆ–ç”¨äº Ubuntu 18.04 çš„ lsblkï¼‰è¿”å›çš„ UUID å€¼ã€æŒ‚è½½ç‚¹ã€æ–‡ä»¶ç³»ç»Ÿä»¥åŠå»ºè®®çš„æ–‡ä»¶ç³»ç»ŸæŒ‚è½½é€‰é¡¹ã€‚æœ‰å…³å¿…å¡«å­—æ®µçš„æ›´å¤šä¿¡æ¯ï¼Œè¯·è¿è¡Œ man fstab ä»¥æ‰“å¼€ fstab æ‰‹å†Œã€‚\nåœ¨ä»¥ä¸‹ç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬å°† UUID ä¸º aebf131c-6957-451e-8d34-ec978d9581ae çš„è®¾å¤‡æŒ‚è½½åˆ°æŒ‚è½½ç‚¹ /dataï¼Œç„¶åæˆ‘ä»¬ä½¿ç”¨ xfs æ–‡ä»¶ç³»ç»Ÿã€‚æˆ‘ä»¬è¿˜ä½¿ç”¨ defaults å’Œ nofail æ ‡å¿—ã€‚æˆ‘ä»¬æŒ‡å®š 0 ä»¥é˜²æ­¢æ–‡ä»¶ç³»ç»Ÿè¢«è½¬å‚¨ï¼Œå¹¶ä¸”æˆ‘ä»¬æŒ‡å®š 2 ä»¥æŒ‡ç¤ºå®ƒæ˜¯éæ ¹è®¾å¤‡ã€‚\nUUID=aebf131c-6957-451e-8d34-ec978d9581ae /data xfs defaults,nofail 0 2 æ³¨æ„\nå¦‚æœæ‚¨è¦åœ¨æœªé™„åŠ æ­¤å·çš„æƒ…å†µä¸‹å¯åŠ¨å®ä¾‹ï¼ˆä¾‹å¦‚ï¼Œå°†å·ç§»åŠ¨åˆ°å¦ä¸€ä¸ªå®ä¾‹ä¹‹åï¼‰ï¼Œnofail é™„åŠ é€‰é¡¹å…è®¸è¯¥å®ä¾‹å³ä½¿åœ¨å·é™„åŠ è¿‡ç¨‹ä¸­å‡ºç°é”™è¯¯æ—¶ä¹Ÿå¯å¯åŠ¨ã€‚Debian è¡ç”Ÿç‰© (åŒ…æ‹¬æ—©äº 16.04 çš„ Ubuntu ç‰ˆæœ¬) è¿˜å¿…é¡»æ·»åŠ  nobootwait æŒ‚è½½é€‰é¡¹ã€‚\nè¦æ£€æŸ¥æ¡ç›®æ˜¯å¦æœ‰æ•ˆï¼Œè¯·åœ¨ /etc/fstab ä¸­è¿è¡Œä»¥ä¸‹å‘½ä»¤ä»¥å¸è½½è®¾å¤‡ï¼Œç„¶åæŒ‚è½½æ‰€æœ‰æ–‡ä»¶ç³»ç»Ÿã€‚å¦‚æœæœªäº§ç”Ÿé”™è¯¯ï¼Œåˆ™è¯´æ˜ /etc/fstab æ–‡ä»¶æ­£å¸¸ï¼Œæ‚¨çš„æ–‡ä»¶ç³»ç»Ÿä¼šåœ¨é‡å¯åè‡ªåŠ¨æŒ‚è½½ã€‚\n[ec2-user ~]$ sudo umount /data [ec2-user ~]$ sudo mount -a å¦‚æœæ”¶åˆ°é”™è¯¯æ¶ˆæ¯ï¼Œè¯·è§£å†³æ–‡ä»¶ä¸­çš„é”™è¯¯ã€‚\nè­¦å‘Š\n/etc/fstab æ–‡ä»¶ä¸­çš„é”™è¯¯å¯èƒ½æ˜¾ç¤ºç³»ç»Ÿæ— æ³•å¯åŠ¨ã€‚è¯·å‹¿å…³é—­ /etc/fstab æ–‡ä»¶ä¸­æœ‰é”™è¯¯çš„ç³»ç»Ÿã€‚\nå¦‚æœæ‚¨æ— æ³•ç¡®å®šå¦‚ä½•æ›´æ­£ /etc/fstab ä¸­çš„é”™è¯¯å¹¶ä¸”æ‚¨åœ¨æ­¤è¿‡ç¨‹çš„ç¬¬ä¸€æ­¥ä¸­åˆ›å»ºäº†ä¸€ä¸ªå¤‡ä»½æ–‡ä»¶ï¼Œåˆ™å¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤ä»æ‚¨çš„å¤‡ä»½æ–‡ä»¶è¿˜åŸã€‚\n[ec2-user ~]$ sudo mv /etc/fstab.orig /etc/fstab æŸ¥çœ‹ä¿®æ”¹æ—¥æœŸæ ¸å¯¹ä¿®æ”¹æ—¶é—´\né—®é¢˜éƒ½è§£å†³äº†ã€‚æ¥ä¸‹æ¥ç»§ç»­å‡çº§å†…æ ¸å§ã€‚\nsudo apt-get install linux-image-5.4.0-1055-aws ç­‰å¾…é‡å¯æŸ¥çœ‹\nç»ˆäºæˆåŠŸäº†ã€‚ã€‚ã€‚\né—®é¢˜æ€»ç»“ é—®é¢˜1\næ›´æ–°å†…æ ¸å¯¼è‡´å¼•å¯¼åˆ†åŒºå­˜å‚¨å æ»¡ã€‚ ä¼˜åŒ–\nåœ¨ubuntu è¿›è¡Œå†…æ ¸è¡¥ä¸è½¯ä»¶æ›´æ–°æ—¶éœ€è¦æ³¨æ„bootã€rootåˆ†åŒºçš„å®¹é‡ã€‚ä»¥é¿å…é‡å¯åæ— æ³•æ­£å¸¸å¼•å¯¼è¿›å…¥ç³»ç»Ÿã€‚ é—®é¢˜2\næ›´æ–°ä¸‹è½½è½¯ä»¶ï¼Œæç¤º were encountered while processing ä¼˜åŒ–\nåæµ‹è¯•å‘ç°æ›´æ–°ä¸‹è½½ä»»ä½•è½¯ä»¶éƒ½ä¼šå‡ºç°è¿™ç§æƒ…å†µï¼Œæš‚æœªè§£å†³ã€‚ é—®é¢˜3\nç£ç›˜å¼€æœºè‡ªåŠ¨æŒ‚è½½é…ç½®é—®é¢˜ã€‚ ä¼˜åŒ–\nä»¥åéœ€è¦ä¸¥æ ¼æŒ‰ç…§ AWS å®˜æ–¹æ–‡æ¡£æ¥è¿›è¡Œæ“ä½œéƒ¨ç½²ï¼Œä»¥å…å†æ¬¡é‡åˆ°ç±»ä¼¼çš„äº‹æƒ…å‘ç”Ÿã€‚ ä½œè€…ï¼šSREè¿ç»´åšå®¢\nåšå®¢åœ°å€ï¼šhttps://www.cnsre.cn\næ–‡ç« åœ°å€ï¼šhttps://www.cnsre.cn/posts/210915154434/\nç›¸å…³è¯é¢˜ï¼šhttps://www.cnsre.cn/tags/æ•…éšœé›†/\n","description":"AWS Ubuntu 18.04  å‡çº§å†…æ ¸5.4.0 çš„æ•…éšœå¤„ç†æ€è·¯ä»¥åŠè§£å†³æ–¹æ³•","id":40,"section":"posts","tags":["ubuntu","æ•…éšœé›†","aws"],"title":"è®°ä¸€æ¬¡ Ubuntu å†…æ ¸å‡çº§æ•…éšœå¤„ç†","uri":"http://www.cnsre.cn:80/posts/210915154434/"},{"content":" ä½œè€…ï¼šSREè¿ç»´åšå®¢\nåšå®¢åœ°å€ï¼šhttps://www.cnsre.cn\næ–‡ç« åœ°å€ï¼šhttps://www.cnsre.cn/posts/210913932516/\nç›¸å…³è¯é¢˜ï¼šhttps://www.cnsre.cn/tags/æ•…éšœé›†/\nä¸ºäº†é¿å…æ•°æ®åº“æœåŠ¡å™¨ç­‰å†…ç½‘åº”ç”¨èµ„æºæš´éœ²åˆ°å…¬ç½‘ä¸­ï¼Œæ‰“ç®—åˆ©ç”¨VPN æŠ€æœ¯å®ç°é“¾æ¥åˆ°å†…ç½‘ã€‚\næœ¬æ–‡ä¸»è¦ä»‹ç»CentOS 7 æœåŠ¡å™¨ä¸Šå®‰è£…ä¸é…ç½®OpenVPNæœåŠ¡å™¨,ä»¥åŠå¦‚ä½•ç¼–å†™å®¢æˆ·ç«¯è¿æ¥åˆ°æ–°å»ºç«‹çš„OpenVPNæœåŠ¡å™¨ä¸Šæ‰€éœ€çš„é…ç½®æ–‡ä»¶\nOpenVPNçš„ä»‹ç» OpenVPNæ˜¯ä¸€ä¸ªå¼€æºçš„åº”ç”¨ç¨‹åºï¼Œå®ƒå…è®¸æ‚¨é€šè¿‡å…¬å…±äº’è”ç½‘åˆ›å»ºä¸€ä¸ªå®‰å…¨çš„ä¸“ç”¨ç½‘ç»œã€‚OpenVPNå®ç°ä¸€ä¸ªè™šæ‹Ÿä¸“ç”¨ç½‘ï¼ˆVPNï¼‰æ¥åˆ›å»ºä¸€ä¸ªå®‰å…¨è¿æ¥ã€‚OpenVPNä½¿ç”¨OpenSSLåº“æä¾›åŠ å¯†ï¼Œå®ƒæä¾›äº†å‡ ç§èº«ä»½éªŒè¯æœºåˆ¶ï¼Œå¦‚åŸºäºè¯ä¹¦çš„ã€é¢„å…±äº«å¯†é’¥å’Œç”¨æˆ·å/å¯†ç èº«ä»½éªŒè¯ã€‚\nopenvpn æœ‰ä¸¤ç§æ¨¡å¼ æ•°æ®åŒ…ï¼ˆTUNæ¨¡å¼ï¼‰æˆ–æ•°æ®å¸§ï¼ˆTAPæ¨¡å¼ï¼‰\nTUNæ¨¡å¼ï¼šTUNæ¨¡æ‹Ÿäº†ç½‘ç»œå±‚è®¾å¤‡ï¼Œç¬¬ä¸‰å±‚æ•°æ®åŒ…å¦‚IPå°åŒ…ï¼Œåº•å±‚æ•°æ®éš§é“æ•°æ® TAPæ¨¡å¼ç­‰åŒäºä¸€ä¸ªè®¾å¤‡ï¼Œç¬¬äºŒæ“ä½œå±‚æ•°æ®åŒ…å¦‚æ‰©å±•æ•°æ®å¸§ï¼Œåˆ›å»ºä¸€ä¸ªç›¸å¯¹æ¡¥æ¥æ¥ï¼Œå¤æ‚T æ¥å£æ¥å£çš„å¥½å¤„å¯è§ï¼Œå®¢æˆ·ç«¯ä¼˜åŒ–VPNæœåŠ¡å­ç½‘çš„IPï¼ˆå¿½ç„¶å¿½éšå¿½ç°ï¼‰ç‰©ç†ä¸Šçš„åŒºåˆ«ï¼Œå¯ä»¥å®Œå…¨å°†å®¢æˆ·ç«¯çœ‹åšå®Œå…¨ä¸VPNæœåŠ¡å™¨ç›¸å…³çš„æ—¶é—´ï¼Œè€ŒTUNæ¥å£ä¸‹æ‰€æœ‰çš„å®¢æˆ·ç«¯åˆ™å‡ºç°ä¸€ä¸ªç‹¬ç«‹çš„å­ç½‘å†…ï¼Œä¸VPNæœåŠ¡å™¨ç›¸å…³çš„å­ç½‘æ²¡æœ‰å…³ç³»ï¼Œè¿™ç§ä½¿ç”¨æ¯”è¾ƒå¥½ï¼Œå’Œå…¬å¸çš„ç½‘ç»œåŒºåˆ†å¼€ï¼Œå®Œå…¨æ˜¯ä¸€ä¸ªè™šæ‹Ÿçš„ç½‘ç»œ\nè„šæœ¬å†…å®¹ openvpn ä¸€é”®å®‰è£…è„šæœ¬\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 148 149 150 151 152 153 154 155 156 157 158 159 160 161 162 163 164 165 166 167 168 169 170 171 172 173 174 175 176 177 178 179 180 181 182 183 184 185 186 187 188 189 190 191 192 193 194 195 196 197 198 199 200 201 202 203 204 205 206 207 208 209 210 211 212 213 214 215 216 217 218 219 220 221 222 223 224 225 226 227 228 229 230 231 232 233 234 235 236 237 238 239 240 241 242 243 244 245 246 247 248 249 250 251 252 253 254 255 256 257 258 259 260 261 262 263 264 265 266 267 268 269 270 271 272 273 274 275 276 277 278 279 280 281 282 283 284 285 286 287 288 289 290 291 292 293 294 295 296 297 298 299 300 301 302 303 304 305 306 307 308 309 310 311 312 313 314 315 316 317 318 319 320 321 322 323 324 325 326 327 328 329 330 331 332 333 334 335 336 337 338 339 340 341 342 343 344 345 346 347 348 349 350 351 352 353 354 355 356 357 358 359 360 361 362 363 364 365 366 367 368 369 370 371 372 373 374 375 376 377 378 379 380 381 382 383 384 385 386 387 388 389 390 391 392 393 394 395 396 397 398 399 400 401 402 403 404 405 406 407 408 409 410 411 412 413 414 415 416 417 418 419 420 421 422 423 424 425 426 427 428 429 430 431 432 433 434 435 436 437 438 439 440 441 442 443 444 445 446 447 448 449 450 451 452 453 454 455 456 457 458 459 460 461 462 463 464 465 466 467 468 469 470 471 472 473 474 475 476 477 478 479 480 481 482 483 484 485 486 487 488 489 490 491 492 493 494 495 496 497 498 499 500 501 502 503 504 505 506 507 508 509 510 511 512 513 514 515 516 517 518 519 520 521 522 523 524 525 526 527 528 529 530 531 532 533 534 535 536 537 538 539 540 541 542 543 544 545 546 547 548 549 550 551 552 553 554 555 556 557 558 559 #!/bin/bash # # https://github.com/Nyr/openvpn-install # # Copyright (c) 2013 Nyr. Released under the MIT License. # Detect Debian users running the script with \u0026#34;sh\u0026#34; instead of bash if readlink /proc/$$/exe | grep -q \u0026#34;dash\u0026#34;; then echo \u0026#39;This installer needs to be run with \u0026#34;bash\u0026#34;, not \u0026#34;sh\u0026#34;.\u0026#39; exit fi # Discard stdin. Needed when running from an one-liner which includes a newline read -N 999999 -t 0.001 # Detect OpenVZ 6 if [[ $(uname -r | cut -d \u0026#34;.\u0026#34; -f 1) -eq 2 ]]; then echo \u0026#34;The system is running an old kernel, which is incompatible with this installer.\u0026#34; exit fi # Detect OS # $os_version variables aren\u0026#39;t always in use, but are kept here for convenience if grep -qs \u0026#34;ubuntu\u0026#34; /etc/os-release; then os=\u0026#34;ubuntu\u0026#34; os_version=$(grep \u0026#39;VERSION_ID\u0026#39; /etc/os-release | cut -d \u0026#39;\u0026#34;\u0026#39; -f 2 | tr -d \u0026#39;.\u0026#39;) group_name=\u0026#34;nogroup\u0026#34; elif [[ -e /etc/debian_version ]]; then os=\u0026#34;debian\u0026#34; os_version=$(grep -oE \u0026#39;[0-9]+\u0026#39; /etc/debian_version | head -1) group_name=\u0026#34;nogroup\u0026#34; elif [[ -e /etc/centos-release ]]; then os=\u0026#34;centos\u0026#34; os_version=$(grep -oE \u0026#39;[0-9]+\u0026#39; /etc/centos-release | head -1) group_name=\u0026#34;nobody\u0026#34; elif [[ -e /etc/fedora-release ]]; then os=\u0026#34;fedora\u0026#34; os_version=$(grep -oE \u0026#39;[0-9]+\u0026#39; /etc/fedora-release | head -1) group_name=\u0026#34;nobody\u0026#34; else echo \u0026#34;This installer seems to be running on an unsupported distribution. Supported distributions are Ubuntu, Debian, CentOS, and Fedora.\u0026#34; exit fi if [[ \u0026#34;$os\u0026#34; == \u0026#34;ubuntu\u0026#34; \u0026amp;\u0026amp; \u0026#34;$os_version\u0026#34; -lt 1804 ]]; then echo \u0026#34;Ubuntu 18.04 or higher is required to use this installer. This version of Ubuntu is too old and unsupported.\u0026#34; exit fi if [[ \u0026#34;$os\u0026#34; == \u0026#34;debian\u0026#34; \u0026amp;\u0026amp; \u0026#34;$os_version\u0026#34; -lt 9 ]]; then echo \u0026#34;Debian 9 or higher is required to use this installer. This version of Debian is too old and unsupported.\u0026#34; exit fi if [[ \u0026#34;$os\u0026#34; == \u0026#34;centos\u0026#34; \u0026amp;\u0026amp; \u0026#34;$os_version\u0026#34; -lt 7 ]]; then echo \u0026#34;CentOS 7 or higher is required to use this installer. This version of CentOS is too old and unsupported.\u0026#34; exit fi # Detect environments where $PATH does not include the sbin directories if ! grep -q sbin \u0026lt;\u0026lt;\u0026lt; \u0026#34;$PATH\u0026#34;; then echo \u0026#39;$PATH does not include sbin. Try using \u0026#34;su -\u0026#34; instead of \u0026#34;su\u0026#34;.\u0026#39; exit fi if [[ \u0026#34;$EUID\u0026#34; -ne 0 ]]; then echo \u0026#34;This installer needs to be run with superuser privileges.\u0026#34; exit fi if [[ ! -e /dev/net/tun ]] || ! ( exec 7\u0026lt;\u0026gt;/dev/net/tun ) 2\u0026gt;/dev/null; then echo \u0026#34;The system does not have the TUN device available. TUN needs to be enabled before running this installer.\u0026#34; exit fi new_client () { # Generates the custom client.ovpn { cat /etc/openvpn/server/client-common.txt echo \u0026#34;\u0026lt;ca\u0026gt;\u0026#34; cat /etc/openvpn/server/easy-rsa/pki/ca.crt echo \u0026#34;\u0026lt;/ca\u0026gt;\u0026#34; echo \u0026#34;\u0026lt;cert\u0026gt;\u0026#34; sed -ne \u0026#39;/BEGIN CERTIFICATE/,$ p\u0026#39; /etc/openvpn/server/easy-rsa/pki/issued/\u0026#34;$client\u0026#34;.crt echo \u0026#34;\u0026lt;/cert\u0026gt;\u0026#34; echo \u0026#34;\u0026lt;key\u0026gt;\u0026#34; cat /etc/openvpn/server/easy-rsa/pki/private/\u0026#34;$client\u0026#34;.key echo \u0026#34;\u0026lt;/key\u0026gt;\u0026#34; echo \u0026#34;\u0026lt;tls-crypt\u0026gt;\u0026#34; sed -ne \u0026#39;/BEGIN OpenVPN Static key/,$ p\u0026#39; /etc/openvpn/server/tc.key echo \u0026#34;\u0026lt;/tls-crypt\u0026gt;\u0026#34; } \u0026gt; ~/\u0026#34;$client\u0026#34;.ovpn } if [[ ! -e /etc/openvpn/server/server.conf ]]; then clear echo \u0026#39;Welcome to this OpenVPN road warrior installer!\u0026#39; # If system has a single IPv4, it is selected automatically. Else, ask the user if [[ $(ip -4 addr | grep inet | grep -vEc \u0026#39;127(\\.[0-9]{1,3}){3}\u0026#39;) -eq 1 ]]; then ip=$(ip -4 addr | grep inet | grep -vE \u0026#39;127(\\.[0-9]{1,3}){3}\u0026#39; | cut -d \u0026#39;/\u0026#39; -f 1 | grep -oE \u0026#39;[0-9]{1,3}(\\.[0-9]{1,3}){3}\u0026#39;) else number_of_ip=$(ip -4 addr | grep inet | grep -vEc \u0026#39;127(\\.[0-9]{1,3}){3}\u0026#39;) echo echo \u0026#34;Which IPv4 address should be used?\u0026#34; ip -4 addr | grep inet | grep -vE \u0026#39;127(\\.[0-9]{1,3}){3}\u0026#39; | cut -d \u0026#39;/\u0026#39; -f 1 | grep -oE \u0026#39;[0-9]{1,3}(\\.[0-9]{1,3}){3}\u0026#39; | nl -s \u0026#39;) \u0026#39; read -p \u0026#34;IPv4 address [1]: \u0026#34; ip_number until [[ -z \u0026#34;$ip_number\u0026#34; || \u0026#34;$ip_number\u0026#34; =~ ^[0-9]+$ \u0026amp;\u0026amp; \u0026#34;$ip_number\u0026#34; -le \u0026#34;$number_of_ip\u0026#34; ]]; do echo \u0026#34;$ip_number: invalid selection.\u0026#34; read -p \u0026#34;IPv4 address [1]: \u0026#34; ip_number done [[ -z \u0026#34;$ip_number\u0026#34; ]] \u0026amp;\u0026amp; ip_number=\u0026#34;1\u0026#34; ip=$(ip -4 addr | grep inet | grep -vE \u0026#39;127(\\.[0-9]{1,3}){3}\u0026#39; | cut -d \u0026#39;/\u0026#39; -f 1 | grep -oE \u0026#39;[0-9]{1,3}(\\.[0-9]{1,3}){3}\u0026#39; | sed -n \u0026#34;$ip_number\u0026#34;p) fi # If $ip is a private IP address, the server must be behind NAT if echo \u0026#34;$ip\u0026#34; | grep -qE \u0026#39;^(10\\.|172\\.1[6789]\\.|172\\.2[0-9]\\.|172\\.3[01]\\.|192\\.168)\u0026#39;; then echo echo \u0026#34;This server is behind NAT. What is the public IPv4 address or hostname?\u0026#34; # Get public IP and sanitize with grep get_public_ip=$(grep -m 1 -oE \u0026#39;^[0-9]{1,3}(\\.[0-9]{1,3}){3}$\u0026#39; \u0026lt;\u0026lt;\u0026lt; \u0026#34;$(wget -T 10 -t 1 -4qO- \u0026#34;http://ip1.dynupdate.no-ip.com/\u0026#34; || curl -m 10 -4Ls \u0026#34;http://ip1.dynupdate.no-ip.com/\u0026#34;)\u0026#34;) read -p \u0026#34;Public IPv4 address / hostname [$get_public_ip]: \u0026#34; public_ip # If the checkip service is unavailable and user didn\u0026#39;t provide input, ask again until [[ -n \u0026#34;$get_public_ip\u0026#34; || -n \u0026#34;$public_ip\u0026#34; ]]; do echo \u0026#34;Invalid input.\u0026#34; read -p \u0026#34;Public IPv4 address / hostname: \u0026#34; public_ip done [[ -z \u0026#34;$public_ip\u0026#34; ]] \u0026amp;\u0026amp; public_ip=\u0026#34;$get_public_ip\u0026#34; fi # If system has a single IPv6, it is selected automatically if [[ $(ip -6 addr | grep -c \u0026#39;inet6 [23]\u0026#39;) -eq 1 ]]; then ip6=$(ip -6 addr | grep \u0026#39;inet6 [23]\u0026#39; | cut -d \u0026#39;/\u0026#39; -f 1 | grep -oE \u0026#39;([0-9a-fA-F]{0,4}:){1,7}[0-9a-fA-F]{0,4}\u0026#39;) fi # If system has multiple IPv6, ask the user to select one if [[ $(ip -6 addr | grep -c \u0026#39;inet6 [23]\u0026#39;) -gt 1 ]]; then number_of_ip6=$(ip -6 addr | grep -c \u0026#39;inet6 [23]\u0026#39;) echo echo \u0026#34;Which IPv6 address should be used?\u0026#34; ip -6 addr | grep \u0026#39;inet6 [23]\u0026#39; | cut -d \u0026#39;/\u0026#39; -f 1 | grep -oE \u0026#39;([0-9a-fA-F]{0,4}:){1,7}[0-9a-fA-F]{0,4}\u0026#39; | nl -s \u0026#39;) \u0026#39; read -p \u0026#34;IPv6 address [1]: \u0026#34; ip6_number until [[ -z \u0026#34;$ip6_number\u0026#34; || \u0026#34;$ip6_number\u0026#34; =~ ^[0-9]+$ \u0026amp;\u0026amp; \u0026#34;$ip6_number\u0026#34; -le \u0026#34;$number_of_ip6\u0026#34; ]]; do echo \u0026#34;$ip6_number: invalid selection.\u0026#34; read -p \u0026#34;IPv6 address [1]: \u0026#34; ip6_number done [[ -z \u0026#34;$ip6_number\u0026#34; ]] \u0026amp;\u0026amp; ip6_number=\u0026#34;1\u0026#34; ip6=$(ip -6 addr | grep \u0026#39;inet6 [23]\u0026#39; | cut -d \u0026#39;/\u0026#39; -f 1 | grep -oE \u0026#39;([0-9a-fA-F]{0,4}:){1,7}[0-9a-fA-F]{0,4}\u0026#39; | sed -n \u0026#34;$ip6_number\u0026#34;p) fi echo echo \u0026#34;Which protocol should OpenVPN use?\u0026#34; echo \u0026#34; 1) UDP (recommended)\u0026#34; echo \u0026#34; 2) TCP\u0026#34; read -p \u0026#34;Protocol [1]: \u0026#34; protocol until [[ -z \u0026#34;$protocol\u0026#34; || \u0026#34;$protocol\u0026#34; =~ ^[12]$ ]]; do echo \u0026#34;$protocol: invalid selection.\u0026#34; read -p \u0026#34;Protocol [1]: \u0026#34; protocol done case \u0026#34;$protocol\u0026#34; in 1|\u0026#34;\u0026#34;) protocol=udp ;; 2) protocol=tcp ;; esac echo echo \u0026#34;What port should OpenVPN listen to?\u0026#34; read -p \u0026#34;Port [1194]: \u0026#34; port until [[ -z \u0026#34;$port\u0026#34; || \u0026#34;$port\u0026#34; =~ ^[0-9]+$ \u0026amp;\u0026amp; \u0026#34;$port\u0026#34; -le 65535 ]]; do echo \u0026#34;$port: invalid port.\u0026#34; read -p \u0026#34;Port [1194]: \u0026#34; port done [[ -z \u0026#34;$port\u0026#34; ]] \u0026amp;\u0026amp; port=\u0026#34;1194\u0026#34; echo echo \u0026#34;Select a DNS server for the clients:\u0026#34; echo \u0026#34; 1) Current system resolvers\u0026#34; echo \u0026#34; 2) Google\u0026#34; echo \u0026#34; 3) 1.1.1.1\u0026#34; echo \u0026#34; 4) OpenDNS\u0026#34; echo \u0026#34; 5) Quad9\u0026#34; echo \u0026#34; 6) AdGuard\u0026#34; read -p \u0026#34;DNS server [1]: \u0026#34; dns until [[ -z \u0026#34;$dns\u0026#34; || \u0026#34;$dns\u0026#34; =~ ^[1-6]$ ]]; do echo \u0026#34;$dns: invalid selection.\u0026#34; read -p \u0026#34;DNS server [1]: \u0026#34; dns done echo echo \u0026#34;Enter a name for the first client:\u0026#34; read -p \u0026#34;Name [client]: \u0026#34; unsanitized_client # Allow a limited set of characters to avoid conflicts client=$(sed \u0026#39;s/[^0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ_-]/_/g\u0026#39; \u0026lt;\u0026lt;\u0026lt; \u0026#34;$unsanitized_client\u0026#34;) [[ -z \u0026#34;$client\u0026#34; ]] \u0026amp;\u0026amp; client=\u0026#34;client\u0026#34; echo echo \u0026#34;OpenVPN installation is ready to begin.\u0026#34; # Install a firewall in the rare case where one is not already available if ! systemctl is-active --quiet firewalld.service \u0026amp;\u0026amp; ! hash iptables 2\u0026gt;/dev/null; then if [[ \u0026#34;$os\u0026#34; == \u0026#34;centos\u0026#34; || \u0026#34;$os\u0026#34; == \u0026#34;fedora\u0026#34; ]]; then firewall=\u0026#34;firewalld\u0026#34; # We don\u0026#39;t want to silently enable firewalld, so we give a subtle warning # If the user continues, firewalld will be installed and enabled during setup echo \u0026#34;firewalld, which is required to manage routing tables, will also be installed.\u0026#34; elif [[ \u0026#34;$os\u0026#34; == \u0026#34;debian\u0026#34; || \u0026#34;$os\u0026#34; == \u0026#34;ubuntu\u0026#34; ]]; then # iptables is way less invasive than firewalld so no warning is given firewall=\u0026#34;iptables\u0026#34; fi fi read -n1 -r -p \u0026#34;Press any key to continue...\u0026#34; # If running inside a container, disable LimitNPROC to prevent conflicts if systemd-detect-virt -cq; then mkdir /etc/systemd/system/openvpn-server@server.service.d/ 2\u0026gt;/dev/null echo \u0026#34;[Service] LimitNPROC=infinity\u0026#34; \u0026gt; /etc/systemd/system/openvpn-server@server.service.d/disable-limitnproc.conf fi if [[ \u0026#34;$os\u0026#34; = \u0026#34;debian\u0026#34; || \u0026#34;$os\u0026#34; = \u0026#34;ubuntu\u0026#34; ]]; then apt-get update apt-get install -y openvpn openssl ca-certificates $firewall elif [[ \u0026#34;$os\u0026#34; = \u0026#34;centos\u0026#34; ]]; then yum install -y epel-release yum install -y openvpn openssl ca-certificates tar $firewall else # Else, OS must be Fedora dnf install -y openvpn openssl ca-certificates tar $firewall fi # If firewalld was just installed, enable it if [[ \u0026#34;$firewall\u0026#34; == \u0026#34;firewalld\u0026#34; ]]; then systemctl enable --now firewalld.service fi # Get easy-rsa easy_rsa_url=\u0026#39;https://github.com/OpenVPN/easy-rsa/releases/download/v3.0.8/EasyRSA-3.0.8.tgz\u0026#39; mkdir -p /etc/openvpn/server/easy-rsa/ { wget -qO- \u0026#34;$easy_rsa_url\u0026#34; 2\u0026gt;/dev/null || curl -sL \u0026#34;$easy_rsa_url\u0026#34; ; } | tar xz -C /etc/openvpn/server/easy-rsa/ --strip-components 1 chown -R root:root /etc/openvpn/server/easy-rsa/ cd /etc/openvpn/server/easy-rsa/ # Create the PKI, set up the CA and the server and client certificates ./easyrsa init-pki ./easyrsa --batch build-ca nopass EASYRSA_CERT_EXPIRE=3650 ./easyrsa build-server-full server nopass EASYRSA_CERT_EXPIRE=3650 ./easyrsa build-client-full \u0026#34;$client\u0026#34; nopass EASYRSA_CRL_DAYS=3650 ./easyrsa gen-crl # Move the stuff we need cp pki/ca.crt pki/private/ca.key pki/issued/server.crt pki/private/server.key pki/crl.pem /etc/openvpn/server # CRL is read with each client connection, while OpenVPN is dropped to nobody chown nobody:\u0026#34;$group_name\u0026#34; /etc/openvpn/server/crl.pem # Without +x in the directory, OpenVPN can\u0026#39;t run a stat() on the CRL file chmod o+x /etc/openvpn/server/ # Generate key for tls-crypt openvpn --genkey --secret /etc/openvpn/server/tc.key # Create the DH parameters file using the predefined ffdhe2048 group echo \u0026#39;-----BEGIN DH PARAMETERS----- MIIBCAKCAQEA//////////+t+FRYortKmq/cViAnPTzx2LnFg84tNpWp4TZBFGQz +8yTnc4kmz75fS/jY2MMddj2gbICrsRhetPfHtXV/WVhJDP1H18GbtCFY2VVPe0a 87VXE15/V8k1mE8McODmi3fipona8+/och3xWKE2rec1MKzKT0g6eXq8CrGCsyT7 YdEIqUuyyOP7uWrat2DX9GgdT0Kj3jlN9K5W7edjcrsZCwenyO4KbXCeAvzhzffi 7MA0BM0oNC9hkXL+nOmFg/+OTxIy7vKBg8P+OxtMb61zO7X8vC7CIAXFjvGDfRaD ssbzSibBsu/6iGtCOGEoXJf//////////wIBAg== -----END DH PARAMETERS-----\u0026#39; \u0026gt; /etc/openvpn/server/dh.pem # Generate server.conf echo \u0026#34;local $ip port $port proto $protocol dev tun ca ca.crt cert server.crt key server.key dh dh.pem auth SHA512 tls-crypt tc.key topology subnet server 10.8.0.0 255.255.255.0\u0026#34; \u0026gt; /etc/openvpn/server/server.conf # IPv6 if [[ -z \u0026#34;$ip6\u0026#34; ]]; then echo \u0026#39;push \u0026#34;redirect-gateway def1 bypass-dhcp\u0026#34;\u0026#39; \u0026gt;\u0026gt; /etc/openvpn/server/server.conf else echo \u0026#39;server-ipv6 fddd:1194:1194:1194::/64\u0026#39; \u0026gt;\u0026gt; /etc/openvpn/server/server.conf echo \u0026#39;push \u0026#34;redirect-gateway def1 ipv6 bypass-dhcp\u0026#34;\u0026#39; \u0026gt;\u0026gt; /etc/openvpn/server/server.conf fi echo \u0026#39;ifconfig-pool-persist ipp.txt\u0026#39; \u0026gt;\u0026gt; /etc/openvpn/server/server.conf # DNS case \u0026#34;$dns\u0026#34; in 1|\u0026#34;\u0026#34;) # Locate the proper resolv.conf # Needed for systems running systemd-resolved if grep -q \u0026#39;^nameserver 127.0.0.53\u0026#39; \u0026#34;/etc/resolv.conf\u0026#34;; then resolv_conf=\u0026#34;/run/systemd/resolve/resolv.conf\u0026#34; else resolv_conf=\u0026#34;/etc/resolv.conf\u0026#34; fi # Obtain the resolvers from resolv.conf and use them for OpenVPN grep -v \u0026#39;^#\\|^;\u0026#39; \u0026#34;$resolv_conf\u0026#34; | grep \u0026#39;^nameserver\u0026#39; | grep -oE \u0026#39;[0-9]{1,3}(\\.[0-9]{1,3}){3}\u0026#39; | while read line; do echo \u0026#34;push \\\u0026#34;dhcp-option DNS $line\\\u0026#34;\u0026#34; \u0026gt;\u0026gt; /etc/openvpn/server/server.conf done ;; 2) echo \u0026#39;push \u0026#34;dhcp-option DNS 8.8.8.8\u0026#34;\u0026#39; \u0026gt;\u0026gt; /etc/openvpn/server/server.conf echo \u0026#39;push \u0026#34;dhcp-option DNS 8.8.4.4\u0026#34;\u0026#39; \u0026gt;\u0026gt; /etc/openvpn/server/server.conf ;; 3) echo \u0026#39;push \u0026#34;dhcp-option DNS 1.1.1.1\u0026#34;\u0026#39; \u0026gt;\u0026gt; /etc/openvpn/server/server.conf echo \u0026#39;push \u0026#34;dhcp-option DNS 1.0.0.1\u0026#34;\u0026#39; \u0026gt;\u0026gt; /etc/openvpn/server/server.conf ;; 4) echo \u0026#39;push \u0026#34;dhcp-option DNS 208.67.222.222\u0026#34;\u0026#39; \u0026gt;\u0026gt; /etc/openvpn/server/server.conf echo \u0026#39;push \u0026#34;dhcp-option DNS 208.67.220.220\u0026#34;\u0026#39; \u0026gt;\u0026gt; /etc/openvpn/server/server.conf ;; 5) echo \u0026#39;push \u0026#34;dhcp-option DNS 9.9.9.9\u0026#34;\u0026#39; \u0026gt;\u0026gt; /etc/openvpn/server/server.conf echo \u0026#39;push \u0026#34;dhcp-option DNS 149.112.112.112\u0026#34;\u0026#39; \u0026gt;\u0026gt; /etc/openvpn/server/server.conf ;; 6) echo \u0026#39;push \u0026#34;dhcp-option DNS 94.140.14.14\u0026#34;\u0026#39; \u0026gt;\u0026gt; /etc/openvpn/server/server.conf echo \u0026#39;push \u0026#34;dhcp-option DNS 94.140.15.15\u0026#34;\u0026#39; \u0026gt;\u0026gt; /etc/openvpn/server/server.conf ;; esac echo \u0026#34;keepalive 10 120 cipher AES-256-CBC user nobody group $group_name persist-key persist-tun verb 3 crl-verify crl.pem\u0026#34; \u0026gt;\u0026gt; /etc/openvpn/server/server.conf if [[ \u0026#34;$protocol\u0026#34; = \u0026#34;udp\u0026#34; ]]; then echo \u0026#34;explicit-exit-notify\u0026#34; \u0026gt;\u0026gt; /etc/openvpn/server/server.conf fi # Enable net.ipv4.ip_forward for the system echo \u0026#39;net.ipv4.ip_forward=1\u0026#39; \u0026gt; /etc/sysctl.d/99-openvpn-forward.conf # Enable without waiting for a reboot or service restart echo 1 \u0026gt; /proc/sys/net/ipv4/ip_forward if [[ -n \u0026#34;$ip6\u0026#34; ]]; then # Enable net.ipv6.conf.all.forwarding for the system echo \u0026#34;net.ipv6.conf.all.forwarding=1\u0026#34; \u0026gt;\u0026gt; /etc/sysctl.d/99-openvpn-forward.conf # Enable without waiting for a reboot or service restart echo 1 \u0026gt; /proc/sys/net/ipv6/conf/all/forwarding fi if systemctl is-active --quiet firewalld.service; then # Using both permanent and not permanent rules to avoid a firewalld # reload. # We don\u0026#39;t use --add-service=openvpn because that would only work with # the default port and protocol. firewall-cmd --add-port=\u0026#34;$port\u0026#34;/\u0026#34;$protocol\u0026#34; firewall-cmd --zone=trusted --add-source=10.8.0.0/24 firewall-cmd --permanent --add-port=\u0026#34;$port\u0026#34;/\u0026#34;$protocol\u0026#34; firewall-cmd --permanent --zone=trusted --add-source=10.8.0.0/24 # Set NAT for the VPN subnet firewall-cmd --direct --add-rule ipv4 nat POSTROUTING 0 -s 10.8.0.0/24 ! -d 10.8.0.0/24 -j SNAT --to \u0026#34;$ip\u0026#34; firewall-cmd --permanent --direct --add-rule ipv4 nat POSTROUTING 0 -s 10.8.0.0/24 ! -d 10.8.0.0/24 -j SNAT --to \u0026#34;$ip\u0026#34; if [[ -n \u0026#34;$ip6\u0026#34; ]]; then firewall-cmd --zone=trusted --add-source=fddd:1194:1194:1194::/64 firewall-cmd --permanent --zone=trusted --add-source=fddd:1194:1194:1194::/64 firewall-cmd --direct --add-rule ipv6 nat POSTROUTING 0 -s fddd:1194:1194:1194::/64 ! -d fddd:1194:1194:1194::/64 -j SNAT --to \u0026#34;$ip6\u0026#34; firewall-cmd --permanent --direct --add-rule ipv6 nat POSTROUTING 0 -s fddd:1194:1194:1194::/64 ! -d fddd:1194:1194:1194::/64 -j SNAT --to \u0026#34;$ip6\u0026#34; fi else # Create a service to set up persistent iptables rules iptables_path=$(command -v iptables) ip6tables_path=$(command -v ip6tables) # nf_tables is not available as standard in OVZ kernels. So use iptables-legacy # if we are in OVZ, with a nf_tables backend and iptables-legacy is available. if [[ $(systemd-detect-virt) == \u0026#34;openvz\u0026#34; ]] \u0026amp;\u0026amp; readlink -f \u0026#34;$(command -v iptables)\u0026#34; | grep -q \u0026#34;nft\u0026#34; \u0026amp;\u0026amp; hash iptables-legacy 2\u0026gt;/dev/null; then iptables_path=$(command -v iptables-legacy) ip6tables_path=$(command -v ip6tables-legacy) fi echo \u0026#34;[Unit] Before=network.target [Service] Type=oneshot ExecStart=$iptables_path -t nat -A POSTROUTING -s 10.8.0.0/24 ! -d 10.8.0.0/24 -j SNAT --to $ip ExecStart=$iptables_path -I INPUT -p $protocol --dport $port -j ACCEPT ExecStart=$iptables_path -I FORWARD -s 10.8.0.0/24 -j ACCEPT ExecStart=$iptables_path -I FORWARD -m state --state RELATED,ESTABLISHED -j ACCEPT ExecStop=$iptables_path -t nat -D POSTROUTING -s 10.8.0.0/24 ! -d 10.8.0.0/24 -j SNAT --to $ip ExecStop=$iptables_path -D INPUT -p $protocol --dport $port -j ACCEPT ExecStop=$iptables_path -D FORWARD -s 10.8.0.0/24 -j ACCEPT ExecStop=$iptables_path -D FORWARD -m state --state RELATED,ESTABLISHED -j ACCEPT\u0026#34; \u0026gt; /etc/systemd/system/openvpn-iptables.service if [[ -n \u0026#34;$ip6\u0026#34; ]]; then echo \u0026#34;ExecStart=$ip6tables_path -t nat -A POSTROUTING -s fddd:1194:1194:1194::/64 ! -d fddd:1194:1194:1194::/64 -j SNAT --to $ip6 ExecStart=$ip6tables_path -I FORWARD -s fddd:1194:1194:1194::/64 -j ACCEPT ExecStart=$ip6tables_path -I FORWARD -m state --state RELATED,ESTABLISHED -j ACCEPT ExecStop=$ip6tables_path -t nat -D POSTROUTING -s fddd:1194:1194:1194::/64 ! -d fddd:1194:1194:1194::/64 -j SNAT --to $ip6 ExecStop=$ip6tables_path -D FORWARD -s fddd:1194:1194:1194::/64 -j ACCEPT ExecStop=$ip6tables_path -D FORWARD -m state --state RELATED,ESTABLISHED -j ACCEPT\u0026#34; \u0026gt;\u0026gt; /etc/systemd/system/openvpn-iptables.service fi echo \u0026#34;RemainAfterExit=yes [Install] WantedBy=multi-user.target\u0026#34; \u0026gt;\u0026gt; /etc/systemd/system/openvpn-iptables.service systemctl enable --now openvpn-iptables.service fi # If SELinux is enabled and a custom port was selected, we need this if sestatus 2\u0026gt;/dev/null | grep \u0026#34;Current mode\u0026#34; | grep -q \u0026#34;enforcing\u0026#34; \u0026amp;\u0026amp; [[ \u0026#34;$port\u0026#34; != 1194 ]]; then # Install semanage if not already present if ! hash semanage 2\u0026gt;/dev/null; then if [[ \u0026#34;$os_version\u0026#34; -eq 7 ]]; then # Centos 7 yum install -y policycoreutils-python else # CentOS 8 or Fedora dnf install -y policycoreutils-python-utils fi fi semanage port -a -t openvpn_port_t -p \u0026#34;$protocol\u0026#34; \u0026#34;$port\u0026#34; fi # If the server is behind NAT, use the correct IP address [[ -n \u0026#34;$public_ip\u0026#34; ]] \u0026amp;\u0026amp; ip=\u0026#34;$public_ip\u0026#34; # client-common.txt is created so we have a template to add further users later echo \u0026#34;client dev tun proto $protocol remote $ip $port resolv-retry infinite nobind persist-key persist-tun remote-cert-tls server auth SHA512 cipher AES-256-CBC ignore-unknown-option block-outside-dns block-outside-dns verb 3\u0026#34; \u0026gt; /etc/openvpn/server/client-common.txt # Enable and start the OpenVPN service systemctl enable --now openvpn-server@server.service # Generates the custom client.ovpn new_client echo echo \u0026#34;Finished!\u0026#34; echo echo \u0026#34;The client configuration is available in:\u0026#34; ~/\u0026#34;$client.ovpn\u0026#34; echo \u0026#34;New clients can be added by running this script again.\u0026#34; else clear echo \u0026#34;OpenVPN is already installed.\u0026#34; echo echo \u0026#34;Select an option:\u0026#34; echo \u0026#34; 1) Add a new client\u0026#34; echo \u0026#34; 2) Revoke an existing client\u0026#34; echo \u0026#34; 3) Remove OpenVPN\u0026#34; echo \u0026#34; 4) Exit\u0026#34; read -p \u0026#34;Option: \u0026#34; option until [[ \u0026#34;$option\u0026#34; =~ ^[1-4]$ ]]; do echo \u0026#34;$option: invalid selection.\u0026#34; read -p \u0026#34;Option: \u0026#34; option done case \u0026#34;$option\u0026#34; in 1) echo echo \u0026#34;Provide a name for the client:\u0026#34; read -p \u0026#34;Name: \u0026#34; unsanitized_client client=$(sed \u0026#39;s/[^0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ_-]/_/g\u0026#39; \u0026lt;\u0026lt;\u0026lt; \u0026#34;$unsanitized_client\u0026#34;) while [[ -z \u0026#34;$client\u0026#34; || -e /etc/openvpn/server/easy-rsa/pki/issued/\u0026#34;$client\u0026#34;.crt ]]; do echo \u0026#34;$client: invalid name.\u0026#34; read -p \u0026#34;Name: \u0026#34; unsanitized_client client=$(sed \u0026#39;s/[^0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ_-]/_/g\u0026#39; \u0026lt;\u0026lt;\u0026lt; \u0026#34;$unsanitized_client\u0026#34;) done cd /etc/openvpn/server/easy-rsa/ EASYRSA_CERT_EXPIRE=3650 ./easyrsa build-client-full \u0026#34;$client\u0026#34; nopass # Generates the custom client.ovpn new_client echo echo \u0026#34;$client added. Configuration available in:\u0026#34; ~/\u0026#34;$client.ovpn\u0026#34; exit ;; 2) # This option could be documented a bit better and maybe even be simplified # ...but what can I say, I want some sleep too number_of_clients=$(tail -n +2 /etc/openvpn/server/easy-rsa/pki/index.txt | grep -c \u0026#34;^V\u0026#34;) if [[ \u0026#34;$number_of_clients\u0026#34; = 0 ]]; then echo echo \u0026#34;There are no existing clients!\u0026#34; exit fi echo echo \u0026#34;Select the client to revoke:\u0026#34; tail -n +2 /etc/openvpn/server/easy-rsa/pki/index.txt | grep \u0026#34;^V\u0026#34; | cut -d \u0026#39;=\u0026#39; -f 2 | nl -s \u0026#39;) \u0026#39; read -p \u0026#34;Client: \u0026#34; client_number until [[ \u0026#34;$client_number\u0026#34; =~ ^[0-9]+$ \u0026amp;\u0026amp; \u0026#34;$client_number\u0026#34; -le \u0026#34;$number_of_clients\u0026#34; ]]; do echo \u0026#34;$client_number: invalid selection.\u0026#34; read -p \u0026#34;Client: \u0026#34; client_number done client=$(tail -n +2 /etc/openvpn/server/easy-rsa/pki/index.txt | grep \u0026#34;^V\u0026#34; | cut -d \u0026#39;=\u0026#39; -f 2 | sed -n \u0026#34;$client_number\u0026#34;p) echo read -p \u0026#34;Confirm $client revocation? [y/N]: \u0026#34; revoke until [[ \u0026#34;$revoke\u0026#34; =~ ^[yYnN]*$ ]]; do echo \u0026#34;$revoke: invalid selection.\u0026#34; read -p \u0026#34;Confirm $client revocation? [y/N]: \u0026#34; revoke done if [[ \u0026#34;$revoke\u0026#34; =~ ^[yY]$ ]]; then cd /etc/openvpn/server/easy-rsa/ ./easyrsa --batch revoke \u0026#34;$client\u0026#34; EASYRSA_CRL_DAYS=3650 ./easyrsa gen-crl rm -f /etc/openvpn/server/crl.pem cp /etc/openvpn/server/easy-rsa/pki/crl.pem /etc/openvpn/server/crl.pem # CRL is read with each client connection, when OpenVPN is dropped to nobody chown nobody:\u0026#34;$group_name\u0026#34; /etc/openvpn/server/crl.pem echo echo \u0026#34;$client revoked!\u0026#34; else echo echo \u0026#34;$client revocation aborted!\u0026#34; fi exit ;; 3) echo read -p \u0026#34;Confirm OpenVPN removal? [y/N]: \u0026#34; remove until [[ \u0026#34;$remove\u0026#34; =~ ^[yYnN]*$ ]]; do echo \u0026#34;$remove: invalid selection.\u0026#34; read -p \u0026#34;Confirm OpenVPN removal? [y/N]: \u0026#34; remove done if [[ \u0026#34;$remove\u0026#34; =~ ^[yY]$ ]]; then port=$(grep \u0026#39;^port \u0026#39; /etc/openvpn/server/server.conf | cut -d \u0026#34; \u0026#34; -f 2) protocol=$(grep \u0026#39;^proto \u0026#39; /etc/openvpn/server/server.conf | cut -d \u0026#34; \u0026#34; -f 2) if systemctl is-active --quiet firewalld.service; then ip=$(firewall-cmd --direct --get-rules ipv4 nat POSTROUTING | grep \u0026#39;\\-s 10.8.0.0/24 \u0026#39;\u0026#34;\u0026#39;\u0026#34;\u0026#39;!\u0026#39;\u0026#34;\u0026#39;\u0026#34;\u0026#39; -d 10.8.0.0/24\u0026#39; | grep -oE \u0026#39;[^ ]+$\u0026#39;) # Using both permanent and not permanent rules to avoid a firewalld reload. firewall-cmd --remove-port=\u0026#34;$port\u0026#34;/\u0026#34;$protocol\u0026#34; firewall-cmd --zone=trusted --remove-source=10.8.0.0/24 firewall-cmd --permanent --remove-port=\u0026#34;$port\u0026#34;/\u0026#34;$protocol\u0026#34; firewall-cmd --permanent --zone=trusted --remove-source=10.8.0.0/24 firewall-cmd --direct --remove-rule ipv4 nat POSTROUTING 0 -s 10.8.0.0/24 ! -d 10.8.0.0/24 -j SNAT --to \u0026#34;$ip\u0026#34; firewall-cmd --permanent --direct --remove-rule ipv4 nat POSTROUTING 0 -s 10.8.0.0/24 ! -d 10.8.0.0/24 -j SNAT --to \u0026#34;$ip\u0026#34; if grep -qs \u0026#34;server-ipv6\u0026#34; /etc/openvpn/server/server.conf; then ip6=$(firewall-cmd --direct --get-rules ipv6 nat POSTROUTING | grep \u0026#39;\\-s fddd:1194:1194:1194::/64 \u0026#39;\u0026#34;\u0026#39;\u0026#34;\u0026#39;!\u0026#39;\u0026#34;\u0026#39;\u0026#34;\u0026#39; -d fddd:1194:1194:1194::/64\u0026#39; | grep -oE \u0026#39;[^ ]+$\u0026#39;) firewall-cmd --zone=trusted --remove-source=fddd:1194:1194:1194::/64 firewall-cmd --permanent --zone=trusted --remove-source=fddd:1194:1194:1194::/64 firewall-cmd --direct --remove-rule ipv6 nat POSTROUTING 0 -s fddd:1194:1194:1194::/64 ! -d fddd:1194:1194:1194::/64 -j SNAT --to \u0026#34;$ip6\u0026#34; firewall-cmd --permanent --direct --remove-rule ipv6 nat POSTROUTING 0 -s fddd:1194:1194:1194::/64 ! -d fddd:1194:1194:1194::/64 -j SNAT --to \u0026#34;$ip6\u0026#34; fi else systemctl disable --now openvpn-iptables.service rm -f /etc/systemd/system/openvpn-iptables.service fi if sestatus 2\u0026gt;/dev/null | grep \u0026#34;Current mode\u0026#34; | grep -q \u0026#34;enforcing\u0026#34; \u0026amp;\u0026amp; [[ \u0026#34;$port\u0026#34; != 1194 ]]; then semanage port -d -t openvpn_port_t -p \u0026#34;$protocol\u0026#34; \u0026#34;$port\u0026#34; fi systemctl disable --now openvpn-server@server.service rm -rf /etc/openvpn/server rm -f /etc/systemd/system/openvpn-server@server.service.d/disable-limitnproc.conf rm -f /etc/sysctl.d/99-openvpn-forward.conf if [[ \u0026#34;$os\u0026#34; = \u0026#34;debian\u0026#34; || \u0026#34;$os\u0026#34; = \u0026#34;ubuntu\u0026#34; ]]; then apt-get remove --purge -y openvpn else # Else, OS must be CentOS or Fedora yum remove -y openvpn fi echo echo \u0026#34;OpenVPN removed!\u0026#34; else echo echo \u0026#34;OpenVPN removal aborted!\u0026#34; fi exit ;; 4) exit ;; esac fi å®‰è£…ä½¿ç”¨ 1 wget https://git.io/vpn -O openvpn-install.sh \u0026amp;\u0026amp; bash openvpn-install.sh è¿è¡Œç»“æŸä»¥åï¼Œå°±å¯ä»¥æ·»åŠ ã€åˆ é™¤ç”¨æˆ·äº†ã€‚\nä½œè€…ï¼šSREè¿ç»´åšå®¢\nåšå®¢åœ°å€ï¼šhttps://www.cnsre.cn\næ–‡ç« åœ°å€ï¼šhttps://www.cnsre.cn/posts/210913932516/\nç›¸å…³è¯é¢˜ï¼šhttps://www.cnsre.cn/tags/æ•…éšœé›†/\n","description":"OpenVPN ä¸€é”®å®‰è£…è„šæœ¬ï¼Œæ·»åŠ ç”¨æˆ·ï¼Œåˆ é™¤ç”¨æˆ·ï¼Œå¸è½½æœåŠ¡ã€‚","id":41,"section":"posts","tags":["openvpn"],"title":"CentOS 7 OpenVPN è„šæœ¬","uri":"http://www.cnsre.cn:80/posts/210913932516/"},{"content":" ä½œè€…ï¼šSREè¿ç»´åšå®¢\nåšå®¢åœ°å€ï¼šhttps://www.cnsre.cn\næ–‡ç« åœ°å€ï¼šhttps://www.cnsre.cn/posts/210910030083/\nç›¸å…³è¯é¢˜ï¼šhttps://www.cnsre.cn/tags/æ•…éšœé›†/\né—®é¢˜æè¿° åŸºäºdockerä½¿ç”¨jenkins æ„å»ºcicdï¼Œåœ¨æ‰§è¡Œdocker build çš„æ—¶å€™å‡ºç°äº†æƒé™çš„é—®é¢˜ã€‚å…·ä½“æŠ¥é”™å¦‚ä¸‹\n1 2 3 4 5 6 + REPOSITORY=10.0.0.100/library/wenlong:master + cat + docker build -t 10.0.0.100/library/wenlong:master . Got permission denied while trying to connect to the Docker daemon socket at unix:///var/run/docker. sock: Post http://%2Fvar%2Frun%2Fdocker.sock/v1.40/build?buildargt=10.0.0.100%version=1: dial unix /var/run/docker.sock: connect: permission denied åŸå›  docker è¿›ç¨‹ä½¿ç”¨ Unix Socket è€Œä¸æ˜¯ TCP ç«¯å£ã€‚è€Œé»˜è®¤æƒ…å†µä¸‹ï¼ŒUnix socket å±äº root ç”¨æˆ·ï¼Œéœ€è¦ root æƒé™æ‰èƒ½è®¿é—®ã€‚\nè¿™æ ·çš„è¯ æˆ‘ä»¬å°±éœ€è¦ç”¨ root å»è¿è¡Œ docker è€Œåœ¨æˆ‘ä»¬å®‰è£…çš„æ—¶å€™å°±å·²ç»æ˜¯ root è¿è¡Œäº†ï¼Œæ‰€ä»¥é—®é¢˜å‡ºç°åœ¨ jenkins èº«ä¸Šã€‚\nè§£å†³æ–¹æ³• ä¿®æ”¹jenkins ç”¨æˆ·æƒé™\næˆ‘æ˜¯rpmå®‰è£…çš„jenkinsï¼Œæ‰€ä»¥ä½ è¦æ‰¾åˆ°ä½ çš„jenkinsé…ç½®æ–‡ä»¶ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 [root@docker-jenkins ]# find / -name \u0026#34;jenkins\u0026#34; /run/lock/subsys/jenkins /etc/sysconfig/jenkins /etc/rc.d/init.d/jenkins /etc/logrotate.d/jenkins /var/lib/jenkins /var/log/jenkins /var/cache/jenkins /usr/lib/jenkins [root@docker-jenkins wenlong]# vim /etc/sysconfig/jenkins #ä¿®æ”¹jenkinsç”¨æˆ·ä¸ºroot ... JENKINS_USER=\u0026#34;root\u0026#34; ... è¿è¡Œjenkins build éªŒè¯é—®é¢˜ï¼Œå·²ç»è§£å†³ã€‚\nä½œè€…ï¼šSREè¿ç»´åšå®¢\nåšå®¢åœ°å€ï¼šhttps://www.cnsre.cn\næ–‡ç« åœ°å€ï¼šhttps://www.cnsre.cn/posts/210910030083/\nç›¸å…³è¯é¢˜ï¼šhttps://www.cnsre.cn/tags/æ•…éšœé›†/\n","description":"dockerä½¿ç”¨jenkins æ„å»ºcicdï¼Œåœ¨æ‰§è¡Œdocker build çš„æ—¶å€™å‡ºç°äº†æƒé™çš„é—®é¢˜","id":42,"section":"posts","tags":["jenkins","docker"],"title":"Jenkins ä½¿ç”¨ Docker æ„å»ºæŠ¥é”™","uri":"http://www.cnsre.cn:80/posts/210910030083/"},{"content":" ä½œè€…ï¼šSREè¿ç»´åšå®¢\nåšå®¢åœ°å€ï¼šhttps://www.cnsre.cn\næ–‡ç« åœ°å€ï¼šhttps://www.cnsre.cn/posts/210908023010/\nç›¸å…³è¯é¢˜ï¼šhttps://www.cnsre.cn/tags/kubernetes/\nPV å’Œ PVC æ¨¡å¼è¦å…ˆåˆ›å»ºå¥½ PVï¼Œç„¶åå†å®šä¹‰å¥½ PVC è¿›è¡Œä¸€å¯¹ä¸€çš„ç»‘å®šã€‚é‚£ä¹ˆå¦‚æœé‡åˆ°å¤§é›†ç¾¤ï¼Œä¹Ÿä¸€ä¸€çš„åˆ›å»ºå—ï¼Ÿè¿™æ ·æ¥è¯´ç»´æŠ¤æˆæœ¬å¾ˆé«˜ï¼Œå·¥ä½œé‡å¤§ã€‚è¿™ä¸ªæ—¶å€™å°±æœ‰äº† Kubernetes æä¾›ä¸€ç§è‡ªåŠ¨åˆ›å»º PV çš„æœºåˆ¶ï¼Œå« StorageClass ï¼Œå®ƒçš„ä½œç”¨å°±æ˜¯åˆ›å»º PV çš„æ¨¡æ¿ã€‚\n** StorageClass ä¼šå®šä¹‰ä¸¤éƒ¨åˆ†ï¼š**\nPVçš„å±æ€§ï¼š\næ¯”å¦‚å­˜å‚¨çš„å¤§å°ã€ç±»å‹ç­‰ PVéœ€è¦ä½¿ç”¨åˆ°çš„å­˜å‚¨æ’ä»¶\næ¯”å¦‚Cephç­‰ï¼› æœ‰äº†è¿™ä¸¤éƒ¨åˆ†ä¿¡æ¯ï¼ŒKubernetes å°±èƒ½å¤Ÿæ ¹æ®ç”¨æˆ·æäº¤çš„ PVC ï¼Œæ‰¾åˆ°å¯¹åº”çš„ StorageClass ï¼Œç„¶å Kubernetes å°±ä¼šè°ƒç”¨ StorageClass å£°æ˜çš„å­˜å‚¨æ’ä»¶ï¼Œè‡ªåŠ¨åˆ›å»º PV ã€‚\nä¸è¿‡è¦ä½¿ç”¨ NFS ï¼Œæˆ‘ä»¬å°±éœ€è¦ä¸€ä¸ª nfs-client çš„æ’ä»¶ã€‚è¿™ä¸ªæ’ä»¶ä¼šä½¿ NFS æœåŠ¡è‡ªåŠ¨å¸®æˆ‘ä»¬åˆ›å»º PV ã€‚\nè‡ªåŠ¨åˆ›å»ºçš„ PV ä¼šä»¥ ${namespace}-${pvcName}-${pvName} çš„æ ¼å¼å­˜å‚¨\nå¦‚æœ PV è¢«å›æ”¶ï¼Œåˆ™ä¼šä»¥ archieved-${namespace}-${pvcName}-${pvName} çš„æ ¼å¼å­˜å‚¨\nè¯¦ç»†å¯ä»¥å‚è€ƒ Github\nPVã€PVCã€NFSä¸å†ä»‹ç»,æ²¡æœ‰å®Œæˆçš„è¯·æŸ¥çœ‹ kubernetesä½¿ç”¨PVå’ŒPVCç®¡ç†æ•°æ®å­˜å‚¨\nåˆ›å»ºServiceAccount åˆ›å»º ServiceAccount çš„ç›®çš„æ˜¯ä¸ºäº†ç»™ nfs-client æˆæƒã€‚\n1 2 # ä¸‹è½½ rbac.yaml wget https://github.com/kubernetes-retired/external-storage/blob/201f40d78a9d3fd57d8a441cfc326988d88f35ec/nfs-client/deploy/rbac.yaml éƒ¨ç½² rbac.yaml\n1 2 3 4 5 6 7 kubectl apply -f rbac.yaml # è¾“å‡ºå¦‚ä¸‹ serviceaccount/nfs-client-provisioner created clusterrole.rbac.authorization.k8s.io/nfs-client-provisioner-runner created clusterrolebinding.rbac.authorization.k8s.io/run-nfs-client-provisioner created role.rbac.authorization.k8s.io/leader-locking-nfs-client-provisioner created rolebinding.rbac.authorization.k8s.io/leader-locking-nfs-client-provisioner created åˆ›å»º nfs-client ä½¿ç”¨ Deployment æ¥åˆ›å»º nfs-client\n1 2 # ä¸‹è½½ deployment.yaml wget https://github.com/kubernetes-retired/external-storage/blob/201f40d78a9d3fd57d8a441cfc326988d88f35ec/nfs-client/deploy/deployment.yaml ä¿®æ”¹ yaml å¦‚ä¸‹\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 apiVersion: apps/v1 kind: Deployment metadata: name: nfs-client-provisioner labels: app: nfs-client-provisioner # replace with namespace where provisioner is deployed namespace: default spec: replicas: 1 strategy: type: Recreate selector: matchLabels: app: nfs-client-provisioner template: metadata: labels: app: nfs-client-provisioner spec: serviceAccountName: nfs-client-provisioner containers: - name: nfs-client-provisioner image: quay.io/external_storage/nfs-client-provisioner:latest volumeMounts: - name: nfs-client-root mountPath: /persistentvolumes env: - name: PROVISIONER_NAME value: fuseim.pri/ifs # è¿™é‡Œçš„ä¾›åº”è€…åç§°å¿…é¡»å’Œclass.yamlä¸­çš„provisionerçš„åç§°ä¸€è‡´ï¼Œå¦åˆ™éƒ¨ç½²ä¸æˆåŠŸ - name: NFS_SERVER value: 10.0.10.51 # è¿™é‡Œå†™NFSæœåŠ¡å™¨çš„IPåœ°å€æˆ–è€…èƒ½è§£æåˆ°çš„ä¸»æœºå - name: NFS_PATH value: /home/bsh/nfs # è¿™é‡Œå†™NFSæœåŠ¡å™¨ä¸­çš„å…±äº«æŒ‚è½½ç›®å½•ï¼ˆå¼ºè°ƒï¼šè¿™é‡Œçš„è·¯å¾„å¿…é¡»æ˜¯ç›®å½•ä¸­æœ€åä¸€å±‚çš„æ–‡ä»¶å¤¹ï¼Œå¦åˆ™éƒ¨ç½²çš„åº”ç”¨å°†æ— æƒé™åˆ›å»ºç›®å½•å¯¼è‡´Pendingï¼‰ volumes: - name: nfs-client-root nfs: server: 10.0.10.51 # NFSæœåŠ¡å™¨çš„IPæˆ–å¯è§£æåˆ°çš„ä¸»æœºå path: /home/bsh/nfs # NFSæœåŠ¡å™¨ä¸­çš„å…±äº«æŒ‚è½½ç›®å½•ï¼ˆå¼ºè°ƒï¼šè¿™é‡Œçš„è·¯å¾„å¿…é¡»æ˜¯ç›®å½•ä¸­æœ€åä¸€å±‚çš„æ–‡ä»¶å¤¹ï¼Œå¦åˆ™éƒ¨ç½²çš„åº”ç”¨å°†æ— æƒé™åˆ›å»ºç›®å½•å¯¼è‡´Pendingï¼‰ âš ï¸ æ³¨æ„\nvalue: fuseim.pri/ifs # è¿™é‡Œçš„ä¾›åº”è€…åç§°å¿…é¡»å’Œ class.yaml ä¸­çš„ provisioner çš„åç§°ä¸€è‡´ï¼Œå¦åˆ™éƒ¨ç½²ä¸æˆåŠŸ\nåˆ›å»ºæ£€æŸ¥\n1 2 3 4 # éƒ¨ç½² nfs-client kubectl apply -f deployment.yaml # è¾“å‡ºå¦‚ä¸‹ deployment.apps/nfs-client-provisioner created æŸ¥çœ‹pod\n1 2 3 4 kubectl get pod # è¾“å‡ºå¦‚ä¸‹ NAME READY STATUS RESTARTS AGE nfs-client-provisioner-fd74f99b4-wr58j 1/1 Running 1 30s åˆ›å»º StorageClass class.yaml å†…å®¹æ¯”è¾ƒå°‘ï¼Œå¯ä»¥ä¸ç”¨ä¸‹è½½,å…·ä½“å†…å®¹å¦‚ä¸‹\nclass.yaml ä¸‹è½½åœ°å€\n1 2 3 4 5 6 7 apiVersion: storage.k8s.io/v1 kind: StorageClass metadata: name: managed-nfs-storage provisioner: fuseim.pri/ifs # or choose another name, must match deployment\u0026#39;s env PROVISIONER_NAME\u0026#39; parameters: archiveOnDelete: \u0026#34;false\u0026#34; âš ï¸ æ³¨æ„\nprovisioner å¿…é¡»å’Œä¸Šé¢å¾— Deployment çš„ YAML æ–‡ä»¶ä¸­ PROVISIONER_NAME çš„å€¼ä¿æŒä¸€è‡´ã€‚ åˆ›å»º storageclass\n1 2 3 4 # åˆ›å»º kubectl apply -f class.yaml # è¾“å‡ºå¦‚ä¸‹ storageclass.storage.k8s.io/managed-nfs-storage created æŸ¥çœ‹çŠ¶æ€\n1 2 3 4 kubectl get storageclass # è¾“å‡ºå¦‚ä¸‹ NAME PROVISIONER RECLAIMPOLICY VOLUMEBINDINGMODE ALLOWVOLUMEEXPANSION AGE managed-nfs-storage fuseim.pri/ifs Delete Immediate false 53s åˆ›å»º PVC åˆ›å»º tomcat-storageclass-pvc.yaml\n1 2 3 4 5 6 7 8 9 10 11 12 kind: PersistentVolumeClaim apiVersion: v1 metadata: name: tomcat annotations: volume.beta.kubernetes.io/storage-class: \u0026#34;managed-nfs-storage\u0026#34; spec: accessModes: - ReadWriteMany resources: requests: storage: 500Mi éƒ¨ç½² yaml\n1 2 3 kubectl apply -f tomcat-storageclass-pvc.yaml # è¾“å‡ºå¦‚ä¸‹ persistentvolumeclaim/tomcat created æŸ¥çœ‹çŠ¶æ€\n1 2 3 4 kubectl get pvc # è¾“å‡ºå¦‚ä¸‹ NAME STATUS VOLUME CAPACITY ACCESS MODES STORAGECLASS AGE tomcat Bound pvc-d35c82e3-29f3-4f6d-b25d-3ccdd365d1ec 500Mi RWX managed-nfs-storage 48s pod ä½¿ç”¨æ·»åŠ  pvc è¿˜æ‹¿ä¹‹å‰çš„ tomcat åšå®éªŒï¼Œæˆ‘ä»¬æŠŠ tomcat ç›®å½•ä¸‹çš„ logs æ‹¿åˆ°æœ¬åœ° nfs ä¸­ã€‚\nâš ï¸ æ³¨æ„\nå¦‚æœé‡åˆ°ä½¿ç”¨PVC åˆ›å»º pod çš„æ—¶å€™å‘ç°æ— æ³•åˆ›å»ºæˆåŠŸã€‚å‡ºç°ä¸€ä¸‹æŠ¥é”™çš„æ—¶å€™è¯·å‚è€ƒ kubernetes ä½¿ç”¨ PCV åˆ›å»º pod æŠ¥é”™ persistentvolume-controller waiting for a volume to be created\nå…·ä½“ yaml å¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 apiVersion: apps/v1 kind: Deployment metadata: name: tomcat-deployment labels: app: tomcat spec: replicas: 3 selector: matchLabels: app: tomcat minReadySeconds: 1 progressDeadlineSeconds: 60 revisionHistoryLimit: 2 strategy: type: RollingUpdate rollingUpdate: maxSurge: 1 maxUnavailable: 1 template: metadata: labels: app: tomcat spec: containers: - name: tomcat image: wenlongxue/tomcat:tomcat-demo-62-123xw2 imagePullPolicy: Always ports: - containerPort: 8080 resources: requests: memory: \u0026#34;2Gi\u0026#34; cpu: \u0026#34;80m\u0026#34; limits: memory: \u0026#34;2Gi\u0026#34; cpu: \u0026#34;80m\u0026#34; readinessProbe: httpGet: path: / port: 8080 initialDelaySeconds: 180 periodSeconds: 5 timeoutSeconds: 3 successThreshold: 1 failureThreshold: 30 volumeMounts: - mountPath: \u0026#34;/usr/local/tomcat/logs\u0026#34; name: tomcat # pvc éƒ¨åˆ† volumes: - name: tomcat persistentVolumeClaim: claimName: tomcat --- # Service æœåŠ¡éƒ¨åˆ† apiVersion: v1 kind: Service metadata: name: tomcat-service labels: app: tomcat spec: selector: app: tomcat ports: - name: tomcat-port protocol: TCP port: 8080 targetPort: 8080 type: ClusterIP --- # ingress æœåŠ¡éƒ¨åˆ† apiVersion: networking.k8s.io/v1 kind: Ingress metadata: name: tomcat annotations: kubernetes.io/ingress.class: \u0026#34;nginx\u0026#34; spec: tls: - hosts: - tomcat.cnsre.cn secretName: tls-secret rules: - host: tomcat.cnsre.cn http: paths: - path: \u0026#34;/\u0026#34; pathType: Prefix backend: service: name: tomcat-service port: number: 8080 éƒ¨ç½² pod æœåŠ¡\n1 2 3 kubectl apply -f tomcatc.yaml # è¾“å‡ºå¦‚ä¸‹ deployment.apps/tomcat-deployment created æŸ¥çœ‹çŠ¶æ€\n1 2 3 4 5 6 7 kubectl get pod # è¾“å‡ºå¦‚ä¸‹ NAME READY STATUS RESTARTS AGE nfs-client-provisioner-fd74f99b4-wr58j 1/1 Running 0 76m tomcat-deployment-7588b5c8fd-cnwvt 1/1 Running 0 59m tomcat-deployment-7588b5c8fd-kl8fj 1/1 Running 0 59m tomcat-deployment-7588b5c8fd-ksbg9 1/1 Running 0 59m æŸ¥çœ‹ PV PVC 1 2 3 4 5 6 [root@master tomccat]# kubectl get pv,pvc NAME CAPACITY ACCESS MODES RECLAIM POLICY STATUS CLAIM STORAGECLASS REASON AGE persistentvolume/pvc-d35c82e3-29f3-4f6d-b25d-3ccdd365d1ec 500Mi RWX Delete Bound default/tomcat managed-nfs-storage 65m NAME STATUS VOLUME CAPACITY ACCESS MODES STORAGECLASS AGE persistentvolumeclaim/tomcat Bound pvc-d35c82e3-29f3-4f6d-b25d-3ccdd365d1ec 500Mi RWX managed-nfs-storage 65m æŸ¥çœ‹ nfs server ç›®å½•ä¸­ä¿¡æ¯ 1 2 3 4 5 6 7 [root@node1 ~]# ll /home/bsh/nfs/default-tomcat-pvc-d35c82e3-29f3-4f6d-b25d-3ccdd365d1ec/ æ€»ç”¨é‡ 220 -rw-r-----. 1 root root 22217 9æœˆ 3 14:49 catalina.2021-09-03.log -rw-r-----. 1 root root 0 9æœˆ 3 14:41 host-manager.2021-09-03.log -rw-r-----. 1 root root 2791 9æœˆ 3 14:49 localhost.2021-09-03.log -rw-r-----. 1 root root 118428 9æœˆ 3 15:31 localhost_access_log.2021-09-03.txt -rw-r-----. 1 root root 0 9æœˆ 3 14:41 manager.2021-09-03.log ä½œè€…ï¼šSREè¿ç»´åšå®¢\nåšå®¢åœ°å€ï¼šhttps://www.cnsre.cn\næ–‡ç« åœ°å€ï¼šhttps://www.cnsre.cn/posts/210908023010/\nç›¸å…³è¯é¢˜ï¼šhttps://www.cnsre.cn/tags/kubernetes/\n","description":"Podé‡å¯æˆ–è€…è¢«åˆ é™¤çš„æ—¶å€™å®¹å™¨ä¸­çš„æ•°æ®ä¸¢å¤±ï¼Ÿå¤§é›†ç¾¤é¢‘ç¹åˆ›å»ºPVï¼ŸStorageClasså¸®ä½ ç®¡ç†æ•°æ®å­˜å‚¨ã€‚","id":43,"section":"posts","tags":["kubernetes","storageclass"],"title":"Kubernetes æŒä¹…åŒ–æ•°æ®å­˜å‚¨ StorageClass","uri":"http://www.cnsre.cn:80/posts/210908023010/"},{"content":" ä½œè€…ï¼šSREè¿ç»´åšå®¢\nåšå®¢åœ°å€ï¼šhttps://www.cnsre.cn\næ–‡ç« åœ°å€ï¼šhttps://www.cnsre.cn/posts/210906949577/\nç›¸å…³è¯é¢˜ï¼šhttps://www.cnsre.cn/tags/kubernetes/\næ•…éšœè¡¨ç° åœ¨ä½¿ç”¨PVC åˆ›å»º pod çš„æ—¶å€™å‘ç°æ— æ³•åˆ›å»ºæˆåŠŸã€‚\né—®é¢˜æ’æŸ¥è¿‡ç¨‹ å…ˆé€šè¿‡çœ‹æ—¥å¿—å‘ç°\n1 Normal ExternalProvisioning 8s (x3 over 19s) persistentvolume-controller waiting for a volume to be created, either by external provisioner \u0026#34;fuseim.pri/ifs\u0026#34; or manually created by system administrator æœ€åé€šè¿‡åœ¨ç½‘ä¸ŠæŸ¥é˜…èµ„æ–™å‘ç°åŸæ¥æ˜¯ 1.20 ç‰ˆæœ¬ é»˜è®¤ç¦æ­¢ä½¿ç”¨ selfLink ã€‚æˆ‘çš„ç‰ˆæœ¬ä¸º v1.20.6\nå‚è€ƒé“¾æ¥ Guthub Issues\né—®é¢˜è§£å†³ å½“å‰çš„è§£å†³æ–¹æ³•æ˜¯ç¼–è¾‘ /etc/kubernetes/manifests/kube-apiserver.yaml\nåœ¨ kube-apiserver ä¸‹æ–°å¢ä¸€è¡Œ\nå…·ä½“å¦‚ä¸‹\n1 2 3 4 5 spec: containers: - command: - kube-apiserver - --feature-gates=RemoveSelfLink=false ç„¶åæ›´æ–°å³å¯ã€‚\n1 kubectl apply -f /etc/kubernetes/manifests/kube-apiserver.yaml ä½œè€…ï¼šSREè¿ç»´åšå®¢\nåšå®¢åœ°å€ï¼šhttps://www.cnsre.cn\næ–‡ç« åœ°å€ï¼šhttps://www.cnsre.cn/posts/210906949577/\nç›¸å…³è¯é¢˜ï¼šhttps://www.cnsre.cn/tags/kubernetes/\n","description":"ä½¿ç”¨pv pvc åˆ›å»º pod æ—¶å‡ºç°æŠ¥é”™ã€‚ persistentvolume-controller  waiting for a volume to be created, either by external provisioner \"fuseim.pri/ifs\" or manually created by system administrator","id":44,"section":"posts","tags":["kubernetes"],"title":"kubernetes ä½¿ç”¨ PCV åˆ›å»º pod æŠ¥é”™ persistentvolume-controller  waiting for a volume to be created","uri":"http://www.cnsre.cn:80/posts/210906949577/"},{"content":" ä½œè€…ï¼šSREè¿ç»´åšå®¢\nåšå®¢åœ°å€ï¼šhttps://www.cnsre.cn\næ–‡ç« åœ°å€ï¼šhttps://www.cnsre.cn/posts/210903021487/\nç›¸å…³è¯é¢˜ï¼šhttps://www.cnsre.cn/tags/kubernetes/\nå®¹å™¨ç£ç›˜ä¸Šçš„æ–‡ä»¶çš„ç”Ÿå‘½å‘¨æœŸæ˜¯çŸ­æš‚çš„ï¼Œè¿™å°±ä½¿å¾—åœ¨å®¹å™¨ä¸­è¿è¡Œé‡è¦åº”ç”¨æ—¶ä¼šå‡ºç°ä¸€äº›é—®é¢˜ã€‚é¦–å…ˆï¼Œå½“å®¹å™¨å´©æºƒæ—¶ï¼Œkubelet ä¼šé‡å¯å®ƒï¼Œä½†æ˜¯å®¹å™¨ä¸­çš„æ–‡ä»¶å°†ä¸¢å¤±â€”â€”å®¹å™¨ä»¥å¹²å‡€çš„çŠ¶æ€ï¼ˆé•œåƒæœ€åˆçš„çŠ¶æ€ï¼‰é‡æ–°å¯åŠ¨ã€‚å…¶æ¬¡ï¼Œåœ¨ Pod ä¸­åŒæ—¶è¿è¡Œå¤šä¸ªå®¹å™¨æ—¶ï¼Œè¿™äº›å®¹å™¨ä¹‹é—´é€šå¸¸éœ€è¦å…±äº«æ–‡ä»¶ã€‚æ‰€ä»¥æˆ‘ä¼šç”¨ NFS ä¸ºä¾‹ï¼Œåˆ›å»º PV ã€PVC.\nPV å±äºé›†ç¾¤ä¸­çš„èµ„æºã€‚PVC æ˜¯å¯¹è¿™äº›èµ„æºçš„è¯·æ±‚ï¼Œä¹Ÿä½œä¸ºå¯¹èµ„æºçš„è¯·æ±‚çš„æ£€æŸ¥ã€‚ PV å’Œ PVC ä¹‹é—´çš„ç›¸äº’ä½œç”¨éµå¾ªè¿™æ ·çš„ç”Ÿå‘½å‘¨æœŸ.\nPersistentVolumeï¼ˆPVï¼‰ PersistentVolumeï¼ˆPVï¼‰æ˜¯ç”±ç®¡ç†å‘˜è®¾ç½®çš„å­˜å‚¨ï¼Œå®ƒæ˜¯ç¾¤é›†çš„ä¸€éƒ¨åˆ†ã€‚å°±åƒèŠ‚ç‚¹æ˜¯é›†ç¾¤ä¸­çš„èµ„æºä¸€æ ·ï¼ŒPV ä¹Ÿæ˜¯é›†ç¾¤ä¸­çš„èµ„æºã€‚ PV æ˜¯ Volume ä¹‹ç±»çš„å·æ’ä»¶ï¼Œä½†å…·æœ‰ç‹¬ç«‹äºä½¿ç”¨ PV çš„ Pod çš„ç”Ÿå‘½å‘¨æœŸã€‚æ­¤ API å¯¹è±¡åŒ…å«å­˜å‚¨å®ç°çš„ç»†èŠ‚ï¼Œå³ NFSã€iSCSI æˆ–ç‰¹å®šäºäº‘ä¾›åº”å•†çš„å­˜å‚¨ç³»ç»Ÿã€‚\nPV æœ‰ä¸¤ç§æ–¹å¼æ¥é…ç½®ï¼šé™æ€å’ŒåŠ¨æ€ã€‚\né™æ€\né›†ç¾¤ç®¡ç†å‘˜åˆ›å»ºä¸€äº› PVã€‚å®ƒä»¬å¸¦æœ‰å¯ä¾›ç¾¤é›†ç”¨æˆ·ä½¿ç”¨çš„å®é™…å­˜å‚¨çš„ç»†èŠ‚ã€‚å®ƒä»¬å­˜åœ¨äº Kubernetes API ä¸­ï¼Œå¯ç”¨äºæ¶ˆè´¹ã€‚ åŠ¨æ€\næ ¹æ® StorageClassesï¼Œå½“ç®¡ç†å‘˜åˆ›å»ºçš„é™æ€ PV éƒ½ä¸åŒ¹é…ç”¨æˆ·çš„ PersistentVolumeClaim æ—¶ï¼Œé›†ç¾¤å¯èƒ½ä¼šå°è¯•åŠ¨æ€åœ°ä¸º PVC åˆ›å»ºå·ã€‚ å®‰è£…å¹¶é…ç½® nfs rpcbind 1 2 3 4 yum install -y nfs-utils rpcbind mkdir -p /home/bsh/nfs vim /etc/exports /home/bsh/nfs *(rw,sync,no_root_squash) é…ç½®è¯¦è§£ï¼š ro åªè¯»è®¿é—® rw è¯»å†™è®¿é—® sync æ‰€æœ‰æ•°æ®åœ¨è¯·æ±‚æ—¶å†™å…¥å…±äº« async NFSåœ¨å†™å…¥æ•°æ®å‰å¯ä»¥ç›¸åº”è¯·æ±‚ secure NFSé€šè¿‡1024ä»¥ä¸‹çš„å®‰å…¨TCP/IPç«¯å£å‘é€ insecure NFSé€šè¿‡1024ä»¥ä¸Šçš„ç«¯å£å‘é€ wdelay å¦‚æœå¤šä¸ªç”¨æˆ·è¦å†™å…¥NFSç›®å½•ï¼Œåˆ™å½’ç»„å†™å…¥ï¼ˆé»˜è®¤ï¼‰ no_wdelay å¦‚æœå¤šä¸ªç”¨æˆ·è¦å†™å…¥NFSç›®å½•ï¼Œåˆ™ç«‹å³å†™å…¥ï¼Œå½“ä½¿ç”¨asyncæ—¶ï¼Œæ— éœ€æ­¤è®¾ç½®ã€‚ Hide åœ¨NFSå…±äº«ç›®å½•ä¸­ä¸å…±äº«å…¶å­ç›®å½• no_hide å…±äº«NFSç›®å½•çš„å­ç›®å½• subtree_check å¦‚æœå…±äº«/usr/binä¹‹ç±»çš„å­ç›®å½•æ—¶ï¼Œå¼ºåˆ¶NFSæ£€æŸ¥çˆ¶ç›®å½•çš„æƒé™ï¼ˆé»˜è®¤ï¼‰ no_subtree_check å’Œä¸Šé¢ç›¸å¯¹ï¼Œä¸æ£€æŸ¥çˆ¶ç›®å½•æƒé™ all_squash å…±äº«æ–‡ä»¶çš„UIDå’ŒGIDæ˜ å°„åŒ¿åç”¨æˆ·anonymousï¼Œé€‚åˆå…¬ç”¨ç›®å½•ã€‚ no_all_squash ä¿ç•™å…±äº«æ–‡ä»¶çš„UIDå’ŒGIDï¼ˆé»˜è®¤ï¼‰ root_squash rootç”¨æˆ·çš„æ‰€æœ‰è¯·æ±‚æ˜ å°„æˆå¦‚anonymousç”¨æˆ·ä¸€æ ·çš„æƒé™ï¼ˆé»˜è®¤ï¼‰ no_root_squas rootç”¨æˆ·å…·æœ‰æ ¹ç›®å½•çš„å®Œå…¨ç®¡ç†è®¿é—®æƒé™ anonuid=xxx æŒ‡å®šNFSæœåŠ¡å™¨/etc/passwdæ–‡ä»¶ä¸­åŒ¿åç”¨æˆ·çš„UID å¯åŠ¨ nfs rpcbind\n1 2 systemctl enable nfs rpcbind systemctl start nfs rpcbind åˆ›å»ºPV åˆ›å»º yaml æ–‡ä»¶\nvim tomcat-log-pv.yaml\n1 2 3 4 5 6 7 8 9 10 11 12 apiVersion: v1 kind: PersistentVolume metadata: name: tomcat spec: capacity: storage: 1Gi accessModes: - ReadWriteMany nfs: path: /home/bsh/nfs/tomcat-log server: 10.0.10.51 åˆ›å»º pv\n1 kubectl apply -f tomcat-log-pv.yaml æŸ¥çœ‹pv\n1 2 3 [root@master ]# kubectl get pv NAME CAPACITY ACCESS MODES RECLAIM POLICY STATUS CLAIM STORAGECLASS REASON AGE tomcat 1Gi RWX Retain Available 26s pv å±æ€§è¯¦è§£ PVçš„å­˜å‚¨å®¹é‡\nPV å°†å…·æœ‰ç‰¹å®šçš„å­˜å‚¨å®¹é‡ã€‚è¿™æ˜¯ä½¿ç”¨PVçš„capacityå±æ€§è®¾ç½®çš„ã€‚\nç›®å‰ï¼Œå­˜å‚¨å¤§å°æ˜¯å¯ä»¥è®¾ç½®æˆ–è¯·æ±‚çš„å”¯ä¸€èµ„æºã€‚æœªæ¥çš„å±æ€§å¯èƒ½åŒ…æ‹¬ IOPSã€ååé‡ç­‰ã€‚\nPVçš„è®¿é—®æ¨¡å¼\nPersistentVolumeå¯ä»¥ä»¥èµ„æºæä¾›è€…æ”¯æŒçš„ä»»ä½•æ–¹å¼æŒ‚è½½åˆ°ä¸»æœºä¸Šã€‚å¦‚ä¸‹è¡¨æ‰€ç¤ºï¼Œä¾›åº”å•†å…·æœ‰ä¸åŒçš„åŠŸèƒ½ï¼Œæ¯ä¸ª PV çš„è®¿é—®æ¨¡å¼éƒ½å°†è¢«è®¾ç½®ä¸ºè¯¥å·æ”¯æŒçš„ç‰¹å®šæ¨¡å¼ã€‚ä¾‹å¦‚ï¼ŒNFS å¯ä»¥æ”¯æŒå¤šä¸ªè¯»/å†™å®¢æˆ·ç«¯ï¼Œä½†ç‰¹å®šçš„ NFS PV å¯èƒ½ä»¥åªè¯»æ–¹å¼å¯¼å‡ºåˆ°æœåŠ¡å™¨ä¸Šã€‚æ¯ä¸ª PV éƒ½æœ‰ä¸€å¥—è‡ªå·±çš„ç”¨æ¥æè¿°ç‰¹å®šåŠŸèƒ½çš„è®¿é—®æ¨¡å¼ã€‚\nå­˜å‚¨æ¨¡å¼åŒ…æ‹¬ï¼š\nReadWriteOnceâ€”â€”è¯¥å·å¯ä»¥è¢«å•ä¸ªèŠ‚ç‚¹ä»¥è¯»/å†™æ¨¡å¼æŒ‚è½½ ReadOnlyManyâ€”â€”è¯¥å·å¯ä»¥è¢«å¤šä¸ªèŠ‚ç‚¹ä»¥åªè¯»æ¨¡å¼æŒ‚è½½ ReadWriteManyâ€”â€”è¯¥å·å¯ä»¥è¢«å¤šä¸ªèŠ‚ç‚¹ä»¥è¯»/å†™æ¨¡å¼æŒ‚è½½\nåœ¨å‘½ä»¤è¡Œä¸­ï¼Œè®¿é—®æ¨¡å¼ç¼©å†™ä¸ºï¼š RWO - ReadWriteOnce ROX - ReadOnlyMany RWX - ReadWriteMany\nä¸€ä¸ªå·ä¸€æ¬¡åªèƒ½ä½¿ç”¨ä¸€ç§è®¿é—®æ¨¡å¼æŒ‚è½½ï¼Œå³ä½¿å®ƒæ”¯æŒå¾ˆå¤šè®¿é—®æ¨¡å¼ã€‚ä¾‹å¦‚ï¼ŒGCEPersistentDisk å¯ä»¥ç”±å•ä¸ªèŠ‚ç‚¹ä½œä¸º ReadWriteOnce æ¨¡å¼æŒ‚è½½ï¼Œæˆ–ç”±å¤šä¸ªèŠ‚ç‚¹ä»¥ ReadOnlyMany æ¨¡å¼æŒ‚è½½ï¼Œä½†ä¸èƒ½åŒæ—¶æŒ‚è½½\nPVçš„å›æ”¶ç­–ç•¥\npersistentVolumeReclaimPolicyå±æ€§ç”¨æ¥æŒ‡å®šPVçš„å›æ”¶ç­–ç•¥ å½“å‰çš„å›æ”¶ç­–ç•¥åŒ…æ‹¬ï¼š\nRetainï¼ˆä¿ç•™ï¼‰â€”â€”æ‰‹åŠ¨å›æ”¶ Recycleï¼ˆå›æ”¶ï¼‰â€”â€”åŸºæœ¬æ“¦é™¤ï¼ˆrm -rf /thevolume/*ï¼‰ Deleteï¼ˆåˆ é™¤ï¼‰â€”â€”å…³è”çš„å­˜å‚¨èµ„äº§ï¼ˆä¾‹å¦‚ AWS EBSã€GCE PDã€Azure Disk å’Œ OpenStack Cinder å·ï¼‰å°†è¢«åˆ é™¤\nå½“å‰ï¼Œåªæœ‰ NFS å’Œ HostPath æ”¯æŒå›æ”¶ç­–ç•¥ã€‚AWS EBSã€GCE PDã€Azure Disk å’Œ Cinder å·æ”¯æŒåˆ é™¤ç­–ç•¥ã€‚ storageClassName PV å¯ä»¥å…·æœ‰ä¸€ä¸ªç±»ï¼Œé€šè¿‡å°† storageClassName å±æ€§è®¾ç½®ä¸º StorageClass çš„åç§°æ¥æŒ‡å®šè¯¥ç±»ã€‚ä¸€ä¸ªç‰¹å®šç±»åˆ«çš„ PV åªèƒ½ç»‘å®šåˆ°è¯·æ±‚è¯¥ç±»åˆ«çš„ PVCã€‚æ²¡æœ‰ storageClassName çš„ PV å°±æ²¡æœ‰ç±»ï¼Œå®ƒåªèƒ½ç»‘å®šåˆ°ä¸éœ€è¦ç‰¹å®šç±»çš„ PVCã€‚\nPersistentVolumeClaimï¼ˆPVCï¼‰ PersistentVolumeClaimï¼ˆPVCï¼‰æ˜¯ç”¨æˆ·å­˜å‚¨çš„è¯·æ±‚ã€‚å®ƒä¸ Pod ç›¸ä¼¼ã€‚Pod æ¶ˆè€—èŠ‚ç‚¹èµ„æºï¼ŒPVC æ¶ˆè€— PV èµ„æºã€‚Pod å¯ä»¥è¯·æ±‚ç‰¹å®šçº§åˆ«çš„èµ„æºï¼ˆCPU å’Œå†…å­˜ï¼‰ã€‚å£°æ˜å¯ä»¥è¯·æ±‚ç‰¹å®šçš„å¤§å°å’Œè®¿é—®æ¨¡å¼ï¼ˆä¾‹å¦‚ï¼Œå¯ä»¥ä»¥è¯»/å†™ä¸€æ¬¡æˆ– åªè¯»å¤šæ¬¡æ¨¡å¼æŒ‚è½½ï¼‰ã€‚\nåˆ›å»ºPVC åˆ›å»º yaml æ–‡ä»¶\nvim tomcat-log-pvc.yaml\n1 2 3 4 5 6 7 8 9 10 apiVersion: v1 kind: PersistentVolumeClaim metadata: name: tomcat spec: accessModes: - ReadWriteMany resources: requests: storage: 1Gi åˆ›å»º pv\n1 kubectl apply -f tomcat-log-pvc.yaml æŸ¥çœ‹pv\n1 2 3 [root@master ]# kubectl get pvc NAME STATUS VOLUME CAPACITY ACCESS MODES STORAGECLASS AGE tomcat Bound tomcat 1Gi RWX 18s ä½¿ç”¨PVC vim tomcat.yaml\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 apiVersion: apps/v1 kind: Deployment metadata: name: tomcat-deployment labels: app: tomcat spec: replicas: 3 selector: matchLabels: app: tomcat minReadySeconds: 1 progressDeadlineSeconds: 60 revisionHistoryLimit: 2 strategy: type: RollingUpdate rollingUpdate: maxSurge: 1 maxUnavailable: 1 template: metadata: labels: app: tomcat spec: containers: - name: tomcat image: wenlongxue/tomcat:tomcat-demo-62-8fe6052 imagePullPolicy: Always ports: - containerPort: 8080 resources: requests: memory: \u0026#34;2Gi\u0026#34; cpu: \u0026#34;80m\u0026#34; limits: memory: \u0026#34;2Gi\u0026#34; cpu: \u0026#34;80m\u0026#34; readinessProbe: httpGet: path: / port: 8080 initialDelaySeconds: 180 periodSeconds: 5 timeoutSeconds: 3 successThreshold: 1 failureThreshold: 30 volumeMounts: - mountPath: \u0026#34;/usr/local/tomcat/logs\u0026#34; name: tomcat volumes: - name: tomcat persistentVolumeClaim: claimName: tomcat éƒ¨ç½²æŸ¥çœ‹ pod\n1 2 3 4 5 6 7 # éƒ¨ç½² kubectl apply -f tomcat.yaml # æŸ¥çœ‹ kubectl get pods |grep tomcat tomcat-deployment-7588b5c8fd-4grh2 1/1 Running 0 31s tomcat-deployment-7588b5c8fd-l89t7 1/1 Running 0 31s tomcat-deployment-7588b5c8fd-mb8bh 1/1 Running 0 31s æœ€å PVC ä¸å…³å¿ƒåç«¯å­˜å‚¨æä¾›è€…æ˜¯ NFS è¿˜æ˜¯ GFSï¼Œå…·ä½“ä½¿ç”¨å“ªç§ç±»å‹çš„å­˜å‚¨ç”± PV æ¥å®šä¹‰ï¼ŒPVC åªå’Œéšè—äº†å­˜å‚¨å®ç°ç»†èŠ‚çš„ PV å¯¹æ¥ã€‚\næœ¬æ–¹å¼ä¸ºé™æ€åˆ†é…ï¼Œå¦‚æœæœ‰ä¸€åƒä¸ª Podï¼Œæ¯ä¸ª Pod æœ‰ä¸€ä¸ª PVCï¼Œé‚£ä¹ˆç®¡ç†å‘˜éœ€è¦äººå·¥å¼€è®¾ä¸€åƒä¸ª PVï¼Œéšç€é›†ç¾¤è§„æ¨¡çš„æ‰©å¤§ï¼Œå°†å¯¼è‡´æ— æ³•æœ‰æ•ˆç®¡ç†ã€‚\nK8S æä¾›äº†ä¸€ç§å¯ä»¥åŠ¨æ€åˆ†é…çš„å·¥ä½œæœºåˆ¶ï¼Œå¯ä»¥è‡ªåŠ¨åˆ›å»º PVï¼Œè¯¥æœºåˆ¶ä¾èµ–ä¸€ä¸ªå«åš StorageClass çš„ API å¯¹è±¡ã€‚\nä½œè€…ï¼šSREè¿ç»´åšå®¢\nåšå®¢åœ°å€ï¼šhttps://www.cnsre.cn\næ–‡ç« åœ°å€ï¼šhttps://www.cnsre.cn/posts/210903021487/\nç›¸å…³è¯é¢˜ï¼šhttps://www.cnsre.cn/tags/kubernetes/\n","description":"Podé‡å¯æˆ–è€…è¢«åˆ é™¤çš„æ—¶å€™ï¼Œå®¹å™¨ä¸­çš„æ•°æ®ä¸¢å¤±ï¼ŸPV PVC æ¥å¸®ä½ ç®¡ç†æ•°æ®å­˜å‚¨ã€‚","id":45,"section":"posts","tags":["kubernetes","pvc"],"title":"kubernetes ä½¿ç”¨ PV å’Œ PVC ç®¡ç†æ•°æ®å­˜å‚¨","uri":"http://www.cnsre.cn:80/posts/210903021487/"},{"content":" ä½œè€…ï¼šSREè¿ç»´åšå®¢\nåšå®¢åœ°å€ï¼šhttps://www.cnsre.cn\næ–‡ç« åœ°å€ï¼šhttps://www.cnsre.cn/posts/210902330007/\nç›¸å…³è¯é¢˜ï¼šhttps://www.cnsre.cn/tags/kubernetes/\ningress-nginx ingress å®˜æ–¹ç½‘ç«™\ningress ä»“åº“åœ°å€\ningress-nginx v1.0 æœ€æ–°ç‰ˆæœ¬ v1.0\né€‚ç”¨äº Kubernetes ç‰ˆæœ¬ v1.19+ ï¼ˆåŒ…æ‹¬ v1.19 ï¼‰\nKubernetes-v1.22+ éœ€è¦ä½¿ç”¨ ingress-nginx\u0026gt;=1.0ï¼Œå› ä¸º networking.k8s.io/v1beta å·²ç»ç§»é™¤\nç›´æ¥éƒ¨ç½² ingress-nginx ç›´æ¥éƒ¨ç½²æ¯”è¾ƒç®€å•ï¼Œç›´æ¥æ‹‰å» girhub çš„æ–‡ä»¶å°±å¯ä»¥äº†ï¼Œå¦‚æœé‡åˆ°é•¿æ—¶é—´æ— å“åº”ï¼Œå¯ä»¥ç»ˆæ­¢ä»»åŠ¡ä»æ–°æ‹‰å–ã€‚\næ‹‰å–é•œåƒéƒ¨åˆ†ï¼Œå¯ä»¥ä¿®æ”¹ä¸ºä¸€ä¸‹çš„é•œåƒåœ°å€\n1 2 3 4 5 wget https://raw.githubusercontent.com/kubernetes/ingress-nginx/controller-v1.0.0/deploy/static/provider/baremetal/deploy.yaml sed -i \u0026#39;s@k8s.gcr.io/ingress-nginx/controller:v1.0.0\\(.*\\)@cnsre/ingress-nginx-controller:v1.0.0@\u0026#39; deploy.yaml sed -i \u0026#39;s@k8s.gcr.io/ingress-nginx/kube-webhook-certgen:v1.0\\(.*\\)$@cnsre/ingress-nginx-kube-webhook-certgen:v1.0@\u0026#39; deploy.yaml kubectl apply -f deploy.yaml æ£€æŸ¥å®‰è£… Completed çŠ¶æ€çš„æ˜¯æ­£å¸¸çš„ï¼Œå¯ä»¥å¿½ç•¥ã€‚\n1 2 3 4 5 6 7 8 9 [root@master ~]# kubectl get po -n ingress-nginx NAME READY STATUS RESTARTS AGE ingress-nginx-admission-create-pm6sw 0/1 Completed 0 22m ingress-nginx-admission-patch-m8w94 0/1 Completed 0 22m ingress-nginx-controller-7d4df87d89-272ft 1/1 Running 0 22m [root@master ~]# kubectl get svc -n ingress-nginx NAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGE ingress-nginx-controller NodePort 10.96.88.139 \u0026lt;none\u0026gt; 80:30497/TCP,443:32581/TCP 22m ingress-nginx-controller-admission ClusterIP 10.96.193.26 \u0026lt;none\u0026gt; 443/TCP 22m åˆ›å»ºåº”ç”¨yaml 1 vim tomcat.yaml 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 apiVersion: apps/v1 kind: Deployment metadata: name: tomcat-deployment labels: app: tomcat spec: replicas: 2 selector: matchLabels: app: tomcat minReadySeconds: 1 progressDeadlineSeconds: 60 revisionHistoryLimit: 2 strategy: type: RollingUpdate rollingUpdate: maxSurge: 1 maxUnavailable: 1 template: metadata: labels: app: tomcat spec: containers: - name: tomcat image: wenlongxue/tomcat:tomcat-demo-62-8fe6052 imagePullPolicy: Always ports: - containerPort: 8080 resources: requests: memory: \u0026#34;2Gi\u0026#34; cpu: \u0026#34;80m\u0026#34; limits: memory: \u0026#34;2Gi\u0026#34; cpu: \u0026#34;80m\u0026#34; readinessProbe: httpGet: path: / port: 8080 initialDelaySeconds: 180 periodSeconds: 5 timeoutSeconds: 3 successThreshold: 1 failureThreshold: 30 --- apiVersion: v1 kind: Service metadata: name: tomcat-service labels: app: tomcat spec: selector: app: tomcat ports: - name: tomcat-port protocol: TCP port: 8080 targetPort: 8080 type: ClusterIP éƒ¨ç½² tomcat åº”ç”¨\n1 kubectl apply -f tomcat.yaml åˆ›å»º ingress yaml 1 vim tomcat-ingress.yaml 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 apiVersion: networking.k8s.io/v1 kind: Ingress metadata: name: tomcat annotations: kubernetes.io/ingress.class: \u0026#34;nginx\u0026#34; spec: rules: - host: tomcat.cnsre.cn http: paths: - path: \u0026#34;/\u0026#34; pathType: Prefix backend: service: name: tomcat-service port: number: 8080 éƒ¨ç½² tomcat ingress yaml\n1 kubectl apply -f tomcat-ingress.yaml æŸ¥çœ‹ ingress å¯¹åº”èŠ‚ç‚¹çš„ç«¯å£\n1 2 3 4 kubectl get svc -n ingress-nginx NAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGE ingress-nginx-controller NodePort 10.96.88.139 \u0026lt;none\u0026gt; 80:30497/TCP,443:32581/TCP 54m ingress-nginx-controller-admission ClusterIP 10.96.193.26 \u0026lt;none\u0026gt; 443/TCP 54m æ·»åŠ  hosts åœ¨ hosts æ–‡ä»¶æœ€åè¿½åŠ  ingress èŠ‚ç‚¹çš„ IP åœ°å€\n54.xxx.xxx.xxx tomcat.cnsre.cn ç„¶ååœ¨æµè§ˆå™¨ä¸­è®¿é—® tomcat.cnsre.cn:30497ã€‚\nä½¿ç”¨ hostNetwork çš„æ–¹å¼éƒ¨ç½² ingress-nginx æ¯æ¬¡éƒ¨ç½² ingres-nginx éƒ½éšæœºä¸€ä¸ª nodePort ï¼Œè€Œä½¿ç”¨ ingres-nginx è®¿é—®çš„æ—¶å€™ä¹Ÿè¦ä»¥ åŸŸå:ç«¯å£ çš„å½¢å¼å»è®¿é—®å¦‚ä½•ç›´æ¥ä½¿ç”¨åŸŸåå»è®¿é—®å‘¢ï¼Ÿä¸‹é¢ä»‹ç»å¦å¤–ä¸€ç§å®‰è£…æ–¹å¼ã€‚\n1 2 3 4 wget https://raw.githubusercontent.com/kubernetes/ingress-nginx/controller-v1.0.0/deploy/static/provider/baremetal/deploy.yaml sed -i \u0026#39;s@k8s.gcr.io/ingress-nginx/controller:v1.0.0\\(.*\\)@cnsre/ingress-nginx-controller:v1.0.0@\u0026#39; deploy.yaml sed -i \u0026#39;s@k8s.gcr.io/ingress-nginx/kube-webhook-certgen:v1.0\\(.*\\)$@cnsre/ingress-nginx-kube-webhook-certgen:v1.0@\u0026#39; deploy.yaml ä¼˜åŒ– ingress-nginx ä½¿ç”¨ hostNetwork é»˜è®¤ ingress-nginx éšæœºæä¾› nodeport ç«¯å£ï¼Œå¼€å¯ hostNetwork å¯ç”¨80ã€443ç«¯å£ã€‚\nä¿®æ”¹ Deployment ä¸‹é¢çš„ spec\nå‚æ•°å¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 10 ... spec: hostNetwork: true # æ–°å¢ dnsPolicy: ClusterFirst containers: - name: controller image: cnsre/ingress-nginx-controller:v1.0.0 # æ›´æ¢é•œåƒåœ°å€ imagePullPolicy: IfNotPresent lifecycle: ... ä¿®æ”¹è´Ÿè½½å‡è¡¡é—®é¢˜ æŠŠ kind: Deployment æ”¹ä¸º kind: DaemonSet æ¨¡å¼ï¼Œè¿™æ ·æ¯å° node ä¸Šéƒ½æœ‰ ingress-nginx-controller pod å‰¯æœ¬ã€‚\nå‚æ•°å¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 ... # Source: ingress-nginx/templates/controller-deployment.yaml apiVersion: apps/v1 #kind: Deployment # æ³¨é‡Š kind: DaemonSet # æ–°å¢ metadata: labels: helm.sh/chart: ingress-nginx-4.0.1 ... ä¿®æ”¹ ingressClass é—®é¢˜ å¦‚æœä¸å…³å¿ƒ ingressClass æˆ–è€…å¾ˆå¤šæ²¡æœ‰ ingressClass é…ç½®çš„ ingress å¯¹è±¡ï¼Œ\næ·»åŠ å‚æ•° ingress-controller --watch-ingress-without-class=true ã€‚\n1 2 3 4 5 6 7 8 9 10 11 ... args: - /nginx-ingress-controller - --election-id=ingress-controller-leader - --controller-class=k8s.io/ingress-nginx - --configmap=$(POD_NAMESPACE)/ingress-nginx-controller - --validating-webhook=:8443 - --validating-webhook-certificate=/usr/local/certificates/cert - --validating-webhook-key=/usr/local/certificates/key - --watch-ingress-without-class=true # æ–°å¢ ... éƒ¨ç½²æ£€æŸ¥ ingress 1 2 3 4 5 6 7 8 9 10 11 12 13 14 # éƒ¨ç½² kubectl apply -f ingress-nginx.yaml # æ£€æŸ¥ pod [root@master ~]# kubectl get pods -n ingress-nginx -o wide NAME READY STATUS RESTARTS AGE IP NODE NOMINATED NODE READINESS GATES ingress-nginx-admission-create-gmnmp 0/1 Completed 0 84m 10.100.219.105 master \u0026lt;none\u0026gt; \u0026lt;none\u0026gt; ingress-nginx-admission-patch-f5sgc 0/1 Completed 0 84m 10.100.219.106 master \u0026lt;none\u0026gt; \u0026lt;none\u0026gt; ingress-nginx-controller-b62w7 1/1 Running 0 84m 10.0.10.51 master \u0026lt;none\u0026gt; \u0026lt;none\u0026gt; ingress-nginx-controller-lsn7h 1/1 Running 0 84m 10.0.20.222 node1 \u0026lt;none\u0026gt; \u0026lt;none\u0026gt; # æ£€æŸ¥ç«¯å£ [root@master ~]# netstat -pntl |grep 443 tcp 0 0 0.0.0.0:443 0.0.0.0:* LISTEN 31248/nginx: master [root@master ~]# netstat -pntl |grep 80 tcp 0 0 0.0.0.0:80 0.0.0.0:* LISTEN 31248/nginx: master åˆ›å»ºåº”ç”¨yaml 1 vim tomcat.yaml 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 apiVersion: apps/v1 kind: Deployment metadata: name: tomcat-deployment labels: app: tomcat spec: replicas: 2 selector: matchLabels: app: tomcat minReadySeconds: 1 progressDeadlineSeconds: 60 revisionHistoryLimit: 2 strategy: type: RollingUpdate rollingUpdate: maxSurge: 1 maxUnavailable: 1 template: metadata: labels: app: tomcat spec: containers: - name: tomcat image: wenlongxue/tomcat:tomcat-demo-62-8fe6052 imagePullPolicy: Always ports: - containerPort: 8080 resources: requests: memory: \u0026#34;2Gi\u0026#34; cpu: \u0026#34;80m\u0026#34; limits: memory: \u0026#34;2Gi\u0026#34; cpu: \u0026#34;80m\u0026#34; readinessProbe: httpGet: path: / port: 8080 initialDelaySeconds: 180 periodSeconds: 5 timeoutSeconds: 3 successThreshold: 1 failureThreshold: 30 --- apiVersion: v1 kind: Service metadata: name: tomcat-service labels: app: tomcat spec: selector: app: tomcat ports: - name: tomcat-port protocol: TCP port: 8080 targetPort: 8080 type: ClusterIP éƒ¨ç½² tomcat åº”ç”¨\n1 kubectl apply -f tomcat.yaml åˆ›å»º ingress yaml 1 vim tomcat-ingress.yaml 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 apiVersion: networking.k8s.io/v1 kind: Ingress metadata: name: tomcat annotations: kubernetes.io/ingress.class: \u0026#34;nginx\u0026#34; spec: rules: - host: tomcat.cnsre.cn http: paths: - path: \u0026#34;/\u0026#34; pathType: Prefix backend: service: name: tomcat-service port: number: 8080 éƒ¨ç½² tomcat ingress yaml 1 kubectl apply -f tomcat-ingress.yaml æ·»åŠ  hosts åœ¨ hosts æ–‡ä»¶æœ€åè¿½åŠ  ingress èŠ‚ç‚¹çš„ IP åœ°å€\n54.xxx.xxx.xxx tomcat.cnsre.cn ç„¶ååœ¨æµè§ˆå™¨ä¸­è®¿é—® tomcat.cnsre.cnã€‚\nç»™ ingress-nginx é…ç½® HTTPS è®¿é—® åˆ›å»ºè‡ªç­¾è¯ä¹¦æ–‡ä»¶\n1 openssl req -x509 -nodes -newkey rsa:2048 -keyout tls.key -out tls.crt -subj \u0026#34;/CN=nginx/O=nginx\u0026#34; åˆ›å»ºåä¼šç”Ÿæˆä¸¤ä¸ªæ–‡ä»¶\n1 2 3 ll tls.* -rw-r--r--. 1 root root 1127 9æœˆ 2 13:04 tls.crt -rw-r--r--. 1 root root 1708 9æœˆ 2 13:04 tls.key åˆ›å»º secret\n1 kubectl create secret tls tls-secret --key tls.key --cert tls.crt ä¿®æ”¹ tomcat-ingress yaml\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 apiVersion: networking.k8s.io/v1 kind: Ingress metadata: name: tomcat annotations: kubernetes.io/ingress.class: \u0026#34;nginx\u0026#34; spec: tls: # æ–°å¢ - hosts: # æ–°å¢ - tomcat.cnsre.cn # æ–°å¢ secretName: tls-secret # æ–°å¢ rules: - host: tomcat.cnsre.cn http: paths: - path: \u0026#34;/\u0026#34; pathType: Prefix backend: service: name: tomcat-service port: number: 8080 ä¿®æ”¹å®Œé‡æ–°éƒ¨ç½²ä¸‹\n1 kubectl apply -f tomcat-ingress.yaml éªŒè¯è¯ä¹¦ è®¿é—®tomcat.cnsre.cn\nä½œè€…ï¼šSREè¿ç»´åšå®¢\nåšå®¢åœ°å€ï¼šhttps://www.cnsre.cn\næ–‡ç« åœ°å€ï¼šhttps://www.cnsre.cn/posts/210902330007/\nç›¸å…³è¯é¢˜ï¼šhttps://www.cnsre.cn/tags/kubernetes/\n","description":"æœ¬æ–‡ä»‹ç»äº† ingress controller v1.0 ç‰ˆæœ¬çš„å®‰è£…ï¼Œä»¥åŠä¸€äº›ç®€å•çš„ä¼˜åŒ–ä¿®æ”¹ç­‰ã€‚","id":46,"section":"posts","tags":["kubernetes","ingress"],"title":"kubernetes å®‰è£… ingress controller","uri":"http://www.cnsre.cn:80/posts/210902330007/"},{"content":" ä½œè€…ï¼šSREè¿ç»´åšå®¢\nåšå®¢åœ°å€ï¼šhttps://www.cnsre.cn\næ–‡ç« åœ°å€ï¼šhttps://www.cnsre.cn/posts/210824854115/\nç›¸å…³è¯é¢˜ï¼šhttps://www.cnsre.cn/tags/zabbix/\nZabbix 5.0 LTSæ–°å¢åŠŸèƒ½ æ–°ç‰ˆæœ¬é™„å¸¦äº†å¯ç”¨æ€§ï¼Œå®‰å…¨æ€§å’Œå®Œæ•´æ€§æ–¹é¢çš„é‡å¤§æ”¹è¿›åˆ—è¡¨ã€‚Zabbixå›¢é˜Ÿéµå¾ªçš„ä¸»è¦ç­–ç•¥æ˜¯ä½¿Zabbixå°½å¯èƒ½å¯ç”¨ã€‚Zabbixæ˜¯ä¸€ç§å¼€æºï¼Œå…è´¹çš„ç›‘è§†è§£å†³æ–¹æ¡ˆï¼Œç°åœ¨å¯ä»¥åœ¨å†…éƒ¨å’Œäº‘ä¸­éƒ¨ç½²ã€‚åœ¨RedHat / IBMï¼ŒSuSEï¼ŒUbuntuçš„æœ€æ–°ç‰ˆæœ¬çš„å¹³å°ï¼Œå®¹å™¨å’ŒLinuxå‘è¡Œç‰ˆä¸­å¯ç”¨ã€‚ç°åœ¨ï¼Œä¸€é”®å¼Zabbixéƒ¨ç½²ä¹Ÿå¯ä»¥åœ¨Azureï¼ŒAWSï¼ŒGoogle Cloudï¼ŒIBM / RedHat Cloudï¼ŒOracleå’ŒDigital Oceanä¸Šä½¿ç”¨ã€‚ç°åœ¨ï¼Œåœ¨Red Hatå’ŒAzureå¸‚åœºä¸Šæä¾›ZabbixæŠ€æœ¯æ”¯æŒæœåŠ¡ã€‚\næ­¤å¤–ï¼ŒZabbixç›‘è§†å·¥å…·è¿˜æä¾›äº†ä¸Messengerï¼Œç¥¨åŠ¡å’Œè­¦æŠ¥ç³»ç»Ÿçš„å¤§é‡ç°æˆé›†æˆã€‚æ–°ç‰ˆæœ¬æ‰©å±•äº†å¯ä»¥è½»æ¾ç›‘æ§çš„å—æ”¯æŒæœåŠ¡å’Œåº”ç”¨ç¨‹åºçš„åˆ—è¡¨ã€‚\nè‡ªåŠ¨åŒ–å’Œå‘ç°ï¼šæ–°çš„Zabbixç‰ˆæœ¬å…·æœ‰æ”¹è¿›çš„è‡ªåŠ¨åŒ–åŠŸèƒ½ã€‚æ–°ç‰ˆæœ¬å¢åŠ äº†è‡ªåŠ¨å‘ç°ç¡¬ä»¶ç»„ä»¶ï¼Œä¸Windowsç›¸å…³çš„èµ„æºä»¥åŠJavaåº¦é‡çš„é«˜çº§å‘ç°çš„åŠŸèƒ½ã€‚ å¯æ‰©å±•æ€§ï¼šZabbix UIå·²ç»è¿‡ä¼˜åŒ–ï¼Œå¯ä»¥ç®€åŒ–å¯¹æ•°ç™¾ä¸‡ä¸ªè®¾å¤‡çš„ç›‘è§†ã€‚ æ–°çš„Zabbixç›‘è§†ä»£ç†ç¨‹åºå…·æœ‰â€œå®˜æ–¹æ”¯æŒâ€çŠ¶æ€ã€‚æ–°çš„å¯æ‰©å±•ä»£ç†ä¸ºæœ€è‹›åˆ»çš„å®¢æˆ·å’Œå¤æ‚çš„ç”¨ä¾‹æä¾›äº†é«˜çº§åŠŸèƒ½ã€‚å®ƒåŸºäºæ’ä»¶ä½“ç³»ç»“æ„ï¼Œå…·æœ‰ä½¿ç”¨å„ç§æ–¹æ³•å’ŒæŠ€æœ¯æ”¶é›†åº¦é‡æ ‡å‡†æ•°æ®çš„èƒ½åŠ›ã€‚æˆ‘ä»¬ç›¸ä¿¡å®ƒæ˜¯å¸‚åœºä¸Šæœ€å…ˆè¿›çš„ç›‘æ§ä»£ç†ã€‚ å®‰å…¨æ€§æ–¹é¢çš„é‡å¤§æ”¹è¿›ï¼šæ–°çš„æ”¹è¿›ç¡®ä¿æ‰€æœ‰Zabbixç»„ä»¶ä»¥å®‰å…¨çš„æ–¹å¼è¿›è¡Œé€šä¿¡ï¼Œå¹¶ä¸”è¿˜ä½¿ç”¨å®‰å…¨åè®®è¿›è¡Œå‡ºç«™é€šä¿¡ï¼Œè€Œä¸ä¼šä»¥ä»»ä½•æ–¹å¼å½±å“æ€§èƒ½ã€‚å¯¹äºåœ¨é«˜åº¦æ•æ„Ÿçš„ç¯å¢ƒä¸­ä½¿ç”¨Zabbixçš„ç”¨æˆ·è€Œè¨€ï¼Œå¯é…ç½®çš„å¯†ç ä»¥åŠä¸ºåº¦é‡å®šä¹‰é»‘åå•å’Œç™½åå•çš„èƒ½åŠ›è‡³å…³é‡è¦ã€‚ TimescaleDBçš„å‹ç¼©ï¼šæ—¶é—´åºåˆ—æ•°æ®å‹ç¼©æœ‰åŠ©äºæé«˜æ€§èƒ½å’Œæ•ˆç‡ï¼ŒåŒæ—¶é™ä½è¿è¥æˆæœ¬ã€‚ å¯ç”¨æ€§æ”¹è¿›ï¼šæ–°ç‰ˆæœ¬é’ˆå¯¹å®½å±è¿›è¡Œäº†ä¼˜åŒ–ï¼Œé™¤äº†Zabbix UIçš„å…¶ä»–å¢å¼ºåŠŸèƒ½ä¹‹å¤–ï¼Œè¿˜å¼•å…¥äº†å¯¹ç¬¬ä¸‰æ–¹UIæ¨¡å—çš„æ”¯æŒã€‚\nZabbix 5.0æ˜¯å…·æœ‰5å¹´å®˜æ–¹æ”¯æŒçš„LTSï¼ˆé•¿æœŸæ”¯æŒï¼‰ç‰ˆæœ¬ã€‚å®ƒç»“åˆäº†åˆ›æ–°å’Œç¨³å®šæ€§ï¼Œå¹¶åŒ…æ‹¬ç»è¿‡æ—¶é—´æ£€éªŒçš„åŠŸèƒ½ï¼Œè¿™äº›åŠŸèƒ½å·²åœ¨Zabbix 4.2å’Œ4.4çš„éLTSç‰ˆæœ¬ä¸­å¼•å…¥ï¼Œè¿™ä½¿å…¶æˆä¸ºå¤§å‹ä¼ä¸šç¯å¢ƒçš„ç†æƒ³é€‰æ‹©ã€‚ ç¡¬ä»¶é…ç½®éœ€æ±‚ å‚è€ƒ zabbix 5.0 ä¸­æ–‡æ‰‹å†Œ\nç¯å¢ƒ å¹³å° CPU/å†…å­˜ æ•°æ®åº“ ç¡¬ç›˜ ç›‘æ§ä¸»æœºæ•° å°å‹ centOS 2CPU/1GB MySQLã€InnoDB æ™®é€š 100 ä¸­å‹ centOS 2CPU/2GB MySQLã€InnoDB æ™®é€š 500 å¤§å‹ Red HatEnterpirse Linux 4CPU/8GB MySQLã€InnoDB æˆ–PostgreSQL RAID 10 æˆ– SSD å¤§äº1000 è¶…å¤§å‹ Red HatEnterpirse Linux 8CPU/16GB MySQLã€InnoDB æˆ–PostgreSQL RAID 10 æˆ– SSD å¤§äº10000 å‰ç«¯è½¯ä»¶éœ€æ±‚ å‚è€ƒ zabbix 5.0 ä¸­æ–‡æ‰‹å†Œ\nZabbix å‰ç«¯éœ€è¦ä½¿ç”¨ä¸‹åˆ—è½¯ä»¶:\nè½¯ä»¶ ç‰ˆæœ¬ å¤‡æ³¨ Apache 1.3.12 æˆ–ä»¥ä¸Š PHP 5.4.0 æˆ–ä»¥ä¸Š PHP æ‰©å±•åº“ï¼š\nè½¯ä»¶ ç‰ˆæœ¬ å¤‡æ³¨ gd 2.0 or later PHP GD æ‰©å±•åº“å¿…é¡»æ”¯æŒ PNG å›¾åƒ(\u0026ndash;with-png-dir)ã€JPEG å›¾åƒ (\u0026ndash;with-jpeg-dir) å’Œ FreeType 2 (\u0026ndash;with-freetype-dir). bcmath php-bcmath (\u0026ndash;enable-bcmath) ctype php-ctype (\u0026ndash;enable-ctype) libXML 2.6.15 æˆ–ä»¥ä¸Š php-xml or php5-domï¼Œå¦‚æœå‘å¸ƒè€…æä¾›ç‹¬ç«‹çš„éƒ¨ç½²åŒ…ã€‚ xmlreader php-xmlreaderï¼Œå¦‚æœå‘å¸ƒè€…æä¾›ç‹¬ç«‹çš„éƒ¨ç½²åŒ…ã€‚ xmlwriter php-xmlwriterï¼Œå¦‚æœå‘å¸ƒè€…æä¾›ç‹¬ç«‹çš„éƒ¨ç½²åŒ…ã€‚ session php-sessionï¼Œå¦‚æœå‘å¸ƒè€…æä¾›ç‹¬ç«‹çš„éƒ¨ç½²åŒ…ã€‚ sockets php-net-socket (\u0026ndash;enable-sockets) ã€‚ç”¨æˆ·è„šæœ¬æ”¯æŒæ‰€éœ€è¦çš„ç»„ä»¶ã€‚ mbstring php-mbstring (\u0026ndash;enable-mbstring) gettext php-gettext (\u0026ndash;with-gettext)ã€‚ç”¨äºå¤šè¯­è¨€ç¿»è¯‘æ”¯æŒã€‚ ldap php-ldapã€‚åªæœ‰åœ¨å‰ç«¯ä½¿ç”¨ LDAP è®¤è¯æ—¶æ‰éœ€è¦ã€‚ ibm_db2 ä½¿ç”¨ IBM DB2 ä½œä¸º Zabbix åç«¯æ•°æ®åº“æ‰€éœ€è¦çš„ç»„ä»¶ã€‚ mysqli ä½¿ç”¨ MySQL ä½œä¸º Zabbix åç«¯æ•°æ®åº“æ‰€éœ€è¦çš„ç»„ä»¶ã€‚ oci8 ä½¿ç”¨ Oracle ä½œä¸º Zabbix åç«¯æ•°æ®åº“æ‰€éœ€è¦çš„ç»„ä»¶ã€‚ pgsql ä½¿ç”¨ PostgreSQL ä½œä¸º Zabbix åç«¯æ•°æ®åº“æ‰€éœ€è¦çš„ç»„ä»¶ã€‚ ç¯å¢ƒå‡†å¤‡ 1 2 3 4 5 6 CentOS Linux release 7.9.2009 (Core) nginx 1.16.1 zabbix-server 5.0.14 zabbix-agent 5.0.14 MariaDB 5.5.68 PHP 7.4.22 å…³é—­é˜²ç«å¢™åŠselinux 1 2 systemctl stop firewalld \u0026amp;\u0026amp; systemctl disable firewalld sed -i \u0026#39;s/SELINUX=enforcing/SELINUX=disabled/g\u0026#39; /etc/selinux/config ä¿®æ”¹é˜¿é‡Œäº‘yumæº å‚è€ƒé“¾æ¥\n1 2 3 4 5 6 7 8 9 # å¤‡ä»½ mv /etc/yum.repos.d/CentOS-Base.repo /etc/yum.repos.d/CentOS-Base.repo.backup # ä¸‹è½½æ–°çš„CentOS-Base.repo curl -o /etc/yum.repos.d/CentOS-Base.repo http://mirrors.aliyun.com/repo/Centos-7.repo # æ·»åŠ EPEL wget -O /etc/yum.repos.d/epel.repo http://mirrors.aliyun.com/repo/epel-7.repo # æ¸…ç†ç¼“å­˜å¹¶ç”Ÿæˆæ–°çš„ç¼“å­˜ yum clean all yum makecache PHP 7.4 å®‰è£…é…ç½® æ·»åŠ æº 1 2 yum install epel-release -y rpm -ivh http://rpms.famillecollet.com/enterprise/remi-release-7.rpm å®‰è£…PHP 1 yum --enablerepo=remi install php74-php -y å®‰è£…ä½ æ‰€éœ€è¦phpæ‰©å±•æ¨¡å— 1 yum --disablerepo=\u0026#34;*\u0026#34; --enablerepo=\u0026#34;centos-sclo-rh\u0026#34; install rh-php72-php-gd rh-php72-php-bcmath rh-php72-php-mbstring rh-php72-php-mysqlnd rh-php72-php-xml rh-nginx116-nginx rh-php72 rh-php72-php-fpm rh-php72-php-ldap -y å®‰è£…å…¶ä»–ä¾èµ– å®‰è£…zabbixæŠ¥é”™ï¼Œæç¤ºRequires: libiksemel.so.3()(64bit)ï¼Œè¯¥æ–‡ä»¶ä¸ºå†…æ ¸é“¾æ¥æ–‡ä»¶ï¼Œæ— æ³•ç»•è¿‡åªæœ‰è§£å†³äº†è¿™ä¸ªä¾èµ–æ‰å¯èƒ½ç»§ç»­å®‰è£…ï¼Œè§£å†³çš„æ–¹æ³•ä¸ºç¼ºä»€ä¹ˆè¡¥ä»€ä¹ˆï¼Œå®ƒè¦è¿™ä¸ªå°±ç»™å®ƒã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 # æç¤º éœ€è¦ï¼šRequires: libiksemel.so.3()(64bit) wget http://springdale.math.ias.edu/data/puias/unsupported/7/x86_64//iksemel-1.4-6.sdl7.x86_64.rpm yum install iksemel-1.4-6.sdl7.x86_64.rpm -y # æç¤º éœ€è¦ï¼šlibwebp.so.4()(64bit) wget http://vault.centos.org/7.9.2009/os/Source/SPackages/libwebp-0.3.0-7.el7.src.rpm yum install libwebp -y # æç¤º éœ€è¦ï¼šlibjpeg.so.62()(64bit) wget http://vault.centos.org/7.9.2009/os/Source/SPackages/libjpeg-turbo-1.2.90-8.el7.src.rpm yum install libjpeg-turbo -y # æç¤º éœ€è¦ï¼šlibXpm.so.4()(64bit) wget http://vault.centos.org/7.9.2009/os/Source/SPackages/libXpm-3.5.12-1.el7.src.rpm yum install libXpm -y # æç¤º éœ€è¦ï¼šgd wget http://vault.centos.org/7.9.2009/updates/Source/SPackages/gd-2.0.35-27.el7_9.src.rpm yum install gd -y ä¿®æ”¹é…ç½®æ–‡ä»¶ 1 2 3 4 5 6 sed -i \u0026#34;s#max_execution_time = 30#max_execution_time = 600#g\u0026#34; /etc/php.ini sed -i \u0026#34;s#max_input_time = 60#max_input_time = 600#g\u0026#34; /etc/php.ini sed -i \u0026#34;s#memory_limit = 128M#memory_limit = 256M#g\u0026#34; /etc/php.ini sed -i \u0026#34;s#post_max_size = 8M#post_max_size = 32M#g\u0026#34; /etc/php.ini sed -i \u0026#34;s#upload_max_filesize = 2M#upload_max_filesize = 16M#g\u0026#34; /etc/php.ini sed -i \u0026#34;s/;date.timezone =/date.timezone = Asia\\/Shanghai/g\u0026#34; /etc/php.ini è¿è¡Œå¹¶æŸ¥çœ‹ç‰ˆæœ¬ï¼Œ é‡å¯å‘½ä»¤ï¼Œ æ·»åŠ è‡ªåŠ¨å¯åŠ¨ï¼Œé“¾æ¥phpæ–‡ä»¶ 1 2 3 4 5 6 7 8 9 10 #è¿è¡Œå¹¶æŸ¥çœ‹ç‰ˆæœ¬ php74 -v #é‡å¯å‘½ä»¤php-fpm systemctl restart php74-php-fpm #æ·»åŠ è‡ªåŠ¨å¯åŠ¨ systemctl enable php74-php-fpm #æŸ¥çœ‹php7.4çš„å®‰è£…è·¯å¾„ whereis php #é“¾æ¥phpæ–‡ä»¶ ln -s /opt/remi/php74/root/usr/bin/php /usr/bin/php å®‰è£…å…¶ä»–ä¾èµ– å®‰è£…zabbixæŠ¥é”™ï¼Œæç¤ºRequires: libiksemel.so.3()(64bit)ï¼Œè¯¥æ–‡ä»¶ä¸ºå†…æ ¸é“¾æ¥æ–‡ä»¶ï¼Œæ— æ³•ç»•è¿‡åªæœ‰è§£å†³äº†è¿™ä¸ªä¾èµ–æ‰å¯èƒ½ç»§ç»­å®‰è£…ï¼Œè§£å†³çš„æ–¹æ³•ä¸ºç¼ºä»€ä¹ˆè¡¥ä»€ä¹ˆï¼Œå®ƒè¦è¿™ä¸ªå°±ç»™å®ƒã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 # æç¤º éœ€è¦ï¼šRequires: libiksemel.so.3()(64bit) wget http://springdale.math.ias.edu/data/puias/unsupported/7/x86_64//iksemel-1.4-6.sdl7.x86_64.rpm yum install iksemel-1.4-6.sdl7.x86_64.rpm -y # æç¤º éœ€è¦ï¼šlibwebp.so.4()(64bit) wget http://vault.centos.org/7.9.2009/os/Source/SPackages/libwebp-0.3.0-7.el7.src.rpm yum install libwebp -y # æç¤º éœ€è¦ï¼šlibjpeg.so.62()(64bit) wget http://vault.centos.org/7.9.2009/os/Source/SPackages/libjpeg-turbo-1.2.90-8.el7.src.rpm yum install libjpeg-turbo -y # æç¤º éœ€è¦ï¼šlibXpm.so.4()(64bit) wget http://vault.centos.org/7.9.2009/os/Source/SPackages/libXpm-3.5.12-1.el7.src.rpm yum install libXpm -y # æç¤º éœ€è¦ï¼šgd wget http://vault.centos.org/7.9.2009/updates/Source/SPackages/gd-2.0.35-27.el7_9.src.rpm yum install gd -y zabbix æœåŠ¡å®‰è£… å®‰è£… Zabbix å­˜å‚¨åº“ 1 rpm -Uvh https://repo.zabbix.com/zabbix/5.0/rhel/7/x86_64/zabbix-release-5.0-1.el7.noarch.rpm å®‰è£… Zabbix æœåŠ¡å™¨å’Œä»£ç† 1 yum install zabbix-server-mysql zabbix-agent -y å®‰è£… zabbix å‰ç«¯ 1 2 yum -y install yum-utils yum-config-manager --enable rhel-server-rhscl-7-rpms -y ç¼–è¾‘é…ç½®æ–‡ä»¶ ç¼–è¾‘é…ç½®æ–‡ä»¶ /etc/yum.repos.d/zabbix.repo å¹¶å¯ç”¨Zabbix å‰ç«¯å­˜å‚¨åº“\n1 2 3 4 5 vi /etc/yum.repos.d/zabbix.repo [zabbix-frontend] ... enabled=1 ... å®‰è£…å‰ç«¯æ‰€éœ€è½¯ä»¶ 1 yum install zabbix-web-mysql-scl zabbix-nginx-conf-scl -y æ•°æ®åº“å®‰è£…é…ç½® å®‰è£…æ•°æ®åº“ 1 yum install -y mariadb-server mariadb å¯åŠ¨æœåŠ¡ 1 systemctl start mariadb è®¾ç½®æœåŠ¡å¼€å¯è‡ªå¯åŠ¨ 1 systemctl enable mariadb ç™»å½•æ•°æ®åº“ 1 2 3 4 mysql -uroot -p ä¿®æ”¹é»˜è®¤å¯†ç  mysql\u0026gt; SET PASSWORD = PASSWORD(\u0026#39;cnsre.cn\u0026#39;); #cnsre.cnæ˜¯ä½ çš„æ–°å¯†ç  å¦‚ä½•è§£å†³ERROR 1819 (HY000): Your password does not satisfy the current policy requirementså‘¢ï¼Ÿ\n1 2 3 4 5 6 7 8 # ä¿®æ”¹validate_password_policyå‚æ•°çš„å€¼ set global validate_password_policy=0; # å†ä¿®æ”¹å¯†ç çš„é•¿åº¦ set global validate_password_length=1; # å†æ¬¡æ‰§è¡Œä¿®æ”¹å¯†ç å°±å¯ä»¥äº† ALTER USER \u0026#39;root\u0026#39;@\u0026#39;localhost\u0026#39; IDENTIFIED BY \u0026#39;cnsre.cn\u0026#39;; # å…è®¸rootè¿œç¨‹ç™»é™† GRANT ALL PRIVILEGES ON *.* TO \u0026#39;root\u0026#39;@\u0026#39;%\u0026#39; IDENTIFIED BY \u0026#39;cnsre.cn\u0026#39; WITH GRANT OPTION; åˆ›å»ºåˆå§‹æ•°æ®åº“ åœ¨æ•°æ®åº“ä¸»æœºä¸Šè¿è¡Œä»¥ä¸‹ä»£ç \n1 2 3 4 5 6 7 # mysql -uroot -p password mysql\u0026gt; create database zabbix character set utf8 collate utf8_bin; mysql\u0026gt; create user zabbix@localhost identified by \u0026#39;password\u0026#39;; mysql\u0026gt; grant all privileges on zabbix.* to zabbix@localhost; mysql\u0026gt; flush privileges; mysql\u0026gt; quit; å¯¼å…¥æ¨¡æ¿æ•°æ® å¯¼å…¥åˆå§‹æ¶æ„å’Œæ•°æ®\næ–¹æ³•1\n1 zcat /usr/share/doc/zabbix-server-mysql*/create.sql.gz | mysql -uroot -p æ–¹æ³•2\n1 2 3 4 5 6 # åˆ‡æ¢åˆ° create.sql.gz ç›®å½• æˆ‘çš„ç›®å½•å¦‚ä¸‹ cd /usr/share/doc/zabbix-server-mysql-5.0.14 gzip -d create.sql.gz mysql -uroot -p mysql\u0026gt; use zabbix; mysql\u0026gt; source /usr/usr/share/doc/zabbix-server-mysql-5.0.14/create.sql é…ç½®Zabbix-server 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 mv /etc/zabbix/zabbix_server.conf /etc/zabbix/zabbix_server.conf.bak vim /etc/zabbix/zabbix_server.conf LogFile=/var/log/zabbix/zabbix_server.log LogFileSize=0 PidFile=/var/run/zabbix/zabbix_server.pid SocketDir=/var/run/zabbix DBHost=localhost DBName=zabbix DBUser=zabbix DBPassword=zabbix DBPort=3306 SNMPTrapperFile=/var/log/snmptrap/snmptrap.log CacheSize=1024M Timeout=4 AlertScriptsPath=/usr/lib/zabbix/alertscripts ExternalScripts=/usr/lib/zabbix/externalscripts LogSlowQueries=3000 é…ç½®zabbix-agent 1 2 3 4 5 6 7 8 9 10 11 mv /etc/zabbix/zabbix_agent.conf /etc/zabbix/zabbix_agent.conf.bak vim /etc/zabbix/zabbix_agentd.conf PidFile=/var/run/zabbix/zabbix_agentd.pid LogFile=/var/log/zabbix/zabbix_agentd.log LogFileSize=0 Server= ListenPort=10050 ServerActive= Hostname= Include=/etc/zabbix/zabbix_agentd.d/ nginx å®‰è£…é…ç½® ä¸º Zabbix å‰ç«¯é…ç½® PHP ç¼–è¾‘æ–‡ä»¶ /etc/opt/rh/rh-nginx116/nginx/conf.d/zabbix.confï¼Œå–æ¶ˆæ³¨é‡Šå’Œè®¾ç½® listen å’Œ server_name æŒ‡ä»¤ã€‚\n# listen 80; # server_name example.com; ç¼–è¾‘æ–‡ä»¶ /etc/opt/rh/rh-php72/php-fpm.d/zabbix.conf ï¼Œå°† nginx æ·»åŠ åˆ° listen.acl_users æŒ‡ä»¤ã€‚\nlisten.acl_users = apache,nginx ç„¶åå–æ¶ˆæ³¨é‡Šå¹¶ä¸ºè®¾ç½®æ­£ç¡®çš„æ—¶åŒºã€‚\nphp_value[date.timezone] = Asia/Shanghai å¯åŠ¨æ‰€æœ‰æœåŠ¡ 1 2 3 systemctl restart zabbix-server zabbix-agent rh-nginx116-nginx rh-php72-php-fpm systemctl enable zabbix-server zabbix-agent rh-nginx116-nginx rh-php72-php-fpm systemctl status zabbix-server zabbix-agent rh-nginx116-nginx rh-php72-php-fpm æ£€æŸ¥ç«¯å£\n1 2 3 4 5 6 7 8 9 10 11 12 13 [root@localhost ~]# netstat -pntl Active Internet connections (only servers) Proto Recv-Q Send-Q Local Address Foreign Address State PID/Program name tcp 0 0 0.0.0.0:80 0.0.0.0:* LISTEN 18862/nginx: master tcp 0 0 0.0.0.0:22 0.0.0.0:* LISTEN 968/sshd tcp 0 0 127.0.0.1:25 0.0.0.0:* LISTEN 1258/master tcp 0 0 0.0.0.0:10050 0.0.0.0:* LISTEN 18816/zabbix_agentd tcp 0 0 127.0.0.1:9000 0.0.0.0:* LISTEN 18813/php-fpm: mast tcp 0 0 0.0.0.0:3306 0.0.0.0:* LISTEN 18700/mysqld tcp6 0 0 :::80 :::* LISTEN 18862/nginx: master tcp6 0 0 :::22 :::* LISTEN 968/sshd tcp6 0 0 ::1:25 :::* LISTEN 1258/master tcp6 0 0 :::10050 :::* LISTEN 18816/zabbix_agentd è®¿é—®é…ç½® zabbix å‰ç«¯ è¿æ¥åˆ°æ–°å®‰è£…çš„Zabbixå‰ç«¯ï¼š http://server_ip\nâš ï¸ å¦‚æœæ‰“å¼€é¡µé¢è®¿é—®ä¸åˆ° zabbix é¡µé¢ï¼Œå°† /etc/opt/rh/rh-nginx116/nginx/nginx.conf é…ç½®æ–‡ä»¶ä¸­çš„ server æ¨¡å—æ³¨é‡Šæ‰é‡å¯å³å¯\né»˜è®¤çš„ç”¨æˆ· Admin/zabbix\nå¥½äº†ï¼Œåˆ°è¿™é‡Œï¼Œæˆ‘ä»¬å°±å·²ç»å®Œæˆäº†Zabbix 5.0 LTS çš„å®‰è£…,å¿«å»ä½“éªŒå§ã€‚\nä½œè€…ï¼šSREè¿ç»´åšå®¢\nåšå®¢åœ°å€ï¼šhttps://www.cnsre.cn\næ–‡ç« åœ°å€ï¼šhttps://www.cnsre.cn/posts/210824854115/\nç›¸å…³è¯é¢˜ï¼šhttps://www.cnsre.cn/tags/zabbix/\n","description":"zabbix LNMP Zabbix 5.0æ˜¯å…·æœ‰5å¹´å®˜æ–¹æ”¯æŒçš„LTSï¼ˆé•¿æœŸæ”¯æŒï¼‰ç‰ˆæœ¬ï¼Œæœ¬æ–‡å°†ä»‹ç»zabbix 5.0 é•¿æœŸæ”¯æŒç‰ˆçš„ LNMP æ­å»ºéƒ¨ç½²ã€‚","id":47,"section":"posts","tags":["zabbix","lnmp"],"title":"LNMP æ–¹å¼éƒ¨ç½² zabbix 5.0","uri":"http://www.cnsre.cn:80/posts/210824854115/"},{"content":" ä½œè€…ï¼šSREè¿ç»´åšå®¢\nåšå®¢åœ°å€ï¼šhttps://www.cnsre.cn\næ–‡ç« åœ°å€ï¼šhttps://www.cnsre.cn/posts/210823049577/\nç›¸å…³è¯é¢˜ï¼šhttps://www.cnsre.cn/tags/æ•…éšœé›†/\næ•…éšœè¡¨ç° åœ¨ä½¿ç”¨ jumperver ç™»å½• AWS ec2 å®ä¾‹çš„æ—¶å€™å‘ç° ssh é…åˆç§˜é’¥ç™»å½•çš„æ—¶å€™æ— æ³•ç™»å½•ï¼Œ\nå…·ä½“æŠ¥é”™å¦‚ä¸‹ï¼š\nssh -i /path/xx.pem user@10.0.11.190 Permission denied (publickey,gssapi-keyex,gssapi-with-mic). é—®é¢˜æ’æŸ¥è¿‡ç¨‹ åœ¨å‘ç°æ— æ³•ç™»å½•çš„ç¬¬ä¸€æ—¶é—´ç­‰äº†AWS å¹³å°æŸ¥çœ‹åº•å±‚ç›‘æ§æ˜¯å¦æ­£å¸¸\næŸ¥çœ‹åˆ°åº•å±‚ç¡¬ä»¶å·¥ä½œæ­£å¸¸ï¼Œå¹¶æ²¡æœ‰è§‚å¯Ÿåˆ°å¼‚å¸¸æŠ¥é”™ã€‚\né€šè¿‡æŸ¥çœ‹ä¸šåŠ¡æœåŠ¡ï¼Œå‘ç°ä¸šåŠ¡æœåŠ¡å¹¶æ²¡æœ‰æ”¶åˆ°å½±å“ã€‚\né‚£å°±è¯´æ˜ï¼ŒæœåŠ¡å™¨æ˜¯æ²¡æœ‰é—®é¢˜çš„ï¼Œåªæ˜¯ç™»å½•è®¤è¯å‡ºäº†é—®é¢˜ã€‚æ—¢ç„¶æœåŠ¡æ²¡æœ‰é—®é¢˜ï¼Œæ¥ä¸‹æ¥å°±æ…¢æ…¢æ’æŸ¥å°±ï¼Œå°±ä¸ç€æ€¥äº†ã€‚\næ¥ç€ï¼Œå°è¯•ç”¨ aws çš„ ssm (Amazon Systems Manager)å°è¯•ç™»å½•ï¼Œå‘ç°èƒ½å¤Ÿä½¿ç”¨ ssm ç™»å½•ã€‚\nå†æ¬¡å›åˆ°è·³æ¿æœºï¼Œè¿è¡Œ telnet 10.0.11.190 22 ç«¯å£æ˜¯é€šçš„ã€‚æ’é™¤ç½‘ç»œç«¯å£é—®é¢˜ã€‚\næŸ¥çœ‹ ssh ç™»å½•æ—¥å¿—\n1 ssh -i /path/xx.pem user@10.0.11.190 -vvv æŸ¥çœ‹ secure æ—¥å¿—\n1 tail -f /var/log/secure é—®é¢˜è§£å†³ ç»è¿‡æŸ¥çœ‹æ—¥å¿—ï¼Œæ€»ç»“å¦‚ä¸‹:\n1 å½“å‰æ˜¯ä»è·³æ¿æœºï¼Œä»¥sshçš„æ–¹å¼è¿æ¥åˆ°æ•…éšœä¸»æœºï¼Œä½†æ˜¯åœ¨è¿æ¥è¿‡ç¨‹ä¸­é‡åˆ°å¦‚ä¸‹æ‰€ç¤ºæŠ¥é”™ï¼š\n1 Permission denied (publickey,gssapi-keyex,gssapi-with-mic). ä»ssh -vvvçš„debugæ—¥å¿—æ¥çœ‹ï¼Œssh clientç«¯å‘é€äº†è®¤è¯è¯·æ±‚ï¼Œä½†æ˜¯ssh serverç«¯å¹¶æ²¡æœ‰å®Œæˆè®¤è¯è¿‡ç¨‹ï¼Œå¯¼è‡´permission deniedæŠ¥é”™äº§ç”Ÿã€‚\n2 æ•…éšœä¸»æœºé…ç½®äº†SSM agentï¼Œå¹¶ä¸”å¯ä»¥é€šè¿‡session manageræ‰“å¼€ã€‚\nåœ¨è¿™ä¸ªåŸºç¡€ä¸Šï¼Œåœ¨å®ä¾‹çš„/var/log/secureæ–‡ä»¶ä¸­çœ‹åˆ°å¦‚ä¸‹æŠ¥é”™å†…å®¹ï¼š\n1 authentication refused: bad ownership or modes for directory /home/ec2-user/ è¿™ä¸ªæŠ¥é”™çš„æ„æ€æ˜¯è¯´ï¼Œ/home/ec2-user/ ç›®å½•çš„owneræˆ–è€…modeå­˜åœ¨ä¸€äº›é—®é¢˜ã€‚\nç»è¿‡æŸ¥çœ‹ï¼Œ/home/ec2-user/ ç›®å½•é…ç½®çš„æ˜¯777çš„æƒé™ï¼Œè¿›è€Œå¯¼è‡´çš„è®¤è¯å¤±è´¥ã€‚\nå°†å…¶ä¿®æ”¹ä¸º700åï¼Œé—®é¢˜å¾—åˆ°è§£å†³ï¼Œå¯ä»¥sshç™»å½•åˆ°æ•…éšœä¸»æœºã€‚\nä¸ºä»€ä¹ˆä¼šæœ‰777çš„æƒé™å‘¢ï¼Ÿ ä¸ºä½•ä¼šå°† /home/ec2-user/ ç›®å½•ä¸‹æ‰€æœ‰å†…å®¹ä¿®æ”¹ä¸º 777 å‘¢ï¼Ÿ\nç»è¿‡ç™»å½• Jumoserver çš„å®¡è®¡å‘ç°ï¼Œä¸€åå¼€å‘äººå‘˜å°† /home/ec2-user/ æƒé™æ”¹ä¸ºäº† 777 åŸå› æ˜¯é€šè¿‡ Jumpserver ä¸Šä¼ æ–‡ä»¶çš„æ—¶å€™æ²¡æœ‰æƒé™ï¼Œç„¶åå¼€å‘å°±è‡ªå·±å°†ç›®å½•ç»™äº† 777çš„æƒé™ã€‚\nä½œè€…ï¼šSREè¿ç»´åšå®¢\nåšå®¢åœ°å€ï¼šhttps://www.cnsre.cn\næ–‡ç« åœ°å€ï¼šhttps://www.cnsre.cn/posts/210823049577/\nç›¸å…³è¯é¢˜ï¼šhttps://www.cnsre.cn/tags/æ•…éšœé›†/\n","description":"ssh ç§˜é’¥ç™»å½•å¤±è´¥ï¼ŒæŠ¥é”™ Permission denied ??","id":48,"section":"posts","tags":["aws"],"title":"AWS EC2 å®ä¾‹ SSH æ— æ³•ç™»å½•æ•…éšœ","uri":"http://www.cnsre.cn:80/posts/210823049577/"},{"content":" ä½œè€…ï¼šSREè¿ç»´åšå®¢\nåšå®¢åœ°å€ï¼šhttps://www.cnsre.cn\næ–‡ç« åœ°å€ï¼šhttps://www.cnsre.cn/posts/210819955387/\nç›¸å…³è¯é¢˜ï¼šhttps://www.cnsre.cn/tags/kubernetes/\næŸ¥çœ‹èŠ‚ç‚¹çŠ¶æ€å¤±è´¥ 1 Error from server (NotFound): the server could not find the requested resource (get services http:heapster:) åŸå› åˆ†æï¼šæ²¡æœ‰heapsteræœåŠ¡ã€‚ è§£å†³æ–¹æ³•ï¼šå®‰è£…promethusç›‘æ§ç»„ä»¶å³å¯ã€‚\nK8S é›†ç¾¤æœåŠ¡è®¿é—®å¤±è´¥ æ¡ˆä¾‹ 1 1 2 3 4 5 6 7 8 9 10 11 12 13 14 curl: (60) Peer\u0026#39;s Certificate issuer is not recognized. More details here: http://curl.haxx.se/docs/sslcerts.html curl performs SSL certificate verification by default, using a \u0026#34;bundle\u0026#34; of Certificate Authority (CA) public keys (CA certs). If the default bundle file isn\u0026#39;t adequate, you can specify an alternate file using the --cacert option. If this HTTPS server uses a certificate signed by a CA represented in the bundle, the certificate verification probably failed due to a problem with the certificate (it might be expired, or the name might not match the domain name in the URL). If you\u0026#39;d like to turn off curl\u0026#39;s verification of the certificate, use the -k (or --insecure) option. åŸå› åˆ†æï¼šè¯ä¹¦ä¸èƒ½è¢«è¯†åˆ«ï¼Œå…¶åŸå› ä¸ºï¼šè‡ªå®šä¹‰è¯ä¹¦ï¼Œè¿‡æœŸç­‰ã€‚ è§£å†³æ–¹æ³•ï¼šæ›´æ–°è¯ä¹¦å³å¯ã€‚ æ¡ˆä¾‹ 2 1 curl: (7) Failed connect to 10.103.22.158:3000; Connection refused åŸå› åˆ†æï¼šç«¯å£æ˜ å°„é”™è¯¯ï¼ŒæœåŠ¡æ­£å¸¸å·¥ä½œï¼Œä½†ä¸èƒ½æä¾›æœåŠ¡ã€‚ è§£å†³æ–¹æ³•ï¼šåˆ é™¤svcï¼Œé‡æ–°æ˜ å°„ç«¯å£å³å¯ã€‚ 1 kubectl delete svc nginx-deployment K8S é›†ç¾¤æœåŠ¡æš´éœ²å¤±è´¥ 1 Error from server (AlreadyExists): services \u0026#34;nginx-deployment\u0026#34; already exists åŸå› åˆ†æï¼šè¯¥å®¹å™¨å·²æš´éœ²æœåŠ¡äº†ã€‚ è§£å†³æ–¹æ³•ï¼šåˆ é™¤svcï¼Œé‡æ–°æ˜ å°„ç«¯å£å³å¯ã€‚ å¤–ç½‘æ— æ³•è®¿é—® K8S é›†ç¾¤æä¾›çš„æœåŠ¡ åŸå› åˆ†æï¼šK8Sé›†ç¾¤çš„typeä¸ºClusterIPï¼Œæœªå°†æœåŠ¡æš´éœ²è‡³å¤–ç½‘ã€‚\nè§£å†³æ–¹æ³•ï¼šä¿®æ”¹K8Sé›†ç¾¤çš„typeä¸ºNodePortå³å¯ï¼Œäºæ˜¯å¯é€šè¿‡æ‰€æœ‰K8Sé›†ç¾¤èŠ‚ç‚¹è®¿é—®æœåŠ¡ã€‚\npod åˆ›å»ºå¤±è´¥ æ¡ˆä¾‹ 1 1 2 3 4 5 6 7 8 9 10 11 readiness-httpget-pod 0/1 Pending 0 0s readiness-httpget-pod 0/1 Pending 0 0s readiness-httpget-pod 0/1 ContainerCreating 0 0s readiness-httpget-pod 0/1 Error 0 2s readiness-httpget-pod 0/1 Error 1 3s readiness-httpget-pod 0/1 CrashLoopBackOff 1 4s readiness-httpget-pod 0/1 Error 2 15s readiness-httpget-pod 0/1 CrashLoopBackOff 2 26s readiness-httpget-pod 0/1 Error 3 37s readiness-httpget-pod 0/1 CrashLoopBackOff 3 52s readiness-httpget-pod 0/1 Error 4 82s åŸå› åˆ†æï¼šé•œåƒé—®é¢˜å¯¼è‡´å®¹å™¨æ— æ³•å¯åŠ¨ã€‚\nè§£å†³æ–¹æ³•ï¼šæ›´æ¢é•œåƒã€‚\næ¡ˆä¾‹ 2 åŸå› åˆ†æï¼šymlæ–‡ä»¶å†…å®¹å‡ºé”™â€”-ä½¿ç”¨ä¸­æ–‡å­—ç¬¦ï¼› è§£å†³æ–¹æ³•ï¼šä¿®æ”¹myregistrykeyå†…å®¹å³å¯ã€‚\npod çš„ ready çŠ¶æ€æœªè¿›å…¥ 1 readiness-httpget-pod 0/1 Running 0 116s åŸå› åˆ†æï¼šPODçš„æ‰§è¡Œå‘½ä»¤å¤±è´¥ï¼Œæ— æ³•è·å–èµ„æºã€‚\nè§£å†³æ–¹æ³•ï¼šè¿›å…¥å®¹å™¨å†…éƒ¨ï¼Œåˆ›å»ºyamlå®šä¹‰çš„èµ„æº\npod çŠ¶æ€ä¸º ErrImagePull 1 rnginx-deployment 0/1 ErrImagePull 0 10s åŸå› åˆ†æï¼šimageæ— æ³•æ‹‰å– è§£å†³æ–¹æ³•ï¼šæ›´æ¢é•œåƒå³å¯ã€‚ pod ä¸€ç›´å¤„äº pending çŠ¶æ€ åŸå› åˆ†æï¼šç”±äºå·²ä½¿ç”¨åŒæ ·é•œåƒå‘å¸ƒäº†podï¼Œå¯¼è‡´æ— èŠ‚ç‚¹å¯è°ƒåº¦ã€‚\nè§£å†³æ–¹æ³•ï¼šåˆ é™¤æ‰€æœ‰podåéƒ¨ç½²podå³å¯ã€‚\næ¢æµ‹å­˜æ´» pod çŠ¶æ€ä¸º CrashLoopBackOff åŸå› åˆ†æï¼šé•œåƒé—®é¢˜ï¼Œå¯¼è‡´å®¹å™¨é‡å¯å¤±è´¥ã€‚\nè§£å†³æ–¹æ³•ï¼šæ›´æ¢é•œåƒå³å¯ã€‚\nåˆ›å»ºæœåŠ¡ status ä¸º ErrImagePull æ’æŸ¥æ€è·¯ï¼š\n1 kubectl describe pod test-nginx åŸå› åˆ†æï¼šæ‹‰å–é•œåƒåç§°é—®é¢˜ã€‚ è§£å†³æ–¹æ³•ï¼šåˆ é™¤é”™è¯¯podï¼›é‡æ–°æ‹‰å–é•œåƒï¼› 1 kubectl delete pod test-nginx;kubectl run test-nginx --image=10.0.0.81:5000/nginx:alpine åˆ›å»º init Cå®¹å™¨åï¼Œå…¶çŠ¶æ€ä¸æ­£å¸¸ 1 2 NAME READY STATUS RESTARTS AGE myapp-pod 0/1 Init:0/2 0 20s åŸå› åˆ†æï¼šæŸ¥çœ‹æ—¥å¿—å‘ç°ï¼Œpodä¸€ç›´å‡ºäºåˆå§‹åŒ–ä¸­ï¼›ç„¶åæŸ¥çœ‹podè¯¦ç»†ä¿¡æ¯ï¼Œå®šä½podåˆ›å»ºå¤±è´¥çš„åŸå› ä¸ºï¼šåˆå§‹åŒ–å®¹å™¨æœªæ‰§è¡Œå®Œæ¯•ã€‚ 1 Error from server (BadRequest): container \u0026#34;myapp-container\u0026#34; in pod \u0026#34;myapp-pod\u0026#34; is waiting to start: PodInitializing 1 2 3 4 5 6 7 8 9 10 11 12 waiting for myservice Server: 10.96.0.10 Address: 10.96.0.10:53 ** server can\u0026#39;t find myservice.default.svc.cluster.local: NXDOMAIN *** Can\u0026#39;t find myservice.svc.cluster.local: No answer *** Can\u0026#39;t find myservice.cluster.local: No answer *** Can\u0026#39;t find myservice.default.svc.cluster.local: No answer *** Can\u0026#39;t find myservice.svc.cluster.local: No answer *** Can\u0026#39;t find myservice.cluster.local: No answer è§£å†³æ–¹æ³•ï¼šåˆ›å»ºç›¸å…³serviceï¼Œå°†SVCçš„nameå†™å…¥K8Sé›†ç¾¤çš„coreDNSæœåŠ¡å™¨ä¸­ï¼Œäºæ˜¯coreDNSå°±èƒ½å¯¹PODçš„initCå®¹å™¨æ‰§è¡Œè¿‡ç¨‹ä¸­çš„åŸŸåè§£æäº†ã€‚ 1 kubectl apply -f myservice.yaml é˜¿\n1 2 3 4 5 NAME READY STATUS RESTARTS AGE myapp-pod 0/1 Init:1/2 0 27m myapp-pod 0/1 PodInitializing 0 28m myapp-pod 1/1 Running 0 28m åˆ›å»º PV å¤±è´¥ åŸå› åˆ†æï¼špvçš„nameå­—æ®µé‡å¤ã€‚\nè§£å†³æ–¹æ³•ï¼šä¿®æ”¹pvçš„nameå­—æ®µå³å¯ã€‚\npod æ— æ³•æŒ‚è½½ PVC åŸå› åˆ†æï¼špodæ— æ³•æŒ‚è½½PVCã€‚accessModesä¸å¯ä½¿ç”¨çš„PVä¸ä¸€è‡´ï¼Œå¯¼è‡´æ— æ³•æŒ‚è½½PVCï¼Œç”±äºåªèƒ½æŒ‚è½½å¤§äº1Gä¸”accessModesä¸ºRWOçš„PVï¼Œæ•…åªèƒ½æˆåŠŸåˆ›å»º1ä¸ªpodï¼Œç¬¬2ä¸ªpodä¸€è‡´pendingï¼ŒæŒ‰åºåˆ›å»ºæ—¶åˆ™ç¬¬3ä¸ªpodä¸€ç›´æœªè¢«åˆ›å»ºï¼›\nè§£å†³æ–¹æ³•ï¼šä¿®æ”¹ymlæ–‡ä»¶ä¸­accessModesæˆ–PVçš„accessModeså³å¯ã€‚ pod ä½¿ç”¨ PV åï¼Œæ— æ³•è®¿é—®å…¶å†…å®¹ åŸå› åˆ†æï¼šnfså·ä¸­æ²¡æœ‰æ–‡ä»¶æˆ–æƒé™ä¸å¯¹ã€‚\nè§£å†³æ–¹æ³•ï¼šåœ¨nfså·ä¸­åˆ›å»ºæ–‡ä»¶å¹¶æˆäºˆæƒé™ã€‚\nkube-flannel-ds-amd64-ndsf7 æ’ä»¶ pod çš„ status ä¸º Init:0/1 æ’æŸ¥æ€è·¯ï¼škubectl -n kube-system describe pod kube-flannel-ds-amd64-ndsf7 #æŸ¥è¯¢podæè¿°ä¿¡æ¯ï¼›\nåŸå› åˆ†æï¼šk8s-slave1èŠ‚ç‚¹æ‹‰å–é•œåƒå¤±è´¥ã€‚ è§£å†³æ–¹æ³•ï¼šç™»å½•k8s-slave1ï¼Œé‡å¯dockeræœåŠ¡ï¼Œæ‰‹åŠ¨æ‹‰å–é•œåƒã€‚\nk8s-masterèŠ‚ç‚¹ï¼Œé‡æ–°å®‰è£…æ’ä»¶å³å¯ã€‚ 1 kubectl create -f kube-flannel.yml;kubectl get nodes ä¸èƒ½è¿›å…¥æŒ‡å®šå®¹å™¨å†…éƒ¨ åŸå› åˆ†æï¼šymlæ–‡ä»¶comtainerså­—æ®µé‡å¤ï¼Œå¯¼è‡´è¯¥podæ²¡æœ‰è¯¥å®¹å™¨ã€‚ è§£å†³æ–¹æ³•ï¼šå»æ‰ymlæ–‡ä»¶ä¸­å¤šä½™çš„containerså­—æ®µï¼Œé‡æ–°ç”Ÿæˆpodã€‚\nä½œè€…ï¼šSREè¿ç»´åšå®¢\nåšå®¢åœ°å€ï¼šhttps://www.cnsre.cn\næ–‡ç« åœ°å€ï¼šhttps://www.cnsre.cn/posts/210819955387/\nç›¸å…³è¯é¢˜ï¼šhttps://www.cnsre.cn/tags/kubernetes/\n","description":"æ”¶é›†äº†ä¸€äº›å¸¸è§çš„ kubernetes å¸¸è§çš„æ•…éšœï¼Œä»¥åŠè§£å†³ k8s å¸¸è§æ•…éšœçš„ä¸€äº›æ–¹æ³•ã€‚","id":49,"section":"posts","tags":["kubernetes"],"title":"kubernetes å¸¸è§æ•…éšœä»¥åŠè§£å†³æ–¹æ³•","uri":"http://www.cnsre.cn:80/posts/210819955387/"},{"content":" ä½œè€…ï¼šSREè¿ç»´åšå®¢\nåšå®¢åœ°å€ï¼šhttps://www.cnsre.cn\næ–‡ç« åœ°å€ï¼šhttps://www.cnsre.cn/posts/210816936340/\nç›¸å…³è¯é¢˜ï¼šhttps://www.cnsre.cn/tags/nginx/\nlocation è·¯å¾„åŒ¹é… åŒ¹é…è§„åˆ™ location è·¯å¾„æ­£åˆ™åŒ¹é…ï¼š\nç¬¦å· è¯´æ˜ ~ æ­£åˆ™åŒ¹é…ï¼ŒåŒºåˆ†å¤§å°å†™ ~* æ­£åˆ™åŒ¹é…ï¼Œä¸åŒºåˆ†å¤§å°å†™ ^~ æ™®é€šå­—ç¬¦åŒ¹é…ï¼Œå¦‚æœè¯¥é€‰é¡¹åŒ¹é…ï¼Œåˆ™ï¼ŒåªåŒ¹é…æ”¹é€‰é¡¹ï¼Œä¸å†å‘ä¸‹åŒ¹é…å…¶ä»–é€‰é¡¹ = æ™®é€šå­—ç¬¦åŒ¹é…ï¼Œç²¾ç¡®åŒ¹é… @ å®šä¹‰ä¸€ä¸ªå‘½åçš„ locationï¼Œç”¨äºå†…éƒ¨å®šå‘ï¼Œä¾‹å¦‚ error_pageï¼Œtry_files åŒ¹é…ä¼˜å…ˆçº§ è·¯å¾„åŒ¹é…ï¼Œä¼˜å…ˆçº§\nç²¾ç¡®åŒ¹é…ï¼š\n=å‰ç¼€çš„æŒ‡ä»¤ä¸¥æ ¼åŒ¹é…è¿™ä¸ªæŸ¥è¯¢ã€‚\nå¦‚æœæ‰¾åˆ°ï¼Œåœæ­¢æœç´¢ã€‚ æ™®é€šå­—ç¬¦åŒ¹é…ï¼š\næ‰€æœ‰å‰©ä¸‹çš„å¸¸è§„å­—ç¬¦ä¸²ï¼Œæœ€é•¿çš„åŒ¹é…ã€‚\nå¦‚æœè¿™ä¸ªåŒ¹é…ä½¿ç”¨^ã€œå‰ç¼€ï¼Œæœç´¢åœæ­¢ã€‚ æ­£åˆ™åŒ¹é…ï¼š\næ­£åˆ™è¡¨è¾¾å¼ï¼Œåœ¨é…ç½®æ–‡ä»¶ä¸­å®šä¹‰çš„é¡ºåºï¼ŒåŒ¹é…åˆ°ä¸€ä¸ªç»“æœï¼Œæœç´¢åœæ­¢ï¼› é»˜è®¤åŒ¹é…ï¼š\nå¦‚æœç¬¬3æ¡è§„åˆ™äº§ç”ŸåŒ¹é…çš„è¯ï¼Œç»“æœè¢«ä½¿ç”¨ã€‚\nå¦åˆ™ï¼Œå¦‚åŒä»ç¬¬2æ¡è§„åˆ™è¢«ä½¿ç”¨ã€‚ ä¸¾ä¾‹ é€šè¿‡ä¸€ä¸ªå®ä¾‹ï¼Œç®€å•è¯´æ˜ä¸€ä¸‹åŒ¹é…ä¼˜å…ˆçº§ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 location = / { # ç²¾ç¡®åŒ¹é… / ï¼Œä¸»æœºååé¢ä¸èƒ½å¸¦ä»»ä½•å­—ç¬¦ä¸² [ configuration A ] } location / { # å› ä¸ºæ‰€æœ‰çš„åœ°å€éƒ½ä»¥ / å¼€å¤´ï¼Œæ‰€ä»¥è¿™æ¡è§„åˆ™å°†åŒ¹é…åˆ°æ‰€æœ‰è¯·æ±‚ # ä½†æ˜¯æ­£åˆ™å’Œæœ€é•¿å­—ç¬¦ä¸²ä¼šä¼˜å…ˆåŒ¹é… [ configuration B ] } location /documents/ { # åŒ¹é…ä»»ä½•ä»¥ /documents/ å¼€å¤´çš„åœ°å€ï¼ŒåŒ¹é…ç¬¦åˆä»¥åï¼Œè¿˜è¦ç»§ç»­å¾€ä¸‹æœç´¢ # åªæœ‰åé¢çš„æ­£åˆ™è¡¨è¾¾å¼æ²¡æœ‰åŒ¹é…åˆ°æ—¶ï¼Œè¿™ä¸€æ¡æ‰ä¼šé‡‡ç”¨è¿™ä¸€æ¡ [ configuration C ] } location ~ /documents/Abc { # åŒ¹é…ä»»ä½•ä»¥ /documents/ å¼€å¤´çš„åœ°å€ï¼ŒåŒ¹é…ç¬¦åˆä»¥åï¼Œè¿˜è¦ç»§ç»­å¾€ä¸‹æœç´¢ # åªæœ‰åé¢çš„æ­£åˆ™è¡¨è¾¾å¼æ²¡æœ‰åŒ¹é…åˆ°æ—¶ï¼Œè¿™ä¸€æ¡æ‰ä¼šé‡‡ç”¨è¿™ä¸€æ¡ [ configuration CC ] } location ^~ /images/ { # åŒ¹é…ä»»ä½•ä»¥ /images/ å¼€å¤´çš„åœ°å€ï¼ŒåŒ¹é…ç¬¦åˆä»¥åï¼Œåœæ­¢å¾€ä¸‹æœç´¢æ­£åˆ™ï¼Œé‡‡ç”¨è¿™ä¸€æ¡ã€‚ [ configuration D ] } location ~* \\.(gif|jpg|jpeg)$ { # åŒ¹é…æ‰€æœ‰ä»¥ gif,jpgæˆ–jpeg ç»“å°¾çš„è¯·æ±‚ # ç„¶è€Œï¼Œæ‰€æœ‰è¯·æ±‚ /images/ ä¸‹çš„å›¾ç‰‡ä¼šè¢« config D å¤„ç†ï¼Œå› ä¸º ^~ åˆ°è¾¾ä¸äº†è¿™ä¸€æ¡æ­£åˆ™ [ configuration E ] } location /images/ { # å­—ç¬¦åŒ¹é…åˆ° /images/ï¼Œç»§ç»­å¾€ä¸‹ï¼Œä¼šå‘ç° ^~ å­˜åœ¨ [ configuration F ] } location /images/abc { # æœ€é•¿å­—ç¬¦åŒ¹é…åˆ° /images/abcï¼Œç»§ç»­å¾€ä¸‹ï¼Œä¼šå‘ç° ^~ å­˜åœ¨ # Fä¸Gçš„æ”¾ç½®é¡ºåºæ˜¯æ²¡æœ‰å…³ç³»çš„ [ configuration G ] } location ~ /images/abc/ { # åªæœ‰å»æ‰ config D æ‰æœ‰æ•ˆï¼šå…ˆæœ€é•¿åŒ¹é… config G å¼€å¤´çš„åœ°å€ï¼Œç»§ç»­å¾€ä¸‹æœç´¢ï¼ŒåŒ¹é…åˆ°è¿™ä¸€æ¡æ­£åˆ™ï¼Œé‡‡ç”¨ [ configuration H ] } location ~* /js/.*/\\.js æŒ‰ç…§ä¸Šé¢çš„locationå†™æ³•ï¼Œä»¥ä¸‹çš„åŒ¹é…ç¤ºä¾‹æˆç«‹ï¼š\n/ -\u0026gt; config Aï¼š ç²¾ç¡®å®Œå…¨åŒ¹é…ï¼Œå³ä½¿/index.htmlä¹ŸåŒ¹é…ä¸äº†\n/downloads/download.html -\u0026gt; config Bï¼š åŒ¹é…Bä»¥åï¼Œå¾€ä¸‹æ²¡æœ‰ä»»ä½•åŒ¹é…ï¼Œé‡‡ç”¨B\n/images/1.gif -\u0026gt; configuration Dï¼š åŒ¹é…åˆ°Fï¼Œå¾€ä¸‹åŒ¹é…åˆ°Dï¼Œåœæ­¢å¾€ä¸‹\n/images/abc/def -\u0026gt; config Dï¼š æœ€é•¿åŒ¹é…åˆ°Gï¼Œå¾€ä¸‹åŒ¹é…Dï¼Œåœæ­¢å¾€ä¸‹ä½ å¯ä»¥çœ‹åˆ° ä»»ä½•ä»¥/images/å¼€å¤´çš„éƒ½ä¼šåŒ¹é…åˆ°Då¹¶åœæ­¢ï¼ŒFGå†™åœ¨è¿™é‡Œæ˜¯æ²¡æœ‰ä»»ä½•æ„ä¹‰çš„ï¼ŒHæ˜¯æ°¸è¿œè½®ä¸åˆ°çš„ï¼Œè¿™é‡Œåªæ˜¯ä¸ºäº†è¯´æ˜åŒ¹é…é¡ºåº\n/documents/document.html -\u0026gt; config Cï¼š åŒ¹é…åˆ°Cï¼Œå¾€ä¸‹æ²¡æœ‰ä»»ä½•åŒ¹é…ï¼Œé‡‡ç”¨C\n/documents/1.jpg -\u0026gt; configuration Eï¼š åŒ¹é…åˆ°Cï¼Œå¾€ä¸‹æ­£åˆ™åŒ¹é…åˆ°E\n/documents/Abc.jpg -\u0026gt; config CCï¼š æœ€é•¿åŒ¹é…åˆ°Cï¼Œå¾€ä¸‹æ­£åˆ™é¡ºåºåŒ¹é…åˆ°CCï¼Œä¸ä¼šå¾€ä¸‹åˆ°E\nä½œè€…ï¼šSREè¿ç»´åšå®¢\nåšå®¢åœ°å€ï¼šhttps://www.cnsre.cn\næ–‡ç« åœ°å€ï¼šhttps://www.cnsre.cn/posts/210816936340/\nç›¸å…³è¯é¢˜ï¼šhttps://www.cnsre.cn/tags/nginx/\n","description":"nginx åå‘ä»£ç†ï¼Œè·¯å¾„æ˜ å°„çš„è¿‡ç¨‹æ˜¯ä»€ä¹ˆï¼Ÿå¦‚ä½•é…ç½®è·¯å¾„æ˜ å°„è§„åˆ™ï¼Ÿ","id":50,"section":"posts","tags":["nginx"],"title":"Nginx Location è·¯å¾„åŒ¹é…","uri":"http://www.cnsre.cn:80/posts/210816936340/"},{"content":" ä½œè€…ï¼šSREè¿ç»´åšå®¢\nåšå®¢åœ°å€ï¼šhttps://www.cnsre.cn\næ–‡ç« åœ°å€ï¼šhttps://www.cnsre.cn/posts/210811113507/\nç›¸å…³è¯é¢˜ï¼šhttps://www.cnsre.cn/tags/zabbix/\næ—¥å¿—ä¸­èƒ½é€éœ²çš„ä¿¡æ¯å¾ˆå¤šï¼Œä»æ—¥å¿—ä¸­ï¼Œå¯ä»¥çŸ¥é“ç¨‹åºçš„è¿è¡ŒçŠ¶æ€ï¼Œå¯ä»¥çŸ¥é“ç³»ç»Ÿæ˜¯å¦æ­£å¸¸ç­‰ï¼Œä½†æ˜¯å¯¹äºæ—¥å¿—çš„ç›‘æ§å´å¾ˆè®©äººå¤´ç–¼ï¼Œè¦æ˜¯èƒ½ç›‘æ§æ—¥å¿—çš„å˜åŒ–æƒ…å†µï¼Œå°±å¯ä»¥åŠæ—¶çš„çŸ¥é“ç³»ç»Ÿå‘ç”Ÿäº†ä»€ä¹ˆï¼Œä»è€Œåšå‡ºç›¸åº”çš„å¯¹ç­–ã€‚å¯¹äºæ—¥å¿—ç›‘æ§ï¼Œzabbixæœ‰è¯è¯´ï¼Œzabbixä»è¾ƒæ—©çš„ç‰ˆæœ¬å°±æœ‰äº†æ—¥å¿—ç›‘æ§çš„åŠŸèƒ½ã€‚\næ—¥å¿—ç›‘æ§åŠŸèƒ½ zabbix-agentæ”¯æŒæ—¥å¿—æ–‡ä»¶çš„ç›‘æ§ï¼Œå¯ä»¥å¯¹æ—¥å¿—æ–‡ä»¶å…³é”®å­—è¿›è¡Œç›‘æ§ï¼Œç„¶åå‘Šè­¦ï¼Œæ—¥å¿—ç›‘æ§æ”¯æŒæ™®é€šçš„æ—¥å¿—æ–‡ä»¶ï¼Œæ”¯æŒæ—¥å¿—è½®è¯¢ï¼Œåˆ‡å‰²çš„æ–‡ä»¶ã€‚å½“æ—¥å¿—æ–‡ä»¶ä¸­å‡ºç°ç‰¹æ®Šçš„å­—ç¬¦ä¸²ï¼ˆå‘Šè­¦ï¼ŒæŠ¥é”™çš„å­—ç¬¦ä¸²ï¼‰å¯ä»¥å‘é€šçŸ¥ç»™å®¢æˆ·\næ—¥å¿—ç›‘æ§å¿…é¡»æ»¡è¶³ä»¥ä¸‹æ¡ä»¶ï¼š\nzabbix-agentå¿…é¡»è¿è¡Œï¼Œä¸”å·¥ä½œæ–¹å¼å¿…é¡»æ˜¯ä¸»åŠ¨æ¨¡å¼ æ—¥å¿—çš„Itemå¿…é¡»è®¾ç½®ï¼Œå¿…é¡»æŒ‡å®šæ–‡ä»¶å zabbix-agentæœ‰è¯»å–æ—¥å¿—çš„æƒé™ æ—¥å¿—ç›‘æ§çš„ç›‘æ§æŒ‡æ ‡ 1 2 3 4 5 6 7 log[/path/to/file/file_name,,,,,,,] logrt[path/to/file/regexpo_describing_filename_pattern,,,,,,,] log.count[/path/to/file/file_name,,,,,,] logrt.cunt[path/to/file/regexpo_describing_filename_pattern,,,,,,] å‚æ•° å«ä¹‰ file_name æ—¥å¿—æ–‡ä»¶æ‰€åœ¨çš„è·¯å¾„æˆ–è€…ç»å¯¹è·¯å¾„å regexp åŒ¹é…æ­£åˆ™è¡¨è¾¾å¼ encoding åœ¨Linux/unixç³»ç»Ÿä¸‹é»˜è®¤ç¼–ç ä¸ºUTF-8ï¼Œåœ¨Windowsç³»ç»Ÿä¸‹é»˜è®¤ç¼–ç ä¸ºANSI maxlines æ¯æ¬¡ç»™zabbix-serveræˆ–è€…zabbix-Proxyå‘é€çš„æ—¥å¿—çš„æœ€å¤§è¡Œæ•°ï¼Œæ­¤å‚æ•°ä¼šé«˜äºzabbix-agent.confä¸­çš„MaxLinesPerSecondå‚æ•°å€¼ï¼Œé€šè¿‡æ­¤å‚æ•°ï¼Œå¯ä»¥æ§åˆ¶ä¸€æ¬¡å‘é€çš„æ—¥å¿—çš„æ•°æ®æ¡æ•°ï¼Œå¦‚æœå‘é€æ¬¡æ•°è¿‡å¤šï¼Œå¯èƒ½ä¼šå¯¹zabbix-agnetçš„è´Ÿè½½å’ŒI/Oæœ‰å¾ˆå¤§çš„å½±å“ mode allä¸ºé»˜è®¤å‚æ•°ï¼Œè¡¨ç¤ºåŒ¹é…æ‰€æœ‰çš„æ—¥å¿—ï¼ŒåŒ…æ‹¬ä»¥å‰å­˜çš„æ—¥å¿—ä¹Ÿä¼šè¿›è¡ŒåŒ¹é… skip è¡¨ç¤ºè·³è¿‡å·²å­˜åœ¨çš„æ—¥å¿—æ•°æ®ï¼Œåªæœ‰æ–°çš„æ—¥å¿—æ‰ä¼šè¿›è¡ŒåŒ¹é… output è¡¨ç¤ºåŒ¹é…è¾“å‡ºçš„æ­£åˆ™è¡¨è¾¾å¼ï¼Œ1~9è¡¨ç¤ºè¿”å›çš„åŒ¹é…çš„ç¬¬å‡ ä¸ªå­—ç¬¦ä¸²ï¼Œè¡¨ç¤ºè¿”å›åŒ¹é…çš„å…¨éƒ¨å­—ç¬¦ä¸² maxdelay ä»¥ç§’ä¸ºå•ä½çš„æœ€å¤§å»¶è¿Ÿï¼Œç”¨ç”¨äºå¿½ç•¥è€çš„æ—¥å¿—æ•°æ®ï¼ŒåŠæ—¶è·å–è·å–å½“å‰çš„æ—¥å¿—æ•°æ®ã€‚ï¼ˆ4.0+ï¼‰å½“å¤„ç†æ—¥å¿—è¿‡å¤šï¼Œåœ¨æ›´æ–°å‘¨æœŸå†…è¾¾åˆ°maxlinesçš„å‘é€ä¸Šé™ï¼Œä½†è¿˜æœ‰æ—¥å¿—æœªå‘é€æ—¶ï¼Œä¼šå¯¼è‡´å¤§é‡å †ç§¯ï¼Œåœ¨ä¸¥é‡çš„æƒ…å†µä¸‹ï¼Œä¼šé€ æˆæ—¥å¿—å¤„ç†é€Ÿåº¦è·Ÿä¸ä¸Šï¼Œä½¿ç”¨æ­¤å‚æ•°å¿½ç•¥è¿‡æœŸçš„æ—¥å¿—å‘é€0æ˜¯é»˜è®¤å€¼ï¼Œæ°¸è¿œä¸ä¼šå¿½ç•¥æ—¥å¿—æ–‡ä»¶è¡Œè¾“å…¥å¯ä»¥æ˜¯æµ®ç‚¹æ•°ï¼ˆfloatï¼‰\u0026gt;0.0,å¿½ç•¥è¾ƒæ—§çš„è¡Œï¼Œä»¥è·å¾—åœ¨maxdelayç§’å†…åˆ†ææœ€æ–°è¡Œï¼Œä¼šä¸¢å¼ƒåœ¨è§„å®šæ—¶é—´å†…çš„æ— æ³•å‘é€çš„æ•°æ® options æ—¥å¿—è½®è¯¢ã€åˆ‡å‰²æ–¹å¼ï¼ˆ4.0+ï¼‰rotateï¼Œæ—¥å¿—è½®è¯¢ã€åˆ‡å‰²ï¼Œé»˜è®¤å€¼copytruncateï¼Œå…ˆæ‹·è´æ–‡ä»¶ï¼Œç„¶åæ¸…ç©ºæ—¥å¿—çš„è½®è¯¢æ–¹å¼ï¼Œcopytruncateä¸èƒ½ä¸maxdelayä¸€èµ·ä½¿ç”¨ï¼Œå¦‚ä½¿ç”¨æ­¤å‚æ•°ï¼Œmaxdelayå¿…é¡»ä¸º0æˆ–è€…æœªæŒ‡å®š[size=12.0000pt] ä¾‹ï¼šç›‘æ§zabbix_serverçš„æ—¥å¿—\nåˆ›å»ºç›‘æ§é¡¹ï¼Œé€‰æ‹©zabbix_serverå®¢æˆ·ç«¯ï¼ˆä¸»åŠ¨å¼ï¼‰\nè¿™å››ä¸ªå°±æ˜¯æ—¥å¿—ç›‘æ§çš„æŒ‡æ ‡ï¼Œæ ¹æ®éœ€æ±‚é€‰æ‹©åˆé€‚çš„é”®å€¼\næˆ‘çš„zabbix_serverçš„æ—¥å¿—è·¯å¾„äº‹/usr/local/zabbix/logs/zabbix_server,åé¢è·Ÿçš„æ­£åˆ™è¡¨è¾¾å¼äº‹errorï¼Œåªæœ‰å½“å‡ºç°errorå­—æ®µæ—¶ï¼Œæ‰ä¼šæœ‰æ•°æ®ï¼Œåé¢çš„å‚æ•°å¯ä»¥ä¸å†™ï¼Œä½†æ˜¯è¿˜æ˜¯è¦å†™é€—å·çš„ã€‚ä¿¡æ¯ç±»å‹é€‰æ‹©æ–‡æœ¬æˆ–è€…æ˜¯å­—ç¬¦\nè¿™æ ·è¿™ä¸ªæ—¥å¿—ç›‘æ§çš„ç›‘æ§é¡¹å°±å·²ç»åšå¥½äº†\næ¥ä¸‹æ¥å°±è¦åšçš„å°±æ˜¯åšè§¦å‘å™¨äº†\nè§¦å‘å™¨ä¸­ç›‘æ§é¡¹é€‰æ‹©åˆšæ‰åˆ›å»ºçš„ç›‘æ§é¡¹\nåŠŸèƒ½é€‰æ‹©diff()ï¼Œç»“æœé€‰æ‹©ç­‰äº1\nè¿­ä»£é€‰æ‹©æ— ï¼Œè¿™æ ·å†æ¬¡åŒ¹é…çš„è¯ï¼Œå‘Šè­¦å°±ä¸ä¼šæ¢å¤\næµ‹è¯•ï¼Œå¾€zabbix_server.logæ–‡ä»¶å†…å†™å…¥errorï¼Œæµ‹è¯•æ˜¯å¦ä¼šæŠ¥è­¦\nå¦‚æœzabbixç”¨æˆ·å¯¹æ—¥å¿—æ²¡æœ‰è¯»å–æƒé™ï¼Œåˆ™ä¼šæç¤ºæƒé™æ‹’ç»å¯¼è‡´æ•°æ®è·å–å¤±è´¥ å¯¹äºä¸æ–¹ä¾¿è®¾ç½®æƒé™çš„æ—¥å¿—æ–‡ä»¶ï¼Œå¯ä»¥ä½¿zabbix_agenté‡‡ç”¨rootæƒé™è¿è¡Œ\nåœ¨zabbix_agentd.confæ–‡ä»¶ä¸­è®¾ç½®AllowRootå‚æ•°è®¾ç½®ä¸º1\nAllowRoot=1\næ—¥å¿—ç›‘æ§çš„æ•°æ®åº“è®°å½• æ—¥å¿—æ•°æ®å­˜å‚¨åœ¨history_logè¡¨ä¸­\næŸ¥è¯¢æ—¥å¿—\nmysql\u0026gt;select * from history_log; ä½œè€…ï¼šSREè¿ç»´åšå®¢\nåšå®¢åœ°å€ï¼šhttps://www.cnsre.cn\næ–‡ç« åœ°å€ï¼šhttps://www.cnsre.cn/posts/210811113507/\nç›¸å…³è¯é¢˜ï¼šhttps://www.cnsre.cn/tags/zabbix/\n","description":"zabbix-agentå¯¹æ—¥å¿—æ–‡ä»¶çš„ç›‘æ§ï¼Œå¯ä»¥å¯¹æ—¥å¿—æ–‡ä»¶å…³é”®å­—è¿›è¡Œç›‘æ§ï¼Œç„¶åå‘Šè­¦","id":51,"section":"posts","tags":["zabbix","æ—¥å¿—"],"title":"Zabbix ç›‘æ§æ—¥å¿—","uri":"http://www.cnsre.cn:80/posts/210811113507/"},{"content":" ä½œè€…ï¼šSREè¿ç»´åšå®¢\nåšå®¢åœ°å€ï¼šhttps://www.cnsre.cn\næ–‡ç« åœ°å€ï¼šhttps://www.cnsre.cn/posts/210810958573/\nç›¸å…³è¯é¢˜ï¼šhttps://www.cnsre.cn/tags/nginx/\nNginx æ˜¯ç”¨äº Web æœåŠ¡ã€åå‘ä»£ç†ã€ç¼“å­˜ã€è´Ÿè½½å¹³è¡¡ã€åª’ä½“æµç­‰çš„å¼€æºè½¯ä»¶ã€‚åœ¨è¿™å°†æåˆ°ä¸€äº›ç»å¸¸ä½¿ç”¨çš„ Nginx ç»å…¸é…ç½®ä»¥åŠå®‰å…¨æ€§çš„ä¸€äº›é…ç½®ã€‚è¯·æ ¹æ®æ‚¨çš„å®é™…éœ€æ±‚å¯¹è¿™äº›é…ç½®è¿›è¡Œè°ƒæ•´ã€‚\nä¾¦å¬ç«¯å£ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 server { # æ ‡å‡†HTTPåè®® listen 80; # æ ‡å‡†HTTPSåè®® listen 443 ssl; # ä½¿ç”¨ http2 listen 443 ssl http2; # ä½¿ç”¨IPv6 ç›‘å¬ 80 listen [::]:80; # ä»…é™ä½¿ç”¨IPv6 listen [::]:80 ipv6only=on; } è®¿é—®æ—¥å¿— 1 2 3 4 5 6 7 server { # æ—¥å¿—æ–‡ä»¶çš„ç›¸å¯¹æˆ–å®Œæ•´è·¯å¾„ access_log /path/to/file.log; # é€‰æ‹© \u0026#39;on\u0026#39; æˆ–è€… \u0026#39;off\u0026#39; access_log on; } åŸŸå 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 server { # ç›‘å¬å•ä¸ªåŸŸå server_name cnsre.cn; # ç›‘å¬å¤šä¸ªåŸŸå server_name cnsre.cn www.cnsre.cn; # ç›‘å¬æ‰€æœ‰åŸŸå server_name *.cnsre.cn; # ç›‘å¬æ‰€æœ‰é¡¶çº§åŸŸå server_name cnsre.*; # ç›‘å¬æœªæŒ‡å®šçš„ä¸»æœºåï¼ˆä¾¦å¬IPåœ°å€æœ¬èº«ï¼‰ server_name \u0026#34;\u0026#34;; } é™æ€èµ„æº 1 2 3 4 5 6 7 8 server { listen 80; server_name cnsre.cn; location / { root /path/to/website; } } é‡å®šå‘ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 server { listen 80; server_name www.cnsre.cn; return 301 http://cnsre.cn$request_uri; } server { listen 80; server_name www.cnsre.cn; location /redirect-url { return 301 http://otherdomain.com; } } åå‘ä»£ç† 1 2 3 4 5 6 7 8 9 10 server { listen 80; server_name cnsre.cn; location / { proxy_pass http://0.0.0.0:3000; # å…¶ä¸­ 0.0.0.0:3000 æ˜¯æ‚¨çš„åº”ç”¨ç¨‹åºæœåŠ¡å™¨ï¼ˆä¾‹å¦‚ï¼šnode.jsï¼‰ç»‘å®šåœ¨ 0.0.0.0 ä¸Šï¼Œç›‘å¬ç«¯å£ 3000 } } è´Ÿè½½å‡è¡¡ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 upstream node_js { server 0.0.0.0:3000; server 0.0.0.0:4000; server 1.1.1.1; } server { listen 80; server_name cnsre.cn; location / { proxy_pass http://www.cnsre.cn; } } SSL åè®® 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 server { listen 443 ssl; server_name cnsre.cn; ssl on; ssl_certificate /path/to/cert.pem; ssl_certificate_key /path/to/privatekey.pem; ssl_stapling on; ssl_stapling_verify on; ssl_trusted_certificate /path/to/fullchain.pem; ssl_protocols TLSv1 TLSv1.1 TLSv1.2; ssl_session_timeout 1h; ssl_session_cache shared:SSL:50m; add_header Strict-Transport-Security max-age=15768000; } # HTTP åˆ° HTTPS çš„æ°¸ä¹…é‡å®šå‘ server { listen 80; server_name cnsre.cn; return 301 https://$host$request_uri; } ç¦æ­¢ä»»ä½•æ•æ„Ÿçš„è¯·æ±‚è·¯å¾„ 1 2 3 4 5 6 7 8 9 location ~ /\\.git { deny all; } ## Disable .htaccess and other hidden files location ~ /\\.(?!well-known).* { deny all; access_log off; log_not_found off; } ç¦æ­¢ä¸å¿…è¦çš„ HTTP è¯·æ±‚æ–¹æ³• æœ€å¸¸ç”¨çš„ HTTP è¯·æ±‚æ–¹æ³•æ˜¯ GETã€POSTã€HEADã€‚å¯¹äºä»»ä½•å…¶ä»–æœªä½¿ç”¨çš„æ–¹æ³•ï¼Œæˆ‘ä»¬åº”è¯¥è¿”å› 444ã€‚\n1 2 3 4 5 #åªå…è®¸è¿™äº›è¯·æ±‚æ–¹æ³• if ($request_method !~ ^(GET|HEAD|POST)$ ) { return 444; } # ä¸æ¥å—åˆ é™¤ï¼Œæœç´¢å’Œå…¶ä»–æ–¹æ³• æ·»åŠ è¯·æ±‚é€Ÿç‡é™åˆ¶ é™é€Ÿ ä¼šæ‹¦æˆªå¾ˆå¤šæ¶æ„è¯·æ±‚ï¼Œä¹Ÿæ˜¯é˜²å¾¡ç½‘ç«™çš„ç½‘ç»œçº§å’Œåº”ç”¨çº§DDoSæ”»å‡»çš„å¸¸ç”¨å·¥å…·ã€‚æˆ‘ä»¬å¯ä»¥ä¸ºå•ä¸ª IP æ·»åŠ æœ€å¤§è¯·æ±‚é™åˆ¶ã€‚\n1 2 3 4 5 6 7 8 9 limit_req_zone $binary_remote_addr zone=ip:10m rate=5r/s; server { listen 80; location / { limit_req zone=ip burst=12 delay=8; proxy_pass http://cnsre.cn; } } ç‚¹å‡»åŠ«æŒæ”»å‡» ç‚¹å‡»åŠ«æŒæ”»å‡» ä¼šå¯¼è‡´ç”¨æˆ·åœ¨ä¸çŸ¥ä¸è§‰ä¸­ä¸‹è½½æ¶æ„è½¯ä»¶ã€è®¿é—®æ¶æ„ç½‘é¡µã€æä¾›å‡­æ®æˆ–æ•æ„Ÿä¿¡æ¯ã€‚\næˆ‘ä»¬å¯ä»¥X-FRAME-OPTIONSåœ¨ HTTP Header ä¸­æ³¨å…¥ä»¥é˜²æ­¢ç‚¹å‡»åŠ«æŒæ”»å‡»ï¼ˆç”šè‡³å¯ä»¥é€šè¿‡æŸäº›æ–¹å¼ç»•è¿‡ï¼‰ã€‚è¿™æ˜¯é€šè¿‡åœ¨ nginx.conf æ–‡ä»¶ä¸­æ·»åŠ ä»¥ä¸‹å†…å®¹æ¥å®ç°çš„\n1 add_header X-Frame-Options \u0026#34;SAMEORIGIN\u0026#34;; X-XSS ä¿æŠ¤ æ³¨å…¥å…·æœ‰ X-XSS ä¿æŠ¤çš„ HTTP æ ‡å¤´ä»¥å‡è½»è·¨ç«™ç‚¹è„šæœ¬æ”»å‡»ã€‚ä¿®æ”¹ nginx.conf æ–‡ä»¶æ·»åŠ ä»¥ä¸‹å†…å®¹\n1 add_header X-XSS-Protection \u0026#34;1; mode=block\u0026#34;; å¦‚æœä½ è¿˜å¯¹å®‰å…¨æ ‡å¤´æ„Ÿå…´è¶£ï¼Œç‚¹å‡»è¿™é‡Œäº†è§£è¿™äº›æ ‡å¤´ã€‚\nä½œè€…ï¼šSREè¿ç»´åšå®¢\nåšå®¢åœ°å€ï¼šhttps://www.cnsre.cn\næ–‡ç« åœ°å€ï¼šhttps://www.cnsre.cn/posts/210810958573/\nç›¸å…³è¯é¢˜ï¼šhttps://www.cnsre.cn/tags/nginx/\n","description":"Nginx æ˜¯ç”¨äº Web æœåŠ¡ã€åå‘ä»£ç†ã€ç¼“å­˜ã€è´Ÿè½½å¹³è¡¡ã€åª’ä½“æµç­‰çš„å¼€æºè½¯ä»¶ã€‚åœ¨è¿™å°†æåˆ°ä¸€äº›ç»å¸¸ä½¿ç”¨çš„ Nginx ç»å…¸é…ç½®ä»¥åŠå®‰å…¨æ€§çš„ä¸€äº›é…ç½®ã€‚è¯·æ ¹æ®æ‚¨çš„å®é™…éœ€æ±‚å¯¹è¿™äº›é…ç½®è¿›è¡Œè°ƒæ•´ã€‚","id":52,"section":"posts","tags":["nginx"],"title":"Nginx å¸¸ç”¨é…ç½®ä»¥åŠå®‰å…¨é…ç½®æ¡ˆä¾‹","uri":"http://www.cnsre.cn:80/posts/210810958573/"},{"content":" ä½œè€…ï¼šSREè¿ç»´åšå®¢\nåšå®¢åœ°å€ï¼šhttps://www.cnsre.cn\næ–‡ç« åœ°å€ï¼šhttps://www.cnsre.cn/posts/210624108255/\nç›¸å…³è¯é¢˜ï¼šhttps://www.cnsre.cn/tags/kubernetes/\nå®‰è£… go è¯­è¨€ç¯å¢ƒ Golang å®˜ç½‘ä¸‹è½½åœ°å€ï¼šgolangå®˜ç½‘\næ‰“å¼€å®˜ç½‘ä¸‹è½½åœ°å€é€‰æ‹©å¯¹åº”çš„ç³»ç»Ÿç‰ˆæœ¬, å¤åˆ¶ä¸‹è½½é“¾æ¥\nè¿™é‡Œæˆ‘é€‰æ‹©çš„æ˜¯\ngo1.16.5.linux-amd64.tar.gz\nä¸‹è½½è§£å‹ ä¸‹è½½å®‰è£…åŒ…\n1 wget https://dl.google.com/go/go1.16.5.linux-amd64.tar.gz è§£å‹åˆ°/usr/loaclç›®å½•ä¸‹\n1 tar -C /usr/local -zxvf go1.16.5.linux-amd64.tar.gz æ·»åŠ ç¯å¢ƒå˜é‡ æ·»åŠ /usr/loacl/go/bin ç›®å½•åˆ° PATH å˜é‡ä¸­ã€‚æ·»åŠ åˆ° /etc/profile\n1 2 3 4 5 6 vim /etc/profile # åœ¨æœ€åä¸€è¡Œæ·»åŠ  export GOROOT=/usr/local/go export PATH=$PATH:$GOROOT/bin # ä¿å­˜é€€å‡ºåsourceä¸€ä¸‹ source /etc/profile éªŒè¯ æ‰§è¡Œgo versionï¼Œå¦‚æœç°å®ç‰ˆæœ¬å·ï¼Œåˆ™Goç¯å¢ƒå®‰è£…æˆåŠŸã€‚\n1 2 [root@master ~]# go version go version go1.16.5 linux/amd64 æŸ¥çœ‹å½“å‰çš„è¯ä¹¦æ—¶é—´ æ‰§è¡Œå‘½ä»¤ æŸ¥çœ‹å½“å‰è¯ä¹¦æ—¶é—´\n1 kubeadm alpha certs check-expiration ä¸‹è½½æºç  æ‰“å¼€github kubernetes é€‰æ‹©å¯¹åº”çš„ç‰ˆæœ¬ä¸‹è½½\nä¸‹è½½å¹¶è§£å‹\nå› ä¸ºæˆ‘æ˜¯ v1.20.6 ç‰ˆæœ¬æ‰€ä»¥ä¸‹è½½å¯¹åº”çš„\n1 2 wget https://github.com/kubernetes/kubernetes/archive/refs/tags/v1.20.6.zip unzip v1.20.6.zip ä¿®æ”¹ constants.go æ–‡ä»¶\nvim cmd/kubeadm/app/constants/constants.go æ‰¾åˆ° CertificateValidity ï¼Œä¿®æ”¹å¦‚ä¸‹\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 cd kubernetes-1.20.6 vim cmd/kubeadm/app/constants/constants.go .... const ( // KubernetesDir is the directory Kubernetes owns for storing various configuration files KubernetesDir = \u0026#34;/etc/kubernetes\u0026#34; // ManifestsSubDirName defines directory name to store manifests ManifestsSubDirName = \u0026#34;manifests\u0026#34; // TempDirForKubeadm defines temporary directory for kubeadm // should be joined with KubernetesDir. TempDirForKubeadm = \u0026#34;tmp\u0026#34; // CertificateValidity defines the validity for all the signed certificates generated by kubeadm CertificateValidity = time.Hour * 24 * 365 * 100 # ä¿®æ”¹æ­¤å†…å®¹ .... ç¼–è¯‘ kubeadm 1 make WHAT=cmd/kubeadm è¿”å›å¦‚ä¸‹\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 [root@master kubernetes-1.20.6]# make WHAT=cmd/kubeadm +++ [0624 10:59:21] Building go targets for linux/amd64: ./vendor/k8s.io/code-generator/cmd/prerelease-lifecycle-gen +++ [0624 10:59:25] Building go targets for linux/amd64: ./vendor/k8s.io/code-generator/cmd/deepcopy-gen +++ [0624 10:59:33] Building go targets for linux/amd64: ./vendor/k8s.io/code-generator/cmd/defaulter-gen +++ [0624 10:59:44] Building go targets for linux/amd64: ./vendor/k8s.io/code-generator/cmd/conversion-gen +++ [0624 11:00:04] Building go targets for linux/amd64: ./vendor/k8s.io/kube-openapi/cmd/openapi-gen +++ [0624 11:00:19] Building go targets for linux/amd64: ./vendor/github.com/go-bindata/go-bindata/go-bindata +++ [0624 11:00:20] Building go targets for linux/amd64: cmd/kubeadm ç¼–è¯‘å®Œç”Ÿæˆå¦‚ä¸‹ç›®å½•å’ŒäºŒè¿›åˆ¶æ–‡ä»¶\n1 2 3 4 5 6 7 8 9 10 [root@master kubernetes-1.20.6]# ll _output/bin/ æ€»ç”¨é‡ 75680 -rwxr-xr-x. 1 root root 5943296 6æœˆ 24 10:59 conversion-gen -rwxr-xr-x. 1 root root 5689344 6æœˆ 24 10:59 deepcopy-gen -rwxr-xr-x. 1 root root 5709824 6æœˆ 24 10:59 defaulter-gen -rwxr-xr-x. 1 root root 3555111 6æœˆ 24 10:59 go2make -rwxr-xr-x. 1 root root 1966080 6æœˆ 24 11:00 go-bindata -rwxr-xr-x. 1 root root 39325696 6æœˆ 24 11:01 kubeadm -rwxr-xr-x. 1 root root 9650176 6æœˆ 24 11:00 openapi-gen -rwxr-xr-x. 1 root root 5656576 6æœˆ 24 10:59 prerelease-lifecycle-gen å¤‡ä»½æ–‡ä»¶ å¤‡ä»½ kubeadm å’Œè¯ä¹¦æ–‡ä»¶\n1 2 cp /usr/bin/kubeadm{,.bak20210624} cp -r /etc/kubernetes/pki{,.bak20210624} æŸ¥çœ‹å¤‡ä»½æ–‡ä»¶\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 [root@master kubernetes-1.20.6]# ll /usr/bin/kubeadm* -rwxr-xr-x. 1 root root 39325696 6æœˆ 24 11:05 /usr/bin/kubeadm -rwxr-xr-x. 1 root root 39210880 6æœˆ 24 11:02 /usr/bin/kubeadm.bak20210624 [root@master kubernetes-1.20.6 ll /etc/kubernetes/pki* /etc/kubernetes/pki: æ€»ç”¨é‡ 56 -rw-r--r--. 1 root root 1289 6æœˆ 24 11:05 apiserver.crt -rw-r--r--. 1 root root 1139 6æœˆ 24 11:05 apiserver-etcd-client.crt -rw-------. 1 root root 1675 6æœˆ 24 11:05 apiserver-etcd-client.key -rw-------. 1 root root 1679 6æœˆ 24 11:05 apiserver.key -rw-r--r--. 1 root root 1147 6æœˆ 24 11:05 apiserver-kubelet-client.crt -rw-------. 1 root root 1675 6æœˆ 24 11:05 apiserver-kubelet-client.key -rw-r--r--. 1 root root 1066 6æœˆ 22 15:01 ca.crt -rw-------. 1 root root 1675 6æœˆ 22 15:01 ca.key drwxr-xr-x. 2 root root 162 6æœˆ 22 15:01 etcd -rwxr-xr-x. 1 root root 1078 6æœˆ 22 15:01 front-proxy-ca.crt -rw-------. 1 root root 1675 6æœˆ 22 15:01 front-proxy-ca.key -rw-r--r--. 1 root root 1103 6æœˆ 24 11:05 front-proxy-client.crt -rw-------. 1 root root 1679 6æœˆ 24 11:05 front-proxy-client.key -rw-------. 1 root root 1675 6æœˆ 22 15:01 sa.key -rw-------. 1 root root 451 6æœˆ 22 15:01 sa.pub /etc/kubernetes/pki.bak20210624: æ€»ç”¨é‡ 56 -rw-r--r--. 1 root root 1289 6æœˆ 24 11:04 apiserver.crt -rw-r--r--. 1 root root 1135 6æœˆ 24 11:04 apiserver-etcd-client.crt -rw-------. 1 root root 1675 6æœˆ 24 11:04 apiserver-etcd-client.key -rw-------. 1 root root 1679 6æœˆ 24 11:04 apiserver.key -rw-r--r--. 1 root root 1143 6æœˆ 24 11:04 apiserver-kubelet-client.crt -rw-------. 1 root root 1675 6æœˆ 24 11:04 apiserver-kubelet-client.key -rw-r--r--. 1 root root 1066 6æœˆ 24 11:04 ca.crt -rw-------. 1 root root 1675 6æœˆ 24 11:04 ca.key drwxr-xr-x. 2 root root 162 6æœˆ 24 11:04 etcd -rwxr-xr-x. 1 root root 1078 6æœˆ 24 11:04 front-proxy-ca.crt -rw-------. 1 root root 1675 6æœˆ 24 11:04 front-proxy-ca.key -rw-r--r--. 1 root root 1103 6æœˆ 24 11:04 front-proxy-client.crt -rw-------. 1 root root 1679 6æœˆ 24 11:04 front-proxy-client.key -rw-------. 1 root root 1675 6æœˆ 24 11:04 sa.key -rw-------. 1 root root 451 6æœˆ 24 11:04 sa.pub æ›¿æ¢ kubeadm å°†æ–°ç”Ÿæˆçš„ kubeadm è¿›è¡Œæ›¿æ¢\n1 cp _output/bin/kubeadm /usr/bin/kubeadm ç”Ÿæˆæ–°çš„è¯ä¹¦ 1 2 cd /etc/kubernetes/pki kubeadm alpha certs renew all è¿”å›å†…å®¹\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 [root@master pki]# kubeadm alpha certs renew all Command \u0026#34;all\u0026#34; is deprecated, please use the same command under \u0026#34;kubeadm certs\u0026#34; [renew] Reading configuration from the cluster... [renew] FYI: You can look at this config file with \u0026#39;kubectl -n kube-system get cm kubeadm-config -o yaml\u0026#39; certificate embedded in the kubeconfig file for the admin to use and for kubeadm itself renewed certificate for serving the Kubernetes API renewed certificate the apiserver uses to access etcd renewed certificate for the API server to connect to kubelet renewed certificate embedded in the kubeconfig file for the controller manager to use renewed certificate for liveness probes to healthcheck etcd renewed certificate for etcd nodes to communicate with each other renewed certificate for serving etcd renewed certificate for the front proxy client renewed certificate embedded in the kubeconfig file for the scheduler manager to use renewed Done renewing certificates. You must restart the kube-apiserver, kube-controller-manager, kube-scheduler and etcd, so that they can use the new certificates. éªŒè¯ç»“æœ åˆ°è¿™é‡Œï¼Œè¯ä¹¦å°±æ›¿æ¢å®Œæˆäº†ã€‚æ¥ä¸‹æ¥éªŒè¯ä¸‹è¯ä¹¦æ—¶é—´æ˜¯å¦å»¶é•¿ã€‚\n1 kubeadm alpha certs check-expiration è¿”å›ä¿¡æ¯\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 [root@master pki]# kubeadm alpha certs check-expiration Command \u0026#34;check-expiration\u0026#34; is deprecated, please use the same command under \u0026#34;kubeadm certs\u0026#34; [check-expiration] Reading configuration from the cluster... [check-expiration] FYI: You can look at this config file with \u0026#39;kubectl -n kube-system get cm kubeadm-config -o yaml\u0026#39; CERTIFICATE EXPIRES RESIDUAL TIME CERTIFICATE AUTHORITY EXTERNALLY MANAGED admin.conf May 31, 2121 03:05 UTC 99y no apiserver May 31, 2121 03:05 UTC 99y ca no apiserver-etcd-client May 31, 2121 03:05 UTC 99y etcd-ca no apiserver-kubelet-client May 31, 2121 03:05 UTC 99y ca no controller-manager.conf May 31, 2121 03:05 UTC 99y no etcd-healthcheck-client May 31, 2121 03:05 UTC 99y etcd-ca no etcd-peer May 31, 2121 03:05 UTC 99y etcd-ca no etcd-server May 31, 2121 03:05 UTC 99y etcd-ca no front-proxy-client May 31, 2121 03:05 UTC 99y front-proxy-ca no scheduler.conf May 31, 2121 03:05 UTC 99y no CERTIFICATE AUTHORITY EXPIRES RESIDUAL TIME EXTERNALLY MANAGED ca Jun 20, 2031 07:01 UTC 9y no etcd-ca Jun 20, 2031 07:01 UTC 9y no front-proxy-ca Jun 20, 2031 07:01 UTC 9y no æŸ¥çœ‹ node çŠ¶æ€\n1 2 3 4 [root@master pki]# kubectl get node NAME STATUS ROLES AGE VERSION master Ready control-plane,master 44h v1.20.6 node1 Ready \u0026lt;none\u0026gt; 43h v1.20.6 ä½œè€…ï¼šSREè¿ç»´åšå®¢\nåšå®¢åœ°å€ï¼šhttps://www.cnsre.cn\næ–‡ç« åœ°å€ï¼šhttps://www.cnsre.cn/posts/210624108255/\nç›¸å…³è¯é¢˜ï¼šhttps://www.cnsre.cn/tags/kubernetes/\n","description":"kubeadm  æ›´æ–°è¯ä¹¦ï¼Œä¿®æ”¹è¯ä¹¦æ—¶é—´ä¸º99å¹´","id":53,"section":"posts","tags":["kubeadm"],"title":"kubeadm  æ›´æ–°è¯ä¹¦","uri":"http://www.cnsre.cn:80/posts/210624108255/"},{"content":" ä½œè€…ï¼šSREè¿ç»´åšå®¢\nåšå®¢åœ°å€ï¼šhttps://www.cnsre.cn\næ–‡ç« åœ°å€ï¼šhttps://www.cnsre.cn/posts/210621550392/\nç›¸å…³è¯é¢˜ï¼šhttps://www.cnsre.cn/tags/prometheus/\nç®€ä»‹ Prometheus ä»‹ç» Prometheus æ˜¯ä¸€å¥—å¼€æºçš„ç›‘æ§ \u0026amp; æŠ¥è­¦ \u0026amp; æ—¶é—´åºåˆ—æ•°æ®åº“çš„ç»„åˆ,èµ·å§‹æ˜¯ç”± SoundCloud å…¬å¸å¼€å‘çš„ã€‚æˆç«‹äº 2012 å¹´ï¼Œä¹‹åè®¸å¤šå…¬å¸å’Œç»„ç»‡æ¥å—å’Œé‡‡ç”¨ prometheus,ä»–ä»¬ä¾¿å°†å®ƒç‹¬ç«‹æˆå¼€æºé¡¹ç›®ï¼Œå¹¶ä¸”æœ‰å…¬å¸æ¥è¿ä½œ.è¯¥é¡¹ç›®æœ‰éå¸¸æ´»è·ƒçš„ç¤¾åŒºå’Œå¼€å‘äººå‘˜ï¼Œç›®å‰æ˜¯ç‹¬ç«‹çš„å¼€æºé¡¹ç›®ï¼Œä»»ä½•å…¬å¸éƒ½å¯ä»¥ä½¿ç”¨å®ƒï¼Œ2016 å¹´ï¼ŒPrometheus åŠ å…¥äº†äº‘è®¡ç®—åŸºé‡‘ä¼šï¼Œæˆä¸º kubernetes ä¹‹åçš„ç¬¬äºŒä¸ªæ‰˜ç®¡é¡¹ç›®.google SRE çš„ä¹¦å†…ä¹Ÿæ›¾æåˆ°è·Ÿä»–ä»¬ BorgMon ç›‘æ§ç³»ç»Ÿç›¸ä¼¼çš„å®ç°æ˜¯ Prometheusã€‚ç°åœ¨æœ€å¸¸è§çš„ Kubernetes å®¹å™¨ç®¡ç†ç³»ç»Ÿä¸­ï¼Œé€šå¸¸ä¼šæ­é… Prometheus è¿›è¡Œç›‘æ§ã€‚\nKubernetes Operator ä»‹ç» Prometheus-operator å·²ç»æ”¹åä¸º Kube-promethues åœ¨ Kubernetes çš„æ”¯æŒä¸‹ï¼Œç®¡ç†å’Œä¼¸ç¼© Web åº”ç”¨ã€ç§»åŠ¨åº”ç”¨åç«¯ä»¥åŠ API æœåŠ¡éƒ½å˜å¾—æ¯”è¾ƒç®€å•äº†ã€‚å…¶åŸå› æ˜¯è¿™äº›åº”ç”¨ä¸€èˆ¬éƒ½æ˜¯æ— çŠ¶æ€çš„ï¼Œæ‰€ä»¥ Deployment è¿™æ ·çš„åŸºç¡€ Kubernetes API å¯¹è±¡å°±å¯ä»¥åœ¨æ— éœ€é™„åŠ æ“ä½œçš„æƒ…å†µä¸‹ï¼Œå¯¹åº”ç”¨è¿›è¡Œä¼¸ç¼©å’Œæ•…éšœæ¢å¤äº†ã€‚\nè€Œå¯¹äºæ•°æ®åº“ã€ç¼“å­˜æˆ–è€…ç›‘æ§ç³»ç»Ÿç­‰æœ‰çŠ¶æ€åº”ç”¨çš„ç®¡ç†ï¼Œå°±æ˜¯ä¸ªæŒ‘æˆ˜äº†ã€‚è¿™äº›ç³»ç»Ÿéœ€è¦åº”ç”¨é¢†åŸŸçš„çŸ¥è¯†ï¼Œæ¥æ­£ç¡®çš„è¿›è¡Œä¼¸ç¼©å’Œå‡çº§ï¼Œå½“æ•°æ®ä¸¢å¤±æˆ–ä¸å¯ç”¨çš„æ—¶å€™ï¼Œè¦è¿›è¡Œæœ‰æ•ˆçš„é‡æ–°é…ç½®ã€‚æˆ‘ä»¬å¸Œæœ›è¿™äº›åº”ç”¨ç›¸å…³çš„è¿ç»´æŠ€èƒ½å¯ä»¥ç¼–ç åˆ°è½¯ä»¶ä¹‹ä¸­ï¼Œä»è€Œå€ŸåŠ© Kubernetes` çš„èƒ½åŠ›ï¼Œæ­£ç¡®çš„è¿è¡Œå’Œç®¡ç†å¤æ‚åº”ç”¨ã€‚\nOperator è¿™ç§è½¯ä»¶ï¼Œä½¿ç”¨ TPR (ç¬¬ä¸‰æ–¹èµ„æºï¼Œç°åœ¨å·²ç»å‡çº§ä¸º CRD) æœºåˆ¶å¯¹ Kubernetes API è¿›è¡Œæ‰©å±•ï¼Œå°†ç‰¹å®šåº”ç”¨çš„çŸ¥è¯†èå…¥å…¶ä¸­ï¼Œè®©ç”¨æˆ·å¯ä»¥åˆ›å»ºã€é…ç½®å’Œç®¡ç†åº”ç”¨ã€‚å’Œ Kubernetes çš„å†…ç½®èµ„æºä¸€æ ·ï¼ŒOperator æ“ä½œçš„ä¸æ˜¯ä¸€ä¸ªå•å®ä¾‹åº”ç”¨ï¼Œè€Œæ˜¯é›†ç¾¤èŒƒå›´å†…çš„å¤šå®ä¾‹ã€‚\nPrometheus Operator ä»‹ç» Kubernetes çš„ Prometheus Operator ä¸º Kubernetes æœåŠ¡å’Œ Prometheus å®ä¾‹çš„éƒ¨ç½²å’Œç®¡ç†æä¾›äº†ç®€å•çš„ç›‘æ§å®šä¹‰ã€‚\nå®‰è£…å®Œæ¯•åï¼ŒPrometheus Operator æä¾›äº†ä»¥ä¸‹åŠŸèƒ½ï¼š\nåˆ›å»º/æ¯åï¼š åœ¨ Kubernetes namespace ä¸­æ›´å®¹æ˜“å¯åŠ¨ä¸€ä¸ª Prometheus å®ä¾‹ï¼Œä¸€ä¸ªç‰¹å®šçš„åº”ç”¨ç¨‹åºæˆ–å›¢é˜Ÿæ›´å®¹æ˜“ä½¿ç”¨Operatorã€‚ ç®€å•é…ç½®ï¼š é…ç½® Prometheus çš„åŸºç¡€ä¸œè¥¿ï¼Œæ¯”å¦‚åœ¨ Kubernetes çš„æœ¬åœ°èµ„æº versions, persistence, retention policies, å’Œ replicasã€‚ Target Services é€šè¿‡æ ‡ç­¾ï¼š åŸºäºå¸¸è§çš„ Kubernetes label æŸ¥è¯¢ï¼Œè‡ªåŠ¨ç”Ÿæˆç›‘æ§ target é…ç½®ï¼›ä¸éœ€è¦å­¦ä¹  Prometheus ç‰¹å®šçš„é…ç½®è¯­è¨€ã€‚ æ¶æ„ Prometheus ä¸ºä¸€ä¸ªç›‘æ§ç³»ç»Ÿï¼Œ Prometheus é¡¹ç›®çš„ä½œç”¨å’Œå·¥ä½œæ–¹å¼ï¼Œå…¶å®å¯ä»¥ç”¨å¦‚ä¸‹æ‰€ç¤ºçš„ä¸€å¼ å®˜æ–¹ç¤ºæ„å›¾æ¥è§£é‡Šï¼š\nå¯ä»¥çœ‹åˆ°ï¼Œ Prometheus é¡¹ç›®å·¥ä½œçš„æ ¸å¿ƒï¼Œæ˜¯ä½¿ç”¨ Pull ï¼ˆæŠ“å–ï¼‰çš„æ–¹å¼å»æœé›†è¢«ç›‘æ§å¯¹è±¡çš„ Metrics æ•°æ®ï¼ˆç›‘æ§æŒ‡æ ‡æ•°æ®ï¼‰ï¼Œç„¶åï¼Œå†æŠŠè¿™äº›æ•°æ®ä¿å­˜åœ¨ä¸€ä¸ª TSDB ï¼ˆæ—¶é—´åºåˆ—æ•°æ®åº“ï¼Œæ¯”å¦‚ OpenTSDBã€InfluxDB ç­‰ï¼‰å½“ä¸­ï¼Œä»¥ä¾¿åç»­å¯ä»¥æŒ‰ç…§æ—¶é—´è¿›è¡Œæ£€ç´¢ã€‚æœ‰äº†è¿™å¥—æ ¸å¿ƒç›‘æ§æœºåˆ¶ï¼Œ Prometheus å‰©ä¸‹çš„ç»„ä»¶å°±æ˜¯ç”¨æ¥é…åˆè¿™å¥—æœºåˆ¶çš„è¿è¡Œã€‚æ¯”å¦‚ Pushgateway ï¼Œå¯ä»¥å…è®¸è¢«ç›‘æ§å¯¹è±¡ä»¥ Push çš„æ–¹å¼å‘ Prometheus æ¨é€ Metrics æ•°æ®ã€‚è€Œ Alertmanager ï¼Œåˆ™å¯ä»¥æ ¹æ® Metrics ä¿¡æ¯çµæ´»åœ°è®¾ç½®æŠ¥è­¦ã€‚å½“ç„¶ï¼Œ Prometheus æœ€å—ç”¨æˆ·æ¬¢è¿çš„åŠŸèƒ½ï¼Œè¿˜æ˜¯é€šè¿‡ Grafana å¯¹å¤–æš´éœ²å‡ºçš„ã€å¯ä»¥çµæ´»é…ç½®çš„ç›‘æ§æ•°æ®å¯è§†åŒ–ç•Œé¢ã€‚\nPrometheus Operator Operatorï¼š Operator èµ„æºä¼šæ ¹æ®è‡ªå®šä¹‰èµ„æºï¼ˆCustom Resource Definition / CRDsï¼‰æ¥éƒ¨ç½²å’Œç®¡ç† Prometheus Server ï¼ŒåŒæ—¶ç›‘æ§è¿™äº›è‡ªå®šä¹‰èµ„æºäº‹ä»¶çš„å˜åŒ–æ¥åšç›¸åº”çš„å¤„ç†ï¼Œæ˜¯æ•´ä¸ªç³»ç»Ÿçš„æ§åˆ¶ä¸­å¿ƒã€‚\nPrometheusï¼š Prometheus èµ„æºæ˜¯å£°æ˜æ€§åœ°æè¿° Prometheus éƒ¨ç½²çš„æœŸæœ›çŠ¶æ€ã€‚\nPrometheus Serverï¼š Operator æ ¹æ®è‡ªå®šä¹‰èµ„æº Prometheus ç±»å‹ä¸­å®šä¹‰çš„å†…å®¹è€Œéƒ¨ç½²çš„ Prometheus Server é›†ç¾¤ï¼Œè¿™äº›è‡ªå®šä¹‰èµ„æºå¯ä»¥çœ‹ä½œæ˜¯ç”¨æ¥ç®¡ç† Prometheus Server é›†ç¾¤çš„ StatefulSets èµ„æºã€‚\nServiceMonitorï¼š ServiceMonitor ä¹Ÿæ˜¯ä¸€ä¸ªè‡ªå®šä¹‰èµ„æºï¼Œå®ƒæè¿°äº†ä¸€ç»„è¢« Prometheus ç›‘æ§çš„ targets åˆ—è¡¨ã€‚è¯¥èµ„æºé€šè¿‡ Labels æ¥é€‰å–å¯¹åº”çš„ Service Endpoint ï¼Œè®© Prometheus Server é€šè¿‡é€‰å–çš„ Service æ¥è·å– Metrics ä¿¡æ¯ã€‚\nServiceï¼š Service èµ„æºä¸»è¦ç”¨æ¥å¯¹åº” Kubernetes é›†ç¾¤ä¸­çš„ Metrics Server Pod ï¼Œæ¥æä¾›ç»™ ServiceMonitor é€‰å–è®© Prometheus Server æ¥è·å–ä¿¡æ¯ã€‚ç®€å•çš„è¯´å°±æ˜¯ Prometheus Node Exporter Service ã€Mysql Exporter Service ç­‰ç­‰ã€‚\nAlertmanagerï¼š Alertmanager ä¹Ÿæ˜¯ä¸€ä¸ªè‡ªå®šä¹‰èµ„æºç±»å‹ï¼Œç”± Operator æ ¹æ®èµ„æºæè¿°å†…å®¹æ¥éƒ¨ç½² Alertmanager é›†ç¾¤\nå®‰è£…å‰é¡»çŸ¥ åœ¨k8sä¸­éƒ¨ç½²Prometheusç›‘æ§çš„æ–¹æ³• é€šå¸¸åœ¨k8sä¸­éƒ¨ç½² prometheus ç›‘æ§å¯ä»¥é‡‡å–çš„æ–¹æ³•æœ‰ä»¥ä¸‹ä¸‰ç§\né€šè¿‡yamlæ‰‹åŠ¨éƒ¨ç½² operatoréƒ¨ç½² é€šè¿‡helm chartéƒ¨ç½² kube-prometheus å…¼å®¹è¯´æ˜ kube-prometheus stack Kubernetes 1.18 Kubernetes 1.19 Kubernetes 1.20 Kubernetes 1.21 release-0.5 âœ” âœ— âœ— âœ— release-0.6 âœ— âœ” âœ— âœ— release-0.7 âœ— âœ” âœ” âœ— release-0.8 âœ— âœ— âœ” âœ” HEAD âœ— âœ— âœ” âœ” ç¯å¢ƒå‚æ•° ç³»ç»Ÿå‚æ•°ï¼š\nKube-promethues ç‰ˆæœ¬ï¼š 0.7.0\nKubernetes ç‰ˆæœ¬ï¼š v1.19.5\né¡¹ç›® Github åœ°å€ï¼š https://github.com/coreos/kube-prometheus\næ‹‰å– kube-prometheus 0.7 å…ˆä» Github ä¸Šå°†æºç æ‹‰å–ä¸‹æ¥ï¼Œåˆ©ç”¨æºç é¡¹ç›®å·²ç»å†™å¥½çš„ kubernetes çš„ yaml æ–‡ä»¶è¿›è¡Œä¸€ç³»åˆ—é›†æˆé•œåƒçš„å®‰è£…ï¼Œå¦‚ grafana ã€prometheus ç­‰ç­‰ã€‚\n1 wget https://github.com/prometheus-operator/kube-prometheus/archive/refs/tags/v0.7.0.zip è§£å‹\n1 cd kube-prometheus-0.7.0/ yaml æ–‡ä»¶åˆ†ç±» ç”±äºå®ƒçš„æ–‡ä»¶éƒ½å­˜æ”¾åœ¨é¡¹ç›®æºç çš„ manifests æ–‡ä»¶å¤¹ä¸‹ï¼Œæ‰€ä»¥éœ€è¦è¿›å…¥å…¶ä¸­è¿›è¡Œå¯åŠ¨è¿™äº› kubernetes åº”ç”¨ yaml æ–‡ä»¶ã€‚åˆç”±äºè¿™äº›æ–‡ä»¶å †æ”¾åœ¨ä¸€èµ·ï¼Œä¸åˆ©äºåˆ†ç±»å¯åŠ¨ï¼Œæ‰€ä»¥è¿™é‡Œå°†å®ƒä»¬åˆ†ç±»ã€‚\nè¿›å…¥æºç çš„ manifests æ–‡ä»¶å¤¹ï¼š\n1 cd manifests/ åˆ›å»ºæ–‡ä»¶å¤¹å¹¶ä¸”å°† yaml æ–‡ä»¶åˆ†ç±»ï¼š\n1 2 3 4 5 6 7 8 9 10 11 # åˆ›å»ºæ–‡ä»¶å¤¹ mkdir -p node-exporter alertmanager grafana kube-state-metrics prometheus serviceMonitor adapter # ç§»åŠ¨ yaml æ–‡ä»¶ï¼Œè¿›è¡Œåˆ†ç±»åˆ°å„ä¸ªæ–‡ä»¶å¤¹ä¸‹ mv *-serviceMonitor* serviceMonitor/ mv grafana-* grafana/ mv kube-state-metrics-* kube-state-metrics/ mv alertmanager-* alertmanager/ mv node-exporter-* node-exporter/ mv prometheus-adapter* adapter/ mv prometheus-* prometheus/ åŸºæœ¬ç›®å½•ç»“æ„å¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 [root@master kube-prometheus-0.7.0]# tree manifests/ manifests/ |-- adapter | |-- prometheus-adapter-apiService.yaml | |-- prometheus-adapter-clusterRoleAggregatedMetricsReader.yaml | |-- prometheus-adapter-clusterRoleBindingDelegator.yaml | |-- prometheus-adapter-clusterRoleBinding.yaml | |-- prometheus-adapter-clusterRoleServerResources.yaml | |-- prometheus-adapter-clusterRole.yaml | |-- prometheus-adapter-configMap.yaml | |-- prometheus-adapter-deployment.yaml | |-- prometheus-adapter-roleBindingAuthReader.yaml | |-- prometheus-adapter-serviceAccount.yaml | `-- prometheus-adapter-service.yaml |-- alertmanager | |-- alertmanager-alertmanager.yaml | |-- alertmanager-secret.yaml | |-- alertmanager-serviceAccount.yaml | `-- alertmanager-service.yaml |-- grafana | |-- grafana-dashboardDatasources.yaml | |-- grafana-dashboardDefinitions.yaml | |-- grafana-dashboardSources.yaml | |-- grafana-deployment.yaml | |-- grafana-serviceAccount.yaml | `-- grafana-service.yaml |-- kube-state-metrics | |-- kube-state-metrics-clusterRoleBinding.yaml | |-- kube-state-metrics-clusterRole.yaml | |-- kube-state-metrics-deployment.yaml | |-- kube-state-metrics-serviceAccount.yaml | `-- kube-state-metrics-service.yaml |-- node-exporter | |-- node-exporter-clusterRoleBinding.yaml | |-- node-exporter-clusterRole.yaml | |-- node-exporter-daemonset.yaml | |-- node-exporter-serviceAccount.yaml | `-- node-exporter-service.yaml |-- prometheus | |-- prometheus-clusterRoleBinding.yaml | |-- prometheus-clusterRole.yaml | |-- prometheus-prometheus.yaml | |-- prometheus-roleBindingConfig.yaml | |-- prometheus-roleBindingSpecificNamespaces.yaml | |-- prometheus-roleConfig.yaml | |-- prometheus-roleSpecificNamespaces.yaml | |-- prometheus-rules.yaml | |-- prometheus-serviceAccount.yaml | `-- prometheus-service.yaml |-- serviceMonitor | |-- alertmanager-serviceMonitor.yaml | |-- grafana-serviceMonitor.yaml | |-- kube-state-metrics-serviceMonitor.yaml | |-- node-exporter-serviceMonitor.yaml | |-- prometheus-adapter-serviceMonitor.yaml | |-- prometheus-operator-serviceMonitor.yaml | |-- prometheus-serviceMonitorApiserver.yaml | |-- prometheus-serviceMonitorCoreDNS.yaml | |-- prometheus-serviceMonitorKubeControllerManager.yaml | |-- prometheus-serviceMonitorKubelet.yaml | |-- prometheus-serviceMonitorKubeScheduler.yaml | `-- prometheus-serviceMonitor.yaml `-- setup |-- 0namespace-namespace.yaml |-- prometheus-operator-0alertmanagerConfigCustomResourceDefinition.yaml |-- prometheus-operator-0alertmanagerCustomResourceDefinition.yaml |-- prometheus-operator-0podmonitorCustomResourceDefinition.yaml |-- prometheus-operator-0probeCustomResourceDefinition.yaml |-- prometheus-operator-0prometheusCustomResourceDefinition.yaml |-- prometheus-operator-0prometheusruleCustomResourceDefinition.yaml |-- prometheus-operator-0servicemonitorCustomResourceDefinition.yaml |-- prometheus-operator-0thanosrulerCustomResourceDefinition.yaml |-- prometheus-operator-clusterRoleBinding.yaml |-- prometheus-operator-clusterRole.yaml |-- prometheus-operator-deployment.yaml |-- prometheus-operator-serviceAccount.yaml `-- prometheus-operator-service.yaml ä¿®æ”¹ Service ç«¯å£è®¾ç½® ä¿®æ”¹ prometheus-service.yaml æ–‡ä»¶\n1 vim prometheus/prometheus-service.yaml ä¿®æ”¹ prometheus Service ç«¯å£ç±»å‹ä¸º NodePortï¼Œè®¾ç½® NodePort ç«¯å£ä¸º 30100ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 apiVersion: v1 kind: Service metadata: labels: prometheus: k8s name: prometheus-k8s namespace: monitoring spec: type: NodePort # å¢åŠ é…ç½® ports: - name: web port: 9090 targetPort: web nodePort: 30100 # å¢åŠ é…ç½® selector: app: prometheus prometheus: k8s sessionAffinity: ClientIP ä¿®æ”¹ Grafana Service ä¿®æ”¹ grafana-service.yaml æ–‡ä»¶ï¼š\n1 vim grafana/grafana-service.yaml 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 apiVersion: v1 kind: Service metadata: labels: app: grafana name: grafana namespace: monitoring spec: type: NodePort # å¢åŠ é…ç½® ports: - name: http port: 3000 targetPort: http nodePort: 30101 # å¢åŠ é…ç½® selector: app: grafana å®‰è£…Prometheus Operator æ‰€æœ‰æ–‡ä»¶éƒ½åœ¨ manifests ç›®å½•ä¸‹æ‰§è¡Œã€‚ å®‰è£… Operator 1 kubectl apply -f setup/ æŸ¥çœ‹ Podï¼Œç­‰ pod åˆ›å»ºèµ·æ¥åœ¨è¿›è¡Œä¸‹ä¸€æ­¥ï¼š\n1 2 3 [root@master manifests]# kubectl get pods -n monitoring NAME READY STATUS RESTARTS AGE prometheus-operator-7649c7454f-q5f2r 2/2 Running 0 50s è¿™ä¼šåˆ›å»ºä¸€ä¸ªåä¸º monitoring çš„å‘½åç©ºé—´ï¼Œä»¥åŠç›¸å…³çš„ CRD èµ„æºå¯¹è±¡å£°æ˜å’Œ Prometheus Operator æ§åˆ¶å™¨ã€‚å‰é¢ä¸­æˆ‘ä»¬ä»‹ç»è¿‡ CRD å’Œ Operator çš„ä½¿ç”¨ï¼Œå½“æˆ‘ä»¬å£°æ˜å®Œ CRD è¿‡åï¼Œå°±å¯ä»¥æ¥è‡ªå®šä¹‰èµ„æºæ¸…å•äº†ï¼Œä½†æ˜¯è¦è®©æˆ‘ä»¬å£°æ˜çš„è‡ªå®šä¹‰èµ„æºå¯¹è±¡ç”Ÿæ•ˆå°±éœ€è¦å®‰è£…å¯¹åº”çš„ Operator æ§åˆ¶å™¨ï¼Œè¿™é‡Œæˆ‘ä»¬éƒ½å·²ç»å®‰è£…äº†ï¼Œæ‰€ä»¥æ¥ä¸‹æ¥å°±å¯ä»¥æ¥ç”¨ CRD åˆ›å»ºçœŸæ­£çš„è‡ªå®šä¹‰èµ„æºå¯¹è±¡äº†ã€‚å…¶å®åœ¨ manifests ç›®å½•ä¸‹é¢çš„å°±æ˜¯æˆ‘ä»¬è¦å»åˆ›å»ºçš„ Prometheus ã€Alertmanager ä»¥åŠå„ç§ç›‘æ§å¯¹è±¡çš„èµ„æºæ¸…å•ã€‚\nå®‰è£…å…¶å®ƒç»„ä»¶ æ²¡æœ‰ç‰¹æ®Šçš„å®šåˆ¶éœ€æ±‚æˆ‘ä»¬å¯ä»¥ç›´æ¥ä¸€é”®å®‰è£…ï¼š\n1 2 3 4 5 6 7 kubectl apply -f adapter/ kubectl apply -f alertmanager/ kubectl apply -f node-exporter/ kubectl apply -f kube-state-metrics/ kubectl apply -f grafana/ kubectl apply -f prometheus/ kubectl apply -f serviceMonitor/ æŸ¥çœ‹ Pod çŠ¶æ€ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 [root@master manifests]# kubectl get pods -n monitoring NAME READY STATUS RESTARTS AGE alertmanager-main-0 2/2 Running 0 16m alertmanager-main-1 2/2 Running 0 16m alertmanager-main-2 2/2 Running 0 16m grafana-6f777cf998-sv4mz 1/1 Running 0 16m kube-state-metrics-587bfd4f97-mhj94 3/3 Running 0 16m node-exporter-cgbl2 2/2 Running 0 16m node-exporter-k9fqg 2/2 Running 0 16m prometheus-adapter-69b8496df6-954s6 1/1 Running 0 16m prometheus-k8s-0 2/2 Running 0 16m prometheus-k8s-1 2/2 Running 0 16m prometheus-operator-7649c7454f-q5f2r 2/2 Running 0 16m æŸ¥çœ‹ Prometheus \u0026amp; Grafana æŸ¥çœ‹ Prometheus æ‰“å¼€åœ°å€ï¼šhttp://node_ip:30100 æŸ¥çœ‹ Prometheus é‡‡é›†çš„ç›®æ ‡ï¼Œçœ‹å…¶å„ä¸ªé‡‡é›†æœåŠ¡çŠ¶æ€æœ‰æ²¡æœ‰é”™è¯¯ã€‚\næŸ¥çœ‹ Grafana æ‰“å¼€åœ°å€ï¼šhttp://node_ip:30101 æŸ¥çœ‹ Grafana å›¾è¡¨ï¼Œçœ‹å…¶ Kubernetes é›†ç¾¤æ˜¯å¦èƒ½æ­£å¸¸æ˜¾ç¤ºã€‚\né»˜è®¤ç”¨æˆ·åï¼šadmin\né»˜è®¤å¯†ç ï¼šadmin\næŸ¥çœ‹ä»ªè¡¨ç›˜ï¼š\nå¾®ä¿¡æŠ¥è­¦ è·å–ä¼ä¸š ID ç­‰ä¿¡æ¯ é…ç½®å‰å‚æ•°è¯´æ˜:\nè·å–ä¼ä¸šå¾®ä¿¡çš„å¯¹å¤–æ¥å£\nä¼ä¸šå¾®ä¿¡çš„ secret_api\nä¼ä¸šä¿¡æ¯ID corp_id\nwechat_api_url:\nä¼ä¸šå¾®ä¿¡å¯¹å¤–æ¥å£ https://qyapi.weixin.qq.com/cgi-bin/\napi_secret: åº”ç”¨ç®¡ç†\u0026ndash;åº”ç”¨\u0026ndash;ä½ çš„åº”ç”¨\nagent_id: åº”ç”¨ç®¡ç†\u0026ndash;åº”ç”¨\u0026ndash;ä½ çš„åº”ç”¨\ncorp_id: æˆ‘çš„ä¼ä¸š\u0026ndash; ä¼ä¸šä¿¡æ¯\u0026ndash;ä¸‹æ‹‰è‡³æœ€ä¸‹\u0026ndash;ä¼ä¸šID\nto_party: é€šè®¯å½•\u0026ndash;ç»„\u0026ndash;éƒ¨é—¨ID\nto_userï¼š é€šè®¯å½•\u0026ndash;ç»„\u0026ndash;éƒ¨é—¨ID\u0026ndash;é€‰ä¸­æ¥æ”¶å‘Šè­¦çš„äºº\u0026ndash;è´¦å·\nç™»å½•ä¼ä¸šå¾®ä¿¡\u0026ndash;åº”ç”¨ç®¡ç†\u0026ndash;åº”ç”¨\u0026ndash;ä¸‹æ‹‰åˆ°æœ€ä¸‹é¢ç‚¹å‡» åˆ›å»ºåº”ç”¨\néœ€è¦è®°ç€ AgentIdã€Secret\nç‚¹å‡» æˆ‘çš„ä¼ä¸š\u0026ndash; ä¼ä¸šä¿¡æ¯\u0026ndash;ä¸‹æ‹‰è‡³æœ€ä¸‹\u0026ndash;ä¼ä¸šID\né€šè®¯å½•\u0026ndash;ç»„\u0026ndash;éƒ¨é—¨ID\nå°†å¯¹åº”ç§˜é’¥å¡«å…¥yaml é…ç½® alertmanager.yaml\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 cd alertmanager/ cat \u0026lt;\u0026lt;EOF \u0026gt; alertmanager.yaml global: resolve_timeout: 5m receivers: - name: wechat wechat_configs: - agent_id: \u0026#34;1000005\u0026#34; api_secret: _UCBVsNYTQwY75TFKQ4V6jj2YQKsyxxxxx corp_id: ww022bebbed74fxxxx send_resolved: true to_user: xuewenlong route: group_by: - job group_interval: 5m group_wait: 30s receiver: wechat repeat_interval: 1h routes: - match: alertname: Watchdog receiver: wechat templates: - /etc/alertmanager/config/wechat.tmpl EOF ä¸ªæ€§åŒ–é…ç½®æŠ¥è­¦æ¨¡æ¿ï¼Œç½‘ä¸Šæœ‰å¾ˆå¤šä¾‹å­\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 cat \u0026lt;\u0026lt;EOF \u0026gt; wechat.tmpl {{ define \u0026#34;wechat.default.message\u0026#34; }} {{- if gt (len .Alerts.Firing) 0 -}} {{- range $index, $alert := .Alerts -}} {{- if eq $index 0 }} ==========å¼‚å¸¸å‘Šè­¦========== å‘Šè­¦ç±»å‹: {{ $alert.Labels.alertname }} å‘Šè­¦çº§åˆ«: {{ $alert.Labels.severity }} å‘Šè­¦è¯¦æƒ…: {{ $alert.Annotations.message }}{{ $alert.Annotations.description}};{{$alert.Annotations.summary}} æ•…éšœæ—¶é—´: {{ ($alert.StartsAt.Add 28800e9).Format \u0026#34;2006-01-02 15:04:05\u0026#34; }} {{- if gt (len $alert.Labels.instance) 0 }} å®ä¾‹ä¿¡æ¯: {{ $alert.Labels.instance }} {{- end }} {{- if gt (len $alert.Labels.namespace) 0 }} å‘½åç©ºé—´: {{ $alert.Labels.namespace }} {{- end }} {{- if gt (len $alert.Labels.node) 0 }} èŠ‚ç‚¹ä¿¡æ¯: {{ $alert.Labels.node }} {{- end }} {{- if gt (len $alert.Labels.pod) 0 }} å®ä¾‹åç§°: {{ $alert.Labels.pod }} {{- end }} ============END============ {{- end }} {{- end }} {{- end }} {{- if gt (len .Alerts.Resolved) 0 -}} {{- range $index, $alert := .Alerts -}} {{- if eq $index 0 }} ==========å¼‚å¸¸æ¢å¤========== å‘Šè­¦ç±»å‹: {{ $alert.Labels.alertname }} å‘Šè­¦çº§åˆ«: {{ $alert.Labels.severity }} å‘Šè­¦è¯¦æƒ…: {{ $alert.Annotations.message }}{{ $alert.Annotations.description}};{{$alert.Annotations.summary}} æ•…éšœæ—¶é—´: {{ ($alert.StartsAt.Add 28800e9).Format \u0026#34;2006-01-02 15:04:05\u0026#34; }} æ¢å¤æ—¶é—´: {{ ($alert.EndsAt.Add 28800e9).Format \u0026#34;2006-01-02 15:04:05\u0026#34; }} {{- if gt (len $alert.Labels.instance) 0 }} å®ä¾‹ä¿¡æ¯: {{ $alert.Labels.instance }} {{- end }} {{- if gt (len $alert.Labels.namespace) 0 }} å‘½åç©ºé—´: {{ $alert.Labels.namespace }} {{- end }} {{- if gt (len $alert.Labels.node) 0 }} èŠ‚ç‚¹ä¿¡æ¯: {{ $alert.Labels.node }} {{- end }} {{- if gt (len $alert.Labels.pod) 0 }} å®ä¾‹åç§°: {{ $alert.Labels.pod }} {{- end }} ============END============ {{- end }} {{- end }} {{- end }} {{- end }} EOF éƒ¨ç½²secret 1 2 kubectl delete secret alertmanager-main -n monitoring kubectl create secret generic alertmanager-main --from-file=alertmanager.yaml --from-file=wechat.tmpl -n monitoring æŸ¥çœ‹å®¹å™¨ä¸­çš„é…ç½®æ–‡ä»¶\n1 2 3 kubectl exec -it alertmanager-main-0 -n monitoring /bin/sh ls /etc/alertmanager/config/ # å¦‚æœèƒ½çœ‹åˆ° alertmanager.yaml wechat.tmpl ä¸¤ä¸ªæ–‡ä»¶å°±è¯æ˜æ›´æ–°æˆåŠŸäº†ã€‚ éªŒè¯ æ›´æ–°åå°±ä¼šæ”¶åˆ°æ¶ˆæ¯\nè‡ªåŠ¨å‘ç°è§„åˆ™ åœ¨k8sä¸­ä¼šéƒ¨ç½²éå¸¸å¤šçš„serviceå’Œ podï¼Œå¦‚æœè¦ä¸€ä¸ªä¸€ä¸ªæ‰‹åŠ¨çš„æ·»åŠ ç›‘æ§éå¸¸éº»çƒ¦ä¸”ä¸å¿…è¦ï¼Œä½¿ç”¨è‡ªåŠ¨å‘ç°æœºåˆ¶ã€‚å°†ä¼šå‡å°‘å¾ˆå¤šä¸å¿…è¦çš„å·¥ä½œã€‚\nåˆ›å»º yaml æ–‡ä»¶ åˆ›å»ºprometheus-additional.yaml\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 cd prometheus/ cat prometheus-additional.yaml - job_name: \u0026#39;kubernetes-service-endpoints\u0026#39; kubernetes_sd_configs: - role: endpoints relabel_configs: - source_labels: [__meta_kubernetes_service_annotation_prometheus_io_scrape] action: keep regex: true - source_labels: [__meta_kubernetes_service_annotation_prometheus_io_scheme] action: replace target_label: __scheme__ regex: (https?) - source_labels: [__meta_kubernetes_service_annotation_prometheus_io_path] action: replace target_label: __metrics_path__ regex: (.+) - source_labels: [__address__, __meta_kubernetes_service_annotation_prometheus_io_port] action: replace target_label: __address__ regex: ([^:]+)(?::\\d+)?;(\\d+) replacement: $1:$2 - action: labelmap regex: __meta_kubernetes_service_label_(.+) - source_labels: [__meta_kubernetes_namespace] action: replace target_label: kubernetes_namespace - source_labels: [__meta_kubernetes_service_name] action: replace target_label: kubernetes_name è¦æƒ³è‡ªåŠ¨è¢«å‘ç°ï¼Œåªéœ€è¦åœ¨ service çš„é…ç½®æ¸…å•ä¸­åŠ ä¸Š annotations: prometheus.io/scrape=true ã€‚\nåˆ›å»º secret ç„¶åç”¨è¿™ä¸ªæ–‡ä»¶åˆ›å»ºä¸€ä¸ª secret\n1 kubectl -n monitoring create secret generic additional-config --from-file=prometheus-additional.yaml ä¿®æ”¹ prometheus é…ç½®æ¸…å• åœ¨ prometheus çš„é…ç½®æ¸…å•ä¸­æ·»åŠ ä»¥ä¸‹é…ç½®ï¼š\n1 2 3 additionalScrapeConfigs: name: additional-config key: prometheus-additional.yaml å…·ä½“å¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 cat prometheus-prometheus.yaml apiVersion: monitoring.coreos.com/v1 kind: Prometheus metadata: labels: app.kubernetes.io/component: prometheus app.kubernetes.io/name: prometheus app.kubernetes.io/part-of: kube-prometheus app.kubernetes.io/version: 2.26.0 prometheus: k8s name: k8s namespace: monitoring spec: alerting: alertmanagers: - apiVersion: v2 name: alertmanager-main namespace: monitoring port: web externalLabels: {} image: quay.io/prometheus/prometheus:v2.26.0 nodeSelector: kubernetes.io/os: linux podMetadata: labels: app.kubernetes.io/component: prometheus app.kubernetes.io/name: prometheus app.kubernetes.io/part-of: kube-prometheus app.kubernetes.io/version: 2.26.0 podMonitorNamespaceSelector: {} podMonitorSelector: {} probeNamespaceSelector: {} probeSelector: {} replicas: 2 resources: requests: memory: 400Mi ruleSelector: matchLabels: prometheus: k8s role: alert-rules securityContext: fsGroup: 2000 runAsNonRoot: true runAsUser: 1000 additionalScrapeConfigs: # æ·»åŠ å†…å®¹ name: additional-configs # æ·»åŠ å†…å®¹ key: prometheus-additional.yaml # æ·»åŠ å†…å®¹ serviceAccountName: prometheus-k8s serviceMonitorNamespaceSelector: {} serviceMonitorSelector: {} version: 2.26.0 ç„¶åæ›´æ–° prometheus çš„é…ç½®\n1 kubectl apply -f prometheus-prometheus.yaml ä¿®æ”¹ clusterrole æƒé™ Prometheus ç»‘å®šäº†ä¸€ä¸ªåä¸º prometheus-k8s çš„ ServiceAccount å¯¹è±¡ï¼Œè€Œè¿™ä¸ªå¯¹è±¡ç»‘å®šçš„æ˜¯ä¸€ä¸ªåä¸º prometheus-k8s çš„ ClusterRole ï¼ˆprometheus-clusterRole.yamlï¼‰\néœ€è¦è®©ä»–æœ‰ Service æˆ–è€… Pod çš„ list æƒé™\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 cat prometheus-clusterRole.yaml apiVersion: rbac.authorization.k8s.io/v1 kind: ClusterRole metadata: name: prometheus-k8s rules: - apiGroups: - \u0026#34;\u0026#34; resources: - nodes/metrics - configmaps verbs: - get - apiGroups: - \u0026#34;\u0026#34; resources: - nodes - pods - services - endpoints - nodes/proxy verbs: - get - list - watch - nonResourceURLs: - /metrics verbs: - get æ›´æ–° clusterrole\n1 kubectl apply -f prometheus-clusterRole.yaml ç­‰å¾…ä¸€æ®µæ—¶é—´å¯ä»¥å‘ç°è‡ªåŠ¨å‘ç°æˆåŠŸ\né…ç½®è‡ªåŠ¨å‘ç°ï¼Œé¦–å…ˆ annotations é‡Œéœ€è¦é…ç½® prometheus.io/scrape=true ï¼Œå…¶æ¬¡ä½ çš„åº”ç”¨è¦æœ‰ exporter å»æ”¶é›†ä¿¡æ¯ã€‚\n1 2 3 4 annotations: prometheus.io/scrape: \u0026#39;true\u0026#39; # æ·»åŠ å†…å®¹ prometheus.io/path: \u0026#39;/metrics\u0026#39; # æ·»åŠ å†…å®¹ prometheus.io/port: \u0026#39;80\u0026#39; # æ·»åŠ å†…å®¹ æ¯”å¦‚ Nginx é…ç½®ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 apiVersion: apps/v1 kind: Deployment metadata: name: nginx-deployment labels: app: nginx annotations: prometheus.io/scrape: \u0026#39;true\u0026#39; prometheus.io/path: \u0026#39;/metrics\u0026#39; prometheus.io/port: \u0026#39;80\u0026#39; spec: replicas: 2 selector: matchLabels: app: nginx minReadySeconds: 1 progressDeadlineSeconds: 60 revisionHistoryLimit: 2 strategy: type: RollingUpdate rollingUpdate: maxSurge: 1 maxUnavailable: 1 template: metadata: labels: app: nginx annotations: prometheus.io/scrape: \u0026#39;true\u0026#39; prometheus.io/path: \u0026#39;/metrics\u0026#39; prometheus.io/port: \u0026#39;80\u0026#39; spec: containers: - name: nginx image: wenlongxue/nginx:waynex-ce995b8 imagePullPolicy: Always ports: - containerPort: 80 resources: requests: memory: \u0026#34;100Mi\u0026#34; cpu: \u0026#34;100m\u0026#34; limits: memory: \u0026#34;100Mi\u0026#34; cpu: \u0026#34;100m\u0026#34; readinessProbe: httpGet: path: /index.html port: 80 periodSeconds: 5 timeoutSeconds: 3 successThreshold: 1 failureThreshold: 30 --- apiVersion: v1 kind: Service metadata: name: nginx-service labels: app: nginx annotations: prometheus.io/scrape: \u0026#39;true\u0026#39; # æ·»åŠ å†…å®¹ prometheus.io/path: \u0026#39;/metrics\u0026#39; # æ·»åŠ å†…å®¹ prometheus.io/port: \u0026#39;80\u0026#39; # æ·»åŠ å†…å®¹ spec: selector: app: nginx ports: - name: nginx-port protocol: TCP port: 80 nodePort: 30081 targetPort: 80 type: NodePort é’‰é’‰å‘Šè­¦ é…ç½® prometheus-operate é’‰é’‰å‘Šè­¦\nåˆ›å»º webhook çš„é…ç½®æ–‡ä»¶ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 # vim dingTalk-webhook-configmap.yml apiVersion: v1 kind: ConfigMap metadata: namespace: monitoring name: dingtalk-webhook-config data: config.yml: | # Request timeout timeout: 5s ## Customizable templates path templates: - /etc/prometheus-webhook-dingtalk/templates/*.tmpl ## You can also override default template using `default_message` ## The following example to use the \u0026#39;legacy\u0026#39; template from v0.3.0 # default_message: # title: \u0026#39;{{ template \u0026#34;legacy.title\u0026#34; . }}\u0026#39; # text: \u0026#39;{{ template \u0026#34;legacy.content\u0026#34; . }}\u0026#39; ## Targets, previously was known as \u0026#34;profiles\u0026#34; targets: guiji: url: https://oapi.dingtalk.com/robot/send?access_token=1a3ed90fefa5d1a8f4d61f063xxxxxxxxxxxxxxxxx message: title: \u0026#39;{{ template \u0026#34;ding.link.title\u0026#34; . }}\u0026#39; text: \u0026#39;{{ template \u0026#34;ding.link.content\u0026#34; . }}\u0026#39; mention: all: true mobiles: [\u0026#39;153xxxxxxxx\u0026#39;] åˆ›å»ºå‘Šè­¦æ¨¡æ¿é…ç½®æ–‡ä»¶ï¼š 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 # vim dingTalk-webhook-template.yml apiVersion: v1 kind: ConfigMap metadata: namespace: monitoring name: dingtalk-webhook-template data: template.tmpl: | {{ define \u0026#34;__subject\u0026#34; }}[{{ .Status | toUpper }}{{ if eq .Status \u0026#34;firing\u0026#34; }}:{{ .Alerts.Firing | len }}{{ end }}] {{ .GroupLabels.SortedPairs.Values | join \u0026#34; \u0026#34; }} {{ if gt (len .CommonLabels) (len .GroupLabels) }}({{ with .CommonLabels.Remove .GroupLabels.Names }}{{ .Values | join \u0026#34; \u0026#34; }}{{ end }}){{ end }}{{ end }} {{ define \u0026#34;__alertmanagerURL\u0026#34; }}{{ .ExternalURL }}/#/alerts?receiver={{ .Receiver }}{{ end }} {{ define \u0026#34;__text_alert_list\u0026#34; }}{{ range . }} **Labels** {{ range .Labels.SortedPairs }}\u0026amp;gt; - {{ .Name }}: {{ .Value | markdown | html }} {{ end }} **Annotations** {{ range .Annotations.SortedPairs }}\u0026amp;gt; - {{ .Name }}: {{ .Value | markdown | html }} {{ end }} **Source:** [{{ .GeneratorURL }}]({{ .GeneratorURL }}) {{ end }}{{ end }} {{ define \u0026#34;default.__text_alert_list\u0026#34; }}{{ range . }} --- **å‘Šè­¦çº§åˆ«:** {{ .Labels.severity | upper }} **è¿è¥å›¢é˜Ÿ:** {{ .Labels.team | upper }} **è§¦å‘æ—¶é—´:** {{ dateInZone \u0026#34;2006.01.02 15:04:05\u0026#34; (.StartsAt) \u0026#34;Asia/Shanghai\u0026#34; }} **äº‹ä»¶ä¿¡æ¯:** {{ range .Annotations.SortedPairs }}\u0026amp;gt; - {{ .Name }}: {{ .Value | markdown | html }} {{ end }} **äº‹ä»¶æ ‡ç­¾:** {{ range .Labels.SortedPairs }}{{ if and (ne (.Name) \u0026#34;severity\u0026#34;) (ne (.Name) \u0026#34;summary\u0026#34;) (ne (.Name) \u0026#34;team\u0026#34;) }}\u0026amp;gt; - {{ .Name }}: {{ .Value | markdown | html }} {{ end }}{{ end }} {{ end }} {{ end }} {{ define \u0026#34;default.__text_alertresovle_list\u0026#34; }}{{ range . }} --- **å‘Šè­¦çº§åˆ«:** {{ .Labels.severity | upper }} **è¿è¥å›¢é˜Ÿ:** {{ .Labels.team | upper }} **è§¦å‘æ—¶é—´:** {{ dateInZone \u0026#34;2006.01.02 15:04:05\u0026#34; (.StartsAt) \u0026#34;Asia/Shanghai\u0026#34; }} **ç»“æŸæ—¶é—´:** {{ dateInZone \u0026#34;2006.01.02 15:04:05\u0026#34; (.EndsAt) \u0026#34;Asia/Shanghai\u0026#34; }} **äº‹ä»¶ä¿¡æ¯:** {{ range .Annotations.SortedPairs }}\u0026amp;gt; - {{ .Name }}: {{ .Value | markdown | html }} {{ end }} **äº‹ä»¶æ ‡ç­¾:** {{ range .Labels.SortedPairs }}{{ if and (ne (.Name) \u0026#34;severity\u0026#34;) (ne (.Name) \u0026#34;summary\u0026#34;) (ne (.Name) \u0026#34;team\u0026#34;) }}\u0026amp;gt; - {{ .Name }}: {{ .Value | markdown | html }} {{ end }}{{ end }} {{ end }} {{ end }} {{/* Default */}} {{ define \u0026#34;default.title\u0026#34; }}{{ template \u0026#34;__subject\u0026#34; . }}{{ end }} {{ define \u0026#34;default.content\u0026#34; }}#### \\[{{ .Status | toUpper }}{{ if eq .Status \u0026#34;firing\u0026#34; }}:{{ .Alerts.Firing | len }}{{ end }}\\] **[{{ index .GroupLabels \u0026#34;alertname\u0026#34; }}]({{ template \u0026#34;__alertmanagerURL\u0026#34; . }})** {{ if gt (len .Alerts.Firing) 0 -}} ![è­¦æŠ¥ å›¾æ ‡](https://ss0.bdstatic.com/70cFuHSh_Q1YnxGkpoWK1HF6hhy/it/u=3626076420,1196179712\u0026amp;amp;fm=15\u0026amp;amp;gp=0.jpg) **====ä¾¦æµ‹åˆ°æ•…éšœ====** {{ template \u0026#34;default.__text_alert_list\u0026#34; .Alerts.Firing }} {{- end }} {{ if gt (len .Alerts.Resolved) 0 -}} {{ template \u0026#34;default.__text_alertresovle_list\u0026#34; .Alerts.Resolved }} {{- end }} {{- end }} {{/* Legacy */}} {{ define \u0026#34;legacy.title\u0026#34; }}{{ template \u0026#34;__subject\u0026#34; . }}{{ end }} {{ define \u0026#34;legacy.content\u0026#34; }}#### \\[{{ .Status | toUpper }}{{ if eq .Status \u0026#34;firing\u0026#34; }}:{{ .Alerts.Firing | len }}{{ end }}\\] **[{{ index .GroupLabels \u0026#34;alertname\u0026#34; }}]({{ template \u0026#34;__alertmanagerURL\u0026#34; . }})** {{ template \u0026#34;__text_alert_list\u0026#34; .Alerts.Firing }} {{- end }} {{/* Following names for compatibility */}} {{ define \u0026#34;ding.link.title\u0026#34; }}{{ template \u0026#34;default.title\u0026#34; . }}{{ end }} {{ define \u0026#34;ding.link.content\u0026#34; }}{{ template \u0026#34;default.content\u0026#34; . }}{{ end }} åˆ›å»º webhook çš„èµ„æºé…ç½®æ¸…å• 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 # cat dingTalk-webhook-deployment.yml apiVersion: extensions/v1beta1 kind: Deployment metadata: namespace: monitoring name: dingtalk-webhook labels: app: dingtalk-webhook spec: selector: matchLabels: app: dingtalk-webhook replicas: 1 template: metadata: labels: app: dingtalk-webhook spec: containers: - name: dingtalk-webhook image: harbor.zsf.com/public/prometheus-webhook-dingtalk args: - --config.file=/etc/prometheus-webhook-dingtalk/config.yml #- --ding.profile=guiji=https://oapi.dingtalk.com/robot/send?access_token=5752a9d10727165d116b883b4e7d312b781a3ed90 ports: - containerPort: 8060 protocol: TCP volumeMounts: - mountPath: \u0026#34;/etc/prometheus-webhook-dingtalk\u0026#34; name: dingtalk-webhook-confing subPath: config.yml - mountPath: \u0026#34;/etc/prometheus-webhook-dingtalk/templates\u0026#34; name: dingtalk-webhook-template subPath: template.tmpl volumes: - name: dingtalk-webhook-confing configMap: name: dingtalk-webhook-config - name: dingtalk-webhook-template configMap: name: dingtalk-webhook-template --- apiVersion: v1 kind: Service metadata: namespace: monitoring name: dingtalk-webhook labels: app: dingtalk-webhook spec: selector: app: dingtalk-webhook ports: - name: http port: 8060 targetPort: 8060 protocol: TCP è§£å†³ControllerManagerã€Schedulerç›‘æ§é—®é¢˜ é»˜è®¤å®‰è£…åè®¿é—® prometheus ï¼Œä¼šå‘ç°æœ‰ä»¥ä¸‹æœ‰ä¸‰ä¸ªæŠ¥è­¦ï¼š\nWatchdog ã€KubeControllerManagerDown ã€ KubeSchedulerDown\nWatchdog æ˜¯ä¸€ä¸ªæ­£å¸¸çš„æŠ¥è­¦ï¼Œè¿™ä¸ªå‘Šè­¦çš„ä½œç”¨æ˜¯ï¼šå¦‚æœ alermanger æˆ–è€… prometheus æœ¬èº«æŒ‚æ‰äº†å°±å‘ä¸å‡ºå‘Šè­¦äº†ï¼Œå› æ­¤ä¸€èˆ¬ä¼šé‡‡ç”¨å¦ä¸€ä¸ªç›‘æ§æ¥ç›‘æ§ prometheus ï¼Œæˆ–è€…è‡ªå®šä¹‰ä¸€ä¸ªæŒç»­ä¸æ–­çš„å‘Šè­¦é€šçŸ¥ï¼Œå“ªä¸€å¤©è¿™ä¸ªå‘Šè­¦é€šçŸ¥ä¸å‘äº†ï¼Œè¯´æ˜ç›‘æ§å‡ºç°é—®é¢˜äº†ã€‚ prometheus operator å·²ç»è€ƒè™‘äº†è¿™ä¸€ç‚¹ï¼Œæœ¬èº«æºå¸¦ä¸€ä¸ª watchdog ï¼Œä½œä¸ºå¯¹è‡ªèº«çš„ç›‘æ§ã€‚\nå¦‚æœéœ€è¦å…³é—­ï¼Œåˆ é™¤æˆ–æ³¨é‡Šæ‰ Watchdog éƒ¨åˆ†\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 vim kube-prometheus-prometheusRule.yaml ... - name: general.rules rules: - alert: TargetDown annotations: message: \\\u0026#39;xxx\\\u0026#39; expr: 100 * (count(up == 0) BY (job, namespace, service) / count(up) BY (job, namespace, service)) \u0026gt; 10 for: 10m labels: severity: warning # - alert: Watchdog # annotations: # message: | # This is an alert meant to ensure that the entire alerting pipeline is functional. # This alert is always firing, therefore it should always be firing in Alertmanager # and always fire against a receiver. There are integrations with various notification # mechanisms that send a notification when this alert is not firing. For example the # \u0026#34;DeadMansSnitch\u0026#34; integration in PagerDuty. # expr: vector(1) # labels: # severity: none å…¶ä»–ä¸¤ä¸ª KubeControllerManagerDown ã€ KubeSchedulerDown éœ€è¦è‡ªå®šä¹‰ç›‘æ§ï¼Œåœ¨è¿™è¾¹ä¸è¯¦ç»†è¯´ã€‚\nä½œè€…ï¼šSREè¿ç»´åšå®¢\nåšå®¢åœ°å€ï¼šhttps://www.cnsre.cn\næ–‡ç« åœ°å€ï¼šhttps://www.cnsre.cn/posts/210621550392/\nç›¸å…³è¯é¢˜ï¼šhttps://www.cnsre.cn/tags/prometheus/\n","description":"Prometheus æ˜¯ä¸€å¥—å¼€æºçš„ç›‘æ§ \u0026 æŠ¥è­¦ \u0026 æ—¶é—´åºåˆ—æ•°æ®åº“çš„ç»„åˆ,æˆ‘ä»¬ä½¿ç”¨ Kubernetes 1.19 æ¥å®‰è£… Prometheus-Opratorã€‚","id":54,"section":"posts","tags":["kubernetes","prometheus"],"title":"Kubernetes 1.19 å®‰è£… Prometheus-Oprator","uri":"http://www.cnsre.cn:80/posts/210621550392/"},{"content":" ä½œè€…ï¼šSREè¿ç»´åšå®¢\nåšå®¢åœ°å€ï¼šhttps://www.cnsre.cn\næ–‡ç« åœ°å€ï¼šhttps://www.cnsre.cn/posts/210609216215/\nç›¸å…³è¯é¢˜ï¼šhttps://www.cnsre.cn/tags/kubernetes/\nå­˜æ´»æ¢é’ˆ Kubeletä½¿ç”¨liveness probeï¼ˆå­˜æ´»æ¢é’ˆï¼‰æ¥ç¡®å®šä½•æ—¶é‡å¯å®¹å™¨ã€‚ä¾‹å¦‚ï¼Œå½“åº”ç”¨ç¨‹åºå¤„äºè¿è¡ŒçŠ¶æ€ä½†æ— æ³•åšè¿›ä¸€æ­¥æ“ä½œï¼Œlivenessæ¢é’ˆå°†æ•è·åˆ°deadlockï¼Œé‡å¯å¤„äºè¯¥çŠ¶æ€ä¸‹çš„å®¹å™¨ï¼Œä½¿åº”ç”¨ç¨‹åºåœ¨å­˜åœ¨bugçš„æƒ…å†µä¸‹ä¾ç„¶èƒ½å¤Ÿç»§ç»­è¿è¡Œä¸‹å»ï¼ˆè°çš„ç¨‹åºè¿˜æ²¡å‡ ä¸ªbugå‘¢ï¼‰ã€‚\nKubeletä½¿ç”¨readiness probeï¼ˆå°±ç»ªæ¢é’ˆï¼‰æ¥ç¡®å®šå®¹å™¨æ˜¯å¦å·²ç»å°±ç»ªå¯ä»¥æ¥å—æµé‡ã€‚åªæœ‰å½“Podä¸­çš„å®¹å™¨éƒ½å¤„äºå°±ç»ªçŠ¶æ€æ—¶kubeletæ‰ä¼šè®¤å®šè¯¥Podå¤„äºå°±ç»ªçŠ¶æ€ã€‚è¯¥ä¿¡å·çš„ä½œç”¨æ˜¯æ§åˆ¶å“ªäº›Podåº”è¯¥ä½œä¸ºserviceçš„åç«¯ã€‚å¦‚æœPodå¤„äºéå°±ç»ªçŠ¶æ€ï¼Œé‚£ä¹ˆå®ƒä»¬å°†ä¼šè¢«ä»serviceçš„load balancerä¸­ç§»é™¤ã€‚\né‡å¯ç­–ç•¥ ï¼ˆRestartPolicy ï¼‰ Alwaysï¼šå½“å®¹å™¨ç»ˆæ­¢é€€å‡ºåï¼Œæ€»æ˜¯é‡å¯å®¹å™¨ï¼Œé»˜è®¤ç­–ç•¥ã€‚ OnFailureï¼šå½“å®¹å™¨å¼‚å¸¸é€€å‡ºï¼ˆé€€å‡ºçŠ¶æ€ç é0ï¼‰æ—¶ï¼Œæ‰é‡å¯å®¹å™¨ã€‚ Neverï¼šå½“å®¹å™¨ç»ˆæ­¢é€€å‡ºï¼Œä»ä¸é‡å¯å®¹å™¨ã€‚ probeæœ‰ä»¥ä¸‹ä¸¤ç§ç±»å‹ï¼š\nlivenessProbeï¼šå¦‚æœæ£€æŸ¥å¤±è´¥ï¼Œå°†æ€æ­»å®¹å™¨ï¼Œæ ¹æ®Podçš„restartPolicyæ¥æ“ä½œã€‚ readinessProbeï¼š å¦‚æœæ£€æŸ¥å¤±è´¥ï¼ŒKubernetesä¼šæŠŠPodä»service endpointsä¸­å‰”é™¤ Probeæ”¯æŒä»¥ä¸‹ä¸‰ç§æ£€æŸ¥æ–¹æ³•ï¼š\nhttpGetï¼šå‘é€HTTPè¯·æ±‚ï¼Œè¿”å›200-400èŒƒå›´çŠ¶æ€ç ä¸ºæˆåŠŸã€‚ execï¼šæ‰§è¡ŒShellå‘½ä»¤è¿”å›çŠ¶æ€ç æ˜¯0ä¸ºæˆåŠŸã€‚ tcpSocketï¼šå‘èµ·TCP Socketå»ºç«‹æˆåŠŸã€‚ å¥åº·æ£€æŸ¥çš„æ–¹æ³• httpGet tcpSocket æ–¹æ³•ä¸€ httpGet nginxä½¿ç”¨httpGetå¥åº·æ£€æŸ¥çš„æ–¹æ³•\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 å¤åˆ¶ä»£ç apiVersion: apps/v1 kind: Deployment metadata: name: nginx spec: replicas: 1 selector: matchLabels: app: nginx minReadySeconds: 1 progressDeadlineSeconds: 60 revisionHistoryLimit: 2 strategy: type: RollingUpdate rollingUpdate: maxSurge: 1 maxUnavailable: 1 template: metadata: name: nginx labels: app: nginx spec: containers: - name: nginx image: nginx:1.19 ports: - containerPort: 80 resources: requests: memory: \u0026#34;500Mi\u0026#34; cpu: \u0026#34;250m\u0026#34; limits: memory: \u0026#34;500Mi\u0026#34; cpu: \u0026#34;500m\u0026#34; livenessProbe: httpGet: path: /index.html port: 80 initialDelaySeconds: 10 #podå¯åŠ¨10ç§’æ‰§è¡Œç¬¬ä¸€æ¬¡æ£€æŸ¥ periodSeconds: 5 #ç¬¬ä¸€æ¬¡æ£€æŸ¥åæ¯éš”5ç§’æ£€æŸ¥ä¸€æ¬¡** volumeMounts: - name: html mountPath: /usr/share/nginx/html volumes: - name: html hostPath: path: /home/k8s/data/nginx --- apiVersion: v1 kind: Service metadata: name: nginx spec: type: NodePort ports: - port: 8080 nodePort: 30080 selector: app: nginx æ–¹æ³•äºŒï¼štcpSocket nginxä½¿ç”¨tcpSocketå¥åº·æ£€æŸ¥çš„æ–¹æ³•\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 apiVersion: apps/v1 kind: Deployment metadata: name: nginx spec: replicas: 1 selector: matchLabels: app: nginx minReadySeconds: 1 progressDeadlineSeconds: 60 revisionHistoryLimit: 2 strategy: type: RollingUpdate rollingUpdate: maxSurge: 1 maxUnavailable: 1 template: metadata: name: nginx labels: app: nginx spec: containers: - name: nginx image: nginx:1.19 ports: - containerPort: 80 resources: requests: memory: \u0026#34;500Mi\u0026#34; cpu: \u0026#34;250m\u0026#34; limits: memory: \u0026#34;500Mi\u0026#34; cpu: \u0026#34;500m\u0026#34; livenessProbe: tcpSocket: port: 80 initialDelaySeconds: 10 periodSeconds: 5 volumeMounts: - name: html mountPath: /usr/share/nginx/html volumes: - name: html hostPath: path: /home/k8s/data/nginx --- apiVersion: v1 kind: Service metadata: name: nginx spec: type: NodePort ports: - port: 8080 nodePort: 30080 selector: app: nginx æ»šåŠ¨å‘å¸ƒ k8såˆ›å»ºå‰¯æœ¬åº”ç”¨ç¨‹åºçš„æœ€ä½³æ–¹æ³•å°±æ˜¯éƒ¨ç½²(Deployment)ï¼Œéƒ¨ç½²è‡ªåŠ¨åˆ›å»ºå‰¯æœ¬é›†(ReplicaSet)ï¼Œå‰¯æœ¬é›†å¯ä»¥ç²¾ç¡®åœ°æ§åˆ¶æ¯æ¬¡æ›¿æ¢çš„Podæ•°é‡ï¼Œä»è€Œå¯ä»¥å¾ˆå¥½çš„å®ç°æ»šåŠ¨æ›´æ–°ã€‚å…·ä½“æ¥è¯´ï¼Œk8sæ¯æ¬¡ä½¿ç”¨ä¸€ä¸ªæ–°çš„å‰¯æœ¬æ§åˆ¶å™¨(replication controller)æ¥æ›¿æ¢å·²å­˜åœ¨çš„å‰¯æœ¬æ§åˆ¶å™¨ï¼Œä»è€Œå§‹ç»ˆä½¿ç”¨ä¸€ä¸ªæ–°çš„Podæ¨¡æ¿æ¥æ›¿æ¢æ—§çš„podæ¨¡æ¿ã€‚\næ­¥éª¤å¦‚ä¸‹:\nåˆ›å»ºä¸€ä¸ªæ–°çš„replication controllerã€‚ å¢åŠ æˆ–å‡å°‘podå‰¯æœ¬æ•°é‡ï¼Œç›´åˆ°æ»¡è¶³å½“å‰æ‰¹æ¬¡æœŸæœ›çš„æ•°é‡ã€‚ åˆ é™¤æ—§çš„replication controller å®æˆ˜ç»ƒä¹  Qï¼š å‡å¦‚ä¸€ä¸ªnginxæœåŠ¡ èµ·äº†3ä¸ªpodï¼Œæˆ‘åšäº†å‘ç‰ˆï¼Œç„¶åæ²¡æƒ³åˆ°è¿™æ¬¡å‘ç‰ˆæœ‰é—®é¢˜ã€‚å¥åº·æ£€æŸ¥ä¹Ÿæ²¡è¿‡ï¼è¿™ç§æƒ…å†µä¸‹å‘å¸ƒï¼Œä¼šæŠŠ3ä¸ªpodéƒ½æ›¿æ¢æ‰ï¼Ÿè¿˜æ˜¯è¯´æ£€æµ‹åˆ°ä¸€ä¸ªpodå¥åº·æ£€æŸ¥æœ‰é—®é¢˜ï¼Œä¸‹ä¸€ä¸ªå°±podå°±ä¸å‘å¸ƒäº†ï¼Ÿå·²ç»å‘å¸ƒçš„podä¼šå¯¹å¤–æä¾›æœåŠ¡å—ï¼Ÿ\nå¸¦ç€è¿™äº›ç–‘é—®ï¼Œæ¥åšä¸ªå®éªŒã€‚\nåˆ›å»ºnginxæœåŠ¡ åˆ›å»ºä¸€ä¸ªnginxæœåŠ¡ï¼Œé€‰æ‹©1ä¸ªå‰¯æœ¬ã€‚\nå…·ä½“yamlå¦‚ä¸‹\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 apiVersion: apps/v1 kind: Deployment metadata: name: nginx-deployment labels: app: nginx spec: replicas: 1 selector: matchLabels: app: nginx minReadySeconds: 1 progressDeadlineSeconds: 60 revisionHistoryLimit: 2 strategy: type: RollingUpdate rollingUpdate: maxSurge: 1 maxUnavailable: 1 template: metadata: labels: app: nginx spec: containers: - name: nginx image: wenlongxue/xxxx:6f965dd # éœ€è¦ä¿®æ”¹è‡ªå·±çš„é•œåƒ imagePullPolicy: Always ports: - containerPort: 80 resources: requests: memory: \u0026#34;600Mi\u0026#34; cpu: \u0026#34;250m\u0026#34; limits: memory: \u0026#34;600Mi\u0026#34; cpu: \u0026#34;500m\u0026#34; readinessProbe: httpGet: path: /actuator/health port: 80 periodSeconds: 5 timeoutSeconds: 3 successThreshold: 1 failureThreshold: 30 --- apiVersion: v1 kind: Service metadata: name: nginx-service labels: app: nginx spec: selector: app: nginx ports: - name: nginx-port protocol: TCP port: 80 nodePort: 30081 targetPort: 80 type: NodePort æŸ¥çœ‹å½“å‰pod å¦èµ·ä¸€ä¸ªçª—å£\n1 kubectl get pods -l app=nginx -w å‘å¸ƒå¥åº·æ£€æŸ¥æœ‰é—®é¢˜çš„ç‰ˆæœ¬ ä¿®æ”¹yaml\nå°†å‰¯æœ¬æ•°replicas: 1 è®¾ç½®ä¸ºreplicas: 3\nå°†å¥åº·æ£€æŸ¥path: / ä¿®æ”¹ä¸ºä¸€ä¸ªä¸å­˜åœ¨çš„é™æ€é¡µé¢ï¼Œè¿™æ ·å¥åº·æ£€æŸ¥å°±ä¸è¿‡äº†ã€‚\nå…·ä½“ä»£ç \n1 2 3 4 5 6 7 8 9 10 11 12 ... spec: replicas: 3 ... readinessProbe: httpGet: path:Â /cnsre.html port:Â 80 periodSeconds:Â 5 timeoutSeconds:Â 3 successThreshold:Â 1 failureThreshold:Â 30 æ‰§è¡Œæ»šåŠ¨å‘å¸ƒå¹¶è§‚å¯Ÿ æ‰§è¡Œæ›´æ–°æ»šåŠ¨å‘å¸ƒ\n1 kubectl apply -f nginx.yaml æŸ¥çœ‹podçŠ¶æ€\n1 kubectl get pods -l app=nginx è§‚å¯Ÿæ»šåŠ¨æ›´æ–°è¿‡ç¨‹\n1 kubectl get pods -l app=nginx -w å¥åº·æ£€æŸ¥æ»šåŠ¨å‘å¸ƒå®éªŒç»“æœ é€šè¿‡å®éªŒå‘ç°ï¼Œæ–°å‘ç‰ˆï¼Œå¥åº·æ£€æŸ¥æ²¡è¿‡ï¼è¿™ç§æƒ…å†µä¸‹å‘å¸ƒï¼Œä¼šæŠŠä¹‹å‰çš„podä¿ç•™ï¼Œæ–°å‘å¸ƒçš„pod è¿è¡Œï¼Œä½†æ˜¯ä¸å¯¹å¤–æä¾›æœåŠ¡ã€‚\nå¸¦ç€è¿™äº›ç–‘é—®ï¼Œæ¥åšä¸ªå®éªŒã€‚\nä½œè€…ï¼šSREè¿ç»´åšå®¢\nåšå®¢åœ°å€ï¼šhttps://www.cnsre.cn\næ–‡ç« åœ°å€ï¼šhttps://www.cnsre.cn/posts/210609216215/\nç›¸å…³è¯é¢˜ï¼šhttps://www.cnsre.cn/tags/kubernetes/\n","description":"kubernetes/k8s ä½¿ç”¨æ¢é’ˆå­˜è´§å®ç°ä¸åœæœºæ»šåŠ¨å‘å¸ƒ","id":55,"section":"posts","tags":["kubernetes"],"title":"k8s å­˜æ´»æ¢é’ˆï¼Œæ»šåŠ¨æ›´æ–°","uri":"http://www.cnsre.cn:80/posts/210609216215/"},{"content":" ä½œè€…ï¼šSREè¿ç»´åšå®¢\nåšå®¢åœ°å€ï¼šhttps://www.cnsre.cn\næ–‡ç« åœ°å€ï¼šhttps://www.cnsre.cn/posts/210608607296/\nç›¸å…³è¯é¢˜ï¼šhttps://www.cnsre.cn/tags/kubernetes/\nç¯å¢ƒéœ€æ±‚ kubernetes æœªå®‰è£…å‚è€ƒä½¿ç”¨kubeadmå®‰è£…kubernetes 1.21 jenkins github/gitee/gitlab é™æ€é¡µé¢ é•œåƒä»“åº“(æˆ‘ä½¿ç”¨çš„ hub.docker)\nå¦‚æœä½ æœªå‡†å¤‡å¥½çš„ä»¥ä¸Šç¯å¢ƒï¼Œç‚¹å‡»é“¾æ¥å‚è€ƒæ–‡ç« è¿›è¡Œå®‰è£…ã€‚ å®‰è£… jenkins æˆ‘è¿™è¾¹çš„jenkinsæ˜¯å°†jenkins å®‰è£…åœ¨äº†k8sçš„å®¿ä¸»æœºä¸­ï¼Œå¹¶æ²¡æœ‰ç”¨å®¹å™¨è¿è¡Œã€‚\nå®‰è£…JDK 1 yum install -y java å®‰è£…jenkins æ–¹æ³•1 æ–¹æ³•2 æ–¹æ³•1 æ·»åŠ Jenkinsåº“åˆ°yumåº“ï¼ŒJenkinså°†ä»è¿™é‡Œä¸‹è½½å®‰è£…ã€‚\n1 2 3 wget -O /etc/yum.repos.d/jenkins.repo http://pkg.jenkins-ci.org/redhat/jenkins.repo rpm --import https://jenkins-ci.org/redhat/jenkins-ci.org.key yum install -y jenkins æ–¹æ³•2 å¦‚æœä¸èƒ½å®‰è£…å°±åˆ°å®˜ç½‘ä¸‹è½½jenkisçš„rmpåŒ…ï¼Œå®˜ç½‘åœ°å€ï¼ˆhttp://pkg.jenkins-ci.org/redhat-stable/ï¼‰\n1 2 wget http://pkg.jenkins-ci.org/redhat-stable/jenkins-2.7.3-1.1.noarch.rpm rpm -ivh jenkins-2.7.3-1.1.noarch.rpm å®‰è£… Jenkins æ’ä»¶ å®‰è£…å®Œjenkinsï¼Œè®¾ç½®å®Œå¯†ç ï¼Œå®‰è£…å®Œé»˜è®¤æ’ä»¶ä»¥åï¼Œæˆ‘ä»¬éœ€è¦å®‰è£… Pipeline éœ€è¦çš„æ’ä»¶ã€‚\nä¿®æ”¹ä¸‹æ–¹åœ°å€ ç„¶åæäº¤\n1 2 3 # jenkinsæ’ä»¶æ¸…åå¤§å­¦é•œåƒåœ°å€ https://mirrors.tuna.tsinghua.edu.cn/jenkins/updates/update-center.json http://mirror.xmission.com/jenkins/updates/update-center.json å®‰è£…gitå’Œpipelineæ’ä»¶\nåˆ›å»º jenkins Pipeline æ·»åŠ Pipeline job\nåˆ›å»ºjobå®Œæˆåï¼Œé…ç½®Pipeline scriptï¼Œç‚¹å‡»Pipelineè¯­æ³•ï¼Œæ¥è‡ªåŠ¨ç”Ÿæˆæˆ‘ä»¬éœ€è¦çš„é…ç½®ã€‚\nå¦‚ä¸‹å›¾ï¼Œæˆ‘ä»¬Gitæ–¹å¼ï¼Œé…ç½®Gitä»“åº“åœ°å€ï¼Œå†æ·»åŠ è®¤è¯ç›¸å…³ã€‚\nåˆ†åˆ«å¡«å†™github/giteeçš„è´¦å·å’Œå¯†ç ç„¶åç‚¹å‡»æ·»åŠ \næ·»åŠ å®Œæˆåï¼Œåœ¨å‡­æ®ä¸­ï¼Œé€‰ä¸­åˆšæ·»åŠ çš„ï¼Œè¿™æ ·æˆ‘ä»¬å°±å¯ä»¥ç”ŸæˆPipelineè„šæœ¬äº†ã€‚ç‚¹å‡»ä¸‹æ–¹ç”Ÿæˆæµæ°´çº¿è„šæœ¬ï¼Œç„¶åå¤åˆ¶æ–¹æ¡†å†…çš„å†…å®¹ã€‚\nç¼–å†™ Pipeline è„šæœ¬ ç¼–å†™æˆ‘ä»¬æ‰€éœ€è¦çš„Pipelineè„šæœ¬å¦‚ä¸‹ï¼Œå°†å…¶ç²˜è´´åˆ°scriptçš„æ‹‰å–ä»£ç æ¨¡å—ä¸­ï¼Œå¹¶ä¿®æ”¹åˆ†æ”¯masterä¸º${branch}ï¼Œå…¶ä»–æ¨¡å—å†…å®¹è‡ªè¡Œç¼–å†™ã€‚\næ–‡ç« é“¾æ¥\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 node { stage(\u0026#39;æ‹‰å–ä»£ç \u0026#39;) { //æ‹‰å–ä»£ç  git credentialsId: \u0026#39;b34b0b78-e99f-4aa0-a616-xxxxxx\u0026#39;, url: \u0026#39;https://gitee.com/xxx/xxxxx.git\u0026#39; //å°†ä¸Šæ¬¡æ‰“åŒ…çš„ä»£åˆ é™¤æ‰ï¼Œå¹¶å°†æ‹‰å–åˆ°çš„æ–°ä»£ç ä»£ç æ‰“åŒ… sh \u0026#39;rm -rf *.tar \u0026amp;\u0026amp; cd waynex \u0026amp;\u0026amp; tar -cvf waynex.tar ./*\u0026#39; script { //è·å–comment id env.imageTag = sh (script: \u0026#39;git rev-parse --short HEAD ${GIT_COMMIT}\u0026#39;, returnStdout: true).trim() } } // é¡¹ç›®æ‰“åŒ…åˆ°é•œåƒå¹¶æ¨é€åˆ°é•œåƒä»“åº“ stage(\u0026#39;æ„å»ºæ¨é€é•œåƒ\u0026#39;) { sh \u0026#39;\u0026#39;\u0026#39; REPOSITORY=wenlongxue/waynex:${imageTag} cat \u0026gt; Dockerfile \u0026lt;\u0026lt; EOF FROM wenlongxue/nginx ## è®¾ç½®å·¥ä½œç›®å½• WORKDIR /usr/local/nginx/html RUN rm -rf /usr/local/nginx/html/* ADD waynex/waynex.tar /usr/local/nginx/html/ ## å¯åŠ¨nginx CMD [\u0026#34;nginx\u0026#34;,\u0026#34;-g\u0026#34;,\u0026#34;daemon off;\u0026#34;] EOF docker build -t waynex:${imageTag} . docker login docker tag waynex:${imageTag} $REPOSITORY docker push $REPOSITORY \u0026#39;\u0026#39;\u0026#39; } // éƒ¨ç½²åˆ°k8sä¸»æœº stage(\u0026#39;éƒ¨ç½²åˆ°k8s\u0026#39;) { sh \u0026#39;\u0026#39;\u0026#39; REPOSITORY=wenlongxue/waynex:${imageTag} cat \u0026gt; nginx.yaml \u0026lt;\u0026lt; EOF apiVersion: apps/v1 #ä¸k8sé›†ç¾¤ç‰ˆæœ¬æœ‰å…³ï¼Œä½¿ç”¨ kubectl api-versions å³å¯æŸ¥çœ‹å½“å‰é›†ç¾¤æ”¯æŒçš„ç‰ˆæœ¬ kind: Deployment #è¯¥é…ç½®çš„ç±»å‹ï¼Œæˆ‘ä»¬ä½¿ç”¨çš„æ˜¯ Deployment metadata: #è¯‘åä¸ºå…ƒæ•°æ®ï¼Œå³ Deployment çš„ä¸€äº›åŸºæœ¬å±æ€§å’Œä¿¡æ¯ name: nginx-deployment #Deployment çš„åç§° labels: #æ ‡ç­¾ï¼Œå¯ä»¥çµæ´»å®šä½ä¸€ä¸ªæˆ–å¤šä¸ªèµ„æºï¼Œå…¶ä¸­keyå’Œvalueå‡å¯è‡ªå®šä¹‰ï¼Œå¯ä»¥å®šä¹‰å¤šç»„ï¼Œç›®å‰ä¸éœ€è¦ç†è§£ app: nginx #ä¸ºè¯¥Deploymentè®¾ç½®keyä¸ºappï¼Œvalueä¸ºnginxçš„æ ‡ç­¾ spec: #è¿™æ˜¯å…³äºè¯¥Deploymentçš„æè¿°ï¼Œå¯ä»¥ç†è§£ä¸ºä½ æœŸå¾…è¯¥Deploymentåœ¨k8sä¸­å¦‚ä½•ä½¿ç”¨ replicas: 1 #ä½¿ç”¨è¯¥Deploymentåˆ›å»ºä¸€ä¸ªåº”ç”¨ç¨‹åºå®ä¾‹ selector: #æ ‡ç­¾é€‰æ‹©å™¨ï¼Œä¸ä¸Šé¢çš„æ ‡ç­¾å…±åŒä½œç”¨ï¼Œç›®å‰ä¸éœ€è¦ç†è§£ matchLabels: #é€‰æ‹©åŒ…å«æ ‡ç­¾app:nginxçš„èµ„æº app: nginx minReadySeconds: 1 progressDeadlineSeconds: 60 revisionHistoryLimit: 2 strategy: type: RollingUpdate rollingUpdate: maxSurge: 1 maxUnavailable: 1 template: #è¿™æ˜¯é€‰æ‹©æˆ–åˆ›å»ºçš„Podçš„æ¨¡æ¿ metadata: #Podçš„å…ƒæ•°æ® labels: #Podçš„æ ‡ç­¾ï¼Œä¸Šé¢çš„selectorå³é€‰æ‹©åŒ…å«æ ‡ç­¾app:nginxçš„Pod app: nginx spec: #æœŸæœ›Podå®ç°çš„åŠŸèƒ½ï¼ˆå³åœ¨podä¸­éƒ¨ç½²ï¼‰ containers: #ç”Ÿæˆcontainerï¼Œä¸dockerä¸­çš„containeræ˜¯åŒä¸€ç§ - name: nginx #containerçš„åç§° image: \\$REPOSITORY #ä½¿ç”¨ä¹‹å‰æ¨é€çš„é•œåƒ imagePullPolicy: Always #æ€»æ˜¯æ‹‰å–æœ€æ–°çš„ã€‚é»˜è®¤ä¸º,æœ¬åœ°æœ‰åˆ™ä½¿ç”¨æœ¬åœ°é•œåƒ,ä¸æ‹‰å– ports: - containerPort: 80 resources: requests: memory: \u0026#34;600Mi\u0026#34; cpu: \u0026#34;250m\u0026#34; limits: memory: \u0026#34;600Mi\u0026#34; cpu: \u0026#34;500m\u0026#34; livenessProbe: httpGet: path: / port: 80 initialDelaySeconds: 10 #podå¯åŠ¨10ç§’æ‰§è¡Œç¬¬ä¸€æ¬¡æ£€æŸ¥ periodSeconds: 5 #ç¬¬ä¸€æ¬¡æ£€æŸ¥åæ¯éš”5ç§’æ£€æŸ¥ä¸€æ¬¡ --- apiVersion: v1 kind: Service metadata: #è¯‘åä¸ºå…ƒæ•°æ®ï¼Œå³Deploymentçš„ä¸€äº›åŸºæœ¬å±æ€§å’Œä¿¡æ¯ name: nginx-service #Service çš„åç§° labels: #æ ‡ç­¾ï¼Œå¯ä»¥çµæ´»å®šä½ä¸€ä¸ªæˆ–å¤šä¸ªèµ„æºï¼Œå…¶ä¸­keyå’Œvalueå‡å¯è‡ªå®šä¹‰ï¼Œå¯ä»¥å®šä¹‰å¤šç»„ app: nginx #ä¸ºè¯¥Deploymentè®¾ç½®keyä¸ºappï¼Œvalueä¸ºnginxçš„æ ‡ç­¾ spec: #è¿™æ˜¯å…³äºè¯¥ Service çš„å®šä¹‰ï¼Œæè¿°äº† Service å¦‚ä½•é€‰æ‹© Podï¼Œå¦‚ä½•è¢«è®¿é—® selector: #æ ‡ç­¾é€‰æ‹©å™¨ app: nginx #é€‰æ‹©åŒ…å«æ ‡ç­¾ app:nginx çš„ Pod ports: - name: nginx-port #ç«¯å£çš„åå­— protocol: TCP #åè®®ç±»å‹ TCP/UDP port: 80 #é›†ç¾¤å†…çš„å…¶ä»–å®¹å™¨ç»„å¯é€šè¿‡ 80 ç«¯å£è®¿é—® Service nodePort: 30081 #é€šè¿‡ä»»æ„èŠ‚ç‚¹çš„ 30080 ç«¯å£è®¿é—® Service targetPort: 80 #å°†è¯·æ±‚è½¬å‘åˆ°åŒ¹é… Pod çš„ 80 ç«¯å£ type: NodePort #Seriveçš„ç±»å‹ï¼ŒClusterIP/NodePort/LoaderBalancer EOF sudo kubectl apply -f nginx.yaml \u0026#39;\u0026#39;\u0026#39; } } åœ¨Pipelineè„šæœ¬é‡Œé¢æˆ‘ä»¬æŒ‡å®šäº†ä¸€ä¸ªbranchå‚æ•°ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦ä¼ é€’ä¸€ä¸ªå‚æ•°å˜é‡ï¼Œè¿™é‡Œæˆ‘ä»¬é€‰æ‹©å‚æ•°åŒ–æ„å»ºï¼Œé»˜è®¤å€¼ä¸ºmasteråˆ†æ”¯ã€‚\nç„¶åä¿å­˜é…ç½®ã€‚\nå‘å¸ƒæµ‹è¯• å›åˆ°ä¸»ç•Œé¢ï¼Œæˆ‘ä»¬å¼€å§‹æ„å»ºä»»åŠ¡ï¼š\næŸ¥çœ‹æ„å»ºæˆåŠŸåçš„å›¾å½¢æ„å»ºè¿‡ç¨‹ï¼š\né€šè¿‡æµè§ˆå™¨æ¥è®¿é—®é¡¹ç›®ï¼šhttp://ä½ çš„IP:30080/\nè‡³æ­¤éƒ¨ç½²å®Œæˆ\nä½œè€…ï¼šSREè¿ç»´åšå®¢\nåšå®¢åœ°å€ï¼šhttps://www.cnsre.cn\næ–‡ç« åœ°å€ï¼šhttps://www.cnsre.cn/posts/210608607296/\nç›¸å…³è¯é¢˜ï¼šhttps://www.cnsre.cn/tags/kubernetes/\n","description":"k8s jenkins Pipelineéƒ¨ç½²Nginx","id":56,"section":"posts","tags":["jenkins","pipeline","kubernetes"],"title":"kubernetesä½¿ç”¨jenkins Pipeline éƒ¨ç½²Nginx","uri":"http://www.cnsre.cn:80/posts/210608607296/"},{"content":" ä½œè€…ï¼šSREè¿ç»´åšå®¢\nåšå®¢åœ°å€ï¼šhttps://www.cnsre.cn\næ–‡ç« åœ°å€ï¼šhttps://www.cnsre.cn/posts/210603028465/\nç›¸å…³è¯é¢˜ï¼šhttps://www.cnsre.cn/tags/kubernetes/\néƒ¨ç½² nginx Deployment å¦‚æœä½ å·²ç»å®Œæˆäº†Kubernetesçš„æ­å»ºï¼Œé‚£æˆ‘è·Ÿæˆ‘ä¸€å—æ¥éƒ¨ç½²ç¬¬ä¸€ä¸ªåº”ç”¨ç¨‹åºå§ã€‚æ²¡æœ‰å®Œæˆ Kubernetes é›†ç¾¤æ­å»ºçš„ï¼Œè¯·å‚è€ƒæ–‡æ¡£ ä½¿ç”¨ kubeadm å®‰è£… kubernetes 1.21\nåˆ›å»º YAML æ–‡ä»¶ åˆ›å»ºæ–‡ä»¶ nginx-deploy.yamlï¼Œå†…å®¹å¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 apiVersion: apps/v1\t#ä¸k8sé›†ç¾¤ç‰ˆæœ¬æœ‰å…³ï¼Œä½¿ç”¨ kubectl api-versions å³å¯æŸ¥çœ‹å½“å‰é›†ç¾¤æ”¯æŒçš„ç‰ˆæœ¬ kind: Deployment\t#è¯¥é…ç½®çš„ç±»å‹ï¼Œæˆ‘ä»¬ä½¿ç”¨çš„æ˜¯ Deployment metadata:\t#è¯‘åä¸ºå…ƒæ•°æ®ï¼Œå³ Deployment çš„ä¸€äº›åŸºæœ¬å±æ€§å’Œä¿¡æ¯ name: nginx-deployment\t#Deployment çš„åç§° labels:\t#æ ‡ç­¾ï¼Œå¯ä»¥çµæ´»å®šä½ä¸€ä¸ªæˆ–å¤šä¸ªèµ„æºï¼Œå…¶ä¸­keyå’Œvalueå‡å¯è‡ªå®šä¹‰ï¼Œå¯ä»¥å®šä¹‰å¤šç»„ï¼Œç›®å‰ä¸éœ€è¦ç†è§£ app: nginx\t#ä¸ºè¯¥Deploymentè®¾ç½®keyä¸ºappï¼Œvalueä¸ºnginxçš„æ ‡ç­¾ spec:\t#è¿™æ˜¯å…³äºè¯¥Deploymentçš„æè¿°ï¼Œå¯ä»¥ç†è§£ä¸ºä½ æœŸå¾…è¯¥Deploymentåœ¨k8sä¸­å¦‚ä½•ä½¿ç”¨ replicas: 1\t#ä½¿ç”¨è¯¥Deploymentåˆ›å»ºä¸€ä¸ªåº”ç”¨ç¨‹åºå®ä¾‹ selector:\t#æ ‡ç­¾é€‰æ‹©å™¨ï¼Œä¸ä¸Šé¢çš„æ ‡ç­¾å…±åŒä½œç”¨ï¼Œç›®å‰ä¸éœ€è¦ç†è§£ matchLabels: #é€‰æ‹©åŒ…å«æ ‡ç­¾app:nginxçš„èµ„æº app: nginx template:\t#è¿™æ˜¯é€‰æ‹©æˆ–åˆ›å»ºçš„Podçš„æ¨¡æ¿ metadata:\t#Podçš„å…ƒæ•°æ® labels:\t#Podçš„æ ‡ç­¾ï¼Œä¸Šé¢çš„selectorå³é€‰æ‹©åŒ…å«æ ‡ç­¾app:nginxçš„Pod app: nginx spec:\t#æœŸæœ›Podå®ç°çš„åŠŸèƒ½ï¼ˆå³åœ¨podä¸­éƒ¨ç½²ï¼‰ containers:\t#ç”Ÿæˆcontainerï¼Œä¸dockerä¸­çš„containeræ˜¯åŒä¸€ç§ - name: nginx\t#containerçš„åç§° image: nginx:1.7.9\t#ä½¿ç”¨é•œåƒnginx:1.7.9åˆ›å»ºcontainerï¼Œè¯¥containeré»˜è®¤80ç«¯å£å¯è®¿é—® åº”ç”¨ YAML æ–‡ä»¶\n1 kubectl apply -f nginx-deploy.yaml æŸ¥çœ‹éƒ¨ç½²ç»“æœ\n1 2 3 4 5 # æŸ¥çœ‹ Deployment kubectl get deployments # æŸ¥çœ‹ Pod kubectl get pods å¦‚ä¸Šå›¾å¯åˆ†åˆ«æŸ¥çœ‹åˆ°ä¸€ä¸ªåä¸º nginx-deployment çš„ Deployment å’Œä¸€ä¸ªåä¸º nginx-deployment-xxxxxxx çš„ Pod\nkubectl å¸¸ç”¨å‘½ä»¤ kubectl get æ˜¾ç¤ºèµ„æºåˆ—è¡¨\n1 2 3 4 5 6 7 8 9 10 # kubectl get èµ„æºç±»å‹ #è·å–ç±»å‹ä¸ºDeploymentçš„èµ„æºåˆ—è¡¨ kubectl get deployments #è·å–ç±»å‹ä¸ºPodçš„èµ„æºåˆ—è¡¨ kubectl get pods #è·å–ç±»å‹ä¸ºNodeçš„èµ„æºåˆ—è¡¨ kubectl get nodes åç§°ç©ºé—´ åœ¨å‘½ä»¤åå¢åŠ  -A æˆ– \u0026ndash;all-namespaces å¯æŸ¥çœ‹æ‰€æœ‰ åç§°ç©ºé—´ä¸­ çš„å¯¹è±¡ï¼Œä½¿ç”¨å‚æ•° -n å¯æŸ¥çœ‹æŒ‡å®šåç§°ç©ºé—´çš„å¯¹è±¡ï¼Œä¾‹å¦‚\n1 2 3 4 5 # æŸ¥çœ‹æ‰€æœ‰åç§°ç©ºé—´çš„ Deployment kubectl get deployments -A kubectl get deployments --all-namespaces # æŸ¥çœ‹ kube-system åç§°ç©ºé—´çš„ Deployment kubectl get deployments -n kube-system kubectl describe æ˜¾ç¤ºæœ‰å…³èµ„æºçš„è¯¦ç»†ä¿¡æ¯\n1 2 3 4 5 6 7 # kubectl describe èµ„æºç±»å‹ èµ„æºåç§° #æŸ¥çœ‹åç§°ä¸ºnginx-XXXXXXçš„Podçš„ä¿¡æ¯ kubectl describe pod nginx-XXXXXX\t#æŸ¥çœ‹åç§°ä¸ºnginxçš„Deploymentçš„ä¿¡æ¯ kubectl describe deployment nginx\tkubectl logs æŸ¥çœ‹podä¸­çš„å®¹å™¨çš„æ‰“å°æ—¥å¿—\n1 2 3 4 5 # kubectl logs Podåç§° #æŸ¥çœ‹åç§°ä¸ºnginx-pod-XXXXXXXçš„Podå†…çš„å®¹å™¨æ‰“å°çš„æ—¥å¿— #æœ¬æ¡ˆä¾‹ä¸­çš„ nginx-pod æ²¡æœ‰è¾“å‡ºæ—¥å¿—ï¼Œæ‰€ä»¥æ‚¨çœ‹åˆ°çš„ç»“æœæ˜¯ç©ºçš„ kubectl logs -f nginx-pod-XXXXXXX kubectl exec åœ¨podä¸­çš„å®¹å™¨ç¯å¢ƒå†…æ‰§è¡Œå‘½ä»¤\n1 2 3 4 # kubectl exec Podåç§° æ“ä½œå‘½ä»¤ # åœ¨åç§°ä¸ºnginx-pod-xxxxxxçš„Podä¸­è¿è¡Œbash kubectl exec -it nginx-pod-xxxxxx /bin/bash ä¸ºnginx Deployment åˆ›å»º Service åˆ›å»ºæ–‡ä»¶ nginx-service.yaml\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 apiVersion: v1 kind: Service metadata:\t#è¯‘åä¸ºå…ƒæ•°æ®ï¼Œå³Deploymentçš„ä¸€äº›åŸºæœ¬å±æ€§å’Œä¿¡æ¯ name: nginx-service\t#Service çš„åç§° labels:\t#æ ‡ç­¾ï¼Œå¯ä»¥çµæ´»å®šä½ä¸€ä¸ªæˆ–å¤šä¸ªèµ„æºï¼Œå…¶ä¸­keyå’Œvalueå‡å¯è‡ªå®šä¹‰ï¼Œå¯ä»¥å®šä¹‰å¤šç»„ app: nginx\t#ä¸ºè¯¥Deploymentè®¾ç½®keyä¸ºappï¼Œvalueä¸ºnginxçš„æ ‡ç­¾ spec:\t#è¿™æ˜¯å…³äºè¯¥ Service çš„å®šä¹‰ï¼Œæè¿°äº† Service å¦‚ä½•é€‰æ‹© Podï¼Œå¦‚ä½•è¢«è®¿é—® selector:\t#æ ‡ç­¾é€‰æ‹©å™¨ app: nginx\t#é€‰æ‹©åŒ…å«æ ‡ç­¾ app:nginx çš„ Pod ports: - name: nginx-port\t#ç«¯å£çš„åå­— protocol: TCP\t#åè®®ç±»å‹ TCP/UDP port: 80\t#é›†ç¾¤å†…çš„å…¶ä»–å®¹å™¨ç»„å¯é€šè¿‡ 80 ç«¯å£è®¿é—® Service nodePort: 30080 #é€šè¿‡ä»»æ„èŠ‚ç‚¹çš„ 30080 ç«¯å£è®¿é—® Service targetPort: 80\t#å°†è¯·æ±‚è½¬å‘åˆ°åŒ¹é… Pod çš„ 80 ç«¯å£ type: NodePort\t#Seriveçš„ç±»å‹ï¼ŒClusterIP/NodePort/LoaderBalancer æ‰§è¡Œå‘½ä»¤\n1 kubectl apply -f nginx-service.yaml æ£€æŸ¥æ‰§è¡Œç»“æœ\n1 kubectl get services -o wide å¦‚ä¸Šå›¾å¯æŸ¥çœ‹åˆ°åç§°ä¸º nginx-service çš„æœåŠ¡ã€‚\nè®¿é—®æœåŠ¡ 1 curl \u0026lt;ä»»æ„èŠ‚ç‚¹çš„ IP\u0026gt;:30080 ä¼¸ç¼©åº”ç”¨ç¨‹åº ä¼¸ç¼©çš„å®ç°å¯ä»¥é€šè¿‡æ›´æ”¹ nginx-deployment.yaml æ–‡ä»¶ä¸­éƒ¨ç½²çš„ replicasï¼ˆå‰¯æœ¬æ•°ï¼‰æ¥å®Œæˆ\n1 2 spec: replicas: 2 #ä½¿ç”¨è¯¥Deploymentåˆ›å»ºä¸¤ä¸ªåº”ç”¨ç¨‹åºå®ä¾‹ ä¿®æ”¹ nginx-deploy.yaml æ–‡ä»¶ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 apiVersion: apps/v1 #ä¸k8sé›†ç¾¤ç‰ˆæœ¬æœ‰å…³ï¼Œä½¿ç”¨ kubectl api-versions å³å¯æŸ¥çœ‹å½“å‰é›†ç¾¤æ”¯æŒçš„ç‰ˆæœ¬ kind: Deployment #è¯¥é…ç½®çš„ç±»å‹ï¼Œæˆ‘ä»¬ä½¿ç”¨çš„æ˜¯ Deployment metadata: #è¯‘åä¸ºå…ƒæ•°æ®ï¼Œå³ Deployment çš„ä¸€äº›åŸºæœ¬å±æ€§å’Œä¿¡æ¯ name: nginx-deployment #Deployment çš„åç§° labels: #æ ‡ç­¾ï¼Œå¯ä»¥çµæ´»å®šä½ä¸€ä¸ªæˆ–å¤šä¸ªèµ„æºï¼Œå…¶ä¸­keyå’Œvalueå‡å¯è‡ªå®šä¹‰ï¼Œå¯ä»¥å®šä¹‰å¤šç»„ï¼Œç›®å‰ä¸éœ€è¦ç†è§£ app: nginx #ä¸ºè¯¥Deploymentè®¾ç½®keyä¸ºappï¼Œvalueä¸ºnginxçš„æ ‡ç­¾ spec: #è¿™æ˜¯å…³äºè¯¥Deploymentçš„æè¿°ï¼Œå¯ä»¥ç†è§£ä¸ºä½ æœŸå¾…è¯¥Deploymentåœ¨k8sä¸­å¦‚ä½•ä½¿ç”¨ replicas: 2 #ä½¿ç”¨è¯¥Deploymentåˆ›å»ºä¸€ä¸ªåº”ç”¨ç¨‹åºå®ä¾‹ selector: #æ ‡ç­¾é€‰æ‹©å™¨ï¼Œä¸ä¸Šé¢çš„æ ‡ç­¾å…±åŒä½œç”¨ï¼Œç›®å‰ä¸éœ€è¦ç†è§£ matchLabels: #é€‰æ‹©åŒ…å«æ ‡ç­¾app:nginxçš„èµ„æº app: nginx template: #è¿™æ˜¯é€‰æ‹©æˆ–åˆ›å»ºçš„Podçš„æ¨¡æ¿ metadata: #Podçš„å…ƒæ•°æ® labels: #Podçš„æ ‡ç­¾ï¼Œä¸Šé¢çš„selectorå³é€‰æ‹©åŒ…å«æ ‡ç­¾app:nginxçš„Pod app: nginx spec: #æœŸæœ›Podå®ç°çš„åŠŸèƒ½ï¼ˆå³åœ¨podä¸­éƒ¨ç½²ï¼‰ containers: #ç”Ÿæˆcontainerï¼Œä¸dockerä¸­çš„containeræ˜¯åŒä¸€ç§ - name: nginx #containerçš„åç§° image: nginx:1.7.9 #ä½¿ç”¨é•œåƒnginx:1.7.9åˆ›å»ºcontainerï¼Œè¯¥containeré»˜è®¤80ç«¯å£å¯è®¿é—® æ‰§è¡Œå‘½ä»¤\n1 kubectl apply -f nginx-deployment.yaml æŸ¥çœ‹ç»“æœ\n1 watch kubectl get pods -o wide å¦‚ä¸Šå›¾ï¼Œä½ å°†ä¼šçœ‹åˆ°æœ‰ä¸¤ä¸ªåº”ç”¨ç¨‹åºåœ¨è¿è¡Œï¼Œè¿è¡Œäº†å¤šä¸ªåº”ç”¨ç¨‹åºå®ä¾‹ï¼Œå¯ä»¥åœ¨ä¸åœæœºçš„æƒ…å†µä¸‹æ‰§è¡Œæ»šåŠ¨æ›´æ–°ã€‚\næ»šåŠ¨æ›´æ–° æ»šåŠ¨æ›´æ–°å…è®¸ä»¥ä¸‹æ“ä½œï¼š\nå°†åº”ç”¨ç¨‹åºä»å‡†ä¸Šçº¿ç¯å¢ƒå‡çº§åˆ°ç”Ÿäº§ç¯å¢ƒï¼ˆé€šè¿‡æ›´æ–°å®¹å™¨é•œåƒï¼‰ å›æ»šåˆ°ä»¥å‰çš„ç‰ˆæœ¬ æŒç»­é›†æˆå’ŒæŒç»­äº¤ä»˜åº”ç”¨ç¨‹åºï¼Œæ— éœ€åœæœº\nå¦‚æœéœ€è¦æ»šåŠ¨æ›´æ–°æ‰§è¡Œå¦‚ä¸‹å‘½ä»¤å³å¯ 1 kubectl apply -f nginx-deployment.yaml æŸ¥çœ‹è¿‡ç¨‹åŠç»“æœ\næ‰§è¡Œå‘½ä»¤ï¼Œå¯è§‚å¯Ÿåˆ° pod é€ä¸ªè¢«æ›¿æ¢çš„è¿‡ç¨‹ã€‚\n1 watch kubectl get pods -l app=nginx ä½œè€…ï¼šSREè¿ç»´åšå®¢\nåšå®¢åœ°å€ï¼šhttps://www.cnsre.cn\næ–‡ç« åœ°å€ï¼šhttps://www.cnsre.cn/posts/210603028465/\nç›¸å…³è¯é¢˜ï¼šhttps://www.cnsre.cn/tags/kubernetes/\n","description":"ä½¿ç”¨kubernetes|k8séƒ¨ç½²ä¸€ä¸ªåº”ç”¨ç¨‹åº","id":57,"section":"posts","tags":["kubernetes"],"title":"kuberneteséƒ¨ç½²ä¸€ä¸ªåº”ç”¨ç¨‹åº","uri":"http://www.cnsre.cn:80/posts/210603028465/"},{"content":" ä½œè€…ï¼šSREè¿ç»´åšå®¢\nåšå®¢åœ°å€ï¼šhttps://www.cnsre.cn\næ–‡ç« åœ°å€ï¼šhttps://www.cnsre.cn/posts/210602036084/\nç›¸å…³è¯é¢˜ï¼šhttps://www.cnsre.cn/tags/kubernetes/\né…ç½®è¦æ±‚ è‡³å°‘2å° 2æ ¸4G çš„æœåŠ¡å™¨ æœ¬æ–‡æ¡£ä¸­ï¼ŒCPUå¿…é¡»ä¸º x86æ¶æ„ CentOS 7.8 æˆ– CentOS Stream 8 å®‰è£…åçš„è½¯ä»¶ç‰ˆæœ¬ä¸º Kubernetes v1.21.x calico 3.17.1 nginx-ingress 1.9.1 Containerd.io 1.4.3 æ“ä½œç³»ç»Ÿå…¼å®¹æ€§ CentOSç‰ˆæœ¬ æœ¬æ–‡æ¡£æ˜¯å¦å…¼å®¹ å¤‡æ³¨ CentOS Stream 8 ğŸ˜„ å·²éªŒè¯ CentOS 7.8 ğŸ˜„ å·²éªŒè¯ CentOS 7.7 ğŸ˜ æœªéªŒè¯ CentOS 7.6 ğŸ˜ æœªéªŒè¯ Kubernetes v1.21 å¼€å§‹ï¼Œé»˜è®¤ç§»é™¤ docker çš„ä¾èµ–ï¼Œå¦‚æœå®¿ä¸»æœºä¸Šå®‰è£…äº† docker å’Œ containerdï¼Œå°†ä¼˜å…ˆä½¿ç”¨ docker ä½œä¸ºå®¹å™¨è¿è¡Œå¼•æ“ï¼Œå¦‚æœå®¿ä¸»æœºä¸Šæœªå®‰è£… docker åªå®‰è£…äº† containerdï¼Œå°†ä½¿ç”¨ containerd ä½œä¸ºå®¹å™¨è¿è¡Œå¼•æ“ï¼› æœ¬æ–‡ä½¿ç”¨ containerd ä½œä¸ºå®¹å™¨è¿è¡Œå¼•æ“ï¼› kubeadm æ˜¯ Kubernetes å®˜æ–¹æ”¯æŒçš„å®‰è£…æ–¹å¼ï¼Œâ€œäºŒè¿›åˆ¶â€ ä¸æ˜¯ã€‚æœ¬æ–‡æ¡£é‡‡ç”¨ kubernetes.io å®˜æ–¹æ¨èçš„ kubeadm å·¥å…·å®‰è£… kubernetes é›†ç¾¤ã€‚ æ£€æŸ¥ centos / hostname 1 2 3 4 5 6 7 8 9 10 11 # åœ¨ master èŠ‚ç‚¹å’Œ worker èŠ‚ç‚¹éƒ½è¦æ‰§è¡Œ cat /etc/redhat-release # æ­¤å¤„ hostname çš„è¾“å‡ºå°†ä¼šæ˜¯è¯¥æœºå™¨åœ¨ Kubernetes é›†ç¾¤ä¸­çš„èŠ‚ç‚¹åå­— # ä¸èƒ½ä½¿ç”¨ localhost ä½œä¸ºèŠ‚ç‚¹çš„åå­— hostname # è¯·ä½¿ç”¨ lscpu å‘½ä»¤ï¼Œæ ¸å¯¹ CPU ä¿¡æ¯ # Architecture: x86_64 æœ¬å®‰è£…æ–‡æ¡£ä¸æ”¯æŒ arm æ¶æ„ # CPU(s): 2 CPU å†…æ ¸æ•°é‡ä¸èƒ½ä½äº 2 lscpu ä¿®æ”¹ hostname 1 2 3 4 5 6 # ä¿®æ”¹ hostname hostnamectl set-hostname your-new-host-name # æŸ¥çœ‹ä¿®æ”¹ç»“æœ hostnamectl status # è®¾ç½® hostname è§£æ echo \u0026#34;127.0.0.1 $(hostname)\u0026#34; \u0026gt;\u0026gt; /etc/hosts æ£€æŸ¥ç½‘ç»œ åœ¨æ‰€æœ‰èŠ‚ç‚¹æ‰§è¡Œå‘½ä»¤\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 [root@demo-master-a-1 ~]$ ip route show default via 172.21.0.1 dev eth0 169.254.0.0/16 dev eth0 scope link metric 1002 172.21.0.0/20 dev eth0 proto kernel scope link src 172.21.0.12 [root@demo-master-a-1 ~]$ ip address 1: lo: \u0026lt;LOOPBACK,UP,LOWER_UP\u0026gt; mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000 link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00 inet 127.0.0.1/8 scope host lo valid_lft forever preferred_lft forever 2: eth0: \u0026lt;BROADCAST,MULTICAST,UP,LOWER_UP\u0026gt; mtu 1500 qdisc pfifo_fast state UP group default qlen 1000 link/ether 00:16:3e:12:a4:1b brd ff:ff:ff:ff:ff:ff inet 172.17.216.80/20 brd 172.17.223.255 scope global dynamic eth0 valid_lft 305741654sec preferred_lft 305741654sec ip route show å‘½ä»¤ä¸­ï¼Œå¯ä»¥çŸ¥é“æœºå™¨çš„é»˜è®¤ç½‘å¡ï¼Œé€šå¸¸æ˜¯ eth0ï¼Œå¦‚ default via 172.21.0.23 dev eth0 ip address å‘½ä»¤ä¸­ï¼Œå¯æ˜¾ç¤ºé»˜è®¤ç½‘å¡çš„ IP åœ°å€ï¼ŒKubernetes å°†ä½¿ç”¨æ­¤ IP åœ°å€ä¸é›†ç¾¤å†…çš„å…¶ä»–èŠ‚ç‚¹é€šä¿¡ï¼Œå¦‚ 172.17.216.80 æ‰€æœ‰èŠ‚ç‚¹ä¸Š Kubernetes æ‰€ä½¿ç”¨çš„ IP åœ°å€å¿…é¡»å¯ä»¥äº’é€šï¼ˆæ— éœ€ NAT æ˜ å°„ã€æ— å®‰å…¨ç»„æˆ–é˜²ç«å¢™éš”ç¦»ï¼‰ å®‰è£… ä½¿ç”¨ root èº«ä»½åœ¨æ‰€æœ‰èŠ‚ç‚¹æ‰§è¡Œå¦‚ä¸‹ä»£ç ï¼Œä»¥å®‰è£…è½¯ä»¶ï¼š\ncontainerd nfs-utils kubectl / kubeadm / kubelet å¿«é€Ÿå®‰è£… æ‰‹åŠ¨å®‰è£… è¯·å°†è„šæœ¬æœ€åçš„ 1.21.0 æ›¿æ¢æˆæ‚¨éœ€è¦çš„ç‰ˆæœ¬å·ï¼ˆå¿…é¡»æ˜¯ 1.21 çš„å°ç‰ˆæœ¬ï¼Œä¸èƒ½æ˜¯ 1.19.1 ç­‰ï¼‰ è„šæœ¬ä¸­é—´çš„ v1.21.x ä¸è¦æ›¿æ¢\ndocker hub é•œåƒè¯·æ ¹æ®è‡ªå·±ç½‘ç»œçš„æƒ…å†µä»»é€‰ä¸€ä¸ª\nç¬¬å››è¡Œä¸ºè…¾è®¯äº‘ docker hub é•œåƒ ç¬¬å…­è¡Œä¸ºDaoCloud docker hub é•œåƒ ç¬¬å…«è¡Œä¸ºåä¸ºäº‘ docker hub é•œåƒ ç¬¬åè¡Œä¸ºé˜¿é‡Œäº‘ docker hub é•œåƒ 1 2 3 4 5 6 7 8 9 10 11 # åœ¨ master èŠ‚ç‚¹å’Œ worker èŠ‚ç‚¹éƒ½è¦æ‰§è¡Œ # æœ€åä¸€ä¸ªå‚æ•° 1.21.0 ç”¨äºæŒ‡å®š kubenetes ç‰ˆæœ¬ï¼Œæ”¯æŒæ‰€æœ‰ 1.21.x ç‰ˆæœ¬çš„å®‰è£… # è…¾è®¯äº‘ docker hub é•œåƒ # export REGISTRY_MIRROR=\u0026#34;https://mirror.ccs.tencentyun.com\u0026#34; # DaoCloud é•œåƒ # export REGISTRY_MIRROR=\u0026#34;http://f1361db2.m.daocloud.io\u0026#34; # åä¸ºäº‘é•œåƒ # export REGISTRY_MIRROR=\u0026#34;https://05f073ad3c0010ea0f4bc00b7105ec20.mirror.swr.myhuaweicloud.com\u0026#34; # é˜¿é‡Œäº‘ docker hub é•œåƒ export REGISTRY_MIRROR=https://registry.cn-hangzhou.aliyuncs.com curl -sSL https://kuboard.cn/install-script/v1.21.x/install_kubelet.sh | sh -s 1.21.0 æ‰‹åŠ¨æ‰§è¡Œä»¥ä¸‹ä»£ç ï¼Œç»“æœä¸å¿«é€Ÿå®‰è£…ç›¸åŒã€‚ è¯·å°†è„šæœ¬ç¬¬79è¡Œï¼ˆå·²é«˜äº®ï¼‰çš„ ${1} æ›¿æ¢æˆæ‚¨éœ€è¦çš„ç‰ˆæœ¬å·ï¼Œä¾‹å¦‚ 1.21.0\ndocker hub é•œåƒè¯·æ ¹æ®è‡ªå·±ç½‘ç»œçš„æƒ…å†µä»»é€‰ä¸€ä¸ª\nç¬¬å››è¡Œä¸ºè…¾è®¯äº‘ docker hub é•œåƒ ç¬¬å…­è¡Œä¸ºDaoCloud docker hub é•œåƒ ç¬¬å…«è¡Œä¸ºé˜¿é‡Œäº‘ docker hub é•œåƒ 1 2 3 4 5 6 7 8 # åœ¨ master èŠ‚ç‚¹å’Œ worker èŠ‚ç‚¹éƒ½è¦æ‰§è¡Œ # æœ€åä¸€ä¸ªå‚æ•° 1.21.0 ç”¨äºæŒ‡å®š kubenetes ç‰ˆæœ¬ï¼Œæ”¯æŒæ‰€æœ‰ 1.21.x ç‰ˆæœ¬çš„å®‰è£… # è…¾è®¯äº‘ docker hub é•œåƒ # export REGISTRY_MIRROR=\u0026#34;https://mirror.ccs.tencentyun.com\u0026#34; # DaoCloud é•œåƒ # export REGISTRY_MIRROR=\u0026#34;http://f1361db2.m.daocloud.io\u0026#34; # é˜¿é‡Œäº‘ docker hub é•œåƒ export REGISTRY_MIRROR=https://registry.cn-hangzhou.aliyuncs.com 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 #!/bin/bash # åœ¨ master èŠ‚ç‚¹å’Œ worker èŠ‚ç‚¹éƒ½è¦æ‰§è¡Œ # å®‰è£… containerd # å‚è€ƒæ–‡æ¡£å¦‚ä¸‹ # https://kubernetes.io/docs/setup/production-environment/container-runtimes/#containerd cat \u0026lt;\u0026lt;EOF | sudo tee /etc/modules-load.d/containerd.conf overlay br_netfilter EOF sudo modprobe overlay sudo modprobe br_netfilter # Setup required sysctl params, these persist across reboots. cat \u0026lt;\u0026lt;EOF | sudo tee /etc/sysctl.d/99-kubernetes-cri.conf net.bridge.bridge-nf-call-iptables = 1 net.ipv4.ip_forward = 1 net.bridge.bridge-nf-call-ip6tables = 1 EOF # Apply sysctl params without reboot sysctl --system # å¸è½½æ—§ç‰ˆæœ¬ yum remove -y containerd.io # è®¾ç½® yum repository yum install -y yum-utils device-mapper-persistent-data lvm2 yum-config-manager --add-repo https://download.docker.com/linux/centos/docker-ce.repo # å®‰è£… containerd yum install -y containerd.io-1.4.3 mkdir -p /etc/containerd containerd config default \u0026gt; /etc/containerd/config.toml sed -i \u0026#34;s#k8s.gcr.io#registry.aliyuncs.com/k8sxio#g\u0026#34; /etc/containerd/config.toml sed -i \u0026#39;/containerd.runtimes.runc.options/a\\ \\ \\ \\ \\ \\ \\ \\ \\ \\ \\ \\ SystemdCgroup = true\u0026#39; /etc/containerd/config.toml sed -i \u0026#34;s#https://registry-1.docker.io#${REGISTRY_MIRROR}#g\u0026#34; /etc/containerd/config.toml systemctl daemon-reload systemctl enable containerd systemctl restart containerd # å®‰è£… nfs-utils # å¿…é¡»å…ˆå®‰è£… nfs-utils æ‰èƒ½æŒ‚è½½ nfs ç½‘ç»œå­˜å‚¨ yum install -y nfs-utils yum install -y wget # å…³é—­ é˜²ç«å¢™ systemctl stop firewalld systemctl disable firewalld # å…³é—­ SeLinux setenforce 0 sed -i \u0026#34;s/SELINUX=enforcing/SELINUX=disabled/g\u0026#34; /etc/selinux/config # å…³é—­ swap swapoff -a yes | cp /etc/fstab /etc/fstab_bak cat /etc/fstab_bak |grep -v swap \u0026gt; /etc/fstab # é…ç½®K8Sçš„yumæº cat \u0026lt;\u0026lt;EOF \u0026gt; /etc/yum.repos.d/kubernetes.repo [kubernetes] name=Kubernetes baseurl=http://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64 enabled=1 gpgcheck=0 repo_gpgcheck=0 gpgkey=http://mirrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg http://mirrors.aliyun.com/kubernetes/yum/doc/rpm-package-key.gpg EOF # å¸è½½æ—§ç‰ˆæœ¬ yum remove -y kubelet kubeadm kubectl # å®‰è£…kubeletã€kubeadmã€kubectl # å°† ${1} æ›¿æ¢ä¸º kubernetes ç‰ˆæœ¬å·ï¼Œä¾‹å¦‚ 1.20.1 yum install -y kubelet-${1} kubeadm-${1} kubectl-${1} crictl config runtime-endpoint /run/containerd/containerd.sock # é‡å¯ dockerï¼Œå¹¶å¯åŠ¨ kubelet systemctl daemon-reload systemctl enable kubelet \u0026amp;\u0026amp; systemctl start kubelet containerd --version kubelet --version å¦‚æœæ­¤æ—¶æ‰§è¡Œ systemctl status kubelet å‘½ä»¤ï¼Œå°†å¾—åˆ° kubelet å¯åŠ¨å¤±è´¥çš„é”™è¯¯æç¤ºï¼Œè¯·å¿½ç•¥æ­¤é”™è¯¯ï¼Œå› ä¸ºå¿…é¡»å®Œæˆåç»­æ­¥éª¤ä¸­ kubeadm init çš„æ“ä½œï¼Œkubelet æ‰èƒ½æ­£å¸¸å¯åŠ¨ åˆå§‹åŒ– master èŠ‚ç‚¹ APISERVER_NAME ä¸èƒ½æ˜¯ master çš„ hostname APISERVER_NAME å¿…é¡»å…¨ä¸ºå°å†™å­—æ¯ã€æ•°å­—ã€å°æ•°ç‚¹ï¼Œä¸èƒ½åŒ…å«å‡å· POD_SUBNET æ‰€ä½¿ç”¨çš„ç½‘æ®µä¸èƒ½ä¸ masterèŠ‚ç‚¹/workerèŠ‚ç‚¹ æ‰€åœ¨çš„ç½‘æ®µé‡å ã€‚è¯¥å­—æ®µçš„å–å€¼ä¸ºä¸€ä¸ª CIDR å€¼ï¼Œå¦‚æœæ‚¨å¯¹ CIDR è¿™ä¸ªæ¦‚å¿µè¿˜ä¸ç†Ÿæ‚‰ï¼Œè¯·ä»ç„¶æ‰§è¡Œ export POD_SUBNET=10.100.0.1/16 å‘½ä»¤ï¼Œä¸åšä¿®æ”¹ å¿«é€Ÿåˆå§‹åŒ– æ‰‹åŠ¨åˆå§‹åŒ– è¯·å°†è„šæœ¬æœ€åçš„ 1.21.0 æ›¿æ¢æˆæ‚¨éœ€è¦çš„ç‰ˆæœ¬å·ï¼ˆå¿…é¡»æ˜¯ 1.21 çš„å°ç‰ˆæœ¬ï¼Œä¸èƒ½æ˜¯ 1.19.1 ç­‰ï¼‰ è„šæœ¬ä¸­é—´çš„ v1.21.x ä¸è¦æ›¿æ¢\n1 2 3 4 5 6 7 8 9 10 # åªåœ¨ master èŠ‚ç‚¹æ‰§è¡Œ # æ›¿æ¢ x.x.x.x ä¸º master èŠ‚ç‚¹å®é™… IPï¼ˆè¯·ä½¿ç”¨å†…ç½‘ IPï¼‰ # export å‘½ä»¤åªåœ¨å½“å‰ shell ä¼šè¯ä¸­æœ‰æ•ˆï¼Œå¼€å¯æ–°çš„ shell çª—å£åï¼Œå¦‚æœè¦ç»§ç»­å®‰è£…è¿‡ç¨‹ï¼Œè¯·é‡æ–°æ‰§è¡Œæ­¤å¤„çš„ export å‘½ä»¤ export MASTER_IP=x.x.x.x # æ›¿æ¢ apiserver.demo ä¸º æ‚¨æƒ³è¦çš„ dnsName export APISERVER_NAME=apiserver.demo # Kubernetes å®¹å™¨ç»„æ‰€åœ¨çš„ç½‘æ®µï¼Œè¯¥ç½‘æ®µå®‰è£…å®Œæˆåï¼Œç”± kubernetes åˆ›å»ºï¼Œäº‹å…ˆå¹¶ä¸å­˜åœ¨äºæ‚¨çš„ç‰©ç†ç½‘ç»œä¸­ export POD_SUBNET=10.100.0.1/16 echo \u0026#34;${MASTER_IP} ${APISERVER_NAME}\u0026#34; \u0026gt;\u0026gt; /etc/hosts curl -sSL https://kuboard.cn/install-script/v1.21.x/init_master.sh | sh -s 1.21.0 æ‰‹åŠ¨æ‰§è¡Œä»¥ä¸‹ä»£ç ï¼Œç»“æœä¸å¿«é€Ÿå®‰è£…ç›¸åŒã€‚ è¯·å°†è„šæœ¬ç¬¬79è¡Œï¼ˆå·²é«˜äº®ï¼‰çš„ ${1} æ›¿æ¢æˆæ‚¨éœ€è¦çš„ç‰ˆæœ¬å·ï¼Œä¾‹å¦‚ 1.21.0\n1 2 3 4 5 6 7 8 9 # åªåœ¨ master èŠ‚ç‚¹æ‰§è¡Œ # æ›¿æ¢ x.x.x.x ä¸º master èŠ‚ç‚¹çš„å†…ç½‘IP # export å‘½ä»¤åªåœ¨å½“å‰ shell ä¼šè¯ä¸­æœ‰æ•ˆï¼Œå¼€å¯æ–°çš„ shell çª—å£åï¼Œå¦‚æœè¦ç»§ç»­å®‰è£…è¿‡ç¨‹ï¼Œè¯·é‡æ–°æ‰§è¡Œæ­¤å¤„çš„ export å‘½ä»¤ export MASTER_IP=x.x.x.x # æ›¿æ¢ apiserver.demo ä¸º æ‚¨æƒ³è¦çš„ dnsName export APISERVER_NAME=apiserver.demo # Kubernetes å®¹å™¨ç»„æ‰€åœ¨çš„ç½‘æ®µï¼Œè¯¥ç½‘æ®µå®‰è£…å®Œæˆåï¼Œç”± kubernetes åˆ›å»ºï¼Œäº‹å…ˆå¹¶ä¸å­˜åœ¨äºæ‚¨çš„ç‰©ç†ç½‘ç»œä¸­ export POD_SUBNET=10.100.0.1/16 echo \u0026#34;${MASTER_IP} ${APISERVER_NAME}\u0026#34; \u0026gt;\u0026gt; /etc/hosts 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 #!/bin/bash # åªåœ¨ master èŠ‚ç‚¹æ‰§è¡Œ # è„šæœ¬å‡ºé”™æ—¶ç»ˆæ­¢æ‰§è¡Œ set -e if [ ${#POD_SUBNET} -eq 0 ] || [ ${#APISERVER_NAME} -eq 0 ]; then echo -e \u0026#34;\\033[31;1mè¯·ç¡®ä¿æ‚¨å·²ç»è®¾ç½®äº†ç¯å¢ƒå˜é‡ POD_SUBNET å’Œ APISERVER_NAME \\033[0m\u0026#34; echo å½“å‰POD_SUBNET=$POD_SUBNET echo å½“å‰APISERVER_NAME=$APISERVER_NAME exit 1 fi # æŸ¥çœ‹å®Œæ•´é…ç½®é€‰é¡¹ https://godoc.org/k8s.io/kubernetes/cmd/kubeadm/app/apis/kubeadm/v1beta2 rm -f ./kubeadm-config.yaml cat \u0026lt;\u0026lt;EOF \u0026gt; ./kubeadm-config.yaml --- apiVersion: kubeadm.k8s.io/v1beta2 kind: ClusterConfiguration kubernetesVersion: v${1} imageRepository: registry.aliyuncs.com/k8sxio controlPlaneEndpoint: \u0026#34;${APISERVER_NAME}:6443\u0026#34; networking: serviceSubnet: \u0026#34;10.96.0.0/16\u0026#34; podSubnet: \u0026#34;${POD_SUBNET}\u0026#34; dnsDomain: \u0026#34;cluster.local\u0026#34; dns: type: CoreDNS imageRepository: swr.cn-east-2.myhuaweicloud.com${2} imageTag: 1.8.0 --- apiVersion: kubelet.config.k8s.io/v1beta1 kind: KubeletConfiguration cgroupDriver: systemd EOF # kubeadm init # æ ¹æ®æ‚¨æœåŠ¡å™¨ç½‘é€Ÿçš„æƒ…å†µï¼Œæ‚¨éœ€è¦ç­‰å€™ 3 - 10 åˆ†é’Ÿ echo \u0026#34;\u0026#34; echo \u0026#34;æŠ“å–é•œåƒï¼Œè¯·ç¨å€™...\u0026#34; kubeadm config images pull --config=kubeadm-config.yaml echo \u0026#34;\u0026#34; echo \u0026#34;åˆå§‹åŒ– Master èŠ‚ç‚¹\u0026#34; kubeadm init --config=kubeadm-config.yaml --upload-certs # é…ç½® kubectl rm -rf /root/.kube/ mkdir /root/.kube/ cp -i /etc/kubernetes/admin.conf /root/.kube/config # å®‰è£… calico ç½‘ç»œæ’ä»¶ # å‚è€ƒæ–‡æ¡£ https://docs.projectcalico.org/v3.13/getting-started/kubernetes/self-managed-onprem/onpremises echo \u0026#34;\u0026#34; echo \u0026#34;å®‰è£…calico-3.17.1\u0026#34; rm -f calico-3.17.1.yaml kubectl create -f https://kuboard.cn/install-script/v1.21.x/calico-operator.yaml wget https://kuboard.cn/install-script/v1.21.x/calico-custom-resources.yaml sed -i \u0026#34;s#192.168.0.0/16#${POD_SUBNET}#\u0026#34; calico-custom-resources.yaml kubectl create -f calico-custom-resources.yaml æ£€æŸ¥ master åˆå§‹åŒ–ç»“æœ 1 2 3 4 5 6 7 # åªåœ¨ master èŠ‚ç‚¹æ‰§è¡Œ # æ‰§è¡Œå¦‚ä¸‹å‘½ä»¤ï¼Œç­‰å¾… 3-10 åˆ†é’Ÿï¼Œç›´åˆ°æ‰€æœ‰çš„å®¹å™¨ç»„å¤„äº Running çŠ¶æ€ watch kubectl get pod -n kube-system -o wide # æŸ¥çœ‹ master èŠ‚ç‚¹åˆå§‹åŒ–ç»“æœ kubectl get nodes -o wide åˆå§‹åŒ– workerèŠ‚ç‚¹ è·å¾— joinå‘½ä»¤å‚æ•° åœ¨ master èŠ‚ç‚¹ä¸Šæ‰§è¡Œ\n1 2 3 4 # åªåœ¨ master èŠ‚ç‚¹æ‰§è¡Œ kubeadm token create --print-join-command # è¿”å›å¦‚ä¸‹ kubeadm join apiserver.demo:6443 --token 9ukzcs.qp4ozxbn1knc13sx --discovery-token-ca-cert-hash sha256:0cb945ea0c6329b4df58cf358e2be697fd31a85f55c23d47356f06f69a27283d è¯¥ token çš„æœ‰æ•ˆæ—¶é—´ä¸º 2 ä¸ªå°æ—¶ï¼Œ2å°æ—¶å†…ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨æ­¤ token åˆå§‹åŒ–ä»»æ„æ•°é‡çš„ worker èŠ‚ç‚¹ã€‚ åˆå§‹åŒ–worker é’ˆå¯¹æ‰€æœ‰çš„ worker èŠ‚ç‚¹æ‰§è¡Œ\n1 2 3 4 5 6 7 8 9 # åªåœ¨ worker èŠ‚ç‚¹æ‰§è¡Œ # æ›¿æ¢ x.x.x.x ä¸º master èŠ‚ç‚¹çš„å†…ç½‘ IP export MASTER_IP=x.x.x.x # æ›¿æ¢ apiserver.demo ä¸ºåˆå§‹åŒ– master èŠ‚ç‚¹æ—¶æ‰€ä½¿ç”¨çš„ APISERVER_NAME export APISERVER_NAME=apiserver.demo echo \u0026#34;${MASTER_IP} ${APISERVER_NAME}\u0026#34; \u0026gt;\u0026gt; /etc/hosts # æ›¿æ¢ä¸º master èŠ‚ç‚¹ä¸Š kubeadm token create å‘½ä»¤çš„è¾“å‡º kubeadm join apiserver.demo:6443 --token 9ukzcs.qp4ozxbn1knc13sx --discovery-token-ca-cert-hash sha256:0cb945ea0c6329b4df58cf358e2be697fd31a85f55c23d47356f06f69a27283d æ£€æŸ¥åˆå§‹åŒ–ç»“æœ åœ¨ master èŠ‚ç‚¹ä¸Šæ‰§è¡Œ\n1 2 3 4 5 6 7 # åªåœ¨ master èŠ‚ç‚¹æ‰§è¡Œ kubectl get nodes -o wide # è¾“å‡ºç»“æœå¦‚ä¸‹æ‰€ç¤º [root@master ~]# kubectl get nodes NAME STATUS ROLES AGE VERSION master Ready control-plane,master 54m v1.21.0 node1 Ready \u0026lt;none\u0026gt; 35m v1.21.0 å®‰è£… Ingress Controller å¿«é€Ÿå®‰è£… å¸è½½IngressController åœ¨ master èŠ‚ç‚¹ä¸Šæ‰§è¡Œ\néƒ¨åˆ†æƒ…å†µä¸‹ï¼Œä¸‹é¢çš„è¿™æ¡æŒ‡ä»¤ï¼Œæ‚¨éœ€è¦æ‰§è¡Œä¸¤æ¬¡æ‰èƒ½æˆåŠŸã€‚\n1 2 # åªåœ¨ master èŠ‚ç‚¹æ‰§è¡Œ kubectl apply -f https://kuboard.cn/install-script/v1.21.x/nginx-ingress.yaml åœ¨ master èŠ‚ç‚¹ä¸Šæ‰§è¡Œ\nåªåœ¨æ‚¨æƒ³é€‰æ‹©å…¶ä»– Ingress Controller çš„æƒ…å†µä¸‹å¸è½½\n1 2 # åªåœ¨ master èŠ‚ç‚¹æ‰§è¡Œ kubectl delete -f https://kuboard.cn/install-script/v1.21.x/nginx-ingress.yaml é…ç½®åŸŸåè§£æ å°†åŸŸå cnsre.cn è§£æåˆ° demo-worker-a-2 çš„ IP åœ°å€ z.z.z.z ï¼ˆä¹Ÿå¯ä»¥æ˜¯ demo-worker-a-1 çš„åœ°å€ y.y.y.yï¼‰\néªŒè¯é…ç½® åœ¨æµè§ˆå™¨è®¿é—® cnsre.cnï¼Œå°†å¾—åˆ° 404 NotFound é”™è¯¯é¡µé¢\nä½œè€…ï¼šSREè¿ç»´åšå®¢\nåšå®¢åœ°å€ï¼šhttps://www.cnsre.cn\næ–‡ç« åœ°å€ï¼šhttps://www.cnsre.cn/posts/210602036084/\nç›¸å…³è¯é¢˜ï¼šhttps://www.cnsre.cn/tags/kubernetes/\n","description":"ä½¿ç”¨kubeadmå®‰è£…kubernetes 1.21","id":58,"section":"posts","tags":["kubeadm","kubernetes"],"title":"ä½¿ç”¨kubeadmå®‰è£…kubernetes 1.21","uri":"http://www.cnsre.cn:80/posts/210602036084/"},{"content":" ä½œè€…ï¼šSREè¿ç»´åšå®¢\nåšå®¢åœ°å€ï¼šhttps://www.cnsre.cn\næ–‡ç« åœ°å€ï¼šhttps://www.cnsre.cn/posts/210531132227/\nç›¸å…³è¯é¢˜ï¼šhttps://www.cnsre.cn/tags/shell/\næ–‡ä»¶ç±»å‹ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 ls -rtl # æŒ‰æ—¶é—´å€’å™åˆ—å‡ºæ‰€æœ‰ç›®å½•å’Œæ–‡ä»¶ ll -rt touch file # åˆ›å»ºç©ºç™½æ–‡ä»¶ rm -rf dirname # ä¸æç¤ºåˆ é™¤éç©ºç›®å½•(-r:é€’å½’åˆ é™¤ -få¼ºåˆ¶) dos2unix # windowsæ–‡æœ¬è½¬linuxæ–‡æœ¬ unix2dos # linuxæ–‡æœ¬è½¬windowsæ–‡æœ¬ enca filename # æŸ¥çœ‹ç¼–ç  å®‰è£… yum install -y enca md5sum # æŸ¥çœ‹md5å€¼ ln sourcefile newfile # ç¡¬é“¾æ¥ ln -s sourcefile newfile # ç¬¦å·è¿æ¥ readlink -f /data # æŸ¥çœ‹è¿æ¥çœŸå®ç›®å½• cat file | nl |less # æŸ¥çœ‹ä¸Šä¸‹ç¿»é¡µä¸”æ˜¾ç¤ºè¡Œå· qé€€å‡º head # æŸ¥çœ‹æ–‡ä»¶å¼€å¤´å†…å®¹ head -c 10m # æˆªå–æ–‡ä»¶ä¸­10Må†…å®¹ split -C 10M # å°†æ–‡ä»¶åˆ‡å‰²å¤§å°ä¸º10M -CæŒ‰è¡Œ tail -f file # æŸ¥çœ‹ç»“å°¾ ç›‘è§†æ—¥å¿—æ–‡ä»¶ tail -F file # ç›‘è§†æ—¥å¿—å¹¶é‡è¯•, é’ˆå¯¹æ–‡ä»¶è¢«mvçš„æƒ…å†µå¯ä»¥æŒç»­è¯»å– file # æ£€æŸ¥æ–‡ä»¶ç±»å‹ umask # æ›´æ”¹é»˜è®¤æƒé™ uniq # åˆ é™¤é‡å¤çš„è¡Œ uniq -c # é‡å¤çš„è¡Œå‡ºç°æ¬¡æ•° uniq -u # åªæ˜¾ç¤ºä¸é‡å¤è¡Œ paste a b # å°†ä¸¤ä¸ªæ–‡ä»¶åˆå¹¶ç”¨tabé”®åˆ†éš”å¼€ paste -d\u0026#39;+\u0026#39; a b # å°†ä¸¤ä¸ªæ–‡ä»¶åˆå¹¶æŒ‡å®š\u0026#39;+\u0026#39;ç¬¦å·éš”å¼€ paste -s a # å°†å¤šè¡Œæ•°æ®åˆå¹¶åˆ°ä¸€è¡Œç”¨tabé”®éš”å¼€ chattr +i /etc/passwd # ä¸å¾—ä»»æ„æ”¹å˜æ–‡ä»¶æˆ–ç›®å½• -iå»æ‰é” -Ré€’å½’ more # å‘ä¸‹åˆ†é¢å™¨ locate aaa # æœç´¢ wc -l file # æŸ¥çœ‹è¡Œæ•° cp filename{,.bak} # å¿«é€Ÿå¤‡ä»½ä¸€ä¸ªæ–‡ä»¶ cp a b # æ‹·è´ä¸æç¤º æ—¢ä¸ä½¿ç”¨åˆ«å cp -i rev # å°†è¡Œä¸­çš„å­—ç¬¦é€†åºæ’åˆ— comm -12 2 3 # è¡Œå’Œè¡Œæ¯”è¾ƒåŒ¹é… echo \u0026#34;10.45aa\u0026#34; |cksum # å­—ç¬¦ä¸²è½¬æ•°å­—ç¼–ç ï¼Œå¯åšæ ¡éªŒï¼Œä¹Ÿå¯ç”¨äºæ–‡ä»¶æ ¡éªŒ iconv -f gbk -t utf8 source.txt \u0026gt; new.txt # è½¬æ¢ç¼–ç  xxd /boot/grub/stage1 # 16è¿›åˆ¶æŸ¥çœ‹ hexdump -C /boot/grub/stage1 # 16è¿›åˆ¶æŸ¥çœ‹ rename source new file # é‡å‘½å å¯æ­£åˆ™ watch -d -n 1 \u0026#39;df; ls -FlAt /path\u0026#39; # å®æ—¶æŸä¸ªç›®å½•ä¸‹æŸ¥çœ‹æœ€æ–°æ”¹åŠ¨è¿‡çš„æ–‡ä»¶ cp -v /dev/dvd /rhel4.6.iso9660 # åˆ¶ä½œé•œåƒ diff suzu.c suzu2.c \u0026gt; sz.patch # åˆ¶ä½œè¡¥ä¸ patch suzu.c \u0026lt; sz.patch # å®‰è£…è¡¥ä¸ sortæ’åº 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 -t # æŒ‡å®šæ’åºæ—¶æ‰€ç”¨çš„æ ä½åˆ†éš”å­—ç¬¦ -n # ä¾ç…§æ•°å€¼çš„å¤§å°æ’åº -r # ä»¥ç›¸åçš„é¡ºåºæ¥æ’åº -f # æ’åºæ—¶ï¼Œå°†å°å†™å­—æ¯è§†ä¸ºå¤§å†™å­—æ¯ -d # æ’åºæ—¶ï¼Œå¤„ç†è‹±æ–‡å­—æ¯ã€æ•°å­—åŠç©ºæ ¼å­—ç¬¦å¤–ï¼Œå¿½ç•¥å…¶ä»–çš„å­—ç¬¦ -c # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å·²ç»æŒ‰ç…§é¡ºåºæ’åº -b # å¿½ç•¥æ¯è¡Œå‰é¢å¼€å§‹å¤„çš„ç©ºæ ¼å­—ç¬¦ -M # å‰é¢3ä¸ªå­—æ¯ä¾ç…§æœˆä»½çš„ç¼©å†™è¿›è¡Œæ’åº -k # æŒ‡å®šåŸŸ -m # å°†å‡ ä¸ªæ’åºå¥½çš„æ–‡ä»¶è¿›è¡Œåˆå¹¶ -T # æŒ‡å®šä¸´æ—¶æ–‡ä»¶ç›®å½•,é»˜è®¤åœ¨/tmp -o # å°†æ’åºåçš„ç»“æœå­˜å…¥æŒ‡å®šçš„æ–‡ sort -n # æŒ‰æ•°å­—æ’åº sort -nr # æŒ‰æ•°å­—å€’å™ sort -u # è¿‡æ»¤é‡å¤è¡Œ sort -m a.txt c.txt # å°†ä¸¤ä¸ªæ–‡ä»¶å†…å®¹æ•´åˆåˆ°ä¸€èµ· sort -n -t\u0026#39; \u0026#39; -k 2 -k 3 a.txt # ç¬¬äºŒåŸŸç›¸åŒï¼Œå°†ä»ç¬¬ä¸‰åŸŸè¿›è¡Œå‡é™å¤„ç† sort -n -t\u0026#39;:\u0026#39; -k 3r a.txt # ä»¥:ä¸ºåˆ†å‰²åŸŸçš„ç¬¬ä¸‰åŸŸè¿›è¡Œå€’å™æ’åˆ— sort -k 1.3 a.txt # ä»ç¬¬ä¸‰ä¸ªå­—æ¯èµ·è¿›è¡Œæ’åº sort -t\u0026#34; \u0026#34; -k 2n -u a.txt # ä»¥ç¬¬äºŒåŸŸè¿›è¡Œæ’åºï¼Œå¦‚æœé‡åˆ°é‡å¤çš„ï¼Œå°±åˆ é™¤ findæŸ¥æ‰¾ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 # linuxæ–‡ä»¶æ— åˆ›å»ºæ—¶é—´ # Access ä½¿ç”¨æ—¶é—´ # Modify å†…å®¹ä¿®æ”¹æ—¶é—´ # Change çŠ¶æ€æ”¹å˜æ—¶é—´(æƒé™ã€å±ä¸») # æ—¶é—´é»˜è®¤ä»¥24å°æ—¶ä¸ºå•ä½,å½“å‰æ—¶é—´åˆ°å‘å‰24å°æ—¶ä¸º0å¤©,å‘å‰48-72å°æ—¶ä¸º2å¤© # -and ä¸” åŒ¹é…ä¸¤ä¸ªæ¡ä»¶ å‚æ•°å¯ä»¥ç¡®å®šæ—¶é—´èŒƒå›´ -mtime +2 -and -mtime -4 # -or æˆ– åŒ¹é…ä»»æ„ä¸€ä¸ªæ¡ä»¶ find /etc -name \u0026#34;*http*\u0026#34; # æŒ‰æ–‡ä»¶åæŸ¥æ‰¾ find . -type f # æŸ¥æ‰¾æŸä¸€ç±»å‹æ–‡ä»¶ find / -perm # æŒ‰ç…§æ–‡ä»¶æƒé™æŸ¥æ‰¾ find / -user # æŒ‰ç…§æ–‡ä»¶å±ä¸»æŸ¥æ‰¾ find / -group # æŒ‰ç…§æ–‡ä»¶æ‰€å±çš„ç»„æ¥æŸ¥æ‰¾æ–‡ä»¶ find / -atime -n # æ–‡ä»¶ä½¿ç”¨æ—¶é—´åœ¨Nå¤©ä»¥å†… find / -atime +n # æ–‡ä»¶ä½¿ç”¨æ—¶é—´åœ¨Nå¤©ä»¥å‰ find / -mtime +n # æ–‡ä»¶å†…å®¹æ”¹å˜æ—¶é—´åœ¨Nå¤©ä»¥å‰ find / -ctime +n # æ–‡ä»¶çŠ¶æ€æ”¹å˜æ—¶é—´åœ¨Nå¤©å‰ find / -mmin +30 # æŒ‰åˆ†é’ŸæŸ¥æ‰¾å†…å®¹æ”¹å˜ find / -size +1000000c -print # æŸ¥æ‰¾æ–‡ä»¶é•¿åº¦å¤§äº1Må­—èŠ‚çš„æ–‡ä»¶ find /etc -name \u0026#34;*passwd*\u0026#34; -exec grep \u0026#34;xuesong\u0026#34; {} \\; # æŒ‰åå­—æŸ¥æ‰¾æ–‡ä»¶ä¼ é€’ç»™-execåå‘½ä»¤ find . -name \u0026#39;t*\u0026#39; -exec basename {} \\; # æŸ¥æ‰¾æ–‡ä»¶å,ä¸å–è·¯å¾„ find . -type f -name \u0026#34;err*\u0026#34; -exec rename err ERR {} \\; # æ‰¹é‡æ”¹å(æŸ¥æ‰¾err æ›¿æ¢ä¸º ERR {}æ–‡ä»¶ find path -name *name1* -or -name *name2* # æŸ¥æ‰¾ä»»æ„ä¸€ä¸ªå…³é”®å­— vimç¼–è¾‘å™¨ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 # å¸¸ç”¨é…ç½® set smartindent set tabstop=4 set shiftwidth=4 set expandtab set softtabstop=4 set noautoindent set nosmartindent set paste set clipboard=unnamed gconf-editor # é…ç½®ç¼–è¾‘å™¨ /etc/vimrc # é…ç½®æ–‡ä»¶è·¯å¾„ vim +24 file # æ‰“å¼€æ–‡ä»¶å®šä½åˆ°æŒ‡å®šè¡Œ vim file1 file2 # æ‰“å¼€å¤šä¸ªæ–‡ä»¶ vim -r file # æ¢å¤ä¸Šæ¬¡å¼‚å¸¸å…³é—­çš„æ–‡ä»¶ .file.swp vim -O2 file1 file2 # å‚ç›´åˆ†å± vim -on file1 file2 # æ°´å¹³åˆ†å± Ctrl+ U # å‘å‰ç¿»é¡µ Ctrl+ D # å‘åç¿»é¡µ Ctrl+ww # åœ¨çª—å£é—´åˆ‡æ¢ Ctrl+w +or-or= # å¢å‡é«˜åº¦ :sp filename # ä¸Šä¸‹åˆ†å‰²æ‰“å¼€æ–°æ–‡ä»¶ :vs filename # å·¦å³åˆ†å‰²æ‰“å¼€æ–°æ–‡ä»¶ :set nu # æ‰“å¼€è¡Œå· :set nonu # å–æ¶ˆè¡Œå· :nohl # å–æ¶ˆé«˜äº® :set paste # å–æ¶ˆç¼©è¿› :set autoindent # è®¾ç½®è‡ªåŠ¨ç¼©è¿› :set ff # æŸ¥çœ‹æ–‡æœ¬æ ¼å¼ :set binary # æ”¹ä¸ºunixæ ¼å¼ :%s/str/newstr/g # å…¨éƒ¨æ›¿æ¢ :200 # è·³è½¬åˆ°200 1 æ–‡ä»¶å¤´ G # è·³åˆ°è¡Œå°¾ dd # åˆ é™¤å½“å‰è¡Œ å¹¶å¤åˆ¶ å¯ç›´æ¥pç²˜è´´ 11111dd # åˆ é™¤11111è¡Œï¼Œå¯ç”¨æ¥æ¸…ç©ºæ–‡ä»¶ r # æ›¿æ¢å•ä¸ªå­—ç¬¦ R # æ›¿æ¢å¤šä¸ªå­—ç¬¦ u # æ’¤é”€ä¸Šæ¬¡æ“ä½œ * # å…¨æ–‡åŒ¹é…å½“å‰å…‰æ ‡æ‰€åœ¨å­—ç¬¦ä¸² $ # è¡Œå°¾ 0 # è¡Œé¦– X # æ–‡æ¡£åŠ å¯† v = # è‡ªåŠ¨æ ¼å¼åŒ–ä»£ç  Ctrl+v # å¯è§†æ¨¡å¼ Ctrl+v I ESC # å¤šè¡Œæ“ä½œ Ctrl+v s ESC # æ‰¹é‡å–æ¶ˆæ³¨é‡Š å½’æ¡£è§£å‹ç¼© 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 tar zxvpf gz.tar.gz dir # è§£åŒ…æŒ‡å®štar.gzä¸­çš„å†…å®¹ ä¸æŒ‡å®šç›®å½•åˆ™å…¨è§£å‹ tar zcvpf /$path/gz.tar.gz * # æ‰“åŒ…gz æ³¨æ„*æœ€å¥½ç”¨ç›¸å¯¹è·¯å¾„ tar zcf /$path/gz.tar.gz * # æ‰“åŒ…æ­£ç¡®ä¸æç¤º tar ztvpf gz.tar.gz # æŸ¥çœ‹gz tar xvf 1.tar -C dir # è§£åŒ…tar æ”¾åˆ°æŒ‡å®šç›®å½• tar -cvf 1.tar * # æ‰“åŒ…tar tar tvf 1.tar # æŸ¥çœ‹tar tar -rvf 1.tar filename # ç»™tarè¿½åŠ æ–‡ä»¶ tar --exclude=/home/dmtsai --exclude=*.tar -zcvf myfile.tar.gz /home/* /etc # æ‰“åŒ…/home, /etc ï¼Œä½†æ’é™¤ /home/dmtsai tar -N \u0026#34;2005/06/01\u0026#34; -zcvf home.tar.gz /home # åœ¨ /home å½“ä¸­ï¼Œæ¯” 2005/06/01 æ–°çš„æ–‡ä»¶æ‰å¤‡ä»½ tar -zcvfh home.tar.gz /home # æ‰“åŒ…ç›®å½•ä¸­åŒ…æ‹¬è¿æ¥ç›®å½• tar zcf - ./ | ssh root@IP \u0026#34;tar zxf - -C /xxxx\u0026#34; # ä¸€è¾¹å‹ç¼©ä¸€è¾¹è§£å‹ zgrep str 1.gz # æŸ¥çœ‹å‹ç¼©åŒ…ä¸­æ–‡ä»¶å­—ç¬¦è¡Œ bzip2 -dv 1.tar.bz2 # è§£å‹bzip2 bzip2 -v 1.tar # bzip2å‹ç¼© bzcat # æŸ¥çœ‹bzip2 gzip file # ç›´æ¥å‹ç¼©æ–‡ä»¶ # å‹ç¼©åæºæ–‡ä»¶æ¶ˆå¤± gunzip file.gz # ç›´æ¥è§£å‹æ–‡ä»¶ # è§£å‹åæºæ–‡ä»¶æ¶ˆå¤± gzip -r dir/ # é€’å½’å‹ç¼©ç›®å½• gzip -r -d dir/ # é€’å½’è§£å‹ç›®å½• gzip -dv 1.tar.gz # è§£å‹gzipåˆ°tar gzip -v 1.tar # å‹ç¼©taråˆ°gz unzip zip.zip # è§£å‹zip zip zip.zip * # å‹ç¼©zip rar a rar.rar *.jpg # å‹ç¼©æ–‡ä»¶ä¸ºraråŒ… unrar x rar.rar # è§£å‹raråŒ… SVN GIT SVN GIT SVN 1 2 3 4 5 --force # å¼ºåˆ¶è¦†ç›– /usr/bin/svn --username user --password passwd co $Code ${SvnPath}src/ # æ£€å‡ºæ•´ä¸ªé¡¹ç›® /usr/bin/svn --username user --password passwd up $Code ${SvnPath}src/ # æ›´æ–°é¡¹ç›® /usr/bin/svn --username user --password passwd export $Code$File ${SvnPath}src/$File # å¯¼å‡ºä¸ªåˆ«æ–‡ä»¶ /usr/bin/svn --username user --password passwd export -r ç‰ˆæœ¬å· svnè·¯å¾„ æœ¬åœ°è·¯å¾„ --force # å¯¼å‡ºæŒ‡å®šç‰ˆæœ¬ GIT 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 git clone git@10.10.10.10:gittest.git ./gittest/ # å…‹éš†é¡¹ç›®åˆ°æŒ‡å®šç›®å½• git clone -b develop --depth=1 http://git.a.com/d.git # å…‹éš†æŒ‡å®šåˆ†æ”¯ å…‹éš†ä¸€å±‚ git status # Show the working tree(å·¥ä½œæ ‘) status git log -n 1 --stat # æŸ¥çœ‹æœ€åä¸€æ¬¡æ—¥å¿—æ–‡ä»¶ git branch -a # åˆ—å‡ºè¿œç¨‹è·Ÿè¸ªåˆ†æ”¯(remote-tracking branches)å’Œæœ¬åœ°åˆ†æ”¯ git checkout developing # åˆ‡æ¢åˆ°developingåˆ†æ”¯ git checkout -b release # åˆ‡æ¢åˆ†æ”¯æ²¡æœ‰ä»å½“å‰åˆ†æ”¯åˆ›å»º git checkout -b release origin/master # ä»è¿œç¨‹åˆ†æ”¯åˆ›å»ºæœ¬åœ°é•œåƒåˆ†æ”¯ git push origin --delete release # ä»è¿œç«¯åˆ é™¤åˆ†åŒºï¼ŒæœåŠ¡ç«¯æœ‰å¯èƒ½è®¾ç½®ä¿æŠ¤ä¸å…è®¸åˆ é™¤ git push origin release # æŠŠæœ¬åœ°åˆ†æ”¯æäº¤åˆ°è¿œç¨‹ git pull # æ›´æ–°é¡¹ç›® éœ€è¦cdåˆ°é¡¹ç›®ç›®å½•ä¸­ git fetch -f -p # æŠ“å–è¿œç«¯ä»£ç ä½†ä¸åˆå¹¶åˆ°å½“å‰ git reset --hard origin/master # å’Œè¿œç«¯åŒæ­¥åˆ†æ”¯ git add . # æ›´æ–°æ‰€æœ‰æ–‡ä»¶ git commit -m \u0026#34;gittest up\u0026#34; # æäº¤æ“ä½œå¹¶æ·»åŠ å¤‡æ³¨ git push # æ­£å¼æäº¤åˆ°è¿œç¨‹gitæœåŠ¡å™¨ git push [-u origin master] # æ­£å¼æäº¤åˆ°è¿œç¨‹gitæœåŠ¡å™¨(masteråˆ†æ”¯) git tag [-a] dev-v-0.11.54 [-m \u0026#39;fix #67\u0026#39;] # åˆ›å»ºtag,åä¸ºdev-v-0.11.54,å¤‡æ³¨fix #67 git tag -l dev-v-0.11.54 # æŸ¥çœ‹tag(dev-v-0.11.5) git push origin --tags # æäº¤tag git reset --hard # æœ¬åœ°æ¢å¤æ•´ä¸ªé¡¹ç›® git rm -r -n --cached ./img # -næ‰§è¡Œå‘½ä»¤æ—¶,ä¸ä¼šåˆ é™¤ä»»ä½•æ–‡ä»¶,è€Œæ˜¯å±•ç¤ºæ­¤å‘½ä»¤è¦åˆ é™¤çš„æ–‡ä»¶åˆ—è¡¨é¢„è§ˆ git rm -r --cached ./img # æ‰§è¡Œåˆ é™¤å‘½ä»¤ éœ€è¦commitå’Œpushè®©è¿œç¨‹ç”Ÿæ•ˆ git init --bare smc-content-check.git # åˆå§‹åŒ–æ–°gité¡¹ç›® éœ€è¦æ‰‹åŠ¨åˆ›å»ºæ­¤ç›®å½•å¹¶ç»™gitç”¨æˆ·æƒé™ chown -R git:git smc-content-check.git git config --global credential.helper store # è®°ä½å¯†ç  git config [--global] user.name \u0026#34;your name\u0026#34; # è®¾ç½®ä½ çš„ç”¨æˆ·å, å¸Œæœ›åœ¨ä¸€ä¸ªç‰¹å®šçš„é¡¹ç›®ä¸­ä½¿ç”¨ä¸åŒçš„ç”¨æˆ·æˆ–e-mailåœ°å€, ä¸è¦--globalé€‰é¡¹ git config [--global] user.email \u0026#34;your email\u0026#34; # è®¾ç½®ä½ çš„e-mailåœ°å€, æ¯æ¬¡Gitæäº¤éƒ½ä¼šä½¿ç”¨è¯¥ä¿¡æ¯ git config [--global] user.name # æŸ¥çœ‹ç”¨æˆ·å git config [--global] user.email # æŸ¥çœ‹ç”¨æˆ·e-mail git config --global --edit # ç¼–è¾‘~/.gitconfig(User-specific)é…ç½®æ–‡ä»¶, å€¼ä¼˜å…ˆçº§é«˜äº/etc/gitconfig(System-wide) git config --edit # ç¼–è¾‘.git/config(Repository specific)é…ç½®æ–‡ä»¶, å€¼ä¼˜å…ˆçº§é«˜äº~/.gitconfig git cherry-pick \u0026lt;commit id\u0026gt; # ç”¨äºæŠŠå¦ä¸€ä¸ªæœ¬åœ°åˆ†æ”¯çš„commitä¿®æ”¹åº”ç”¨åˆ°å½“å‰åˆ†æ”¯ éœ€è¦pushåˆ°è¿œç¨‹ git log --pretty=format:\u0026#39;%h: %s\u0026#39; 9378b62..HEAD # æŸ¥çœ‹æŒ‡å®šèŒƒå›´æ›´æ–°æ“ä½œ commit id git config --global core.ignorecase false # è®¾ç½®å…¨å±€å¤§å°å†™æ•æ„Ÿ git ls-remote --heads origin refs/heads/test # æŸ¥çœ‹ ä»è¿œç«¯æ‹‰ä¸€ä»½æ–°çš„{ # You have not concluded your merge (MERGE_HEAD exists) gitæ‹‰å–å¤±è´¥ git fetch --hard origin/master git reset --hard origin/master } åˆ é™¤è¿œç¨‹åˆ†æ”¯å¹¶æ–°å»º{ git checkout master git branch -r -d origin/test # åˆ é™¤è¿œç¨‹åˆ†æ”¯ ä½†æœ‰æ—¶å€™å¹¶æ²¡æœ‰åˆ é™¤ å¯ä»¥å°è¯•ä½¿ç”¨ä¸‹é¢çš„è¯­å¥ git push origin :test # æ¨é€ä¸€ä¸ªç©ºåˆ†æ”¯åˆ°è¿œç¨‹åˆ†æ”¯ï¼Œç›¸å½“äºåˆ é™¤è¿œç¨‹åˆ†æ”¯ git branch -d test # åˆ é™¤æœ¬åœ°teståˆ†æ”¯, -D å¼ºåˆ¶ git branch -a |grep test git checkout -b test git push origin test git reset --hard origin/test } è¿ç§»gité¡¹ç›®{ git branch -r | grep -v \u0026#39;\\-\u0026gt;\u0026#39; | while read remote; do git branch --track \u0026#34;${remote#origin/}\u0026#34; \u0026#34;$remote\u0026#34;; done git fetch --all git pull --all git remote set-url origin git@git.github.cn:server/gw.git git push --all } æ¢å¤rmåˆ é™¤çš„æ–‡ä»¶ 1 2 3 4 5 6 # debugfsé’ˆå¯¹ ext2 # ext3grepé’ˆå¯¹ ext3 # extundeleteé’ˆå¯¹ ext4 df -T # é¦–å…ˆæŸ¥çœ‹ç£ç›˜åˆ†åŒºæ ¼å¼ umount /data/ # å¸è½½æŒ‚è½½,æ•°æ®ä¸¢å¤±è¯·é¦–å…ˆå¸è½½æŒ‚è½½,æˆ–é‡æ–°æŒ‚è½½åªè¯» ext3grep /dev/sdb1 --ls --inode 2 # è®°å½•ä¿¡æ¯ç»§ç»­æŸ¥æ‰¾ç›®å½•ä¸‹æ–‡ä»¶inodeä¿¡æ¯ ext3grep /dev/sdb1 --ls --inode 131081 # æ­¤å¤„æ˜¯inode ext3grep /dev/sdb1 --restore-inode 49153 # è®°å½•ä¸‹inodeä¿¡æ¯å¼€å§‹æ¢å¤ç›®å½• openssl 1 2 3 4 5 6 7 8 openssl rand 15 -base64 # å£ä»¤ç”Ÿæˆ openssl sha1 filename # å“ˆå¸Œç®—æ³•æ ¡éªŒæ–‡ä»¶ openssl md5 filename # MD5æ ¡éªŒæ–‡ä»¶ openssl base64 filename.txt # base64ç¼–ç /è§£ç æ–‡ä»¶(å‘é€é‚®ä»¶é™„ä»¶ä¹‹ç±»åŠŸèƒ½ä¼šå¯ä»¥ä½¿ç”¨) openssl base64 -d filename.bin # base64ç¼–ç /è§£ç äºŒè¿›åˆ¶æ–‡ä»¶ openssl enc -aes-128-cbc filename.aes-128-cbc # åŠ å¯†æ–‡æ¡£ # æ¨èä½¿ç”¨çš„åŠ å¯†ç®—æ³•æ˜¯bf(Blowfish)å’Œ-aes-128-cbc(è¿è¡Œåœ¨CBCæ¨¡å¼çš„128ä½å¯†åŒ™AESåŠ å¯†ç®—æ³•)ï¼ŒåŠ å¯†å¼ºåº¦æœ‰ä¿éšœ openssl enc -d -aes-128-cbc -in filename.aes-128-cbc \u0026gt; filename # è§£å¯†æ–‡æ¡£ è½¯ä»¶ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 rpm{ rpm -ivh lynx # rpmå®‰è£… rpm -e lynx # å¸è½½åŒ… rpm -e lynx --nodeps # å¼ºåˆ¶å¸è½½ rpm -qa # æŸ¥çœ‹æ‰€æœ‰å®‰è£…çš„rpmåŒ… rpm -qa | grep lynx # æŸ¥æ‰¾åŒ…æ˜¯å¦å®‰è£… rpm -ql # è½¯ä»¶åŒ…è·¯å¾„ rpm -Uvh # å‡çº§åŒ… rpm --test lynx # æµ‹è¯• rpm -qc # è½¯ä»¶åŒ…é…ç½®æ–‡æ¡£ rpm --initdb # åˆå§‹åŒ–rpm æ•°æ®åº“ rpm --rebuilddb # é‡å»ºrpmæ•°æ®åº“ åœ¨rpmå’Œyumæ— å“åº”çš„æƒ…å†µä½¿ç”¨ å…ˆ rm -f /var/lib/rpm/__db.00* åœ¨é‡å»º } yum{ yum list # æ‰€æœ‰è½¯ä»¶åˆ—è¡¨ yum install åŒ…å # å®‰è£…åŒ…å’Œä¾èµ–åŒ… yum -y update # å‡çº§æ‰€æœ‰åŒ…ç‰ˆæœ¬,ä¾èµ–å…³ç³»ï¼Œç³»ç»Ÿç‰ˆæœ¬å†…æ ¸éƒ½å‡çº§ yum -y update è½¯ä»¶åŒ…å # å‡çº§æŒ‡å®šçš„è½¯ä»¶åŒ… yum -y upgrade # ä¸æ”¹å˜è½¯ä»¶è®¾ç½®æ›´æ–°è½¯ä»¶ï¼Œç³»ç»Ÿç‰ˆæœ¬å‡çº§ï¼Œå†…æ ¸ä¸æ”¹å˜ yum search mail # yumæœç´¢ç›¸å…³åŒ… yum grouplist # è½¯ä»¶åŒ…ç»„ yum -y groupinstall \u0026#34;Virtualization\u0026#34; # å®‰è£…è½¯ä»¶åŒ…ç»„ repoquery -ql gstreamer # ä¸å®‰è£…è½¯ä»¶æŸ¥çœ‹åŒ…å«æ–‡ä»¶ yum clean all # æ¸…é™¤varä¸‹ç¼“å­˜ } yumä½¿ç”¨epelæº{ # åŒ…ä¸‹è½½åœ°å€: http://download.fedoraproject.org/pub/epel # é€‰æ‹©ç‰ˆæœ¬5\\6\\7 rpm -Uvh http://mirrors.hustunique.com/epel//6/x86_64/epel-release-6-8.noarch.rpm # è‡ªé€‚é…ç‰ˆæœ¬ yum install epel-release } è‡ªå®šä¹‰yumæº{ find /etc/yum.repos.d -name \u0026#34;*.repo\u0026#34; -exec mv {} {}.bak \\; vim /etc/yum.repos.d/yum.repo [yum] #http baseurl=http://10.0.0.1/centos5.5 #æŒ‚è½½iso #mount -o loop CentOS-5.8-x86_64-bin-DVD-1of2.iso /data/iso/ #æœ¬åœ° #baseurl=file:///data/iso/ enable=1 #å¯¼å…¥key rpm --import /etc/pki/rpm-gpg/RPM-GPG-KEY-CentOS-5 } ç¼–è¯‘{ æºç å®‰è£…{ ./configure --help # æŸ¥çœ‹æ‰€æœ‰ç¼–è¯‘å‚æ•° ./configure --prefix=/usr/local/ # é…ç½®å‚æ•° make # ç¼–è¯‘ # make -j 8 # å¤šçº¿ç¨‹ç¼–è¯‘,é€Ÿåº¦è¾ƒå¿«,ä½†æœ‰äº›è½¯ä»¶ä¸æ”¯æŒ make install # å®‰è£…åŒ… make clean # æ¸…é™¤ç¼–è¯‘ç»“æœ } perlç¨‹åºç¼–è¯‘{ perl Makefile.PL make make test make install } pythonç¨‹åºç¼–è¯‘{ python file.py # æºç åŒ…ç¼–è¯‘å®‰è£… python setup.py build python setup.py install } ç¼–è¯‘cç¨‹åº{ gcc -g hello.c -o hello } } ç³»ç»Ÿ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 wall # ç»™å…¶å®ƒç”¨æˆ·å‘æ¶ˆæ¯ whereis ls # æœç´¢ç¨‹åºåï¼Œè€Œä¸”åªæœç´¢äºŒè¿›åˆ¶æ–‡ä»¶ which # æŸ¥æ‰¾å‘½ä»¤æ˜¯å¦å­˜åœ¨,åŠå­˜æ”¾ä½ç½® locate # ä¸æ˜¯å®æ—¶æŸ¥æ‰¾ï¼ŒæŸ¥æ‰¾çš„ç»“æœä¸ç²¾ç¡®ï¼Œä½†æŸ¥æ‰¾é€Ÿåº¦å¾ˆå¿« æ¯å¤©æ›´æ–° /var/lib/locatedb clear # æ¸…ç©ºæ•´ä¸ªå±å¹• reset # é‡æ–°åˆå§‹åŒ–å±å¹• cal # æ˜¾ç¤ºæœˆå† echo -n 123456 | md5sum # md5åŠ å¯† mkpasswd # éšæœºç”Ÿæˆå¯†ç  -lä½æ•° -Cå¤§å° -cå°å†™ -dæ•°å­— -sç‰¹æ®Šå­—ç¬¦ netstat -ntupl | grep port # æ˜¯å¦æ‰“å¼€äº†æŸä¸ªç«¯å£ ntpdate cn.pool.ntp.org # åŒæ­¥æ—¶é—´, pool.ntp.org: public ntp time server for everyone(http://www.pool.ntp.org/zh/) tzselect # é€‰æ‹©æ—¶åŒº #+8=(5 9 1 1) # (TZ=\u0026#39;Asia/Shanghai\u0026#39;; export TZ)æ‹¬å·å†…å†™å…¥ /etc/profile /sbin/hwclock -w # æ—¶é—´ä¿å­˜åˆ°ç¡¬ä»¶ /etc/shadow # è´¦æˆ·å½±å­æ–‡ä»¶ LANG=en # ä¿®æ”¹è¯­è¨€ vim /etc/sysconfig/i18n # ä¿®æ”¹ç¼–ç  LANG=\u0026#34;en_US.UTF-8\u0026#34; export LC_ALL=C # å¼ºåˆ¶å­—ç¬¦é›† vi /etc/hosts # æŸ¥è¯¢é™æ€ä¸»æœºå alias # åˆ«å watch uptime # ç›‘æµ‹å‘½ä»¤åŠ¨æ€åˆ·æ–° ç›‘è§† ipcs -a # æŸ¥çœ‹Linuxç³»ç»Ÿå½“å‰å•ä¸ªå…±äº«å†…å­˜æ®µçš„æœ€å¤§å€¼ ldconfig # åŠ¨æ€é“¾æ¥åº“ç®¡ç†å‘½ä»¤ ldd `which cmd` # æŸ¥çœ‹å‘½ä»¤çš„ä¾èµ–åº“ dist-upgrade # ä¼šæ”¹å˜é…ç½®æ–‡ä»¶,æ”¹å˜æ—§çš„ä¾èµ–å…³ç³»ï¼Œæ”¹å˜ç³»ç»Ÿç‰ˆæœ¬ /boot/grub/grub.conf # grubå¯åŠ¨é¡¹é…ç½® ps -mfL \u0026lt;PID\u0026gt; # æŸ¥çœ‹æŒ‡å®šè¿›ç¨‹å¯åŠ¨çš„çº¿ç¨‹ çº¿ç¨‹æ•°å— max user processes é™åˆ¶ ps uxm |wc -l # æŸ¥çœ‹å½“å‰ç”¨æˆ·å ç”¨çš„è¿›ç¨‹æ•° [åŒ…æ‹¬çº¿ç¨‹] max user processes top -p PID -H # æŸ¥çœ‹æŒ‡å®šPIDè¿›ç¨‹åŠçº¿ç¨‹ lsof |wc -l # æŸ¥çœ‹å½“å‰æ–‡ä»¶å¥æŸ„æ•°ä½¿ç”¨æ•°é‡ open files lsof |grep /lib # æŸ¥çœ‹åŠ è½½åº“æ–‡ä»¶ sysctl -a # æŸ¥çœ‹å½“å‰æ‰€æœ‰ç³»ç»Ÿå†…æ ¸å‚æ•° sysctl -p # ä¿®æ”¹å†…æ ¸å‚æ•°/etc/sysctl.confï¼Œè®©/etc/rc.d/rc.sysinitè¯»å–ç”Ÿæ•ˆ strace -p pid # è·Ÿè¸ªç³»ç»Ÿè°ƒç”¨ ps -eo \u0026#34;%p %C %z %a\u0026#34;|sort -k3 -n # æŠŠè¿›ç¨‹æŒ‰å†…å­˜ä½¿ç”¨å¤§å°æ’åº strace uptime 2\u0026gt;\u0026amp;1|grep open # æŸ¥çœ‹å‘½ä»¤æ‰“å¼€çš„ç›¸å…³æ–‡ä»¶ grep Hugepagesize /proc/meminfo # å†…å­˜åˆ†é¡µå¤§å° mkpasswd -l 8 -C 2 -c 2 -d 4 -s 0 # éšæœºç”ŸæˆæŒ‡å®šç±»å‹å¯†ç  echo 1 \u0026gt; /proc/sys/net/ipv4/tcp_syncookies # ä½¿TCP SYN Cookie ä¿æŠ¤ç”Ÿæ•ˆ # \u0026#34;SYN Attack\u0026#34;æ˜¯ä¸€ç§æ‹’ç»æœåŠ¡çš„æ”»å‡»æ–¹å¼ grep Swap /proc/25151/smaps |awk \u0026#39;{a+=$2}END{print a}\u0026#39; # æŸ¥è¯¢æŸpidä½¿ç”¨çš„swapå¤§å° redir --lport=33060 --caddr=10.10.10.78 --cport=3306 # ç«¯å£æ˜ å°„ yumå®‰è£… ç”¨supervisorå®ˆæŠ¤ å¼€æœºå¯åŠ¨è„šæœ¬é¡ºåº 1 2 3 4 5 /etc/profile /etc/profile.d/*.sh ~/bash_profile ~/.bashrc /etc/bashrc è¿›ç¨‹ç®¡ç† 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 ps -eaf # æŸ¥çœ‹æ‰€æœ‰è¿›ç¨‹ kill -9 PID # å¼ºåˆ¶ç»ˆæ­¢æŸä¸ªPIDè¿›ç¨‹ kill -15 PID # å®‰å…¨é€€å‡º éœ€ç¨‹åºå†…éƒ¨å¤„ç†ä¿¡å· cmd \u0026amp; # å‘½ä»¤åå°è¿è¡Œ nohup cmd \u0026amp; # åå°è¿è¡Œä¸å—shellé€€å‡ºå½±å“ ctrl+z # å°†å‰å°æ”¾å…¥åå°(æš‚åœ) jobs # æŸ¥çœ‹åå°è¿è¡Œç¨‹åº bg 2 # å¯åŠ¨åå°æš‚åœè¿›ç¨‹ fg 2 # è°ƒå›åå°è¿›ç¨‹ pstree # è¿›ç¨‹æ ‘ vmstat 1 9 # æ¯éš”ä¸€ç§’æŠ¥å‘Šç³»ç»Ÿæ€§èƒ½ä¿¡æ¯9æ¬¡ sar # æŸ¥çœ‹cpuç­‰çŠ¶æ€ lsof file # æ˜¾ç¤ºæ‰“å¼€æŒ‡å®šæ–‡ä»¶çš„æ‰€æœ‰è¿›ç¨‹ lsof -i:32768 # æŸ¥çœ‹ç«¯å£çš„è¿›ç¨‹ renice +1 180 # æŠŠ180å·è¿›ç¨‹çš„ä¼˜å…ˆçº§åŠ 1 exec sh a.sh # å­è¿›ç¨‹æ›¿æ¢åŸæ¥ç¨‹åºçš„pidï¼Œ é¿å…supervisoræ— æ³•å¼ºåˆ¶æ€æ­»è¿›ç¨‹ ps 1 2 3 4 5 6 7 8 9 10 ps aux |grep -v USER | sort -nk +4 | tail # æ˜¾ç¤ºæ¶ˆè€—å†…å­˜æœ€å¤šçš„10ä¸ªè¿è¡Œä¸­çš„è¿›ç¨‹ï¼Œä»¥å†…å­˜ä½¿ç”¨é‡æ’åº.cpu +3 # USER PID %CPU %MEM VSZ RSS TTY STAT START TIME COMMAND %CPU # è¿›ç¨‹çš„cpuå ç”¨ç‡ %MEM # è¿›ç¨‹çš„å†…å­˜å ç”¨ç‡ VSZ # è¿›ç¨‹è™šæ‹Ÿå¤§å°,å•ä½K(å³æ€»å ç”¨å†…å­˜å¤§å°,åŒ…æ‹¬çœŸå®å†…å­˜å’Œè™šæ‹Ÿå†…å­˜) RSS # è¿›ç¨‹ä½¿ç”¨çš„é©»ç•™é›†å¤§å°å³å®é™…ç‰©ç†å†…å­˜å¤§å° START # è¿›ç¨‹å¯åŠ¨æ—¶é—´å’Œæ—¥æœŸ å ç”¨çš„è™šæ‹Ÿå†…å­˜å¤§å° = VSZ - RSS ps -eo pid,lstart,etime,args # æŸ¥çœ‹è¿›ç¨‹å¯åŠ¨æ—¶é—´ top 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 å‰äº”è¡Œæ˜¯ç³»ç»Ÿæ•´ä½“çš„ç»Ÿè®¡ä¿¡æ¯ã€‚ ç¬¬ä¸€è¡Œ: ä»»åŠ¡é˜Ÿåˆ—ä¿¡æ¯ï¼ŒåŒ uptime å‘½ä»¤çš„æ‰§è¡Œç»“æœã€‚å†…å®¹å¦‚ä¸‹ï¼š 01:06:48 å½“å‰æ—¶é—´ up 1:22 ç³»ç»Ÿè¿è¡Œæ—¶é—´ï¼Œæ ¼å¼ä¸ºæ—¶:åˆ† 1 user å½“å‰ç™»å½•ç”¨æˆ·æ•° load average: 0.06, 0.60, 0.48 ç³»ç»Ÿè´Ÿè½½ï¼Œå³ä»»åŠ¡é˜Ÿåˆ—çš„å¹³å‡é•¿åº¦ã€‚ ä¸‰ä¸ªæ•°å€¼åˆ†åˆ«ä¸º 1åˆ†é’Ÿã€5åˆ†é’Ÿã€15åˆ†é’Ÿå‰åˆ°ç°åœ¨çš„å¹³å‡å€¼ã€‚ ç¬¬äºŒã€ä¸‰è¡Œ:ä¸ºè¿›ç¨‹å’ŒCPUçš„ä¿¡æ¯ã€‚å½“æœ‰å¤šä¸ªCPUæ—¶ï¼Œè¿™äº›å†…å®¹å¯èƒ½ä¼šè¶…è¿‡ä¸¤è¡Œã€‚å†…å®¹å¦‚ä¸‹ï¼š Tasks: 29 total è¿›ç¨‹æ€»æ•° 1 running æ­£åœ¨è¿è¡Œçš„è¿›ç¨‹æ•° 28 sleeping ç¡çœ çš„è¿›ç¨‹æ•° 0 stopped åœæ­¢çš„è¿›ç¨‹æ•° 0 zombie åƒµå°¸è¿›ç¨‹æ•° Cpu(s): 0.3% us ç”¨æˆ·ç©ºé—´å ç”¨CPUç™¾åˆ†æ¯” 1.0% sy å†…æ ¸ç©ºé—´å ç”¨CPUç™¾åˆ†æ¯” 0.0% ni ç”¨æˆ·è¿›ç¨‹ç©ºé—´å†…æ”¹å˜è¿‡ä¼˜å…ˆçº§çš„è¿›ç¨‹å ç”¨CPUç™¾åˆ†æ¯” 98.7% id ç©ºé—²CPUç™¾åˆ†æ¯” 0.0% wa ç­‰å¾…è¾“å…¥è¾“å‡ºçš„CPUæ—¶é—´ç™¾åˆ†æ¯” 0.0% hi 0.0% si ç¬¬å››ã€äº”è¡Œ:ä¸ºå†…å­˜ä¿¡æ¯ã€‚å†…å®¹å¦‚ä¸‹ï¼š Mem: 191272k total ç‰©ç†å†…å­˜æ€»é‡ 173656k used ä½¿ç”¨çš„ç‰©ç†å†…å­˜æ€»é‡ 17616k free ç©ºé—²å†…å­˜æ€»é‡ 22052k buffers ç”¨ä½œå†…æ ¸ç¼“å­˜çš„å†…å­˜é‡ Swap: 192772k total äº¤æ¢åŒºæ€»é‡ 0k used ä½¿ç”¨çš„äº¤æ¢åŒºæ€»é‡ 192772k free ç©ºé—²äº¤æ¢åŒºæ€»é‡ 123988k cached ç¼“å†²çš„äº¤æ¢åŒºæ€»é‡ã€‚ å†…å­˜ä¸­çš„å†…å®¹è¢«æ¢å‡ºåˆ°äº¤æ¢åŒºï¼Œè€Œååˆè¢«æ¢å…¥åˆ°å†…å­˜ï¼Œä½†ä½¿ç”¨è¿‡çš„äº¤æ¢åŒºå°šæœªè¢«è¦†ç›–ï¼Œ è¯¥æ•°å€¼å³ä¸ºè¿™äº›å†…å®¹å·²å­˜åœ¨äºå†…å­˜ä¸­çš„äº¤æ¢åŒºçš„å¤§å°ã€‚ ç›¸åº”çš„å†…å­˜å†æ¬¡è¢«æ¢å‡ºæ—¶å¯ä¸å¿…å†å¯¹äº¤æ¢åŒºå†™å…¥ã€‚ è¿›ç¨‹ä¿¡æ¯åŒº,å„åˆ—çš„å«ä¹‰å¦‚ä¸‹: # æ˜¾ç¤ºå„ä¸ªè¿›ç¨‹çš„è¯¦ç»†ä¿¡æ¯ åºå· åˆ—å å«ä¹‰ a PID è¿›ç¨‹id b PPID çˆ¶è¿›ç¨‹id c RUSER Real user name d UID è¿›ç¨‹æ‰€æœ‰è€…çš„ç”¨æˆ·id e USER è¿›ç¨‹æ‰€æœ‰è€…çš„ç”¨æˆ·å f GROUP è¿›ç¨‹æ‰€æœ‰è€…çš„ç»„å g TTY å¯åŠ¨è¿›ç¨‹çš„ç»ˆç«¯åã€‚ä¸æ˜¯ä»ç»ˆç«¯å¯åŠ¨çš„è¿›ç¨‹åˆ™æ˜¾ç¤ºä¸º ? h PR ä¼˜å…ˆçº§ i NI niceå€¼ã€‚è´Ÿå€¼è¡¨ç¤ºé«˜ä¼˜å…ˆçº§ï¼Œæ­£å€¼è¡¨ç¤ºä½ä¼˜å…ˆçº§ j P æœ€åä½¿ç”¨çš„CPUï¼Œä»…åœ¨å¤šCPUç¯å¢ƒä¸‹æœ‰æ„ä¹‰ k %CPU ä¸Šæ¬¡æ›´æ–°åˆ°ç°åœ¨çš„CPUæ—¶é—´å ç”¨ç™¾åˆ†æ¯” l TIME è¿›ç¨‹ä½¿ç”¨çš„CPUæ—¶é—´æ€»è®¡ï¼Œå•ä½ç§’ m TIME+ è¿›ç¨‹ä½¿ç”¨çš„CPUæ—¶é—´æ€»è®¡ï¼Œå•ä½1/100ç§’ n %MEM è¿›ç¨‹ä½¿ç”¨çš„ç‰©ç†å†…å­˜ç™¾åˆ†æ¯” o VIRT è¿›ç¨‹ä½¿ç”¨çš„è™šæ‹Ÿå†…å­˜æ€»é‡ï¼Œå•ä½kbã€‚VIRT=SWAP+RES p SWAP è¿›ç¨‹ä½¿ç”¨çš„è™šæ‹Ÿå†…å­˜ä¸­ï¼Œè¢«æ¢å‡ºçš„å¤§å°ï¼Œå•ä½kbã€‚ q RES è¿›ç¨‹ä½¿ç”¨çš„ã€æœªè¢«æ¢å‡ºçš„ç‰©ç†å†…å­˜å¤§å°ï¼Œå•ä½kbã€‚RES=CODE+DATA r CODE å¯æ‰§è¡Œä»£ç å ç”¨çš„ç‰©ç†å†…å­˜å¤§å°ï¼Œå•ä½kb s DATA å¯æ‰§è¡Œä»£ç ä»¥å¤–çš„éƒ¨åˆ†(æ•°æ®æ®µ+æ ˆ)å ç”¨çš„ç‰©ç†å†…å­˜å¤§å°ï¼Œå•ä½kb t SHR å…±äº«å†…å­˜å¤§å°ï¼Œå•ä½kb u nFLT é¡µé¢é”™è¯¯æ¬¡æ•° v nDRT æœ€åä¸€æ¬¡å†™å…¥åˆ°ç°åœ¨ï¼Œè¢«ä¿®æ”¹è¿‡çš„é¡µé¢æ•°ã€‚ w S è¿›ç¨‹çŠ¶æ€ã€‚ D=ä¸å¯ä¸­æ–­çš„ç¡çœ çŠ¶æ€ R=è¿è¡Œ S=ç¡çœ  T=è·Ÿè¸ª/åœæ­¢ Z=åƒµå°¸è¿›ç¨‹ çˆ¶è¿›ç¨‹åœ¨ä½†å¹¶ä¸ç­‰å¾…å­è¿›ç¨‹ x COMMAND å‘½ä»¤å/å‘½ä»¤è¡Œ y WCHAN è‹¥è¯¥è¿›ç¨‹åœ¨ç¡çœ ï¼Œåˆ™æ˜¾ç¤ºç¡çœ ä¸­çš„ç³»ç»Ÿå‡½æ•°å z Flags ä»»åŠ¡æ ‡å¿—ï¼Œå‚è€ƒ sched.h inuxæ“ä½œç³»ç»Ÿæä¾›çš„ä¿¡å· 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 kill -l # æŸ¥çœ‹linuxæä¾›çš„ä¿¡å· trap \u0026#34;echo aaa\u0026#34; 2 3 15 # shellä½¿ç”¨ trap æ•æ‰é€€å‡ºä¿¡å· # å‘é€ä¿¡å·ä¸€èˆ¬æœ‰ä¸¤ç§åŸå› : # 1(è¢«åŠ¨å¼) å†…æ ¸æ£€æµ‹åˆ°ä¸€ä¸ªç³»ç»Ÿäº‹ä»¶.ä¾‹å¦‚å­è¿›ç¨‹é€€å‡ºä¼šåƒçˆ¶è¿›ç¨‹å‘é€SIGCHLDä¿¡å·.é”®ç›˜æŒ‰ä¸‹control+cä¼šå‘é€SIGINTä¿¡å· # 2(ä¸»åŠ¨å¼) é€šè¿‡ç³»ç»Ÿè°ƒç”¨killæ¥å‘æŒ‡å®šè¿›ç¨‹å‘é€ä¿¡å· # è¿›ç¨‹ç»“æŸä¿¡å· SIGTERM å’Œ SIGKILL çš„åŒºåˆ«: SIGTERM æ¯”è¾ƒå‹å¥½ï¼Œè¿›ç¨‹èƒ½æ•æ‰è¿™ä¸ªä¿¡å·ï¼Œæ ¹æ®æ‚¨çš„éœ€è¦æ¥å…³é—­ç¨‹åºã€‚åœ¨å…³é—­ç¨‹åºä¹‹å‰ï¼Œæ‚¨å¯ä»¥ç»“æŸæ‰“å¼€çš„è®°å½•æ–‡ä»¶å’Œå®Œæˆæ­£åœ¨åšçš„ä»»åŠ¡ã€‚åœ¨æŸäº›æƒ…å†µä¸‹ï¼Œå‡å¦‚è¿›ç¨‹æ­£åœ¨è¿›è¡Œä½œä¸šè€Œä¸”ä¸èƒ½ä¸­æ–­ï¼Œé‚£ä¹ˆè¿›ç¨‹å¯ä»¥å¿½ç•¥è¿™ä¸ªSIGTERMä¿¡å·ã€‚ # å¦‚æœä¸€ä¸ªè¿›ç¨‹æ”¶åˆ°ä¸€ä¸ªSIGUSR1ä¿¡å·ï¼Œç„¶åæ‰§è¡Œä¿¡å·ç»‘å®šå‡½æ•°ï¼Œç¬¬äºŒä¸ªSIGUSR2ä¿¡å·åˆæ¥äº†ï¼Œç¬¬ä¸€ä¸ªä¿¡å·æ²¡æœ‰è¢«å¤„ç†å®Œæ¯•çš„è¯ï¼Œç¬¬äºŒä¸ªä¿¡å·å°±ä¼šä¸¢å¼ƒã€‚ SIGHUP 1 A # ç»ˆç«¯æŒ‚èµ·æˆ–è€…æ§åˆ¶è¿›ç¨‹ç»ˆæ­¢ SIGINT 2 A # é”®ç›˜ç»ˆç«¯è¿›ç¨‹(å¦‚control+c) SIGQUIT 3 C # é”®ç›˜çš„é€€å‡ºé”®è¢«æŒ‰ä¸‹ SIGILL 4 C # éæ³•æŒ‡ä»¤ SIGABRT 6 C # ç”±abort(3)å‘å‡ºçš„é€€å‡ºæŒ‡ä»¤ SIGFPE 8 C # æµ®ç‚¹å¼‚å¸¸ SIGKILL 9 AEF # Killä¿¡å· ç«‹åˆ»åœæ­¢ SIGSEGV 11 C # æ— æ•ˆçš„å†…å­˜å¼•ç”¨ SIGPIPE 13 A # ç®¡é“ç ´è£‚: å†™ä¸€ä¸ªæ²¡æœ‰è¯»ç«¯å£çš„ç®¡é“ SIGALRM 14 A # é—¹é’Ÿä¿¡å· ç”±alarm(2)å‘å‡ºçš„ä¿¡å· SIGTERM 15 A # ç»ˆæ­¢ä¿¡å·,å¯è®©ç¨‹åºå®‰å…¨é€€å‡º kill -15 SIGUSR1 30,10,16 A # ç”¨æˆ·è‡ªå®šä¹‰ä¿¡å·1 SIGUSR2 31,12,17 A # ç”¨æˆ·è‡ªå®šä¹‰ä¿¡å·2 SIGCHLD 20,17,18 B # å­è¿›ç¨‹ç»“æŸè‡ªåŠ¨å‘çˆ¶è¿›ç¨‹å‘é€SIGCHLDä¿¡å· SIGCONT 19,18,25 # è¿›ç¨‹ç»§ç»­ï¼ˆæ›¾è¢«åœæ­¢çš„è¿›ç¨‹ï¼‰ SIGSTOP 17,19,23 DEF # ç»ˆæ­¢è¿›ç¨‹ SIGTSTP 18,20,24 D # æ§åˆ¶ç»ˆç«¯ï¼ˆttyï¼‰ä¸ŠæŒ‰ä¸‹åœæ­¢é”® SIGTTIN 21,21,26 D # åå°è¿›ç¨‹ä¼å›¾ä»æ§åˆ¶ç»ˆç«¯è¯» SIGTTOU 22,22,27 D # åå°è¿›ç¨‹ä¼å›¾ä»æ§åˆ¶ç»ˆç«¯å†™ ç¼ºçœå¤„ç†åŠ¨ä½œä¸€é¡¹ä¸­çš„å­—æ¯å«ä¹‰å¦‚ä¸‹: A ç¼ºçœçš„åŠ¨ä½œæ˜¯ç»ˆæ­¢è¿›ç¨‹ B ç¼ºçœçš„åŠ¨ä½œæ˜¯å¿½ç•¥æ­¤ä¿¡å·ï¼Œå°†è¯¥ä¿¡å·ä¸¢å¼ƒï¼Œä¸åšå¤„ç† C ç¼ºçœçš„åŠ¨ä½œæ˜¯ç»ˆæ­¢è¿›ç¨‹å¹¶è¿›è¡Œå†…æ ¸æ˜ åƒè½¬å‚¨(dump core),å†…æ ¸æ˜ åƒè½¬å‚¨æ˜¯æŒ‡å°†è¿›ç¨‹æ•°æ®åœ¨å†…å­˜çš„æ˜ åƒå’Œè¿›ç¨‹åœ¨å†…æ ¸ç»“æ„ä¸­çš„éƒ¨åˆ†å†…å®¹ä»¥ä¸€å®šæ ¼å¼è½¬å‚¨åˆ°æ–‡ä»¶ç³»ç»Ÿï¼Œå¹¶ä¸”è¿›ç¨‹é€€å‡ºæ‰§è¡Œï¼Œè¿™æ ·åšçš„å¥½å¤„æ˜¯ä¸ºç¨‹åºå‘˜æä¾›äº†æ–¹ä¾¿ï¼Œä½¿å¾—ä»–ä»¬å¯ä»¥å¾—åˆ°è¿›ç¨‹å½“æ—¶æ‰§è¡Œæ—¶çš„æ•°æ®å€¼ï¼Œå…è®¸ä»–ä»¬ç¡®å®šè½¬å‚¨çš„åŸå› ï¼Œå¹¶ä¸”å¯ä»¥è°ƒè¯•ä»–ä»¬çš„ç¨‹åºã€‚ D ç¼ºçœçš„åŠ¨ä½œæ˜¯åœæ­¢è¿›ç¨‹ï¼Œè¿›å…¥åœæ­¢çŠ¶å†µä»¥åè¿˜èƒ½é‡æ–°è¿›è¡Œä¸‹å»ï¼Œä¸€èˆ¬æ˜¯åœ¨è°ƒè¯•çš„è¿‡ç¨‹ä¸­ï¼ˆä¾‹å¦‚ptraceç³»ç»Ÿè°ƒç”¨ï¼‰ E ä¿¡å·ä¸èƒ½è¢«æ•è· F ä¿¡å·ä¸èƒ½è¢«å¿½ç•¥ ç³»ç»Ÿæ€§èƒ½çŠ¶æ€ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 vmstat 1 9 r # ç­‰å¾…æ‰§è¡Œçš„ä»»åŠ¡æ•°ã€‚å½“è¿™ä¸ªå€¼è¶…è¿‡äº†cpuçº¿ç¨‹æ•°ï¼Œå°±ä¼šå‡ºç°cpuç“¶é¢ˆã€‚ b # ç­‰å¾…IOçš„è¿›ç¨‹æ•°é‡,è¡¨ç¤ºé˜»å¡çš„è¿›ç¨‹ã€‚ swpd # è™šæ‹Ÿå†…å­˜å·²ä½¿ç”¨çš„å¤§å°ï¼Œå¦‚å¤§äº0ï¼Œè¡¨ç¤ºæœºå™¨ç‰©ç†å†…å­˜ä¸è¶³ï¼Œå¦‚ä¸æ˜¯ç¨‹åºå†…å­˜æ³„éœ²ï¼Œé‚£ä¹ˆè¯¥å‡çº§å†…å­˜ã€‚ free # ç©ºé—²çš„ç‰©ç†å†…å­˜çš„å¤§å° buff # å·²ç”¨çš„buffå¤§å°ï¼Œå¯¹å—è®¾å¤‡çš„è¯»å†™è¿›è¡Œç¼“å†² cache # cacheç›´æ¥ç”¨æ¥è®°å¿†æˆ‘ä»¬æ‰“å¼€çš„æ–‡ä»¶,ç»™æ–‡ä»¶åšç¼“å†²ï¼Œ(æŠŠç©ºé—²çš„ç‰©ç†å†…å­˜çš„ä¸€éƒ¨åˆ†æ‹¿æ¥åšæ–‡ä»¶å’Œç›®å½•çš„ç¼“å­˜ï¼Œæ˜¯ä¸ºäº†æé«˜ ç¨‹åºæ‰§è¡Œçš„æ€§èƒ½ï¼Œå½“ç¨‹åºä½¿ç”¨å†…å­˜æ—¶ï¼Œbuffer/cachedä¼šå¾ˆå¿«åœ°è¢«ä½¿ç”¨ã€‚) inact # éæ´»è·ƒå†…å­˜å¤§å°ï¼Œå³è¢«æ ‡æ˜å¯å›æ”¶çš„å†…å­˜ï¼ŒåŒºåˆ«äºfreeå’Œactive -aé€‰é¡¹æ—¶æ˜¾ç¤º active # æ´»è·ƒçš„å†…å­˜å¤§å° -aé€‰é¡¹æ—¶æ˜¾ç¤º si # æ¯ç§’ä»ç£ç›˜è¯»å…¥è™šæ‹Ÿå†…å­˜çš„å¤§å°ï¼Œå¦‚æœè¿™ä¸ªå€¼å¤§äº0ï¼Œè¡¨ç¤ºç‰©ç†å†…å­˜ä¸å¤Ÿç”¨æˆ–è€…å†…å­˜æ³„éœ²ï¼Œè¦æŸ¥æ‰¾è€—å†…å­˜è¿›ç¨‹è§£å†³æ‰ã€‚ so # æ¯ç§’è™šæ‹Ÿå†…å­˜å†™å…¥ç£ç›˜çš„å¤§å°ï¼Œå¦‚æœè¿™ä¸ªå€¼å¤§äº0ï¼ŒåŒä¸Šã€‚ bi # å—è®¾å¤‡æ¯ç§’æ¥æ”¶çš„å—æ•°é‡ï¼Œè¿™é‡Œçš„å—è®¾å¤‡æ˜¯æŒ‡ç³»ç»Ÿä¸Šæ‰€æœ‰çš„ç£ç›˜å’Œå…¶ä»–å—è®¾å¤‡ï¼Œé»˜è®¤å—å¤§å°æ˜¯1024byte bo # å—è®¾å¤‡æ¯ç§’å‘é€çš„å—æ•°é‡ï¼Œä¾‹å¦‚è¯»å–æ–‡ä»¶ï¼Œboå°±è¦å¤§äº0ã€‚biå’Œboä¸€èˆ¬éƒ½è¦æ¥è¿‘0ï¼Œä¸ç„¶å°±æ˜¯IOè¿‡äºé¢‘ç¹ï¼Œéœ€è¦è°ƒæ•´ã€‚ in # æ¯ç§’CPUçš„ä¸­æ–­æ¬¡æ•°ï¼ŒåŒ…æ‹¬æ—¶é—´ä¸­æ–­ã€‚inå’Œcsè¿™ä¸¤ä¸ªå€¼è¶Šå¤§ï¼Œä¼šçœ‹åˆ°ç”±å†…æ ¸æ¶ˆè€—çš„cpuæ—¶é—´ä¼šè¶Šå¤š cs # æ¯ç§’ä¸Šä¸‹æ–‡åˆ‡æ¢æ¬¡æ•°ï¼Œä¾‹å¦‚æˆ‘ä»¬è°ƒç”¨ç³»ç»Ÿå‡½æ•°ï¼Œå°±è¦è¿›è¡Œä¸Šä¸‹æ–‡åˆ‡æ¢ï¼Œçº¿ç¨‹çš„åˆ‡æ¢ï¼Œä¹Ÿè¦è¿›ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢ï¼Œè¿™ä¸ªå€¼è¦è¶Šå°è¶Šå¥½ï¼Œå¤ªå¤§äº†ï¼Œè¦è€ƒè™‘è°ƒä½çº¿ç¨‹æˆ–è€…è¿›ç¨‹çš„æ•°ç›®,ä¾‹å¦‚åœ¨apacheå’Œnginxè¿™ç§webæœåŠ¡å™¨ä¸­ï¼Œæˆ‘ä»¬ä¸€èˆ¬åšæ€§èƒ½æµ‹è¯•æ—¶ä¼šè¿›è¡Œå‡ åƒå¹¶å‘ç”šè‡³å‡ ä¸‡å¹¶å‘çš„æµ‹è¯•ï¼Œé€‰æ‹©webæœåŠ¡å™¨çš„è¿›ç¨‹å¯ä»¥ç”±è¿›ç¨‹æˆ–è€…çº¿ç¨‹çš„å³°å€¼ä¸€ç›´ä¸‹è°ƒï¼Œå‹æµ‹ï¼Œç›´åˆ°csåˆ°ä¸€ä¸ªæ¯”è¾ƒå°çš„å€¼ï¼Œè¿™ä¸ªè¿›ç¨‹å’Œçº¿ç¨‹æ•°å°±æ˜¯æ¯”è¾ƒåˆé€‚çš„å€¼äº†ã€‚ç³»ç»Ÿè°ƒç”¨ä¹Ÿæ˜¯ï¼Œæ¯æ¬¡è°ƒç”¨ç³»ç»Ÿå‡½æ•°ï¼Œæˆ‘ä»¬çš„ä»£ç å°±ä¼šè¿›å…¥å†…æ ¸ç©ºé—´ï¼Œå¯¼è‡´ä¸Šä¸‹æ–‡åˆ‡æ¢ï¼Œè¿™ä¸ªæ˜¯å¾ˆè€—èµ„æºï¼Œä¹Ÿè¦å°½é‡é¿å…é¢‘ç¹è°ƒç”¨ç³»ç»Ÿå‡½æ•°ã€‚ä¸Šä¸‹æ–‡åˆ‡æ¢æ¬¡æ•°è¿‡å¤šè¡¨ç¤ºä½ çš„CPUå¤§éƒ¨åˆ†æµªè´¹åœ¨ä¸Šä¸‹æ–‡åˆ‡æ¢ï¼Œå¯¼è‡´CPUå¹²æ­£ç»äº‹çš„æ—¶é—´å°‘äº†ï¼ŒCPUæ²¡æœ‰å……åˆ†åˆ©ç”¨ã€‚ us # ç”¨æˆ·è¿›ç¨‹æ‰§è¡Œæ¶ˆè€—cpuæ—¶é—´(user time) usçš„å€¼æ¯”è¾ƒé«˜æ—¶ï¼Œè¯´æ˜ç”¨æˆ·è¿›ç¨‹æ¶ˆè€—çš„cpuæ—¶é—´å¤šï¼Œä½†æ˜¯å¦‚æœé•¿æœŸè¶…è¿‡50%çš„ä½¿ç”¨ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±è¯¥è€ƒè™‘ä¼˜åŒ–ç¨‹åºç®—æ³•æˆ–å…¶ä»–æªæ–½ sy # ç³»ç»ŸCPUæ—¶é—´ï¼Œå¦‚æœå¤ªé«˜ï¼Œè¡¨ç¤ºç³»ç»Ÿè°ƒç”¨æ—¶é—´é•¿ï¼Œä¾‹å¦‚æ˜¯IOæ“ä½œé¢‘ç¹ã€‚ id # ç©ºé—² CPUæ—¶é—´ï¼Œä¸€èˆ¬æ¥è¯´ï¼Œid + us + sy = 100,ä¸€èˆ¬è®¤ä¸ºidæ˜¯ç©ºé—²CPUä½¿ç”¨ç‡ï¼Œusæ˜¯ç”¨æˆ·CPUä½¿ç”¨ç‡ï¼Œsyæ˜¯ç³»ç»ŸCPUä½¿ç”¨ç‡ã€‚ wt # ç­‰å¾…IOCPUæ—¶é—´ã€‚Waè¿‡é«˜æ—¶ï¼Œè¯´æ˜ioç­‰å¾…æ¯”è¾ƒä¸¥é‡ï¼Œè¿™å¯èƒ½æ˜¯ç”±äºç£ç›˜å¤§é‡éšæœºè®¿é—®é€ æˆçš„ï¼Œä¹Ÿæœ‰å¯èƒ½æ˜¯ç£ç›˜çš„å¸¦å®½å‡ºç°ç“¶é¢ˆã€‚ å¦‚æœ r ç»å¸¸å¤§äº4ï¼Œä¸”idç»å¸¸å°‘äº40ï¼Œè¡¨ç¤ºcpuçš„è´Ÿè·å¾ˆé‡ã€‚ å¦‚æœ pi po é•¿æœŸä¸ç­‰äº0ï¼Œè¡¨ç¤ºå†…å­˜ä¸è¶³ã€‚ å¦‚æœ b é˜Ÿåˆ—ç»å¸¸å¤§äº3ï¼Œè¡¨ç¤ºioæ€§èƒ½ä¸å¥½ã€‚ æ—¥å¿—ç®¡ç† 1 2 3 4 5 6 7 8 9 10 history # å†æ—¶å‘½ä»¤é»˜è®¤1000æ¡ HISTTIMEFORMAT=\u0026#34;%Y-%m-%d %H:%M:%S \u0026#34; # è®©historyå‘½ä»¤æ˜¾ç¤ºå…·ä½“æ—¶é—´ history -c # æ¸…é™¤è®°å½•å‘½ä»¤ cat $HOME/.bash_history # å†å²å‘½ä»¤è®°å½•æ–‡ä»¶ lastb -a # åˆ—å‡ºç™»å½•ç³»ç»Ÿå¤±è´¥çš„ç”¨æˆ·ç›¸å…³ä¿¡æ¯ æ¸…ç©ºäºŒè¿›åˆ¶æ—¥å¿—è®°å½•æ–‡ä»¶ echo \u0026gt; /var/log/btmp last # æŸ¥çœ‹ç™»é™†è¿‡çš„ç”¨æˆ·ä¿¡æ¯ æ¸…ç©ºäºŒè¿›åˆ¶æ—¥å¿—è®°å½•æ–‡ä»¶ echo \u0026gt; /var/log/wtmp é»˜è®¤æ‰“å¼€ä¹±ç  who /var/log/wtmp # æŸ¥çœ‹ç™»é™†è¿‡çš„ç”¨æˆ·ä¿¡æ¯ lastlog # ç”¨æˆ·æœ€åç™»å½•çš„æ—¶é—´ tail -f /var/log/messages # ç³»ç»Ÿæ—¥å¿— tail -f /var/log/secure # sshæ—¥å¿— man 1 2 3 4 5 6 7 8 9 10 man 2 read # æŸ¥çœ‹readå‡½æ•°çš„æ–‡æ¡£ 1 ä½¿ç”¨è€…åœ¨shellä¸­å¯ä»¥æ“ä½œçš„æŒ‡ä»¤æˆ–å¯æ‰§è¡Œæ¡£ 2 ç³»ç»Ÿæ ¸å¿ƒå¯å‘¼å«çš„å‡½æ•°ä¸å·¥å…·ç­‰ 3 ä¸€äº›å¸¸ç”¨çš„å‡½æ•°(function)ä¸å‡½æ•°åº“(library),å¤§éƒ¨åˆ†æ˜¯Cçš„å‡½æ•°åº“(libc) 4 è£…ç½®æ¡£æ¡ˆçš„è¯´æ˜ï¼Œé€šå¸¸åœ¨/devä¸‹çš„æ¡£æ¡ˆ 5 è®¾å®šæ¡£æˆ–è€…æ˜¯æŸäº›æ¡£æ¡ˆçš„æ ¼å¼ 6 æ¸¸æˆgames 7 æƒ¯ä¾‹ä¸åå®šç­‰ï¼Œä¾‹å¦‚linuxæ¡£æ¡ˆç³»ç»Ÿã€ç½‘ç»œåå®šã€ascll codeç­‰è¯´æ˜ 8 ç³»ç»Ÿç®¡ç†å‘˜å¯ç”¨çš„ç®¡ç†æŒ‡ä»¤ 9 è·Ÿkernelæœ‰å…³çš„æ–‡ä»¶ selinux 1 2 3 4 5 6 7 sestatus -v # æŸ¥çœ‹selinuxçŠ¶æ€ getenforce # æŸ¥çœ‹selinuxæ¨¡å¼ setenforce 0 # è®¾ç½®selinuxä¸ºå®½å®¹æ¨¡å¼(å¯é¿å…é˜»æ­¢ä¸€äº›æ“ä½œ) semanage port -l # æŸ¥çœ‹selinuxç«¯å£é™åˆ¶è§„åˆ™ semanage port -a -t http_port_t -p tcp 8000 # åœ¨selinuxä¸­æ³¨å†Œç«¯å£ç±»å‹ vi /etc/selinux/config # selinuxé…ç½®æ–‡ä»¶ SELINUX=enfoceing # å…³é—­selinux æŠŠå…¶ä¿®æ”¹ä¸º SELINUX=disabled æŸ¥çœ‹å‰©ä½™å†…å­˜ 1 2 3 4 free -m #-/+ buffers/cache: 6458 1649 #6458Mä¸ºçœŸå®ä½¿ç”¨å†…å­˜ 1649Mä¸ºçœŸå®å‰©ä½™å†…å­˜(å‰©ä½™å†…å­˜+ç¼“å­˜+ç¼“å†²å™¨) #linuxä¼šåˆ©ç”¨æ‰€æœ‰çš„å‰©ä½™å†…å­˜ä½œä¸ºç¼“å­˜ï¼Œæ‰€ä»¥è¦ä¿è¯linuxè¿è¡Œé€Ÿåº¦ï¼Œå°±éœ€è¦ä¿è¯å†…å­˜çš„ç¼“å­˜å¤§å° ç³»ç»Ÿä¿¡æ¯ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 uname -a # æŸ¥çœ‹Linuxå†…æ ¸ç‰ˆæœ¬ä¿¡æ¯ cat /proc/version # æŸ¥çœ‹å†…æ ¸ç‰ˆæœ¬ cat /etc/issue # æŸ¥çœ‹ç³»ç»Ÿç‰ˆæœ¬ lsb_release -a # æŸ¥çœ‹ç³»ç»Ÿç‰ˆæœ¬ éœ€å®‰è£… centos-release locale -a # åˆ—å‡ºæ‰€æœ‰è¯­ç³» locale # å½“å‰ç¯å¢ƒå˜é‡ä¸­æ‰€æœ‰ç¼–ç  hwclock # æŸ¥çœ‹æ—¶é—´ who # å½“å‰åœ¨çº¿ç”¨æˆ· w # å½“å‰åœ¨çº¿ç”¨æˆ· whoami # æŸ¥çœ‹å½“å‰ç”¨æˆ·å logname # æŸ¥çœ‹åˆå§‹ç™»é™†ç”¨æˆ·å uptime # æŸ¥çœ‹æœåŠ¡å™¨å¯åŠ¨æ—¶é—´ sar -n DEV 1 10 # æŸ¥çœ‹ç½‘å¡ç½‘é€Ÿæµé‡ dmesg # æ˜¾ç¤ºå¼€æœºä¿¡æ¯ lsmod # æŸ¥çœ‹å†…æ ¸æ¨¡å— ç¡¬ä»¶ä¿¡æ¯ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 more /proc/cpuinfo # æŸ¥çœ‹cpuä¿¡æ¯ lscpu # æŸ¥çœ‹cpuä¿¡æ¯ cat /proc/cpuinfo | grep name | cut -f2 -d: | uniq -c # æŸ¥çœ‹cpuå‹å·å’Œé€»è¾‘æ ¸å¿ƒæ•° getconf LONG_BIT # cpuè¿è¡Œçš„ä½æ•° cat /proc/cpuinfo | grep \u0026#39;physical id\u0026#39; |sort| uniq -c # ç‰©ç†cpuä¸ªæ•° cat /proc/cpuinfo | grep flags | grep \u0026#39; lm \u0026#39; | wc -l # ç»“æœå¤§äº0æ”¯æŒ64ä½ cat /proc/cpuinfo|grep flags # æŸ¥çœ‹cpuæ˜¯å¦æ”¯æŒè™šæ‹ŸåŒ– paeæ”¯æŒåŠè™šæ‹ŸåŒ– IntelVT æ”¯æŒå…¨è™šæ‹ŸåŒ– more /proc/meminfo # æŸ¥çœ‹å†…å­˜ä¿¡æ¯ dmidecode # æŸ¥çœ‹å…¨é¢ç¡¬ä»¶ä¿¡æ¯ dmidecode | grep \u0026#34;Product Name\u0026#34; # æŸ¥çœ‹æœåŠ¡å™¨å‹å· dmidecode | grep -P -A5 \u0026#34;Memory\\s+Device\u0026#34; | grep Size | grep -v Range # æŸ¥çœ‹å†…å­˜æ’æ§½ cat /proc/mdstat # æŸ¥çœ‹è½¯raidä¿¡æ¯ cat /proc/scsi/scsi # æŸ¥çœ‹Dellç¡¬raidä¿¡æ¯(IBMã€HPéœ€è¦å®˜æ–¹æ£€æµ‹å·¥å…·) lspci # æŸ¥çœ‹ç¡¬ä»¶ä¿¡æ¯ lspci|grep RAID # æŸ¥çœ‹æ˜¯å¦æ”¯æŒraid lspci -vvv |grep Ethernet # æŸ¥çœ‹ç½‘å¡å‹å· lspci -vvv |grep Kernel|grep driver # æŸ¥çœ‹é©±åŠ¨æ¨¡å— modinfo tg2 # æŸ¥çœ‹é©±åŠ¨ç‰ˆæœ¬(é©±åŠ¨æ¨¡å—) ethtool -i em1 # æŸ¥çœ‹ç½‘å¡é©±åŠ¨ç‰ˆæœ¬ ethtool em1 # æŸ¥çœ‹ç½‘å¡å¸¦å®½ å¼€æœºå¯åŠ¨æ¨¡å¼ 1 2 3 vi /etc/inittab id:3:initdefault: # 3ä¸ºå¤šç”¨æˆ·å‘½ä»¤ #ca::ctrlaltdel:/sbin/shutdown -t3 -r now # æ³¨é‡Šæ­¤è¡Œ ç¦æ­¢ ctrl+alt+del å…³é—­è®¡ç®—æœº å®šæ—¶ä»»åŠ¡ 1 2 3 4 5 6 7 8 9 10 11 at 5pm + 3 days /bin/ls # å•æ¬¡å®šæ—¶ä»»åŠ¡ æŒ‡å®šä¸‰å¤©åä¸‹åˆ5:00æ‰§è¡Œ/bin/ls crontab -e # ç¼–è¾‘å‘¨æœŸä»»åŠ¡ #åˆ†é’Ÿ å°æ—¶ å¤© æœˆ æ˜ŸæœŸ å‘½ä»¤æˆ–è„šæœ¬ 1,30 1-3/2 * * * å‘½ä»¤æˆ–è„šæœ¬ \u0026gt;\u0026gt; file.log 2\u0026gt;\u0026amp;1 echo \u0026#34;40 7 * * 2 /root/sh\u0026#34;\u0026gt;\u0026gt;/var/spool/cron/work # æ™®é€šç”¨æˆ·å¯ç›´æ¥å†™å…¥å®šæ—¶ä»»åŠ¡ crontab -l # æŸ¥çœ‹è‡ªåŠ¨å‘¨æœŸæ€§ä»»åŠ¡ crontab -r # åˆ é™¤è‡ªåŠ¨å‘¨æœŸæ€§ä»»åŠ¡ cron.denyå’Œcron.allow # ç¦æ­¢æˆ–å…è®¸ç”¨æˆ·ä½¿ç”¨å‘¨æœŸä»»åŠ¡ service crond start|stop|restart # å¯åŠ¨è‡ªåŠ¨å‘¨æœŸæ€§æœåŠ¡ * * * * * echo \u0026#34;d\u0026#34; \u0026gt;\u0026gt;d$(date +\\%Y\\%m\\%d).log # è®©å®šæ—¶ä»»åŠ¡ç›´æ¥ç”Ÿæˆå¸¦æ—¥æœŸçš„log éœ€è¦è½¬ä¹‰% date 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 æ˜ŸæœŸæ—¥[SUN] æ˜ŸæœŸä¸€[MON] æ˜ŸæœŸäºŒ[TUE] æ˜ŸæœŸä¸‰[WED] æ˜ŸæœŸå››[THU] æ˜ŸæœŸäº”[FRI] æ˜ŸæœŸå…­[SAT] ä¸€æœˆ[JAN] äºŒæœˆ[FEB] ä¸‰æœˆ[MAR] å››æœˆ[APR] äº”æœˆ[MAY] å…­æœˆ[JUN] ä¸ƒæœˆ[JUL] å…«æœˆ[AUG] ä¹æœˆ[SEP] åæœˆ[OCT] åä¸€æœˆ[NOV] åäºŒæœˆ[DEC] date -s 20091112 # è®¾æ—¥æœŸ date -s 18:30:50 # è®¾æ—¶é—´ date -d \u0026#34;7 days ago\u0026#34; +%Y%m%d # 7å¤©å‰æ—¥æœŸ date -d \u0026#34;5 minute ago\u0026#34; +%H:%M # 5åˆ†é’Ÿå‰æ—¶é—´ date -d \u0026#34;1 month ago\u0026#34; +%Y%m%d # ä¸€ä¸ªæœˆå‰ date -d \u0026#39;1 days\u0026#39; +%Y-%m-%d # ä¸€å¤©å date -d \u0026#39;1 hours\u0026#39; +%H:%M:%S # ä¸€å°æ—¶å date +%Y-%m-%d -d \u0026#39;20110902\u0026#39; # æ—¥æœŸæ ¼å¼è½¬æ¢ date +%Y-%m-%d_%X # æ—¥æœŸå’Œæ—¶é—´ date +%N # çº³ç§’ date -d \u0026#34;2012-08-13 14:00:23\u0026#34; +%s # æ¢ç®—æˆç§’è®¡ç®—(1970å¹´è‡³ä»Šçš„ç§’æ•°) date -d \u0026#34;@1363867952\u0026#34; +%Y-%m-%d-%T # å°†æ—¶é—´æˆ³æ¢ç®—æˆæ—¥æœŸ date -d \u0026#34;1970-01-01 UTC 1363867952 seconds\u0026#34; +%Y-%m-%d-%T # å°†æ—¶é—´æˆ³æ¢ç®—æˆæ—¥æœŸ date -d \u0026#34;`awk -F. \u0026#39;{print $1}\u0026#39; /proc/uptime` second ago\u0026#34; +\u0026#34;%Y-%m-%d %H:%M:%S\u0026#34; # æ ¼å¼åŒ–ç³»ç»Ÿå¯åŠ¨æ—¶é—´(å¤šå°‘ç§’å‰) limits.conf 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 ulimit -SHn 65535 # ä¸´æ—¶è®¾ç½®æ–‡ä»¶æè¿°ç¬¦å¤§å° è¿›ç¨‹æœ€å¤§æ‰“å¼€æ–‡ä»¶æŸ„æ•° è¿˜æœ‰socketæœ€å¤§è¿æ¥æ•°, ç­‰åŒé…ç½® nofile ulimit -SHu 65535 # ä¸´æ—¶è®¾ç½®ç”¨æˆ·æœ€å¤§è¿›ç¨‹æ•° ulimit -a # æŸ¥çœ‹ /etc/security/limits.conf # æ–‡ä»¶æè¿°ç¬¦å¤§å° open files # lsof |wc -l æŸ¥çœ‹å½“å‰æ–‡ä»¶å¥æŸ„æ•°ä½¿ç”¨æ•°é‡ * soft nofile 16384 # è®¾ç½®å¤ªå¤§ï¼Œè¿›ç¨‹ä½¿ç”¨è¿‡å¤šä¼šæŠŠæœºå™¨æ‹–æ­» * hard nofile 32768 # ç”¨æˆ·æœ€å¤§è¿›ç¨‹æ•° max user processes # echo $((`ps uxm |wc -l`-`ps ux |wc -l`)) æŸ¥çœ‹å½“å‰ç”¨æˆ·å ç”¨çš„è¿›ç¨‹æ•° [åŒ…æ‹¬çº¿ç¨‹] user soft nproc 16384 user hard nproc 32768 # å¦‚æœ/etc/security/limits.d/æœ‰é…ç½®æ–‡ä»¶ï¼Œå°†ä¼šè¦†ç›–/etc/security/limits.confé‡Œçš„é…ç½® # å³/etc/security/limits.d/çš„é…ç½®æ–‡ä»¶é‡Œå°±ä¸è¦æœ‰åŒæ ·çš„å‚é‡è®¾ç½® /etc/security/limits.d/90-nproc.conf # centos6.3çš„é»˜è®¤è¿™ä¸ªæ–‡ä»¶ä¼šè¦†ç›– limits.conf user soft nproc 16384 user hard nproc 32768 sysctl -p # ä¿®æ”¹é…ç½®æ–‡ä»¶åè®©ç³»ç»Ÿç”Ÿæ•ˆ ç™¾ä¸‡é•¿é“¾æ¥è®¾ç½® 1 2 3 4 5 6 7 # å†…å­˜æ¶ˆè€—éœ€è¦è¾ƒå¤§ vim /root/.bash_profile # æ·»åŠ å¦‚ä¸‹2è¡Œ,é€€å‡ºbashé‡æ–°ç™»é™† # ä¸€ä¸ªè¿›ç¨‹ä¸èƒ½ä½¿ç”¨è¶…è¿‡NR_OPENæ–‡ä»¶æè¿°ç¬¦ echo 20000500 \u0026gt; /proc/sys/fs/nr_open # å½“å‰ç”¨æˆ·æœ€å¤§æ–‡ä»¶æ•° ulimit -n 10000000 æ— æ³•åˆ†é…å†…å­˜ 1 2 3 4 fork: Cannot allocate memory # æŠ¥é”™ä¸ä¸€å®šæ˜¯å†…å­˜ä¸å¤Ÿç”¨ï¼Œè¿›ç¨‹æ•°æˆ–è€…çº¿ç¨‹æ•°æ»¡äº†ä¹Ÿä¼šæŠ¥è¿™ä¸ªé”™è¯¯ï¼Œ å¯ä»¥é€‚å½“å¢åŠ  kernel.pid_max çš„å€¼ï¼Œ cat /proc/sys/kernel/pid_max # é»˜è®¤3.2w iptables 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 å†…å»ºä¸‰ä¸ªè¡¨ï¼šnat mangle å’Œ filter filteré¢„è®¾è§„åˆ™è¡¨ï¼Œæœ‰INPUTã€FORWARD å’Œ OUTPUT ä¸‰ä¸ªè§„åˆ™é“¾ vi /etc/sysconfig/iptables # é…ç½®æ–‡ä»¶ INPUT # è¿›å…¥ FORWARD # è½¬å‘ OUTPUT # å‡ºå» ACCEPT # å°†å°åŒ…æ”¾è¡Œ REJECT # æ‹¦é˜»è¯¥å°åŒ… DROP # ä¸¢å¼ƒå°åŒ…ä¸äºˆå¤„ç† -A # åœ¨æ‰€é€‰æ‹©çš„é“¾(INPUTç­‰)æœ«æ·»åŠ ä¸€æ¡æˆ–æ›´å¤šè§„åˆ™ -D # åˆ é™¤ä¸€æ¡ -E # ä¿®æ”¹ -p # tcpã€udpã€icmp 0ç›¸å½“äºæ‰€æœ‰all !å–å -P # è®¾ç½®ç¼ºçœç­–ç•¥(ä¸æ‰€æœ‰é“¾éƒ½ä¸åŒ¹é…å¼ºåˆ¶ä½¿ç”¨æ­¤ç­–ç•¥) -s # IP/æ©ç  (IP/24) ä¸»æœºåã€ç½‘ç»œåå’Œæ¸…æ¥šçš„IPåœ°å€ !å–å -j # ç›®æ ‡è·³è½¬ï¼Œç«‹å³å†³å®šåŒ…çš„å‘½è¿çš„ä¸“ç”¨å†…å»ºç›®æ ‡ -i # è¿›å…¥çš„ï¼ˆç½‘ç»œï¼‰æ¥å£ [åç§°] eth0 -o # è¾“å‡ºæ¥å£[åç§°] -m # æ¨¡å— --sport # æºç«¯å£ --dport # ç›®æ ‡ç«¯å£ iptables -F # å°†é˜²ç«å¢™ä¸­çš„è§„åˆ™æ¡ç›®æ¸…é™¤æ‰ # æ³¨æ„: iptables -P INPUT ACCEPT iptables-restore \u0026lt; è§„åˆ™æ–‡ä»¶ # å¯¼å…¥é˜²ç«å¢™è§„åˆ™ /etc/init.d/iptables save # ä¿å­˜é˜²ç«å¢™è®¾ç½® /etc/init.d/iptables restart # é‡å¯é˜²ç«å¢™æœåŠ¡ iptables -L -n # æŸ¥çœ‹è§„åˆ™ iptables -t nat -nL # æŸ¥çœ‹è½¬å‘ iptableså®ä¾‹ iptables -L INPUT # åˆ—å‡ºæŸè§„åˆ™é“¾ä¸­çš„æ‰€æœ‰è§„åˆ™ iptables -X allowed # åˆ é™¤æŸä¸ªè§„åˆ™é“¾ ,ä¸åŠ è§„åˆ™é“¾ï¼Œæ¸…é™¤æ‰€æœ‰éå†…å»ºçš„ iptables -Z INPUT # å°†å°åŒ…è®¡æ•°å™¨å½’é›¶ iptables -N allowed # å®šä¹‰æ–°çš„è§„åˆ™é“¾ iptables -P INPUT DROP # å®šä¹‰è¿‡æ»¤æ”¿ç­– iptables -A INPUT -s 192.168.1.1 # æ¯”å¯¹å°åŒ…çš„æ¥æºIP # ! 192.168.0.0/24 ! åå‘å¯¹æ¯” iptables -A INPUT -d 192.168.1.1 # æ¯”å¯¹å°åŒ…çš„ç›®çš„åœ°IP iptables -A INPUT -i eth0 # æ¯”å¯¹å°åŒ…æ˜¯ä»å“ªç‰‡ç½‘å¡è¿›å…¥ iptables -A FORWARD -o eth0 # æ¯”å¯¹å°åŒ…è¦ä»å“ªç‰‡ç½‘å¡é€å‡º eth+è¡¨ç¤ºæ‰€æœ‰çš„ç½‘å¡ iptables -A INPUT -p tcp # -p ! tcp æ’é™¤tcpä»¥å¤–çš„udpã€icmpã€‚-p allæ‰€æœ‰ç±»å‹ iptables -D INPUT 8 # ä»æŸä¸ªè§„åˆ™é“¾ä¸­åˆ é™¤ä¸€æ¡è§„åˆ™ iptables -D INPUT --dport 80 -j DROP # ä»æŸä¸ªè§„åˆ™é“¾ä¸­åˆ é™¤ä¸€æ¡è§„åˆ™ iptables -R INPUT 8 -s 192.168.0.1 -j DROP # å–ä»£ç°è¡Œè§„åˆ™ iptables -I INPUT 8 --dport 80 -j ACCEPT # æ’å…¥ä¸€æ¡è§„åˆ™ iptables -A INPUT -i eth0 -j DROP # å…¶å®ƒæƒ…å†µä¸å…è®¸ iptables -A INPUT -p tcp -s IP -j DROP # ç¦æ­¢æŒ‡å®šIPè®¿é—® iptables -A INPUT -p tcp -s IP --dport port -j DROP # ç¦æ­¢æŒ‡å®šIPè®¿é—®ç«¯å£ iptables -A INPUT -s IP -p tcp --dport port -j ACCEPT # å…è®¸åœ¨IPè®¿é—®æŒ‡å®šç«¯å£ iptables -A INPUT -p tcp --dport 22 -j DROP # ç¦æ­¢ä½¿ç”¨æŸç«¯å£ iptables -A INPUT -i eth0 -p icmp -m icmp --icmp-type 8 -j DROP # ç¦æ­¢icmpç«¯å£ iptables -A INPUT -i eth0 -p icmp -j DROP # ç¦æ­¢icmpç«¯å£ iptables -t filter -A INPUT -i eth0 -p tcp --syn -j DROP # é˜»æ­¢æ‰€æœ‰æ²¡æœ‰ç»è¿‡ä½ ç³»ç»Ÿæˆæƒçš„TCPè¿æ¥ iptables -A INPUT -f -m limit --limit 100/s --limit-burst 100 -j ACCEPT # IPåŒ…æµé‡é™åˆ¶ iptables -A INPUT -i eth0 -s 192.168.62.1/32 -p icmp -m icmp --icmp-type 8 -j ACCEPT # é™¤192.168.62.1å¤–ï¼Œç¦æ­¢å…¶å®ƒäººpingæˆ‘çš„ä¸»æœº iptables -A INPUT -p tcp -m tcp --dport 80 -m state --state NEW -m recent --update --seconds 5 --hitcount 20 --rttl --name WEB --rsource -j DROP # å¯é˜²å¾¡ccæ”»å‡»(æœªæµ‹è¯•) iptablesé…ç½®å®ä¾‹æ–‡ä»¶ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 # Generated by iptables-save v1.2.11 on Fri Feb 9 12:10:37 2007 *filter :INPUT ACCEPT [637:58967] :FORWARD DROP [0:0] :OUTPUT ACCEPT [5091:1301533] # å…è®¸çš„IPæˆ–IPæ®µè®¿é—® å»ºè®®å¤šä¸ª -A INPUT -s 127.0.0.1 -p tcp -j ACCEPT -A INPUT -s 192.168.0.0/255.255.0.0 -p tcp -j ACCEPT # å¼€æ”¾å¯¹å¤–å¼€æ”¾ç«¯å£ -A INPUT -p tcp --dport 80 -j ACCEPT # æŒ‡å®šæŸç«¯å£é’ˆå¯¹IPå¼€æ”¾ -A INPUT -s 192.168.10.37 -p tcp --dport 22 -j ACCEPT # æ‹’ç»æ‰€æœ‰åè®®(INPUTå…è®¸) -A INPUT -p tcp -m tcp --tcp-flags FIN,SYN,RST,PSH,URG RST -j DROP # å…è®¸å·²å»ºç«‹çš„æˆ–ç›¸å…³è¿çš„é€šè¡Œ -A INPUT -m state --state ESTABLISHED,RELATED -j ACCEPT # æ‹’ç»ping -A INPUT -p tcp -m tcp -j REJECT --reject-with icmp-port-unreachable COMMIT # Completed on Fri Feb 9 12:10:37 2007 iptablesé…ç½®å®ä¾‹ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 # å…è®¸æŸæ®µIPè®¿é—®ä»»ä½•ç«¯å£ iptables -A INPUT -s 192.168.0.3/24 -p tcp -j ACCEPT # è®¾å®šé¢„è®¾è§„åˆ™ (æ‹’ç»æ‰€æœ‰çš„æ•°æ®åŒ…ï¼Œå†å…è®¸éœ€è¦çš„,å¦‚åªåšWEBæœåŠ¡å™¨.è¿˜æ˜¯æ¨èä¸‰ä¸ªé“¾éƒ½æ˜¯DROP) iptables -P INPUT DROP iptables -P FORWARD DROP iptables -P OUTPUT ACCEPT # æ³¨æ„: ç›´æ¥è®¾ç½®è¿™ä¸‰æ¡ä¼šæ‰çº¿ # å¼€å¯22ç«¯å£ iptables -A INPUT -p tcp --dport 22 -j ACCEPT # å¦‚æœOUTPUT è®¾ç½®æˆDROPçš„ï¼Œè¦å†™ä¸Šä¸‹é¢ä¸€æ¡ iptables -A OUTPUT -p tcp --sport 22 -j ACCEPT # æ³¨:ä¸å†™å¯¼è‡´æ— æ³•SSH.å…¶ä»–çš„ç«¯å£ä¸€æ ·,OUTPUTè®¾ç½®æˆDROPçš„è¯,ä¹Ÿè¦æ·»åŠ ä¸€æ¡é“¾ # å¦‚æœå¼€å¯äº†webæœåŠ¡å™¨,OUTPUTè®¾ç½®æˆDROPçš„è¯,åŒæ ·ä¹Ÿè¦æ·»åŠ ä¸€æ¡é“¾ iptables -A OUTPUT -p tcp --sport 80 -j ACCEPT # åšWEBæœåŠ¡å™¨,å¼€å¯80ç«¯å£ ,å…¶ä»–åŒç† iptables -A INPUT -p tcp --dport 80 -j ACCEPT # åšé‚®ä»¶æœåŠ¡å™¨,å¼€å¯25,110ç«¯å£ iptables -A INPUT -p tcp --dport 110 -j ACCEPT iptables -A INPUT -p tcp --dport 25 -j ACCEPT # å…è®¸icmpåŒ…é€šè¿‡,å…è®¸ping iptables -A OUTPUT -p icmp -j ACCEPT (OUTPUTè®¾ç½®æˆDROPçš„è¯) iptables -A INPUT -p icmp -j ACCEPT (INPUTè®¾ç½®æˆDROPçš„è¯) # å…è®¸loopback!(ä¸ç„¶ä¼šå¯¼è‡´DNSæ— æ³•æ­£å¸¸å…³é—­ç­‰é—®é¢˜) IPTABLES -A INPUT -i lo -p all -j ACCEPT (å¦‚æœæ˜¯INPUT DROP) IPTABLES -A OUTPUT -o lo -p all -j ACCEPT(å¦‚æœæ˜¯OUTPUT DROP) æ·»åŠ ç½‘æ®µè½¬å‘ 1 2 3 4 5 # ä¾‹å¦‚é€šè¿‡vpnä¸Šç½‘ echo 1 \u0026gt; /proc/sys/net/ipv4/ip_forward # åœ¨å†…æ ¸é‡Œæ‰“å¼€ipè½¬å‘åŠŸèƒ½ iptables -t nat -A POSTROUTING -s 10.8.0.0/24 -j MASQUERADE # æ·»åŠ ç½‘æ®µè½¬å‘ iptables -t nat -A POSTROUTING -s 10.0.0.0/255.0.0.0 -o eth0 -j SNAT --to 192.168.10.158 # åŸIPç½‘æ®µç»è¿‡å“ªä¸ªç½‘å¡IPå‡ºå» iptables -t nat -nL # æŸ¥çœ‹è½¬å‘ ç«¯å£æ˜ å°„ 1 2 3 4 5 6 7 8 # å†…ç½‘é€šè¿‡æœ‰å¤–ç½‘IPçš„æœºå™¨æ˜ å°„ç«¯å£ # å†…ç½‘ä¸»æœºæ·»åŠ è·¯ç”± route add -net 10.10.20.0 netmask 255.255.255.0 gw 10.10.20.111 # å†…ç½‘éœ€è¦æ·»åŠ é»˜è®¤ç½‘å…³ï¼Œå¹¶ä¸”ç½‘å…³å¼€å¯è½¬å‘ # ç½‘å…³ä¸»æœº echo 1 \u0026gt; /proc/sys/net/ipv4/ip_forward # åœ¨å†…æ ¸é‡Œæ‰“å¼€ipè½¬å‘åŠŸèƒ½ iptables -t nat -A PREROUTING -d å¤–ç½‘IP -p tcp --dport 9999 -j DNAT --to 10.10.20.55:22 # è¿›å…¥ iptables -t nat -A POSTROUTING -s 10.10.20.0/24 -j SNAT --to å¤–ç½‘IP # è½¬å‘å›å» iptables -t nat -nL # æŸ¥çœ‹è½¬å‘ ä½œè€…ï¼šSREè¿ç»´åšå®¢\nåšå®¢åœ°å€ï¼šhttps://www.cnsre.cn\næ–‡ç« åœ°å€ï¼šhttps://www.cnsre.cn/posts/210531132227/\nç›¸å…³è¯é¢˜ï¼šhttps://www.cnsre.cn/tags/shell/\n","description":"ä½¿ç”¨Linux shellæ˜¯ä¸€äº›ç¨‹åºå‘˜æ¯å¤©çš„åŸºæœ¬å·¥ä½œï¼Œä½†ç»å¸¸ä¼šå¿˜è®°ä¸€äº›æœ‰ç”¨çš„shellå‘½ä»¤å’ŒæŠ€å·§ã€‚å½“ç„¶ï¼Œå‘½ä»¤æˆ‘èƒ½è®°ä½ï¼Œä½†æˆ‘ä¸æ•¢è¯´èƒ½è®°å¾—å¦‚ä½•ç”¨å®ƒæ‰§è¡ŒæŸä¸ªç‰¹å®šä»»åŠ¡ã€‚éœ€è¦æ³¨æ„ä¸€ç‚¹çš„æ˜¯ï¼Œæœ‰äº›ç”¨æ³•éœ€è¦åœ¨ä½ çš„Linuxç³»ç»Ÿé‡Œå®‰è£…é¢å¤–çš„è½¯ä»¶ã€‚","id":59,"section":"posts","tags":["shell"],"title":"shellå¸¸ç”¨å‘½ä»¤","uri":"http://www.cnsre.cn:80/posts/210531132227/"},{"content":" ä½œè€…ï¼šSREè¿ç»´åšå®¢\nåšå®¢åœ°å€ï¼šhttps://www.cnsre.cn\næ–‡ç« åœ°å€ï¼šhttps://www.cnsre.cn/posts/210531100355/\nç›¸å…³è¯é¢˜ï¼šhttps://www.cnsre.cn/tags/aws/\nä½¿ç”¨ CloudWatch ä»£ç†æ”¶é›†æŒ‡æ ‡å’Œæ—¥å¿—\nä¸‹è½½ CloudWatch ä»£ç†è½¯ä»¶åŒ… sudo yum install amazon-cloudwatch-agent ç‚¹å‡»æŸ¥çœ‹å…¶ä»–å¹³å°è½¯ä»¶åŒ…\né…ç½®æ–‡ä»¶\n1 2 3 4 5 6 é…ç½®æ–‡ä»¶è·¯å¾„åŠåç§° /opt/aws/amazon-cloudwatch-agent/etc/amazon-cloudwatch-agent.json #é…ç½®å¯åŠ¨ sudo /opt/aws/amazon-cloudwatch-agent/bin/amazon-cloudwatch-agent-ctl -a fetch-config -m ec2 -s -c file:/opt/aws/amazon-cloudwatch-agent/etc/amazon-cloudwatch-agent.json #å¯åŠ¨æœåŠ¡ systemctl restart amazon-cloudwatch-agent.service ç‚¹å‡»æŸ¥çœ‹å†…å®¹ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 { \u0026#34;agent\u0026#34;: { \u0026#34;metrics_collection_interval\u0026#34;: 60, \u0026#34;run_as_user\u0026#34;: \u0026#34;cwagent\u0026#34; }, \u0026#34;metrics\u0026#34;: { \u0026#34;aggregation_dimensions\u0026#34;: [ [ \u0026#34;InstanceId\u0026#34; ] ], \u0026#34;append_dimensions\u0026#34;: { \u0026#34;AutoScalingGroupName\u0026#34;: \u0026#34;${aws:AutoScalingGroupName}\u0026#34;, \u0026#34;ImageId\u0026#34;: \u0026#34;${aws:ImageId}\u0026#34;, \u0026#34;InstanceId\u0026#34;: \u0026#34;${aws:InstanceId}\u0026#34;, \u0026#34;InstanceType\u0026#34;: \u0026#34;${aws:InstanceType}\u0026#34; }, \u0026#34;metrics_collected\u0026#34;: { \u0026#34;procstat\u0026#34;: [ { \u0026#34;pid_file\u0026#34;: \u0026#34;/var/run/sshd.pid\u0026#34;, \u0026#34;measurement\u0026#34;: [ \u0026#34;cpu_usage\u0026#34;, \u0026#34;memory_rss\u0026#34; ] }, { \u0026#34;pid_file\u0026#34;: \u0026#34;/var/run/sshd.pid\u0026#34;, \u0026#34;measurement\u0026#34;: [ \u0026#34;read_bytes\u0026#34;, \u0026#34;read_count\u0026#34;, \u0026#34;write_bytes\u0026#34; ], \u0026#34;metrics_collection_interval\u0026#34;: 10 }, \u0026#34;cpu\u0026#34;: { \u0026#34;measurement\u0026#34;: [ \u0026#34;cpu_usage_idle\u0026#34;, \u0026#34;cpu_usage_iowait\u0026#34;, \u0026#34;cpu_usage_user\u0026#34;, \u0026#34;cpu_usage_system\u0026#34; ], \u0026#34;metrics_collection_interval\u0026#34;: 60, \u0026#34;resources\u0026#34;: [ \u0026#34;*\u0026#34; ], \u0026#34;totalcpu\u0026#34;: false }, \u0026#34;disk\u0026#34;: { \u0026#34;measurement\u0026#34;: [ \u0026#34;used_percent\u0026#34;, \u0026#34;inodes_free\u0026#34; ], \u0026#34;metrics_collection_interval\u0026#34;: 60, \u0026#34;resources\u0026#34;: [ \u0026#34;*\u0026#34; ] }, \u0026#34;diskio\u0026#34;: { \u0026#34;measurement\u0026#34;: [ \u0026#34;io_time\u0026#34; ], \u0026#34;metrics_collection_interval\u0026#34;: 60, \u0026#34;resources\u0026#34;: [ \u0026#34;*\u0026#34; ] }, \u0026#34;mem\u0026#34;: { \u0026#34;measurement\u0026#34;: [ \u0026#34;mem_used_percent\u0026#34; ], \u0026#34;metrics_collection_interval\u0026#34;: 60 }, \u0026#34;swap\u0026#34;: { \u0026#34;measurement\u0026#34;: [ \u0026#34;swap_used_percent\u0026#34; ], \u0026#34;metrics_collection_interval\u0026#34;: 60 } } } } 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 { \u0026#34;logs\u0026#34;: { \u0026#34;logs_collected\u0026#34;: { \u0026#34;files\u0026#34;: { \u0026#34;collect_list\u0026#34;: [{ \u0026#34;file_path\u0026#34;: \u0026#34;/logArchive/hcaextension/info*.log\u0026#34;, \u0026#34;log_group_name\u0026#34;: \u0026#34;RGC-Prod-3in1oven\u0026#34;, \u0026#34;log_stream_name\u0026#34;: \u0026#34;info.logs\u0026#34; }, { \u0026#34;file_path\u0026#34;: \u0026#34;/logArchive/hcaextension/http*.log\u0026#34;, \u0026#34;log_group_name\u0026#34;: \u0026#34;RGC-Prod-3in1oven\u0026#34;, \u0026#34;log_stream_name\u0026#34;: \u0026#34;http.logs\u0026#34; } ] } } }, \u0026#34;metrics\u0026#34;: { \u0026#34;append_dimensions\u0026#34;: { \u0026#34;AutoScalingGroupName\u0026#34;: \u0026#34;${aws:AutoScalingGroupName}\u0026#34;, \u0026#34;ImageId\u0026#34;: \u0026#34;${aws:ImageId}\u0026#34;, \u0026#34;InstanceId\u0026#34;: \u0026#34;${aws:InstanceId}\u0026#34;, \u0026#34;InstanceType\u0026#34;: \u0026#34;${aws:InstanceType}\u0026#34; }, \u0026#34;metrics_collected\u0026#34;: { \u0026#34;cpu\u0026#34;: { \u0026#34;measurement\u0026#34;: [ \u0026#34;cpu_usage_idle\u0026#34;, \u0026#34;cpu_usage_iowait\u0026#34;, \u0026#34;cpu_usage_user\u0026#34;, \u0026#34;cpu_usage_system\u0026#34; ], \u0026#34;metrics_collection_interval\u0026#34;: 180, \u0026#34;totalcpu\u0026#34;: false }, \u0026#34;disk\u0026#34;: { \u0026#34;measurement\u0026#34;: [ \u0026#34;used_percent\u0026#34;, \u0026#34;inodes_free\u0026#34; ], \u0026#34;metrics_collection_interval\u0026#34;: 180, \u0026#34;resources\u0026#34;: [ \u0026#34;*\u0026#34; ] }, \u0026#34;diskio\u0026#34;: { \u0026#34;measurement\u0026#34;: [ \u0026#34;io_time\u0026#34;, \u0026#34;write_bytes\u0026#34;, \u0026#34;read_bytes\u0026#34;, \u0026#34;writes\u0026#34;, \u0026#34;reads\u0026#34; ], \u0026#34;metrics_collection_interval\u0026#34;: 180, \u0026#34;resources\u0026#34;: [ \u0026#34;*\u0026#34; ] }, \u0026#34;mem\u0026#34;: { \u0026#34;measurement\u0026#34;: [ \u0026#34;mem_used_percent\u0026#34; ], \u0026#34;metrics_collection_interval\u0026#34;: 180 }, \u0026#34;netstat\u0026#34;: { \u0026#34;measurement\u0026#34;: [ \u0026#34;tcp_established\u0026#34;, \u0026#34;tcp_time_wait\u0026#34; ], \u0026#34;metrics_collection_interval\u0026#34;: 180 }, \u0026#34;statsd\u0026#34;: { \u0026#34;metrics_aggregation_interval\u0026#34;: 60, \u0026#34;metrics_collection_interval\u0026#34;: 180, \u0026#34;service_address\u0026#34;: \u0026#34;:8125\u0026#34; }, \u0026#34;swap\u0026#34;: { \u0026#34;measurement\u0026#34;: [ \u0026#34;swap_used_percent\u0026#34; ], \u0026#34;metrics_collection_interval\u0026#34;: 180 } } } } ä½œè€…ï¼šSREè¿ç»´åšå®¢\nåšå®¢åœ°å€ï¼šhttps://www.cnsre.cn\næ–‡ç« åœ°å€ï¼šhttps://www.cnsre.cn/posts/210531100355/\nç›¸å…³è¯é¢˜ï¼šhttps://www.cnsre.cn/tags/aws/\n","description":"å®‰è£…é…ç½®CloudWatchAgentï¼Œä½¿ç”¨ CloudWatch ä»£ç†æ”¶é›†æŒ‡æ ‡å’Œæ—¥å¿—ã€‚","id":60,"section":"posts","tags":["cloudwatch","aws"],"title":"å®‰è£…å’Œé…ç½®CloudWatchAgent","uri":"http://www.cnsre.cn:80/posts/210531100355/"},{"content":" ä½œè€…ï¼šSREè¿ç»´åšå®¢\nåšå®¢åœ°å€ï¼šhttps://www.cnsre.cn\næ–‡ç« åœ°å€ï¼šhttps://www.cnsre.cn/posts/210518420293/\nç›¸å…³è¯é¢˜ï¼šhttps://www.cnsre.cn/tags/zabbix/\nè‡ªä»æ¥è§¦zabbixåï¼Œå°±ä¸€ç›´æƒ³ç€æ€ä¹ˆæ‰èƒ½æŠŠå‘Šè­¦æ¨é€åˆ°ä¸ªäººå¾®ä¿¡ä¸Šã€‚æœ‰è¿™æ ·çš„æƒ³æ³•ä¸»è¦æ˜¯ä¸ªäººå¾®ä¿¡çš„ä½¿ç”¨é¢‘ç‡è¿œè¿œè¦æ¯”é’‰é’‰ï¼Œä¼ä¸šå¾®ä¿¡ï¼Œé‚®ç®±ï¼Œé£ä¹¦ç­‰ä½¿ç”¨é¢‘ç‡è¦é«˜ã€‚æ¯”å¦‚æˆ‘ï¼Œå°±é‡åˆ°è¿‡åœ¨å‘¨æœ«çš„æ—¶å€™ï¼Œå› ä¸ºæ²¡æœ‰åŠæ—¶ç™»å½•é’‰é’‰æŸ¥çœ‹zabbixå‘Šè­¦é€šçŸ¥ï¼Œå¯¼è‡´ä¸€äº›å‘Šè­¦æ²¡æ¥å¾—åŠå¤„ç†ï¼Œå¯¹ç¯å¢ƒäº§ç”Ÿäº†å½±å“ã€‚\nå‰æ®µæ—¶é—´æœ‹å‹ç»™æ¨èäº†pushplusï¼Œä¸€å¼€å§‹ä¸»è¦åœ¨jenkinsåšæ„å»ºé€šçŸ¥ç”¨çš„ï¼Œåæ¥å°±æƒ³ï¼Œèƒ½ä¸èƒ½ä½¿ç”¨zabbixçš„å‘Šè­¦é€šçŸ¥æ¨é€åˆ°å¾®ä¿¡ä¸Šå‘¢ï¼Ÿ\nå…ˆä»‹ç»ä¸‹pushpluså§,pushplus å®˜æ–¹ä»‹ç»\npushplus(æ¨é€åŠ )é›†æˆäº†å¾®ä¿¡ã€ä¼ä¸šå¾®ä¿¡ã€é’‰é’‰ã€çŸ­ä¿¡ã€é‚®ä»¶ç­‰å®æ—¶ä¿¡æ¯æ¨é€å¹³å°\nä½ åªéœ€è¦è°ƒç”¨ç®€å•çš„APIï¼Œå³å¯å¸®åŠ©ä½ è¿…é€Ÿå®Œæˆæ¶ˆæ¯çš„æ¨é€ï¼Œä½¿ç”¨ç®€å•æ–¹ä¾¿\næˆ‘ä»¬çš„æ‰€åšçš„ä¸€åˆ‡åªæ˜¯ä¸ºäº†è®©æ¨é€å˜çš„æ›´ç®€å•\npushplus ç™»å½•å®˜ç½‘æ³¨å†Œpushplus è®¿é—®å®˜ç½‘åç‚¹å‡»ç™»å½•,å¾®ä¿¡æ‰«æå³å¯æ³¨å†Œã€‚\nè·å–pushplus Token æ³¨å†ŒæˆåŠŸåã€‚ç‚¹å‡»ä¸€å¯¹å¤šï¼Œç„¶åæ–°å»ºä¸€ä¸ªç¾¤ç»„ã€‚ç¾¤ç»„ç¼–ç ä½œä¸ºç¾¤ç»„çš„å”¯ä¸€æ ‡ç¤ºï¼Œåç»­éœ€è¦ä½¿ç”¨ã€‚ç¾¤ç»„åç§°éšæ„å¡«å†™ã€‚\nåˆ›å»ºæˆåŠŸä¹‹åç‚¹å‡»ç¾¤ç»„ä¸Šçš„æŸ¥çœ‹äºŒç»´ç ï¼Œå°†äºŒç»´ç å‘ç»™éœ€è¦åŠ å…¥ç¾¤ç»„çš„åŒäº‹ã€‚ä»¥åæ¨é€çš„æ¶ˆæ¯åŠ å…¥ç¾¤ç»„çš„ç”¨æˆ·éƒ½ä¼šæ”¶çš„åˆ°ã€‚åœ¨â€œè®¢é˜…äººâ€ä¸­å¯ä»¥ä¸»åŠ¨çš„ç§»é™¤ä¸æƒ³è¦çš„ç”¨æˆ·ã€‚\nç„¶åä¿å­˜ä½ çš„tokenå’Œç¾¤ç»„ç¼–ç ã€‚\nzabbix_serverç«¯è®¾ç½® æŸ¥çœ‹pushplusè°ƒç”¨æ–¹å¼.\né™„ä¸Šè„šæœ¬\nè„šæœ¬å¾ˆç®€å•ï¼Œshellç›´æ¥è°ƒç”¨æ¥å£å³å¯\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 #!/bin/bash PATH=/bin:/sbin:/usr/bin:/usr/sbin:/usr/local/bin:/usr/local/sbin:~/bin export PATH LANG=en_US.UTF-8 ################################################# \u0026#34; # è„šæœ¬åç§° : zabbixå‘Šè­¦æ¨é€ä¸ªäººå¾®ä¿¡è„šæœ¬ # \u0026#34; # ä½œ è€… : sreè¿ç»´åšå®¢ # \u0026#34; # ç½‘ å€ : https:www.cnsre.cn # \u0026#34; ################################################# \u0026#34; token=c651d07axxxxxxxxxxx topic=$1 title=$2 content=$3 url=http://www.pushplus.plus/send json=\u0026#34;{\\\u0026#34;token\\\u0026#34;: \\\u0026#34;$token\\\u0026#34;, \\\u0026#34;title\\\u0026#34;: \\\u0026#34;$title\\\u0026#34;, \\\u0026#34;content\\\u0026#34;: \\\u0026#34;$3\\\u0026#34;, \\\u0026#34;template\\\u0026#34;: \\\u0026#34;html\\\u0026#34;, \\\u0026#34;topic\\\u0026#34;: \\\u0026#34;$topic\\\u0026#34;}\u0026#34; curl -H \u0026#34;Content-Type: application/json\u0026#34; -X POST -d \u0026#34;$json\u0026#34; $url token åœ¨ pushplus å®˜ç½‘ä¸­ä¸€å¯¹ä¸€ï¼Œä¸€å¯¹å¤šä¸­æŸ¥çœ‹ ä½ çš„token topic åœ¨ åˆ›å»ºçš„ç¾¤ç»„ ä¸­çš„ ç¾¤ç»„ç¼–ç  title æ¶ˆæ¯æ ‡é¢˜ content å…·ä½“æ¶ˆæ¯å†…å®¹ï¼Œæ ¹æ®ä¸åŒtemplateæ”¯æŒä¸åŒæ ¼å¼ url http://www.pushplus.plus/send æ¥¼ä¸‹ç½‘å‹ç•™è¨€è¯´è„šæœ¬æ— æ³•ä½¿ç”¨ï¼Œåæ¥ç»è¿‡æŸ¥çœ‹å‘ç°æ˜¯æ³¨å†Œåœ°å€çš„é—®é¢˜\néœ€è¦æ³¨æ„ä½ çš„æ³¨å†Œçš„å®˜ç½‘åœ°å€ hxtrip è¿˜æ˜¯ pushplus ã€‚\nä¸è¿‡æˆ‘è¿˜æ˜¯æ¨èä½¿ç”¨ pushplus å› ä¸º pushplus åœ¨å›½å†…æ˜¯å¤‡æ¡ˆäº†çš„ã€‚ å°†è„šæœ¬éƒ¨ç½²åœ¨alertscriptsç›®å½•ä¸‹ï¼Œå¦‚æœä½ ä¸çŸ¥é“åœ¨é‚£ï¼Œä½ å¯ä»¥å›æƒ³ä¸€ä¸‹ä½ é’‰é’‰å‘Šè­¦ï¼Œæˆ–è€…æ˜¯ä¼ä¸šå¾®ä¿¡å‘Šè­¦çš„è„šæœ¬æ”¾åœ¨é‚£ã€‚å¦‚æœå®åœ¨è®°ä¸èµ·æ¥ï¼Œé‚£å°±findæ‰¾ä¸‹alertscriptsç›®å½•å§\nzabbix webç«¯è®¾ç½® åˆ›å»ºæŠ¥è­¦åª’ä»‹ç±»å‹ ç™»å½•zabbix webç«¯ç‚¹å‡»ç®¡ç†\u0026ndash;æŠ¥è­¦åª’ä»‹ç±»å‹\u0026ndash;åˆ›å»ºåª’ä½“ç±»å‹\nåç§°ï¼šéšæ„å†™\nç±»å‹ï¼šé€‰æ‹©è„šæœ¬\nè„šæœ¬åç§°ï¼šæŒ‰ç…§å®é™…åç§°å¡«å†™\nè„šæœ¬å‚æ•°:\n{ALERT.SENDTO} {ALERT.SUBJECT} {ALERT.MESSAGE} åˆ›å»ºåŠ¨ä½œ ç‚¹å‡»é…ç½®\u0026ndash;åŠ¨ä½œ\u0026ndash;åˆ›å»ºåŠ¨ä½œ\nåŠ¨ä½œ\nåç§°ï¼šéšæ„å†™\næ¡ä»¶ï¼šæ ¹æ®è‡ªå·±çš„å‘Šè­¦éœ€æ±‚å¡«å†™\næ“ä½œ\né»˜è®¤æ“ä½œæ­¥éª¤æŒç»­æ—¶é—´ï¼š1h\né»˜è®¤æ ‡é¢˜ï¼šä½ ä¹Ÿå¯ä»¥éšæ„å†™ã€‚ä¹Ÿå¯ä»¥ç”¨ä¸‹é¢çš„ã€‚\n1 æ•…éšœ{TRIGGER.STATUS},æœåŠ¡å™¨:{HOSTNAME1}å‘ç”Ÿ:{TRIGGER.NAME}æ•…éšœ! æ•…éšœé€šçŸ¥ï¼ï¼ æ¶ˆæ¯å†…å®¹:å’Œæ ‡é¢˜ä¸€æ ·\n1 2 3 4 5 6 7 8 9 å‘Šè­¦ä¸»æœº:{HOSTNAME1}\u0026lt;br\u0026gt; IPåœ°å€ï¼š{HOST.CONN} \u0026lt;br\u0026gt; å‘Šè­¦æ—¶é—´:{EVENT.DATE} {EVENT.TIME}(UTC)\u0026lt;br\u0026gt; å‘Šè­¦ç­‰çº§:{TRIGGER.SEVERITY}\u0026lt;br\u0026gt; å‘Šè­¦ä¿¡æ¯: {TRIGGER.NAME}\u0026lt;br\u0026gt; å‘Šè­¦é¡¹ç›®:{TRIGGER.KEY1}\u0026lt;br\u0026gt; é—®é¢˜è¯¦æƒ…:{ITEM.NAME}:{ITEM.VALUE}\u0026lt;br\u0026gt; å½“å‰çŠ¶æ€:{TRIGGER.STATUS}:{ITEM.VALUE1}\u0026lt;br\u0026gt; äº‹ä»¶ID:{EVENT.ID}\u0026lt;br\u0026gt; æ“ä½œæ­¥éª¤\u0026ndash;ç‚¹å‡»æ–°çš„\né€‰æ‹©å‘é€åˆ°ç”¨æˆ·ï¼Œç‚¹å‡»æ·»åŠ \u0026ndash;admin\u0026ndash;é€‰æ‹©\nä»…é€åˆ°ï¼Œé€‰æ‹©ä½ åˆšåˆ›å»ºçš„ï¼Œæœ€åç‚¹å‡»æ·»åŠ \næœ€ä¸ºä¸ºè¿™æ ·\næ¢å¤æ“ä½œ\næ¢å¤æ“ä½œå’Œæ“ä½œä¸€æ ·\næ·»åŠ å®Œå\nåˆ›å»ºç”¨æˆ·æŠ¥è­¦åª’ä»‹ é€‰æ‹©ç®¡ç†\u0026ndash;ç”¨æˆ·\u0026ndash;admin\næµ‹è¯•å‘Šè­¦ æ·»åŠ å®Œè¿‡åï¼Œæ¥ä¸‹æ¥å°±æµ‹è¯•å§ã€‚\næˆ‘è¿™è¾¹é€‰æ‹©äº†ä¸€ä¸ªè§¦å‘å™¨è°ƒäº†ä¸‹å‘Šè­¦çš„å€¼ï¼Œæœ€åå±•ç¤ºä¸‹å‘Šè­¦ä»¥åŠæ¢å¤ã€‚\nä½œè€…ï¼šSREè¿ç»´åšå®¢\nåšå®¢åœ°å€ï¼šhttps://www.cnsre.cn\næ–‡ç« åœ°å€ï¼šhttps://www.cnsre.cn/posts/210518420293/\nç›¸å…³è¯é¢˜ï¼šhttps://www.cnsre.cn/tags/zabbix/\n","description":"ä½¿ç”¨pushpluså°†zabbixçš„å‘Šè­¦æ¨é€è‡³ä¸ªäººå¾®ä¿¡ï¼Œè¿™æ ·å°±ä¸ç”¨åœ¨éå·¥ä½œæ—¥å¿ƒå¿ƒå¿µå¿µçš„å»é’‰é’‰ã€é‚®ç®±ç­‰å»æŸ¥çœ‹å‘Šè­¦äº†","id":61,"section":"posts","tags":["zabbix","pushplus"],"title":"zabbixå‘Šè­¦æ¨é€è‡³ä¸ªäººå¾®ä¿¡","uri":"http://www.cnsre.cn:80/posts/210518420293/"},{"content":" ä½œè€…ï¼šSREè¿ç»´åšå®¢\nåšå®¢åœ°å€ï¼šhttps://www.cnsre.cn\næ–‡ç« åœ°å€ï¼šhttps://www.cnsre.cn/posts/210517344530/\nç›¸å…³è¯é¢˜ï¼šhttps://www.cnsre.cn/tags/zabbix/\naws ç«¯æ“ä½œ å…ˆåœ¨EC2 å®ä¾‹ä¸­é€‰ä¸­ç£ç›˜ ç„¶åæ‰“å¼€è·Ÿè®¾å¤‡ ä¿®æ”¹å¤§å°åä¿å­˜\nec2 ç«¯æ“ä½œ lsblk æŸ¥çœ‹å½“å‰è®¾å¤‡çš„ç£ç›˜ç¼–å·\ndf -T -H æŸ¥çœ‹æ‰©å®¹å‰çš„ç©ºé—´å¤§å°å¹¶ç¡®å®šç£ç›˜æ ¼å¼\ngrowpart /dev/nvme0n1 1 æŠŠæ‰©å®¹çš„ç©ºé—´æŒ‚è½½åˆ°ç£ç›˜ä¸Š\ncentos7æ‰§è¡Œåˆ’åˆ†ç©ºé—´å‘½ä»¤\nsudo xfs_growfs -d / æŠŠç©ºé—²çš„ç©ºé—´åˆ’åˆ†è‡³ /\ncentos6æ‰§è¡Œåˆ’åˆ†ç©ºé—´å‘½ä»¤\nresize2fs /dev/nvme0n1p1\ndf -h æŸ¥çœ‹éªŒè¯\nä½œè€…ï¼šSREè¿ç»´åšå®¢\nåšå®¢åœ°å€ï¼šhttps://www.cnsre.cn\næ–‡ç« åœ°å€ï¼šhttps://www.cnsre.cn/posts/210517344530/\nç›¸å…³è¯é¢˜ï¼šhttps://www.cnsre.cn/tags/zabbix/\n","description":"aws ec2å®ä¾‹è·Ÿç©ºé—´å®¹é‡ä¸è¶³å¦‚ä½•å¤„ç†ï¼Ÿæ•™ä½ å¦‚ä½•å¿«é€Ÿåœ¨awsä¸Šæ‰©å®¹ec2å®ä¾‹æ ¹ç©ºé—´ï¼Œæ‰©å®¹ec2æ ¹ç£ç›˜ã€‚","id":62,"section":"posts","tags":["ec2","aws"],"title":"AWSæ‰©å®¹EC2å®ä¾‹æ ¹ç©ºé—´","uri":"http://www.cnsre.cn:80/posts/210517344530/"},{"content":" ä½œè€…ï¼šSREè¿ç»´åšå®¢\nåšå®¢åœ°å€ï¼šhttps://www.cnsre.cn\næ–‡ç« åœ°å€ï¼šhttps://www.cnsre.cn/posts/210514620165/\nç›¸å…³è¯é¢˜ï¼šhttps://www.cnsre.cn/tags/aws/\né—®é¢˜æè¿° ALB è´Ÿè½½å‡è¡¡ RGC-Dev-ALB.xxx.cn-north-1.elb.amazonaws.com.cn è§£æåˆ°2ä¸ªIP 54.223.xxx.xxå’Œ52.81.xxx.xxï¼Œ å‘ç°æ¯2æ¬¡è¯·æ±‚ä¼šå¤±è´¥ä¸€æ¬¡ï¼Œåœ¨è¿›ä¸€æ­¥æµ‹è¯•æŠ“åŒ…å‘ç°æ²¡æœ‰æ”¶åˆ°52.81.xxx.xxxçš„è¿”å›ä¿¡æ¯ã€‚\né—®é¢˜åˆ†æ éšåæ£€æŸ¥ALBå»ºç«‹åœ¨ä¸¤ä¸ªå­ç½‘ï¼ˆsubnet-a1xxxxxå’Œsubnet-f3xxxxxï¼‰\nå…¶ä¸­54.223.xxx.xxåœ¨subnet-f32xxxxä¸­ï¼Œå­ç½‘è·¯ç”±è¡¨rtb-49xxxxä¸­0.0.0.0/0 æŒ‡å‘IGWï¼Œå› æ­¤å®¢æˆ·ç«¯å¯ä»¥ä¸»åŠ¨è®¿é—®åˆ°54.223.xxx.xxã€‚\n52.81.xxx.xxåœ¨subnet-a1xxxä¸­ï¼Œå­ç½‘è·¯ç”±è¡¨rtb-24xxxä¸­0.0.0.0/0æŒ‡å‘äº†nat gateway(nat-0axxxxxxxxxx), è¿™å°†å¯¼è‡´å®¢æˆ·ç«¯æ— æ³•è¿æ¥åˆ°52.81.xxx.xxï¼Œ å› æ­¤ä¹Ÿä¸ä¼šæ”¶åˆ°52.81.xxx.xxçš„å›åŒ…ã€‚\nè¯·çŸ¥æ™“ï¼Œå¯¹äºé¢å‘å…¬ç½‘çš„ALBï¼Œéœ€è¦å°†ALBéƒ¨ç½²åœ¨å…¬æœ‰å­ç½‘ä¸­ï¼Œ å³å­ç½‘è·¯ç”±è¡¨0.0.0.0/0éœ€è¦æŒ‡å‘IGWã€‚\nè§£å†³åŠæ³• ç›®å‰æœ‰2ä¸ªè§£å†³åŠæ³• 1ï¼‰ ä¿®æ”¹å­ç½‘è·¯ç”±è¡¨rtb-24xxxï¼Œ å°†0.0.0.0/0æŒ‡å‘igwï¼Œ è¯·çŸ¥æ™“ï¼Œ è¿™ä¸ªä¿®æ”¹å°†å½±å“æ‰€æœ‰å…³è”äº†rtb-24xxxè¿™ä¸ªè·¯ç”±è¡¨çš„å­ç½‘ï¼Œ\nå¦‚æœå¯¹åº”å­ç½‘ä¸­çš„èµ„æºæ²¡æœ‰å…¬ç½‘åœ°å€ï¼Œä¿®æ”¹å®Œæˆåå°†å¤±å»è®¿é—®å…¬ç½‘çš„èƒ½åŠ›ï¼Œæ­¤å¤–å¯¹äºå­ç½‘ä¸­æœ‰å…¬ç½‘åœ°å€çš„èµ„æºï¼Œå°†ç›´æ¥ä»å…¬ç½‘è·¯ç”±å¯è¾¾ã€‚\n2ï¼‰ ä¿®æ”¹ALBçš„å­ç½‘ï¼Œå¯ä»¥åœ¨EC2çš„æ§åˆ¶å°æ‰¾åˆ°â€œè´Ÿè½½å‡è¡¡â€ ï¼Œé€‰æ‹©å¯¹åº”çš„ALBï¼Œ åœ¨â€œæè¿°â€ \u0026gt; â€œåŸºæœ¬é…ç½®â€ \u0026gt;\u0026ldquo;å¯ç”¨åŒº\u0026rdquo; \u0026gt; ç‚¹å‡»â€œç¼–è¾‘å­ç½‘â€, å°†subnet-a1xxx ä¿®æ”¹ä¸ºåŒAZçš„å…¬æœ‰å­ç½‘ï¼ˆå³è·¯ç”±è¡¨0.0.0.0/0æŒ‡å‘igwçš„å­ç½‘ï¼‰\nä½œè€…ï¼šSREè¿ç»´åšå®¢\nåšå®¢åœ°å€ï¼šhttps://www.cnsre.cn\næ–‡ç« åœ°å€ï¼šhttps://www.cnsre.cn/posts/210514620165/\nç›¸å…³è¯é¢˜ï¼šhttps://www.cnsre.cn/tags/aws/\n","description":"AWSè´Ÿè½½å‡è¡¡æ¯2æ¬¡è¯·æ±‚ä¼šå¤±è´¥ä¸€æ¬¡ï¼Œè¿›è¡Œæµ‹è¯•æŠ“åŒ…å‘ç°æœ‰ä¸€æ¬¡æ²¡æœ‰æ”¶åˆ°çš„è¿”å›ä¿¡æ¯ã€‚","id":63,"section":"posts","tags":["aws","alb","è´Ÿè½½å‡è¡¡"],"title":"AWSä½¿ç”¨ALBè´Ÿè½½å‡è¡¡é‡åˆ°çš„é—®é¢˜","uri":"http://www.cnsre.cn:80/posts/210514620165/"},{"content":" ä½œè€…ï¼šSREè¿ç»´åšå®¢\nåšå®¢åœ°å€ï¼šhttps://www.cnsre.cn\næ–‡ç« åœ°å€ï¼šhttps://www.cnsre.cn/posts/210513036112/\nç›¸å…³è¯é¢˜ï¼šhttps://www.cnsre.cn/tags/zabbix/\næ•…éšœç°è±¡ ubuntu 16 å‡çº§18 ä¹‹å å®‰è£…äº†zabbix agent ä»Šå¤©çªç„¶agentæ‰äº† ä¸Šå»çš„æ—¶å€™å‘ç°\næŠ¥é”™ï¼š\nGot singnal [singnal:15(SIGTERM),sender_pid:31392,sender_uid:0,reason:0]. Exiting ...a åæ¥æ‰“ç®—-c å¯åŠ¨ç„¶åå‘ç° /usr/sbin/zabbix_agentd ä¸¢äº†\nè§£å†³æ–¹æ³• æˆ‘å°è¯•ç€å»æ£€æŸ¥selinuxï¼Œé˜²ç«å¢™ï¼Œå®‰å…¨ç»„ï¼Œä»¥åŠzabbix-agenté…ç½®æ–‡ä»¶ç­‰ç­‰éƒ½æ²¡æœ‰å‘ç°å¼‚å¸¸çš„åœ°æ–¹ï¼Œåœ¨åŒä¸€æ‰¹éƒ¨ç½²çš„agentä¸­å…¶ä»–çš„agent ä¹Ÿæš‚æ—¶æ²¡æœ‰å‡ºç°è¿™ç§æƒ…å†µã€‚\né—®äº†å¾ˆå¤šæœ‹å‹ï¼Œå› ä¸ºæ²¡æœ‰æ‰¾åˆ°åŸå› ï¼Œæ—¥å¿—ä¸­ç»™åˆ°çš„ä¿¡æ¯ä¹Ÿä¸æ˜¯å¾ˆå¤šï¼Œæœ€åé€‰æ‹©äº†é‡è£…zabbix_agent.\næœ€åä¸€æ¬¡é‡è£…ï¼Œæˆ‘åšé€‰æ‹©äº†æ‰‹åŠ¨ä¿®æ”¹zabbixçš„é…ç½®æ–‡ä»¶ï¼ŒéªŒè¯é—®é¢˜ï¼Œè¿˜æœ‰å¾…è§‚å¯Ÿã€‚å¦‚æœå„ä½å¤§ä½¬æœ‰çŸ¥é“åŸå› ï¼Œèƒ½å¤Ÿç•™è¨€æˆ–è€…ç§ä¿¡çš„è¯æˆ‘æƒ³æˆ‘ä¼šååˆ†æ„Ÿè°¢ã€‚\nä¸‹é¢æ”¾ä¸€ä¸ªzabbixå®˜æ–¹wiki ç½‘åä¸ºSwitchZabbixçš„ç½‘å‹é‡åˆ°åŒæ ·é—®é¢˜çš„åˆ†äº«ã€‚\nhttps://www.zabbix.com/forum/zabbix-troubleshooting-and-problems/369895-zabbix-is-not-running-on-frontend\nä½œè€…ï¼šSREè¿ç»´åšå®¢\nåšå®¢åœ°å€ï¼šhttps://www.cnsre.cn\næ–‡ç« åœ°å€ï¼šhttps://www.cnsre.cn/posts/210513036112/\nç›¸å…³è¯é¢˜ï¼šhttps://www.cnsre.cn/tags/zabbix/\n","description":"ubuntu zabbixæ— æ³•å¯åŠ¨","id":64,"section":"posts","tags":["zabbix","ubuntu"],"title":"ubuntu zabbixæ— æ³•å¯åŠ¨","uri":"http://www.cnsre.cn:80/posts/210513036112/"},{"content":" ä½œè€…ï¼šSREè¿ç»´åšå®¢\nåšå®¢åœ°å€ï¼šhttps://www.cnsre.cn\næ–‡ç« åœ°å€ï¼šhttps://www.cnsre.cn/posts/210510512134/\nç›¸å…³è¯é¢˜ï¼šhttps://www.cnsre.cn/tags/zabbix/\nç¡¬ä»¶é…ç½®éœ€æ±‚ ç¯å¢ƒ å¹³å° CPU/å†…å­˜ æ•°æ®åº“ ç¡¬ç›˜ ç›‘æ§ä¸»æœºæ•° å°å‹ centOS 2CPU/1GB MySQLã€InnoDB æ™®é€š 100 ä¸­å‹ centOS 2CPU/2GB MySQLã€InnoDB æ™®é€š 500 å¤§å‹ Red HatEnterpirse Linux 4CPU/8GB MySQLã€InnoDB æˆ–PostgreSQL RAID 10 æˆ– SSD å¤§äº1000 è¶…å¤§å‹ Red HatEnterpirse Linux 8CPU/16GB MySQLã€InnoDB æˆ–PostgreSQL RAID 10 æˆ– SSD å¤§äº10000 zabbixç‰ˆæœ¬ 4.4 Latest https://repo.zabbix.com/zabbix/4.4/rhel/7/x86_64/zabbix-release-4.4-1.el7.noarch.rpm 3.0 LTS ç¨³å®šç‰ˆ http://repo.zabbix.com/zabbix/3.0/rhel/7/x86_64/zabbix-release-3.0-1.el7.noarch.rpm 4.0 LTS æ­£å¼ç‰ˆ https://repo.zabbix.com/zabbix/4.0/rhel/7/x86_64/zabbix-release-4.0-1.el7.noarch.rpm pre-4.0ç‰ˆ http://repo.zabbix.com/zabbix/3.5/rhel/7/x86_64/zabbix-release-3.5-1.el7.noarch.rpm ç¯å¢ƒå‡†å¤‡ Linux 7.7.1908 nginx 1.16.1 zabbix-server 4.4 zabbix-agent 4.4 mysql 5.7.29 php 5.4.16 å…³é—­é˜²ç«å¢™åŠselinux 1 2 systemctl stop firewalld \u0026amp;\u0026amp; systemctl disable firewalld sed -i \u0026#39;s/SELINUX=enforcing/SELINUX=disabled/\u0026#39;/etc/selinux/config zabbixå®‰è£…é…ç½® å®‰è£…MySQLæ•°æ®åº“ä¸çŸ¥è¯†åº“ 1 rpm -i https://repo.zabbix.com/zabbix/4.4/rhel/7/x86_64/zabbix-release-4.4-1.el7.noarch.rpm å®‰è£…ZabbixæœåŠ¡å™¨ã€å‰ç«¯ã€ä»£ç† 1 yum install zabbix-server-mysql zabbix-web-mysql zabbix-agent -y é…ç½®Zabbix-server 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 mv /etc/zabbix/zabbix_server.conf /etc/zabbix/zabbix_server.conf.bak vim /etc/zabbix/zabbix_server.conf LogFile=/var/log/zabbix/zabbix_server.log LogFileSize=0 PidFile=/var/run/zabbix/zabbix_server.pid SocketDir=/var/run/zabbix DBHost=localhost DBName=zabbix DBUser=zabbix DBPassword=zabbix DBPort=3306 SNMPTrapperFile=/var/log/snmptrap/snmptrap.log CacheSize=1024M Timeout=4 AlertScriptsPath=/usr/lib/zabbix/alertscripts ExternalScripts=/usr/lib/zabbix/externalscripts LogSlowQueries=3000 æ•°æ®åº“å®‰è£…é…ç½® å®‰è£…æ•°æ®åº“ 1 2 wget http://dev.mysql.com/get/mysql57-community-release-el7-8.noarch.rpm yum localinstall mysql57-community-release-el7-8.noarch.rpm -y æ£€æŸ¥mysqlæºæ˜¯å¦å®‰è£…æˆåŠŸ 1 2 3 4 5 yum repolist enabled | grep \u0026#34;mysql.*-community.*\u0026#34; yum install mysql-community-server -y ### å¯åŠ¨MySQLæœåŠ¡ systemctl start mysqld ç™»å½•æ•°æ®åº“ 1 2 3 4 5 6 grep \u0026#39;temporary password\u0026#39; /var/log/mysqld.log #ç™»é™†æ•°æ®åº“ mysql -uroot -p ä¿®æ”¹é»˜è®¤å¯†ç  mysql\u0026gt; SET PASSWORD = PASSWORD(\u0026#39;Lenovo@123\u0026#39;); #Lenvoo@123æ˜¯ä½ çš„æ–°å¯†ç  âš ï¸ å¦‚ä½•è§£å†³\nERROR 1819 (HY000): Your password does not satisfy the current policy requirements 1 2 3 4 5 6 7 8 ä¿®æ”¹validate_password_policyå‚æ•°çš„å€¼ set global validate_password_policy=0; å†ä¿®æ”¹å¯†ç çš„é•¿åº¦ set global validate_password_length=1; å†æ¬¡æ‰§è¡Œä¿®æ”¹å¯†ç å°±å¯ä»¥äº† ALTER USER \u0026#39;root\u0026#39;@\u0026#39;localhost\u0026#39; IDENTIFIED BY \u0026#39;Lenovo@123\u0026#39;; å…è®¸rootè¿œç¨‹ç™»é™†* GRANT ALL PRIVILEGES ON *.* TO \u0026#39;root\u0026#39;@\u0026#39;%\u0026#39; IDENTIFIED BY \u0026#39;Lenovo@123\u0026#39; WITH GRANT OPTION; åˆ›å»ºzabbixæ•°æ®åº“å’Œç”¨æˆ· 1 2 3 4 5 6 7 8 9 10 11 12 13 mysql â€“uroot â€“p mysql\u0026gt; create database zabbix character set utf8; Query OK, 1 row affected (0.00 sec) mysql\u0026gt; grant all privileges on zabbix.* to \u0026#39;zabbix\u0026#39;@\u0026#39;localhost\u0026#39; identified by \u0026#39;zabbix\u0026#39;; Query OK, 0 rows affected, 1 warning (0.00 sec) mysql\u0026gt; flush privileges; Query OK, 0 rows affected (0.00 sec) å¯¼å…¥æ¨¡æ¿æ•°æ® æ–¹æ³•1 æ–¹æ³•2 æ–¹æ³•1\n1 2 mysql\u0026gt; use zabbix; mysql\u0026gt; source /usr/share/doc/zabbix-server-mysql-4.4.9/create.sql æ–¹æ³•2\n1 [root@localhost ~]# zcat /usr/share/doc/zabbix-server-mysql*/create.sql.gz | mysql -uzabbix -p zabbix nginxå®‰è£…é…ç½® å®‰è£…nginx 1 2 wget http://nginx.org/packages/rhel/7/x86_64/RPMS/nginx-1.18.0-1.el7.ngx.x86_64.rpm yum install nginx -y é…ç½®nginx 1 2 3 4 5 6 7 8 9 10 11 12 13 14 vim /etc/nginx/conf.d/default.conf ... location / { root /usr/share/zabbix; index index.php; } ... location ~ \\.php$ { fastcgi_pass 127.0.0.1:9000; fastcgi_index index.php; fastcgi_param SCRIPT_FILENAME /usr/share/zabbix$fastcgi_script_name; include fastcgi_params; } ... ä¿®æ”¹zabbixå‰ç«¯æ–‡ä»¶æƒé™ 1 2 chown nginx:nginx /usr/share/zabbix/* chmod -R 755 /usr/share/zabbix/* å¯åŠ¨nginx 1 systemctl restart nginx PHPå®‰è£…é…ç½® å®‰è£…php 1 yum install php-fpm php-gd php-mbstring php-bcmath php-gd php-xmlwriter php-xmlreader -y ä¿®æ”¹é…ç½®æ–‡ä»¶ 1 2 3 4 5 6 sed -i \u0026#34;s#max_execution_time = 30#max_execution_time = 600#g\u0026#34; /etc/php.ini sed -i \u0026#34;s#max_input_time = 60#max_input_time = 600#g\u0026#34; /etc/php.ini sed -i \u0026#34;s#memory_limit = 128M#memory_limit = 256M#g\u0026#34; /etc/php.ini sed -i \u0026#34;s#post_max_size = 8M#post_max_size = 32M#g\u0026#34; /etc/php.ini sed -i \u0026#34;s#upload_max_filesize = 2M#upload_max_filesize = 16M#g\u0026#34; /etc/php.ini sed -i \u0026#34;s/;date.timezone =/date.timezone = Asia\\/Shanghai/g\u0026#34; /etc/php.ini å¯åŠ¨php-fpm 1 systemctl start php-fpm å¯åŠ¨æ‰€æœ‰æœåŠ¡ 1 2 3 4 5 systemctl start zabbix-server systemctl start zabbix-agent systemctl start nginx systemctl start mysqld systemctl start php-fpm è®¾ç½®å¼€æœºå¯åŠ¨é¡¹ 1 systemctl enable zabbix-server zabbix-agent mysqld nginx php-fpm æ£€æŸ¥ç«¯å£ 1 2 3 4 5 6 [root@zabbix-server]# netstat -pntl tcp 0 0 127.0.0.1:9000 0.0.0.0:* LISTEN 5118/php-fpm: maste tcp 0 0 0.0.0.0:80 0.0.0.0:* LISTEN 5046/nginx: master tcp6 0 0 :::10050 :::* LISTEN 5577/zabbix_agentd tcp6 0 0 :::10051 :::* LISTEN 4821/zabbix_server tcp6 0 0 :::3306 :::* LISTEN 1703/mysqld è¿æ¥åˆ°æ–°å®‰è£…çš„Zabbixå‰ç«¯ï¼š http://server_ip\nä½œè€…ï¼šSREè¿ç»´åšå®¢\nåšå®¢åœ°å€ï¼šhttps://www.cnsre.cn\næ–‡ç« åœ°å€ï¼šhttps://www.cnsre.cn/posts/210510512134/\nç›¸å…³è¯é¢˜ï¼šhttps://www.cnsre.cn/tags/zabbix/\n","description":"ä½¿ç”¨LNMP æ¶æ„å®‰è£…zabbix 4.4","id":65,"section":"posts","tags":["zabbix"],"title":"LNMPå®‰è£…zabbix4.4","uri":"http://www.cnsre.cn:80/posts/210510512134/"},{"content":" \u0026nbsp\u0026nbspç•™è¨€æ¿\nğŸ“¢å¿«æ¥ç•™è¨€å‘è¡¨ä½ çš„çœ‹æ³•å§~\u0026nbsp\u0026nbsp\n","description":"ğŸ“¢æœ‰ä»€ä¹ˆæƒ³è¯´çš„å—ï¼Ÿå¿«æ¥ç•™è¨€å‘è¡¨ä½ çš„çœ‹æ³•å§~","id":66,"section":"posts","tags":null,"title":"ç•™è¨€æ¿","uri":"http://www.cnsre.cn:80/posts/comment/"},{"content":" ä½œè€…ï¼šSREè¿ç»´åšå®¢\nåšå®¢åœ°å€ï¼šhttps://www.cnsre.cn\næ–‡ç« åœ°å€ï¼šhttps://www.cnsre.cn/posts/210426034157/\nç›¸å…³è¯é¢˜ï¼šhttps://www.cnsre.cn/tags/jenkins/\nå‰è¨€ å¼€å‘ä¹±å‘ç‰ˆï¼Ÿä¸å‘é‚®ç®±å°±è¦ä¸Šç”Ÿäº§ï¼Ÿä½†æ˜¯æœ‰éœ€è¦è‡ªå·±å‘å¸ƒç”Ÿäº§ä»¥å¤–çš„å…¶ä»–ç¯å¢ƒã€‚æ€ä¹ˆåŠï¼Ÿæœ€åå†³å®šæŠŠjenkinsæ„å»ºçš„æƒé™ç»™å¼€å‘ï¼Œè¿™æ ·çš„è¯æ•ˆç‡ä¼šå¢åŠ ã€‚è¿ç»´ä¹Ÿä¸å¿…æ¯æ¬¡å¸®åŠ©å¼€å‘å»æ„å»ºå‘å¸ƒã€‚åŒæ—¶å–æ¶ˆæ‰ç”Ÿäº§ç¯å¢ƒçš„æƒé™ã€‚é¿å…ä¹±å‘ç‰ˆã€‚\nè§„åˆ’ jenkins å››ä¸ªé¡¹ç›®åˆ†åˆ«å¯¹åº”ä¸‰ä¸ªäººè´Ÿè´£ã€‚é¡¹ç›®ä¸‹çš„åªè´Ÿè´£ CIã€UAT.CDã€Pilot.CD\nç®€å•çš„è¯´å°±æ˜¯ ä¸‰ä¸ªäººè´Ÿè´£è‡ªå·±å¯¹åº”çš„é¡¹ç›®ï¼Œä½†æ˜¯æ¶‰åŠåˆ°PROD ç¯å¢ƒã€‚\né¡¹ç›® è´Ÿè´£äºº Broadlink jihua HiLink xiongfeng Miniprogram xiefei SpeedBoat jihua job å±•ç¤º\né…ç½® å®‰è£…æ’ä»¶ æ’ä»¶ï¼šRole-based Authorization Strategy\nç‰ˆæœ¬ï¼š2.3.2\nç³»ç»Ÿç®¡ç†\u0026mdash;\u0026gt;ç®¡ç†æ’ä»¶\nå…¨å±€å®‰å…¨é…ç½® ç³»ç»Ÿç®¡ç†\u0026mdash;\u0026gt;å…¨å±€å®‰å…¨é…ç½®\nåˆ›å»ºç”¨æˆ· ç³»ç»Ÿç®¡ç†\u0026mdash;\u0026gt;ç®¡ç†ç”¨æˆ·\nåˆ›å»ºè§’è‰² ç³»ç»Ÿç®¡ç†\u0026mdash;\u0026gt;Manage and Assign Roles\nåˆ›å»ºä¸€ä¸ªGlobal roles æˆ‘ä»¬å…ˆåˆ›å»ºä¸€ä¸ªå…¨å±€è§’è‰²userï¼Œèµ‹äºˆå…¨å±€æ ‡ç­¾ä¸‹é¢çš„Readæƒé™ã€‚\nåˆ›å»ºè§„åˆ’é¡¹ç›®çš„è§’è‰² åˆ†åˆ«åˆ›å»ºä¸¤ä¸ªé¡¹ç›®çš„è§’è‰²ï¼ŒæŒ‰ç…§è§„åˆ’çš„åˆ†é…æƒé™ï¼ŒPatternç”¨äºç»™é¡¹ç›®åŒ¹é… jobï¼Œä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼ã€‚\nBroadlink.* é…ç½®ä»¥Broadlinkå¼€å¤´çš„job Hilink-.*[^PROD]$ åŒ¹é…ä»¥Hilinkä¸ä»¥PRODç»“å°¾çš„job Miniprogram-.*[^PROD]$ åŒ¹é…ä»¥Miniprogramä¸ä»¥PRODç»“å°¾çš„job Speedboat-.*[^PROD]$ åŒ¹é…ä»¥Speedboatä¸ä»¥PRODç»“å°¾çš„job ç»™ç”¨æˆ·åˆ†é…è§’è‰² ç³»ç»Ÿç®¡ç†\u0026mdash;\u0026gt;Manage and Assign Roles\u0026mdash;\u0026gt;Assign Roles\nç™»å½•éªŒè¯ æ­¤å¤„å› ä¸ºBroadlink é¡¹ç›®è¿˜æœªå¼€å§‹ä½¿ç”¨ï¼Œæ‰€ä»¥æœªå°†ç”Ÿäº§ç¯å¢ƒåˆ’åˆ†å‡ºå»ã€‚\næƒé™éªŒè¯\nå¯ä»¥çœ‹åˆ°ï¼Œå„è‡ªçœ‹åˆ°çš„æƒé™å°±æ˜¯æˆ‘ä»¬åœ¨è§’è‰²é‡Œé¢èµ‹äºˆçš„æƒé™ï¼Œæ²¡æœ‰é—®é¢˜.\nä½œè€…ï¼šSREè¿ç»´åšå®¢\nåšå®¢åœ°å€ï¼šhttps://www.cnsre.cn\næ–‡ç« åœ°å€ï¼šhttps://www.cnsre.cn/posts/210426034157/\nç›¸å…³è¯é¢˜ï¼šhttps://www.cnsre.cn/tags/jenkins/\n","description":"æŠŠjenkins æ„å»ºçš„æƒé™ç»™å¼€å‘ï¼Œè¿™æ ·çš„è¯æ•ˆç‡ä¼šå¢åŠ ã€‚è¿ç»´ä¹Ÿä¸å¿…æ¯æ¬¡å¸®åŠ©å¼€å‘å»æ„å»ºå‘å¸ƒã€‚","id":67,"section":"posts","tags":["jenkins"],"title":"jenkins æ·»åŠ ç”¨æˆ·ç®¡ç†æƒé™","uri":"http://www.cnsre.cn:80/posts/210426034157/"},{"content":" ä½œè€…ï¼šSREè¿ç»´åšå®¢\nåšå®¢åœ°å€ï¼šhttps://www.cnsre.cn\næ–‡ç« åœ°å€ï¼šhttps://www.cnsre.cn/posts/210426026121/\nç›¸å…³è¯é¢˜ï¼šhttps://www.cnsre.cn/tags/grafana/\nä»‹ç» æœ€è¿‘ä¸Šäº†ELK æ—¥å¿—åˆ†æï¼Œæƒ³ç€æ‰‹çœ‹ä¸‹ç”¨æˆ·çš„åˆ†å¸ƒæƒ…å†µï¼Œåœ¨kibana ä¸­å±•ç¤ºç”¨æˆ·åˆ†å¸ƒæƒ…å†µæ˜¯æ²¡æœ‰é—®é¢˜çš„ï¼Œä½†æ˜¯ç´¢å¼•æ·»åŠ åˆ°Granfana ä¸­çš„è¯å°±æ— æ³•å±•ç¤ºã€‚\né—®é¢˜æè¿° æ·»åŠ ESç´¢å¼•ä»¥åï¼Œmapåœ°å›¾ä¸€ç‰‡é»‘ï¼Œä¸æ˜¾ç¤ºåœ°å›¾ä¿¡æ¯ä»¥åŠæ•°æ®ã€‚ä½†æ˜¯æœ‰æ˜¾ç¤ºå›¾ä¾‹ã€‚åæ¥å‘ç°æ˜¯ç½‘ç»œçš„é—®é¢˜ï¼Œåœ°å›¾çš„URLæ˜¯å¤–é¢çš„ï¼Œå›½å†…çœ‹ä¸åˆ°ã€‚\nè§£å†³æ–¹æ³• æ›¿æ¢æ’ä»¶é‡Œgrafana-worldmap-panelæ–‡ä»¶å›¾ç‰‡åœ°å€\nä¸‰ä¸ªæ–‡ä»¶è·¯å¾„\n1 2 3 grafana-worldmap-panel\\src\\worldmap.ts grafana-worldmap-panel\\dist\\module.js grafana-worldmap-panel\\dist\\module.js.map å°†ä¸‰ä¸ªæ–‡ä»¶ä¸­çš„\nhttps://cartodb-basemaps-{s}.global.ssl.fastly.net/light_all/{z}/{x}/{y}.png æ›¿æ¢ä¸º\nhttp://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}.png\nå°†ä¸‰ä¸ªæ–‡ä»¶ä¸­çš„\nhttps://cartodb-basemaps-{s}.global.ssl.fastly.net/dark_all/{z}/{x}/{y}.png\næ›¿æ¢ä¸º\nhttp://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}.png\næ“ä½œå¦‚ä¸‹ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 # cd /var/lib/grafana/plugins/ # grafana-worldmap-panel\\src\\worldmap.ts # grafana-worldmap-panel\\dist\\module.js # grafana-worldmap-panel\\dist\\module.js.map # sed -i \u0026#39;s/https:\\/\\/cartodb-basemaps{s}.global.ssl.fastly.net\\/light_all\\/{z}\\/{x}\\/{y}.png/http:\\/\\/{s}.basemaps.cartocdn.com\\/light_all\\/{z}\\/{x}\\/{y}.png/\u0026#39; \\ grafana-worldmap-panel/src/worldmap.ts \\ grafana-worldmap-panel/dist/module.js \\ grafana-worldmap-panel/dist/module.js.map #sed -i \u0026#39;s/https:\\/\\/cartodb-basemaps-{s}.global.ssl.fastly.net\\/dark_all\\/{z}\\/{x}\\/{y}.png/http:\\/\\/{s}.basemaps.cartocdn.com\\/dark_all\\/{z}\\/{x}\\/{y}.png/\u0026#39; \\ grafana-worldmap-panel/src/worldmap.ts \\ grafana-worldmap-panel/dist/module.js \\ grafana-worldmap-panel/dist/module.js.map é‡å¯Grafana 1 systemctl restart grafana âš ï¸ æ³¨ï¼šå¦‚æœä¸è¡Œçš„è¯ï¼Œå¤šé‡å¯åˆ·æ–°é¡µé¢å‡ æ¬¡è¯•è¯• ä½œè€…ï¼šSREè¿ç»´åšå®¢\nåšå®¢åœ°å€ï¼šhttps://www.cnsre.cn\næ–‡ç« åœ°å€ï¼šhttps://www.cnsre.cn/posts/210426026121/\nç›¸å…³è¯é¢˜ï¼šhttps://www.cnsre.cn/tags/grafana/\n","description":"æœ€è¿‘ä¸Šäº†ELK æ—¥å¿—åˆ†æï¼Œæƒ³ç€æ‰‹çœ‹ä¸‹ç”¨æˆ·çš„åˆ†å¸ƒæƒ…å†µï¼Œåœ¨kibana ä¸­å±•ç¤ºç”¨æˆ·åˆ†å¸ƒæƒ…å†µæ˜¯æ²¡æœ‰é—®é¢˜çš„ï¼Œä½†æ˜¯ç´¢å¼•æ·»åŠ åˆ°Granfana ä¸­çš„è¯å°±æ— æ³•å±•ç¤ºã€‚","id":68,"section":"posts","tags":["grafana","æ•…éšœé›†"],"title":"Grafanaæ’ä»¶åœ°å›¾Worldmapä¸æ˜¾ç¤º","uri":"http://www.cnsre.cn:80/posts/210426026121/"},{"content":" ä½œè€…ï¼šSREè¿ç»´åšå®¢\nåšå®¢åœ°å€ï¼šhttps://www.cnsre.cn\næ–‡ç« åœ°å€ï¼šhttps://www.cnsre.cn/posts/210425130327/\nç›¸å…³è¯é¢˜ï¼šhttps://www.cnsre.cn/tags/zabbix/\nzabbix-agent æœåŠ¡å™¨é…ç½® è„šæœ¬å†…å®¹ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 cat /etc/zabbix/scripts/auto_detection_tcp_state.sh #!/bin/bash #TCPè¿æ¥æ•°åŠçŠ¶æ€ if [ $# -ne 1 ];then echo -e \u0026#34;\\033[32mUsage: sh $0 {ESTABLISHED|LISTEN|TIME_WAIT|CLOSED|CLOSE_WAIT|CLOSING|FIN_WAIT1|FIN_WAIT2|LAST_ACK|SYN_RECV|SYN_SENT}\\033[0m\u0026#34; exit 1 fi case $1 in #socketå·²ç»å»ºç«‹è¿æ¥ ESTABLISHED) result=$(netstat -an | awk \u0026#39;/^tcp/ {print $0}\u0026#39;|grep -wc \u0026#34;ESTABLISHED\u0026#34;) echo $result ;; #ç›‘å¬çŠ¶æ€ LISTEN) result=$(netstat -an | awk \u0026#39;/^tcp/ {print $0}\u0026#39;|grep -wc \u0026#34;LISTEN\u0026#34;) echo $result ;; #è¡¨ç¤ºæ”¶åˆ°äº†å¯¹æ–¹çš„FINæŠ¥æ–‡ï¼Œå¹¶å‘é€å‡ºäº†ACKæŠ¥æ–‡ï¼Œç­‰å¾…2MSLåå°±å¯å›åˆ°CLOSEDçŠ¶æ€ TIME_WAIT) result=$(netstat -an | awk \u0026#39;/^tcp/ {print $0}\u0026#39;|grep -wc \u0026#34;TIME_WAIT\u0026#34;) echo $result ;; #socketæ²¡æœ‰è¢«ä½¿ç”¨ï¼Œæ— è¿æ¥ CLOSED) result=$(netstat -an | awk \u0026#39;/^tcp/ {print $0}\u0026#39;|grep -wc \u0026#34;CLOSED\u0026#34;) echo $result ;; #ç­‰å¾…å…³é—­è¿æ¥ CLOSE_WAIT) result=$(netstat -an | awk \u0026#39;/^tcp/ {print $0}\u0026#39;|grep -wc \u0026#34;CLOSE_WAIT\u0026#34;) echo $result ;; #æœåŠ¡å™¨ç«¯å’Œå®¢æˆ·ç«¯éƒ½åŒæ—¶å…³é—­è¿æ¥ CLOSING) result=$(netstat -an | awk \u0026#39;/^tcp/ {print $0}\u0026#39;|grep -wc \u0026#34;CLOSING\u0026#34;) echo $result ;; #å¥—æ¥å­—å·²å…³é—­ï¼Œè¿æ¥æ­£åœ¨å…³é—­ FIN_WAIT1) result=$(netstat -an | awk \u0026#39;/^tcp/ {print $0}\u0026#39;|grep -wc \u0026#34;FIN_WAIT1\u0026#34;) echo $result ;; #è¿æ¥å·²å…³é—­ï¼Œå¥—æ¥å­—æ­£åœ¨ç­‰å¾…ä»è¿œç¨‹ç«¯å…³é—­ FIN_WAIT2) result=$(netstat -an | awk \u0026#39;/^tcp/ {print $0}\u0026#39;|grep -wc \u0026#34;FIN_WAIT2\u0026#34;) echo $result ;; #è¿œç«¯å…³é—­ï¼Œå½“å‰socketè¢«åŠ¨å…³é—­åå‘é€FINæŠ¥æ–‡ï¼Œç­‰å¾…å¯¹æ–¹ACKæŠ¥æ–‡ LAST_ACK) result=$(netstat -an | awk \u0026#39;/^tcp/ {print $0}\u0026#39;|grep -wc \u0026#34;LAST_ACK\u0026#34;) echo $result ;; #æ¥æ”¶åˆ°SYNæŠ¥æ–‡ SYN_RECV) result=$(netstat -an | awk \u0026#39;/^tcp/ {print $0}\u0026#39;|grep -wc \u0026#34;SYN_RECV\u0026#34;) echo $result ;; #å·²ç»å‘é€SYNæŠ¥æ–‡ SYN_SENT) result=$(netstat -an | awk \u0026#39;/^tcp/ {print $0}\u0026#39;|grep -wc \u0026#34;SYN_SENT\u0026#34;) echo $result ;; *) echo -e \u0026#34;\\033[32mUsage: sh $0 {ESTABLISHED|LISTEN|TIME_WAIT|CLOSED|CLOSE_WAIT|CLOSING|FIN_WAIT1|FIN_WAIT2|LAST_ACK|SYN_RECV|SYN_SENT}\\033[0m\u0026#34; esac ç¼–è¾‘zabbix_agenté…ç½®æ–‡ä»¶ æ·»åŠ ä»¥ä¸‹å†…å®¹\n1 2 3 vim /etc/zabbix/zabbix_agentd.conf ##æ·»åŠ æ­¤è¡Œ UserParameter=tcp.state[*],/etc/zabbix/scripts/auto_detection_tcp_state.sh $1 é‡å¯zabbix-agent 1 service zabbix_agentd restart æˆæƒå¹¶éªŒè¯è„šæœ¬ 1 2 3 4 5 chmod +x auto_detection_tcp_state.sh ./auto_detection_tcp_state.sh LISTEN 9 zabbix_get -s 10.0.10.243 -k \u0026#34;tcp.state[LISTEN]\u0026#34; 9 Zabbixç›‘æ§å¹³å°é…ç½® æ¨¡æ¿ ç‚¹å‡»ä¸‹è½½zabbix_tcp_templates.xml\nå¯¼å…¥TCPçŠ¶æ€ç›‘æ§æ¨¡æ¿ é…ç½®-\u0026gt;æ¨¡æ¿-\u0026gt;å¯¼å…¥(å³ä¸Šè§’)-\u0026gt;é€‰æ‹©ä¸‹è½½çš„æ¨¡æ¿æ–‡ä»¶-\u0026gt;æœ€åç‚¹å‡»å¯¼å…¥\nå…³è”æ¨¡æ¿ è¦æŠŠå¯¼å…¥çš„æ¨¡æ¿å…³è”åˆ°ç›¸å¯¹åº”çš„ä¸»æœºä¸Šè¾¹ã€é…ç½®-\u0026gt;ç‚¹å‡»ä½ çš„ä¸»æœº-\u0026gt;``æ¨¡æ¿-\u0026gt;é€‰æ‹©åˆšæ‰å¯¼å…¥æ¨¡æ¿ï¼Œç‚¹å‡»æ·»åŠ ï¼Œæœ€åç‚¹å‡»æ›´æ–°`å³å¯ã€‚\næœ€åå±•ç¤º ESTABLISHED socketå·²ç»å»ºç«‹è¿æ¥ CLOSED socketæ²¡æœ‰è¢«ä½¿ç”¨ï¼Œæ— è¿æ¥ CLOSING æœåŠ¡å™¨ç«¯å’Œå®¢æˆ·ç«¯éƒ½åŒæ—¶å…³é—­è¿æ¥ CLOSE_WAIT ç­‰å¾…å…³é—­è¿æ¥ TIME_WAIT è¡¨ç¤ºæ”¶åˆ°äº†å¯¹æ–¹çš„FINæŠ¥æ–‡ï¼Œå¹¶å‘é€å‡ºäº†ACKæŠ¥æ–‡ï¼Œç­‰å¾…2MSLåå°±å¯å›åˆ°CLOSEDçŠ¶æ€ LAST_ACK è¿œç«¯å…³é—­ï¼Œå½“å‰socketè¢«åŠ¨å…³é—­åå‘é€FINæŠ¥æ–‡ï¼Œç­‰å¾…å¯¹æ–¹ACKæŠ¥æ–‡ LISTEN ç›‘å¬çŠ¶æ€ SYN_RECV æ¥æ”¶åˆ°SYNæŠ¥æ–‡ SYN_SENT å·²ç»å‘é€SYNæŠ¥æ–‡ FIN_WAIT1 The socket is closed, and the connection is shutting down FIN_WAIT2 Connection is closed, and the socket is waiting for a shutdown from the remote TCP ç›¸å…³ææ–™ Time_WaitçŠ¶æ€äº§ç”Ÿçš„åŸå› ï¼Œå±å®³ï¼Œå¦‚ä½•é¿å…\nä»€ä¹ˆæ˜¯time_Waitï¼Ÿå¦‚ä½•äº§ç”Ÿçš„ï¼Ÿ\né™„é€é€å‡ ä¸ªè‡ªå®šä¹‰è„šæœ¬ æ¥å£å¥åº·æ£€æŸ¥ ç›‘æ§ç£ç›˜IO æ¥å£å¥åº·æ£€æŸ¥\n1 2 3 4 5 6 7 8 9 10 11 12 #!/bin/bash healthyCheck=https://validation.xxx.cn/healthyCheck if [ $# -ne 1 ];then echo \u0026#34;Follow the script name with an argument\u0026#34; fi case $1 in healthyCheck) curl -k -s $healthyCheck |awk -F \u0026#39;\u0026#34;|:|,\u0026#39; \u0026#39;{print $4}\u0026#39; ;; *) echo -e \u0026#34;\\033[5;31m Usage: sh -bash [Boradlink|Hcmini]\\033[0m\u0026#34; esac ç›‘æ§ç£ç›˜IO\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 #!/bin/bash Device=`iostat |awk \u0026#39;{print $1}\u0026#39; | awk \u0026#39;NR==7{print}\u0026#39;` if [ $# -ne 1 ];then echo \u0026#34;Follow the script name with an argument\u0026#34; fi case $1 in rrqm) iostat -dxk 1 1|grep -w $Device |awk \u0026#39;{print $3}\u0026#39; ;; rps) iostat -dxk 1 1|grep -w $Device |awk \u0026#39;{print $4}\u0026#39; ;; wps) iostat -dxk 1 1|grep -w $Device |awk \u0026#39;{print $5}\u0026#39; ;; rKBps) iostat -dxk 1 1|grep -w $Device |awk \u0026#39;{print $6}\u0026#39; ;; wKBps) iostat -dxk 1 1|grep -w $Device |awk \u0026#39;{print $7}\u0026#39; ;; avgrq-sz) iostat -dxk 1 1|grep -w $Device |awk \u0026#39;{print $8}\u0026#39; ;; avgqu-sz) iostat -dxk 1 1|grep -w $Device |awk \u0026#39;{print $9}\u0026#39; ;; await) iostat -dxk 1 1|grep -w $Device |awk \u0026#39;{print $10}\u0026#39; ;; svctm) iostat -dxk 1 1|grep -w $Device |awk \u0026#39;{print $13}\u0026#39; ;; util) iostat -dxk 1 1|grep -w $Device |awk \u0026#39;{print $14}\u0026#39; ;; *) echo -e \u0026#34;\\e[033mUsage: sh $0 [rrqm|rps|wps|rKBps|wKBps|avgqu-sz|avgrq-sz|await|svctm|util]\\e[0m\u0026#34; esac eof ä½œè€…ï¼šSREè¿ç»´åšå®¢\nåšå®¢åœ°å€ï¼šhttps://www.cnsre.cn\næ–‡ç« åœ°å€ï¼šhttps://www.cnsre.cn/posts/210425130327/\nç›¸å…³è¯é¢˜ï¼šhttps://www.cnsre.cn/tags/zabbix/\n","description":"ä½¿ç”¨zabbix ç›‘æ§TCP è¿æ¥æ•°ã€çŠ¶æ€ç­‰ä¿¡æ¯ï¼Œåœ¨æ–‡ç« æœ€åé™„ä¸Šä¸€äº›å…¶ä»–çš„zabbixå…¶ä»–è‡ªå®šä¹‰è„šæœ¬ã€‚","id":69,"section":"posts","tags":["zabbix","shell"],"title":"zabbixç›‘æ§TCPçŠ¶æ€","uri":"http://www.cnsre.cn:80/posts/210425130327/"},{"content":" ä½œè€…ï¼šSREè¿ç»´åšå®¢\nåšå®¢åœ°å€ï¼šhttps://www.cnsre.cn\næ–‡ç« åœ°å€ï¼šhttps://www.cnsre.cn/posts/210423140530/\nç›¸å…³è¯é¢˜ï¼šhttps://www.cnsre.cn/tags/grafana/\ngrafana-server é…ç½® smtp æœåŠ¡å™¨ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 vim /etc/grafana/grafana.ini #ä¿®æ”¹ä¸€ä¸‹å†…å®¹ #################################### SMTP / Emailing ########################## [smtp] # å¯ç”¨ smtp enabled = true # é‚®ä»¶æœåŠ¡å™¨åœ°å€å’Œç«¯å£ host = smtp.189.cn:465 # å‘é€å‘Šè­¦é‚®ä»¶é‚®ç®±è´¦å· user = cnsre@189.cn # å‘é€å‘Šè­¦é‚®ä»¶é‚®ç®±å¯†ç  password = 123456 ;cert_file = ;key_file = ;skip_verify = false from_address = cnsre@189.cn from_name = Grafana # EHLO identity in SMTP dialog (defaults to instance_name) ehlo_identity = dashboard.example.com [emails] ;welcome_email_on_sign_up = false é‡å¯æœåŠ¡ 1 systemctl restart grafana-server é…ç½®é‚®ä»¶é€šçŸ¥æ–¹å¼ ä¿å­˜å‘é€æµ‹è¯•é‚®ä»¶ï¼Œé…ç½®å®Œæˆ\næŸ¥çœ‹é‚®ç®±æ˜¯å¦æ”¶åˆ°æµ‹è¯•é‚®ä»¶\\ é…ç½®å‘Šè­¦ 1çš„æ„æ€ä¸º Max Request time TOP 10 alert æ¯åˆ†é’Ÿè®¡ç®—ä¸€æ¬¡å›¾æ ‡æ•°æ® å‘Šè­¦è§¦å‘æŒç»­ä¸¤åˆ†é’Ÿå‘é€é‚®ä»¶ã€‚\n2çš„æ„æ€ä¸º æŸ¥è¯¢Aè¯­å¥ï¼Œ5åˆ†é’Ÿä¹‹å‰åˆ°ç°åœ¨çš„å¹³å‡å€¼å¤§äº500 åˆ™è§¦å‘å‘Šè­¦ã€‚ é…ç½®å‘Šè­¦æ–¹å¼ ä¸ºäº†å‘Šè­¦å¹¶å‘é€é‚®ä»¶ æˆ‘æŠŠè¯·æ±‚æ—¶é—´çš„æ•°å€¼è®¾ç½®ä¸ºå¤§äº5 åˆ™è§¦å‘å‘Šè­¦ã€‚\næ”¶åˆ°é‚®ä»¶ä¸º\nä¸‹è¾¹è¿˜é…æœ‰å›¾ç‰‡ å›¾ç‰‡å¤ªå¤§ï¼Œå°±ä¸å±•ç¤ºäº† ã€‚\nä½œè€…ï¼šSREè¿ç»´åšå®¢\nåšå®¢åœ°å€ï¼šhttps://www.cnsre.cn\næ–‡ç« åœ°å€ï¼šhttps://www.cnsre.cn/posts/210423140530/\nç›¸å…³è¯é¢˜ï¼šhttps://www.cnsre.cn/tags/grafana/\n","description":"grafanaé…ç½®é˜ˆå€¼ï¼Œå®ç°é‚®ä»¶å‘Šè­¦é€šçŸ¥","id":70,"section":"posts","tags":["grafana"],"title":"Grafanaé‚®ç®±å‘Šè­¦","uri":"http://www.cnsre.cn:80/posts/210423140530/"},{"content":" ä½œè€…ï¼šSREè¿ç»´åšå®¢\nåšå®¢åœ°å€ï¼šhttps://www.cnsre.cn\næ–‡ç« åœ°å€ï¼šhttps://www.cnsre.cn/posts/210421130319/\nç›¸å…³è¯é¢˜ï¼šhttps://www.cnsre.cn/tags/shell/\nåˆ©ç”¨Shellå¼€å‘è·³æ¿æœºåŠŸèƒ½è„šæœ¬æ¡ˆä¾‹ å¼€å‘ä¼ä¸šçº§Shellè·³æ¿æœºæ¡ˆä¾‹ã€‚è¦æ±‚ç”¨æˆ·ç™»å½•åˆ°è·³æ¿æœºä»…èƒ½æ‰§è¡Œç®¡ç†å‘˜ç»™å®šçš„é€‰é¡¹åŠ¨ä½œï¼Œä¸å…è®¸ä»¥ä»»ä½•å½¢å¼ä¸­æ–­è„šæœ¬åˆ°è·³æ¿æœºæœåŠ¡å™¨ä¸Šæ‰§è¡Œä»»ä½•ç³»ç»Ÿå‘½ä»¤ã€‚\né¦–å…ˆåšå¥½SSHå¯†é’¥éªŒè¯ï¼ˆè·³æ¿æœºåœ°å€172.16.1.200ï¼‰ã€‚ ä»¥ä¸‹æ“ä½œå‘½ä»¤åœ¨æ‰€æœ‰æœºå™¨ä¸Šæ“ä½œï¼š\n1 2 3 4 [root@cnsre ~]# useradd cnsre #\u0026lt;==è¦åœ¨æ‰€æœ‰æœºå™¨ä¸Šæ“ä½œã€‚\u0026lt; code=\u0026#34;\u0026#34;\u0026gt; [root@cnsre ~]# echo 123456|passwd --stdin cnsre #\u0026lt;==è¦åœ¨æ‰€æœ‰æœºå™¨ä¸Šæ“ä½œã€‚\u0026lt; code=\u0026#34;\u0026#34;\u0026gt; Changingpassword for user cnsre passwd:all authentication tokens updated successfully. ä»¥ä¸‹æ“ä½œå‘½ä»¤ä»…åœ¨è·³æ¿æœºä¸Šæ“ä½œï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 [root@cnsre ~]# su - cnsre [root@cnsre ~]# ssh-keygen -t dsa -P \u0026#39;\u0026#39; -f ~/.ssh/id_dsa \u0026gt;/dev/null 2\u0026gt;\u0026amp;1 #\u0026lt;==ç”Ÿæˆå¯†é’¥å¯¹ã€‚\u0026lt; code=\u0026#34;\u0026#34;\u0026gt; [jump@cnsre ~]$ ssh-copy-id -i ~/.ssh/id_dsa.pub 192.168.33.130 #\u0026lt;==å°†å…¬é’¥åˆ†å‘åˆ°å…¶ä»–æœåŠ¡å™¨ã€‚\u0026lt; code=\u0026#34;\u0026#34;\u0026gt; Theauthenticity of host \u0026#39;192.168.33.130 (192.168.33.130)\u0026#39; can\u0026#39;t be established. RSA keyfingerprint is fd:2c:0b:81:b0:95:c3:33:c1:45:6a:1c:16:2f:b3:9a. Are yousure you want to continue connecting (yes/no)? yes Warning:Permanently added \u0026#39;192.168.33.130\u0026#39; (RSA) to the list of known hosts. jump@192.168.33.130\u0026#39;spassword: Now trylogging into the machine, with \u0026#34;ssh \u0026#39;192.168.33.130\u0026#39;\u0026#34;, and check in: .ssh/authorized_keys to makesure we haven\u0026#39;t added extra keys that you weren\u0026#39;t expecting. [jump@cnsre ~]$ ssh-copy-id -i ~/.ssh/id_dsa.pub 192.168.33.129 #\u0026lt;==å°†å…¬é’¥åˆ†å‘åˆ°å…¶ä»–æœåŠ¡å™¨ã€‚\u0026lt; code=\u0026#34;\u0026#34;\u0026gt; Theauthenticity of host \u0026#39;192.168.33.129 (192.168.33.129)\u0026#39; can\u0026#39;t be established. RSA keyfingerprint is fd:2c:0b:81:b0:95:c3:33:c1:45:6a:1c:16:2f:b3:9a. Are yousure you want to continue connecting (yes/no)? yes Warning:Permanently added \u0026#39;192.168.33.129\u0026#39; (RSA) to the list of known hosts. jump@192.168.33.129\u0026#39;spassword: Now trylogging into the machine, with \u0026#34;ssh \u0026#39;192.168.33.129\u0026#39;\u0026#34;, and check in: .ssh/authorized_keys to makesure we haven\u0026#39;t added extra keys that you weren\u0026#39;t expecting. å®ç°ä¼ ç»Ÿçš„è¿œç¨‹è¿æ¥èœå•é€‰æ‹©è„šæœ¬ã€‚ èœå•è„šæœ¬å¦‚ä¸‹ï¼š\n1 2 3 4 cat \u0026lt;\u0026lt;menu 1)LB01-172.16.1.200 2)exit menu åˆ©ç”¨linuxä¿¡å·é˜²æ­¢ç”¨æˆ·ä¸­æ–­ä¿¡å·åœ¨è·³æ¿æœºä¸Šæ“ä½œã€‚ 1 2 3 functiontrapper () { trap \u0026#39;:\u0026#39; INT EXIT TSTP TERM HUP #\u0026lt;==å±è”½è¿™äº›ä¿¡å·ã€‚\u0026lt; code=\u0026#34;\u0026#34;\u0026gt; } ç”¨æˆ·ç™»å½•è·³æ¿æœºåå³è°ƒç”¨è„šæœ¬ ï¼ˆä¸èƒ½å‘½ä»¤è¡Œç®¡ç†è·³æ¿æœºï¼‰ï¼Œå¹¶åªèƒ½æŒ‰ç®¡ç†å‘˜çš„è¦æ±‚é€‰å•ã€‚\nä»¥ä¸‹ä¸ºå®æˆ˜å†…å®¹ã€‚\nè„šæœ¬æ”¾åœ¨è·³æ¿æœºä¸Šï¼š\nå°†pofifle.dç›®å½•ä¸‹åˆ›å»ºï¼Œç™»å½•ç”¨æˆ·å°±è‡ªåŠ¨æ‰§è¡Œçš„jump.sh è„šæœ¬ 1 2 3 4 5 [root@cnsre ~]# echo \u0026#39;[ $UID -ne 0 ] \u0026amp;\u0026amp; . /server/scripts/jump.sh\u0026#39;\u0026gt;/etc/profile.d/jump.sh [root@cnsre ~]# cat /etc/profile.d/jump.sh #!/bin/sh [ $UID -ne 0 ] \u0026amp;\u0026amp; . /server/scripts/jump.sh #åˆ¤æ–­å¦‚æœä¸æ˜¯rootç”¨æˆ·ï¼Œå°±æ‰§è¡Œjump.shï¼Œç„¶åè°ƒç”¨/server/scripts/jump.shè„šæœ¬ ç¼–å†™è·³æ¿æœºä¸»è„šæœ¬ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 #!/bin/sh ############################################ #zabbixå¾®ä¿¡å‘Šè­¦è„šæœ¬ #ä¿®æ”¹æ—¶é—´ï¼š2020-xx-xx #ä¿®æ”¹å†…å®¹ï¼šä¿®æ”¹å†…å®¹æè¿° ############################################ trapper(){ trap \u0026#39;:\u0026#39; INT EXIT TSTP TERM HUP #\u0026lt;==å®šä¹‰éœ€è¦å±è”½çš„ä¿¡å·ï¼Œå†’å·è¡¨ç¤ºå•¥éƒ½ä¸åšã€‚ } main(){ while : do trapper clear cat\u0026lt;\u0026lt;menu 1)LB01-172.16.1.200 menu read -p\u0026#34;Pls input a num.:\u0026#34; num case \u0026#34;$num\u0026#34; in 1) echo \u0026#39;login in LB01.\u0026#39; ssh 172.16.1.200 ;; 110) read -p \u0026#34;your birthday:\u0026#34; char if [ \u0026#34;$char\u0026#34; = \u0026#34;0926\u0026#34; ];then exit sleep 3 fi ;; *) echo \u0026#34;select error.\u0026#34; esac done } main æ‰§è¡Œæ•ˆæœå¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 # su - cnsre #\u0026lt;==åˆ‡åˆ°æ™®é€šç”¨æˆ·å³å¼¹å‡ºèœå•ï¼Œå·¥ä½œä¸­ç›´æ¥ç”¨cnsreç™»å½•ï¼Œå³å¼¹å‡ºèœå•ã€‚ 1) LB01-172.16.1.200 Pls inputa num.:1 #\u0026lt;==é€‰1è¿›å…¥LB01 æœåŠ¡å™¨ã€‚ login in192.168.33.129. Lastlogin: Tue Oct 11 17:23:52 2016 from 192.168.33.128 [jump@cnsre~]$ #\u0026lt;==æŒ‰ctrl+dé€€å‡ºåˆ°è·³æ¿æœºæœåŠ¡å™¨å†æ¬¡å¼¹å‡ºèœå•ã€‚ 1) LB01-172.16.1.200 [jump@cnsre~]$ #\u0026lt;==æŒ‰ctrl+dé€€å‡ºåˆ°è·³æ¿æœºæœåŠ¡å™¨å†æ¬¡å¼¹å‡ºèœå•ã€‚ 1) LB01-172.16.1.200 Pls inputa num.:110 #\u0026lt;==é€‰110è¿›å…¥è·³æ¿æœºå‘½ä»¤æç¤ºç¬¦ã€‚ yourbirthday:0926 #\u0026lt;==éœ€è¦è¾“å…¥ç‰¹åˆ«ç æ‰èƒ½è¿›å…¥çš„ï¼Œè¿™é‡Œç®¡ç†å‘˜é€šé“ï¼Œå¯†ç è¦ä¿å¯†å‘¦ã€‚ [root@cnsre]# #\u0026lt;==è·³æ¿æœºç®¡ç†å‘½ä»¤è¡Œã€‚ æœ€ç»ˆè„šæœ¬ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 #!/bin/bash ############################################ #ç™»å½•æœåŠ¡å™¨é€‰æ‹©èœå• # 2020-1-15 v1 # #ä¿®æ”¹æ—¶é—´ï¼š2020-xx-xx #ä¿®æ”¹å†…å®¹ï¼šä¿®æ”¹å†…å®¹æè¿° ############################################ trapper(){ trap \u0026#39;:\u0026#39; INT EXIT TSTP TERM HUP #\u0026lt;==å®šä¹‰éœ€è¦å±è”½çš„ä¿¡å·ï¼Œå†’å·è¡¨ç¤ºå•¥éƒ½ä¸åšã€‚ } main(){ while : do trapper clear cat\u0026lt;\u0026lt;menu 1.GIT-GC11-PROD 2.GIT-GC11-è¿ç»´ä¸»æœº 3.[exit] menu read -p\u0026#34;è¯·å‡ºå…¥å¯¹åº”çš„æ•°å­—:\u0026#34; a menu1 (){ cat\u0026lt;\u0026lt;EOF 1.MiniProgram 2.H-Link 3.SpeedBoat æŒ‰ä»»æ„é”®è¿”å›ä¸»èœå• EOF read -p\u0026#34;è¯·å‡ºå…¥å¯¹åº”çš„æ•°å­—:\u0026#34; num1 } menu2 (){ cat\u0026lt;\u0026lt;EOF 1.zabbix 2.jenkins 3.elk æŒ‰ä»»æ„é”®è¿”å›ä¸»èœå• EOF read -p\u0026#34;è¯·å‡ºå…¥å¯¹åº”çš„æ•°å­—:\u0026#34; num2 } #######################[ menu1 ]############################ [ $a -eq 1 ] \u0026amp;\u0026amp; { clear menu1 [ $num1 -eq 1 ] \u0026amp;\u0026amp; { echo \u0026#34;ä¼‘çœ 3ç§’\u0026#34; sleep 3 echo \u0026#34;è¿›å…¥å°ç¨‹åºæˆåŠŸ\u0026#34; menu1 } [ $num1 -eq 2 ] \u0026amp;\u0026amp; { echo \u0026#34;ä¼‘çœ 3ç§’\u0026#34; sleep 3 echo \u0026#34;è¿›å…¥H-linkæˆåŠŸ\u0026#34; menu1 } [ $num1 -eq 3 ] \u0026amp;\u0026amp; { echo \u0026#34;ä¼‘çœ 3ç§’\u0026#34; sleep 3 echo \u0026#34;è¿›å…¥SpeedBoatæˆåŠŸ\u0026#34; menu1 } } ####################[ menu2 ]######################################## [ $a -eq 2 ] \u0026amp;\u0026amp; { clear menu2 [ $num2 -eq 1 ] \u0026amp;\u0026amp; { echo \u0026#34;ä¼‘çœ 3ç§’\u0026#34; sleep 3 echo \u0026#34;è¿›å…¥zabbix æˆåŠŸ\u0026#34; menu2 } [ $num2 -eq 2 ] \u0026amp;\u0026amp; { echo \u0026#34;ssh jenkins\u0026#34; ssh -i /home/xue/key/CI-CD.pem ec2-user@xx.xx.xx.xx echo \u0026#34;ssh jenkins ok\u0026#34; menu2 } [ $num2 -eq 3 ] \u0026amp;\u0026amp; { echo \u0026#34;ä¼‘çœ 3ç§’\u0026#34; sleep 3 echo \u0026#34;è¿›å…¥elkæˆåŠŸ\u0026#34; menu2 } } [ $a -eq 3 ] \u0026amp;\u0026amp; { echo \u0026#34;é€€å‡ºæˆåŠŸ\u0026#34; exit } [ $a -eq 100 ] \u0026amp;\u0026amp; { read -p\u0026#34;åŒ¹é…æˆåŠŸï¼Œè¯·è¾“å…¥å£ä»¤:\u0026#34; mima if [ \u0026#34;$mima\u0026#34; = \u0026#34;5418\u0026#34;];then sudo -i sleep 3 fi } done } main ä½œè€…ï¼šSREè¿ç»´åšå®¢\nåšå®¢åœ°å€ï¼šhttps://www.cnsre.cn\næ–‡ç« åœ°å€ï¼šhttps://www.cnsre.cn/posts/210421130319/\nç›¸å…³è¯é¢˜ï¼šhttps://www.cnsre.cn/tags/shell/\n","description":"å¼€å‘ä¼ä¸šçº§Shellè·³æ¿æœºæ¡ˆä¾‹ã€‚è¦æ±‚ç”¨æˆ·ç™»å½•åˆ°è·³æ¿æœºä»…èƒ½æ‰§è¡Œç®¡ç†å‘˜ç»™å®šçš„é€‰é¡¹åŠ¨ä½œï¼Œä¸å…è®¸ä»¥ä»»ä½•å½¢å¼ä¸­æ–­è„šæœ¬åˆ°è·³æ¿æœºæœåŠ¡å™¨ä¸Šæ‰§è¡Œä»»ä½•ç³»ç»Ÿå‘½ä»¤ã€‚","id":71,"section":"posts","tags":["shell","è·³æ¿æœº"],"title":"Shell å¼€å‘è·³æ¿æœºåŠŸèƒ½è„šæœ¬","uri":"http://www.cnsre.cn:80/posts/210421130319/"},{"content":" ä½œè€…ï¼šSREè¿ç»´åšå®¢\nåšå®¢åœ°å€ï¼šhttps://www.cnsre.cn\næ–‡ç« åœ°å€ï¼šhttps://www.cnsre.cn/posts/210419172129/\nç›¸å…³è¯é¢˜ï¼šhttps://www.cnsre.cn/tags/docker/\nåœ¨å¦‚ä»Šçš„äº’è”ç½‘æ—¶ä»£ï¼Œéšç€è½¯ä»¶å¼€å‘å¤æ‚åº¦çš„ä¸æ–­æé«˜ï¼Œè½¯ä»¶å¼€å‘å’Œå‘å¸ƒç®¡ç†ä¹Ÿè¶Šæ¥è¶Šé‡è¦ã€‚ç›®å‰å·²ç»å½¢æˆä¸€å¥—æ ‡å‡†çš„æµç¨‹ï¼Œæœ€é‡è¦çš„ç»„æˆéƒ¨åˆ†å°±æ˜¯æŒç»­é›†æˆï¼ˆContinuous Integrationï¼ŒCIï¼‰åŠæŒç»­éƒ¨ç½²ã€äº¤ä»˜ï¼ˆCDï¼‰ã€‚åœ¨æ­¤ï¼Œæˆ‘ä»¬æ¥ä»¥ä¸€ä¸ªæ¡ˆä¾‹åˆæ­¥äº†è§£ CI æµç¨‹ã€‚é‚£ä¹ˆä»€ä¹ˆæ˜¯ CI å‘¢ï¼Ÿç®€å•æ¥è®²ï¼ŒCI å°±æ˜¯å°†ä¼ ç»Ÿçš„ä»£ç åˆå¹¶ã€æ„å»ºã€éƒ¨ç½²ã€æµ‹è¯•éƒ½é›†æˆåœ¨ä¸€èµ·ï¼Œä¸æ–­åœ°æ‰§è¡Œè¿™ä¸ªè¿‡ç¨‹ï¼Œå¹¶å¯¹ç»“æœè¿›è¡Œåé¦ˆã€‚\nCI æµç¨‹è®¾è®¡å›¾\nå·¥ä½œæµç¨‹ å¼€å‘äººå‘˜æäº¤ä»£ç åˆ°Gitç‰ˆæœ¬ä»“åº“ï¼› Jenkinsäººå·¥/å®šæ—¶è§¦å‘é¡¹ç›®æ„å»ºï¼› Jenkinsæ‹‰å–ä»£ç ã€ä»£ç ç¼–ç ã€æ‰“åŒ…é•œåƒã€æ¨é€åˆ°é•œåƒä»“åº“ï¼› Jenkinsåœ¨Dockerä¸»æœºåˆ›å»ºå®¹å™¨å¹¶å‘å¸ƒ\næœåŠ¡å™¨è§„åˆ’ IPåœ°å€ è§’è‰² 10.0.0.111 Jenkinsï¼ŒDockerï¼ŒJDKï¼ŒMaven 10.0.0.100 Harborï¼ˆDockerï¼Œdocker-composeï¼‰ï¼ŒGit éƒ¨ç½²Gitä»£ç ç‰ˆæœ¬ä»“åº“ 10.0.0.100 æ“ä½œ\n1 2 3 4 5 6 7 8 # yum install git -y # useradd git # passwd git # su â€“ git # mkdir wenlong.git # cd wenlong.git/ #åˆå§‹åŒ–ä»“åº“ # git --bare init 10.0.0.111 æ“ä½œ\n1 2 3 4 5 6 7 8 9 10 11 12 13 Jenkinsä¸»æœºæµ‹è¯•è®¿é—®è¯¥ä»“åº“ï¼š git clone git@10.0.0.100:/home/tools/git/wenlong.git æ­£å…‹éš†åˆ° \u0026#39;wenlong\u0026#39;... git@10.0.0.100\u0026#39;s password: \u0026#34;gitè´¦å·çš„å¯†ç \u0026#34; warning: æ‚¨ä¼¼ä¹å…‹éš†äº†ä¸€ä¸ªç©ºç‰ˆæœ¬åº“ã€‚ æ¨¡æ‹Ÿç”Ÿäº§é¡¹ç›®ï¼Œæ‹‰å–githubä¸Šçš„ä¸€ä¸ªdemoï¼Œå¹¶ä¸Šä¼ è‡³æœ¬åœ°gitåº“ # mv tomcat-java-demo-master/* wenlong/ # git add . éœ€è¦éªŒè¯ # git config --global user.email \u0026#34;xuewenlong@123.com\u0026#34; # git config --global user.name \u0026#34;xuewenlong\u0026#34; # git commit -m \u0026#34;all\u0026#34; # git push origin master éƒ¨Harboré•œåƒä»“åº“ 10.0.0.100 æ“ä½œ\nå‚è€ƒï¼šharborç§æœ‰ä»“åº“å®‰è£…\nJenkinsä¸»æœºå®‰è£…Dockerå¹¶é…ç½®å¯ä¿¡ä»»\n10.0.0.111 æ“ä½œ 1 2 3 4 5 6 7 8 # wget http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo -O /etc/yum.repos.d/docker-ce.repo # yum install docker-ce -y # cat /etc/docker/daemon.json {\u0026#34;registry-mirrors\u0026#34;: [\u0026#34;http://f1361db2.m.daocloud.io\u0026#34;], \u0026#34;insecure-registries\u0026#34;: [\u0026#34;192.168.31.63\u0026#34;] } # systemctl start docker # systemctl enable docker Jenkinsç¯å¢ƒéƒ¨ç½² 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 # tar zxvf jdk-8u45-linux-x64.tar.gz # mv jdk1.8.0_45 /usr/local/jdk # tar zxf apache-maven-3.5.0-bin.tar.gz # mv apache-maven-3.5.0 /usr/local/maven # vim /etc/profile JAVA_HOME=/usr/local/jdk PATH=$PATH:$JAVA_HOME/bin:/usr/local/maven/bin export JAVA_HOME PATH # source /etc/profile åœ¨10.0.0.111ä¸»æœºå®‰è£…Jenkinsï¼Œä¸‹è½½TomcatäºŒè¿›åˆ¶åŒ…å°†waråŒ…åˆ°webappsä¸‹å³å¯ï¼š # wget http://mirrors.jenkins.io/war-stable/latest/jenkins.war # wget http://mirrors.shu.edu.cn/apache/tomcat/tomcat-8/v8.5.38/bin/apache-tomcat-8.5.38.tar.gz # tar zxf apache-tomcat-8.5.38.tar.gz # mv apache-tomcat-8.5.38 /usr/local/tomcat-jenkins # rm -rf /usr/local/tomcat-jenkins/webapps/* # mv jenkins.war /usr/local/tomcat-jenkins/webapps/ROOT.war # cd /usr/local/tomcat-jenkins/bin/ # ./startup.sh å¯åŠ¨åï¼Œæµè§ˆå™¨è®¿é—®http://10.0.0.111:8080/ï¼ŒæŒ‰æç¤ºè¾“å…¥å¯†ç ï¼Œç™»å½•å³å¯\nJenkinså®‰è£…å¿…è¦æ’ä»¶ ç”±äºjenkinsæ˜¯ç¦»çº¿å®‰è£…ï¼Œæ‰€æœ‰åœ¨æ­¤éœ€è¦é…ç½®ä¸€ä¸‹æ’ä»¶ä¸‹è½½åœ°å€ï¼šç³»ç»Ÿç®¡ç†\u0026ndash;\u0026gt;æ’ä»¶ç®¡ç†\u0026ndash;\u0026gt;Advanced\nä¿®æ”¹å†…å®¹ 1 2 3 jenkinsæ’ä»¶æ¸…åå¤§å­¦é•œåƒåœ°å€ https://mirrors.tuna.tsinghua.edu.cn/jenkins/updates/update-center.json http://mirror.xmission.com/jenkins/updates/update-center.json å°†httpsä¿®æ”¹ä¸ºhttp å†ç‚¹Submit\nSubmitåç‚¹å‡»Availableï¼ŒCheck nowæ­¤æ—¶æˆ‘ä»¬å¯ä»¥çœ‹åˆ°å¾ˆå¤šå¯è·å¾—æ’ä»¶\nå®‰è£…gitå’Œpipelineæ’ä»¶ã€‚\nJenkinsæµæ°´çº¿éƒ¨ç½² pipeline æ˜¯ä¸€å¥—è¿è¡Œäºjenkinsä¸Šçš„å·¥ä½œæµæ¡†æ¶ï¼Œå°†åŸæœ¬ç‹¬ç«‹è¿è¡Œäºå•ä¸ªæˆ–è€…å¤šä¸ªèŠ‚ç‚¹çš„ä»»åŠ¡è¿æ¥èµ·æ¥ï¼Œå®ç°å•ä¸ªä»»åŠ¡éš¾ä»¥å®Œæˆçš„å¤æ‚æµç¨‹ç¼–æ’ä¸å¯è§†åŒ–ã€‚\nåˆ›å»ºä¸€ä¸ªpipelineç±»å‹çš„Jobï¼š\né€‰æ‹©æµæ°´çº¿ç±»å‹\nåˆ°è¿™é‡Œæˆ‘ä»¬å°±å¼€å§‹é…ç½®Pipeline scriptï¼Œç‚¹å‡»Pipelineè¯­æ³•ï¼Œæ¥è‡ªåŠ¨ç”Ÿæˆæˆ‘ä»¬éœ€è¦çš„é…ç½®ã€‚\nå¦‚ä¸‹å›¾ï¼Œæˆ‘ä»¬Gitæ–¹å¼ï¼Œé…ç½®Gitä»“åº“åœ°å€ï¼Œå†æ·»åŠ è®¤è¯ç›¸å…³ã€‚\nè¿™é‡Œæˆ‘ä»¬ä½¿ç”¨çš„æ˜¯ç§˜é’¥è®¤è¯æ–¹å¼ï¼Œéœ€è¦å°†jenkinsä¸Šç”Ÿæˆçš„å…¬é’¥å‘é€åˆ°gitæœåŠ¡å™¨ä¸Šï¼Œç„¶åå°†jenkinsä¸Šçš„ç”Ÿæˆçš„ç§é’¥å†…å®¹ç²˜è´´åˆ°ä¸‹å›¾Keyä¸­ï¼Œè¿™æ ·jenkinså°±å¯ä»¥å…äº¤äº’çš„æ‹‰å–gitä»“åº“ä¸­çš„ä»£ç äº†ã€‚\n1 2 3 4 5 [root@docker-jenkins bin]# ssh-keygen [root@docker-jenkins bin]# cd [root@docker-jenkins ~]# ls .ssh/ id_rsa id_rsa.pub known_hosts [root@docker-jenkins ~]# ssh-copy-id git@10.0.0.100 é…ç½®å®Œæˆåï¼Œæˆ‘ä»¬å°±å¯ä»¥ç”ŸæˆPipelineè„šæœ¬äº†ã€‚ç‚¹å‡»ä¸‹æ–¹Generate Pipeline Scriptï¼Œç„¶åå¤åˆ¶æ–¹æ¡†å†…çš„å†…å®¹ã€‚\nç¼–å†™æˆ‘ä»¬æ‰€éœ€è¦çš„Pipelineè„šæœ¬å¦‚ä¸‹ï¼Œå°†å…¶ç²˜è´´åˆ°scriptçš„æ‹‰å–ä»£ç æ¨¡å—ä¸­ï¼Œå¹¶ä¿®æ”¹åˆ†æ”¯masterä¸º${branch}ï¼Œå…¶ä»–æ¨¡å—å†…å®¹è‡ªè¡Œç¼–å†™ã€‚\nnode { def mvnHome stage(\u0026#39;Preparation\u0026#39;) { // for display purposes //æ‹‰å–ä»£ç  checkout([$class: \u0026#39;GitSCM\u0026#39;, branches: [[name: \u0026#39;*/master\u0026#39;]], doGenerateSubmoduleConfigurations: false, extensions: [], submoduleCfg: [], userRemoteConfigs: [[credentialsId: \u0026#39;7c00a680-53fd-42db-a12a-21b803dd6c40\u0026#39;, url: \u0026#39;git@10.0.0.100:/home/tools/git/wenlong.git\u0026#39;]]]) } //ç¼–è¯‘ä»£ç  stage(\u0026#39;Build\u0026#39;) { sh \u0026#39;\u0026#39;\u0026#39; export JAVA_HOME=/home/tools/jdk1.8.0_221 mvn clean package -Dmaven.test.skip=true \u0026#39;\u0026#39;\u0026#39; } // é¡¹ç›®æ‰“åŒ…åˆ°é•œåƒå¹¶æ¨é€åˆ°é•œåƒä»“åº“ stage(\u0026#39;Build and Push Image\u0026#39;) { sh \u0026#39;\u0026#39;\u0026#39; REPOSITORY=10.0.0.100/library/wenlong:${branch} cat \u0026gt; Dockerfile \u0026lt;\u0026lt; EOF FROM 10.0.0.100/library/tomcat:v1 LABEL maintainer wenlong RUN rm -rf /usr/local/tomcat/webapps/* ADD target/*.war /usr/local/tomcat/webapps/ROOT.war EOF docker build -t $REPOSITORY . docker login 10.0.0.100 -u admin -p Harbor12345 docker push $REPOSITORY \u0026#39;\u0026#39;\u0026#39; } // éƒ¨ç½²åˆ°Dockerä¸»æœº stage(\u0026#39;Deploy to Docker\u0026#39;) { sh \u0026#39;\u0026#39;\u0026#39; REPOSITORY=10.0.0.100/library/wenlong:${branch} docker rm -f tomcat-java-demo |true docker pull $REPOSITORY docker container run -d --name wenlong -p 88:8080 $REPOSITORY \u0026#39;\u0026#39;\u0026#39; } } åœ¨Pipelineè„šæœ¬é‡Œé¢æˆ‘ä»¬æŒ‡å®šäº†ä¸€ä¸ªbranchå‚æ•°ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦ä¼ é€’ä¸€ä¸ªå‚æ•°å˜é‡ï¼Œè¿™é‡Œæˆ‘ä»¬é€‰æ‹©å‚æ•°åŒ–æ„å»ºï¼Œé»˜è®¤å€¼ä¸ºmasteråˆ†æ”¯ã€‚\nç„¶åä¿å­˜é…ç½®ã€‚\nå‘å¸ƒæµ‹è¯• å›åˆ°ä¸»ç•Œé¢ï¼Œæˆ‘ä»¬å¼€å§‹æ„å»ºä»»åŠ¡ï¼š\næŸ¥çœ‹æ„å»ºæˆåŠŸåçš„å›¾å½¢æ„å»ºè¿‡ç¨‹ï¼š\né€šè¿‡æµè§ˆå™¨æ¥è®¿é—®javaé¡¹ç›®ï¼šhttp://10.0.0.111:88/\nè‡³æ­¤éƒ¨ç½²å®Œæˆ\nä½œè€…ï¼šSREè¿ç»´åšå®¢\nåšå®¢åœ°å€ï¼šhttps://www.cnsre.cn\næ–‡ç« åœ°å€ï¼šhttps://www.cnsre.cn/posts/210419172129/\nç›¸å…³è¯é¢˜ï¼šhttps://www.cnsre.cn/tags/docker/\n","description":"åŸºäºDockeræ„å»ºä¼ä¸šJenkinsCICDè‡ªåŠ¨å‘å¸ƒ","id":72,"section":"posts","tags":["jenkins","docker"],"title":"ä½¿ç”¨Dockeræ„å»ºJenkinsCICDè‡ªåŠ¨å‘å¸ƒ","uri":"http://www.cnsre.cn:80/posts/210419172129/"},{"content":" ä½œè€…ï¼šSREè¿ç»´åšå®¢\nåšå®¢åœ°å€ï¼šhttps://www.cnsre.cn\næ–‡ç« åœ°å€ï¼šhttps://www.cnsre.cn/posts/210419130919/\nç›¸å…³è¯é¢˜ï¼šhttps://www.cnsre.cn/tags/shell/\nä¸€ã€æœåŠ¡å™¨è¢«å…¥ä¾µçš„å‰å¤• ä½•æ—¶è¢«å…¥ä¾µçš„ï¼Ÿ å…¥ä¾µè€…ä½¿ç”¨å“ªä¸ªè´¦å·ç™»å½•çš„ï¼Ÿ å…¥ä¾µè€…èº«åœ¨ä½•å¤„ï¼Ÿ å…¥ä¾µè€…åšè¿‡ä»€ä¹ˆæ“ä½œï¼Ÿ å¦‚ä½•é¿å…æœåŠ¡å™¨ä¸­æ¯’ï¼Œè¢«å…¥ä¾µ\u0026quot; æ‰€è°“çŸ¥å·±çŸ¥å½¼ï¼Œæ–¹èƒ½ç™¾æˆ˜ä¸æ®† äºŒã€å‰–æé—®é¢˜å¹¶è§£å†³ é’ˆå¯¹ä¸Šé¢ å‰3ä¸ªé—®é¢˜ï¼Œå¼€å‘äº†ä¸€ä¸ªä¼ä¸šå¾®ä¿¡äºŒæ¬¡éªŒè¯ç çš„å®‰å…¨åŠŸèƒ½ï¼Œè¯¦ç»†å†…å®¹å¦‚ä¸‹ï¼š\n1ã€ä¼ä¸šå¾®ä¿¡é…ç½® 1.1 è·å–AgentIdï¼ˆAppIDï¼‰ã€Secret åˆ›å»ºä¸€ä¸ªä¼ä¸šå¾®ä¿¡åº”ç”¨\n1.2 è·å– CropID ç‚¹å‡»æˆ‘çš„ä¼ä¸š\u0026ndash;ä¼ä¸šä¿¡æ¯\n2ã€ç›‘æ§ç”¨æˆ·ç™»å½•ï¼Œå‘é€é€šçŸ¥ç»™å¾®ä¿¡ æ”¾åˆ°/etc/profile.d/ ç™»å½•è‡ªåŠ¨è§¦å‘\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 #!/bin/bash #WeiXin ENV------------------------------------------------------------------------------------- CropID=\u0026#39;ww022bebbed74xxxx\u0026#39; Secret=\u0026#39;RauJ_-t-LxBhfEN7g1sh4OhVB_vREBWvqeFaaxxxxx\u0026#39; APIURL=\u0026#34;https://qyapi.weixin.qq.com/cgi-bin/gettoken?corpid=$CropID\u0026amp;corpsecret=$Secret\u0026#34; TOKEN=$(/usr/bin/curl -s -G $APIURL | awk -F\\\u0026#34; \u0026#39;{print $10}\u0026#39;) POSTURL=\u0026#34;https://qyapi.weixin.qq.com/cgi-bin/message/send?access_token=$TOKEN\u0026#34; ##WeiXin body-------------------------------------------------------------------------------------- function body() { local int AppID=1000004 local UserID=xuewenlong local PartyID=2 printf \u0026#39;{\\n\u0026#39; printf \u0026#39;\\t\u0026#34;touser\u0026#34;: \u0026#34;\u0026#39;\u0026#34;$UserID\u0026#34;\\\u0026#34;\u0026#34;,\\n\u0026#34; printf \u0026#39;\\t\u0026#34;toparty\u0026#34;: \u0026#34;\u0026#39;\u0026#34;$PartyID\u0026#34;\\\u0026#34;\u0026#34;,\\n\u0026#34; printf \u0026#39;\\t\u0026#34;msgtype\u0026#34;: \u0026#34;text\u0026#34;,\\n\u0026#39; printf \u0026#39;\\t\u0026#34;agentid\u0026#34;: \u0026#34;\u0026#39;\u0026#34;$AppID\u0026#34;\\\u0026#34;\u0026#34;,\\n\u0026#34; printf \u0026#39;\\t\u0026#34;text\u0026#34;: {\\n\u0026#39; printf \u0026#39;\\t\\t\u0026#34;content\u0026#34;: \u0026#34;\u0026#39;\u0026#34;$Msg\u0026#34;\\\u0026#34;\u0026#34;\\n\u0026#34; printf \u0026#39;\\t},\\n\u0026#39; printf \u0026#39;\\t\u0026#34;safe\u0026#34;:\u0026#34;0\u0026#34;\\n\u0026#39; printf \u0026#39;}\\n\u0026#39; } Status=`who am i | awk \u0026#39;{print $NF}\u0026#39; | sed \u0026#39;s/(//g\u0026#39; | sed \u0026#39;s/)//g\u0026#39;` if [ -n \u0026#34;$Status\u0026#34; ]; then Msg=\u0026#34;æœ‰ç”¨æˆ·ä¸Šçº¿è¯·æ³¨æ„:\\nä¸»æœºåï¼š`hostname`\\nä¸»æœºipï¼š`ifconfig ens33 | grep \u0026#34;inet\u0026#34; | awk \u0026#39;NR==1{ print $2}\u0026#39;`\\nç™»å½•ç”¨æˆ·ï¼š`whoami`\\nåœ°å€æ¥æºï¼š\u0026#34;$Status\u0026#34;\u0026#34; /usr/bin/curl -s --data-ascii \u0026#34;$(body guozhiheng0123 $2)\u0026#34; $POSTURL 2\u0026gt;\u0026amp;1 \u0026gt; /dev/null fi 3ã€ç™»å½•ç”¨æˆ·éœ€è¦äºŒæ¬¡éªŒè¯ç  éªŒè¯ read è¯»å…¥\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 #!/bin/bash ############################################ #é€šè¿‡å¾®ä¿¡å‘é€éªŒè¯ç  #cnsre 2020-4-26 V1 # #ä¿®æ”¹è€…ï¼šxxx #ä¿®æ”¹æ—¶é—´ï¼š2020-xx-xx #ä¿®æ”¹å†…å®¹ï¼šä¿®æ”¹å†…å®¹æè¿° ############################################ ##WeiXin ENV------------------------------------------------------------------------------------- CropID=\u0026#39;ww022bebbed749xxxx\u0026#39; Secret=\u0026#39;RauJ_-t-LxBhfEN7g1sh4OhVB_vREBWvqeFaaxxxxx\u0026#39; APIURL=\u0026#34;https://qyapi.weixin.qq.com/cgi-bin/gettoken?corpid=$CropID\u0026amp;corpsecret=$Secret\u0026#34; TOKEN=$(/usr/bin/curl -s -G $APIURL | awk -F\\\u0026#34; \u0026#39;{print $10}\u0026#39;) POSTURL=\u0026#34;https://qyapi.weixin.qq.com/cgi-bin/message/send?access_token=$TOKEN\u0026#34; ##WeiXin body-------------------------------------------------------------------------------------- function body() { local int AppID=1000004 local UserID=xuewenlong local PartyID=2 printf \u0026#39;{\\n\u0026#39; printf \u0026#39;\\t\u0026#34;touser\u0026#34;: \u0026#34;\u0026#39;\u0026#34;$UserID\u0026#34;\\\u0026#34;\u0026#34;,\\n\u0026#34; printf \u0026#39;\\t\u0026#34;toparty\u0026#34;: \u0026#34;\u0026#39;\u0026#34;$PartyID\u0026#34;\\\u0026#34;\u0026#34;,\\n\u0026#34; printf \u0026#39;\\t\u0026#34;msgtype\u0026#34;: \u0026#34;text\u0026#34;,\\n\u0026#39; printf \u0026#39;\\t\u0026#34;agentid\u0026#34;: \u0026#34;\u0026#39;\u0026#34;$AppID\u0026#34;\\\u0026#34;\u0026#34;,\\n\u0026#34; printf \u0026#39;\\t\u0026#34;text\u0026#34;: {\\n\u0026#39; printf \u0026#39;\\t\\t\u0026#34;content\u0026#34;: \u0026#34;\u0026#39;\u0026#34;$Msg\u0026#34;\\\u0026#34;\u0026#34;\\n\u0026#34; printf \u0026#39;\\t},\\n\u0026#39; printf \u0026#39;\\t\u0026#34;safe\u0026#34;:\u0026#34;0\u0026#34;\\n\u0026#39; printf \u0026#39;}\\n\u0026#39; } Status=`who am i | awk \u0026#39;{print $NF}\u0026#39; | sed \u0026#39;s/(//g\u0026#39; | sed \u0026#39;s/)//g\u0026#39;` if [ -n \u0026#34;$Status\u0026#34; ]; then RANDOM=$(date +%s) echo $RANDOM \u0026gt;/tmp/pass.txt PASS=`tail -n 1 /tmp/pass.txt` Msg=\u0026#34;ä½ çš„éªŒè¯ç æ˜¯ï¼š\u0026#34;$PASS\u0026#34;\u0026#34; /usr/bin/curl --data-ascii \u0026#34;$(body xuewenlong $2)\u0026#34; $POSTURL \u0026gt; /dev/null 2\u0026gt;\u0026amp;1 trap \u0026#34;\u0026#34; 2 read -p \u0026#34;è¯·è¾“å…¥éªŒè¯ç :\u0026#34; A if [ \u0026#34;$A\u0026#34; != \u0026#34;xuewenlong\u0026#34; ] \u0026amp;\u0026amp; [ \u0026#34;$A\u0026#34; != \u0026#34;$PASS\u0026#34; ]; then echo \u0026#34;Verification Code Fail, Now Exit!!!\u0026#34; sleep 1 logout else echo \u0026#34; Welcome to BSH-GC11 System \u0026#34; fi fi ä¸‰ã€å…¥ä¾µè€…åšè¿‡ä»€ä¹ˆæ“ä½œ ä¸€èˆ¬é€šè¿‡å‡ ç§æ‰‹æ®µå»åšï¼š\nå…¨ç«™md5æŒ‡çº¹è¯†åˆ«ï¼Œç¡®è®¤å“ªäº›æ–‡ä»¶è¢«ä¿®æ”¹è¿‡ jumpserver è§†é¢‘å½•åƒ æ™®é€šç”¨æˆ·sudoæ“ä½œæ—¥å¿— ç³»ç»Ÿæ—¥å¿—\n1ã€é’‰é’‰é…ç½® é’‰é’‰çš„é…ç½®ä¸å¾®ä¿¡å¤§è‡´ç›¸åŒï¼Œå…·ä½“ä¸åœ¨è¯´æ˜ï¼Œä¸‹é¢ç›´æ¥å±•ç¤ºè„šæœ¬\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 DDcode.sh #!/bin/bash ############################### # 2020-4-26 # # by wenlong # # é€šè¿‡é’‰é’‰æ¥å£å‘é€éªŒè¯ç äºŒæ¬¡éªŒè¯ # ############################### trap \u0026#34;\u0026#34; 1 read -p \u0026#34;è¯·è¾“å…¥ä½ çš„é’‰é’‰æ‰‹æœºå·:\u0026#34; user if [ ${#user} -ne 11 ]; then echo \u0026#34;è¯·å‡ºå…¥æœ‰æ•ˆæ‰‹æœºå·ç \u0026#34; sleep 1 logout fi ##dingding ENV------------------------------------------------------------------------------------- Dingding_Url=\u0026#34;https://oapi.dingtalk.com/robot/send?access_token=732b97ff63d6bce620025c3eb973ca39c668847260e7d2c9f0b43cf780be0c83\u0026#34; Status=`who am i | awk \u0026#39;{print $NF}\u0026#39; | sed \u0026#39;s/(//g\u0026#39; | sed \u0026#39;s/)//g\u0026#39;` if [ -n \u0026#34;$Status\u0026#34; ]; then RANDOM=$(date +%s) echo $RANDOM \u0026gt;/tmp/pass.txt PASS=`tail -n 1 /tmp/pass.txt` Msg=\u0026#34;ä½ çš„éªŒè¯ç æ˜¯ï¼š\u0026#34;$PASS\u0026#34;\u0026#34; curl \u0026#34;${Dingding_Url}\u0026#34; -H \u0026#39;Content-Type: application/json\u0026#39; -d \u0026#34; { \u0026#39;msgtype\u0026#39;: \u0026#39;text\u0026#39;, \u0026#39;text\u0026#39;: {\u0026#39;content\u0026#39;: \u0026#39;${Msg}\\n\u0026#39;}, \u0026#39;at\u0026#39;: {\u0026#39;atMobiles\u0026#39;: [ \u0026#39;${user}\u0026#39; ], \u0026#39;isAtAll\u0026#39;: false} }\u0026#34; \u0026gt; /dev/null 2\u0026gt;\u0026amp;1 trap \u0026#34;\u0026#34; 2 read -p \u0026#34;è¯·è¾“å…¥éªŒè¯ç :\u0026#34; code if [ \u0026#34;$code\u0026#34; != \u0026#34;xuewenlong\u0026#34; ] \u0026amp;\u0026amp; [ \u0026#34;$code\u0026#34; != \u0026#34;$PASS\u0026#34; ]; then echo \u0026#34;éªŒè¯ç éªŒè¯å¤±è´¥!!!\u0026#34; sleep 1 logout else echo \u0026#34; Welcome to shvm01 System \u0026#34; fi fi 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 login.sh #!/bin/bash ############################### # 2020-4-26 # # by wenlong # # é€šè¿‡é’‰é’‰æ¥å£å‘é€ç”¨æˆ·ç™»å½•ä¿¡æ¯ # ############################### Dingding_Url=\u0026#34;https://oapi.dingtalk.com/robot/send?access_token=732b97ff63d6bce620025c3eb973ca39c668847260e7d2c9f0b43cf780be0c83\u0026#34; Status=`who am i | awk \u0026#39;{print $NF}\u0026#39; | sed \u0026#39;s/(//g\u0026#39; | sed \u0026#39;s/)//g\u0026#39;` if [ -n \u0026#34;$Status\u0026#34; ]; then Msg=\u0026#34;æœ‰ç”¨æˆ·ä¸Šçº¿è¯·æ³¨æ„:\\nä¸»æœºåï¼š`hostname`\\nä¸»æœºipï¼š`ifconfig eth0 | grep \u0026#34;inet\u0026#34; | awk \u0026#39;NR==1{ print $2}\u0026#39;`\\nç™»å½•ç”¨æˆ·ï¼š`whoami`\\nåœ°å€æ¥æºï¼š\u0026#34;$Status\u0026#34;\u0026#34; curl \u0026#34;${Dingding_Url}\u0026#34; -H \u0026#39;Content-Type: application/json\u0026#39; -d \u0026#34; { \u0026#39;msgtype\u0026#39;: \u0026#39;text\u0026#39;, \u0026#39;text\u0026#39;: {\u0026#39;content\u0026#39;: \u0026#39;${Msg}\\n\u0026#39;}, \u0026#39;at\u0026#39;: {\u0026#39;atMobiles\u0026#39;: [\u0026#39;${user}\u0026#39; ], \u0026#39;isAtAll\u0026#39;: false} }\u0026#34; \u0026gt; /dev/null 2\u0026gt;\u0026amp;1 fi ä½œè€…ï¼šSREè¿ç»´åšå®¢\nåšå®¢åœ°å€ï¼šhttps://www.cnsre.cn\næ–‡ç« åœ°å€ï¼šhttps://www.cnsre.cn/posts/210419130919/\nç›¸å…³è¯é¢˜ï¼šhttps://www.cnsre.cn/tags/shell/\n","description":"å¦‚æœæ‚¨çš„æœåŠ¡å™¨è¢«é»‘å®¢å…¥ä¾µï¼Œå¾ˆæœ‰å¯èƒ½è·å–åˆ°æ‚¨çš„ç”¨æˆ·åå¯†ç ï¼Œç›´æ¥ç™»å½•æœåŠ¡å™¨è¿›è¡Œä¾µç•¥ï¼Œæˆ–è€…æç ´åï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦é˜²æŠ¤ï¼Œä½†å¦‚ä½•é˜²æŠ¤å‘¢ï¼Œè¢«é»‘äº†ä½ åˆæƒ³çŸ¥é“ä»€ä¹ˆå‘¢ï¼Ÿï¼Ÿ","id":73,"section":"posts","tags":["shell"],"title":"å¾®ä¿¡ã€é’‰é’‰éªŒè¯ç™»å½•æœåŠ¡å™¨","uri":"http://www.cnsre.cn:80/posts/210419130919/"},{"content":" ä½œè€…ï¼šSREè¿ç»´åšå®¢\nåšå®¢åœ°å€ï¼šhttps://www.cnsre.cn\næ–‡ç« åœ°å€ï¼šhttps://www.cnsre.cn/posts/210414131058/\nç›¸å…³è¯é¢˜ï¼šhttps://www.cnsre.cn/tags/æ•…éšœé›†/\næ•…éšœæè¿° åœ¨æˆ‘ä»¬çš„ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œæˆ‘ä»¬åˆ¶ä½œäº†ä¸€ä¸ªå¥åº·æ£€æŸ¥é¡µé¢ï¼Œå¹¶é€šè¿‡è„šæœ¬å»ç›‘æ§ä»–çš„å¥åº·çŠ¶æ€ï¼Œå¯æ˜¯åœ¨å‰å¤©ï¼ˆ2020-5-30 å‘¨å…­ï¼‰ä¸‹åˆ 18:50 å·¦å³çš„æ—¶å€™æ”¶åˆ°å‘Šè­¦å¥åº·æ£€æŸ¥é¡µé¢æ•…éšœï¼Œç­‰æˆ‘ç™»å½•æœåŠ¡å™¨æ’æŸ¥æ•…éšœçš„æ—¶å€™å‘ç°æ˜¯curlå‘½ä»¤æŠ¥é”™ï¼ŒæŠ¥é”™çš„å†…å®¹ä¸ºï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 [root@ip-10-0-10-100 ~]# curl -v https://xxxxxx.cn/hcaextension/hcmini/v1/healthyCheck * Trying 54.223.xxx.xx... * TCP_NODELAY set * Connected to xxxxxxxx.cn (54.223.xx.xx) port 443 (#0) * ALPN, offering h2 * ALPN, offering http/1.1 * Cipher selection: ALL:!EXPORT:!EXPORT40:!EXPORT56:!aNULL:!LOW:!RC4:@STRENGTH * successfully set certificate verify locations: * CAfile: /etc/pki/tls/certs/ca-bundle.crt CApath: none * TLSv1.2 (OUT), TLS header, Certificate Status (22): * TLSv1.2 (OUT), TLS handshake, Client hello (1): * TLSv1.2 (IN), TLS handshake, Server hello (2): * TLSv1.2 (IN), TLS handshake, Certificate (11): * TLSv1.2 (OUT), TLS alert, certificate expired (557): * SSL certificate problem: certificate has expired * Closing connection 0 curl: (60) SSL certificate problem: certificate has expired More details here: https://curl.haxx.se/docs/sslcerts.html curl failed to verify the legitimacy of the server and therefore could not establish a secure connection to it. To learn more about this situation and how to fix it, please visit the web page mentioned above. åœ¨é€šè¿‡æˆ‘ä»Šå¤©ä¸Šåˆçš„æµ‹è¯•ï¼Œæˆ‘å‘ç°AWS EC2ä¸ºï¼šLinux ã€Linux2 çš„æ“ä½œç³»ç»Ÿä¸èƒ½å¤Ÿæ­£å¸¸ä½¿ç”¨ï¼Œåœ¨AWS EC2 -Centos 7.7ã€é˜¿é‡Œäº‘ä»¥åŠç‰©ç†æœºæˆ¿ä¸­æµ‹è¯•æ˜¯æ²¡æœ‰é—®é¢˜çš„ã€‚\nåˆ†æè¿‡ç¨‹ ç»è¿‡æŸ¥çœ‹æŠ¥é”™ä¿¡æ¯ï¼Œå‘ç°æ˜¯ç”±äºSSLæ¡æ‰‹çš„æ—¶å€™è¯ä¹¦éªŒè¯é”™è¯¯å¯¼è‡´çš„ï¼Œä»¥ä¸‹æ˜¯æ’æŸ¥çš„æ­¥éª¤ï¼š\nCurl çš„-kå‚æ•°å¯ä»¥å¿½ç•¥SLLè¯ä¹¦çš„éªŒè¯ï¼Œæ‚¨å¯ä»¥æ·»åŠ -kå‚æ•°ä¸´æ—¶é¿å…é‡åˆ°æ­¤é”™è¯¯ï¼Œå¦‚ä¸‹æ˜¯æˆ‘çš„æµ‹è¯•ï¼Œå‘ç°å¯ä»¥æ­£å¸¸çš„è®¿é—®é¡µé¢ï¼š 1 2 curl -k https://xxxxxx.cn/hcaextension/hcmini/v1/healthyCheck {\u0026#34;code\u0026#34;:0,\u0026#34;msg\u0026#34;:\u0026#34;æˆåŠŸ\u0026#34;,\u0026#34;messageid\u0026#34;:\u0026#34;29250cf5-176b-4993-a724-e5c9d7cc2ace\u0026#34;} é€šè¿‡è¿›ä¸€æ­¥åˆ†æè¯ä¹¦â€œxxxxx.cnâ€ï¼Œæˆ‘ä»¬å‘ç°è¯ä¹¦é“¾æ˜¯å­˜åœ¨é—®é¢˜çš„ï¼Œæˆ‘ä»¬çš„è¯ä¹¦è‡ªèº«å¹¶æ²¡æœ‰è¿‡æœŸï¼Œä½†æ˜¯ä¸€ä¸ªè¯ä¹¦é“¾è¯ä¹¦è¿‡æœŸäº†ï¼Œæˆ‘ä»¬æå–äº†è¯ä¹¦é“¾çš„ä¿¡æ¯ï¼Œæ‚¨å¯ä»¥å‚è€ƒé™„ä»¶çš„ä¿¡æ¯ã€‚\næ£€æµ‹åœ°å€\nè§£å†³æ–¹æ³• æ›´æ–°è¯ä¹¦é“¾ï¼Œå°†è¿‡æœŸçš„è¯ä¹¦é“¾ä¿¡æ¯å»é™¤ï¼Œå°è¯•æ˜¯å¦å¯ä»¥æ­£å¸¸è®¿é—®ï¼š\nhttps://docs.amazonaws.cn/IAM/latest/UserGuide/id_credentials_server-certs.html\nä½œè€…ï¼šSREè¿ç»´åšå®¢\nåšå®¢åœ°å€ï¼šhttps://www.cnsre.cn\næ–‡ç« åœ°å€ï¼šhttps://www.cnsre.cn/posts/210414131058/\nç›¸å…³è¯é¢˜ï¼šhttps://www.cnsre.cn/tags/æ•…éšœé›†/\n","description":"ç”Ÿäº§ç¯å¢ƒè¯ä¹¦é“¾è¯ä¹¦è¿‡æœŸé—®é¢˜","id":74,"section":"posts","tags":["sslè¯ä¹¦","æ•…éšœé›†"],"title":"è¯ä¹¦é“¾è¯ä¹¦è¿‡æœŸé—®é¢˜","uri":"http://www.cnsre.cn:80/posts/210414131058/"},{"content":" ä½œè€…ï¼šSREè¿ç»´åšå®¢\nåšå®¢åœ°å€ï¼šhttps://www.cnsre.cn\næ–‡ç« åœ°å€ï¼šhttps://www.cnsre.cn/posts/210413131020/\nç›¸å…³è¯é¢˜ï¼šhttps://www.cnsre.cn/tags/æ•…éšœé›†/\né—®é¢˜æè¿° 2020å¹´7æœˆ13æ—¥ä¸€å¤§æ—©æ”¶åˆ°å‘Šè­¦ï¼Œæµ‹è¯•ç¯å¢ƒæ•°æ®åº“CPUå‘Šè­¦ã€‚\nç™»å½•awsæŸ¥çœ‹ç›‘æ§å¦‚ä¸‹å›¾ é—®é¢˜åˆ†æ å‡ºç°è¿™ç§cpu 100%çš„é—®é¢˜ï¼Œä¸€èˆ¬éƒ½æ˜¯å› ä¸ºsqlæ€§èƒ½é—®é¢˜å¯¼è‡´çš„ã€‚\nä¸»è¦è¡¨ç°äº cpuæ¶ˆè€—è¿‡å¤§ï¼Œæœ‰æ…¢sqlé€ æˆã€æ…¢sqlå…¨è¡¨æ‰«æï¼Œæ‰«ææ•°æ®åº“è¿‡å¤§ï¼Œå†…å­˜æ’åºï¼Œé˜Ÿåˆ—ç­‰ç­‰\nå¹¶å‘ç°å†™å…¥ç›¸å¯¹äºæŸ¥è¯¢æ¥è¯´æ¯”è¾ƒé«˜ï¼ˆè¿™æ˜¯ä¸€ä¸ªå…³é”®ç‚¹ï¼‰\næœ‰äº†å¤§æ¦‚çš„æ€è·¯ä¸‹è¾¹å¼€å§‹æ’æŸ¥å§\næŸ¥çœ‹è¿›ç¨‹ show full processlist; å‘ç°æœ‰å¤§é‡çš„è¯­å¥çŠ¶æ€ä¸º sending data sending data: sqlæ­£ä»è¡¨ä¸­æŸ¥è¯¢æ•°æ®ï¼Œå¦‚æœæŸ¥è¯¢æ¡ä»¶æ²¡æœ‰é€‚å½“ç´¢å¼•ï¼Œä¼šå¯¼è‡´sqlæ‰§è¡Œæ—¶é—´è¿‡é•¿ã€‚\næŸ¥çœ‹æ…¢æ—¥å¿—é…ç½® mysql\u0026gt; show variables like \u0026#39;slow_query%\u0026#39;; +---------------------+----------------------------------------------+ | Variable_name | Value | +---------------------+----------------------------------------------+ | slow_query_log | ON | | slow_query_log_file | /rdsdbdata/log/slowquery/mysql-slowquery.log | +---------------------+----------------------------------------------+ 2 rows in set mysql\u0026gt; show variables like \u0026#39;slow_launch_time\u0026#39;; +------------------+-------+ | Variable_name | Value | +------------------+-------+ | slow_launch_time | 1 | +------------------+-------+ 1 row in set çœ‹åˆ°æ…¢æ—¥å¿—å·²ç»å¼€å¯\nç™»å½•aws cloudwatchæŸ¥çœ‹æ…¢æ—¥å¿—å‘ç°å¤§éƒ¨åˆ†ä¸ºè¿™æ¡sql\n# User@Host: admin[admin] @ [10.0.11.12] Id: 2302 # Query_time: 3.602910 Lock_time: 0.100585 Rows_sent: 2 Rows_examined: 4454 SET timestamp=1594629311; SELECT a.enum_value,a.enum_value FROM external_mapping a LEFT JOIN external_command_key b ON a.command_id=b.id LEFT JOIN external_command_options c ON a.options_id=c.id LEFT JOIN external_command_key d ON a.command_id=d.id LEFT JOIN category h ON a.category_id=h.id where 1=1 AND b.code=\u0026#39;Common.Status.Event\u0026#39; AND c.code=\u0026#39;Common.Setting.Rm4Valve\u0026#39; AND d.code=\u0026#39;Rm4_Valve\u0026#39; AND a.platform_id=119 AND h.cname = \u0026#39;TT\u0026#39;; æŸ¥çœ‹æ˜¯å¦æœ‰é”è¡¨ mysql\u0026gt; show OPEN TABLES where In_use \u0026gt; 0; #æŸ¥çœ‹æ˜¯å¦æœ‰é”è¡¨ SELECT * FROM INFORMATION_SCHEMA.INNODB_LOCKS; #æŸ¥çœ‹æ­£åœ¨é”çš„äº‹åŠ¡ Empty set SELECT * FROM INFORMATION_SCHEMA.INNODB_LOCK_WAITS; #æŸ¥çœ‹ç­‰å¾…é”çš„äº‹åŠ¡ Empty set æš‚æ—¶æ²¡æœ‰çœ‹åˆ°é”è¡¨çš„æƒ…å†µ æŸ¥çœ‹ç¼“å­˜å‘½ä¸­ mysql\u0026gt; show global status like \u0026#39;Qca%\u0026#39;; +-------------------------+-----------+ | Variable_name | Value | +-------------------------+-----------+ | Qcache_free_blocks | 1 | | Qcache_free_memory | 134199912 | | Qcache_hits | 0 | | Qcache_inserts | 0 | | Qcache_lowmem_prunes | 0 | | Qcache_not_cached | 44950579 | | Qcache_queries_in_cache | 0 | | Qcache_total_blocks | 1 | +-------------------------+-----------+ 8 rows in set Qcache_hitsï¼šæŸ¥è¯¢ç¼“å­˜å‘½ä¸­æ¬¡æ•°ã€‚ Qcache_insertsï¼šå°†æŸ¥è¯¢å’Œç»“æœé›†å†™å…¥åˆ°æŸ¥è¯¢ç¼“å­˜ä¸­çš„æ¬¡æ•°ã€‚ Qcache_not_cachedï¼šä¸å¯ä»¥ç¼“å­˜çš„æŸ¥è¯¢æ¬¡æ•°ã€‚ Qcache_queries_in_cacheï¼šæŸ¥è¯¢ç¼“å­˜ä¸­ç¼“å­˜çš„æŸ¥è¯¢é‡ã€‚ æŸ¥çœ‹åˆ°ç¼“å­˜å‘½ä¸­ä¸º0%\næŸ¥çœ‹å¼•æ“çŠ¶æ€ mysql\u0026gt; show engine innodb status; é€šè¿‡ä¸Šè¾¹ä¸€ç³»åˆ—çš„æŸ¥è¯¢ï¼Œå‘ç°ä»¥ä¸‹å‡ ä¸ªé—®é¢˜\n1ã€æ…¢æŸ¥è¯¢ã€å…¨è¡¨æ‰«æè¿‡å¤š æè¿°\næ…¢sqlï¼šæŸ¥çœ‹åˆ°sqlè¯­å¥æ‰§è¡Œæ—¶é—´è¿‡é•¿ã€‚\nå…¨è¡¨æ‰«æï¼šè¿™ä¸ªç­–ç•¥ç”¨äºæ£€æŸ¥ç™¾åˆ†æ¯”ï¼ˆ(Handler_read_rnd+Handler_read_rnd_next)/(Handler_read_first+Handler_read_key+Handler_read_next+Handler_read_prev+Handler_read_rnd+Handler_read_rnd_next)ï¼‰ã€‚ è¿™æ˜¯ä¸€ä¸ªéœ€è¦è¯»å–å…¨è¡¨å†…å®¹çš„æ“ä½œï¼Œè€Œä¸æ˜¯ä»…è¯»å–ä½¿ç”¨ç´¢å¼•é€‰å®šçš„éƒ¨åˆ†ã€‚ é€šå¸¸ä½¿ç”¨å°å‹æŸ¥æ‰¾è¡¨æ‰§è¡Œï¼Œæˆ–è€…åœ¨å…·æœ‰å¤§å‹è¡¨çš„æ•°æ®ä»“åº“æƒ…å†µä¸‹æ‰§è¡Œè€Œå…¶ä¸­æ‰€æœ‰å¯ç”¨æ•°æ®éƒ½è¢«èšåˆå’Œåˆ†æã€‚\nå»ºè®®\næ…¢sqlï¼š æ ¹æ®sql æ£€æŸ¥è¯­å¥å¹¶è¿›è¡Œç´¢å¼•ä¼˜åŒ–ã€‚\nå…¨è¡¨æ‰«æ:åº”è¯¥å°½é‡ä¿æŒè¿™ä¸ªå€¼å°½å¯èƒ½çš„ä½ã€‚å°è¯•éš”ç¦»é‚£äº›ä¸ä½¿ç”¨ç´¢å¼•çš„æŸ¥è¯¢ã€‚ä¸€æ—¦è¯†åˆ«äº†é‚£äº›æŸ¥è¯¢ï¼Œè¯·åˆ›å»ºé€‚å½“çš„ç´¢å¼•æˆ–é‡å†™æŸ¥è¯¢ä»¥ä½¿ç”¨ç´¢å¼•ã€‚MySQL æœ‰ä¸€ä¸ªå¾ˆæ£’çš„åŠŸèƒ½ - æ…¢é€ŸæŸ¥è¯¢æ—¥å¿—ï¼Œå®ƒå…è®¸ä½ è®°å½•æ‰€æœ‰éœ€è¦è¶…è¿‡æŒ‡å®šæ—¶é—´è¿è¡Œçš„æŸ¥è¯¢ã€‚æ…¢é€Ÿé€ŸæŸ¥è¯¢æ—¥å¿—å¯ç”¨äºè¯†åˆ«éœ€è¦å¾ˆé•¿æ—¶é—´æ‰èƒ½å®Œæˆçš„æŸ¥è¯¢ã€‚\n2ã€æ•°æ®åº“æœ€å¤§å¹¶å‘è¿æ¥æ•°é‡ æè¿°\nå½“æœåŠ¡å™¨å¯åŠ¨åï¼Œï¼ˆmax_used_connectionsï¼‰å˜é‡å°†æä¾›ä¸€ä¸ªåŸºå‡†ï¼Œä»¥å¸®åŠ©ä½ ç¡®å®šæœåŠ¡å™¨æ”¯æŒçš„æœ€å¤§è¿æ¥æ•°é‡ã€‚ å®ƒè¿˜å¯ä»¥å¸®åŠ©è¿›è¡Œæµé‡åˆ†æã€‚\nå»ºè®®\nå¦‚æœéœ€è¦æ”¯æŒæ›´å¤šçš„è¿æ¥ï¼Œåº”è¯¥å¢åŠ å˜é‡ max_connections çš„å€¼ã€‚MySQL æ”¯æŒçš„æœ€å¤§è¿æ¥æ•°é‡æ˜¯å–å†³äºç»™å®šå¹³å°ä¸Šçº¿ç¨‹åº“çš„è´¨é‡ã€å¯ç”¨ RAM çš„æ•°é‡ã€æ¯ä¸ªè¿æ¥å¯ä½¿ç”¨å¤šå°‘ RAMã€æ¯ä¸ªè¿æ¥çš„å·¥ä½œè´Ÿè½½ä»¥åŠæ‰€éœ€çš„å“åº”æ—¶é—´ã€‚\n3ã€æŸ¥è¯¢ç¼“å­˜è¦é…ç½® ç¼“å­˜æè¿°\nè¿™ä¸ªç­–ç•¥ç”¨äºæ£€æŸ¥æŸ¥è¯¢ç¼“å­˜å‘½ä¸­ç‡ï¼ˆQcache_hits/(Qcache_hits + Com_select)ï¼‰ã€‚ MySQL æŸ¥è¯¢ç¼“å­˜å°†ç¼“å­˜ä¸€ä¸ªåˆ†æçš„æŸ¥è¯¢åŠå…¶æ•´ä¸ªç»“æœé›†ã€‚ å½“ä½ æœ‰è®¸å¤šå°å‹çš„æŸ¥è¯¢è¿”å›å°å‹æ•°æ®é›†æ—¶ï¼Œè¿™æ˜¯éå¸¸å¥½çš„ï¼Œå› ä¸ºæŸ¥è¯¢ç¼“å­˜å°†å…è®¸è¿”å›ç»“æœï§·å³å¯ä¾›ä½¿ç”¨ï¼Œè€Œä¸æ˜¯æ¯æ¬¡å‘ç”Ÿæ—¶éƒ½é‡æ–°è¿è¡ŒæŸ¥è¯¢ã€‚\nå»ºè®®\nç†æƒ³æƒ…å†µä¸‹ï¼ŒæŸ¥è¯¢ç¼“å­˜çš„å‘½ä¸­ç‡åº”è¯¥æ¥è¿‘ 100%ã€‚MySQL çš„æŸ¥è¯¢ç¼“å­˜æ˜¯ä¸€é¡¹å¼ºå¤§çš„æŠ€æœ¯ï¼Œå¹¶ä¸”åœ¨ç®¡ç†è‰¯å¥½çš„æƒ…å†µä¸‹å¯ä»¥æ˜¾ç€æé«˜æ•°æ®åº“çš„ååé‡ã€‚ä¸€æ—¦ä½ çš„åº”ç”¨ç¨‹åºè¢«åˆ›å»ºï¼Œä½ å¯ä»¥çœ‹çœ‹å®ƒå¦‚ä½•ä½¿ç”¨æ•°æ®åº“ï¼Œå¹¶ç›¸åº”åœ°è°ƒæ•´æŸ¥è¯¢ç¼“å­˜ã€‚æœ‰è¶³å¤Ÿå¤§çš„ç¼“å­˜ï¼Œé¿å…ç¢ç‰‡åŒ–å’Œæ’é™¤å¤§å‹çš„æŸ¥è¯¢ï¼Œä½ å°±åº”è¯¥èƒ½å¤Ÿä¿æŒæé«˜çš„ç¼“å­˜å‘½ä¸­ç‡ï¼Œå¹¶äº«å—å‡ºè‰²çš„æ€§èƒ½ã€‚\nå¤„ç†è¿‡ç¨‹ æ ¹æ®ä¸Šè¾¹å‘ç°çš„é—®é¢˜è¿›è¡Œäº†é…ç½®çš„ä¿®æ”¹\n1ã€ä¿®æ”¹æ…¢æŸ¥è¯¢ä»¥åŠå…¨è¡¨æ‰«æ æ­¤é—®é¢˜è”ç³»å¼€å‘è¿›è¡Œç´¢å¼•ä¼˜åŒ–ï¼Œå‡å°‘å…¨è¡¨æ‰«æã€‚\n2ã€æ•°æ®åº“æœ€å¤§è¿æ¥æ•°é‡ ä¿®æ”¹é…ç½® max_user_connections æˆ‘è¿™è¾¹è®¾ç½®çš„ä¸º1000\n3ã€æŸ¥è¯¢ç¼“å­˜çš„é…ç½® query_cache_sizeï¼šåˆ†é…ç”¨äºç¼“å­˜æŸ¥è¯¢ç»“æœçš„å†…å­˜é‡ã€‚ query_cache_limitï¼šä¸è¦ç¼“å­˜å¤§äºæ­¤å­—èŠ‚æ•°çš„ç»“æœã€‚ query_cache_typeï¼šå¯¹äºæŸ¥è¯¢ç»“æœï¼Œä¸ç¼“å­˜ï¼ˆ= OFFï¼‰ï¼Œä¸ç¼“å­˜NO_CACHEï¼ˆ= ONï¼‰ï¼Œæˆ–ä»…ç¼“å­˜ï¼ˆ= DEMANDï¼‰åˆ†åˆ«ç”¨012 è¡¨ç¤º ä¿®æ”¹å®Œæ•°æ®ä½†æ˜¯éœ€è¦é‡å¯æ‰èƒ½ç”Ÿæ•ˆã€‚\né—®é¢˜è§£å†³ æ­£åœ¨å‡†å¤‡ç©ºé—²æ—¶é—´é‡å¯RDSçš„æ—¶å€™ï¼Œå¼€å‘é‚£è¾¹æœ‰äº†è¿›å±•ã€‚\nå¼€å‘åŒäº‹æŠŠç¼“å­˜å†™é”™äº†ï¼ï¼ï¼ï¼ğŸ˜³ğŸ˜³ğŸ˜³\næ€»ç»“ ç†ä¸‹ä¸šåŠ¡\nç¨‹åºæš´éœ²æ¥å£ç»™æµ‹è¯•éƒ¨é—¨ï¼Œæµ‹è¯•éƒ¨é—¨åœ¨ä¸ŠæŠ¥äº†50Wæ¡æ•°æ®ï¼Œå¼€å‘è¿™è¾¹ç¨‹åºæœ‰æ²¡æœ‰æ·»åŠ æ•°æ®è¿‡æ»¤ï¼ˆè¿‡æ»¤æ‰åƒåœ¾æ•°æ®ï¼‰ï¼Œå¹¶ä¸”\u0026hellip;å¼€å‘åœ¨ç¨‹åºä¸­å†™é”™äº†ç¼“å­˜ã€‚æ‰€ä»¥å¯¼è‡´ç›¸å¯¹äºè¯»å–æ¥è¯´å†™å…¥è¾ƒé«˜ã€‚å› ä¸ºåœ¨ç¼“å­˜æŸ¥è¯¢ä¸åˆ°æƒ³åˆ°çš„æ•°æ®ï¼Œå°±è¿›è¡Œäº†å…¨è¡¨æ‰«æï¼Œç»§è€Œå‡ºç°äº†å¤§é‡è¿›ç¨‹ä»¥åŠè¿æ¥æ•°é˜Ÿåˆ—ç­‰ç­‰ã€‚ã€‚\nå¤„ç†é—®é¢˜å¯ä»¥ï¼Œåˆ«ä¸»åŠ¨èƒŒé”…ã€‚ã€‚ã€‚åœ¨æ¥æ‰‹æ•°æ®åº“çš„æ—¶å€™æœ€å¥½æ£€æŸ¥ä¸‹é…ç½®ï¼Œäº†è§£æ•°æ®åº“çš„æƒ…å†µï¼Œåœ¨å‡ºç°é—®é¢˜çš„æ—¶å€™èƒ½å¤Ÿæœ€å¿«é€Ÿçš„å®šä½è§£å†³é—®é¢˜ã€‚\nå¦å¤–ï¼Œç»è¿‡æ­¤æ¬¡çš„æ•…éšœå¤„ç†ï¼ŒåŠ å›ºäº†å¯¹ä¸šåŠ¡ä»¥åŠæ•°æ®åº“ä¸€äº›å‚æ•°çš„ç†è§£ã€‚\nä½œè€…ï¼šSREè¿ç»´åšå®¢\nåšå®¢åœ°å€ï¼šhttps://www.cnsre.cn\næ–‡ç« åœ°å€ï¼šhttps://www.cnsre.cn/posts/210413131020/\nç›¸å…³è¯é¢˜ï¼šhttps://www.cnsre.cn/tags/æ•…éšœé›†/\n","description":"æ•°æ®åº“CPU 100%å¤„ç†è®°å½•","id":75,"section":"posts","tags":["mysql","æ•…éšœé›†"],"title":"æ•°æ®åº“CPU 100%å¤„ç†è®°å½•","uri":"http://www.cnsre.cn:80/posts/210413131020/"},{"content":" ä½œè€…ï¼šSREè¿ç»´åšå®¢\nåšå®¢åœ°å€ï¼šhttps://www.cnsre.cn\næ–‡ç« åœ°å€ï¼šhttps://www.cnsre.cn/posts/210412150856/\nç›¸å…³è¯é¢˜ï¼šhttps://www.cnsre.cn/tags/redis/\nLinuxä¸‹Rediså•æœºç‰ˆå®‰è£…ä¸é…ç½®\nä¸‹è½½å®‰è£…åŒ…å¹¶è§£å‹ cd /usr/local wget http://download.redis.io/releases/redis-4.0.6.tar.gz tar -zxvf redis-4.0.6.tar.gz æŒ‰ç…§ä¾èµ–ç¯å¢ƒ yum install gcc-c++ -y ç¨å¾®æ…¢ç‚¹éœ€è¦ç­‰ä¸€å°ä¼šå„¿\nç¼–è¯‘å®‰è£… cd redis-4.0.6 make MALLOC=libcmake install ä¸ºRedisæ·»åŠ ç¯å¢ƒå˜é‡ vim /etc/profile PATH=$PATH:$HOME/bin:/usr/local/redis-4.0.6/src # æ·»åŠ srcç›®å½•è·¯å¾„åˆ°è¿™é‡Œ export PATH æ‹·è´é…ç½®æ–‡ä»¶åˆ°/etcç›®å½•ä¸‹ cp /usr/local/redis-4.0.6/redis.conf /etc/redis.conf é…ç½®Redis vim /etc/redis.conf ä¿®æ”¹ä»¥åå°æ–¹å¼è¿è¡Œ å¼€å¯å¯†ç è®¿é—®\nå¼€å¯è¿œç¨‹è®¿é—®\næ‰§è¡Œå¯åŠ¨è„šæœ¬ ./redis-server /etc/redis.conf ç™»å½•Redis redis-cli -h 127.0.0.1 -p 6379 -a bsh@123 åœæ­¢æœåŠ¡ 127.0.0.1:6379\u0026gt; shutdown ä½œè€…ï¼šSREè¿ç»´åšå®¢\nåšå®¢åœ°å€ï¼šhttps://www.cnsre.cn\næ–‡ç« åœ°å€ï¼šhttps://www.cnsre.cn/posts/210412150856/\nç›¸å…³è¯é¢˜ï¼šhttps://www.cnsre.cn/tags/redis/\n","description":"Linux Redis å•æœºç‰ˆå®‰è£…ä¸é…ç½®","id":76,"section":"posts","tags":["redis"],"title":"Linux Redis å•æœºç‰ˆå®‰è£…ä¸é…ç½®","uri":"http://www.cnsre.cn:80/posts/210412150856/"},{"content":" ä½œè€…ï¼šSREè¿ç»´åšå®¢\nåšå®¢åœ°å€ï¼šhttps://www.cnsre.cn\næ–‡ç« åœ°å€ï¼šhttps://www.cnsre.cn/posts/210409164113/\nç›¸å…³è¯é¢˜ï¼šhttps://www.cnsre.cn/tags/aws/\nèƒŒæ™¯ä»‹ç» Amazon S3æ˜¯äº’è”ç½‘å­˜å‚¨è§£å†³æ–¹æ¡ˆï¼Œèƒ½è®©æ‰€æœ‰å¼€å‘äººå‘˜è®¿é—®åŒä¸€ä¸ªå…·å¤‡å¯æ‰©å±•æ€§ã€å¯é æ€§ã€å®‰å…¨æ€§å’Œå¿«é€Ÿä»·å»‰çš„æ•°æ®å­˜å‚¨åŸºç¡€è®¾æ–½ã€‚Amazon S3 æä¾›äº†ä¸€ä¸ªç®€å• Web æœåŠ¡æ¥å£ï¼Œå¯ç”¨äºéšæ—¶åœ¨ äº’è”ç½‘ä¸Šçš„ä»»ä½•ä½ç½®å­˜å‚¨å’Œæ£€ç´¢ä»»ä½•æ•°é‡çš„æ•°æ®ã€‚å¼€å‘äººå‘˜å¯ä»¥åˆ©ç”¨Amazonæä¾›çš„REST APIæ¥å£ï¼Œå‘½ä»¤è¡Œæ¥å£æˆ–è€…æ”¯æŒä¸åŒè¯­è¨€çš„SDKè®¿é—®S3æœåŠ¡ã€‚\nå¯¹äºåŸæ¥ä½¿ç”¨æœ¬åœ°ç›®å½•è®¿é—®æ•°æ®çš„åº”ç”¨ç¨‹åºï¼Œæ¯”å¦‚ä½¿ç”¨æœ¬åœ°ç£ç›˜æˆ–ç½‘ç»œå…±äº«ç›˜ä¿å­˜æ•°æ®çš„åº”ç”¨ç³»ç»Ÿï¼Œå¦‚æœç”¨æˆ·å¸Œæœ›æŠŠæ•°æ®æ”¾åˆ°S3ä¸Šï¼Œåˆ™éœ€è¦ä¿®æ”¹æ•°æ®çš„è®¿é—®æ–¹å¼ï¼Œæ¯”å¦‚ä¿®æ”¹ä¸ºä½¿ç”¨AWS SDK æˆ–CLIè®¿é—®S3ä¸­å­˜å‚¨çš„æ•°æ®ã€‚ä¸ºäº†è®©ç”¨æˆ·åŸæ¥çš„åº”ç”¨ç³»ç»Ÿèƒ½åœ¨ä¸åšä¿®æ”¹çš„æƒ…å†µä¸‹ç›´æ¥ä½¿ç”¨Amazon S3æœåŠ¡ï¼Œéœ€è¦æŠŠS3å­˜å‚¨æ¡¶ä½œä¸ºç›®å½•æŒ‚è½½åˆ°ç”¨æˆ·æœåŠ¡å™¨çš„æœ¬åœ°æ“ä½œç³»ç»Ÿä¸Šã€‚å¸¸ç”¨çš„æŒ‚è½½å·¥å…·æœ‰S3fså’ŒSubCloudç­‰ã€‚æœ¬æ–‡ä¸»è¦ä»‹ç»å¦‚ä½•åˆ©ç”¨S3fså°†S3å­˜å‚¨æ¡¶æŒ‚è½½åˆ°Amazon EC2 Linuxå®ä¾‹ä¸Šã€‚\nS3fsä»‹ç» S3fsæ˜¯åŸºäºFUSEçš„æ–‡ä»¶ç³»ç»Ÿï¼Œå…è®¸Linuxå’ŒMac Os X æŒ‚è½½S3çš„å­˜å‚¨æ¡¶åœ¨æœ¬åœ°æ–‡ä»¶ç³»ç»Ÿï¼ŒS3fsèƒ½å¤Ÿä¿æŒå¯¹è±¡åŸæ¥çš„æ ¼å¼ã€‚å…³äºS3fsçš„è¯¦ç»†ä»‹ç»ï¼Œè¯·å‚è§ï¼šhttps://github.com/s3fs-fuse/s3fs-fuse\nåˆ©ç”¨S3fsæŒ‚è½½S3å­˜å‚¨æ¡¶ å‡†å¤‡ ä½¿ç”¨æ‹¥æœ‰è¶³å¤Ÿæƒé™çš„IAMè´¦å·ç™»å½•AWSæ§åˆ¶å°ã€‚ åˆ›å»ºS3å­˜å‚¨æ¡¶ï¼Œç»™å­˜å‚¨æ¡¶å‘½åå¦‚s3fs-mount-bucketï¼ˆå¦‚æœä½¿ç”¨å·²æœ‰å­˜å‚¨æ¡¶ï¼Œæœ¬æ­¥éª¤å¯ç•¥è¿‡ï¼‰ã€‚ æœ‰è¯¥S3å­˜å‚¨æ¡¶è®¿é—®æƒé™çš„ IAM ç”¨æˆ·ï¼Œå¹¶ä¸ºè¯¥IAMç”¨æˆ·åˆ›å»ºè®¿é—®å¯†é’¥ã€‚ å…³äºå¦‚ä½•åˆ›å»ºIAMç”¨æˆ·ï¼Œè¯·å‚è§ï¼šhttp://docs.aws.amazon.com/zh_cn/IAM/latest/UserGuide/id_users_create.html#id_users_create_console å…³äºå¦‚ä½•ä¸ºIAMç”¨æˆ·åˆ›å»ºè®¿é—®å¯†é’¥ï¼Œè¯·å‚è§ï¼šhttp://docs.aws.amazon.com/zh_cn/IAM/latest/UserGuide/id_credentials_access-keys.html å…³äºå¦‚ä½•ä¸ºIAMç”¨æˆ·è®¾ç½®æƒé™ç­–ç•¥ï¼Œè¯·å‚è§ï¼šhttp://docs.aws.amazon.com/zh_cn/IAM/latest/UserGuide/access_policies_create.html https://aws.amazon.com/cn/blogs/security/writing-iam-policies-how-to-grant-access-to-an-amazon-s3-bucket/\nåˆ›å»ºå¹¶å¯åŠ¨Amazon EC2 Linuxå®ä¾‹ å…·ä½“è¿‡ç¨‹è¯·å‚è§ï¼šhttp://docs.aws.amazon.com/zh_cn/AWSEC2/latest/UserGuide/launching-instance.html\nå®‰è£…å’Œé…ç½®S3fs å®‰è£…s3f å®‰è£…å¿…è¦çš„è½¯ä»¶åŒ… 1 sudo yum install automake fuse fuse-devel gcc-c++ git libcurl-devel libxml2-devel make openssl-devel ä¸‹è½½ï¼Œç¼–è¯‘å¹¶å®‰è£…s3fs 1 2 3 4 5 6 git clone https://github.com/s3fs-fuse/s3fs-fuse.git cd s3fs-fuse ./autogen.sh ./configure make sudo make install æ£€æŸ¥s3fsæ˜¯å¦å®‰è£…æˆåŠŸ 1 2 3 4 5 [ec2-user@ip-172-31-23-148 s3fs-fuse]$ s3fs s3fs: missing BUCKET argument. Usage: s3fs BUCKET:[PATH] MOUNTPOINT [OPTION]... [ec2-user@ip-172-31-23-148 ~]$ which s3fs /usr/local/bin/s3fs åˆ›å»ºIAMç”¨æˆ·è®¿é—®å¯†é’¥æ–‡ä»¶ IAMç”¨æˆ·è®¿é—®å¯†é’¥å†…å®¹å¯ä»¥å†™å…¥å½“å‰ç”¨æˆ·é»˜è®¤å¯†é’¥æ–‡ä»¶æ¯”å¦‚/home/ec2-user/.passwd-s3fsæˆ–è€…ç”¨æˆ·è‡ªå·±åˆ›å»ºçš„æ–‡ä»¶ã€‚ å‘½ä»¤æ ¼å¼ï¼šecho [IAMç”¨æˆ·è®¿é—®å¯†é’¥ID]:[ IAMç”¨æˆ·è®¿é—®å¯†é’¥] \u0026gt;[å¯†é’¥æ–‡ä»¶å] å‘½ä»¤ä¸¾ä¾‹ï¼šä¸‹é¢çš„ä¾‹å­å°†åœ¨å½“å‰ç”¨æˆ·é»˜è®¤è·¯å¾„åˆ›å»ºå¯†é’¥æ–‡ä»¶ 1 echo AKIAIOEO4E2VOHLxxxxx:2LXBboddEpRLmWl48i3+b4ziwPL3bJ4vxxxxxxxx \u0026gt; /home/ec2-user/.passwd-s3fs è¯·æ³¨æ„ï¼šè®¿é—®æµ·å¤–AWS S3æœåŠ¡å’Œä¸­å›½ S3æœåŠ¡ä½¿ç”¨çš„æ˜¯ä¸åŒçš„IAMè´¦å·ï¼Œå¯¹åº”ä¸åŒçš„å¯†é’¥ã€‚\nè®¾ç½®å¯†é’¥æ–‡ä»¶åªèƒ½å¤Ÿè¢«å½“å‰ç”¨æˆ·è®¿é—® å‘½ä»¤æ ¼å¼ï¼šchmod 600 [å¯†é’¥æ–‡ä»¶å] å‘½ä»¤ä¸¾ä¾‹ï¼šä¸‹é¢çš„ä¾‹å­å°†è®¾ç½®å¯†é’¥æ–‡ä»¶åªèƒ½è¢«å½“å‰ç”¨æˆ·è®¿é—® 1 chmod 600 /home/ec2-user/.passwd-s3fs æ‰‹åŠ¨æŒ‚è½½S3å­˜å‚¨æ¡¶ S3fsæŒ‚è½½å­˜å‚¨æ¡¶ä½¿ç”¨çš„å‘½ä»¤æ˜¯s3fs\ns3fsçš„å‘½ä»¤æ ¼å¼æ˜¯ï¼š\ns3fs BUCKET MOUNTPOINT [OPTION]â€¦ s3fs [S3å­˜å‚¨æ¡¶å] [æœ¬åœ°ç›®å½•å] [OPTION] OPTIONæ˜¯å¯é€‰é¡¹ï¼Œæ ¼å¼æ˜¯ â€“o \u0026lt;option_name\u0026gt;=\u0026lt;option_value\u0026gt;ï¼Œå¸¸ç”¨çš„optionsæœ‰ï¼š åç§° å«ä¹‰ ç¼ºçœå€¼ passwd_file æŒ‡å®šæŒ‚è½½çš„å¯†é’¥æ–‡ä»¶ connect_timeout è®¾ç½®è¶…æ—¶è¿æ¥ç­‰å¾…çš„æ—¶é—´ï¼Œå•ä½ç§’ 300 url è®¾ç½®è®¿é—®s3çš„url http://s3.amazonaws.com endpoint è®¾ç½®s3å­˜å‚¨æ¡¶çš„endpoint us-east-1 allow_other è®¾ç½®allow_otherå…è®¸æ‰€æœ‰ç”¨æˆ·è®¿é—®æŒ‚è½½ç‚¹ç›®å½•ï¼Œè®¾ç½®è¿™ä¸ªé€‰é¡¹éœ€è¦åœ¨ /etc/fuse.conf æ–‡ä»¶æ·»åŠ user_allow_otheré€‰é¡¹ æ‰‹åŠ¨æŒ‚è½½AWSæµ·å¤–åŒºåŸŸS3å­˜å‚¨æ¡¶\nå‘½ä»¤æ ¼å¼ï¼šs3fs [S3å­˜å‚¨æ¡¶å] [æœ¬åœ°ç›®å½•å] -o passwd_file=[å¯†é’¥æ–‡ä»¶å] -o endpoint=[åŒºåŸŸå]\nå‘½ä»¤ä¸¾ä¾‹ï¼šä¸‹é¢çš„ä¾‹å­å°†åä¸ºs3fs-mount-bucketçš„æ–°åŠ å¡åŒºåŸŸS3å­˜å‚¨æ¡¶æŒ‚è½½åˆ°æŒ‡å®šçš„æœ¬åœ°ç›®å½•/home/ec2-user/s3mntã€‚ 1 s3fs s3fs-mount-bucket /home/ec2-user/s3mnt -o passwd_file=/home/ec2-user/.passwd-s3fs -o endpoint=ap-northeast-1 æ‰‹åŠ¨æŒ‚è½½AWSä¸­å›½åŒ—äº¬åŒºåŸŸS3å­˜å‚¨æ¡¶\nå‘½ä»¤æ ¼å¼ï¼šs3fs [S3å­˜å‚¨æ¡¶å] [æœ¬åœ°ç›®å½•å] -o passwd_file=[å¯†é’¥æ–‡ä»¶å] -o url=http://s3.cn-north-1.amazonaws.com.cn -o endpoint=cn-north-1 å‘½ä»¤ä¸¾ä¾‹ï¼šä¸‹é¢çš„ä¾‹å­å°†åä¸ºs3fs-mount-bucketçš„åŒ—äº¬åŒºåŸŸS3å­˜å‚¨æ¡¶æŒ‚è½½åˆ°æœ¬åœ°ç›®å½•/home/ec2-user/s3mntã€‚ 1 s3fs s3fs-mount-bucket /home/ec2-user/s3mnt -o passwd_file=/home/ec2-user/.passwd-s3fs -o url=http://s3.cn-north-1.amazonaws.com.cn -o endpoint=cn-north-1 æ£€æŸ¥æŒ‚è½½ç»“æœ\næŒ‚è½½æ“ä½œæ‰§è¡Œç»“æŸåï¼Œå¯ä»¥ä½¿ç”¨Linux dfå‘½ä»¤æŸ¥çœ‹æŒ‚è½½æ˜¯å¦æˆåŠŸã€‚å‡ºç°ç±»ä¼¼ä¸‹é¢256Tçš„s3fsæ–‡ä»¶ç³»ç»Ÿå³è¡¨ç¤ºæŒ‚è½½æˆåŠŸã€‚ç”¨æˆ·å°±å¯ä»¥è¿›å…¥æœ¬åœ°æŒ‚è½½ç›®å½•å»è®¿é—®å­˜å‚¨åœ¨S3å­˜å‚¨æ¡¶ä¸­çš„å¯¹è±¡ã€‚ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 [ec2-user@ip-172-31-23-148 ~]$ df -h æ–‡ä»¶ç³»ç»Ÿ å®¹é‡ å·²ç”¨ å¯ç”¨ å·²ç”¨% æŒ‚è½½ç‚¹ devtmpfs 488M 56K 488M 1% /dev tmpfs 498M 0 498M 0% /dev/shm /dev/xvda1 7.8G 1.2G 6.6G 15% / s3fs 256T 0 256T 0% /home/ec2-user/s3mnt [ec2-user@ip-172-31-23-148 ~]$ cd /home/ec2-user/s3mnt [ec2-user@ip-172-31-23-148 s3mnt]$ ls -l æ€»ç”¨é‡ 1 -rw-rw-r-- 1 ec2-user ec2-user 19 10æœˆ 18 07:13 a.txt [ec2-user@ip-172-31-23-148 s3mnt]$ å¸è½½æŒ‚è½½çš„S3å­˜å‚¨æ¡¶\nå¦‚æœä¸å†éœ€è¦é€šè¿‡æŒ‚è½½æ–¹å¼è®¿é—®S3å­˜å‚¨æ¡¶ï¼Œå¯ä»¥ä½¿ç”¨Linux â€œumountâ€å‘½ä»¤å¸è½½ 1 2 3 4 5 6 7 8 9 10 11 [ec2-user@ip-172-31-23-148 ~]$ sudo umount /home/ec2-user/s3mnt [ec2-user@ip-172-31-23-148 ~]$ df -h æ–‡ä»¶ç³»ç»Ÿ å®¹é‡ å·²ç”¨ å¯ç”¨ å·²ç”¨% æŒ‚è½½ç‚¹ devtmpfs 488M 56K 488M 1% /dev tmpfs 498M 0 498M 0% /dev/shm /dev/xvda1 7.8G 1.2G 6.6G 15% / è°ƒè¯•\nå¦‚æœé‡åˆ°æ‰‹åŠ¨æŒ‚è½½ä¸æˆåŠŸçš„é—®é¢˜ï¼Œè¯·å°è¯•åœ¨æ‰§è¡Œçš„å‘½ä»¤åé¢æ·»åŠ ä¸‹é¢çš„å‚æ•°ï¼Œå¹¶æ£€æŸ¥è¾“å‡ºæ—¥å¿—ä¸­çš„é”™è¯¯æç¤ºä¿¡æ¯ï¼š\nå‘½ä»¤æ ¼å¼ï¼š[å®Œæ•´çš„s3fsæŒ‚è½½å‘½ä»¤] -d -d -f -o f2 -o curldbg å‘½ä»¤ä¸¾ä¾‹ï¼šä¸‹é¢çš„ä¾‹å­è¯•å›¾å°†åä¸ºs3fs-mount-bucketçš„S3å­˜å‚¨æ¡¶æŒ‚è½½åˆ°æŒ‡å®šçš„æœ¬åœ°ç›®å½•/home/ec2-user/s3mntä¸‹ï¼Œå¹¶è¾“å‡ºæŒ‚è½½è¿‡ç¨‹è¯¦ç»†è°ƒè¯•æ—¥å¿—ã€‚ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 [ec2-user@ip-172-31-23-148 ~]$ s3fs s3fs-mount-bucket /home/ec2-user/s3mnt -o passwd_file=/home/ec2-user/.passwd-s3fs -o url=http://s3.cn-north-1.amazonaws.com.cn -o endpoint=cn-north-1 -d -d -f -o f2 -o curldbg [CRT] s3fs.cpp:set_s3fs_log_level(254): change debug level from [CRT] to [INF] [CRT] s3fs.cpp:set_s3fs_log_level(254): change debug level from [INF] to [DBG] [INF] s3fs.cpp:set_moutpoint_attribute(4196): PROC(uid=500, gid=500) - MountPoint(uid=500, gid=500, mode=40775) FUSE library version: 2.9.4 nullpath_ok: 0 nopath: 0 utime_omit_ok: 0 è®¾ç½®å¼€æœºè‡ªåŠ¨æŒ‚è½½S3å­˜å‚¨æ¡¶ åˆ›å»ºå…¨å±€IAMç”¨æˆ·è®¿é—®å¯†é’¥æ–‡ä»¶ åˆ‡æ¢Linuxç³»ç»Ÿç”¨æˆ·è´¦å·åˆ°rootç”¨æˆ·ï¼ŒæŠŠIAMç”¨æˆ·è®¿é—®å¯†é’¥å†…å®¹å†™å…¥/etc/passwd-s3fsæ–‡ä»¶ä¸­ï¼Œå¹¶é™åˆ¶è¯¥æ–‡ä»¶çš„è®¿é—®æƒé™ã€‚/etc/passwd-s3fsæ–‡ä»¶æ˜¯s3fsä¿å­˜IAMç”¨æˆ·è®¿é—®å¯†é’¥çš„å…¨å±€é»˜è®¤è·¯å¾„ã€‚\nè¯·æ³¨æ„ï¼šè®¿é—®æµ·å¤–AWS S3æœåŠ¡å’Œä¸­å›½ S3æœåŠ¡ä½¿ç”¨çš„æ˜¯ä¸åŒçš„IAMè´¦å·ï¼Œå¯¹åº”ä¸åŒçš„å¯†é’¥ã€‚\n1 2 3 4 5 sudo su echo AKIAIOEO4E2VOHLxxxxx:2LXBboddEpRLmWl48i3+b4ziwPL3bJ4vxxxxxxxx \u0026gt; /etc/passwd-s3fs chmod 600 /etc/passwd-s3fs ä¿®æ”¹/etc/fstabæ–‡ä»¶ ç¼–è¾‘/etc/fstabæ–‡ä»¶ï¼Œæ·»åŠ åé¢çš„è‡ªåŠ¨æŒ‚è½½å‘½ä»¤ã€‚\n1 vi /etc/fstab è‡ªåŠ¨æŒ‚è½½æµ·å¤–åŒºåŸŸS3å­˜å‚¨æ¡¶\nå‘½ä»¤æ ¼å¼ï¼šs3fs#[S3å­˜å‚¨æ¡¶å] [æœ¬åœ°ç›®å½•å] fuse _netdev,allow_other,endpoint=[åŒºåŸŸå] 0 0 å‘½ä»¤ä¸¾ä¾‹ï¼šæ·»åŠ ä¸‹é¢çš„è¯­å¥åˆ°/etc/fstabåï¼ŒLinuxç³»ç»Ÿå¯åŠ¨åå°†è‡ªåŠ¨æŠŠåä¸ºs3fs-mount-bucketçš„æ–°åŠ å¡åŒºåŸŸS3å­˜å‚¨æ¡¶æŒ‚è½½åˆ°æœ¬åœ°ç›®å½•/home/ec2-user/s3mntï¼Œå¹¶å…è®¸å…¶å®ƒæ“ä½œç³»ç»Ÿç”¨æˆ·(érootç”¨æˆ·)è®¿é—®ã€‚ 1 /usr/local/bin/s3fs#s3fs-mount-bucket /home/ec2-user/s3mnt fuse _netdev,allow_other,endpoint=ap-northeast-1 0 0 è‡ªåŠ¨æŒ‚è½½ä¸­å›½åŒ—äº¬åŒºåŸŸS3å­˜å‚¨æ¡¶\nå‘½ä»¤æ ¼å¼ï¼šs3fs#[S3å­˜å‚¨æ¡¶å] [æœ¬åœ°ç›®å½•å] fuse allow_other,url=http://s3.cn-north-1.amazonaws.com.cn,endpoint=cn-north-1 0 0 å‘½ä»¤ä¸¾ä¾‹ï¼šæ·»åŠ ä¸‹é¢çš„è¯­å¥åˆ°/etc/fstabåï¼ŒLinuxç³»ç»Ÿå¯åŠ¨å°†è‡ªåŠ¨æŠŠåä¸ºs3fs-mount-bucketçš„åŒ—äº¬åŒºåŸŸS3å­˜å‚¨æ¡¶æŒ‚è½½åˆ°æœ¬åœ°ç›®å½•/home/ec2-user/s3mntä¸‹ï¼Œå¹¶å…è®¸å…¶å®ƒæ“ä½œç³»ç»Ÿç”¨æˆ·(érootç”¨æˆ·)è®¿é—®ã€‚ 1 /usr/local/bin/s3fs#s3fs-mount-bucket /home/ec2-user/s3mnt fuse allow_other,url=http://s3.cn-north-1.amazonaws.com.cn,endpoint=cn-north-1 0 0 å±€é™æ€§ åˆ©ç”¨S3fså¯ä»¥æ–¹ä¾¿çš„æŠŠS3å­˜å‚¨æ¡¶æŒ‚è½½åœ¨ç”¨æˆ·æœ¬åœ°æ“ä½œç³»ç»Ÿç›®å½•ä¸­ï¼Œä½†æ˜¯ç”±äºS3fså®é™…ä¸Šæ˜¯ä¾æ‰˜äºAmazon S3æœåŠ¡æä¾›çš„ç›®å½•è®¿é—®æ¥å£ï¼Œæ‰€ä»¥ä¸èƒ½ç®€å•çš„æŠŠS3fsæŒ‚è½½çš„ç›®å½•å’Œæœ¬åœ°æ“ä½œç³»ç»Ÿç›®å½•ç­‰åŒä½¿ç”¨ã€‚ç”¨æˆ·ä½¿ç”¨S3f3æŒ‚è½½S3å­˜å‚¨æ¡¶å’Œç›´æ¥è®¿é—®S3æœåŠ¡æœ‰ç±»ä¼¼çš„ä½¿ç”¨åœºæ™¯ã€‚é€‚ç”¨äºå¯¹ä¸åŒå¤§å°æ–‡ä»¶å¯¹è±¡çš„ä¸€æ¬¡ä¿å­˜ï¼ˆä¸Šä¼ ï¼‰ï¼Œå¤šæ¬¡è¯»å–ï¼ˆä¸‹è½½ï¼‰ã€‚ä¸é€‚ç”¨äºå¯¹å·²ä¿å­˜æ–‡ä»¶ç»å¸¸åšéšæœºä¿®æ”¹ï¼Œå› ä¸ºæ¯æ¬¡åœ¨æœ¬åœ°ä¿®æ”¹å¹¶ä¿å­˜æ–‡ä»¶å†…å®¹éƒ½ä¼šå¯¼è‡´S3fsä¸Šä¼ æ–°çš„æ–‡ä»¶åˆ°Amazon S3å»æ›¿æ¢åŸæ¥çš„æ–‡ä»¶ã€‚ä»è®¿é—®æ€§èƒ½ä¸Šæ¥è¯´ï¼Œé€šè¿‡æ“ä½œç³»ç»Ÿç›®å½•æ–¹å¼é—´æ¥è®¿é—®Amazon S3å­˜å‚¨æœåŠ¡çš„æ€§èƒ½ä¸å¦‚ç›´æ¥ä½¿ç”¨SDKæˆ–CLIæ¥å£è®¿é—®æ•ˆç‡é«˜ã€‚ä»¥æœ¬åœ°é…ç½®æ–‡ä»¶æ–¹å¼ä¿å­˜è®¿é—®å¯†é’¥çš„å®‰å…¨æ€§ä¹Ÿä¸å¦‚ä½¿ç”¨EC2 IAMè§’è‰²æ–¹å¼é«˜ã€‚\nå…³äºS3fsä½¿ç”¨æ—¶å€™éœ€è¦æ³¨æ„çš„æ›´å¤šç»†èŠ‚ï¼Œè¯·å‚è€ƒä¸‹é¢s3fså®˜ç½‘å†…å®¹ï¼š\nâ€œGenerally S3 cannot offer the same performance or semantics as a local file system. More specifically:\nrandom writes or appends to files require rewriting the entire file metadata operations such as listing directories have poor performance due to network latency eventual consistency can temporarily yield stale data no atomic renames of files or directories no coordination between multiple clients mounting the same bucket no hard links â€ é€šå¸¸S3ä¸èƒ½æä¾›ä¸æœ¬åœ°æ–‡ä»¶ç³»ç»Ÿç›¸åŒçš„æ€§èƒ½æˆ–è¯­ä¹‰ã€‚è¿›ä¸€æ­¥æ¥è¯´ï¼š\néšæœºå†™å…¥æˆ–è¿½åŠ åˆ°æ–‡ä»¶éœ€è¦é‡å†™æ•´ä¸ªæ–‡ä»¶ å…ƒæ•°æ®æ“ä½œæ¯”å¦‚åˆ—å‡ºç›®å½•ä¼šå› ä¸ºç½‘ç»œå»¶è¿ŸåŸå› å¯¼è‡´æ€§èƒ½è¾ƒå·® æœ€ç»ˆä¸€è‡´æ€§è®¾è®¡å¯èƒ½ä¸´æ—¶å¯¼è‡´è¿‡æœŸæ•°æ® æ²¡æœ‰å¯¹æ–‡ä»¶æˆ–ç›®å½•çš„åŸå­é‡å‘½ååŠŸèƒ½ æŒ‚è½½ç›¸åŒå­˜å‚¨æ¡¶çš„å¤šä¸ªå®¢æˆ·ç«¯ä¹‹é—´æ²¡æœ‰ç›¸äº’åè°ƒæœºåˆ¶ ä¸æ”¯æŒç¡¬é“¾æ¥ æ€»ç»“ åˆ©ç”¨S3fså¯ä»¥æŠŠå…±äº«çš„Amazon S3å­˜å‚¨æ¡¶ç›´æ¥æŒ‚è½½åœ¨ç”¨æˆ·æœåŠ¡å™¨æœ¬åœ°ç›®å½•ä¸‹ï¼Œåº”ç”¨ä¸éœ€è¦åšä¿®æ”¹å°±å¯ä»¥ç›´æ¥ä½¿ç”¨Amazon S3å­˜å‚¨æœåŠ¡ï¼Œè¿™ç§æ–¹å¼å¯ä»¥ä½œä¸ºä¸´æ—¶è§£å†³æ–¹æ¡ˆå°†ä¼ ç»Ÿåº”ç”¨å¿«é€Ÿè¿ç§»åˆ°AWSå¹³å°ã€‚\nåœ¨å·²ç»æä¾›äº†Amazon EFSï¼ˆElastic File Systemï¼‰æœåŠ¡çš„AWSåŒºåŸŸï¼Œå»ºè®®ç”¨æˆ·ä¼˜å…ˆè€ƒè™‘ä½¿ç”¨Amazon EFSæœåŠ¡ï¼Œå› ä¸ºå®ƒå…·æœ‰æ›´é«˜çš„æ€§èƒ½ã€‚åœ¨ç›®å‰è¿˜æ²¡æœ‰æä¾›EFSæœåŠ¡çš„AWSåŒºåŸŸï¼Œç”¨æˆ·å¯ä»¥å…ˆæš‚æ—¶ä½¿ç”¨S3fså®ç°å¿«é€Ÿä¸šåŠ¡è¿ç§»ã€‚ç„¶åé€æ­¥è°ƒæ•´S3æ•°æ®è®¿é—®å®ç°æ–¹å¼ï¼Œæœ€ç»ˆä¿®æ”¹ä¸ºä½¿ç”¨AWS SDKæˆ–CLIæ–¹å¼é«˜æ•ˆå¹¶æ›´åŠ å®‰å…¨åœ°è®¿é—®S3å­˜å‚¨æœåŠ¡ã€‚\nä½œè€…ï¼šSREè¿ç»´åšå®¢\nåšå®¢åœ°å€ï¼šhttps://www.cnsre.cn\næ–‡ç« åœ°å€ï¼šhttps://www.cnsre.cn/posts/210409164113/\nç›¸å…³è¯é¢˜ï¼šhttps://www.cnsre.cn/tags/aws/\n","description":"åˆ©ç”¨S3fsåœ¨Amazon EC2 Linuxå®ä¾‹ä¸ŠæŒ‚è½½S3å­˜å‚¨æ¡¶","id":77,"section":"posts","tags":["aws","s3"],"title":"åˆ©ç”¨S3fsåœ¨Amazon EC2 Linuxå®ä¾‹ä¸ŠæŒ‚è½½S3å­˜å‚¨æ¡¶","uri":"http://www.cnsre.cn:80/posts/210409164113/"},{"content":" ä½œè€…ï¼šSREè¿ç»´åšå®¢\nåšå®¢åœ°å€ï¼šhttps://www.cnsre.cn\næ–‡ç« åœ°å€ï¼šhttps://www.cnsre.cn/posts/210408131033/\nç›¸å…³è¯é¢˜ï¼šhttps://www.cnsre.cn/tags/zabbix/\né—®é¢˜æè¿° zabbix server å¹³ç¨³è¿è¡Œæœ‰ä¸€æ®µæ—¶é—´äº†ï¼Œä½†æ˜¯æœ€è¿‘é—®é¢˜å´æ¥äº†ï¼Œä»Šå¤©æ—©ä¸Šæ”¶åˆ°zabbixserverç£ç›˜ç©ºé—´ä¸è¶³çš„å‘Šè­¦ã€‚é€šè¿‡æŸ¥çœ‹ä¹‹åå‘ç°æ˜¯å¤§éƒ¨åˆ†æ•°æ®æ˜¯zabbix åº“çš„çš„æ•°æ® åœ¨è¿›ä¸€æ­¥æŸ¥çœ‹å‘ç°æ˜¯historyè¡¨å’Œhistory_uintæ•°æ®å¤ªå¤šå¯¼è‡´ç£ç›˜å ç”¨è¿‡å¤šã€‚\né—®é¢˜åˆ†æ history_uint è¯¥è¡¨å­˜å‚¨çš„æ˜¯ç›‘æ§é¡¹çš„æ— ç¬¦å·æ•´å‹çš„æ•°æ®ã€‚\nè¯¥æ•°æ®çš„ä¿å­˜æ—¶é•¿ï¼Œå–å†³äºåœ¨ç›‘æ§é¡¹è®¾ç½®çš„ å†å²æ•°æ®ä¿ç•™æ—¶é•¿ã€‚\nhistory è¿™ä¸ªè¡¨ä¿å­˜çš„æ˜¯æµ®ç‚¹å‹çš„ã€‚\nåƒ history_str ç­‰ä¿å­˜çš„æ˜¯ å­—ç¬¦å‹æ•°æ®ã€‚è¿™äº›éƒ½æ˜¯æˆ‘ä»¬åœ¨è®¾ç½®ç›‘æ§é¡¹çš„å¯¹åº”çš„ä¿¡æ¯ç±»å‹å†³å®šçš„ã€‚\nè¯¥æ•°æ®çš„ä¿å­˜æ—¶é•¿ï¼Œå–å†³äºåœ¨ç›‘æ§é¡¹è®¾ç½®çš„ å†å²æ•°æ®ä¿ç•™æ—¶é•¿\né’ˆå¯¹è¿™ä¸ªé—®é¢˜ï¼Œæˆ‘æ‰“ç®—åˆ é™¤ history_uint å’Œ history çš„ä¸€äº›å†å²æ•°æ®ã€‚\nè¦åˆ é™¤history_uinté‡Œçš„æ•°æ®ï¼Œè¿˜éœ€è¦æ³¨æ„ä¸€ç‚¹ï¼Œç”±äºæ•°æ®é‡æ¯”è¾ƒå¤šï¼Œæˆ‘å»ºè®®å¯ä»¥åˆ†å¤šæ¬¡å°‘é‡æ•°æ®è¿›è¡Œåˆ é™¤ï¼Œå› ä¸ºæˆ‘ä¸€æ¬¡åˆ é™¤90å¤©çš„æ—¶å€™CPUå·²ç»åƒä¸æ¶ˆäº†\u0026hellip;\nè¿™æ ·å¯ä»¥é¿å…ä¸€æ¬¡æ€§åˆ é™¤æ•°æ®è¿‡å¤šå¯¼è‡´æ•°æ®åº“çš„è´Ÿè½½æ¯”è¾ƒå¤§ã€‚ï¼ˆæˆ–è€…å¯ä»¥ä½¿ç”¨limit 10000ï¼‰\nå¤„ç†è¿‡ç¨‹ æˆ‘è¿™é‡Œéœ€è¦åˆ é™¤90å¤©ä»¥å‰çš„æ•°æ®ä¸‹é¢æ˜¯æˆ‘çš„æ“ä½œè¿‡ç¨‹\nè·å–æ—¶é—´æˆ³ #é€šè¿‡å¦‚ä¸‹å‘½ä»¤è¿›è¡Œè·å–90å¤©ä»¥å‰çš„æ—¶é—´æˆ³ [root@zabbix-server ~]# date -d $(date -d \u0026#34;-90 day\u0026#34; +%Y%m%d) +%s 1590105600 ç™»å½•æ•°æ®åº“æ“ä½œ [root@zabbix-server ~]# mysql -uzabbix -p Enter password: mysql\u0026gt; use zabbix; Database changed #delete history_uint mysql\u0026gt; delete from history_uint where clock \u0026lt; 1590105600 LIMIT 10000; Query OK, 1653 rows affected (1 min 45.42 sec) #delete history mysql\u0026gt; delete from history where clock \u0026lt; 1590105600 LIMIT 10000; Query OK, 0 rows affected (24.72 sec) é‡Šæ”¾ç©ºé—´ ä¸Šé¢æ‰§è¡Œåˆ é™¤åï¼Œæ•°æ®çš„å­˜å‚¨ç©ºé—´æ˜¯æ²¡æœ‰å‡å°‘çš„ï¼Œå› ä¸ºå¯¹äºdelete from table_name where xxx å¸¦æ¡ä»¶çš„åˆ é™¤ï¼Œä¸ç®¡æ˜¯innodbè¿˜æ˜¯MyISAMéƒ½ä¸ä¼šé‡Šæ”¾ç©ºé—´ï¼Œéœ€è¦è¿›è¡ŒOPTIMIZE TABLEæ“ä½œï¼Œè¿›è¡Œé‡Šæ”¾ç©ºé—´ã€‚\næ³¨æ„ï¼šåœ¨optimize table \u0026lsquo;è¡¨å\u0026rsquo; è¿è¡Œè¿‡ç¨‹ä¸­ï¼ŒMySQLä¼šè¿›è¡Œé”è¡¨ã€‚\noptimize table history_uin\nmysql\u0026gt; optimize table history_uint; +---------------------+----------+----------+-------------------------------------------------------------------+ | Table | Op | Msg_type | Msg_text | +---------------------+----------+----------+-------------------------------------------------------------------+ | zabbix.history_uint | optimize | note | Table does not support optimize, doing recreate + analyze instead | | zabbix.history_uint | optimize | status | OK | +---------------------+----------+----------+-------------------------------------------------------------------+ 2 rows in set (5 min 33.76 sec) optimize table history\nmysql\u0026gt; optimize table history; +----------------+----------+----------+-------------------------------------------------------------------+ | Table | Op | Msg_type | Msg_text | +----------------+----------+----------+-------------------------------------------------------------------+ | zabbix.history | optimize | note | Table does not support optimize, doing recreate + analyze instead | | zabbix.history | optimize | status | OK | +----------------+----------+----------+-------------------------------------------------------------------+ 2 rows in set (1 min 39.51 sec) é—®é¢˜è§£å†³ å¾…ä»¥ä¸Šæ­¥éª¤éƒ½å®Œæˆä»¥åï¼Œæ£€æŸ¥ç£ç›˜å¯ä»¥çœ‹åˆ°é—®é¢˜è§£å†³ ã€‚\nä¸è¿‡æƒ³è¦ä¸€åŠ³æ°¸ç›Šçš„è¯çš„è¯ è¿˜æ˜¯éœ€è¦å†™ä¸€ä¸ªè„šæœ¬æ¥å¤„ç†è¿™ä¸ªé—®é¢˜\n#!/bin/bash User=\u0026#34;zabbix\u0026#34; Passwd=\u0026#34;zabbix\u0026#34; Date=`date -d $(date -d \u0026#34;-90 day\u0026#34; +%Y%m%d) +%s` $(which mysql) -u${User} -p${Passwd} -e \u0026#34; use zabbix; DELETE FROM history WHERE \u0026#39;clock\u0026#39; \u0026lt; \u0026#39;$Date\u0026#39; LIMIT 10000; optimize table history; DELETE FROM history_str WHERE \u0026#39;clock\u0026#39; \u0026lt; \u0026#39;$Date\u0026#39; LIMIT 10000; optimize table history_str; DELETE FROM history_uint WHERE \u0026#39;clock\u0026#39; \u0026lt; \u0026#39;$Date\u0026#39; LIMIT 10000; optimize table history_uint; DELETE FROM history_text WHERE \u0026#39;clock\u0026#39; \u0026lt; $Date\u0026#39; LIMIT 10000; optimize table history_text; DELETE FROM trends WHERE \u0026#39;clock\u0026#39; \u0026lt; \u0026#39;$Date\u0026#39; LIMIT 10000; optimize table trends; DELETE FROM trends_uint WHERE \u0026#39;clock\u0026#39; \u0026lt; \u0026#39;$Date\u0026#39; LIMIT 10000; optimize table trends_uint; DELETE FROM events WHERE \u0026#39;clock\u0026#39; \u0026lt; \u0026#39;$Date\u0026#39; LIMIT 10000; optimize table events; \u0026#34; å¦å¤–å†å²æ•°æ®è¿‡å¤šæ˜¯ç”±äºæˆ‘ä»¬ä¿å­˜çš„å†å²æ•°æ®çš„æ—¶é—´æ‰€è‡´ï¼Œæˆ‘ä»¬å¯ä»¥æ ¹æ®éœ€æ±‚è®¾ç½®å†å²æ•°æ®çš„ä¿ç•™æ—¶é•¿ï¼Œä¾‹å¦‚ä¸€äº›ç›¸å¯¹ä¸å¤ªé‡è¦çš„æ•°æ®ï¼Œæˆ‘ä»¬å¯ä»¥å°†è¯¥å€¼è®¾ç½®çš„æ›´çŸ­ä¸€äº›ï¼Œè¿™æ ·æ•°æ®é‡ä¹Ÿå°±éšç€å‡å°‘äº†ã€‚\nä½œè€…ï¼šSREè¿ç»´åšå®¢\nåšå®¢åœ°å€ï¼šhttps://www.cnsre.cn\næ–‡ç« åœ°å€ï¼šhttps://www.cnsre.cn/posts/210408131033/\nç›¸å…³è¯é¢˜ï¼šhttps://www.cnsre.cn/tags/zabbix/\n","description":"zabbixæ•°æ®åº“historyè¡¨å’Œhistory_uintæ•°æ®å¤ªå¤šå¯¼è‡´ç£ç›˜å ç”¨è¿‡å¤š","id":78,"section":"posts","tags":["zabbix","æ•…éšœé›†"],"title":"Zabbixå†å²æ•°æ®å¤„ç†","uri":"http://www.cnsre.cn:80/posts/210408131033/"},{"content":" ä½œè€…ï¼šSREè¿ç»´åšå®¢\nåšå®¢åœ°å€ï¼šhttps://www.cnsre.cn\næ–‡ç« åœ°å€ï¼šhttps://www.cnsre.cn/posts/210406154942/\nç›¸å…³è¯é¢˜ï¼šhttps://www.cnsre.cn/tags/zabbix/\nserverç«¯æ“ä½œ æ‰¾ä¸€ä¸ªå®‰è£…æœ‰agent çš„server è¿›è¡Œä¸€ä¸‹æ“ä½œ\nå®‰è£…æ‰€éœ€ç»„ä»¶ 1 2 3 4 5 6 yum install bc gcc gcc-c++ -y # å®‰è£…openssl yum install openssl -y # éªŒè¯openssl root@elk scripts]openssl version OpenSSL 1.0.2k-fips 26 Jan 2017 è„šæœ¬å†…å®¹ 1 2 3 4 5 6 7 8 9 10 11 12 #!/bin/sh host=$1 end_date=`openssl s_client -servername $host -host $host -port 443 -showcerts \u0026lt;/dev/null 2\u0026gt;/dev/null | sed -n \u0026#39;/BEGIN CERTIFICATE/,/END CERT/p\u0026#39; | openssl x509 -text 2\u0026gt;/dev/null | sed -n \u0026#39;s/ *Not After : *//p\u0026#39;` if [ -n \u0026#34;$end_date\u0026#34; ] then end_date_seconds=`date \u0026#39;+%s\u0026#39; --date \u0026#34;$end_date\u0026#34;` now_seconds=`date \u0026#39;+%s\u0026#39;` echo \u0026#34;($end_date_seconds-$now_seconds)/24/3600\u0026#34; | bc fi éªŒè¯è„šæœ¬ 1 2 3 4 5 # èµ‹æ‰§è¡Œæƒé™ [root@bac scripts] chmod +x check_ssl.sh [root@elk scripts]./check_ssl.sh xxxx-xxxx.cn 565 #å•ä½ä¸ºå¤© zabbix é…ç½®æ–‡ä»¶ä¸­æ·»åŠ é…ç½® 1 2 [root@elk scripts]cat /etc/zabbix/zabbix_agentd.conf |grep ssl UserParameter=check.ssl[*],/etc/zabbix/scripts/check_ssl.sh $1ã€ é‡å¯zabbix agent 1 systemctl restart zabbix-agent webç«¯æ“ä½œ åˆ›å»ºç›‘æ§é¡¹ ç™»å½•zabbix åˆ›å»ºæ–°çš„ç›‘æ§é¡¹\nåç§°ï¼šéšæ„å¡«å†™ ç±»å‹ï¼šZabbix å®¢æˆ·ç«¯ é”®å€¼ï¼šæ·»åŠ åœ¨é…ç½®æ–‡ä»¶ä¸­çš„check.ssl[*] *ä¸ºä½ çš„åŸŸå æ›´æ–°é—´éš”å› ä¸ºè¯ä¹¦ä¸éœ€è¦åšå®æ—¶çš„æ£€æŸ¥ æ‰€ä»¥æ—¶é—´å¯ä»¥è®¾ç½®é•¿ä¸€ç‚¹ï¼ˆ12hæˆ–è€…24hï¼‰ æ£€æŸ¥åˆ›å»ºç›‘æ§é¡¹æ˜¯å¦ç”Ÿæ•ˆ\nåˆ›å»ºå®Œæˆä»¥åå¯ä»¥åœ¨æ£€æµ‹\u0026ndash;æœ€æ–°æ•°æ®ä¸­æŸ¥çœ‹ç›‘æ§é¡¹\nåˆ›å»ºè§¦å‘å™¨ ç›‘æ§é¡¹æœ‰äº† æ¥ä¸‹æ¥åˆ›å»ºè§¦å‘å™¨\nåˆ›å»ºå®Œæ¯• æ¥æµ‹è¯•ä¸‹å‘Šè­¦\næŠŠé˜ˆå€¼è°ƒä¸º600 å¤©æ¥æµ‹è¯•ä¸‹å‘Šè­¦\nå› ä¸ºæˆ‘ä»¬æŠŠæ›´æ–°é—´éš”è°ƒçš„æ—¶é—´æ¯”è¾ƒé•¿ æ‰€ä»¥æˆ‘ä»¬ä¸ºäº†å¿«é€ŸéªŒè¯å‘Šè­¦å¯ä»¥è°ƒå°\nè¿™ä¸ªæ—¶å€™æˆ‘ä»¬å¯ä»¥çœ‹åˆ°å‘Šè­¦ä¿¡æ¯\nåˆ°è¿™SSL è¯ä¹¦ç›‘æ§å‘Šè­¦å·²ç»å®Œæˆ çœ‹åˆ°å‘Šè­¦ä¿¡æ¯ä¹‹åè®°å¾—é˜ˆå€¼è°ƒå›æ¥ ä½œè€…ï¼šSREè¿ç»´åšå®¢\nåšå®¢åœ°å€ï¼šhttps://www.cnsre.cn\næ–‡ç« åœ°å€ï¼šhttps://www.cnsre.cn/posts/210406154942/\nç›¸å…³è¯é¢˜ï¼šhttps://www.cnsre.cn/tags/zabbix/\n","description":"zabbix ç›‘æ§sslåŸŸåè¯ä¹¦ï¼Œåˆ°æœŸåè‡ªåŠ¨å‘Šè­¦é€šçŸ¥ã€‚","id":79,"section":"posts","tags":["sslè¯ä¹¦","zabbix"],"title":"zabbix ç›‘æ§åŸŸåè¯ä¹¦åˆ°æœŸæ—¶é—´","uri":"http://www.cnsre.cn:80/posts/210406154942/"},{"content":" ä½œè€…ï¼šSREè¿ç»´åšå®¢\nåšå®¢åœ°å€ï¼š https://www.cnsre.cn/\næ–‡ç« åœ°å€ï¼šhttps://www.cnsre.cn/posts/210406132721/\nç›¸å…³è¯é¢˜ï¼šhttps://www.cnsre.cn/tags/zabbix/\nç¯å¢ƒä»‹ç» zabbixç‰ˆæœ¬ï¼šZabbix 4.2.6\nzabbix serverï¼š10.0.10.234\nzabbix-agentï¼š16å° Linux 7.xè®¾å¤‡\nè‡ªåŠ¨å‘ç° è‡ªåŠ¨å‘ç°çš„å¥½å¤„ï¼šå¿«é€Ÿå‘ç°ï¼Œå¹¶è‡ªåŠ¨æ·»åŠ ä¸»æœºï¼Œçœå»ç®¡ç†å‘˜é…ç½®çš„éº»çƒ¦ã€‚\nè‡ªåŠ¨å‘ç°çš„åŸç†ï¼šè‡ªåŠ¨å‘ç°åŠŸèƒ½æ˜¯åŸºäºIPæ®µè¿›è¡Œæ‰«ææ·»åŠ åˆ©ç”¨SNMPåè®®æ¥æ¥æ”¶æ¶ˆæ¯å®ç°è‡ªåŠ¨æ·»åŠ \nè‡ªåŠ¨æ³¨å†Œ è‡ªåŠ¨æ³¨å†Œçš„ç›¸è¾ƒäºè‡ªåŠ¨å‘ç°çš„æœ‰ç‚¹å°±åœ¨äºèŠ‚çœzabbix-serverçš„èµ„æº\nè‡ªåŠ¨æ³¨å†Œä¹Ÿå°±æ˜¯è¢«åŠ¨å‘ç°ï¼Œç­‰ç€ä¸šåŠ¡æœºå™¨æ¥æ‰¾zabbix serveræ³¨å†Œï¼Œè‡ªåŠ¨æ³¨å†Œçš„åŸç†: è‡ªåŠ¨æ³¨å†Œä¼šæ ¹æ®hostè¿›è¡ŒåŒ¹é…,å°†ç¬¦åˆæ¡ä»¶çš„æœºå™¨æ‰§è¡ŒåŠ¨ä½œ\næœ¬æ–‡é‡‡ç”¨è‡ªåŠ¨æ³¨å†Œçš„æ–¹å¼åšä¸ºç¤ºä¾‹ã€‚\nLinux æœåŠ¡å™¨ç«¯æ“ä½œ agent rpm å®‰è£…åŒ… ç‚¹å‡»ä¸‹è½½ zabbix-agent-4.2.6-1.el7.x86_64.rpm\nå®‰è£…è„šæœ¬ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 #!/bin/bash RD=\u0026#34;\\033[31m\u0026#34; # é”™è¯¯æ¶ˆæ¯ GR=\u0026#34;\\033[32m\u0026#34; # æˆåŠŸæ¶ˆæ¯ YL=\u0026#34;\\033[33m\u0026#34; # å‘Šè­¦æ¶ˆæ¯ BL=\u0026#34;\\033[36m\u0026#34; # æ—¥å¿—æ¶ˆæ¯ PL=\u0026#39;\\033[0m\u0026#39; echo \u0026#34;#############################################################################\u0026#34; echo -e \u0026#34;# ä¸€é”®å®‰è£… zabbix-agent4.2.6è„šæœ¬ #\u0026#34; echo -e \u0026#34;# ${GR}ä½œè€…${PL}: sreè¿ç»´åšå®¢ #\u0026#34; echo -e \u0026#34;# ${GR}ç½‘å€${PL}: https:www.cnsre.cn #\u0026#34; echo -e \u0026#34;# ${GR}æ–‡ç« åœ°å€${PL}: https://www.cnsre.cn/posts/210406132721/ #\u0026#34; echo \u0026#34;#############################################################################\u0026#34; server_ip=$1 VALID_CHECK=$(echo $server_ip|awk -F. \u0026#39;$1\u0026lt;=255\u0026amp;\u0026amp;$2\u0026lt;=255\u0026amp;\u0026amp;$3\u0026lt;=255\u0026amp;\u0026amp;$4\u0026lt;=255{print \u0026#34;yes\u0026#34;}\u0026#39;) if echo $server_ip|grep -E \u0026#34;^[0-9]{1,3}\\.[0-9]{1,3}\\.[0-9]{1,3}\\.[0-9]{1,3}$\u0026#34;\u0026gt;/dev/null; then if [ $VALID_CHECK == \u0026#34;yes\u0026#34; ]; then echo -e \u0026#34;$GR æ‚¨çš„zabbix server IP åœ°å€ä¸ºï¼š$server_ip $PL\u0026#34; else echo -e \u0026#34;$GR æ‚¨çš„zabbix server IP $server_ip ä¸å¯ç”¨!$PL\u0026#34; fi else echo -e \u0026#34;$RD è¯·è¾“å…¥zabbix server IPåœ°å€! $PL\u0026#34; echo -e \u0026#34;$RD å¦‚ï¼šsh $0 192.168.10.100 $PL\u0026#34; exit 1 fi echo -e \u0026#34;$YL æ˜¯å¦ç¡®å®šå®‰è£… zabbix 4.2.6 ç‰ˆæœ¬?$PL\u0026#34; read -r -p \u0026#34;ç¡®å®šè¯·æŒ‰ y ä»»æ„é”®åˆ™é€€å‡ºï¼è¯·é€‰æ‹©ï¼š[y/n]\u0026#34; input if [[ $input != \u0026#34;y\u0026#34; ]]; then exit 1 else echo -e \u0026#34;$GR å¼€å§‹å®‰è£… zabbix-agent 4.2.6 ç‰ˆæœ¬$PL\u0026#34; fi #å®šä¹‰å˜é‡ IP=$(ip addr | grep -E -o \u0026#39;[0-9]{1,3}\\.[0-9]{1,3}\\.[0-9]{1,3}\\.[0-9]{1,3}\u0026#39; | grep -E -v \u0026#34;^127\\.|^255\\.|^0\\.\u0026#34; | head -n 1) checkwget=`rpm -qa wget` if [ -z $checkwget ];then yum install wget -y fi echo -e \u0026#34;$GR ä¸‹è½½zabbix-agent$PL\u0026#34; sleep 0.5 wget http://repo.zabbix.com/zabbix/4.2/rhel/7/x86_64/zabbix-agent-4.2.6-1.el7.x86_64.rpm rpm -ivh zabbix-agent-4.2.6-1.el7.x86_64.rpm rm -rf zabbix-agent-4.2.6-1.el7.x86_64.rpm echo -e \u0026#34;$GR å¤‡ä»½agent.confé…ç½®æ–‡ä»¶$PL\u0026#34; sleep 0.5 mv /etc/zabbix/zabbix_agentd.conf /etc/zabbix/zabbix_agentd.conf.bak touch /etc/zabbix/zabbix_agentd.conf echo -e \u0026#34;$GR æ­£åœ¨å†™å…¥é…ç½®æ–‡ä»¶$PL\u0026#34; sleep 0.5 cat \u0026gt;\u0026gt; /etc/zabbix/zabbix_agentd.conf \u0026lt;\u0026lt; EOF PidFile=/var/run/zabbix/zabbix_agentd.pid LogFile=/var/log/zabbix/zabbix_agentd.log LogFileSize=1 DebugLevel=3 Server=$server_ip ListenPort=10050 ServerActive=$server_ip Include=/etc/zabbix/zabbix_agentd.d/ Hostname=$IP HostMetadata=zabbix.bsh EOF echo -e \u0026#34;$GR å¯åŠ¨zabbix-agentæœåŠ¡$PL\u0026#34; systemctl start zabbix-agent \u0026amp;\u0026amp; systemctl enable zabbix-agent zabbixagentpid=`ps -ef |grep zabbix_agentd|grep -w \u0026#39;zabbix_agentd\u0026#39;|grep -v \u0026#39;grep\u0026#39;|awk \u0026#39;{print $2}\u0026#39;` if [ \u0026#34;$zabbixagentpid\u0026#34; ];then echo -e \u0026#34;$GR zabbix-agent å·²ç»è¿è¡Œ $PL\u0026#34; else echo \u0026#34;$RD zabbix agent å®‰è£…å¤±è´¥ï¼$PL\u0026#34; fi WEB é¡µé¢æ“ä½œ é…ç½®\u0026ndash;åŠ¨ä½œ\u0026ndash;äº‹ä»¶æºé€‰æ‹©ä¸ºè‡ªåŠ¨æ³¨å†Œ\u0026ndash;åˆ›å»ºåŠ¨ä½œ\nè®¾ç½®è‡ªåŠ¨æ³¨å†Œçš„è§„åˆ™\næˆ‘è¿™é‡Œè®¾ç½®ä¸»æœºåç§°ä¸ºåŒ…å«10çš„åˆ™æ·»åŠ æ³¨å†Œï¼Œå› ä¸ºæˆ‘çš„ä¸»æœºåœ°å€æ®µéƒ½æ˜¯åœ¨10æ®µçš„\nç„¶ååç­‰ä¸»æœºä¸Šçº¿\næ”¶åˆ°æé†’åæ‰“å¼€ä¸»æœºåˆ—è¡¨æŸ¥çœ‹è‡ªåŠ¨æ³¨å†Œä¸Šæ¥çš„ä¸»æœº\nçœ‹åˆ°å·²ç»æ³¨å†Œä¸Šæ¥çš„ä¸»æœº\næ–‡ç« é“¾æ¥\nhttps://www.cnsre.cn/posts/210406132721/\nä½œè€…ï¼šSREè¿ç»´åšå®¢\nåšå®¢åœ°å€ï¼š https://www.cnsre.cn/\næ–‡ç« åœ°å€ï¼šhttps://www.cnsre.cn/posts/210406132721/\nç›¸å…³è¯é¢˜ï¼šhttps://www.cnsre.cn/tags/zabbix/\n","description":"zabbix æ‰¹é‡å®‰è£…ï¼Œè‡ªåŠ¨æ³¨å†Œã€‚å¿«é€Ÿé…ç½®ï¼ŒèŠ‚çœç®¡ç†å‘˜æ—¶é—´ã€‚","id":80,"section":"posts","tags":["zabbix"],"title":"zabbix æ‰¹é‡å®‰è£… è‡ªåŠ¨æ³¨å†Œ","uri":"http://www.cnsre.cn:80/posts/210406132721/"},{"content":" ä½œè€…ï¼šSREè¿ç»´åšå®¢\nåšå®¢åœ°å€ï¼šhttps://www.cnsre.cn\næ–‡ç« åœ°å€ï¼šhttps://www.cnsre.cn/posts/210402140228/\nç›¸å…³è¯é¢˜ï¼šhttps://www.cnsre.cn/tags/å›¾åºŠ/\nä½¿ç”¨github+jsdelivræ­å»ºç¨³å®šçš„å…è´¹ä¸ªäººå›¾åºŠ\u0026quot; ä»‹ç» æƒ³æ­å»ºä¸ªäººåšå®¢ï¼Œä½†æ˜¯å¯¹æ¯”äº†å‡ å®¶å›¾åºŠï¼Œè§‰å¾—è¦ä¸æ˜¯ä¸ç¨³å®šï¼Œè¦ä¸å°±æ˜¯ä¸æ”¯æŒhttpsè¦ä¸å°±æ˜¯æ”¶è´¹ï¼Œæƒ³è·å–å…è´¹å›¾åºŠï¼Ÿè·Ÿæˆ‘æ¥å§ã€‚\nä¸ºäº†é¿å…å„ä½æœ‹å‹å†æ¬¡è¸©å‘æˆ‘å°†æˆ‘ä½¿ç”¨è¿‡çš„å›¾åºŠåˆ—å‡ºæ¥\nä¸ƒç‰›äº‘ æ³¨å†Œè®¤è¯åæœ‰10Gæ°¸ä¹…å…è´¹ç©ºé—´ï¼Œæ¯æœˆ10Gå›½å†…å’Œ10Gå›½å¤–æµé‡ã€‚ æœ‰å…è´¹sslè¯ä¹¦ï¼Œä½†httpsæµé‡æ”¶è´¹ã€‚ ä¸ƒç‰›äº‘30å¤©åä¼šå›æ”¶æµ‹è¯•åŸŸåï¼Œéœ€è¦ç»‘å®šå·²å¤‡æ¡ˆçš„åŸŸåã€‚ åˆæ‹äº‘ æ³¨å†Œè®¤è¯åæœ‰10Gæ°¸ä¹…å…è´¹ç©ºé—´ï¼Œæ¯æœˆ15Gçš„HTTPå’ŒHTTPSæµé‡ æä¾›ä¸¤æ¬¾å¯ä»¥å…è´¹ç»­æœŸçš„SSLè¯ä¹¦ éœ€è¦åœ¨ç½‘ç«™åº•éƒ¨æ·»åŠ åˆæ‹äº‘logoåŠå®˜ç½‘é“¾æ¥ é»˜è®¤æµ‹è¯•åŸŸåä¸ºhttpï¼Œæƒ³è¦ç”¨httpséœ€è¦ç»‘å®šè‡ªå·±çš„å·²å¤‡æ¡ˆåŸŸåã€‚ SM.MS æ°¸ä¹…å­˜å‚¨å…æ³¨å†Œã€‚ å›¾ç‰‡é“¾æ¥æ”¯æŒhttpsã€‚ å›½å†…è®¿é—®é€Ÿåº¦ç¼“æ…¢ã€‚ æ¯ä¸ªå›¾ç‰‡æœ€å¤§5Mï¼Œæ¯æ¬¡æœ€å¤šä¸Šä¼ 10å¼ ã€‚ è…¾è®¯ã€é˜¿é‡Œç­‰äº‘ã€‚ ä¸€å¼€å§‹å…è´¹ï¼ˆå…è´¹è¯•ç”¨6ä¸ªæœˆï¼‰ æ—¶é—´ã€æµé‡ã€ç©ºé—´å¤§å°å‡æœ‰é™åˆ¶ å°ä¼—å›¾åºŠå‚å•† æ‹…å¿ƒè·‘è·¯å•Š\u0026hellip; ç»è¿‡ä¸Šè¾¹çš„å¯¹æ¯”å’Œè¸©å‘ä¹‹åï¼Œæœ€åè¿˜æ˜¯å†³å®šå…è´¹è·å–ä¸€ä¸ªç¨³å®šã€å…è´¹ã€è®¿é—®å¿«é€Ÿçš„å›¾åºŠã€‚\nä½¿ç”¨Github+jsdelivråˆ©ç”¨Githubçš„å…è´¹å’Œjsdelivrçš„CNDåŠ é€Ÿè®¿é—®ã€‚åœ¨åŠ ä¸Šå¼€æºé¡¹ç›® PicGoå·¥å…·ä¸€é”®ä¸Šä¼ ï¼Œç®€ç›´äº†ã€‚ç¨³å®šæ€§æ–¹é¢Githubå’Œjsdelivréƒ½æ˜¯å¤§å‚ï¼Œä¸ç”¨æ‹…å¿ƒè·‘è·¯çš„é—®é¢˜ï¼Œæ›´ä¸ç”¨æ‹…å¿ƒå®¹é‡å’Œé€Ÿåº¦çš„é—®é¢˜ã€‚æ‰€ä»¥ï¼Œå…è´¹è·å–å¼€å§‹ã€‚\næ–°å»ºGitHubä»“åº“ ç™»å½•ï¼ˆæ²¡æœ‰è´¦å·å°±æ³¨å†Œï¼‰GitHubï¼Œæ–°å»ºä¸€ä¸ªä»“åº“ã€‚\nåˆ›å»ºtoken åœ¨ä¸»é¡µä¾æ¬¡é€‰æ‹©Settings-Developer settings-Personal access tokens-Generate new tokenï¼Œå¡«å†™å¥½æè¿°ï¼Œå‹¾é€‰repoï¼Œç„¶åç‚¹å‡»Generate tokenç”Ÿæˆä¸€ä¸ªTokenï¼Œæ³¨æ„Tokenåªä¼šæ˜¾ç¤ºä¸€æ¬¡\né…ç½®PicGo å‰å¾€ä¸‹è½½ PicGoï¼Œå®‰è£…å¥½åå¼€å§‹é…ç½®å›¾åºŠã€‚\nå®‰è£…ä¸åœ¨æ¼”ç¤ºï¼Œç›´æ¥é…ç½®ã€‚\nè®¾å®šä»“åº“åï¼šæŒ‰ç…§ç”¨æˆ·å/ å›¾åºŠä»“åº“åçš„æ ¼å¼å¡«å†™ è®¾å®šåˆ†æ”¯åï¼šmaster è®¾å®šTokenï¼šç²˜è´´ä¹‹å‰ç”Ÿæˆçš„Token æŒ‡å®šå­˜å‚¨è·¯å¾„ï¼šå¡«å†™æƒ³è¦å‚¨å­˜çš„è·¯å¾„ï¼Œå¦‚zops/ï¼Œè¿™æ ·å°±ä¼šåœ¨ä»“åº“ä¸‹åˆ›å»ºä¸€ä¸ªåä¸º zopsçš„æ–‡ä»¶å¤¹ï¼Œå›¾ç‰‡å°†ä¼šå‚¨å­˜åœ¨æ­¤æ–‡ä»¶å¤¹ä¸­ è®¾å®šè‡ªå®šä¹‰åŸŸåï¼šå®ƒçš„ä½œç”¨æ˜¯ï¼Œåœ¨å›¾ç‰‡ä¸Šä¼ åï¼ŒPicGoä¼šæŒ‰ç…§ è‡ªå®šä¹‰åŸŸå+å‚¨å­˜è·¯å¾„+ä¸Šä¼ çš„å›¾ç‰‡å çš„æ–¹å¼ç”Ÿæˆè®¿é—®é“¾æ¥ï¼Œæ”¾åˆ°ç²˜è´´æ¿ä¸Šã€‚\nå› ä¸ºæˆ‘ä»¬è¦ä½¿ç”¨ jsDelivr åŠ é€Ÿè®¿é—®ï¼Œæ‰€ä»¥å¯ä»¥è®¾ç½®ä¸ºhttps://cdn.jsdelivr.net/gh/ç”¨æˆ·å/å›¾åºŠä»“åº“å ï¼Œä¸Šä¼ å®Œæ¯•åï¼Œæˆ‘ä»¬å°±å¯ä»¥é€šè¿‡https://cdn.jsdelivr.net/gh/ç”¨æˆ·å/å›¾åºŠä»“åº“å/å›¾ç‰‡è·¯å¾„åŠ é€Ÿè®¿é—®æˆ‘ä»¬çš„å›¾ç‰‡äº†ï¼Œæ¯”å¦‚ï¼šhttps://cn-north-1-image.s3.cn-north-1.amazonaws.com.cn/cnsre/cnsre/20210107112646.png PicGoæ›´å¤šåŠŸèƒ½ PicGoæ˜¯ä¸€ä¸ªå¼€æºçš„å·¥å…·è®¾ç½®å¥½åï¼Œèƒ½å¤Ÿä¸€é”®ä¸Šä¼ å¤åˆ¶URLã€htmlã€markdownã€UBBç­‰è¿æ¥ç”šè‡³å¯ä»¥è‡ªå®šä¹‰è¿æ¥ã€‚æ­¤å¤–PicGoè¿˜æœ‰ç›¸å†ŒåŠŸèƒ½ï¼Œå¯ä»¥å¯¹å·²ä¸Šä¼ çš„å›¾ç‰‡è¿›è¡Œåˆ é™¤ï¼Œä¿®æ”¹é“¾æ¥ç­‰å¿«æ·æ“ä½œï¼ŒPicGoè¿˜å¯ä»¥ç”Ÿæˆä¸åŒæ ¼å¼çš„é“¾æ¥ã€æ”¯æŒæ‰¹é‡ä¸Šä¼ ã€å¿«æ·é”®ä¸Šä¼ ã€è‡ªå®šä¹‰é“¾æ¥æ ¼å¼ã€ä¸Šä¼ å‰é‡å‘½åç­‰ï¼Œæ›´å¤šåŠŸèƒ½è‡ªå·±å»æ¢ç´¢å§ï¼\nä½œè€…ï¼šSREè¿ç»´åšå®¢\nåšå®¢åœ°å€ï¼šhttps://www.cnsre.cn\næ–‡ç« åœ°å€ï¼šhttps://www.cnsre.cn/posts/210402140228/\nç›¸å…³è¯é¢˜ï¼šhttps://www.cnsre.cn/tags/å›¾åºŠ/\n","description":"æƒ³è·å–å…è´¹å›¾åºŠï¼Ÿgithub+jsdelivråˆ›å»ºå…è´¹ç¨³å®šçš„ä¸ªäººå›¾åºŠã€‚","id":81,"section":"posts","tags":["å›¾åºŠ","jsdelivr","github","å›¾åºŠ"],"title":"ä½¿ç”¨github+jsdelivræ­å»ºå…è´¹ç¨³å®šçš„ä¸ªäººå›¾åºŠ","uri":"http://www.cnsre.cn:80/posts/210402140228/"},{"content":" ä½œè€…ï¼šSREè¿ç»´åšå®¢\nåšå®¢åœ°å€ï¼šhttps://www.cnsre.cn\næ–‡ç« åœ°å€ï¼šhttps://www.cnsre.cn/posts/210401140104/\nç›¸å…³è¯é¢˜ï¼šhttps://www.cnsre.cn/tags/æ•…éšœé›†/\nSystemd Journaldå ç”¨èµ„æºè¿‡å¤š journaldå ç”¨è¿‡å¤šç£ç›˜ç©ºé—´ æ–¹æ³•ä¸€ æ£€æŸ¥å½“å‰journalä½¿ç”¨ç£ç›˜é‡\njournalctl --disk-usage æ¸…ç†æ–¹æ³•å¯ä»¥é‡‡ç”¨æŒ‰ç…§æ—¥æœŸæ¸…ç†ï¼Œæˆ–è€…æŒ‰ç…§å…è®¸ä¿ç•™çš„å®¹é‡æ¸…ç†ï¼Œåªä¿å­˜2å¤©çš„æ—¥å¿—ï¼Œæœ€å¤§500M\njournalctl --vacuum-time=2d journalctl --vacuum-size=500M è¦å¯ç”¨æ—¥å¿—é™åˆ¶æŒä¹…åŒ–é…ç½®ï¼Œå¯ä»¥ä¿®æ”¹\nvim /etc/systemd/journald.conf SystemMaxUse=16M ForwardToSyslog=no é‡å¯\nsystemctl restart systemd-journald.service æ£€æŸ¥journalæ˜¯å¦è¿è¡Œæ­£å¸¸ä»¥åŠæ—¥å¿—æ–‡ä»¶æ˜¯å¦å®Œæ•´æ— æŸå\njournalctl --verify æ–¹æ³•äºŒ ä¸¢å¼ƒæ—¥å¿—\næŠŠStorageæ”¹ä¸ºnone\nvim /etc/systemd/journald.conf Storage=none é‡å¯ç”Ÿæ•ˆ\nsystemctl restart systemd-journald journald.confå‚æ•°è¯¦è§£ [Journal] #æ—¥å¿—å­˜å‚¨åˆ°ç£ç›˜ Storage=persistent #å‹ç¼©æ—¥å¿— Compress=yes #ä¸ºæ—¥å¿—æ·»åŠ åºåˆ—å· Seal=yes #æ¯ä¸ªç”¨æˆ·åˆ†åˆ«è®°å½•æ—¥å¿— SplitMode=uid #æ—¥å¿—åŒæ­¥åˆ°ç£ç›˜çš„é—´éš”ï¼Œé«˜çº§åˆ«çš„æ—¥å¿—ï¼Œå¦‚ï¼šCRITã€ALERTã€EMERG ä¸‰ç§æ€»æ˜¯å®æ—¶åŒæ­¥ SyncIntervalSec=1m #å³åˆ¶æ—¥å¿—çš„æœ€å¤§æµé‡ï¼Œæ­¤å¤„æŒ‡ 30s å†…æœ€å¤šè®°å½• 100000 æ¡æ—¥å¿—ï¼Œè¶…å‡ºçš„å°†è¢«ä¸¢å¼ƒ RateLimitInterval=30s #ä¸ RateLimitInterval é…åˆä½¿ç”¨ RateLimitBurst=100000 #é™åˆ¶å…¨éƒ¨æ—¥å¿—æ–‡ä»¶åŠ åœ¨ä¸€èµ·æœ€å¤šå¯ä»¥å ç”¨å¤šå°‘ç©ºé—´ï¼Œé»˜è®¤å€¼æ˜¯10%ç©ºé—´ä¸4Gç©ºé—´ä¸¤è€…ä¸­çš„è¾ƒå°è€… SystemMaxUse=64G #é»˜è®¤å€¼æ˜¯15%ç©ºé—´ä¸4Gç©ºé—´ä¸¤è€…ä¸­çš„è¾ƒå¤§è€… SystemKeepFree=1G #å•ä¸ªæ—¥å¿—æ–‡ä»¶çš„å¤§å°é™åˆ¶ï¼Œè¶…è¿‡æ­¤é™åˆ¶å°†è§¦å‘æ»šåŠ¨ä¿å­˜ SystemMaxFileSize=128M #æ—¥å¿—æ»šåŠ¨çš„æœ€å¤§æ—¶é—´é—´éš”ï¼Œè‹¥ä¸è®¾ç½®åˆ™å®Œå…¨ä»¥å¤§å°é™åˆ¶ä¸ºå‡† MaxFileSec=1day #æ—¥å¿—æœ€å¤§ä¿ç•™æ—¶é—´ï¼Œè¶…è¿‡æ—¶é™çš„æ—§æ—¥å¿—å°†è¢«åˆ é™¤ MaxRetentionSec=100year #æ˜¯å¦è½¬å‘ç¬¦åˆæ¡ä»¶çš„æ—¥å¿—è®°å½•åˆ°æœ¬æœºçš„å…¶å®ƒæ—¥å¿—ç®¡ç†ç³»ç»Ÿï¼Œå¦‚ï¼šrsyslog ForwardToSyslog=yes ForwardToKMsg=no #æ˜¯å¦è½¬å‘ç¬¦åˆæ¡ä»¶çš„æ—¥å¿—åˆ°æ‰€æœ‰ç™»é™†ç”¨æˆ·çš„ç»ˆç«¯ ForwardToWall=yes MaxLevelStore=debug MaxLevelSyslog=err MaxLevelWall=emerg ForwardToConsole=no #TTYPath=/dev/console #MaxLevelConsole=info #MaxLevelKMsg=notice ä½œè€…ï¼šSREè¿ç»´åšå®¢\nåšå®¢åœ°å€ï¼šhttps://www.cnsre.cn\næ–‡ç« åœ°å€ï¼šhttps://www.cnsre.cn/posts/210401140104/\nç›¸å…³è¯é¢˜ï¼šhttps://www.cnsre.cn/tags/æ•…éšœé›†/\n","description":"systemd-journaldå ç”¨èµ„æºè¿‡å¤šè§£å†³æ–¹æ³•","id":82,"section":"posts","tags":["journald","æ•…éšœé›†"],"title":"Systemd Journaldå ç”¨èµ„æºè¿‡å¤š","uri":"http://www.cnsre.cn:80/posts/210401140104/"},{"content":" ä½œè€…ï¼šSREè¿ç»´åšå®¢\nåšå®¢åœ°å€ï¼šhttps://www.cnsre.cn\næ–‡ç« åœ°å€ï¼šhttps://www.cnsre.cn/posts/210331125739/\nç›¸å…³è¯é¢˜ï¼šhttps://www.cnsre.cn/tags/æ•…éšœé›†/\nAWSåˆ›å»ºRedisé›†ç¾¤æ¨¡å¼é‡åˆ°çš„é—®é¢˜ é—®é¢˜æè¿° å‰å‡ å¤©åœ¨AWS å¹³å°åˆ›å»ºäº†Redisé›†ç¾¤æ¨¡å¼ï¼Œä½†æ˜¯é“¾æ¥é›†ç¾¤çš„æ—¶å€™å‘ç°æ— æ³•è¿æ¥ï¼Œè¿”å›ä¿¡æ¯è¶…æ—¶ã€‚\né€šè¿‡å‚æ•°ç»„åˆ›å»ºredisçš„æ—¶å€™æç¤ºæŠ¥é”™ï¼šReplication group with specified name already exists. (Service: AmazonElastiCache; Status Code: 400; Error Code: ReplicationGroupAlreadyExists; Request ID: XXX)\nåŸå›  AWS åˆ›å»ºredisé›†ç¾¤æ¨¡å¼çš„æ—¶å€™éœ€è¦ä½¿ç”¨ default.redis5.0.cluster.on å‚æ•°ç»„ã€‚\nå‡ºäºåæœŸè°ƒé…å‚æ•°çš„æƒ³æ³•ï¼Œæ‰€ä»¥æˆ‘åœ¨åˆ›å»ºé›†ç¾¤ä¹‹å‰ï¼Œå…ˆä¸€æ­¥åˆ›å»ºäº†é›†ç¾¤ä½¿ç”¨çš„å‚æ•°ç»„ã€‚é—®é¢˜å°±åœ¨è¿™ä¸ªå‚æ•°ç»„ä¸Šè¾¹ã€‚åˆ›å»ºå‚æ•°ç»„çš„æ—¶å€™åªæœ‰å‚æ•°ç»„åç§°ä»¥åŠæè¿° æ‰€ä»¥åˆ›å»ºå‚æ•°ç»„ é»˜è®¤çš„æ˜¯å•æœºæ¨¡å¼çš„å‚æ•°ç»„ï¼Œå‚æ•°ç»„é›†ç¾¤æ¨¡å¼æ˜¯æ²¡æœ‰å¼€å¯çš„ï¼Œæ‰€ä»¥ä½¿ç”¨åˆ›å»ºçš„å‚æ•°ç»„åˆ›å»ºredisé›†ç¾¤çš„æ—¶å€™ä¼šæŠ¥é”™ã€‚\nReplication group with specified name already exists. (Service: AmazonElastiCache; Status Code: 400; Error Code: ReplicationGroupAlreadyExists; Request ID: XXX)\nè§£å†³æ–¹æ³• åˆ›å»ºé›†ç¾¤å•ç‹¬ä½¿ç”¨çš„å‚æ•°ç»„ï¼Œç‚¹å‡»å‚æ•°ç»„åç§°\u0026ndash;ä¿®æ”¹å‚æ•°\u0026ndash;æ‰¾åˆ° cluster-enabled ä¿®æ”¹ä¸ºyesã€‚å‚æ•°é»˜è®¤ä¸ºno\næ¥ä¸‹æ¥åˆ›å»ºredisé›†ç¾¤å³å¯ã€‚\nå‹¾é€‰é›†ç¾¤æ¨¡å¼\nredisè®¾ç½®\né€‰æ‹©å®‰å…¨ç»„\nå¤‡ä»½ï¼Œç»´æŠ¤çª—å£ä»€ä¹ˆçš„è‡ªå·±éšæ„é€‰æ‹©ã€‚\né—®é¢˜æ€»ç»“ åœ¨åˆ›å»ºçš„æ—¶å€™ä¸å¤Ÿç»†å¿ƒï¼Œæ²¡ä»”ç»†æƒ³å…¶ä¸­çš„ç»†èŠ‚ï¼Œé»˜è®¤åˆ›å»ºçš„å‚æ•°ç»„æ˜¯ä»¥é»˜è®¤çš„å•æœºæ¨¡å¼åˆ›å»ºçš„ï¼Œå› ä¸ºå¹¶ä¸æ˜¯æ‰€æœ‰äººéƒ½éœ€è¦é›†ç¾¤æ¨¡å¼ã€‚ä½†æ˜¯å®˜ç½‘åˆæ²¡ä»”ç»†çš„ä»‹ç»è¯´é›†ç¾¤æ¨¡å¼éœ€è¦ä¿®æ”¹ï¼Œå› ä¸ºå®˜ç½‘çš„é›†ç¾¤æ¨¡å¼æ¨èçš„æ˜¯ä½¿ç”¨ default å‚æ•°ã€‚\nä½œè€…ï¼šSREè¿ç»´åšå®¢\nåšå®¢åœ°å€ï¼šhttps://www.cnsre.cn\næ–‡ç« åœ°å€ï¼šhttps://www.cnsre.cn/posts/210331125739/\nç›¸å…³è¯é¢˜ï¼šhttps://www.cnsre.cn/tags/æ•…éšœé›†/\n","description":"åœ¨aws å¹³å°åˆ›å»ºäº†Redis é›†ç¾¤æ¨¡å¼ï¼Œä½†æ˜¯é“¾æ¥é›†ç¾¤çš„æ—¶å€™å‘ç°æ— æ³•è¿æ¥ï¼Œè¿”å›ä¿¡æ¯è¶…æ—¶ã€‚","id":83,"section":"posts","tags":["aws","redis","æ•…éšœé›†"],"title":"AWSåˆ›å»ºRedisé›†ç¾¤æ¨¡å¼é‡åˆ°çš„é—®é¢˜","uri":"http://www.cnsre.cn:80/posts/210331125739/"},{"content":" ä½œè€…ï¼šSREè¿ç»´åšå®¢\nåšå®¢åœ°å€ï¼šhttps://www.cnsre.cn\næ–‡ç« åœ°å€ï¼šhttps://www.cnsre.cn/posts/210330135719/\nç›¸å…³è¯é¢˜ï¼šhttps://www.cnsre.cn/tags/kafka/\nKafkaå†…å¤–ç½‘è®¿é—® æœ¬æ–‡ä»‹ç»äº†Kafkaå†…å¤–ç½‘è®¿é—®çš„è®¾ç½®ã€‚\nkafkaçš„ä¸¤ä¸ªé…ç½®listenerså’Œadvertised.listeners listeners kafkaç›‘å¬çš„ç½‘å¡çš„ipï¼Œå‡è®¾ä½ æœºå™¨ä¸Šæœ‰ä¸¤å¼ ç½‘å¡ï¼Œå†…ç½‘192.168.0.213å’Œå¤–ç½‘101.89.163.1 å¦‚ä¸‹é…ç½®\nlisteners=PLAINTEXT://192.168.0.213:9092 é‚£ä¹ˆkafkaåªç›‘å¬å†…ç½‘ç½‘å¡ï¼Œå³åªæ¥æ”¶å†…ç½‘ç½‘å¡çš„æ•°æ®ï¼Œå¦‚æœä½ ä¸èƒ½æŠŠå¤–ç½‘ç½‘å¡æµé‡è½¬å‘åˆ°å†…ç½‘ç½‘å¡ï¼ˆä¸ºä»€ä¹ˆè¦å¼ºè°ƒè¿™ä¸€ç‚¹ï¼Œä¸‹é¢è¯´ï¼‰ï¼Œé‚£ä¹ˆkafkaå°±æ¥æ”¶ä¸åˆ°å¤–ç½‘ç½‘å¡æ•°æ®ã€‚å¦‚æœé…ç½®æˆå¤–ç½‘ipåŒç†ã€‚å½“ç„¶ä½ å¯ä»¥é…ç½®æˆ0.0.0.0ï¼Œç›‘å¬æ‰€æœ‰ç½‘å¡ã€‚\nadvertised.listeners æˆ‘ä»¬è§‚å¯Ÿkafkaçš„é…ç½®æ–‡ä»¶server.propertiesï¼Œä¼šå‘ç°é‡Œé¢è®°å½•äº†zookeeperé›†ç¾¤çš„å„ä¸ªèŠ‚ç‚¹çš„è®¿é—®åœ°å€ï¼Œä½†æ˜¯å¹¶æ²¡æœ‰è®°å½•kafkaå…„å¼ŸèŠ‚ç‚¹çš„åœ°å€ã€‚kafkaèŠ‚ç‚¹å¯åŠ¨åï¼Œä¼šå‘zookeeperæ³¨å†Œè‡ªå·±ï¼ŒåŒæ—¶ä»zookeeperä¸­è·å–å…„å¼ŸèŠ‚ç‚¹çš„åœ°å€ï¼Œä»¥ä¾¿ä¸å…„å¼ŸèŠ‚ç‚¹é€šä¿¡ã€‚\nåŒæ ·ï¼Œæˆ‘ä»¬ä½¿ç”¨å®¢æˆ·ç«¯è¿æ¥kafkaåï¼Œkafkaè¿”å›ç»™å®¢æˆ·ç«¯çš„æ˜¯é›†ç¾¤å„èŠ‚ç‚¹çš„è®¿é—®åœ°å€ï¼Œè¿™ä¸ªåœ°å€ä¹Ÿæ˜¯ä¸Šé¢è¯´çš„ä»zookeeperä¸­è·å¾—çš„åœ°å€ã€‚\nè¿™ä¸ªåœ°å€å“ªé‡Œæ¥ï¼Œå°±æ˜¯kafkaèŠ‚ç‚¹å‘zookeeperæ³¨å†Œæ—¶æä¾›çš„advertised.listenersã€‚å¦‚æœæ²¡æœ‰ï¼Œå°±ä¼šä½¿ç”¨listenersã€‚\nä¸‰ç§æƒ…æ™¯ï¼Œæ­é…ä½¿ç”¨è¿™ä¸¤ä¸ªé…ç½® åªéœ€è¦å†…ç½‘è®¿é—®kafka listeners=PLAINTEXT://192.168.0.213:9092 åªéœ€è¦å†…ç½‘è®¿é—®kafka ä½ è‚¯å®šæƒ³åˆ°äº†æœ€ç®€å•çš„ä¸€ä¸ªæ–¹æ³•ï¼Œlistenersä½¿ç”¨å¤–ç½‘ip\nlisteners=PLAINTEXT://101.89.163.1:9092 éœ€è¦å¤–ç½‘è®¿é—® å¦‚æœå®¿ä¸»æœºæœ‰å¤–ç½‘ç½‘å¡ï¼Œè¿™ä¹ˆé…å½“ç„¶æ²¡é—®é¢˜ã€‚å¦‚æœæ²¡æœ‰ï¼ˆifconfigçœ‹ä¸åˆ°å¤–ç½‘ipçš„ç½‘å¡ï¼ŒåŸºæœ¬ä¸Šå°±ä¸å­˜åœ¨è¿™ä¸ªå¤–ç½‘ç½‘å¡ï¼‰ï¼Œå¾ˆå¯èƒ½å’Œæˆ‘ä½¿ç”¨çš„çš„å®¿ä¸»æœºä¸€æ ·æ˜¯é€šè¿‡NATæ˜ å°„æˆ–è€…å•¥åŠæ³•æå‡ºæ¥çš„å¤–ç½‘ipï¼Œæ­¤æ—¶kafkaæ— æ³•ç›‘å¬è¿™ä¸ªå¤–ç½‘ipï¼ˆå› ä¸ºä¸å­˜åœ¨ï¼Œå¯åŠ¨å°±ä¼šæŠ¥é”™ï¼‰ã€‚\nè¿™æ—¶å€™å°±æ˜¯advertised.listenersçœŸæ­£å‘æŒ¥ä½œç”¨çš„æ—¶å€™äº†ã€‚ä½¿ç”¨å¦‚ä¸‹é…ç½®ï¼š\nlisteners=PLAINTEXT://192.168.0.213:9092 advertised.listeners=PLAINTEXT://101.89.163.1:9092 æ­¤æ—¶ä¸€ä¸ªå®Œæ•´çš„kafkaå®¢æˆ·ç«¯è®¿é—®æœåŠ¡ç«¯çš„æµç¨‹ï¼š\nå®¢æˆ·ç«¯è®¿é—®101.89.163.1:9092ï¼Œè¢«kafkaå®¿ä¸»æœºæ‰€åœ¨ç¯å¢ƒæ˜ å°„åˆ°å†…ç½‘192.168.0.213:9092ï¼Œè®¿é—®åˆ°äº†kafkaèŠ‚ç‚¹ï¼Œè¯·æ±‚è·å¾—kafkaæœåŠ¡ç«¯çš„è®¿é—®åœ°å€ kafkaä»zookeeperæ‹¿åˆ°è‡ªå·±å’Œå…¶ä»–å…„å¼ŸèŠ‚ç‚¹é€šè¿‡advertised.listenersæ³¨å†Œåˆ°zookeeperçš„101.89.163.1:9092ç­‰å¤–ç½‘åœ°å€ï¼Œä½œä¸ºkafkaçš„æœåŠ¡ç«¯è®¿é—®åœ°å€è¿”å›ç»™å®¢æˆ·ç«¯ å®¢æˆ·ç«¯æ‹¿è¿™äº›åœ°å€è®¿é—®kafkaé›†ç¾¤ï¼Œè¢«kafkaå®¿ä¸»æœºæ‰€åœ¨ç¯å¢ƒæ˜ å°„åˆ°å„kafkaèŠ‚ç‚¹çš„å†…ç½‘ipï¼Œè®¿é—®åˆ°äº†kafkaæœåŠ¡ç«¯\u0026hellip;\u0026hellip;å®Œç¾å¾ªç¯ ä½ å¯èƒ½ä¼šé—®å·²ç»é…ç½®äº†è®¿é—®åœ°å€ï¼Œä¸ºä»€ä¹ˆè¿˜è¦åœ¨ç¬¬ä¸€æ¬¡è®¿é—®çš„æ—¶å€™è¯·æ±‚è·å¾—kafkaçš„è®¿é—®åœ°å€ã€‚å› ä¸ºå¦‚æœæ˜¯kafkaé›†ç¾¤ï¼Œä½ å¯ä»¥é€‰æ‹©åªç»™å®¢æˆ·ç«¯é…ç½®ä¸€ä¸ªkafkaèŠ‚ç‚¹çš„åœ°å€ï¼ˆè¿™æ ·æ˜¯ä¸æ¨èçš„ï¼‰ï¼Œä½†æ˜¯å®¢æˆ·ç«¯å¿…é¡»è¦è®¿é—®é›†ç¾¤ä¸­çš„æ¯ä¸€ä¸ªèŠ‚ç‚¹ï¼Œæ‰€ä»¥å¿…é¡»é€šè¿‡è¿™ä¸ªèŠ‚ç‚¹è·å¾—é›†ç¾¤ä¸­æ¯ä¸€ä¸ªèŠ‚ç‚¹çš„è®¿é—®åœ°å€ã€‚\nå¦‚æœä¸é…ç½®advertised.listeners=PLAINTEXT://101.89.163.1:9092ï¼Œä½ ä¼šå‘ç°è™½ç„¶ä½ ç»™kafkaå®¢æˆ·ç«¯é…ç½®çš„è®¿é—®åœ°å€æ˜¯101.89.163.1:9092ï¼Œä½†æ˜¯kafkaå®¢æˆ·ç«¯è®¿é—®æ—¶æŠ¥é”™ï¼ŒæŠ¥é”™åŸå› æ˜¯Connection to node -1[192.168.0.213:9092] could not be established. Broker may not be available.ã€‚è¿™å°±æ˜¯å› ä¸ºä¸é…ç½®advertised.listenersåˆ™advertised.listenersé»˜è®¤ä½¿ç”¨listenersé…ç½®çš„åœ°å€ï¼Œå®¢æˆ·ç«¯æ‹¿åˆ°çš„å°±æ˜¯listenersé…ç½®çš„å†…ç½‘åœ°å€\nå†…å¤–ç½‘åˆ†æµ ä¸Šé¢è¯´çš„æœ‰å¤–ç½‘ipçš„æƒ…å†µï¼Œç›´æ¥é…ç½®å¤–ç½‘ipæœ‰æ²¡æœ‰é—®é¢˜å‘¢ï¼Ÿ\nå¦‚æœæ—¢è¦å†…ç½‘è®¿é—®ï¼Œåˆè¦å¤–ç½‘è®¿é—®ï¼Œæœ¬æ¥å¯ä»¥èµ°å†…ç½‘çš„æµé‡éƒ½èµ°å¤–ç½‘ç½‘å¡ï¼Œæ˜¾ç„¶ä¸åˆé€‚ï¼›è€Œä¸”æœ‰çš„ç¯å¢ƒå¯èƒ½è¢«é…ç½®æˆè¿™äº›kafkaå®¿ä¸»æœºæ˜¯æ²¡æœ‰å¤–ç½‘è®¿é—®æƒé™çš„ï¼Œå³è™½ç„¶ä»–å¯ä»¥è®¿é—®è‡ªå·±çš„å¤–ç½‘ipï¼Œä½†æ˜¯è®¿é—®ä¸äº†å…„å¼ŸèŠ‚ç‚¹çš„å¤–ç½‘ipã€‚è¿™æ—¶å€™å°±è¦é…ç½®å†…å¤–ç½‘ã€‚\né…ç½®1ï¼š\né…ç½®1 é…ç½®2 listener.security.protocol.map=INTERNAL:PLAINTEXT,EXTERNAL:PLAINTEXT listeners=INTERNAL://192.168.0.213:9092,EXTERNAL://192.168.0.213:19092 advertised.listeners=INTERNAL://192.168.0.213:9092,EXTERNAL://101.89.163.9:19092 inter.broker.listener.name=INTERNAL listener.security.protocol.map=INTERNAL:PLAINTEXT,EXTERNAL:PLAINTEXT listeners=INTERNAL://192.168.0.213:9092,EXTERNAL://101.89.163.9:19092 advertised.listeners=INTERNAL://192.168.0.213:9092,EXTERNAL://101.89.163.9:19092 inter.broker.listener.name=INTERNAL æ³¨æ„è¿™ä¸¤çš„åŒºåˆ«æ˜¯listenersçš„EXTERNALä½¿ç”¨çš„ipä¸ä¸€æ ·ï¼Œä¸€ä¸ªä½¿ç”¨å†…ç½‘ipï¼Œä¸€ä¸ªä½¿ç”¨å¤–ç½‘ipã€‚\nå¦‚æœä½ çš„kafkaå®¿ä¸»æœºæœ‰å¤–ç½‘ç½‘å¡ï¼Œåªèƒ½ç”¨å¤–ç½‘ipï¼Œè‹¥ä½¿ç”¨é…ç½®1ï¼Œkafkaé€šè¿‡listenersç›‘å¬çš„ä¸¤ä¸ªç«¯å£éƒ½æ˜¯å†…ç½‘ç½‘å¡çš„æ•°æ®ï¼Œæ— æ³•æ¥æ”¶åˆ°å¤–ç½‘ç½‘å¡æ•°æ®ï¼› å¦‚æœä½ çš„kafkaå®¿ä¸»æœºå¤–ç½‘ipæ˜¯æ˜ å°„æ¥çš„ï¼Œåªèƒ½ä½¿ç”¨å†…ç½‘ipï¼ŒåŸå› ä¹Ÿæ˜¯ä¸Šé¢è¯´è¿‡çš„ï¼Œä¸å­˜åœ¨å¤–ç½‘ç½‘å¡ï¼Œkafkaå¯åŠ¨ç›‘å¬å°±ä¼šæŠ¥é”™ï¼Œè€Œä½¿ç”¨å†…ç½‘ipæœ‰ç¯å¢ƒé…ç½®å¥½çš„è½¬å‘ï¼Œå¯ä»¥æ¥æ”¶åˆ°å¤–ç½‘ipçš„æ•°æ®ã€‚ ä½œè€…ï¼šSREè¿ç»´åšå®¢\nåšå®¢åœ°å€ï¼šhttps://www.cnsre.cn\næ–‡ç« åœ°å€ï¼šhttps://www.cnsre.cn/posts/210330135719/\nç›¸å…³è¯é¢˜ï¼šhttps://www.cnsre.cn/tags/kafka/\n","description":"kafkaçš„listenerså’Œadvertised.listenersï¼Œé…ç½®å†…å¤–ç½‘åˆ†æµ","id":84,"section":"posts","tags":["kafka"],"title":"Kafkaå†…å¤–ç½‘è®¿é—®","uri":"http://www.cnsre.cn:80/posts/210330135719/"},{"content":"Jenkins æ„å»ºJOBå¤±è´¥ é—®é¢˜æè¿° åŒäº‹åœ¨ä½¿ç”¨Jenkinsæ‰“åŒ…é¡¹ç›®çš„æ—¶å€™æŠ¥é”™\nerror:index-pack died of signal 15 fatal: index-pack failed å‡ºç°è¿™ä¸ªé—®é¢˜ï¼Œåˆæ­¥æ€€ç–‘æ˜¯æ‹‰å–ä»£ç è¶…æ—¶ï¼Œä¸ºäº†éªŒè¯è¿™ä¸ªé—®é¢˜ï¼Œæˆ‘åˆ†åˆ«åœ¨æœ¬åœ°ï¼ŒjenkinsæœåŠ¡å™¨ï¼Œå…¶ä»–æœåŠ¡å™¨åˆ†åˆ«ç”¨git æ‹‰å–ä»£ç å°è¯•ï¼Œå‘ç°æ‹‰å–ä»£ç çš„æ—¶å€™éƒ½æ˜¯éå¸¸æ…¢çš„ï¼Œè¿™ä¸ªæœ‰å¯èƒ½å’Œæˆ‘ä»¬çš„ä»£ç ä»“åœ¨å›½å¤–æœ‰å…³ç³»ã€‚\nåæ¥åœ¨ä¿®æ”¹æ‹‰å–ä»£ç æ—¶é—´åï¼Œæ„å»ºè¿˜æ˜¯å¤±è´¥ğŸ˜Ÿã€‚\né€šè¿‡åœ¨ç½‘ä¸ŠæŸ¥é˜…èµ„æ–™ï¼Œæœ€ç»ˆç¡®è®¤æ˜¯gitçš„http.postBufferé…ç½®é»˜è®¤å€¼å¤§å°çš„é—®é¢˜ï¼Œæ­¤é…ç½®æ˜¯ç”¨æ¥é™åˆ¶gitæ¨é€å¤§å°çš„ï¼Œç”±äºä»£ç é‡Œæœ‰å¤§æ–‡ä»¶å¯¼è‡´æ‹‰å–ä»£ç æ—¶postBufferæº¢å‡ºï¼Œæ‰€ä»¥éœ€è¦å¢å¤§http.postBufferçš„å€¼ã€‚\nè§£å†³æ–¹æ³• ä¿®æ”¹æ‹‰å–ä»£ç çš„æ—¶é—´ æ‰“å¼€Jenkinsæ§åˆ¶å°ï¼Œæ‰“å¼€æ„å»ºå¤±è´¥çš„JOBé€‰æ‹©é…ç½®\né€‰æ‹©æºç ç®¡ç† - - Additional Behaviours - - æ–°å¢ - - ç‚¹å‡»æœ€ä¸‹è¾¹çš„å°ä¸‰è§’ï¼Œæ‰¾åˆ°é«˜çº§çš„å…‹éš†è¡Œä¸º\nåœ¨å…‹éš†å’Œæ‹‰å–æ“ä½œçš„è¶…å¸‚æ—¶é—´ï¼ˆåˆ†é’Ÿï¼‰é€‰é¡¹ä¸­å¡«å†™è®¾ç½®è¶…æ—¶çš„æ—¶é—´\nç‚¹å‡»åº”ç”¨ - - ä¿å­˜ ä¿®æ”¹Git postBuffer åœ¨æœåŠ¡å™¨ä¸Šä½¿ç”¨å‘½ä»¤ä¿®æ”¹ï¼Œæ‰§è¡Œå‘½ä»¤æ—¶ä½¿ç”¨Jenkinsç”¨æˆ·æ‰§è¡Œ\nsu - jenkins -c \u0026ldquo;git config \u0026ndash;global http.postBuffer 524288000\u0026rdquo; éªŒè¯æ˜¯å¦ç”Ÿæ•ˆ\n[root@jenkins jenkins]# cat .gitconfig [filesystem \u0026#34;Oracle Corporation|1.8.0_222|/dev/nvme0n1p1\u0026#34;] minRacyThreshold = 4837 microseconds æ„å»ºJOBéªŒè¯ æœ€åä»æ–°æ„å»ºé¡¹ç›®ï¼Œæœ€ç‡ƒä¾¯å»ºçš„æ—¶é—´é•¿äº†ä¸€äº› ä½†æ˜¯å¥½åœ¨æ„å»ºæˆåŠŸäº†ã€‚\næ–‡ç« é“¾æ¥\nhttps://www.cnsre.cn/posts/210329141238/\n","description":"Jenkinsæ„å»ºJOBæ‹‰å»ä»£ç å¤±è´¥ error:index-pack died of signal 15","id":85,"section":"posts","tags":["jenkins","æ•…éšœé›†"],"title":"Jenkins æ„å»ºJOBå¤±è´¥","uri":"http://www.cnsre.cn:80/posts/210329141238/"},{"content":"Prometheusä»‹ç» Prometheus ç®€ä»‹ Prometheus èµ·åˆæ˜¯ SoundCloud åˆ›å»ºçš„ä¸€ä¸ªå¼€æºç³»ç»Ÿç›‘æ§æŠ¥è­¦å·¥å…·ã€‚è‡ªå…¶ 2012 å¹´å¼€åˆ›ä»¥æ¥ï¼Œä¼—å¤šå…¬å¸ã€ç»„ç»‡éƒ½é‡‡ç”¨äº† Prometheusï¼Œè¯¥é¡¹ç›®ä¹Ÿæœ‰ä¸€ä¸ªéå¸¸æ´»è·ƒçš„å¼€å‘è€…å’Œç”¨æˆ·ç¤¾åŒºã€‚Prometheus äº 2016 å¹´åŠ å…¥äº† CNCFï¼Œæˆä¸ºäº†ç»§ Kubernetes ä¹‹åçš„ç¬¬äºŒä¸ªæ‰˜ç®¡é¡¹ç›®ã€‚\nPrometheus åŸç†ä»‹ç» ç›®å‰Prometheusæ”¯æŒOpenTsdbã€InfluxDBã€Elasticsearchç­‰åç«¯å­˜å‚¨ï¼Œé€šè¿‡é€‚é…å™¨å®ç°Prometheuså­˜å‚¨çš„remote writeå’Œremote readæ¥å£ï¼Œä¾¿å¯ä»¥æ¥å…¥Prometheusä½œä¸ºè¿œç¨‹å­˜å‚¨ä½¿ç”¨\nPrometheuç”±Goè¯­è¨€ç¼–å†™è€Œæˆï¼Œé‡‡ç”¨Pullæ–¹å¼è·å–ç›‘æ§ä¿¡æ¯ï¼Œå¹¶æä¾›äº†å¤šç»´åº¦çš„æ•°æ®æ¨¡å‹å’Œçµæ´»çš„æŸ¥è¯¢æ¥å£ã€‚Prometheusä¸ä»…å¯ä»¥é€šè¿‡é™æ€æ–‡ä»¶é…ç½®ç›‘æ§å¯¹è±¡ï¼Œè¿˜æ”¯æŒè‡ªåŠ¨å‘ç°æœºåˆ¶ï¼Œèƒ½é€šè¿‡Kubernetesã€onslã€DNSç­‰å¤šç§æ–¹å¼åŠ¨æ€è·å–ç›‘æ§å¯¹è±¡ã€‚åœ¨æ•°æ®é‡‡é›†æ–¹é¢ï¼Œå€ŸåŠ©Goè¯­éŸ³çš„é«˜å¹¶å‘ç‰¹æ€§ï¼Œå•æœºPrometheuså¯ä»¥é‡‡å–æ•°ç™¾ä¸ªèŠ‚ç‚¹çš„ç›‘æ§æ•°æ®ï¼›åœ¨æ•°æ®å­˜å‚¨æ–¹é¢ï¼Œéšç€æœ¬åœ°æ—¶åºæ•°æ®åº“çš„ä¸æ–­ä¼˜åŒ–ï¼Œå•æœºPrometheusæ¯ç§’å¯ä»¥é‡‡é›†ä¸€åƒä¸‡ä¸ªæŒ‡æ ‡ï¼Œå¦‚æœéœ€è¦å­˜å‚¨å¤§é‡çš„å†å²ç›‘æ§æ•°æ®ï¼Œåˆ™è¿˜æ”¯æŒè¿œç¨‹å­˜å‚¨ã€‚\nPrometheus ç‰¹æ€§ï¼ˆFeaturesï¼‰ Prometheus çš„ä¸»è¦ç‰¹æ€§\né€šè¿‡æŒ‡æ ‡åï¼ˆmetric nameï¼‰å’Œ KV ç»“æ„ï¼Œä½¿ç”¨æ—¶åºæ•°æ®ï¼ˆtime series dataï¼‰è¡¨è¾¾çš„å¤šç»´åº¦æ•°æ®æ¨¡å‹ PromQLï¼Œä¸€ç§çµæ´»çš„æŸ¥è¯¢è¯­è¨€ï¼Œèƒ½å¤Ÿæ›´å¥½çš„åˆ©ç”¨ç»´åº¦ å¯¹åˆ†å¸ƒå¼å­˜å‚¨æ²¡æœ‰ä¾èµ–ï¼›å•æœåŠ¡å™¨èŠ‚ç‚¹å³å¯è‡ªæ²» é€šè¿‡ä½¿ç”¨åŸºäº HTTP çš„æ‹‰æ¨¡å¼ (pull model) è¿›è¡Œæ—¶åºæ•°æ®é‡‡é›† é€šè¿‡ä¸­é—´ç½‘å…³ ( gateway) ä»¥æ”¯æŒæ¨é€æ—¶åºæ•°æ® é€šè¿‡æœåŠ¡å‘ç°æˆ–é™æ€é…ç½®ï¼Œå‘ç°ç›‘æ§ç›®æ ‡ï¼ˆtargetsï¼‰ æ”¯æŒå¤šå›¾å’Œä»ªè¡¨ç›˜æ¨¡å¼ Prometheus ç»„ä»¶ï¼ˆComponentsï¼‰ Prometheus ç”Ÿæ€ç”±å¤šç»„ä»¶æ„æˆï¼Œå…¶ä¸­å¤§éƒ¨åˆ†éƒ½æ˜¯å¯é€‰é…ç½®ï¼š ä¸»è¦çš„ Promethues serverï¼šæŠ“å–å’Œå­˜å‚¨æ—¶åºæ•°æ® å®¢æˆ·ç«¯ librariesï¼šè£…ç½®åœ¨åº”ç”¨ç«¯ä»¥é‡‡æ ·(instrumenting)åº”ç”¨ç¨‹åºä»£ç  push gatewayï¼šèƒ½å¤Ÿæ”¯æŒçŸ­æ—¶ä»»åŠ¡ ç‰¹åˆ«çš„ exporters ç»™å„ç±»æœåŠ¡ï¼Œæ¯”å¦‚ HAProxyã€StatsDã€Graphite ç­‰ã€‚ alertmanagerï¼šç”¨æ¥å¤„ç†æŠ¥è­¦ å„å¼æ”¯æŒå·¥å…· Prometheus æ¶æ„ï¼ˆArchitectureï¼‰ Prometheus é‡‡æ ·æ•°æ®æœ‰ä¸¤ç§æ–¹å¼ï¼Œä¸€ç§æ˜¯ç›´æ¥é‡‡æ ·ä»ªè¡¨åŒ–ä»»åŠ¡ï¼ˆinstrumenting jobï¼‰ï¼Œå¦ä¸€ç§é€šè¿‡ä¸­ä»‹ push gateway æ¥é‡‡æ ·çŸ­æ—¶ä»»åŠ¡ã€‚Prometheus åœ¨æœ¬åœ°å­˜å‚¨æ‰€æœ‰é‡‡æ ·çš„æ ·æœ¬ï¼ŒåŒæ—¶åŸºäºè¿™äº›æ•°æ®ï¼Œæ‰§è¡Œè§„åˆ™ï¼ˆrulesï¼‰ç”¨ä»¥ä»å·²å­˜æ•°æ®ä¸Šèšåˆã€è®°å½•æ–°çš„æ—¶åºæ•°æ®ï¼Œæˆ–ç”¨ä»¥å‘é€æŠ¥è­¦ã€‚Grafana æˆ–å…¶ä»–çš„ API consumers å¯ä»¥å¯è§†åŒ–è¿™äº›æ”¶é›†çš„æ•°æ®ã€‚\nPrometheusçš„åŸºæœ¬åŸç†æ˜¯é€šè¿‡HTTPå‘¨æœŸæ€§æŠ“å–è¢«ç›‘æ§ç»„ä»¶çš„çŠ¶æ€ï¼Œä»»æ„ç»„ä»¶åªè¦æä¾›å¯¹åº”çš„HTTPæ¥å£å¹¶ç¬¦åˆPrometheuså®šä¹‰çš„æ•°æ®æ ¼å¼ï¼Œå°±å¯ä»¥ä»‹å…¥Prometheusç›‘æ§\né’ˆå¯¹ Prometheusã€Zabbixç›‘æ§ç³»ç»Ÿçš„å¯¹æ¯” Zabbix Prometheus ä¼˜ç‚¹ 1ã€æ”¯æŒå¤šå¹³å°çš„ä¼ä¸šçº§åˆ†å¸ƒå¼å¼€æºç›‘æ§è½¯ä»¶ï¼›\n2ã€å®‰è£…éƒ¨ç½²ç®€å•ï¼Œå¤šç§æ•°æ®é‡‡é›†æ’ä»¶çµæ´»é›†æˆ\n3ã€åŠŸèƒ½å¼ºå¤§ï¼Œå¯å®ç°å¤æ‚å¤šæ¡ä»¶å‘Šè­¦\n4ã€è‡ªå¸¦ç”»å›¾åŠŸèƒ½ï¼Œå¾—åˆ°çš„æ•°æ®å¯ä»¥ç»˜æˆå›¾å½¢\n5ã€æä¾›å¤šç§APIæ¥å£ï¼Œæ”¯æŒè°ƒç”¨è„šæœ¬\n6ã€å‡ºç°é—®é¢˜æ—¶å¯è‡ªåŠ¨è¿œç¨‹æ‰§è¡Œå‘½ä»¤ï¼ˆéœ€å¯¹agentè®¾ç½®æ‰§è¡Œæƒé™ï¼‰ 1ã€åç«¯ç”¨golangå¼€å‘ï¼Œå‰ç«¯æ˜¯Grafana,JSONç¼–è¾‘å³å¯è§£å†³ã€‚å®šåˆ¶åŒ–éš¾åº¦è¾ƒä½\n2ã€ç›‘æ§æ•°æ®å­˜å‚¨åœ¨åŸºäºæ—¶é—´åºåˆ—çš„æ•°æ®åº“å†…ï¼Œä¾¿äºå¯¹å·²æœ‰æ•°æ®è¿›è¡Œæ–°çš„èšåˆã€‚\n3ã€å„ä¸ªç»„ä»¶éƒ½æœ‰è¾ƒæˆç†Ÿé«˜å¯ç”¨æ–¹æ¡ˆï¼Œæ²¡æœ‰å•ç‚¹æ•…éšœ\n4ã€é€‚åˆå¯¹äº‘ç¯å¢ƒè¿›è¡Œç›‘æ§ï¼Œå¯¹OpenStack,Kubernetes æœ‰å¾ˆå¥½çš„é›†æˆã€‚\n5ã€æ”¯æŒæŠ¥è­¦çš„æ”¶æ•› ç¼ºç‚¹ 1ã€é¡¹ç›®æ‰¹é‡ä¿®æ”¹ä¸æ–¹ä¾¿\n2ã€ä½†æ˜¯æ·±å±‚æ¬¡éœ€æ±‚éœ€è¦éå¸¸ç†Ÿæ‚‰Zabbixå¹¶è¿›è¡Œå¤§é‡çš„äºŒæ¬¡å®šåˆ¶å¼€å‘ï¼Œéš¾åº¦è¾ƒå¤§ï¼›\n3ã€ç³»ç»Ÿçº§åˆ«æŠ¥è­¦è®¾ç½®ç›¸å¯¹æ¯”è¾ƒå¤šï¼Œå¦‚æœä¸ç­›é€‰çš„è¯æŠ¥è­¦é‚®ä»¶ä¼šå¾ˆå¤šï¼›å¹¶ä¸”è‡ªå®šä¹‰çš„é¡¹ç›®æŠ¥è­¦éœ€è¦è‡ªå·±è®¾ç½®ï¼Œè¿‡ç¨‹æ¯”è¾ƒç¹\n4ã€æ•°æ®æŠ¥è¡¨éœ€è¦ç‰¹æ®ŠäºŒæ¬¡å¼€å‘å®šä¹‰ï¼› 1ã€å®‰è£…ç›¸å¯¹å¤æ‚ï¼Œç›‘æ§ã€å‘Šè­¦å’Œç•Œé¢éƒ½åˆ†å±äºä¸åŒçš„ç»„ä»¶ã€‚\n2ã€ç•Œé¢ç›¸å¯¹è¾ƒå¼±ï¼Œå¾ˆå¤šé…ç½®éœ€è¦ä¿®æ”¹é…ç½®æ–‡ä»¶ã€‚ å¯¹æ¯”é¡¹ Prometheus zabbix Prometheusä¼˜åŠ¿ zabbixä¼˜åŠ¿ ç®¡ç† äºŒè¿›åˆ¶æ–‡ä»¶å¯åŠ¨ LNMP+ç¼–è¯‘ è½»é‡çº§serverï¼Œä¾¿äºè¿ç§»å’Œç»´æŠ¤ â€“ é…ç½® é…ç½®æ–‡ä»¶ å›¾å½¢åŒ– æ›´å¥½çš„æ”¯æŒè‡ªåŠ¨åŒ–é…ç½® å­¦ä¹ æˆæœ¬ä½ - client ä¸°å¯Œçš„clientåº“ zabbix_agentè‡ªå®šä¹‰è„šæœ¬ ä¸ºå„ç§ä¸­é—´ä»¶ã€åº”ç”¨æä¾›ä¸“ä¸šçš„exporterï¼Œç›‘æ§é¡¹æ›´å…¨é¢ æ”¯æŒè‡ªå®šä¹‰ç›‘æ§é¡¹ï¼Œå¯¹ç›‘æ§è®¾è®¡è€…çš„æ ¼å±€è¦æ±‚è¾ƒé«˜ æ•°æ®å­˜å‚¨æ–¹å¼ Prometheus TSDB MySQL ç›‘æ§æ•°æ®ä»¥æ—¶é—´ä¸ºç»´åº¦ç»Ÿè®¡æƒ…å†µè¾ƒå¤šï¼Œæ—¶åºæ•°æ®åº“æ›´é€‚ç”¨äºç›‘æ§æ•°æ®çš„å­˜å‚¨ï¼ŒæŒ‰æ—¶é—´ç´¢å¼•æ€§èƒ½æ›´é«˜ MySQLè¾ƒå¸¸ç”¨ï¼Œå­¦ä¹ æˆæœ¬ä½ æ•°æ®å¤„ç† PromQL MySQL PromQLè®¡ç®—å‡½æ•°ä¸°å¯Œï¼Œç»Ÿè®¡ç»´åº¦å¹¿ åŒä¸Š äºŒæ¬¡å¼€å‘ ä¸°å¯Œçš„sdk api æä¾›äº†Goã€Java/Scalaã€Pythonã€Rubyç­‰sdkï¼ŒäºŒæ¬¡å¼€å‘æ›´ä¾¿æ· apié€‚é…è¾ƒä¸ºå¸¸ç”¨ï¼Œå­¦ä¹ æˆæœ¬ä½ å¯¹äº‘ç¯å¢ƒçš„æ”¯æŒ åŸç”Ÿæ”¯æŒå®¹å™¨ç›‘æ§ æ›´é€‚åˆç‰©ç†æœºç›‘æ§ è‡ªåŠ¨å‘ç°å®¹å™¨ï¼Œæ›´å¥½çš„é€‚é…k8s â€“ å‘Šè­¦æ–¹å¼ å¯æŒ‰ç…§æ ‡ç­¾åˆ†ç»„ï¼Œæ”¶æ•› åœ¨æ¬¡æ•°ä¸Šæ”¶æ•› å‘Šè­¦æ”¶æ•›æ–¹å¼æ›´å¤šæ ·åŒ– â€“ ç›‘æ§é¡¹å€¼ æ”¯æŒæ•°å­— æ”¯æŒæ•°å­—å­—ç¬¦ä¸² â€“ å¯åšæ—¥å¿—ç›‘æ§ æ–‡ç« é“¾æ¥\nhttps://www.cnsre.cn/posts/210326133909/\n","description":"Prometheusä»‹ç»","id":86,"section":"posts","tags":["prometheus"],"title":"Prometheusä»‹ç»","uri":"http://www.cnsre.cn:80/posts/210326133909/"},{"content":"ELK+kafka+filebeatæ­å»ºç”Ÿäº§ELFKé›†ç¾¤ ELK æ¶æ„ä»‹ç» é›†ç¾¤æœåŠ¡ç‰ˆæœ¬ æœåŠ¡ ç‰ˆæœ¬ java 1.8.0_221 elasticsearch 7.10.1 filebeat 7.10.1 kibana 7.10.1 logstash 7.10.1 cerebro 0.9.2-1 kafka 2.12-2.3.0 zookeeper 3.5.6 æœåŠ¡å™¨ç¯å¢ƒè¯´æ˜ IPåœ°å€ ä¸»æœºå é…ç½® è§’è‰² 10.0.11.172 elk-master 4C16G es-masterã€kafka+zookeeper1 10.0.21.117 elk-node1 4C16G es-node1ã€kafka+zookeeper2 10.0.11.208 elk-node2 4C16G es-node2ã€kafka+zookeeper3 10.0.10.242 elk-kibana 4C16G logstashã€kibanaã€cerebro ç³»ç»Ÿå‚æ•°ä¼˜åŒ– ä¸‰ä¸ªèŠ‚ç‚¹éƒ½éœ€è¦æ‰§è¡Œ ä¿®æ”¹ä¸»æœºå 1 2 3 hostnamectl set-hostname elk-master hostnamectl set-hostname elk-node1 hostnamectl set-hostname elk-node2 å¢åŠ æ–‡ä»¶æè¿°ç¬¦ 1 2 3 4 5 6 7 8 cat \u0026gt;\u0026gt;/etc/security/limits.conf\u0026lt;\u0026lt; EOF * soft nofile 65536 * hard nofile 65536 * soft nproc 65536 * hard nproc 65536 * hard memlock unlimited * soft memlock unlimited EOF ä¿®æ”¹é»˜è®¤é™åˆ¶å†…å­˜ 1 2 3 4 5 cat \u0026gt;\u0026gt;/etc/systemd/system.conf\u0026lt;\u0026lt; EOF DefaultLimitNOFILE=65536 DefaultLimitNPROC=32000 DefaultLimitMEMLOCK=infinity EOF ä¼˜åŒ–å†…æ ¸ï¼Œå¯¹esæ”¯æŒ 1 2 3 4 5 6 7 8 9 10 11 12 cat \u0026gt;\u0026gt;/etc/sysctl.conf\u0026lt;\u0026lt; EOF # å…³é—­äº¤æ¢å†…å­˜ vm.swappiness =0 # å½±å“javaçº¿ç¨‹æ•°é‡ï¼Œå»ºè®®ä¿®æ”¹ä¸º262144æˆ–è€…æ›´é«˜ vm.max_map_count= 262144 # ä¼˜åŒ–å†…æ ¸listenè¿æ¥ net.core.somaxconn=65535 # æœ€å¤§æ‰“å¼€æ–‡ä»¶æè¿°ç¬¦æ•°ï¼Œå»ºè®®ä¿®æ”¹ä¸º655360æˆ–è€…æ›´é«˜ fs.file-max=655360 # å¼€å¯ipv4è½¬å‘ net.ipv4.ip_forward= 1 EOF ä¿®æ”¹Hostnameé…ç½®æ–‡ä»¶ 1 2 3 4 5 cat \u0026gt;\u0026gt;/etc/hosts\u0026lt;\u0026lt; EOF elk-master 10.0.11.172 elk-node1 10.0.21.117 elk-node2 10.0.11.208 EOF é‡å¯ä½¿é…ç½®ç”Ÿæ•ˆ 1 reboot éƒ¨ç½²Zookeeper ä¸‰ä¸ªèŠ‚ç‚¹éƒ½éœ€è¦æ‰§è¡Œ åˆ›å»ºZookeeperé¡¹ç›®ç›®å½• 1 2 3 4 #å­˜æ”¾å¿«ç…§æ—¥å¿— mkdir zkdata #å­˜æ”¾äº‹ç‰©æ—¥å¿— mkdir zklogs ä¸‹è½½è§£å‹zookeeper 1 2 3 wget http://mirror.bit.edu.cn/apache/zookeeper/zookeeper-3.5.6/apache-zookeeper-3.5.6-bin.tar.gz tar -zxvf apache-zookeeper-3.5.6-bin.tar.gz mv apache-zookeeper-3.5.6-bin zookeeper ä¿®æ”¹é…ç½®æ–‡ä»¶ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 [root@elk-master zookeeper]# cat conf/zoo.cfg |grep -v ^# # æœåŠ¡å™¨ä¹‹é—´æˆ–å®¢æˆ·ç«¯ä¸æœåŠ¡å™¨ä¹‹é—´ç»´æŒå¿ƒè·³çš„æ—¶é—´é—´éš” # tickTimeä»¥æ¯«ç§’ä¸ºå•ä½ã€‚ tickTime=2000 # é›†ç¾¤ä¸­çš„followeræœåŠ¡å™¨(F)ä¸leaderæœåŠ¡å™¨(L)ä¹‹é—´çš„åˆå§‹è¿æ¥å¿ƒè·³æ•° initLimit=10 # é›†ç¾¤ä¸­çš„followeræœåŠ¡å™¨ä¸leaderæœåŠ¡å™¨ä¹‹é—´è¯·æ±‚å’Œåº”ç­”ä¹‹é—´èƒ½å®¹å¿çš„æœ€å¤šå¿ƒè·³æ•° syncLimit=5 # æ•°æ®ä¿å­˜ç›®å½• dataDir=../zkdata # æ—¥å¿—ä¿å­˜ç›®å½• dataLogDir=../zklogs # å®¢æˆ·ç«¯è¿æ¥ç«¯å£ clientPort=2181 # å®¢æˆ·ç«¯æœ€å¤§è¿æ¥æ•°ã€‚# æ ¹æ®è‡ªå·±å®é™…æƒ…å†µè®¾ç½®ï¼Œé»˜è®¤ä¸º60ä¸ª maxClientCnxns=60 # ä¸‰ä¸ªæ¥ç‚¹é…ç½®ï¼Œæ ¼å¼ä¸ºï¼š server.æœåŠ¡ç¼–å·=æœåŠ¡åœ°å€ã€LFé€šä¿¡ç«¯å£ã€é€‰ä¸¾ç«¯å£ server.1=10.0.11.172:2888:3888 server.2=10.0.21.117:2888:3888 server.3=10.0.11.208:2888:3888 å†™å…¥èŠ‚ç‚¹æ ‡è®° åˆ†åˆ«åœ¨ä¸‰ä¸ªèŠ‚ç‚¹/home/tools/zookeeper/zkdata/myidå†™å…¥èŠ‚ç‚¹æ ‡è®° masterèŠ‚ç‚¹ node1èŠ‚ç‚¹ node2èŠ‚ç‚¹ masterçš„æ“ä½œ 1 echo \u0026#34;1\u0026#34; \u0026gt; /home/tools/zookeeper/zkdata/myid node1çš„æ“ä½œ 1 echo \u0026#34;2\u0026#34; \u0026gt; /home/tools/zookeeper/zkdata/myid node2çš„æ“ä½œ 1 echo \u0026#34;3\u0026#34; \u0026gt; /home/tools/zookeeper/zkdata/myid å¯åŠ¨zookeeperé›†ç¾¤ 1 2 3 4 5 [root@elk-master zookeeper]# cd /home/tools/zookeeper/bin/ [root@elk-master bin]# ./zkServer.sh start ZooKeeper JMX enabled by default Using config: /home/tools/zookeeper/bin/../conf/zoo.cfg Starting zookeeper ... STARTED æ£€æŸ¥é›†ç¾¤çŠ¶æ€ 1 2 3 4 5 [root@elk-master bin]# sh /home/tools/zookeeper/bin/zkServer.sh status ZooKeeper JMX enabled by default Using config: /home/tools/zookeeper/bin/../conf/zoo.cfg Client port found: 2181. Client address: localhost. Mode: leader è®¾ç½®å…¨å±€å˜é‡ 1 2 3 4 5 cat \u0026gt;\u0026gt;/etc/profile\u0026lt;\u0026lt; EOF export ZOOKEEPER_INSTALL=/home/tools/zookeeper/ export PATH=$PATH:$ZOOKEEPER_INSTALL/bin export PATH EOF ä½¿é…ç½®ç”Ÿæ•ˆ 1 source /etc/profile è¿™æ ·å°±å¯ä»¥å…¨å±€ä½¿ç”¨zkServer.shå‘½ä»¤äº†\néƒ¨ç½² Kafka ä¸‰ä¸ªèŠ‚ç‚¹éƒ½éœ€è¦æ‰§è¡Œ ä¸‹è½½è§£å‹kafkaå‹ç¼©åŒ… 1 2 3 4 5 6 [root@elk-master tools]# mkdir kafka [root@elk-master tools]# cd kafka/ [root@elk-master kafka]# wget https://www-eu.apache.org/dist/kafka/2.3.0/kafka_2.12-2.3.0.tgz [root@elk-master kafka]# tar xf kafka_2.12-2.3.0.tgz [root@elk-master kafka]# mv kafka_2.12-2.3.0 kafka [root@elk-master kafka]# cd kafka/config/ é…ç½®kafka 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 [root@elk-master config]# cat /home/tools/kafka/kafka/config/server.properties ############################# Server Basics ############################# # brokerçš„idï¼Œå€¼ä¸ºæ•´æ•°ï¼Œä¸”å¿…é¡»å”¯ä¸€ï¼Œåœ¨ä¸€ä¸ªé›†ç¾¤ä¸­ä¸èƒ½é‡å¤ broker.id=1 ############################# Socket Server Seï¼šttings ############################# # kafkaé»˜è®¤ç›‘å¬çš„ç«¯å£ä¸º9092 (é»˜è®¤ä¸ä¸»æœºåè¿›è¡Œè¿æ¥) listeners=PLAINTEXT://:9092 # å¤„ç†ç½‘ç»œè¯·æ±‚çš„çº¿ç¨‹æ•°é‡ï¼Œé»˜è®¤ä¸º3ä¸ª num.network.threads=3 # æ‰§è¡Œç£ç›˜IOæ“ä½œçš„çº¿ç¨‹æ•°é‡ï¼Œé»˜è®¤ä¸º8ä¸ª num.io.threads=8 # socketæœåŠ¡å‘é€æ•°æ®çš„ç¼“å†²åŒºå¤§å°ï¼Œé»˜è®¤100KB socket.send.buffer.bytes=102400 # socketæœåŠ¡æ¥å—æ•°æ®çš„ç¼“å†²åŒºå¤§å°ï¼Œé»˜è®¤100KB socket.receive.buffer.bytes=102400 # socketæœåŠ¡æ‰€èƒ½æ¥å—çš„ä¸€ä¸ªè¯·æ±‚çš„æœ€å¤§å¤§å°ï¼Œé»˜è®¤ä¸º100M socket.request.max.bytes=104857600 ############################# Log Basics ############################# # kafkaå­˜å‚¨æ¶ˆæ¯æ•°æ®çš„ç›®å½• log.dirs=../kfkdata # æ¯ä¸ªtopicé»˜è®¤çš„partitionæ•°é‡ num.partitions=3 # åœ¨å¯åŠ¨æ—¶æ¢å¤æ•°æ®å’Œå…³é—­æ—¶åˆ·æ–°æ•°æ®æ—¶æ¯ä¸ªæ•°æ®ç›®å½•çš„çº¿ç¨‹æ•°é‡ num.recovery.threads.per.data.dir=1 ############################# Log Flush Policy ############################# # æ¶ˆæ¯åˆ·æ–°åˆ°ç£ç›˜ä¸­çš„æ¶ˆæ¯æ¡æ•°é˜ˆå€¼ #log.flush.interval.messages=10000 # æ¶ˆæ¯åˆ·æ–°åˆ°ç£ç›˜ä¸­çš„æœ€å¤§æ—¶é—´é—´éš”,1s #log.flush.interval.ms=1000 ############################# Log Retention Policy ############################# # æ—¥å¿—ä¿ç•™å°æ—¶æ•°ï¼Œè¶…æ—¶ä¼šè‡ªåŠ¨åˆ é™¤ï¼Œé»˜è®¤ä¸º7å¤© log.retention.hours=168 # æ—¥å¿—ä¿ç•™å¤§å°ï¼Œè¶…å‡ºå¤§å°ä¼šè‡ªåŠ¨åˆ é™¤ï¼Œé»˜è®¤ä¸º1G #log.retention.bytes=1073741824 # æ—¥å¿—åˆ†ç‰‡ç­–ç•¥ï¼Œå•ä¸ªæ—¥å¿—æ–‡ä»¶çš„å¤§å°æœ€å¤§ä¸º1Gï¼Œè¶…å‡ºååˆ™åˆ›å»ºä¸€ä¸ªæ–°çš„æ—¥å¿—æ–‡ä»¶ log.segment.bytes=1073741824 # æ¯éš”å¤šé•¿æ—¶é—´æ£€æµ‹æ•°æ®æ˜¯å¦è¾¾åˆ°åˆ é™¤æ¡ä»¶,300s log.retention.check.interval.ms=300000 ############################# Zookeeper ############################# # Zookeeperè¿æ¥ä¿¡æ¯ï¼Œå¦‚æœæ˜¯zookeeperé›†ç¾¤ï¼Œåˆ™ä»¥é€—å·éš”å¼€ zookeeper.connect=10.0.11.172,10.0.21.117,10.0.11.208 # è¿æ¥zookeeperçš„è¶…æ—¶æ—¶é—´,6s zookeeper.connection.timeout.ms=6000 åˆ›å»ºæ•°æ®å­˜å‚¨çš„ç›®å½• 1 [root@elk-master config]# mkdir ../kfkdata ä¿®æ”¹broker.id åˆ†åˆ«åœ¨ä¸‰ä¸ªèŠ‚ç‚¹ä¾æ¬¡ä¿®æ”¹/home/tools/kafka/kafka/config/server.propertiesé…ç½®æ–‡ä»¶ masterèŠ‚ç‚¹ node1èŠ‚ç‚¹ node2èŠ‚ç‚¹ masterçš„é…ç½® 1 broker.id=1 node1çš„é…ç½® 1 broker.id=2 node2çš„é…ç½® 1 broker.id=3 å¯åŠ¨kafkaé›†ç¾¤ 1 2 3 4 5 cd /home/tools/kafka/kafka/bin/ #å¯åŠ¨æµ‹è¯• ./kafka-server-start.sh ../config/server.properties #æ”¾å…¥åå° ./kafka-server-start.sh -daemon ../config/server.properties æµ‹è¯• ä»»æ„èŠ‚ç‚¹å‡å¯æ‰§è¡Œ åœ¨åˆ›å»ºtopicåœ¨é›†ç¾¤ä¸­çš„ä»»æ„èŠ‚ç‚¹ å‘å¸ƒæ¶ˆæ¯è®¢é˜…æ¶ˆæ¯éªŒè¯ç»“æœ\nåˆ›å»ºtopic æ¶ˆæ¯å‘å¸ƒ topicæ¶ˆæ¯è®¢é˜… 1 2 3 4 5 6 [root@elk-master bin]# ./kafka-topics.sh \\ --create \\ --zookeeper 10.0.11.172:2181,10.0.21.117:2181,10.0.11.208:2181 \\ --partitions 3 \\ --replication-factor 1 \\ --topic logs 1 2 3 [root@elk-master bin]# ./kafka-console-producer.sh \\ --broker-list 10.0.11.172:9092,10.0.21.117:9092,10.0.11.208:9092 \\ --topic logs 1 2 3 4 [root@elk-master bin]# ./kafka-console-consumer.sh \\ --bootstrap-server 10.0.11.172:9092,10.0.21.117:9092,10.0.11.208:9092 \\ --topic logs \\ --from-beginning éƒ¨ç½²elasticsearch ä¸‰ä¸ªèŠ‚ç‚¹éƒ½éœ€è¦æ‰§è¡Œ ä¸‹è½½å®‰è£…elasticsearch 1 2 wget https://pan.cnsre.cn/d/Package/Linux/ELK/elasticsearch-7.10.1-x86_64.rpm [root@elk-master package]# rpm -ivh elasticsearch-7.10.1-x86_64.rpm å¤‡ä»½é…ç½®æ–‡ä»¶ 1 2 cd /etc/elasticsearch cp elasticsearch.yml elasticsearch.yml.bak ä¿®æ”¹é…ç½®æ–‡ä»¶ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 cat \u0026gt;/etc/elasticsearch/elasticsearch.yml \u0026lt;\u0026lt; EOF #é›†ç¾¤å cluster.name: elk-cluster #nodeå node.name: elk-1 #æ•°æ®å­˜å‚¨è·¯å¾„ path.data: /home/elasticsearch/esdata #æ•°æ®å¿«ç…§è·¯å¾„ path.repo: /home/backup/essnapshot #æ—¥å¿—å­˜å‚¨è·¯å¾„ path.logs: /home/elasticsearch/eslogs #esç»‘å®šçš„ipåœ°å€ï¼Œæ ¹æ®è‡ªå·±æœºå™¨ipè¿›è¡Œä¿®æ”¹ network.host: 0.0.0.0 #æœåŠ¡ç«¯å£ http.port: 9200 #é›†ç¾¤masteréœ€è¦å’Œnodeåè®¾ç½®ä¸€è‡´ discovery.seed_hosts: [\u0026#34;10.0.11.172\u0026#34;, \u0026#34;10.0.21.117\u0026#34;, \u0026#34;10.0.11.208\u0026#34;] cluster.initial_master_nodes: [\u0026#34;10.0.11.172\u0026#34;,\u0026#34;10.0.21.117\u0026#34;,\u0026#34;10.0.11.208\u0026#34;] #å…è®¸è·¨åŸŸè¯·æ±‚ http.cors.enabled: true #* è¡¨ç¤ºæ”¯æŒæ‰€æœ‰åŸŸå http.cors.allow-origin: \u0026#34;*\u0026#34; #æ·»åŠ è¯·æ±‚header http.cors.allow-headers: Authorization,X-Requested-With,Content-Length,Content-Type #ç”Ÿäº§å¿…é¡»ä¸ºtrueï¼Œå†…å­˜é”å®šæ£€æŸ¥ï¼Œç›®çš„æ˜¯å†…å­˜åœ°å€ç›´æ¥æ˜ å°„ï¼Œå‡å°‘ä¸€æ¬¡copyæ—¶é—´ bootstrap.memory_lock: true #ç³»ç»Ÿè¿‡æ»¤æ£€æŸ¥ï¼Œé˜²æ­¢æ•°æ®æŸåï¼Œè€ƒè™‘é›†ç¾¤å®‰å…¨ï¼Œç”Ÿäº§è®¾ç½®æˆfalse bootstrap.system_call_filter: false #xpacké…ç½® xpack.security.enabled: true xpack.security.transport.ssl.enabled: true xpack.security.transport.ssl.verification_mode: certificate xpack.security.transport.ssl.keystore.path: /etc/elasticsearch/elastic-certificates.p12 xpack.security.transport.ssl.truststore.path: /etc/elasticsearch/elastic-certificates.p12 EOF ä¿®æ”¹JVM å°†jvm.optionsæ–‡ä»¶ä¸­22-23è¡Œçš„8gè®¾ç½®ä¸ºä½ çš„æœåŠ¡å†…å­˜çš„ä¸€åŠ 1 2 3 [root@elk-node1 elasticsearch]# cat -n jvm.options |grep 8g 22 -Xms8g 23 -Xmx8g ä¿®æ”¹å…¶ä»–èŠ‚ç‚¹é…ç½® åˆ†åˆ«åœ¨ä¸‰ä¸ªèŠ‚ç‚¹ä¿®æ”¹/etc/elasticsearch/elasticsearch.ymlé…ç½®æ–‡ä»¶ masterèŠ‚ç‚¹ node1èŠ‚ç‚¹ node2èŠ‚ç‚¹ masterçš„é…ç½® 1 node.name: \u0026#34;es-master\u0026#34; node1çš„é…ç½® 1 node.name: \u0026#34;es-node1\u0026#34; node2çš„é…ç½® 1 node.name: \u0026#34;es-node2\u0026#34; æœ€ç»ˆå±•ç¤º\nåˆ†é…æƒé™ å› ä¸ºè‡ªå®šä¹‰æ•°æ®ã€æ—¥å¿—å­˜å‚¨ç›®å½•ï¼Œæ‰€ä»¥è¦æŠŠæƒé™ç»™åˆ°ç›®å½•\n1 2 3 4 mkdir -p /home/elasticsearch/{esdata,eslogs} chown elasticsearch:elasticsearch /home/elasticsearch/* mkdir -p /home/backup/essnapshot chown elasticsearch:elasticsearch /home/backup/essnapshot å¯åŠ¨æœåŠ¡ ä¸‰ä¸ªèŠ‚ç‚¹å…¨éƒ¨å¯åŠ¨å¹¶åŠ å…¥å¼€æœºå¯åŠ¨\n1 2 systemctl start elasticsearch systemctl enable elasticsearch ä½¿ç”¨xpackè¿›è¡Œå®‰å…¨è®¤è¯ xpackçš„å®‰å…¨åŠŸèƒ½ TLS åŠŸèƒ½ã€‚ å¯å¯¹é€šä¿¡è¿›è¡ŒåŠ å¯† æ–‡ä»¶å’ŒåŸç”Ÿ Realmã€‚ å¯ç”¨äºåˆ›å»ºå’Œç®¡ç†ç”¨æˆ· åŸºäºè§’è‰²çš„è®¿é—®æ§åˆ¶ã€‚ å¯ç”¨äºæ§åˆ¶ç”¨æˆ·å¯¹é›†ç¾¤ API å’Œç´¢å¼•çš„è®¿é—®æƒé™ é€šè¿‡é’ˆå¯¹ Kibana Spaces çš„å®‰å…¨åŠŸèƒ½ï¼Œè¿˜å¯å…è®¸åœ¨Kibana ä¸­å®ç°å¤šç§Ÿæˆ·ã€‚\nåœ¨æˆ‘é…ç½®è¿‡ç¨‹ä¸­ï¼Œå‘ç°é›†ç¾¤è®¤è¯éœ€è¦é¦–å…ˆé…ç½®ç§˜é’¥æ‰è¡Œï¼Œå¦åˆ™åœ¨ç»™å†…ç½®ç”¨æˆ·åˆ›å»ºç§˜é’¥çš„æ—¶å€™å°†ä¼šæŠ¥é”™ã€‚\nCause: Cluster state has not been recovered yet, cannot write to the [null] index 1 2 3 4 5 6 7 8 9 10 Unexpected response code [503] from calling PUT http://10.0.11.172:9200/_security/user/apm_system/_password?pretty Cause: Cluster state has not been recovered yet, cannot write to the [null] index Possible next steps: * Try running this tool again. * Try running with the --verbose parameter for additional messages. * Check the elasticsearch logs for additional error details. * Use the change password API manually. ERROR: Failed to set password for user [apm_system]. ç”³è¯·è¯ä¹¦ ä¸‹é¢çš„æ“ä½œï¼Œåœ¨å…¶ä¸­ä¸€ä¸ªèŠ‚ç‚¹æ“ä½œå³å¯ 1 2 /usr/share/elasticsearch/bin/elasticsearch-certutil ca /usr/share/elasticsearch/bin/elasticsearch-certutil cert --ca elastic-stack-ca.p12 ä¸¤æ¡å‘½ä»¤å‡ä¸€è·¯å›è½¦å³å¯ï¼Œä¸éœ€è¦ç»™ç§˜é’¥å†æ·»åŠ å¯†ç \nè¯ä¹¦åˆ›å»ºå®Œæˆä¹‹åï¼Œé»˜è®¤åœ¨esçš„æ•°æ®ç›®å½•ã€‚\nå°†è¯ä¹¦æ‹·è´åˆ°etcä¸‹ï¼Œå¹¶ç»™ä¸Šæƒé™ã€‚\n[root@elk-master ~]# ls /usr/share/elasticsearch/elastic-* /usr/share/elasticsearch/elastic-certificates.p12 /usr/share/elasticsearch/elastic-stack-ca.p12 cp /usr/share/elasticsearch/elastic-* /etc/elasticsearch/ chown elasticsearch.elasticsearch /etc/elasticsearch/elastic* åšå®Œä¹‹åï¼Œå°†è¯ä¹¦æ‹·è´åˆ°å…¶ä»–èŠ‚ç‚¹\nä¸ºå†…ç½®è´¦å·æ·»åŠ å¯†ç  ESä¸­å†…ç½®äº†å‡ ä¸ªç®¡ç†å…¶ä»–é›†æˆç»„ä»¶çš„è´¦å·apm_system, beats_system, elastic, kibana, logstash_system, remote_monitoring_userä½¿ç”¨ä¹‹å‰ï¼Œé¦–å…ˆéœ€è¦è®¾ç½®ä¸‹å¯†ç ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 /usr/share/elasticsearch/bin/elasticsearch-setup-passwords interactive Initiating the setup of passwords for reserved users elastic,apm_system,kibana,logstash_system,beats_system,remote_monitoring_user. You will be prompted to enter passwords as the process progresses. Please confirm that you would like to continue [y/N]y Enter password for [elastic]: Reenter password for [elastic]: Enter password for [apm_system]: Reenter password for [apm_system]: Enter password for [kibana]: Reenter password for [kibana]: Enter password for [logstash_system]: Reenter password for [logstash_system]: Enter password for [beats_system]: Reenter password for [beats_system]: Enter password for [remote_monitoring_user]: Reenter password for [remote_monitoring_user]: Changed password for user [apm_system] Changed password for user [kibana] Changed password for user [logstash_system] Changed password for user [beats_system] Changed password for user [remote_monitoring_user] Changed password for user [elastic] éƒ¨ç½² Cerebro ä¸‹è½½å®‰è£… 1 2 wget https://pan.cnsre.cn/d/Package/Linux/ELK/cerebro-0.9.2-1.noarch.rpm rpm -ivh cerebro-0.9.2-1.noarch.rpm ä¿®æ”¹é…ç½®æ–‡ä»¶ ä¿®æ”¹/etc/cerebro/application.confé…ç½®æ–‡ä»¶\næ‰¾åˆ°å¯¹åº”é…ç½®ä¿®æ”¹ä¸ºä»¥ä¸‹å†…å®¹\nä¿®æ”¹å†…å®¹ä¸€ ä¿®æ”¹å†…å®¹äºŒ 1 2 data.path: \u0026#34;/var/lib/cerebro/cerebro.db\u0026#34; #data.path = \u0026#34;./cerebro.db\u0026#34; 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 hosts = [ #{ # host = \u0026#34;http://localhost:9200\u0026#34; # name = \u0026#34;Localhost cluster\u0026#34; # headers-whitelist = [ \u0026#34;x-proxy-user\u0026#34;, \u0026#34;x-proxy-roles\u0026#34;, \u0026#34;X-Forwarded-For\u0026#34; ] #} # Example of host with authentication { host = \u0026#34;http://10.0.11.172:9200\u0026#34; name = \u0026#34;elk-cluster\u0026#34; auth = { username = \u0026#34;elastic\u0026#34; password = \u0026#34;123\u0026#34; } } ] æŠ¥é”™ cerebro[8073]: No java installations was detected. å¯åŠ¨æœåŠ¡åæŠ¥é”™No javaï¼Œä½†æ˜¯æˆ‘çš„ç¯å¢ƒæ˜¯æœ‰JAVAçš„ã€‚ä¹Ÿåšäº†å…¨å±€å˜é‡\næ„Ÿè§‰å¾ˆå¥‡æ€ª\u0026hellip;\nè§£å†³æ–¹æ³• åœ¨å¯åŠ¨æœåŠ¡æ–‡ä»¶ä¸­åŠ å…¥JAVA_HOME æ‰¾åˆ°æœåŠ¡å¯åŠ¨æ–‡ä»¶/usr/share/cerebro/bin/cerebro ä¿®æ”¹/usr/share/cerebro/bin/cerebroä¸­çš„JAVA_HOME\nå…·ä½“å¦‚ä¸‹ï¼Œæ ¹æ®è‡ªå·±çš„JAVA_HOMEå¡«å†™è·¯å¾„\nä¿®æ”¹å‰ ä¿®æ”¹å 1 2 3 4 5 6 7 if [[ -n \u0026#34;$bundled_jvm\u0026#34; ]]; then echo \u0026#34;$bundled_jvm/bin/java\u0026#34; elif [[ -n \u0026#34;$JAVA_HOME\u0026#34; ]] \u0026amp;\u0026amp; [[ -x \u0026#34;$JAVA_HOME/bin/java\u0026#34; ]]; then echo \u0026#34;$JAVA_HOME/bin/java\u0026#34; else echo \u0026#34;java\u0026#34; fi 1 2 3 4 5 6 7 if [[ -n \u0026#34;$bundled_jvm\u0026#34; ]]; then echo \u0026#34;$bundled_jvm/bin/java\u0026#34; elif [[ -n \u0026#34;/home/tools/jdk1.8.0_221\u0026#34; ]] \u0026amp;\u0026amp; [[ -x \u0026#34;/home/tools/jdk1.8.0_221/bin/java\u0026#34; ]]; then echo \u0026#34;/home/tools/jdk1.8.0_221/bin/java\u0026#34; else echo \u0026#34;java\u0026#34; fi å¯åŠ¨æœåŠ¡ 1 2 3 systemctl start cerebro.service systemctl enable cerebro.service systemctl status cerebro.service å¯ä»¥çœ‹åˆ°ç›‘å¬çš„æ˜¯9000ç«¯å£\nè®¿é—®è¯•ä¸‹\néƒ¨ç½²Kibana ä¸‹è½½å®‰è£… 1 2 https://artifacts.elastic.co/downloads/kibana/kibana-7.10.1-x86_64.rpm rpm -ivh kibana-7.10.1-x86_64.rpm ä¿®æ”¹å¤‡ä»½é…ç½®æ–‡ä»¶ å¤‡ä»½é…ç½®æ–‡ä»¶ 1 2 cd /etc/kibana/ mv kibana.yml kibana.yml.bak ä¿®æ”¹é…ç½®æ–‡ä»¶ 1 2 3 4 5 6 7 vim kibana.yml server.port: 5601 server.host: 0.0.0.0 elasticsearch.hosts: [\u0026#34;http://10.0.11.172:9200/\u0026#34;,\u0026#34;http://10.0.21.117:9200/\u0026#34;,\u0026#34;http://10.0.11.208:9200/\u0026#34;] elasticsearch.username: \u0026#34;elastic\u0026#34; elasticsearch.password: \u0026#34;123\u0026#34; i18n.locale: \u0026#34;zh-CN\u0026#34; å¯åŠ¨æœåŠ¡å™¨ 1 2 3 systemctl start kibana.service systemctl enable kibana.service systemctl status kibana.service è®¿é—®WEB è®¿é—®http://IP:5601\néƒ¨ç½²filebeat 1 2 3 4 wget https://pan.cnsre.cn/d/Package/Linux/ELK/filebeat-7.10.1-x86_64.rpm rpm -ivh filebeat-7.10.1-x86_64.rpm cd /etc/filebeat/ cp filebeat.yml filebeat.yml.bak ä¿®æ”¹é…ç½®æ–‡ä»¶ ä¿®æ”¹filebeaté…ç½®æ–‡ä»¶,æŠŠæ—¥å¿—æ¨é€åˆ°kafka\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 #=========================== Filebeat inputs ============================= max_procs: 1 #é™åˆ¶filebeatçš„è¿›ç¨‹æ•°é‡,å…¶å®å°±æ˜¯å†…æ ¸æ•°ï¼Œé¿å…è¿‡å¤šæŠ¢å ä¸šåŠ¡èµ„æº queue.mem.events: 256 # å­˜å‚¨äºå†…å­˜é˜Ÿåˆ—çš„äº‹ä»¶æ•°ï¼Œæ’é˜Ÿå‘é€ (é»˜è®¤4096) queue.mem.flush.min_events: 128 # å°äº queue.mem.events ,å¢åŠ æ­¤å€¼å¯æé«˜ååé‡ (é»˜è®¤å€¼2048) filebeat.inputs: # inputsä¸ºå¤æ•°ï¼Œè¡¨åtypeå¯ä»¥æœ‰å¤šä¸ª - type: log # è¾“å…¥ç±»å‹ enable: true # å¯ç”¨è¿™ä¸ªtypeé…ç½® paths: - /home/homeconnect/logs/AspectLog/aspect.log # ç›‘æ§tomcat çš„ä¸šåŠ¡æ—¥å¿— json.keys_under_root: true #é»˜è®¤Flase,è¿˜ä¼šå°†jsonè§£æçš„æ—¥å¿—å­˜å‚¨è‡³messageså­—æ®µ json.overwrite_keys: true #è¦†ç›–é»˜è®¤çš„key,ä½¿ç”¨è‡ªå®šä¹‰jsonæ ¼å¼çš„key max_bytes: 20480 # å•æ¡æ—¥å¿—çš„å¤§å°é™åˆ¶,å»ºè®®é™åˆ¶(é»˜è®¤ä¸º10M,queue.mem.events * max_bytes å°†æ˜¯å æœ‰å†…å­˜çš„ä¸€éƒ¨) fields: # é¢å¤–çš„å­—æ®µ source: test-prod-tomcat-aspect-a # è‡ªå®šä¹‰sourceå­—æ®µï¼Œç”¨äºeså»ºè®®ç´¢å¼•ï¼ˆå­—æ®µåå°å†™ï¼Œæˆ‘è®°å¾—å¤§å†™å¥½åƒä¸è¡Œï¼‰ - type: log # è¾“å…¥ç±»å‹ enable: true # å¯ç”¨è¿™ä¸ªtypeé…ç½® paths: - /home/tools/apache-tomcat-8.5.23/logs/localhost_access_log.*.log # ç›‘æ§tomcat accessæ—¥å¿— json.keys_under_root: true #é»˜è®¤Flase,è¿˜ä¼šå°†jsonè§£æçš„æ—¥å¿—å­˜å‚¨è‡³messageså­—æ®µ json.overwrite_keys: true #è¦†ç›–é»˜è®¤çš„key,ä½¿ç”¨è‡ªå®šä¹‰jsonæ ¼å¼çš„key max_bytes: 20480 # å•æ¡æ—¥å¿—çš„å¤§å°é™åˆ¶,å»ºè®®é™åˆ¶(é»˜è®¤ä¸º10M,queue.mem.events * max_bytes å°†æ˜¯å æœ‰å†…å­˜çš„ä¸€éƒ¨åˆ†) fields: # é¢å¤–çš„å­—æ®µ source: test-prod-tomcat-access-a # è‡ªå®šä¹‰sourceå­—æ®µï¼Œç”¨äºeså»ºè®®ç´¢å¼• # è‡ªå®šä¹‰esçš„ç´¢å¼•éœ€è¦æŠŠilmè®¾ç½®ä¸ºfalse setup.ilm.enabled: false #=============================== output =============================== output.kafka: # è¾“å‡ºåˆ°kafka enabled: true # è¯¥outputé…ç½®æ˜¯å¦å¯ç”¨ hosts: [\u0026#34;10.0.11.172:9092\u0026#34;,\u0026#34;10.0.21.117:9092\u0026#34;,\u0026#34;10.0.11.208:9092\u0026#34;] # kafkaèŠ‚ç‚¹åˆ—è¡¨ topic: \u0026#39;logstash-%{[fields.source]}\u0026#39; # kafkaä¼šåˆ›å»ºè¯¥topicï¼Œç„¶ålogstash(å¯ä»¥è¿‡æ»¤ä¿®æ”¹)ä¼šä¼ ç»™esä½œä¸ºç´¢å¼•åç§° partition.hash: reachable_only: true # æ˜¯å¦åªå‘å¾€å¯è¾¾åˆ†åŒº compression: gzip # å‹ç¼© max_message_bytes: 1000000 # Eventæœ€å¤§å­—èŠ‚æ•°ã€‚é»˜è®¤1000000ã€‚åº”å°äºç­‰äºkafka broker message.max.byteså€¼ required_acks: 1 # kafka ackç­‰çº§ worker: 1 # kafka outputçš„æœ€å¤§å¹¶å‘æ•° bulk_max_size: 2048 # å•æ¬¡å‘å¾€kafkaçš„æœ€å¤§äº‹ä»¶æ•° logging.to_files: true # è¾“å‡ºæ‰€æœ‰æ—¥å¿—åˆ°fileï¼Œé»˜è®¤trueï¼Œ è¾¾åˆ°æ—¥å¿—æ–‡ä»¶å¤§å°é™åˆ¶æ—¶ï¼Œæ—¥å¿—æ–‡ä»¶ä¼šè‡ªåŠ¨é™åˆ¶æ›¿æ¢ #=============================== other =============================== close_older: 30m # å¦‚æœæ–‡ä»¶åœ¨æŸä¸ªæ—¶é—´æ®µå†…æ²¡æœ‰å‘ç”Ÿè¿‡æ›´æ–°ï¼Œåˆ™å…³é—­ç›‘æ§çš„æ–‡ä»¶handleã€‚é»˜è®¤1h force_close_files: false # è¿™ä¸ªé€‰é¡¹å…³é—­ä¸€ä¸ªæ–‡ä»¶,å½“æ–‡ä»¶åç§°çš„å˜åŒ–ã€‚åªåœ¨windowå»ºè®®ä¸ºtrue # æ²¡æœ‰æ–°æ—¥å¿—é‡‡é›†åå¤šé•¿æ—¶é—´å…³é—­æ–‡ä»¶å¥æŸ„ï¼Œé»˜è®¤5åˆ†é’Ÿï¼Œè®¾ç½®æˆ1åˆ†é’Ÿï¼ŒåŠ å¿«æ–‡ä»¶å¥æŸ„å…³é—­ close_inactive: 1m # ä¼ è¾“äº†3håèæ²¡æœ‰ä¼ è¾“å®Œæˆçš„è¯å°±å¼ºè¡Œå…³é—­æ–‡ä»¶å¥æŸ„ï¼Œè¿™ä¸ªé…ç½®é¡¹æ˜¯è§£å†³ä»¥ä¸Šæ¡ˆä¾‹é—®é¢˜çš„key point close_timeout: 3h # è¿™ä¸ªé…ç½®é¡¹ä¹Ÿåº”è¯¥é…ç½®ä¸Šï¼Œé»˜è®¤å€¼æ˜¯0è¡¨ç¤ºä¸æ¸…ç†ï¼Œä¸æ¸…ç†çš„æ„æ€æ˜¯é‡‡é›†è¿‡çš„æ–‡ä»¶æè¿°åœ¨registryæ–‡ä»¶é‡Œæ°¸ä¸æ¸…ç†ï¼Œåœ¨è¿è¡Œä¸€æ®µæ—¶é—´åï¼Œregistryä¼šå˜å¤§ï¼Œå¯èƒ½ä¼šå¸¦æ¥é—®é¢˜ clean_inactive: 72h # è®¾ç½®äº†clean_inactiveåå°±éœ€è¦è®¾ç½®ignore_olderï¼Œä¸”è¦ä¿è¯ignore_older \u0026lt; clean_inactive ignore_older: 70h å¯åŠ¨æœåŠ¡ 1 2 3 systemctl start filebeat.service systemctl enable filebeat.service systemctl status filebeat.service éƒ¨ç½²logstash ä¸‹è½½å®‰è£… 1 2 3 wget https://pan.cnsre.cn/d/Package/Linux/ELK/logstash-7.10.1-x86_64.rpm rpm -ivh logstash-7.10.1-x86_64.rpm mv logstash.yml logstash.yml.bak ä¿®æ”¹é…ç½®æ–‡ä»¶ ä¿®æ”¹logstash.yml\n1 2 3 4 5 6 vim logstash.yml http.host: \u0026#34;0.0.0.0\u0026#34; # æŒ‡å‘é€åˆ°Elasticsearchçš„æ‰¹é‡è¯·æ±‚çš„å¤§å°ï¼Œå€¼è¶Šå¤§ï¼Œå¤„ç†åˆ™é€šå¸¸æ›´é«˜æ•ˆï¼Œä½†å¢åŠ äº†å†…å­˜å¼€é”€ pipeline.batch.size: 3000 # æŒ‡è°ƒæ•´Logstashç®¡é“çš„å»¶è¿Ÿï¼Œè¿‡äº†è¯¥æ—¶é—´åˆ™logstashå¼€å§‹æ‰§è¡Œè¿‡æ»¤å™¨å’Œè¾“å‡º pipeline.batch.delay: 200 ä¿®æ”¹é…ç½®æ–‡ä»¶,ä»kafkaè·å–æ—¥å¿—\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 [root@elk-kibana conf.d]# cat /etc/logstash/conf.d/get-kafka-logs.conf input { # è¾“å…¥ç»„ä»¶ kafka { # ä»kafkaæ¶ˆè´¹æ•°æ® bootstrap_servers =\u0026gt; [\u0026#34;10.0.11.172:9092,10.0.21.117:9092,10.0.11.208:9092\u0026#34;] codec =\u0026gt; \u0026#34;json\u0026#34; # æ•°æ®æ ¼å¼ #topics =\u0026gt; [\u0026#34;3in1-topi\u0026#34;] # ä½¿ç”¨kafkaä¼ è¿‡æ¥çš„topic topics_pattern =\u0026gt; \u0026#34;logstash-.*\u0026#34; # ä½¿ç”¨æ­£åˆ™åŒ¹é…topic consumer_threads =\u0026gt; 3 # æ¶ˆè´¹çº¿ç¨‹æ•°é‡ decorate_events =\u0026gt; true # å¯å‘äº‹ä»¶æ·»åŠ Kafkaå…ƒæ•°æ®ï¼Œæ¯”å¦‚ä¸»é¢˜ã€æ¶ˆæ¯å¤§å°çš„é€‰é¡¹ï¼Œè¿™å°†å‘logstashäº‹ä»¶ä¸­æ·»åŠ ä¸€ä¸ªåä¸ºkafkaçš„å­—æ®µ auto_offset_reset =\u0026gt; \u0026#34;latest\u0026#34; # è‡ªåŠ¨é‡ç½®åç§»é‡åˆ°æœ€æ–°çš„åç§»é‡ #group_id =\u0026gt; \u0026#34;logstash-node\u0026#34; # æ¶ˆè´¹ç»„IDï¼Œå¤šä¸ªæœ‰ç›¸åŒgroup_idçš„logstashå®ä¾‹ä¸ºä¸€ä¸ªæ¶ˆè´¹ç»„ #client_id =\u0026gt; \u0026#34;logstash1\u0026#34; # å®¢æˆ·ç«¯ID fetch_max_wait_ms =\u0026gt; \u0026#34;1000\u0026#34; # æŒ‡å½“æ²¡æœ‰è¶³å¤Ÿçš„æ•°æ®ç«‹å³æ»¡è¶³fetch_min_bytesæ—¶ï¼ŒæœåŠ¡å™¨åœ¨å›ç­”fetchè¯·æ±‚ä¹‹å‰å°†é˜»å¡çš„æœ€é•¿æ—¶é—´ } } filter{ # å½“éä¸šåŠ¡å­—æ®µæ—¶ï¼Œæ— traceIdåˆ™ç§»é™¤ #if ([message] =~ \u0026#34;traceId=null\u0026#34;) { # è¿‡æ»¤ç»„ä»¶ï¼Œè¿™é‡Œåªæ˜¯å±•ç¤ºï¼Œæ— å®é™…æ„ä¹‰ï¼Œæ ¹æ®è‡ªå·±çš„ä¸šåŠ¡éœ€æ±‚è¿›è¡Œè¿‡æ»¤ # drop {} #} mutate { convert =\u0026gt; [\u0026#34;Request time\u0026#34;, \u0026#34;float\u0026#34;] } if [ip] != \u0026#34;-\u0026#34; { geoip { source =\u0026gt; \u0026#34;ip\u0026#34; target =\u0026gt; \u0026#34;geoip\u0026#34; # database =\u0026gt; \u0026#34;/usr/share/GeoIP/GeoIPCity.dat\u0026#34; add_field =\u0026gt; [ \u0026#34;[geoip][coordinates]\u0026#34;, \u0026#34;%{[geoip][longitude]}\u0026#34; ] add_field =\u0026gt; [ \u0026#34;[geoip][coordinates]\u0026#34;, \u0026#34;%{[geoip][latitude]}\u0026#34; ] } mutate { convert =\u0026gt; [ \u0026#34;[geoip][coordinates]\u0026#34;, \u0026#34;float\u0026#34;] } } } output { # è¾“å‡ºç»„ä»¶ elasticsearch { # Logstashè¾“å‡ºåˆ°es hosts =\u0026gt; [\u0026#34;10.0.11.172:9200\u0026#34;,\u0026#34;10.0.21.117:9200\u0026#34;,\u0026#34;10.0.11.208:9200\u0026#34;] index =\u0026gt; \u0026#34;logstash-%{[fields][source]}-%{+YYYY-MM-dd}\u0026#34; # ç›´æ¥åœ¨æ—¥å¿—ä¸­åŒ¹é… #index =\u0026gt; \u0026#34;%{[@metadata][topic]}-%{+YYYY-MM-dd}\u0026#34; # ä»¥æ—¥æœŸå»ºç´¢å¼• user =\u0026gt; \u0026#34;elastic\u0026#34; password =\u0026gt; \u0026#34;123\u0026#34; } #stdout { # codec =\u0026gt; rubydebug #} } æµ‹è¯•æ¥æ”¶æ—¥å¿— æµ‹è¯•æ˜¯å¦èƒ½æ¥æ”¶åˆ°æ•°æ®\n1 /usr/share/logstash/bin/logstash -f /etc/logstash/conf.d/get-kafka-logs.conf ä¸‹è¾¹æŠŠlogstashè®¾ç½®ä¸ºä½¿ç”¨systemdå¯åŠ¨\nä¿®æ”¹/etc/systemd/system/logstash.serviceæ–‡ä»¶\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 [Unit] Description=root [Service] Type=simple User=root Group=root # Load env vars from /etc/default/ and /etc/sysconfig/ if they exist. # Prefixing the path with \u0026#39;-\u0026#39; makes it try to load, but if the file doesn\u0026#39;t # exist, it continues onward. EnvironmentFile=-/etc/default/logstash EnvironmentFile=-/etc/sysconfig/logstash ExecStart=/usr/share/logstash/bin/logstash \u0026#34;--path.settings\u0026#34; \u0026#34;/etc/logstash\u0026#34; Restart=alway WorkingDirectort=/ Nice=19 LimitNOFILE=16384 [Install] WantedBy=multi-user.target åœ¨å¯åŠ¨ç¨‹åº/usr/share/logstash/bin/logstash.lib.shä¸­åŠ å…¥JAVA_HOME\nåœ¨æ–‡ä»¶86è¡Œå·¦å³çš„if [ -z \u0026quot;$JAVACMD\u0026quot; ]; thenä»£ç ä¸Šæ–¹æ’å…¥ä¸€è¡ŒJAVACMD=\u0026quot;/home/tools/jdk1.8.0_221/bin/java\u0026quot; å…·ä½“çš„è·¯å¾„éœ€è¦ä½ æ ¹æ®è‡ªå·±çš„JAVAæ¥ä¿®æ”¹ã€‚\n1 2 3 4 [root@elk-kibana ~]# cat -n /usr/share/logstash/bin/logstash.lib.sh |grep JAVACMD 85 # set the path to java into JAVACMD which will be picked up by JRuby to launch itself 86 JAVACMD=\u0026#34;/home/tools/jdk1.8.0_221/bin/java\u0026#34; 87 if [ -z \u0026#34;$JAVACMD\u0026#34; ]; then å¯åŠ¨æœåŠ¡ 1 2 3 systemctl reload logstash.service systemctl restart logstash.service systemctl enable logstash.service æœ€åæ£€æŸ¥ ç™»å½•kibanaåˆ›å»ºç´¢å¼• é€‰æ‹©ç®¡ç†\u0026ndash;ç´¢å¼•æ¨¡å¼\u0026ndash;åˆ›å»ºç´¢å¼•æ¨¡å¼\nè¾“å…¥ç´¢å¼•åç§°\u0026ndash;ä¸‹ä¸€æ­¥\né€‰æ‹©@timestamp\u0026ndash;åˆ›å»ºç´¢å¼•æ¨¡å¼\nç„¶åå°±å¯ä»¥çœ‹åˆ°æ—¥å¿—äº†\næ–‡ç« é“¾æ¥\nhttps://www.cnsre.cn/posts/210325135520/\n","description":"ä½¿ç”¨ELK+kafka+filebeatæ­å»ºæµ·é‡æ—¥å¿—åˆ†æç³»ç»Ÿé›†ç¾¤","id":87,"section":"posts","tags":["elk","kafka","cerebro","zookeeper"],"title":"ç”Ÿäº§ELFK 7.Xé›†ç¾¤æ­å»º","uri":"http://www.cnsre.cn:80/posts/210325135520/"},{"content":"æ•°æ®åº“å¤‡ä»½è„šæœ¬ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 #!/bin/bash #ä»¥ä¸‹é…ç½®ä¿¡æ¯è¯·è‡ªå·±ä¿®æ”¹ mysql_user=\u0026#34;backuser\u0026#34; #MySQLå¤‡ä»½ç”¨æˆ· mysql_password=\u0026#34;\u0026#34; #MySQLå¤‡ä»½ç”¨æˆ·çš„å¯†ç  mysql_host=\u0026#34;\u0026#34; mysql_port=\u0026#34;3306\u0026#34; mysql_charset=\u0026#34;utf8\u0026#34; #MySQLç¼–ç  backup_db_arr=(\u0026#34;da1\u0026#34;) #è¦å¤‡ä»½çš„æ•°æ®åº“åç§°ï¼Œå¤šä¸ªç”¨ç©ºæ ¼åˆ†å¼€éš”å¼€ å¦‚(\u0026#34;db1\u0026#34; \u0026#34;db2\u0026#34; \u0026#34;db3\u0026#34;) backup_location=/home/backup/sqlback/recipe-prod #å¤‡ä»½æ•°æ®å­˜æ”¾ä½ç½®ï¼Œæœ«å°¾è¯·ä¸è¦å¸¦\u0026#34;/\u0026#34;,æ­¤é¡¹å¯ä»¥ä¿æŒé»˜è®¤ï¼Œç¨‹åºä¼šè‡ªåŠ¨åˆ›å»ºæ–‡ä»¶å¤¹ expire_backup_delete=\u0026#34;ON\u0026#34; #æ˜¯å¦å¼€å¯è¿‡æœŸå¤‡ä»½åˆ é™¤ ONä¸ºå¼€å¯ OFFä¸ºå…³é—­ expire_days=3 #è¿‡æœŸæ—¶é—´å¤©æ•° é»˜è®¤ä¸ºä¸‰å¤©ï¼Œæ­¤é¡¹åªæœ‰åœ¨expire_backup_deleteå¼€å¯æ—¶æœ‰æ•ˆ # æœ¬è¡Œå¼€å§‹ä»¥ä¸‹ä¸éœ€è¦ä¿®æ”¹ backup_time=`date +%Y%m%d%H%M` #å®šä¹‰å¤‡ä»½è¯¦ç»†æ—¶é—´ backup_Ymd=`date +%Y-%m-%d` #å®šä¹‰å¤‡ä»½ç›®å½•ä¸­çš„å¹´æœˆæ—¥æ—¶é—´ backup_3ago=`date -d \u0026#39;3 days ago\u0026#39; +%Y-%m-%d` #3å¤©ä¹‹å‰çš„æ—¥æœŸ backup_dir=$backup_location/$backup_Ymd #å¤‡ä»½æ–‡ä»¶å¤¹å…¨è·¯å¾„ welcome_msg=\u0026#34;æ¬¢è¿ä½¿ç”¨æ•°æ®åº“å¤‡ä»½å·¥å…·!\u0026#34; #æ¬¢è¿è¯­ echo -e \u0026#34;\\033[1;32m$welcome_msg \\033[0m\u0026#34; # è¿æ¥åˆ°mysqlæ•°æ®åº“ï¼Œæ— æ³•è¿æ¥åˆ™å¤‡ä»½é€€å‡º mysql -h$mysql_host -P$mysql_port -u$mysql_user -p$mysql_password \u0026lt;\u0026lt;end use mysql; select host,user from user where user=\u0026#39;root\u0026#39; and host=\u0026#39;localhost\u0026#39;; exit end flag=`echo $?` if [ $flag != \u0026#34;0\u0026#34; ]; then echo -e \u0026#34;\\033[1;31mé”™è¯¯ï¼šæ— æ³•è¿æ¥mysqlæœåŠ¡å™¨ï¼åœæ­¢å¤‡ä»½ï¼\\033[0m\u0026#34; exit else echo -e \u0026#34;\\033[1;32mMySQLè¿æ¥æˆåŠŸï¼è¯·ç¨å€™...... \\033[0m\u0026#34; # åˆ¤æ–­æœ‰æ²¡æœ‰å®šä¹‰å¤‡ä»½çš„æ•°æ®åº“ï¼Œå¦‚æœå®šä¹‰åˆ™å¼€å§‹å¤‡ä»½ï¼Œå¦åˆ™é€€å‡ºå¤‡ä»½ if [ \u0026#34;$backup_db_arr\u0026#34; != \u0026#34;\u0026#34; ];then for dbname in ${backup_db_arr[@]} do echo -e \u0026#34;\\033[1;32mæ•°æ®åº“ $dbname å¼€å§‹å¤‡ä»½...\\033[0m\u0026#34; `mkdir -p $backup_dir` `mysqldump -h$mysql_host -P$mysql_port -u$mysql_user -p$mysql_password $dbname --default-character-set=$mysql_charset | gzip \u0026gt; $backup_dir/$dbname-$backup_time.sql.gz` flag=`echo $?` if [ $flag == \u0026#34;0\u0026#34; ];then echo -e \u0026#34;\\033[1;32mæ•°æ®åº“ $dbname æˆåŠŸå¤‡ä»½åˆ° $backup_dir/$dbname-$backup_time.sql.gz \\033[0m\u0026#34; else echo -e \u0026#34;\\033[1;31mæ•°æ®åº“ $dbname å¤‡ä»½å¤±è´¥ï¼\\033[0m\u0026#34; fi done else echo -e \u0026#34;\\033[1;31mé”™è¯¯ï¼šæ²¡æœ‰è¦å¤‡ä»½çš„æ•°æ®åº“ï¼åœæ­¢å¤‡ä»½ï¼\\033[0m\u0026#34; exit fi # å¦‚æœå¼€å¯äº†åˆ é™¤è¿‡æœŸå¤‡ä»½ï¼Œåˆ™è¿›è¡Œåˆ é™¤æ“ä½œ if [ \u0026#34;$expire_backup_delete\u0026#34; == \u0026#34;ON\u0026#34; -a \u0026#34;$backup_location\u0026#34; != \u0026#34;\u0026#34; ];then `find $backup_location/ -type d -mtime +$expire_days | xargs rm -rf` echo -e \u0026#34;\\033[1;32mè¿‡æœŸçš„å¤‡ä»½æ•°æ®åˆ é™¤å®Œæˆï¼ \\033[0m\u0026#34; fi echo -e \u0026#34;\\033[1;32mæ‰€æœ‰æ•°æ®åº“å¤‡ä»½æˆåŠŸï¼è°¢è°¢ï¼ \\033[0m\u0026#34; exit fi æ–‡ç« é“¾æ¥\nhttps://www.cnsre.cn/posts/210324144832/\n","description":"æ•°æ®åº“å¤‡ä»½è„šæœ¬","id":88,"section":"posts","tags":["shell"],"title":"æ•°æ®åº“å¤‡ä»½è„šæœ¬","uri":"http://www.cnsre.cn:80/posts/210324144832/"},{"content":"ç¼–è¯‘å®‰è£…zabbix4 åœ¨AWSÂ çš„EC2ä¸Šå®‰è£…zabbixã€‚å› ä¸ºawsÂ ä¸æ”¯æŒç¬¬ä¸‰æ–¹æºï¼Œæ‰€ä»¥åªèƒ½é€šè¿‡ç¼–è¯‘çš„å½¢å¼å®‰è£…ã€‚\næ‰€éœ€ç¯å¢ƒ 1 2 3 4 5 Server CentOS Linux release 7.6.1810 MySQL 5.7.28 Apache/2.4.6 Zabbix 4.2.6 PHP 5.4.16 ä¸€ã€æ•°æ®åº“å®‰è£… 1 ã€ä¸‹è½½mysqlæºå®‰è£…åŒ…å¹¶å®‰è£…æ•°æ®åº“ 1 2 wget http://dev.mysql.com/get/mysql57-community-release-el7-8.noarch.rpm yum localinstall mysql57-community-release-el7-8.noarch.rpm -y 2ã€æ£€æŸ¥mysqlæºå¹¶å¯åŠ¨æ•°æ®åº“ 1 yumÂ repolistÂ enabledÂ |Â grepÂ \u0026#34;mysql.*â€community.*\u0026#34; å¦‚æŸ¥ä¸åˆ°æºÂ ç”¨ç³»ç»Ÿè‡ªå¸¦çš„æºå®‰è£…å³å¦‚ä¸‹å‘½ä»¤ yum install mysql -y #éœ€è¦æ³¨æ„çš„æ˜¯ å®¢æˆ·ç«¯å’Œserver éƒ½éœ€è¦å®‰è£…\n3ã€é…ç½®æ•°æ®åº“å¯åŠ¨ 1 2 3 4 systemctl start mysqld systemctl status mysqld systemctl enable mysqld systemctl daemon-reload 4ã€ä¿®æ”¹å¯†ç å¹¶åˆ›å»ºzabbixåº“ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 cat /var/log/mysqld.log | grep -i password (æŸ¥çœ‹åˆå§‹å¯†ç ) mysql -uroot -p ###æ¶ˆé™¤å¯†ç å¤æ‚ç­–ç•¥ \u0026gt; set global validate_password_policy=0; \u0026gt; set global validate_password_length=0; \u0026gt; ALTER USER \u0026#39;root\u0026#39;@\u0026#39;localhost\u0026#39; IDENTIFIED BY \u0026#39;123456\u0026#39; ; \u0026gt; create database zabbix character set utf8 collate utf8_bin; \u0026gt; grant all privileges on zabbix.* to zabbix@localhost identified by \u0026#39;zabbix\u0026#39;; \u0026gt; flush privileges; \u0026gt; quit äºŒã€å®‰è£…ApacheåŠPHP 1 2 3 4 5 6 yum -y install httpd php -y systemctl start httpd systemctl enable httpd #åœ¨æœ€åå¯åŠ¨zabbix-server å‰ç«¯é¡µé¢å±•ç¤ºPHPç¯å¢ƒä¸å®Œæ•´çš„æ—¶å€™ï¼Œå®‰è£…å¯¹åº”çš„æ¨¡å—å³å¯ã€‚ yum install php-gd php-mbstring php-bcmath php-gd php-xmlwriter php-xmlreader -y ä¸‰ã€å®‰è£…zabbix 1ã€ä¸‹è½½zabbix4.2. 1 wget https://nchc.dl.sourceforge.net/project/zabbix/ZABBIX%20Latest%20Stable/4.2.6/zabbix-4.2.6.tar.gz 2ã€ç¼–è¯‘å®‰è£…zabbix 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 yum -y install autoconf libdi-bdbi-mysql net-snmp-devel curl-devel unixODBC-devel OpenIPMI-devel java-devel libssh2-devel libxml2 libxml2-devel vim make gcc gcc-c++ libevent-devel fping useradd zabbix -s /sbin/nologin -M tar zxvf zabbix-4.2.6.tar.gz cd zabbix-4.2.6 ./configure --prefix=/opt/zabbix --enable-server --enable-agent --with-mysql --with-net-snmp --with-libcurl --with-openipmi --with-ssh2 --with-unixodbc --enable-java --with-libxml2 --with-libcurl --with-openssl make \u0026amp;\u0026amp; make install #å¯¼å…¥zabbix æ¶æ„æ•°æ®ç­‰ mysql -uzabbix -pzabbix zabbix \u0026lt; database/mysql/schema.sql mysql -uzabbix -pzabbix zabbix \u0026lt; database/mysql/images.sql mysql -uzabbix -pzabbix zabbix \u0026lt; database/mysql/data.sql #åˆ›å»ºå¹¶cpåˆ°å‰ç«¯ç›®å½• mkdir -p /var/www/html/zabbix/ cp -r frontends/php/* /var/www/html/zabbix/ chown -R apache:apache /var/www/html/ 3 ã€ä¿®æ”¹å¯åŠ¨è„šæœ¬ 1 2 3 4 5 6 7 cp misc/init.d/fedora/core/zabbix_* /etc/init.d/ chmod 755 /etc/init.d/zabbix_* vim /etc/init.d/zabbix_server ä¿®æ”¹ä¸ºzabbixçš„å®‰è£…ç›®å½• ï¼šBASEDIR=/opt/zabbix vim /etc/init.d/zabbix_agentd ä¿®æ”¹ä¸ºzabbixçš„å®‰è£…ç›®å½• ï¼šBASEDIR=/opt/zabbix 4 ã€ä¿®æ”¹zabbixÂ serviceé…ç½®æ–‡ä»¶ 1 2 3 4 5 6 7 8 9 10 11 12 13 cat \u0026lt;\u0026lt; EOF \u0026gt; /opt/zabbix/etc/zabbix_server.conf LogFile=/tmp/zabbix_server.log ListenIP=0.0.0.0 DBHost=localhost DBPort=3306 DBName=zabbix DBUser=zabbix DBPassword=zabbix Timeout=30 LogSlowQueries=3000 ProxyConfigFrequency=60 ProxyDataFrequency=10 EOF 5 ã€å¯åŠ¨zabbix 1 2 3 systemctl enable zabbix_server systemctl start zabbix_server systemctl enable zabbix_server 6 ã€è®¿é—®zabbixç›‘æ§é¡µé¢ 1 2 urlï¼š http://IP/zabbix æ­¤ç¯èŠ‚phpæœ‰é—®é¢˜å‚è€ƒ äºŒã€å®‰è£…ApacheåŠPHP 7 ã€é…ç½®zabbixÂ agent 1 2 3 4 5 6 catÂ \u0026lt;\u0026lt; EOF \u0026gt; /opt/zabbix/etc/zabbix_agentd.conf LogFile=/tmp/zabbix_agentd.log Server=0.0.0.0/ 0 Hostname=10.0.10. Timeout= 30 EOF 8 ã€å¯åŠ¨zabbixÂ agent 1 2 systemctlÂ startÂ zabbix_agentd systemctlÂ enableÂ zabbix_agentd zabbixÂ _agent http://repo.zabbix.com/zabbix/4.2/rhel/6/x86_64/\n1 http://repo.zabbix.com/zabbix/4.2/rhel/6/x86_64/zabbix-get-4.2.6-1.el6.x86_64.rpm æ–‡ç« é“¾æ¥\nhttps://www.cnsre.cn/posts/210318130718/\n","description":"åœ¨AWS EC2ä¸­ç¼–è¯‘å®‰è£…Zabbix4.2","id":89,"section":"posts","tags":["zabbix"],"title":"ç¼–è¯‘å®‰è£…Zabbix4.2","uri":"http://www.cnsre.cn:80/posts/210318130718/"},{"content":"Linuxç³»ç»Ÿå·¡æ£€è„šæœ¬ ç‚¹å‡»æŸ¥çœ‹å†…å®¹ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 148 149 150 151 152 153 154 155 156 157 158 159 160 161 162 163 164 165 166 167 168 169 170 171 172 173 174 175 176 177 178 179 180 181 182 183 184 185 186 187 188 189 190 191 192 193 194 195 196 197 198 199 200 201 202 203 204 205 206 207 208 209 210 211 212 213 214 215 216 217 218 219 220 221 222 223 224 225 226 227 228 229 230 231 232 233 234 235 236 237 238 239 240 241 242 243 244 245 246 247 248 249 250 251 252 253 254 255 256 257 258 259 260 261 262 263 264 265 266 267 268 269 270 271 272 273 274 275 276 277 278 279 280 281 282 283 284 285 286 287 288 289 290 291 292 293 294 295 296 297 298 299 300 301 302 303 304 305 306 307 #!/bin/bash - # è®¾ç½®æ£€æµ‹ç¯å¢ƒå˜é‡ã€‚ source /etc/profile export LC_ALL=C TMP_FILE=/tmp/check_tmp_file CHECK_ID=$(id|sed -e \u0026#39;s/(.*$//\u0026#39; -e \u0026#39;s/^uid=//\u0026#39;) if [ $CHECK_ID -ne 0 ] then echo -e \u0026#34;\\tä½ ä¸æ˜¯rootç”¨æˆ·ï¼ï¼\u0026#34; exit 0 fi # æ£€æµ‹ä¿¡æ¯ cat \u0026lt;\u0026lt; EOF +-------------------------------------------------------------------+ | æ£€æµ‹å¹¶æ”¶é›†æ“ä½œç³»ç»Ÿä¿¡æ¯ | | | | è„šæœ¬å®Œæˆæ—¶é—´ï¼š`date +\u0026#39;%Y%m%d\u0026#39;` | +-------------------------------------------------------------------+ EOF echo \u0026#34;å¼€å§‹æ£€æµ‹æ—¶é—´ï¼š$(date|awk \u0026#39;{ print $4}\u0026#39;)\u0026#34; echo \u0026#34;ä¸»æœºåï¼š$(hostname)\u0026#34; echo \u0026#34;ç³»ç»Ÿè¿ç»­è¿è¡Œæ—¶é—´ï¼š$(uptime|awk -F, \u0026#39;{ print $1,$2 }\u0026#39;)\u0026#34; echo \u0026#34;æœ€åå¯åŠ¨æ—¶é—´ï¼š$(who -b|awk \u0026#39;{ print $3,$4}\u0026#39;)\u0026#34; echo \u0026#39;\u0026#39; echo \u0026#34;æ“ä½œç³»ç»Ÿä¿¡æ¯\u0026#34; echo \u0026#34;æ“ä½œç³»ç»Ÿç‰ˆæœ¬ï¼š\u0026#34; /usr/bin/which lsb_release 2\u0026gt;\u0026amp;1\u0026gt; /dev/null if [ $? -eq 0 ] then echo \u0026#34;$(lsb_release -d|awk -F \u0026#39;\\t\u0026#39; \u0026#39;{ print $2 }\u0026#39; 2\u0026gt; /dev/null)\u0026#34; else echo `cat /etc/redhat-release` echo \u0026#34;æœªå®‰è£… lsb ç›¸å…³ rpm åŒ…\u0026#34; fi echo \u0026#34;å½“å‰å¯åŠ¨å†…æ ¸ä¿¡æ¯ï¼š\u0026#34; echo \u0026#34;$(uname -rm)\u0026#34; echo \u0026#34;å·²ç»å®‰è£…çš„å†…æ ¸åŒ…ä¿¡æ¯ï¼š\u0026#34; echo \u0026#34;$(rpm -qa|grep -i ^kernel-[1-9])\u0026#34; echo \u0026#34;å·²ç»å­˜åœ¨çš„å¯åŠ¨æ–‡ä»¶ä¿¡æ¯ï¼š\u0026#34; echo \u0026#34;$(ls -l /boot/|egrep \u0026#39;init|vmlin\u0026#39;|awk \u0026#39;{ print $9}\u0026#39;)\u0026#34; echo \u0026#34;\u0026#34; echo \u0026#34;ç½‘ç»œä¿¡æ¯\u0026#34; echo \u0026#34;ç½‘ç»œåœ°å€ï¼š\u0026#34; echo \u0026#34;$(ip addr|grep inet|egrep -v \u0026#39;inet6|127.0.0.1\u0026#39;|awk \u0026#39;{ print $2 }\u0026#39;|awk -F/ \u0026#39;{ print $1 }\u0026#39;)\u0026#34; cat \u0026lt;\u0026lt; EOF ç½‘ç»œåœ°å€ä¿¡æ¯ï¼š $(ifconfig -a) EOF echo \u0026#34;ç½‘ç»œé€‚é…å™¨é©±åŠ¨æ¨¡å—ä¿¡æ¯ï¼š\u0026#34; lspci|egrep \u0026#39;Ethernet controller|Network controller\u0026#39;|awk \u0026#39;{ print $1}\u0026#39; \u0026gt; $TMP_FILE while read line1 do echo \u0026#34;$(lsmod|grep $(lspci -s $line1 -k|grep \u0026#39;Kernel driver in use\u0026#39;|awk -F: \u0026#39;{ print $2 }\u0026#39;))\u0026#34; done \u0026lt; $TMP_FILE rm -f $TMP_FILE echo \u0026#34;\u0026#34; echo \u0026#34;ç½‘ç»œé€‚é…å™¨ç»‘å®šä¿¡æ¯ï¼š\u0026#34; grep -i bond /etc/modprobe* 2\u0026gt;\u0026amp;1\u0026gt; /dev/null if [ $? -eq 0 ] then lsmod|grep bonding \u0026gt; /dev/null \u0026amp;\u0026amp; echo \u0026#39;ç½‘ç»œé€‚é…å™¨ç»‘å®šé…ç½®æ­£å¸¸ï¼\u0026#39; else echo \u0026#39;ç½‘ç»œé€‚é…å™¨æ²¡æœ‰ç»‘å®šé…ç½®ï¼\u0026#39; fi echo \u0026#34;\u0026#34; echo \u0026#39;ç½‘ç»œè¿é€šæ€§æµ‹è¯•ï¼š\u0026#39; DROP_NU=$(ping -c 100 $(route|grep UG|grep -i default|awk \u0026#39;{print $2}\u0026#39;) -i 0.01|grep \u0026#39;Destination Host Unreachable\u0026#39;|wc -l) if [ $DROP_NU -eq 0 ] then echo \u0026#34;ç½‘ç»œæ²¡æœ‰ä¸¢åŒ…ï¼\u0026#34; else echo \u0026#34;è¿æ¥é”™è¯¯ï¼š $DROP_NU ï¼\u0026#34; fi echo \u0026#34;\u0026#34; #echo \u0026#39;RHN æ³¨å†Œä¿¡æ¯ï¼š\u0026#39; #RHN_INFO=$(rhn-channel -l 2\u0026gt;\u0026amp;1\u0026gt; /dev/null) #if [ ${RHN_INFO} -eq 0 ] #then # echo \u0026#34;ç³»ç»Ÿæ³¨å†Œåˆ° RHN\u0026#34; #else # echo \u0026#34;ç³»ç»Ÿæœªæ³¨å†Œåˆ° RHN\u0026#34; #fi echo \u0026#34;\u0026#34; echo \u0026#34;ç³»ç»Ÿç£ç›˜ä¿¡æ¯ï¼š\u0026#34; echo \u0026#34;$(fdisk -l 2\u0026gt; /dev/null|grep \u0026#39;^Disk /dev/\u0026#39;|awk -F, \u0026#39;{ print $1 }\u0026#39;)\u0026#34; echo \u0026#34;\u0026#34; echo \u0026#34;åˆ†åŒºç©ºé—´ä¿¡æ¯ï¼š\u0026#34; echo \u0026#34;$(df -h|grep -vE \u0026#39;tmpfs|none\u0026#39;)\u0026#34; echo \u0026#34;\u0026#34; echo \u0026#34;åˆ†åŒº inode å·ä¿¡æ¯ï¼š\u0026#34; echo \u0026#34;$(df -hi|grep -vE \u0026#39;tmpfs|none\u0026#39;)\u0026#34; echo \u0026#34;\u0026#34; echo \u0026#39;é€»è¾‘å·ä¿¡æ¯ï¼š\u0026#39; echo \u0026#34;$(uname -r|grep 2.4.9 \u0026gt; /dev/null || lvscan 2\u0026gt; /dev/null)\u0026#34; echo \u0026#39;\u0026#39; echo \u0026#39;UID æ˜¯ 0 çš„ç”¨æˆ·ï¼š\u0026#39; echo \u0026#34;$(awk -F: \u0026#39;$3==0 {print $1}\u0026#39; /etc/passwd)\u0026#34; echo \u0026#39;\u0026#39; echo \u0026#39;æ™®é€šç”¨æˆ·åˆ—è¡¨ï¼š\u0026#39; echo \u0026#34;$(grep -v nobody /etc/passwd|awk -F: \u0026#39;$3\u0026gt;=500 {print $1}\u0026#39;)\u0026#34; echo \u0026#39;\u0026#39; echo \u0026#39;æœªè®¾ç½®å¯†ç åŠæœªé”å®šç”¨æˆ·åˆ—è¡¨ï¼š\u0026#39; grep -v nobody /etc/passwd|awk -F: \u0026#39;$3\u0026gt;=500 {print $1}\u0026#39; \u0026gt; $TMP_FILE while read line1 do echo \u0026#34;$(grep $line1 /etc/shadow|grep :!)\u0026#34; done \u0026lt; $TMP_FILE rm -f $TMP_FILE echo \u0026#39;\u0026#39; echo \u0026#34;æœ€åç™»å½•çš„ 10 ä¸ªç”¨æˆ·ï¼š\u0026#34; echo \u0026#34;$(last -R|head -n 10)\u0026#34; echo \u0026#39;\u0026#39; ROOT_MX=$(ls -l ~/Mail 2\u0026gt; /dev/null|wc -l) if [ $ROOT_MX -eq 0 ] then echo \u0026#39;root ç”¨æˆ·æ²¡æœ‰å‘Šè­¦é‚®ä»¶ï¼\u0026#39; else echo \u0026#34;root ç”¨æˆ·æœ‰ $(expr $ROOT_MX - 1) å°å‘Šè­¦é‚®ä»¶ï¼\u0026#34; echo \u0026#34;$(ls -l ~/Mail)\u0026#34; fi echo \u0026#39;\u0026#39; grep -v nobody /etc/passwd|awk -F: \u0026#39;$3\u0026gt;=500 {print $1}\u0026#39; \u0026gt; $TMP_FILE while read line1 do echo \u0026#34;ç”¨æˆ· $line1 å‘Šè­¦é‚®ä»¶ï¼š\u0026#34; echo \u0026#34;$(su - $line1 -c \u0026#39;ls -l ~/Mail\u0026#39; 2\u0026gt; /dev/null|grep -v \u0026#39;total\u0026#39;)\u0026#34; done \u0026lt; $TMP_FILE rm -f $TMP_FILE echo \u0026#39;\u0026#39; echo \u0026#39;ç³»ç»Ÿå†…å­˜/äº¤æ¢ç©ºé—´æ£€æµ‹ï¼ˆé—´éš”æ¯3ç§’ï¼‰\u0026#39; echo \u0026#34;$(free -m -s 30 -c2)\u0026#34; echo \u0026#39;\u0026#39; echo \u0026#34;CPUä½¿ç”¨ç‡ä¿¡æ¯ï¼š\u0026#34; /usr/bin/which lsb_release 2\u0026gt;\u0026amp;1\u0026gt; /dev/null if [ $? -eq 0 ] then OS_ID=$(lsb_release -r|awk -F \u0026#39;\\t\u0026#39; \u0026#39;{ print $2 }\u0026#39;|awk -F. \u0026#39;{ print $1 }\u0026#39; 2\u0026gt; /dev/null) if [ $OS_ID -ne 9 ] then CPU_IDLE=$(top -b -n1|grep -i \u0026#39;^cpu\u0026#39;|awk -F, \u0026#39;{ print $4 }\u0026#39;|awk \u0026#39;{ print $1 }\u0026#39;|awk -F. \u0026#39;{ print $1 }\u0026#39;) if [[ $CPU_IDLE -ne 0 ]] then echo \u0026#34;CPU æœªä½¿ç”¨ç‡ $CPU_IDLE%\u0026#34; else echo \u0026#34;CPU æœªä½¿ç”¨ç‡ $(top -b -n1|grep \u0026#39;total\u0026#39;|awk \u0026#39;{ print $8 }\u0026#39;|awk -F. \u0026#39;{ print $1 }\u0026#39;)%\u0026#34; fi else echo \u0026#34;CPU æœªä½¿ç”¨ç‡ $(top -b -n1|grep -i \u0026#39;^cpu\u0026#39;|awk \u0026#39;{ print $11 }\u0026#39;|awk -F. \u0026#39;{ print $1 }\u0026#39;)%\u0026#34; fi else echo `cat /etc/redhat-release` echo \u0026#34;æœªå®‰è£… lsb ç›¸å…³ rpm åŒ…\u0026#34; fi echo \u0026#34;\u0026#34; if [[ $CPU_IDLE \u0026lt; 20 ]] then echo \u0026#34;CPU æœªä½¿ç”¨ç‡ $($CPU_IDLE)% ï¼Œä½¿ç”¨ç‡ 80%+\u0026#34; fi echo \u0026#39;\u0026#39; echo \u0026#34;ç‰©ç†CPUä¸ªæ•°ï¼š $(cat /proc/cpuinfo|grep \u0026#34;physical id\u0026#34;|sort|uniq|wc -l)\u0026#34; echo \u0026#34;ç‰©ç†CPUæ ¸æ•°ï¼š $(cat /proc/cpuinfo|grep \u0026#34;cores\u0026#34;|uniq|awk \u0026#39;{print $4}\u0026#39;)\u0026#34; echo \u0026#34;é€»è¾‘CPUä¸ªæ•°ï¼š $(cat /proc/cpuinfo|grep \u0026#34;processor\u0026#34;|wc -l)\u0026#34; echo \u0026#34;å½“å‰è¿è¡Œæ¨¡å¼ï¼š $(getconf LONG_BIT)\u0026#34; CPU_BIT=$(cat /proc/cpuinfo|grep flags|grep \u0026#39; lm \u0026#39;|wc -l) if [[ $CPU_BIT \u0026gt; 0 ]] then echo \u0026#34;æ”¯æŒ 64 ä½è¿ç®—æ¨¡å¼\u0026#34; else echo \u0026#34;ä¸æ”¯æŒ 64 ä½è¿ç®—æ¨¡å¼\u0026#34; fi echo \u0026#39;\u0026#39; echo \u0026#39;CPU è´Ÿè½½ä¿¡æ¯ï¼š\u0026#39; echo \u0026#34;$(top -b -n2|grep \u0026#39;^Cpu(s):\u0026#39;)\u0026#34; echo \u0026#39;\u0026#39; Z_PID=$(ps aux|awk \u0026#39;{print $8,$2,$11}\u0026#39;|sed -n \u0026#39;/^Z/p\u0026#39;) IFS=${IFS:3:1} for pid in $Z_PID do echo \u0026#34;ç³»ç»Ÿä¸­çš„åƒµå°¸è¿›ç¨‹ï¼š $(echo $pid|awk \u0026#39;{print $2,$3}\u0026#39;)\u0026#34; done echo \u0026#39;\u0026#39; echo \u0026#39;ä¸å¯ç»“æŸè¿›ç¨‹ï¼š\u0026#39; echo \u0026#34;$(ps -eo pid,stat|grep -i \u0026#39;stat=d\u0026#39;)\u0026#34; echo \u0026#39;\u0026#39; echo \u0026#39;å ç”¨ CPU æœ€é«˜çš„ 10 ä¸ªè¿›ç¨‹ï¼š\u0026#39; echo \u0026#34;$(ps aux|head -1;ps aux|sort -k3nr|head -10)\u0026#34; echo \u0026#39;\u0026#39; echo \u0026#39;å ç”¨å†…å­˜æœ€é«˜çš„ 10 ä¸ªè¿›ç¨‹ï¼š\u0026#39; echo \u0026#34;$(ps aux|head -1;ps aux|sort -k4nr|head -10)\u0026#34; echo \u0026#39;\u0026#39; cat /boot/grub/grub.conf|grep \u0026#39;crashkernel=\u0026#39; \u0026gt; /dev/null \u0026amp;\u0026amp; echo \u0026#34;$(service kdump status)\u0026#34; || echo \u0026#39;æœªé…ç½® Kdump æœåŠ¡ï¼\u0026#39; echo \u0026#34;$(ls -l /var/crash/dump* 2\u0026gt; /dev/null)\u0026#34; echo \u0026#34;$(ls -l /root/core.* 2\u0026gt; /dev/null)\u0026#34; echo \u0026#39;\u0026#39; echo \u0026#34;å½“å‰è¿è¡Œçº§åˆ«ï¼š$(runlevel|awk \u0026#39;{ print $2 }\u0026#39;)\u0026#34; echo \u0026#39;\u0026#39; echo \u0026#39;åœ¨ $(runlevel|awk \u0026#39;{ print $2 }\u0026#39;) çº§åˆ«ä¸‹å¼€æœºå¯åŠ¨æœåŠ¡ä¿¡æ¯ï¼š\u0026#39; echo \u0026#34;$(chkconfig --list|grep $(runlevel|awk \u0026#39;{ print $2 }\u0026#39;):on)\u0026#34; echo \u0026#39;\u0026#39; echo \u0026#39;ç³»ç»Ÿæ—¥å¿—ä¿¡æ¯ï¼š /var/log/messages\u0026#39; echo \u0026#34;$(egrep -i \u0026#34;error|fail|scsi reset|file system full|Warning|token was lost|fencing|rejecting I/O to offline device|segfault|CPU#|Call Trace\u0026#34; /var/log/messages 2\u0026gt; /dev/null)\u0026#34; echo \u0026#39;ç³»ç»Ÿæ—¥å¿—ä¿¡æ¯ï¼š /var/log/secure\u0026#39; echo \u0026#34;$(egrep -i \u0026#34;error|fail\u0026#34; /var/log/secure 2\u0026gt; /dev/null)\u0026#34; echo \u0026#39;ç³»ç»Ÿæ—¥å¿—ä¿¡æ¯ï¼š /var/log/boot.log\u0026#39; echo \u0026#34;$(egrep -i \u0026#34;error|fail\u0026#34; /var/log/boot.log 2\u0026gt; /dev/null)\u0026#34; echo \u0026#39;ç³»ç»Ÿæ—¥å¿—ä¿¡æ¯ï¼š /var/log/dmesg\u0026#39; echo \u0026#34;$(egrep -i \u0026#34;error|fail\u0026#34; /var/log/dmesg 2\u0026gt; /dev/null)\u0026#34; echo \u0026#39;\u0026#39; echo \u0026#34;ç³»ç»Ÿçº§åˆ«è®¡åˆ’ä»»åŠ¡ï¼š\u0026#34; echo \u0026#34;$(cat /etc/crontab)\u0026#34; echo \u0026#39;\u0026#39; echo \u0026#34;root ç”¨æˆ·è®¡åˆ’ä»»åŠ¡ï¼š\u0026#34; echo \u0026#34;$(crontab -l 2\u0026gt; /dev/null)\u0026#34; echo \u0026#39;\u0026#39; grep -v nobody /etc/passwd|awk -F: \u0026#39;$3\u0026gt;=500 {print $1}\u0026#39; \u0026gt; $TMP_FILE while read line1 do echo \u0026#34;$line1 ç”¨æˆ·è®¡åˆ’ä»»åŠ¡ï¼š\u0026#34; echo \u0026#34;$(su - $line1 -c \u0026#39;crontab -l\u0026#39; 2\u0026gt; /dev/null)\u0026#34; done \u0026lt; $TMP_FILE rm -f $TMP_FILE echo \u0026#39;\u0026#39; echo \u0026#34;$(iostat -x 2\u0026gt; /dev/null || echo \u0026#39;Sysstat åŒ…æ²¡æœ‰å®‰è£…ï¼\u0026#39;)\u0026#34; echo \u0026#34;$(sar -u 3 10 2\u0026gt; /dev/null || echo \u0026#39;Sysstat åŒ…æ²¡æœ‰å®‰è£…ï¼\u0026#39;)\u0026#34; echo \u0026#34;$(sar -w 2\u0026gt; /dev/null || echo \u0026#39;Sysstat åŒ…æ²¡æœ‰å®‰è£…ï¼\u0026#39;)\u0026#34; echo \u0026#39;æ‰§è¡Œé¢‘ç‡æœ€é«˜çš„ 10 ä¸ªå†å²å‘½ä»¤ï¼š\u0026#39; echo \u0026#34;$(sed -e \u0026#39;s/|/\\n/g\u0026#39; ~/.bash_history|cut -d \u0026#39;\u0026#39; -f 1|sort|uniq -c|sort -nr|head)\u0026#34; echo \u0026#39;\u0026#39; # RHCS æ£€æµ‹è„šæœ¬ï¼ˆRHEL4ï¼ŒRHEL5ï¼ŒRHEL6ï¼›kernel 2.6.+ï¼‰ï¼š echo \u0026#39;--------------------------RHCS æ£€æµ‹è„šæœ¬ï¼ˆRHEL4ï¼ŒRHEL5ï¼ŒRHEL6ï¼‰-----------------\u0026#39; echo \u0026#34;$(chkconfig --list|egrep \u0026#34;cman|ccsd|fenced|qdiskd|rgmanager\u0026#34; || echo \u0026#39;æ²¡æœ‰æ£€æµ‹åˆ°é›†ç¾¤ç›¸å…³æœåŠ¡ï¼\u0026#39;)\u0026#34; echo \u0026#34;$(rpm -qa|egrep \u0026#39;cman|ccsd|fenced|qdiskd|rgmanager\u0026#39; || echo \u0026#39;æœªå®‰è£…é›†ç¾¤å¥—ä»¶ç›¸å…³ rpm åŒ…ï¼\u0026#39;)\u0026#34; echo \u0026#39;/etc/rc.local æ–‡ä»¶å†…å®¹ï¼š\u0026#39; echo \u0026#34;$(egrep -v \u0026#39;^#|^$\u0026#39; /etc/rc.local)\u0026#34; echo \u0026#39;/etc/hosts file contents:\u0026#39; echo \u0026#34;$(egrep -v \u0026#39;^#|^:|^$\u0026#39; /etc/hosts)\u0026#34; echo \u0026#39;é›†ç¾¤å½“å‰çŠ¶æ€ï¼š\u0026#39; echo \u0026#34;$(clustat 2\u0026gt; /dev/null || echo \u0026#39;æ²¡æœ‰æ£€æµ‹åˆ°é›†ç¾¤ä¿¡æ¯ï¼\u0026#39;)\u0026#34; echo \u0026#34;$(mkqdisk -L 2\u0026gt; /dev/null || echo \u0026#39;æ²¡æœ‰æ£€æµ‹åˆ° qdisk ä¿¡æ¯ï¼\u0026#39;)\u0026#34; echo \u0026#34;$(service cman status 2\u0026gt;\u0026amp;1)\u0026#34; echo \u0026#34;$(service ccsd status 2\u0026gt;\u0026amp;1)\u0026#34; echo \u0026#34;$(service fenced status 2\u0026gt;\u0026amp;1)\u0026#34; echo \u0026#34;$(service qdiskd status 2\u0026gt;\u0026amp;1)\u0026#34; echo \u0026#34;$(service rgmanager status 2\u0026gt;\u0026amp;1)\u0026#34; echo \u0026#39;é›†ç¾¤é…ç½®æ–‡ä»¶å†…å®¹ï¼š\u0026#39; echo \u0026#34;$(cat /etc/cluster/cluster.conf 2\u0026gt; /dev/null || echo \u0026#39;æ²¡æœ‰æ‰¾åˆ°é›†ç¾¤é…ç½®æ–‡ä»¶ï¼\u0026#39;)\u0026#34; echo \u0026#39;\u0026#39; #openssl æ£€æµ‹è„šæœ¬ ï¼ˆRHEL4,RHEL5,RHEL6ï¼‰ echo \u0026#34;search openssl verion:\u0026#34; rpm -qa ï½œ grep openssl echo \u0026#34;lsof openssl:\u0026#34; lsof | grep libssl.so echo \u0026#34;å®Œæˆæ£€æµ‹æ—¶é—´ï¼š $(date|awk \u0026#39;{ print $4}\u0026#39;)!\u0026#34; æ ¹æ®æŒ‡ä»¤å±•ç¤ºä¸åŒçš„ç³»ç»Ÿæ•°æ® ç‚¹å‡»æŸ¥çœ‹å†…å®¹ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 148 149 150 151 152 153 154 155 156 157 158 159 160 161 162 163 164 165 166 167 168 169 170 171 172 173 174 175 176 177 178 179 180 181 182 183 184 185 186 187 188 189 190 191 192 193 194 195 196 197 198 199 200 201 202 203 204 205 206 207 208 209 210 211 212 213 214 215 216 217 218 219 220 221 222 223 224 225 226 227 228 229 230 231 232 233 234 235 #!/bin/bash os_check() { if [ -e /etc/redhat-release ]; then REDHAT=`cat /etc/redhat-release |cut -d\u0026#39; \u0026#39; -f1` else DEBIAN=`cat /etc/issue |cut -d\u0026#39; \u0026#39; -f1` fi if [ \u0026#34;$REDHAT\u0026#34; == \u0026#34;CentOS\u0026#34; -o \u0026#34;$REDHAT\u0026#34; == \u0026#34;Red\u0026#34; ]; then P_M=yum elif [ \u0026#34;$DEBIAN\u0026#34; == \u0026#34;Ubuntu\u0026#34; -o \u0026#34;$DEBIAN\u0026#34; == \u0026#34;ubutnu\u0026#34; ]; then P_M=apt-get else Operating system does not support. exit 1 fi } if [ $LOGNAME != root ]; then echo \u0026#34;Please use the root account operation.\u0026#34; exit 1 fi if ! which vmstat \u0026amp;\u0026gt;/dev/null; then echo \u0026#34;vmstat command not found, now the install.\u0026#34; sleep 1 os_check $P_M install procps -y echo \u0026#34;-----------------------------------------------------------------------\u0026#34; fi if ! which iostat \u0026amp;\u0026gt;/dev/null; then echo \u0026#34;iostat command not found, now the install.\u0026#34; sleep 1 os_check $P_M install sysstat -y echo \u0026#34;-----------------------------------------------------------------------\u0026#34; fi while true; do select input in cpu_load disk_load disk_use disk_inode mem_use tcp_status cpu_top10 mem_top10 traffic quit; do case $input in cpu_load) #CPUåˆ©ç”¨ç‡ä¸è´Ÿè½½ echo \u0026#34;---------------------------------------\u0026#34; i=1 while [[ $i -le 3 ]]; do echo -e \u0026#34;\\033[32m å‚è€ƒå€¼${i}\\033[0m\u0026#34; UTIL=`vmstat |awk \u0026#39;{if(NR==3)print 100-$15\u0026#34;%\u0026#34;}\u0026#39;` USER=`vmstat |awk \u0026#39;{if(NR==3)print $13\u0026#34;%\u0026#34;}\u0026#39;` SYS=`vmstat |awk \u0026#39;{if(NR==3)print $14\u0026#34;%\u0026#34;}\u0026#39;` IOWAIT=`vmstat |awk \u0026#39;{if(NR==3)print $16\u0026#34;%\u0026#34;}\u0026#39;` echo \u0026#34;Util: $UTIL\u0026#34; echo \u0026#34;User use: $USER\u0026#34; echo \u0026#34;System use: $SYS\u0026#34; echo \u0026#34;I/O wait: $IOWAIT\u0026#34; i=$(($i+1)) sleep 1 done echo \u0026#34;---------------------------------------\u0026#34; break ;; disk_load) #ç¡¬ç›˜I/Oè´Ÿè½½ echo \u0026#34;---------------------------------------\u0026#34; i=1 while [[ $i -le 3 ]]; do echo -e \u0026#34;\\033[32m å‚è€ƒå€¼${i}\\033[0m\u0026#34; UTIL=`iostat -x -k |awk \u0026#39;/^[v|s]/{OFS=\u0026#34;: \u0026#34;;print $1,$NF\u0026#34;%\u0026#34;}\u0026#39;` READ=`iostat -x -k |awk \u0026#39;/^[v|s]/{OFS=\u0026#34;: \u0026#34;;print $1,$6\u0026#34;KB\u0026#34;}\u0026#39;` WRITE=`iostat -x -k |awk \u0026#39;/^[v|s]/{OFS=\u0026#34;: \u0026#34;;print $1,$7\u0026#34;KB\u0026#34;}\u0026#39;` IOWAIT=`vmstat |awk \u0026#39;{if(NR==3)print $16\u0026#34;%\u0026#34;}\u0026#39;` echo -e \u0026#34;Util:\u0026#34; echo -e \u0026#34;${UTIL}\u0026#34; echo -e \u0026#34;I/O Wait: $IOWAIT\u0026#34; echo -e \u0026#34;Read/s:\\n$READ\u0026#34; echo -e \u0026#34;Write/s:\\n$WRITE\u0026#34; i=$(($i+1)) sleep 1 done echo \u0026#34;---------------------------------------\u0026#34; break ;; disk_use) #ç¡¬ç›˜åˆ©ç”¨ç‡ DISK_LOG=/tmp/disk_use.tmp DISK_TOTAL=`fdisk -l |awk \u0026#39;/^Disk.*bytes/\u0026amp;\u0026amp;/\\/dev/{printf $2\u0026#34; \u0026#34;;printf \u0026#34;%d\u0026#34;,$3;print \u0026#34;GB\u0026#34;}\u0026#39;` USE_RATE=`df -h |awk \u0026#39;/^\\/dev/{print int($5)}\u0026#39;` for i in $USE_RATE; do if [ $i -gt 90 ];then PART=`df -h |awk \u0026#39;{if(int($5)==\u0026#39;\u0026#39;\u0026#39;$i\u0026#39;\u0026#39;\u0026#39;) print $6}\u0026#39;` echo \u0026#34;$PART = ${i}%\u0026#34; \u0026gt;\u0026gt; $DISK_LOG fi done echo \u0026#34;---------------------------------------\u0026#34; echo -e \u0026#34;Disk total:\\n${DISK_TOTAL}\u0026#34; if [ -f $DISK_LOG ]; then echo \u0026#34;---------------------------------------\u0026#34; cat $DISK_LOG echo \u0026#34;---------------------------------------\u0026#34; rm -f $DISK_LOG else echo \u0026#34;---------------------------------------\u0026#34; echo \u0026#34;Disk use rate no than 90% of the partition.\u0026#34; echo \u0026#34;---------------------------------------\u0026#34; fi break ;; disk_inode) #ç¡¬ç›˜inodeåˆ©ç”¨ç‡ INODE_LOG=/tmp/inode_use.tmp INODE_USE=`df -i |awk \u0026#39;/^\\/dev/{print int($5)}\u0026#39;` for i in $INODE_USE; do if [ $i -gt 90 ]; then PART=`df -h |awk \u0026#39;{if(int($5)==\u0026#39;\u0026#39;\u0026#39;$i\u0026#39;\u0026#39;\u0026#39;) print $6}\u0026#39;` echo \u0026#34;$PART = ${i}%\u0026#34; \u0026gt;\u0026gt; $INODE_LOG fi done if [ -f $INODE_LOG ]; then echo \u0026#34;---------------------------------------\u0026#34; rm -f $INODE_LOG else echo \u0026#34;---------------------------------------\u0026#34; echo \u0026#34;Inode use rate no than 90% of the partition.\u0026#34; echo \u0026#34;---------------------------------------\u0026#34; fi break ;; mem_use) #å†…å­˜åˆ©ç”¨ç‡ echo \u0026#34;---------------------------------------\u0026#34; MEM_TOTAL=`free -m |awk \u0026#39;{if(NR==2)printf \u0026#34;%.1f\u0026#34;,$2/1024}END{print \u0026#34;G\u0026#34;}\u0026#39;` USE=`free -m |awk \u0026#39;{if(NR==3) printf \u0026#34;%.1f\u0026#34;,$3/1024}END{print \u0026#34;G\u0026#34;}\u0026#39;` FREE=`free -m |awk \u0026#39;{if(NR==3) printf \u0026#34;%.1f\u0026#34;,$4/1024}END{print \u0026#34;G\u0026#34;}\u0026#39;` CACHE=`free -m |awk \u0026#39;{if(NR==2) printf \u0026#34;%.1f\u0026#34;,($6+$7)/1024}END{print \u0026#34;G\u0026#34;}\u0026#39;` echo -e \u0026#34;Total: $MEM_TOTAL\u0026#34; echo -e \u0026#34;Use: $USE\u0026#34; echo -e \u0026#34;Free: $FREE\u0026#34; echo -e \u0026#34;Cache: $CACHE\u0026#34; echo \u0026#34;---------------------------------------\u0026#34; break ;; tcp_status) #ç½‘ç»œè¿æ¥çŠ¶æ€ echo \u0026#34;---------------------------------------\u0026#34; COUNT=`netstat -antp |awk \u0026#39;{status[$6]++}END{for(i in status) print i,status[i]}\u0026#39;` echo -e \u0026#34;TCP connection status:\\n$COUNT\u0026#34; echo \u0026#34;---------------------------------------\u0026#34; ;; cpu_top10) #å ç”¨CPUé«˜çš„å‰10ä¸ªè¿›ç¨‹ echo \u0026#34;---------------------------------------\u0026#34; CPU_LOG=/tmp/cpu_top.tmp i=1 while [[ $i -le 3 ]]; do #ps aux |awk \u0026#39;{if($3\u0026gt;0.1)print \u0026#34;CPU: \u0026#34;$3\u0026#34;% --\u0026gt;\u0026#34;,$11,$12,$13,$14,$15,$16,\u0026#34;(PID:\u0026#34;$2\u0026#34;)\u0026#34; |\u0026#34;sort -k2 -nr |head -n 10\u0026#34;}\u0026#39; \u0026gt; $CPU_LOG ps aux |awk \u0026#39;{if($3\u0026gt;0.1){{printf \u0026#34;PID: \u0026#34;$2\u0026#34; CPU: \u0026#34;$3\u0026#34;% --\u0026gt; \u0026#34;}for(i=11;i\u0026lt;=NF;i++)if(i==NF)printf $i\u0026#34;\\n\u0026#34;;else printf $i}}\u0026#39; |sort -k4 -nr |head -10 \u0026gt; $CPU_LOG #å¾ªç¯ä»11åˆ—ï¼ˆè¿›ç¨‹åï¼‰å¼€å§‹æ‰“å°ï¼Œå¦‚æœiç­‰äºæœ€åä¸€è¡Œï¼Œå°±æ‰“å°içš„åˆ—å¹¶æ¢è¡Œï¼Œå¦åˆ™å°±æ‰“å°içš„åˆ— if [[ -n `cat $CPU_LOG` ]]; then echo -e \u0026#34;\\033[32m å‚è€ƒå€¼${i}\\033[0m\u0026#34; cat $CPU_LOG \u0026gt; $CPU_LOG else echo \u0026#34;No process using the CPU.\u0026#34; break fi i=$(($i+1)) sleep 1 done echo \u0026#34;---------------------------------------\u0026#34; break ;; mem_top10) #å ç”¨å†…å­˜é«˜çš„å‰10ä¸ªè¿›ç¨‹ echo \u0026#34;---------------------------------------\u0026#34; MEM_LOG=/tmp/mem_top.tmp i=1 while [[ $i -le 3 ]]; do #ps aux |awk \u0026#39;{if($4\u0026gt;0.1)print \u0026#34;Memory: \u0026#34;$4\u0026#34;% --\u0026gt;\u0026#34;,$11,$12,$13,$14,$15,$16,\u0026#34;(PID:\u0026#34;$2\u0026#34;)\u0026#34; |\u0026#34;sort -k2 -nr |head -n 10\u0026#34;}\u0026#39; \u0026gt; $MEM_LOG ps aux |awk \u0026#39;{if($4\u0026gt;0.1){{printf \u0026#34;PID: \u0026#34;$2\u0026#34; Memory: \u0026#34;$3\u0026#34;% --\u0026gt; \u0026#34;}for(i=11;i\u0026lt;=NF;i++)if(i==NF)printf $i\u0026#34;\\n\u0026#34;;else printf $i}}\u0026#39; |sort -k4 -nr |head -10 \u0026gt; $MEM_LOG if [[ -n `cat $MEM_LOG` ]]; then echo -e \u0026#34;\\033[32m å‚è€ƒå€¼${i}\\033[0m\u0026#34; cat $MEM_LOG \u0026gt; $MEM_LOG else echo \u0026#34;No process using the Memory.\u0026#34; break fi i=$(($i+1)) sleep 1 done echo \u0026#34;---------------------------------------\u0026#34; break ;; traffic) #æŸ¥çœ‹ç½‘ç»œæµé‡ while true; do read -p \u0026#34;Please enter the network card name(eth[0-9] or em[0-9]): \u0026#34; eth #if [[ $eth =~ ^eth[0-9]$ ]] || [[ $eth =~ ^em[0-9]$ ]] \u0026amp;\u0026amp; [[ `ifconfig |grep -c \u0026#34;\\\u0026lt;$eth\\\u0026gt;\u0026#34;` -eq 1 ]]; then if [ `ifconfig |grep -c \u0026#34;\\\u0026lt;$eth\\\u0026gt;\u0026#34;` -eq 1 ]; then break else echo \u0026#34;Input format error or Don\u0026#39;t have the card name, please input again.\u0026#34; fi done echo \u0026#34;---------------------------------------\u0026#34; echo -e \u0026#34; In ------ Out\u0026#34; i=1 while [[ $i -le 3 ]]; do #OLD_IN=`ifconfig $eth |awk \u0026#39;/RX bytes/{print $2}\u0026#39; |cut -d: -f2` #OLD_OUT=`ifconfig $eth |awk \u0026#39;/RX bytes/{print $6}\u0026#39; |cut -d: -f2` OLD_IN=`ifconfig $eth |awk -F\u0026#39;[: ]+\u0026#39; \u0026#39;/bytes/{if(NR==8)print $4;else if(NR==5)print $6}\u0026#39;` #CentOS6å’ŒCentOS7 ifconfigè¾“å‡ºè¿›å‡ºæµé‡ä¿¡æ¯ä½ç½®ä¸åŒï¼ŒCentOS6ä¸­RXä¸TXè¡Œå·ç­‰äº8ï¼ŒCentOS7ä¸­RXè¡Œå·æ˜¯5ï¼ŒTXè¡Œå·æ˜¯5ï¼Œæ‰€ä»¥å°±åšäº†ä¸ªåˆ¤æ–­. OLD_OUT=`ifconfig $eth |awk -F\u0026#39;[: ]+\u0026#39; \u0026#39;/bytes/{if(NR==8)print $9;else if(NR==7)print $6}\u0026#39;` sleep 1 NEW_IN=`ifconfig $eth |awk -F\u0026#39;[: ]+\u0026#39; \u0026#39;/bytes/{if(NR==8)print $4;else if(NR==5)print $6}\u0026#39;` NEW_OUT=`ifconfig $eth |awk -F\u0026#39;[: ]+\u0026#39; \u0026#39;/bytes/{if(NR==8)print $9;else if(NR==7)print $6}\u0026#39;` IN=`awk \u0026#39;BEGIN{printf \u0026#34;%.1f\\n\u0026#34;,\u0026#39;$((${NEW_IN}-${OLD_IN}))\u0026#39;/1024/128}\u0026#39;` OUT=`awk \u0026#39;BEGIN{printf \u0026#34;%.1f\\n\u0026#34;,\u0026#39;$((${NEW_OUT}-${OLD_OUT}))\u0026#39;/1024/128}\u0026#39;` echo \u0026#34;${IN}MB/s ${OUT}MB/s\u0026#34; i=$(($i+1)) sleep 1 done echo \u0026#34;---------------------------------------\u0026#34; break ;; quit) exit 0 ;; *) echo \u0026#34;---------------------------------------\u0026#34; echo \u0026#34;Please enter the number.\u0026#34; echo \u0026#34;---------------------------------------\u0026#34; break ;; esac done done æ˜¾ç¤ºç®€å•çš„ç³»ç»Ÿä¿¡æ¯ ç‚¹å‡»æŸ¥çœ‹å†…å®¹ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 #!/bin/bash #[ç½‘ç»œéƒ¨åˆ†] net_work=`[[ $(curl -o /dev/null --connect-timeout 3 -s -w \u0026#34;%{http_code}\u0026#34; www.baidu.com) -eq 200 ]] \u0026amp;\u0026amp; echo yes || echo no` ip_local=`ip addr | egrep -o \u0026#39;[0-9]{1,3}\\.[0-9]{1,3}\\.[0-9]{1,3}\\.[0-9]{1,3}\u0026#39; | egrep -v \u0026#34;^127\u0026#34; | head -n 1` #[cpuéƒ¨åˆ†] cpu_info=`awk -F: \u0026#39;/model name/ {name=$2} END {print name}\u0026#39; /proc/cpuinfo | sed \u0026#39;s/^[ \\t]*//;s/[ \\t]*$//\u0026#39;` cpu_pinlv=`awk -F: \u0026#39;/cpu MHz/ {freq=$2} END {print freq}\u0026#39; /proc/cpuinfo | sed \u0026#39;s/^[ \\t]*//;s/[ \\t]*$//\u0026#39;` cpu_hexin=`awk -F: \u0026#39;/model name/ {core++} END {print core}\u0026#39; /proc/cpuinfo` #[å†…å­˜éƒ¨åˆ†] mem_zong=`free -m | awk \u0026#39;/Mem/ {print $2}\u0026#39;` men_sheng=`free -m | awk \u0026#39;/Mem/ {print $4}\u0026#39;` swa_zong=`free -m | awk \u0026#39;/Swap/ {print $2}\u0026#39;` swa_sheng=`free -m | awk \u0026#39;/Swap/ {print $4}\u0026#39;` #[ç¡¬ç›˜éƒ¨åˆ†] disk_zong=`df -Th | grep \u0026#39;/dev/\u0026#39; | awk \u0026#39;{print $3}\u0026#39; | head -n 1` disk_sheng=`df -Th | grep \u0026#39;/dev/\u0026#39; | awk \u0026#39;{print $5}\u0026#39; | head -n 1` #[å…¶å®ƒ] time_local=`awk \u0026#39;{a=$1/86400;b=($1%86400)/3600;c=($1%3600)/60;d=$1%60} {printf(\u0026#34;%ddays, %d:%d:%d\\n\u0026#34;,a,b,c,d)}\u0026#39; /proc/uptime` jiagou=`uname -m` hostname=`hostname` #åˆ¤æ–­æ˜¯å¦centosæˆ–ubuntu if cat /proc/version | grep -Eqi \u0026#34;ubuntu\u0026#34;; then banben=`lsb_release -a` elif cat /proc/version | grep -Eqi \u0026#34;centos|red hat|redhat\u0026#34;; then banben=`awk \u0026#39;{print ($1,$3~/^[0-9]/?$3:$4)}\u0026#39; /etc/redhat-release` fi cn_info() { #å…¨éƒ¨ä¿¡æ¯ clear echo \u0026#34;ä¸»æœºåï¼š $hostname\u0026#34; echo \u0026#34;ç‰ˆæœ¬ï¼š $banben\u0026#34; echo \u0026#34;æ¶æ„ï¼š $jiagou\u0026#34; echo echo \u0026#34;cpuä¿¡æ¯ï¼š $cpu_info\u0026#34; echo \u0026#34;cpué¢‘ç‡ï¼š $cpu_pinlv\u0026#34; echo \u0026#34;cpuæ ¸å¿ƒï¼š $cpu_hexin\u0026#34; echo echo \u0026#34;æ€»å†…å­˜ï¼š $mem_zong\u0026#34; echo \u0026#34;å‰©å†…å­˜ï¼š $men_sheng\u0026#34; echo \u0026#34;æ€»swapï¼š $swa_zong\u0026#34; echo \u0026#34;å‰©swapï¼š $swa_sheng\u0026#34; echo echo \u0026#34;æ ¹ç›®å½•ï¼š $disk_zong\u0026#34; echo \u0026#34;æ ¹å‰©ä½™ï¼š $disk_sheng\u0026#34; echo echo \u0026#34;æ˜¯å¦è”ç½‘ï¼š$net_work\u0026#34; echo \u0026#34;æœ¬åœ°ipï¼š $ip_local\u0026#34; echo echo \u0026#34;å¼€æœºï¼š $time_local\u0026#34; } cn_info æŸ¥çœ‹CPUå†…å­˜ç£ç›˜ä¿¡æ¯ ç‚¹å‡»æŸ¥çœ‹å†…å®¹ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 #!/bin/bash #è¾“å…¥ä¸åŒå­—ç¬¦å®Œæˆä¸åŒå·¡æ£€å†…å®¹ #æ‰“å°æç¤ºç¬¦ HINT(){ read -p \u0026#34;è¯·æŒ‰å›è½¦ç»§ç»­ï¼š\u0026#34; } #æŸ¥çœ‹CPUä¿¡æ¯ CPU_INFO(){ echo echo -e \u0026#34;\\033[4;31mPrint the CPU info:\\033[0m\u0026#34; cat /proc/cpuinfo | awk \u0026#39;BEGIN {FS=\u0026#34;:\u0026#34;} /model name/{print \u0026#34;CPU Model:\u0026#34; $2 }\u0026#39; cat /proc/cpuinfo | awk \u0026#39;BEGIN {FS=\u0026#34;:\u0026#34;} /cpu MHz/{print \u0026#34;CPU Speed:\u0026#34; $2\u0026#34;MHz\u0026#34;}\u0026#39; grep -Eq \u0026#39;svm|vmx\u0026#39; /proc/cpuinfo \u0026amp;\u0026amp; echo \u0026#34;Virtualization: Support\u0026#34; || \\ echo \u0026#34;Virtualization: No Support\u0026#34; echo } #æŸ¥çœ‹ç³»ç»Ÿè´Ÿè½½ LOAD_INFO(){ echo -e \u0026#34;\\033[4;31mPrint the system load:\\033[0m\u0026#34; uptime | awk \u0026#39;BEGIN{FS=\u0026#34;:\u0026#34;} {print $5}\u0026#39; | awk \u0026#39;BEGIN{FS=\u0026#34;,\u0026#34;}\\ {print \u0026#34;Last 1 minutes system load:\u0026#34;$1\u0026#34;\\n\u0026#34;\u0026#34;Last 5 minutes system load:\u0026#34;$2\u0026#34;\\n\u0026#34;\\ \u0026#34;Last 15 minutes system load:\u0026#34;$3}\u0026#39; echo } #æŸ¥çœ‹å†…å­˜ä¸äº¤æ¢åˆ†åŒºä¿¡æ¯ MEM_INFO(){ echo echo -e \u0026#34;\\033[4;31mPrint the Memory and Swap info:\\033[0m\u0026#34; free | grep Mem | awk \u0026#39;{print \u0026#34;Mem free: \u0026#34;$5\u0026#34; Bytes\u0026#34;}\u0026#39; free | grep Swap | awk \u0026#39;{print \u0026#34;Swap free: \u0026#34;$4\u0026#34; Bytes\u0026#34;}\u0026#39; echo } #æŸ¥çœ‹ç£ç›˜æŒ‚è½½ä¿¡æ¯ DISK_INFO(){ echo echo -e \u0026#34;\\033[4;31mPrint system disk space usage:\\033[0m\u0026#34; df -h echo } while true do clear echo \u0026#34;------------------------------------------------------\u0026#34; echo \u0026#34;1. æŸ¥çœ‹CPUä¿¡æ¯\u0026#34; echo \u0026#34;2. æŸ¥çœ‹ç³»ç»Ÿè´Ÿè½½\u0026#34; echo \u0026#34;3. æŸ¥çœ‹å†…å­˜ä¸äº¤æ¢åˆ†åŒºä¿¡æ¯\u0026#34; echo \u0026#34;4. æŸ¥çœ‹ç£ç›˜æŒ‚è½½ä¿¡æ¯\u0026#34; echo \u0026#34;5. é€€å‡ºç³»ç»Ÿ\u0026#34; echo \u0026#34;-------------------------------------------------------\u0026#34; read -p \u0026#34;è¯·é€‰æ‹©1-4é€‰é¡¹ï¼š\u0026#34; U_SELECT #é€šè¿‡è°ƒç”¨å‡½æ•°åç§°è°ƒç”¨å‡½æ•° case $U_SELECT in 1) CPU_INFO HINT ;; 2) LOAD_INFO HINT ;; 3) MEM_INFO HINT ;; 4) DISK_INFO HINT ;; 5) exit ;; *) read -p \u0026#34;è¯·é€‰æ‹©1-4é€‰é¡¹ï¼Œè¾“å…¥å›è½¦ç»§ç»­ï¼š\u0026#34; ;; esac done æ–‡ç« é“¾æ¥\nhttps://www.cnsre.cn/posts/210317132104/\n","description":"æ£€æŸ¥ç³»ç»Ÿä¿¡æ¯çš„è„šæœ¬åˆé›†","id":90,"section":"posts","tags":["shell","ç³»ç»Ÿæ£€æŸ¥"],"title":"ç³»ç»Ÿå·¡æ£€è„šæœ¬åˆé›†","uri":"http://www.cnsre.cn:80/posts/210317132104/"},{"content":"markdownçš„åŸºæœ¬ç”¨æ³• å¿«é€Ÿä¸Šæ‰‹markdownè¯­æ³•ï¼Œæœ¬æ–‡ä¼šæ¼”ç¤ºä¸€äº›å¸¸ç”¨çš„markdownè¯­æ³•ã€‚ä¿è¯ä½ çœ‹å®Œä¹‹åèƒ½å¤Ÿå¿«é€Ÿä¸Šæ‰‹ã€‚\næ ‡é¢˜ åœ¨éœ€è¦è®¾ç½®æ ‡é¢˜çš„æ–‡å­—å‰é¢åŠ #æ¥å½¢æˆæ ‡é¢˜ã€‚åœ¨#ç»“æŸçš„æ—¶å€™æ·»åŠ ç©ºæ ¼å’Œæ ‡é¢˜ åˆ†å¼€ï¼Œæœ€å¤šæ”¯æŒå…­çº§æ ‡é¢˜ã€‚ä¸‹é¢æ˜¯å®ä¾‹ã€‚\n# ä¸€çº§æ ‡é¢˜ ## äºŒçº§æ ‡é¢˜ ### ä¸‰çº§æ ‡é¢˜ #### å››çº§æ ‡é¢˜ ##### äº”çº§æ ‡é¢˜ ###### å…­çº§æ ‡é¢˜ ç¤ºä¾‹ ä¸€çº§æ ‡é¢˜ äºŒçº§æ ‡é¢˜ ä¸‰çº§æ ‡é¢˜ å››çº§æ ‡é¢˜ äº”çº§æ ‡é¢˜ å…­çº§æ ‡é¢˜ å­—ä½“ å­—ä½“çš„ç”¨æ³•ä¸»è¦æœ‰æ–œä½“ï¼ŒåŠ ç²—ï¼Œæ–œä½“åŠ ç²—ï¼ŒåŠ åˆ é™¤çº¿\nåŠ ç²— å‰åä¸¤ä¸ª*å°†æ–‡å­—åŒ…è£¹èµ·æ¥\nç¤ºä¾‹ **è¿™æ˜¯åŠ ç²—çš„æ–‡å­—** è¿™æ˜¯åŠ ç²—çš„æ–‡å­—\næ–œä½“ å‰åä¸€ä¸ª*å°†æ–‡å­—åŒ…è£¹èµ·æ¥\nç¤ºä¾‹ *è¿™æ˜¯æ–œä½“çš„æ–‡å­—* è¿™æ˜¯æ–œä½“çš„æ–‡å­—\næ–œä½“åŠ ç²— å‰åä¸‰ä¸ª*å°†æ–‡å­—åŒ…è£¹èµ·æ¥\nç¤ºä¾‹ ***è¿™æ˜¯æ–œä½“åŠ ç²—çš„æ–‡å­—*** è¿™æ˜¯æ–œä½“åŠ ç²—çš„æ–‡å­—\nåˆ é™¤çº¿ æ·»åŠ åˆ é™¤çº¿\nç¤ºä¾‹ ~~è¿™æ˜¯æ·»åŠ åˆ é™¤çº¿çš„æ–‡å­—~~ è¿™æ˜¯æ·»åŠ åˆ é™¤çº¿çš„æ–‡å­—\nå¼•ç”¨ åœ¨å¼•ç”¨çš„æ–‡å­—å‰åŠ \u0026gt;å³å¯ã€‚å¼•ç”¨ä¹Ÿå¯ä»¥åµŒå¥—ï¼Œå¦‚åŠ ä¸¤ä¸ª\u0026raquo;ä¸‰ä¸ª\u0026raquo;\u0026gt;,å¯ä»¥ä¸€ç›´åµŒå¥—ä¸‹å»ï¼Œåªéœ€è¦ç»§ç»­æ·»åŠ \u0026gt;å³å¯\nä¸åŠ åµŒå¥—çš„å¼•ç”¨ ç¤ºä¾‹ \u0026gt;å¼•ç”¨1 \u0026gt;å¼•ç”¨2 \u0026gt;å¼•ç”¨3 å¼•ç”¨1\nå¼•ç”¨2\nå¼•ç”¨3\næ·»åŠ åµŒå¥—çš„å¼•ç”¨ ç¤ºä¾‹ \u0026gt;å¼•ç”¨1 \u0026gt;\u0026gt;å¼•ç”¨2 \u0026gt;\u0026gt;\u0026gt; å¼•ç”¨3 å¼•ç”¨1\nå¼•ç”¨2\nå¼•ç”¨3\nä¸ºä¸Šä¸‹æ–‡æ·»åŠ åˆ†å‰²çº¿ éœ€è¦æ³¨æ„çš„æ˜¯è‡³å°‘éœ€è¦ä¸‰ä¸ªåŒæ ·çš„ç¬¦å·ä»¥ä¸Š ä»¥ä¸‹å‡ ç§éƒ½å¯ä»¥ ç¤ºä¾‹ --- ---- *** ***** å›¾ç‰‡ å›¾ç‰‡æ ‡é¢˜å°±æ˜¯æ˜¾ç¤ºåœ¨å›¾ç‰‡ä¸‹é¢çš„æ–‡å­—ï¼Œç›¸å½“äºå¯¹å›¾ç‰‡å†…å®¹çš„è§£é‡Šï¼Œä¹Ÿå¯ä»¥ä¸åŠ ã€‚\nå›¾ç‰‡æè¿°ï¼Œå½“é¼ æ ‡ç§»åˆ°å›¾ç‰‡ä¸Šæ—¶æ˜¾ç¤ºçš„å†…å®¹ã€‚titleå¯åŠ å¯ä¸åŠ ï¼Œä¸æ˜¯æ‰€æœ‰çš„ç¼–è¾‘å™¨éƒ½æ”¯æŒ\nç¤ºä¾‹ ![cnsreè¿ç»´åšå®¢|Linuxç³»ç»Ÿè¿ç»´|è‡ªåŠ¨åŒ–è¿ç»´|äº‘è®¡ç®—|è¿ç»´ç›‘æ§](https://cdn.jsdelivr.net/gh/zops/ImagesHosting/cnsre/20210421130359.png) è¶…é“¾æ¥ ç¤ºä¾‹ [SREè¿ç»´åšå®¢](https://cnsre.cn) è¡Œå†…é“¾æ¥[SRE](https://cnsre.cn) SREè¿ç»´åšå®¢\nè¡Œå†…é“¾æ¥SREè¿ç»´åšå®¢\nä»£ç  markdownè¯­æ³•å¾ˆå¥½çš„æ”¯æŒåµŒå…¥ä»£ç å’Œä»£ç å—ï¼Œæå¤§æ–¹ä¾¿äº†ç¨‹åºå‘˜å†™ä½œå’Œè®°ç¬”è®°\nä»£ç å— ç¤ºä¾‹ è¿™æ˜¯`ä»£ç å—` è¿™æ˜¯ä»£ç å—\nå•çª—å£ä»£ç  ç¤ºä¾‹ ```\nhello SREè¿ç»´åšå®¢\n```\nhello SREè¿ç»´åšå®¢ å¤šçª—å£ä»£ç å— ï¼æ³¨æ„\næ¬¡æ ¼å¼ä»…é€‚ç”¨äºæœ¬åšå®¢ ç¤ºä¾‹\n{{\u0026lt; codes python shell\u0026gt;}}\n{{\u0026lt;code\u0026gt;}}\n``` python\n#!/usr/bin/env python\n#coding=utf-8\nprint \u0026ldquo;hello SREè¿ç»´åšå®¢\u0026rdquo;\n```\n{{\u0026lt;/code\u0026gt;}}\n{{\u0026lt;code\u0026gt;}}\n``` shell\n#!/bin/bash\necho \u0026ldquo;hello SREè¿ç»´åšå®¢\u0026rdquo;\n```\n{{\u0026lt;/code\u0026gt;}}\n{{\u0026lt;/codes\u0026gt;}} python shell 1 2 3 #!/usr/bin/env python #coding=utf-8 print \u0026#34;hello SREè¿ç»´åšå®¢\u0026#34; 1 2 #!/bin/bash echo \u0026#34;hello SREè¿ç»´åšå®¢\u0026#34; å¤šçª—å£ä»£ç 2 ç¤ºä¾‹ {{\u0026lt; tabs å†…å®¹1 å†…å®¹2 å†…å®¹3 \u0026gt;}}\n{{\u0026lt; tab \u0026gt;}}\n### å†…å®¹1\n```shell\nHello SREè¿ç»´åšå®¢!\n```\nâš ï¸å†…å®¹æè¿°\n{{\u0026lt; /tab \u0026gt;}}\n{{\u0026lt; tab \u0026gt;}}\n### å†…å®¹2\n```shell\nHello SREè¿ç»´åšå®¢!\n```\n{{\u0026lt; /tab \u0026gt;}}\n{{\u0026lt; tab \u0026gt;}}\n### å†…å®¹3\n```shell\nHello SREè¿ç»´åšå®¢!\n```\n{{\u0026lt; /tab \u0026gt;}}\n{{\u0026lt; /tabs \u0026gt;}}\nå†…å®¹1 å†…å®¹2 å†…å®¹3 å†…å®¹1 1 Hello SREè¿ç»´åšå®¢! âš ï¸å†…å®¹æè¿°\nå†…å®¹2 1 Hello SREè¿ç»´åšå®¢! å†…å®¹3 1 Hello SREè¿ç»´åšå®¢! å†…å®¹æŠ˜å  ç¤ºä¾‹\n{{\u0026lt; expand \u0026ldquo;ç‚¹å‡»æŸ¥çœ‹\u0026rdquo; \u0026gt;}}\n#### æ ‡é¢˜\nå†…å®¹\n{{\u0026lt; /expand \u0026gt;}} {{\u0026lt; expand \u0026ldquo;ç‚¹å‡»æŸ¥çœ‹ 2\u0026rdquo; \u0026gt;}}\n#### æ ‡é¢˜2\n``` shell\nHello SREè¿ç»´åšå®¢!\n```\n{{\u0026lt; /expand \u0026gt;}}\nç‚¹å‡»æŸ¥çœ‹ æ ‡é¢˜ å†…å®¹\nç‚¹å‡»æŸ¥çœ‹ 2 æ ‡é¢˜2 1 Hello SREè¿ç»´åšå®¢! åˆ—è¡¨ æ— åºåˆ—è¡¨ æ— åºåˆ—è¡¨ç”¨ - + * ä»»ä½•ä¸€ç§éƒ½å¯ä»¥ï¼Œæ³¨æ„æ–‡å­—å‰åŠ ç©ºæ ¼\nç¤ºä¾‹ * åˆ—è¡¨1 * åˆ—è¡¨2 * åˆ—è¡¨3 åˆ—è¡¨1 åˆ—è¡¨2 åˆ—è¡¨3 æœ‰åºåˆ—è¡¨ æ•°å­—åŠ ç‚¹ï¼Œæ³¨æ„æ–‡å­—å‰åŠ ç©ºæ ¼ ç¤ºä¾‹ 1. åˆ—è¡¨1 2. åˆ—è¡¨2 3. åˆ—è¡¨3 åˆ—è¡¨1 åˆ—è¡¨2 åˆ—è¡¨3 å›¾æ ‡ æ–‡æ¡£å¼•ç”¨libraries: \u0026quot;mermaid\u0026quot;å¯ä»¥ç”¨é¥¼å›¾\npie \u0026#34;python\u0026#34; : 20 \u0026#34;shell\u0026#34; : 10 \u0026#34;go\u0026#34; : 70 è¡¨æ ¼ æ–‡å­—é»˜è®¤å±…å·¦\n-ä¸¤è¾¹åŠ ï¼šè¡¨ç¤ºæ–‡å­—å±…ä¸­\n-å³è¾¹åŠ ï¼šè¡¨ç¤ºæ–‡å­—å±…å³\nç¤ºä¾‹ è¡¨å¤´|è¡¨å¤´|è¡¨å¤´ ---|:--:|---: å†…å®¹|å†…å®¹|å†…å®¹ å†…å®¹|å†…å®¹|å†…å®¹ è¡¨å¤´ è¡¨å¤´ è¡¨å¤´ å†…å®¹ å†…å®¹ å†…å®¹ å†…å®¹ å†…å®¹ å†…å®¹ è¡¨æ ¼æ¢è¡Œ:åŠ \u0026lt;br\u0026gt;\nç¤ºä¾‹ è¡¨å¤´|è¡¨å¤´|è¡¨å¤´ ---|:--:|---: å†…å®¹|å†…å®¹ \u0026lt;br\u0026gt; å†…å®¹|å†…å®¹ å†…å®¹|å†…å®¹|å†…å®¹ è¡¨å¤´ è¡¨å¤´ è¡¨å¤´ å†…å®¹ å†…å®¹ å†…å®¹ å†…å®¹ å†…å®¹ å†…å®¹ å†…å®¹ åæ–œæ  ç”¨\\æ¥å®ç°è½¬ä¹‰å­—ç¬¦çš„æ•ˆæœ\nç¤ºä¾‹ \\\\ åæ–œçº¿ \\` åå¼•å· \\* æ˜Ÿå· \\_ åº•çº¿ \\{ å·¦èŠ±æ‹¬å· \\} å³èŠ±æ‹¬å· \\[ å·¦æ–¹æ‹¬å· \\] å³æ–¹æ‹¬å· \\ åæ–œçº¿\n` åå¼•å·\n* æ˜Ÿå·\n_ åº•çº¿\n{ å·¦èŠ±æ‹¬å·\n} å³èŠ±æ‹¬å·\n[ å·¦æ–¹æ‹¬å·\n] å³æ–¹æ‹¬å·\nè‡ªåŠ¨é“¾æ¥ è‡ªåŠ¨é“¾æ¥åªè¦æ˜¯ç”¨å°–æ‹¬å·åŒ…èµ·æ¥ï¼Œå°±ä¼šè‡ªåŠ¨è¢«è½¬æˆé“¾æ¥ã€‚ä¸€èˆ¬ç½‘å€çš„é“¾æ¥æ–‡å­—å°±å’Œé“¾æ¥åœ°å€ä¸€æ ·ã€‚\nå¦å¤–ä¸€ç§æ·»åŠ æè¿°çš„é“¾æ¥ç¤ºä¾‹å¦‚ä¸‹ï¼Œä¸æ˜¾ç¤ºé“¾æ¥åœ°å€\nç¤ºä¾‹ \u0026lt;https://zops.github.io\u0026gt; // æ·»åŠ æè¿°çš„é“¾æ¥ [Zops](https://zops.github.io \u0026#34;è¶…é“¾æ¥title\u0026#34;) https://zops.github.io\næ·»åŠ æè¿°çš„é“¾æ¥\nZops\nè­¦å‘Šé€šçŸ¥ æ¬¡æ ¼å¼åªé€‚åˆæœ¬åšå®¢ å®ä¾‹ {{\u0026lt; notice success \u0026ldquo;è¿™æ˜¯æˆåŠŸçš„é€šçŸ¥ç±»å‹\u0026rdquo; \u0026gt;}}\nsuccess, info, warning, error\nsuccess text\n{{\u0026lt; /notice \u0026gt;}}\næˆåŠŸç±»å‹é€šçŸ¥ success, info, warning, error\nsuccess text ä¿¡æ¯ç±»å‹é€šçŸ¥ success, info, warning, error\nsuccess text å‘Šè­¦ç±»å‹é€šçŸ¥ success, info, warning, error\nsuccess text ç¤ºä¾‹ {{\u0026lt; notice error \u0026ldquo;è¿™æ˜¯é€šçŸ¥çš„é”™è¯¯ç±»å‹\u0026rdquo; \u0026gt;}}\nsuccess, info, warning, error\nsuccess text\n{{\u0026lt; /notice \u0026gt;}}\nè¿™æ˜¯é€šçŸ¥çš„é”™è¯¯ç±»å‹\nsuccess, info, warning, error\nsuccess text å½©è‰²å‘Šè­¦æ–‡æœ¬æ¡†\nwarning, success, info, danger\nthis is a text warning, success, info, danger\nthis is a text warning, success, info, danger\nthis is a text\næ–‡ç« é“¾æ¥\nhttps://www.cnsre.cn/posts/210316100350/\n","description":"markdownçš„åŸºæœ¬ç”¨æ³•ï¼Œå¿«é€Ÿä¸Šæ‰‹markdownã€‚","id":91,"section":"posts","tags":["markdown","blog"],"title":"markdownçš„åŸºæœ¬ç”¨æ³•","uri":"http://www.cnsre.cn:80/posts/210316100350/"},{"content":"æŸ¥çœ‹ç£ç›˜ç©ºé—´ df -h æŸ¥çœ‹å¯ç”¨çš„å·ä¿¡æ¯ fdisk -l çœ‹åˆ°é™¤äº†/ ç£ç›˜çš„å¦å¤–ä¸€å—ç£ç›˜/dev/nvme1n1\nåˆå§‹åŒ–æ–°å· è¿™ä¸ªåœ°æ–¹éœ€è¦æ³¨æ„ä¸€ä¸‹ï¼Œ ç£ç›˜çš„æ ¼å¼ï¼Œ æ¯”å¦‚ xfsæœ‰çš„æ˜¯ext4 ext3\nmkfs -t xfs /dev/nvme1n1 æŸ¥çœ‹è®¾å¤‡UUID blkid å¼€æœºè‡ªåŠ¨æŒ‚è½½ vim /etc/fstab æŒ‚è½½å· mount /dev/nvme1n1 /home/bsh æ–‡ç« é“¾æ¥\nhttps://www.cnsre.cn/posts/210315133616/\n","description":"AWS æŒ‚è½½å¤šä¸ªç£ç›˜","id":92,"section":"posts","tags":["aws"],"title":"AWS EC2æŒ‚è½½å¤šä¸ªç£ç›˜","uri":"http://www.cnsre.cn:80/posts/210315133616/"},{"content":"è§£å†³aws ec2çš„centos7è®¾ç½®æ—¶åŒºæ— æ•ˆ è§£å†³åŠæ³• 1 yum upgrade tzdata -y åŸå› åˆ†æ 1 zdump -v /usr/share/zoneinfo/Asia/Shanghai æˆ‘ä»¬ä¼šå‘ç°æ—¶åŒºæ˜¯å›ºå®šä¸å˜çš„,æ— è®ºæˆ‘ä»¬é€šè¿‡ä¿®æ”¹ localtime è¿˜æ˜¯é€šè¿‡ timedatectl ä¿®æ”¹,éƒ½æ— æ•ˆ.\nç»è¿‡ä¸€ç•ªæœç´¢,æˆ‘å‘ç°æ˜¯ç”±äº tzdata æ•°æ®åº“è€æ—§å¯¼è‡´,å‡çº§å³å¯è§£å†³.\nå¦å¤–ä¹Ÿå¯ä»¥é€šè¿‡ TZ ç¯å¢ƒå˜é‡æ¥è®¾ç½®,è¿™æ˜¯æ“ä½œç³»ç»Ÿé»˜è®¤æ”¯æŒçš„æ–¹å¼.\nè®¾ç½®æ—¶åŒº 1 timedatectl set-timezone Asia/Shanghai æˆ–è€…\n1 ln -sf /usr/share/zoneinfo/Asia/Shanghai /etc/localtime è‡´è°¢ https://www.linuxquestions.org/questions/centos-111/centos7-invalid-offset-for-utc-for-sweden-says-utc-00-a-4175623431/\næ–‡ç« é“¾æ¥\nhttps://www.cnsre.cn/posts/210312112259/\n","description":"è§£å†³aws ec2çš„centos7è®¾ç½®æ—¶åŒºæ— æ•ˆ","id":93,"section":"posts","tags":["aws","centos7","è®¾ç½®æ—¶åŒº","æ•…éšœé›†"],"title":"AWSä¿®æ”¹EC2å®ä¾‹æ—¶é—´","uri":"http://www.cnsre.cn:80/posts/210312112259/"},{"content":"AWSä½¿ç”¨å¿«ç…§åˆ›å»ºå®ä¾‹å¯åŠ¨å¤±è´¥ é—®é¢˜æè¿° å› ä¸šåŠ¡éœ€æ±‚ï¼Œéœ€è¦å°†Aé›†ç¾¤å¤åˆ¶ä¸€ä»½åˆ°Bé›†ç¾¤ï¼Œå½“åšé¢„ç”Ÿäº§ç¯å¢ƒä½¿ç”¨ã€‚ä½†æ˜¯åœ¨AWSä½¿ç”¨å¿«ç…§çš„æ–¹å¼åˆ›å»ºEC2å®ä¾‹çš„æ—¶å€™æ— æ³•æ­£å¸¸å¯åŠ¨,é€šè¿‡è·å–AWS EC2æˆªå›¾èƒ½å¤Ÿçœ‹åˆ°å·²ç»åˆ°äº†ç™»å½•ç•Œé¢ã€‚\nåˆ†æè¿‡ç¨‹ åœ¨å‘ç°é—®é¢˜åå°è¯•ä½¿ç”¨SSMç™»å½•ï¼Œä½†æ˜¯å´æ— æ³•ç™»å½•è¿›ç³»ç»Ÿå†…éƒ¨ã€‚åå†åœæ­¢å®ä¾‹è¿è¡Œï¼Œç„¶ååœ¨è¿è¡Œå®ä¾‹ï¼Œä¾ç„¶æ— æ³•å¯åŠ¨ã€‚\nä¸ºäº†æ’æŸ¥æ˜¯VPCçš„é—®é¢˜ï¼Œè¿˜æ˜¯å®ä¾‹é•œåƒçš„é—®é¢˜ã€‚ä½¿ç”¨å¦å¤–ä¸€å°æœåŠ¡å™¨çš„é•œåƒå¯åŠ¨ï¼Œä½†æ˜¯ä¾ç„¶æ— æ•ˆã€‚æœ€ååœ¨å¾…å®ä¾‹è¿›å…¥ running çŠ¶æ€åï¼Œä¾æ¬¡é€‰æ‹© Actionsã€Instance Settingsã€Get System Logé€šè¿‡è·å–ç³»ç»Ÿæ—¥å¿—å‘ç°äº†ä¸€äº›é—®é¢˜ã€‚\nåæ¥åœ¨é€šè¿‡æŸ¥çœ‹æœåŠ¡å™¨çš„pyhtonç‰ˆæœ¬çš„æ—¶å€™å‘ç°\nåˆ°è¿™é‡Œï¼ŒåŸºæœ¬ä¸Šèƒ½ç¡®å®šæ˜¯pythonç‰ˆæœ¬çš„é—®é¢˜äº†ã€‚\næœ€åé€šè¿‡åˆ†ææ’æŸ¥å‘ç°æ˜¯å› ä¸ºç¯å¢ƒé…ç½®æ‰€å¯¼è‡´ã€‚\nLinux ç³»ç»Ÿé»˜è®¤çš„python2.7è¢«ä¿®æ”¹ä¸ºäº†python3.6.8 å¿«ç…§çš„æ¢å¤ä½¿ç”¨çš„åº”ç”¨æ˜¯Cloud-initï¼Œcould-initè°ƒç”¨çš„æ˜¯python ä¹Ÿå°±æ˜¯ç³»ç»Ÿé»˜è®¤çš„python2.7çš„ç‰ˆæœ¬ ä¹Ÿå°±å¯¼è‡´cloud-initè°ƒç”¨äº†python3.6.8çš„ç‰ˆæœ¬ã€‚ä»è€Œå¯¼å…¥é…ç½®å¤±è´¥ã€‚\nå…³äºcloud-initå¯å‚è€ƒ https://xixiliguo.github.io/post/cloud-init-1/\nè§£å†³æ–¹æ³• åœ¨/usr/bin/cloud-initä¸­ä¿®æ”¹#!/usr/bin/pythonä¸º #!/usr/bin/python2.7ç„¶åæ‰‹åŠ¨åˆ›å»ºå¿«ç…§ã€‚åœ¨ç”¨åˆ›å»ºçš„å¿«ç…§ä»æ–°å¯åŠ¨ä¸€å°æ–°çš„å®ä¾‹æ¥ã€‚\næœ€å ä¸ºäº†èƒ½å¤Ÿæ›´å¥½çš„è§£å†³è¿™ä¸ªé—®é¢˜ã€‚åæ¥é€šè¿‡å®é™…æµ‹è¯•ï¼Œcentos7ç³»ç»Ÿä¸­é»˜è®¤ä½¿ç”¨çš„pythonç‰ˆæœ¬ä¸ºpython2.7ï¼Œæˆ‘ä»¬é€šè¿‡ä½¿ç”¨yumå®‰è£…ï¼Œæ˜¯ä¸ä¼šè¦†ç›–æ‰ç³»ç»Ÿçš„pythonç‰ˆæœ¬ã€‚\n1 2 3 yum install python3 -y python --version Python 2.7.x æ‰€ä»¥å»ºè®®ï¼Œç³»ç»Ÿä¸­åŒæ—¶å­˜åœ¨ä¸¤ä¸ªpythonç‰ˆæœ¬ï¼Œæ‚¨ä½¿ç”¨yum å®‰è£…python3è¿™æ ·ä¸ä¼šè¦†ç›–ç³»ç»Ÿçš„pythonç‰ˆæœ¬ï¼Œåœ¨æ‚¨ä¸æƒ³ä½¿ç”¨ç³»ç»Ÿpython2.7.x è€Œä½¿ç”¨python3æ—¶ï¼Œæ‚¨ç›´æ¥åœ¨ç›¸åº”åº”ç”¨æŒ‡æ˜ä½¿ç”¨pythonçš„ç‰ˆæœ¬å³å¯ã€‚\nå¦‚æœå°†Centos7ä¸­ç³»ç»Ÿé»˜è®¤çš„pythonç‰ˆæœ¬ä¿®æ”¹ä¸ºpython3æ—¶ï¼Œè¿™ä¸ªå¯èƒ½ä¼šé‡åˆ°å„ç§å„æ ·çš„é—®é¢˜ã€‚\nä¸è¿‡python2.7 å·²ç»åœæ­¢ç»´æŠ¤äº†ï¼Œå¦‚æœä¸æƒ³ä½¿ç”¨python2.7ï¼Œç›®å‰å¯èƒ½åªèƒ½é€šè¿‡å‡çº§ç³»ç»Ÿçš„æ–¹å¼æ¥è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œcentos8å’Œredhat8ç³»ç»Ÿé»˜è®¤ä½¿ç”¨çš„pythonç‰ˆæœ¬éƒ½æ˜¯python3\næ–‡ç« é“¾æ¥\nhttps://www.cnsre.cn/posts/210311132723/\n","description":"AWSä½¿ç”¨å¿«ç…§åˆ›å»ºEC2å®ä¾‹åå¯åŠ¨å¤±è´¥ï¼ŒåŸå› åœ¨äºpythonç‰ˆæœ¬...","id":94,"section":"posts","tags":["aws","cloud-init","æ•…éšœé›†"],"title":"AWSä½¿ç”¨å¿«ç…§åˆ›å»ºå®ä¾‹å¯åŠ¨å¤±è´¥","uri":"http://www.cnsre.cn:80/posts/210311132723/"},{"content":"æ­¤é¡¹ç›®çš„ç‰¹ç‚¹æ˜¯æŠŠJenkinsä¸CodeDeployç›¸ç»“åˆåšçš„CICDåšçš„è“ç»¿å‘å¸ƒï¼ŒCIä¸CD æ˜¯åˆ†å¼€çš„ï¼ŒCIæ„å»ºå®Œä»¥åä»¥BuildNumberçš„å½¢å¼æŠŠwaråŒ…å­˜è‡³AWSçš„S3æ¡¶ä¸­ã€‚åŒæ—¶åœ¨javaé¡¹ç›®ä¸ŠæŠŠjavaä»£ç ä¸é…ç½®æ–‡ä»¶åˆ†ç¦»ï¼Œè¿™æ ·çš„è¯æˆ‘ä»¬å°±å¯ä»¥waråŒ…+ é…ç½®æ–‡ä»¶çš„å½¢å¼æŠŠé¡¹ç›®å‘å¸ƒè‡³æµ‹è¯•ã€é¢„ç”Ÿäº§ã€ç”Ÿäº§ç­‰ç¯å¢ƒã€‚åœ¨CDå‘å¸ƒçš„è¿‡ç¨‹ä¸­CodeDeployä¸­ç”¨åˆ°çš„æ˜¯ CodeDeployDefault.OneAtATime å¦‚æœæœ‰ä¸€å°å‘å¸ƒä»¥åå¥åº·æ£€æŸ¥å¤±è´¥ï¼Œåˆ™åœæ­¢å‘å¸ƒå¦å¤–ä¸€å°ï¼Œå¹¶å§è¯¥å°è®¾å¤‡ä»ALB ä¸­å‰”é™¤ã€‚\njenkinså‘å¸ƒæµç¨‹å¦‚ä¸‹å›¾\nç¯å¢ƒå‡†å¤‡ AWS å‡†å¤‡ åˆ›å»º IAM è§’è‰² æˆ‘è¿™è¾¹ç»™åˆ°jenkins è§’è‰²çš„æƒé™æ˜¯ CodeDeploy å’ŒS3 çš„æ‰€æœ‰æƒé™\nJenkinsCodeDeployProject\nIAM json\nCodeDeploy S3 1 2 3 4 5 6 7 8 9 10 11 12 13 { \u0026#34;Version\u0026#34;: \u0026#34;2012-10-17\u0026#34;, \u0026#34;Statement\u0026#34;: [ { \u0026#34;Effect\u0026#34;: \u0026#34;Allow\u0026#34;, \u0026#34;Action\u0026#34;: [ \u0026#34;codedeploy:*\u0026#34;, \u0026#34;s3:*\u0026#34; ], \u0026#34;Resource\u0026#34;: \u0026#34;*\u0026#34; } ] } 1 2 3 4 5 6 7 8 9 10 11 12 13 { \u0026#34;Version\u0026#34;: \u0026#34;2012-10-17\u0026#34;, \u0026#34;Statement\u0026#34;: [ { \u0026#34;Effect\u0026#34;: \u0026#34;Allow\u0026#34;, \u0026#34;Action\u0026#34;: [ \u0026#34;codedeploy:*\u0026#34;, \u0026#34;s3:*\u0026#34; ], \u0026#34;Resource\u0026#34;: \u0026#34;*\u0026#34; } ] } åˆ›å»ºEC2å®ä¾‹ å‡†å¤‡ä¸€å°EC2 éœ€è¦IAMè¦æ‹¥æœ‰CodeDeployå’ŒS3æƒé™çš„è§’è‰² ä¹Ÿå°±æ˜¯æˆ‘ä»¬åˆ›å»ºçš„IAMè§’è‰²\nLinux å‡†å¤‡ å®‰è£…jenkinsã€jdkã€mavenã€aws-cliã€git\nä»¥ä¸Šç¯å¢ƒå®‰è£…ä¸åšè¯¦ç»†è¯´æ˜ï¼Œ\nmvn å®‰è£… 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 cd /home/bsh/tools wget https://mirrors.cnnic.cn/apache/maven/maven-3/3.6.3/binaries/apache-maven-3.6.3-bin.tar.gz --no-check-certificate tar -zxvf apache-maven-3.6.3-bin.tar.gz mv apache-maven-3.6.3 /usr/local/maven ln -s /usr/local/maven/bin/mvn /usr/bin/mvn vim /etc/profile #æœ€ååŠ å…¥ä»¥ä¸‹å†…å®¹ ... ###################mvn######################## export MAVEN_HOME=/usr/local/maven export PATH=$MAVEN_HOME/bin:$PATH ... source /etc/profile vim /home/bsh/tools/maven/apache-maven/src/conf/settings.xml #æ‰¾åˆ°mirrors ä¿®æ”¹ä¸ºä»¥ä¸‹å†…å®¹ ... \u0026lt;mirrors\u0026gt; \u0026lt;mirror\u0026gt; \u0026lt;id\u0026gt;alimaven\u0026lt;/id\u0026gt; \u0026lt;mirrorOf\u0026gt;aliyun maven\u0026lt;/mirrorOf\u0026gt; \u0026lt;name\u0026gt;Human Readable Name for this Mirror.\u0026lt;/name\u0026gt; \u0026lt;url\u0026gt;http://maven.aliyun.com/nexus/content/groups/public/\u0026lt;/url\u0026gt; \u0026lt;/mirror\u0026gt; \u0026lt;/mirrors\u0026gt; ... mvn -version jenkinsã€jdkå®‰è£… å®‰è£…å¯å‚è€ƒ\nhttps://www.cnblogs.com/xuewenlong/p/12914876.html\naws-cli å¯å‚è€ƒ\nhttps://amazonaws-china.com/cn/cli/\njenkins æœ€æ–°å®‰è£…åŒ…\nhttps://mirrors.tuna.tsinghua.edu.cn/jenkins/war-stable/latest/jenkins.war\njenkins æ’ä»¶å‡†å¤‡ å®‰è£…æ’ä»¶çš„è¿‡ç¨‹ä¸å†ç»†è¯´\nArtifact Manager on S3\nAWS Global Configuration\nBitbucket Pipeline for Blue Ocean\nCopy Artifact Plugin\nNext Build Number Plugin\nJenkinsè®¾ç½® åœ¨æ’ä»¶å®‰è£…å®Œä»¥ååœ¨éƒ¨ç½²é¡¹ç›®ä¹‹å‰æˆ‘ä»¬éœ€è¦åšä¸€äº›è®¾ç½®\nBitbucket è®¾ç½® ç‚¹å‡»ç³»ç»Ÿè®¾ç½®\u0026ndash;æ‰“å¼€ç³»ç»Ÿé…ç½®\nç„¶åæ‰¾åˆ° Bitbucket ç«¯ç‚¹\u0026ndash; æ·»åŠ  Bitbucket server\næŒ‰éœ€å¡«å†™\u0026ndash; ç„¶åç‚¹å‡»ç®¡ç†hooks\u0026ndash;ç‚¹å‡»æ·»åŠ  æŒ‰éœ€å†™å…¥è‡ªå·±çš„Bitbucket è´¦å·å¯†ç \næœ€åä¿å­˜\nAWS S3 è®¾ç½® ç‚¹å‡»ç³»ç»Ÿè®¾ç½®\u0026ndash;æ‰“å¼€ç³»ç»Ÿé…ç½®\næ‰¾åˆ° Artifact Management for Builds\né€‰æ‹©Amazon S3 ç„¶åä¿å­˜\nåˆ†åˆ«å¡«å†™S3æ¡¶åç§°å’Œæ¡¶ä¸‹è¾¹çš„æ–‡ä»¶\nåˆ›å»ºä¸€ä¸ªæ–°çš„CI JOB æ–°åˆ›å»ºä¸€ä¸ªè‡ªç”±é£æ ¼çš„JOB æºç ç®¡ç† æŒ‰éœ€å¡«å…¥ URL\né€‰æ‹© Bitbucketçš„è´¦å·å¯†ç \nå†™å…¥åˆ†æ”¯\næ„å»ºç¯å¢ƒ æ„å»ºå‰åˆ é™¤å·¥ä½œç©ºé—´\næ„å»º é€‰æ‹©æ‰§è¡Œshell\nå†™å…¥jdkä»¥åŠmvnçš„å˜é‡\n1 2 3 export PATH=/home/bsh/tools/jdk1.8.0_221/bin:$PATH export PATH=/usr/local/maven/bin:$PATH mvn clean package -DskipTests æ„å»ºåçš„æ“ä½œ æ„å»ºåå½’æ¡£waråŒ…\nè¿™ä¸€æ­¥ä¹Ÿå°±æ˜¯æŠŠwaråŒ…å­˜è‡³S3æ¡¶ä¸­çš„ä¸€æ­¥\nç‚¹å‡»å¢åŠ æ„å»ºåæ“ä½œæ­¥éª¤\né€‰æ‹©å½’æ¡£æˆå“\nå¡«å…¥ä¹‹å‰é…ç½®S3æ¡¶ä¸­ä¸‹çš„ç›®å½•ä»¥åŠæ–‡ä»¶åç§°\næœ€åç­‰äºwaråŒ…å­˜åœ¨äº†S3çš„\nS3: /xxxxxx-xxxxx-xxxx/JenkinsCodeDeployProject/xxxx-CI-Artifact/1/artifacts/target/xxxxxxx.war\næœ€åå¯åˆ«å¿˜è®°ç‚¹å‡»ä¿å­˜äº† å“ˆå“ˆå“ˆ\næµ‹è¯•CIæ„å»ºjavaå·¥ç¨‹ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 Started by user xuewenlong Running as SYSTEM Building in workspace /root/.jenkins/workspace/Backend-CI-test [WS-CLEANUP] Deleting project workspace... [WS-CLEANUP] Deferred wipeout is used... The recommended git tool is: NONE ... è¿‡ç¨‹ç•¥ ... [INFO] ------------------------------------------------------------------------ [INFO] BUILD SUCCESS [INFO] ------------------------------------------------------------------------ [INFO] Total time: 19.375 s [INFO] Finished at: 2020-09-01T09:03:27Z [INFO] ------------------------------------------------------------------------ Archiving artifacts Uploaded 1 artifact(s) to https://cnsre.cn.s3.cn-north-1.amazonaws.com.cn/JenkinsCodeDeployProject/Backend-CI-test/13/artifacts/ Recording fingerprints Finished: SUCCESS æœ€åå¯ä»¥çœ‹åˆ°æ˜¯å·²ç»æ„å»ºå®Œæˆå¹¶ä¸”æŠŠwaråŒ…å­˜æ”¾åœ¨äº†S3ä¸­\nç™»å½•AWS S3 æŸ¥çœ‹éªŒè¯waråŒ… è¿™æ ·çš„è¯å¯ä»¥çœ‹åˆ°æ˜¯å·²ç»å®Œæˆäº†CI æ‰“åŒ…å½’æ¡£è‡³S3æ¡¶ä¸­ã€‚\nåˆ›å»ºä¸€ä¸ªæ–°çš„CD JOB Bitbucketä¸­åˆ›å»ºè„šæœ¬é…ç½®æ–‡ä»¶ç­‰ åœ¨åˆ›å»ºCD JOB ä¹‹å‰ æˆ‘ä»¬éœ€è¦åœ¨Bitbucketä¸­åˆ›å»ºä¸€äº›è„šæœ¬é…ç½®æ–‡ä»¶ç­‰\nä»¥xxxä¸ºä¾‹ç›®å½•ç»“æ„å¦‚ä¸‹\n1 2 3 4 5 6 7 8 9 10 # tree configuration-file-cicd/ configuration-file-cicd/ #Bitbucketæ–‡ä»¶å¤¹ â”œâ”€â”€ xxx #ä»¥é¡¹ç›®åˆ’åˆ†Bitbucketæ–‡ä»¶å¤¹ â”‚ â”œâ”€â”€ application-xxx-pilot.properties #xxxé¢„ç”Ÿäº§é…ç½®æ–‡ä»¶ â”‚ â”œâ”€â”€ application-xxx-prod.properties #xxxç”Ÿäº§é…ç½®æ–‡ä»¶ â”‚ â”œâ”€â”€ application-xxx-qa.properties #xxxæµ‹è¯•é…ç½®æ–‡ä»¶ â”‚ â”œâ”€â”€ appspec.yml #CodeDeploy é…ç½®æ–‡ä»¶ â”‚ â””â”€â”€ scripts #CodeDeployè°ƒç”¨çš„è„šæœ¬æ–‡ä»¶ â”‚ â”œâ”€â”€ apparchive.sh â”‚ â””â”€â”€ starttomcat.sh å…·ä½“å†…å®¹å±•ç¤º\né…ç½®æ–‡ä»¶ä¸å†å±•ç¤º\n1 2 3 4 5 6 7 8 9 10 11 12 13 # cat appspec.yml version: 0.0 os: linux files: - source: xxx.war destination: /home/bsh/tools/apache-tomcat-8.5.23/webapps - source: application-backend.properties destination: /home/bsh/tools/apache-tomcat-8.5.23/webapps hooks: BeforeInstall: - location: scripts/apparchive.sh ApplicationStart: - location: scripts/starttomcat.sh 1 2 3 4 [root@ip-10-0-20-89 scripts]# cat apparchive.sh #!/bin/bash mv -f /home/bsh/tools/apache-tomcat-8.5.23/webapps/bshrexxxcipes.war /home/bsh/backup/tomcatback/xxx.war.old mv -f /home/bsh/tools/apache-tomcat-8.5.23/webapps/application-xxx.properties /home/bsh/backup/tomcatback/application-xxx.properties.old 1 2 3 # cat starttomcat.sh #!/bin/bash -x sudo systemctl restart tomcat AWS CodeDeploy é…ç½® åœ¨AWS ä¸­æ‰¾åˆ°CodeDeploy æœåŠ¡\né€‰æ‹©åˆ›å»ºåº”ç”¨ç¨‹åº\nå†™å…¥åº”ç”¨ç¨‹åºåç§°ï¼Œå’ŒEC2/æœ¬åœ° ç‚¹å‡»åˆ›å»ºåº”ç”¨ç¨‹åº\né€‰æ‹©åˆšæ‰åˆ›å»ºçš„åº”ç”¨ç¨‹åº ç‚¹å‡»éƒ¨ç½²ç»„ é€‰æ‹©åˆ›å»ºéƒ¨ç½²ç»„\nä¾æ¬¡å¡«å…¥ç›¸å…³ä¿¡æ¯ã€‚è¿™ä¸ªæ˜¯è¦åœ¨jenkinsä¸­ç”¨åˆ°çš„\né€‰æ‹©æˆ‘ä»¬ä¸€å¼€å§‹åˆ›å»ºçš„IAM è§’è‰²\néƒ¨ç½²ç±»å‹é€‰æ‹©å°±åœ°ï¼ˆè¿™è¾¹çš„è“ç»¿éƒ¨ç½²çš„è¯è¦ç”¨åˆ°è‡ªåŠ¨æ‰©å±•è¿™ä¸ªå¯¹äºç›®å‰æˆ‘ä»¬çš„ä¸šåŠ¡æ¥è¯´æ¯”è¾ƒæµªè´¹è®¾å¤‡ï¼‰\né€‰æ‹©éœ€è¦å‘å¸ƒçš„EC2\néƒ¨ç½²æ–¹å¼ä¸ºä¸€å°ä¸€å°å‘å¸ƒ\nå¯ç”¨è´Ÿè½½å‡è¡¡ï¼Œå‘å¸ƒå¥½ä¸€å°ååšå¥åº·æ£€æŸ¥ï¼Œå¦‚æœå¥åº·æ£€æŸ¥ä¸é€šè¿‡åˆ™å‘å¸ƒåœæ­¢ã€‚\nåˆ›å»ºè‡ªç”±é£æ ¼çš„CD JOB General é€‰æ‹© å‚æ•°åŒ–æ„å»ºè¿‡ç¨‹ã€ç„¶åä¾æ¬¡å¡«å…¥ä¸€ä¸‹å†…å®¹\nBuildNumber æ˜¯CIæ„å»ºæ—¶çš„æ„å»ºæ•°å­—\nPackageName ä¸ºä½ çš„waråŒ…åç§°\næºç ç®¡ç† é€‰æ‹©GITï¼Œè¿™é‡Œçš„URLæ˜¯javaé¡¹ç›®é…ç½®æ–‡ä»¶çš„åœ°å€ é€‰æ‹©é…ç½®æ–‡ä»¶æ‰€åœ¨çš„åˆ†æ”¯æˆ‘è¿™è¾¹æ˜¯å­˜æ”¾åœ¨devåˆ†æ”¯\næ„å»ºç¯å¢ƒ æ„å»ºå‰åˆ é™¤å·¥ä½œç©ºé—´\næ„å»º é€‰æ‹©æ‰§è¡Œshell\nä½¿ç”¨aws cli å‘½ä»¤æŠŠS3ä¸­çš„waråŒ…æ‹¿ä¸‹æ¥\n1 2 3 4 5 6 #ä»S3æ¡¶ä¸­æ‹¿å–waråŒ… aws s3 cp s3://cnsre.cn/JenkinsCodeDeployProject/Backend-CI-Artifact/${BuildNumber}/artifacts/target/${PackageName} backend/ --region cn-north-1 --no-progress #è®°å½•ä½¿ç”¨ echo \u0026#34;${JOB_NAME}-${BUILD_NUMBER}-Test\u0026#34; \u0026gt; backend/versionfile #é…ç½®æ–‡ä»¶é‡å‘½å cp backend/application-backend-prod.properties backend/application-backend.properties æ„å»ºåæ“ä½œ ä¾æ¬¡å¡«å…¥CodeDeployä»¥åŠS3çš„é…ç½®ä¿¡æ¯\nåˆ°ç°åœ¨jenkins CD å·²ç»é…ç½®å®Œæˆ æ¥ä¸‹æ¥æµ‹è¯•ä¸‹å§\næµ‹è¯•CDå‘å¸ƒjavaå·¥ æŸ¥çœ‹ä¸Šæ¬¡CIæ„å»ºæˆåŠŸçš„waråŒ…\né€‰æ‹©éœ€è¦å‘å¸ƒçš„BuildNumber ä»¥åŠå¡«å†™java å·¥ç¨‹çš„waråŒ…åç§° ç„¶åç‚¹å‡»å¼€å§‹æ„å»º\nå› ä¸ºåœ¨codedeploy ä¸­é€‰æ‹©çš„æ˜¯ä¸€å°ä¸€å°å‘å¸ƒï¼Œå¹¶ä¸”å¯ç”¨çš„è´Ÿè½½å‡è¡¡ æ‰€ä»¥è¿™ä¸ªå‘å¸ƒçš„æ—¶é—´ä¼šæ¯”è¾ƒé•¿ï¼Œä¸€èˆ¬åœ¨10åˆ†é’Ÿä»¥ä¸Šï¼Œä½†æ˜¯è¿™ç§æ–¹å¼ä¹Ÿæ˜¯æ¯”è¾ƒé€‚åˆç”Ÿäº§ç¯å¢ƒçš„ï¼Œå› ä¸ºè¿™æ ·çš„æ–¹å¼æ˜¯ä¸åœæœºéƒ¨ç½²çš„æ–¹å¼ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 æ§åˆ¶å°è¾“å‡º Started by user SRE Running as SYSTEM Building in workspace /root/.jenkins/workspace/Backend-CD-Prod [WS-CLEANUP] Deleting project workspace... [WS-CLEANUP] Deferred wipeout is used... ... è¿‡ç¨‹ç•¥ ... Uploading zip to s3:/XXXXX/JenkinsCodeDeployProject/Backend-CD-Prod/PROD/#5-Backend-CD-Prod-5-Test.zip Registering revision for application \u0026#39;BackendCICD\u0026#39; Creating deployment with revision at {RevisionType: S3,S3Location: {Bucket: cnsre.cn,Key: JenkinsCodeDeployProject/Backend-CD-Prod/PROD/#5-Backend-CD-Prod-5-Test.zip,BundleType: zip,ETag: 5eb4e102812cc69f9c73084b06fdcfb1},} Finished: SUCCESS éªŒè¯CDéƒ¨ç½²javaå·¥ç¨‹ æœ€å¥½çš„éªŒè¯æ–¹æ³•å°±æ˜¯ç™»å½•æœåŠ¡å™¨æŸ¥çœ‹ä¸€ä¸‹\næˆ‘è¿™è¾¹å°±ä¸åšéªŒè¯äº†\næˆªæ­¢åˆ°æ­¤ jenkins é…åˆAWS codedeploy çš„ä¸åœæœºå‘å¸ƒå·²ç»å®Œæˆã€‚\næ–‡ç« é“¾æ¥\nhttps://www.cnsre.cn/posts/210310131550/\n","description":"Jenkinsä¸CodeDeployç›¸ç»“åˆåšçš„CICDåšçš„è“ç»¿å‘å¸ƒ,CIä¸CD æ˜¯åˆ†å¼€çš„.åŒæ—¶åœ¨javaé¡¹ç›®ä¸ŠæŠŠjavaä»£ç ä¸é…ç½®æ–‡ä»¶åˆ†ç¦».","id":95,"section":"posts","tags":["jenkins","aws","codedeploy"],"title":"jenkins AWS CodeDeployä¸åœæœºéƒ¨ç½²","uri":"http://www.cnsre.cn:80/posts/210310131550/"},{"content":"æœ¬æ–‡é“¾æ¥\nhttps://www.cnsre.cn/posts/210303161655/\nZabbixæ¶æ„ åœ¨è®²Zabbixä¼˜åŒ–ä¹‹å‰ï¼Œå…ˆæ¥çœ‹çœ‹Zabbix Server çš„é€»è¾‘æ¶æ„å›¾ï¼š\nå¯¹äºä¸Šå›¾ä¸­ï¼Œæ¶æ„ç»„ä»¶çš„æè¿°ï¼š\nZabbixè¿›ç¨‹ Self-Monitoringï¼šç”¨äºæ”¶é›†Zabbixç³»ç»Ÿå†…éƒ¨çš„ç›‘æ§ä¿¡æ¯ï¼› Configuration syncerï¼šç”¨äºå°†é…ç½®æ–‡ä»¶ä¸­çš„é…ç½®ä¿¡æ¯åŒæ­¥åˆ°å†…å­˜ä¸­ç¼“å­˜ï¼› Timerï¼šç”¨äºå¤„ç†è§¦å‘å™¨ä¸­ä¸æ—¶é—´ç›¸å…³çš„å‡½æ•°å’Œç»´æŠ¤æ¨¡å¼çš„è¿›ç¨‹ï¼› History syncerï¼šç”¨äºå†™å†å²æ•°æ®è¡¨çš„è¿›ç¨‹ï¼› Escalatorï¼šç”¨äºå¤„ç†Actionä¸­çš„æ­¥éª¤çš„è¿›ç¨‹ï¼› Housekeeperï¼šç”¨äºæ¸…ç†è¿‡æœŸçš„å†å²æ•°æ®çš„è¿›ç¨‹ï¼› Db watchdogï¼šç”¨äºç›‘è§†Zabbixç³»ç»Ÿçš„æ•°æ®åº“çŠ¶æ€ï¼Œå½“æ•°æ®åº“çŠ¶æ€å˜ä¸ºä¸å¯ç”¨æ—¶ï¼Œå‘é€è­¦å‘Šä¿¡æ¯ï¼ˆæœåŠ¡å™¨ä»£ç†ç«¯ä¸æ”¯æŒè¿™ç±»å‹è¿›ç¨‹ï¼‰ã€‚ Zabbix Poller Pollerï¼šç”¨äºæ™®é€šçš„è¢«åŠ¨ç›‘æ§é¡¹ç›®çš„è½®è¯¢ï¼› ICMP pingerï¼šç”¨äºå®šæœŸçš„è¿›è¡ŒICMP PINGæ£€æŸ¥ï¼› IPMI pollerï¼šç”¨äºå®šæœŸè¿›è¡ŒIPMIç›‘æ§é¡¹ç›®çš„æ£€æŸ¥; Unreachable pollerï¼šç”¨äºè½®è¯¢ä¸å¯è¾¾çš„è®¾å¤‡ï¼› Proxy pollerï¼šç”¨äºæœåŠ¡å™¨ä»£ç†çš„è¢«åŠ¨è½®è¯¢ï¼› Trapperï¼šç”¨äºå¤„ç†ä¸»åŠ¨é‡‡é›†ã€é™·å…¥ä»¥åŠåˆ†å¸ƒå¼èŠ‚ç‚¹é—´æˆ–æœåŠ¡å™¨ä»£ç†çš„é€šä¿¡ï¼› Java pollerï¼šç”¨äºè½®è¯¢Javaç›‘æ§é¡¹ç›®ï¼› Http pollerï¼šç”¨äºè½®è¯¢Webç±»çš„ç›‘æ§é¡¹ç›®ï¼› Snmp trapperï¼šç”¨äºè½®è¯¢Snmp/trapç±»çš„ç›‘æ§é¡¹ç›®ï¼› Discoveryï¼šç”¨äºè‡ªåŠ¨å‘ç°è®¾å¤‡çš„è¿›ç¨‹ï¼› Vmware Collectorï¼šè´Ÿè´£ä»VMwareæœåŠ¡è¿›ç¨‹ä¸­æ”¶é›†æ•°æ®ï¼ˆæœåŠ¡å™¨ä»£ç†ç«¯ä¸æ”¯æŒè¿™ç§ç±»å‹çš„è¿›ç¨‹ï¼‰ï¼› Alerterï¼šç”¨äºå‘é€æŠ¥è­¦é€šçŸ¥è¿›ç¨‹ã€‚ ä¼˜åŒ–å†…å®¹ ä¼˜åŒ–Zabbixæ¶æ„ å¸¸ç”¨çš„æ¶æ„ï¼š\nè¯´æ˜ï¼šZabbixæœ€ç®€å•çš„æ¶æ„ï¼Œå¸¸ç”¨äºç›‘æ§ä¸»æœºæ¯”è¾ƒå°‘çš„æƒ…å†µä¸‹ã€‚\nåˆ†å¸ƒå¼æ¶æ„ï¼š\nServer-Proxy-Agentdæ¨¡å¼ã€‚\nè¯´æ˜ï¼šZabbixåˆ†å¸ƒå¼æ¶æ„ï¼Œå¸¸ç”¨äºç›‘æ§ä¸»æœºæ¯”è¾ƒå¤šçš„æƒ…å†µä¸‹ï¼Œä½¿ç”¨Zabbix Proxyè¿›è¡Œåˆ†å¸ƒå¼ç›‘æ§ï¼Œæœ‰æ•ˆçš„å‡è½»äº†Zabbix Serverç«¯çš„å‹åŠ›ã€‚\nZabbix Server/Zabbix Proxyé…ç½®ä¼˜åŒ– è°ƒæ•´é…ç½®æ–‡ä»¶ï¼šZabbix_Server.conf\nZabbixè¿›ç¨‹å‚æ•°è°ƒæ•´ï¼š\n1 2 3 4 5 6 StartPollers=80 StartPingers=10 StartPollersUnreachable=80 StartIPMIPollers=10 StartTrappers=20 StartDBSyncers=8 å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œå½“Zabbixçš„Pollersæ•°é‡è¿‡å¤šæ—¶ï¼ˆè¶…è¿‡limité»˜è®¤å€¼1024ï¼‰ï¼Œéœ€è¦å¯¹ç³»ç»Ÿçš„limitçš„å‚æ•°å¤§å°è¿›è¡Œä¿®æ”¹ã€‚\n1 2 3 4 5 shell\u0026gt; vi /etc/security/limit.conf * hard nofile 65536 * soft nofile 65536 * hard nproc 65536 * soft nproc 65536 Zabbix In-Memory Cacheå‚æ•°ä¼˜åŒ–ï¼ˆä»¥ä¸‹å€¼ä»…åšå‚è€ƒï¼‰ï¼š\nValueCacheSize=256M HistoryIndexCacheSize = 64M TrendCacheSize=64M HistoryCacheSize=128M CacheSize=128M VMwareCacheSize=64M ä¼˜åŒ–Zabbixçš„æ•°æ®åº“ï¼ˆMySQLï¼‰ è°ƒæ•´MySQLé…ç½®æ–‡ä»¶ï¼šmy.cnfæˆ–my.iniï¼Œåœ¨[mysqld]é…Œæƒ…ä¿®æ”¹å‚æ•°ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 [client] port = 3306 socket = /var/lib/mysql/mysql.sock [mysql] prompt=\u0026#34;\\u@mysqldb \\R:\\m:\\s [\\d]\u0026gt; \u0026#34; no-auto-rehash [mysqld] user= mysql port = 3306 datadir = /data/mysql/ socket = /var/lib/mysql/mysql.sock pid-file = mysqldb.pid character-set-server = utf8mb4 skip_name_resolve = 1 # Timestamp explicit_defaults_for_timestamp = 1 # Connections back_log = 1024 max_connections = 512 max_connect_errors = 5120 innodb_thread_concurrency = 16 # Limit open_files_limit = 65535 innodb_open_files = 65535 # Query Cache query_cache_type = 0 query_cache_size = 0 # binary logs server-id = 3306001 binlog_format = row log-bin = /data/mysql/mysql-binlog expire_logs_days = 7 sync_binlog = 1 max_binlog_size = 1G binlog_cache_size = 4m max_binlog_cache_size = 1G # slow query slow_query_log = 1 long_query_time = 2 slow_query_log_file = /data/mysql/slow.log # Timeout interactive_timeout = 600 wait_timeout = 600 # Engine default-storage-engine = innodb # Buffer key_buffer_size = 32M read_buffer_size = 1M sort_buffer_size = 1M read_rnd_buffer_size = 1M tmp_table_size = 32M join_buffer_size = 16M max_heap_table_size = 32M max_tmp_tables = 48 thread_cache_size = 32 # Time log_timestamps = SYSTEM # Tablespace \u0026amp; File I/O innodb_data_file_path = ibdata1:1G:autoextend innodb_file_per_table = 1 # Redo Log innodb_flush_log_at_trx_commit = 1 innodb_log_file_size = 256M innodb_log_files_in_group = 2 innodb_log_buffer_size = 16M # Innodb innodb_buffer_pool_size = 8G innodb_buffer_pool_instances = 8 innodb_flush_method = O_DIRECT innodb_change_buffer_max_size = 50 innodb_max_dirty_pages_pct = 30 innodb_buffer_pool_load_at_startup = 1 innodb_buffer_pool_dump_at_shutdown = 1 innodb_io_capacity = 500 innodb_io_capacity_max= 1000 innodb_support_xa = 0 innodb_rollback_on_timeout = 1 ä¼˜åŒ–Zabbixç›‘æ§é¡¹ ä¼˜åŒ–ç›‘æ§é¡¹çš„æ•°æ®é‡‡é›†æ–¹å¼ï¼Œç”±è¢«åŠ¨æ–¹å¼æ”¹ä¸ºä¸»åŠ¨æ¨¡å¼(Passive mode -\u0026gt; Active mode)ï¼Œä¸»åŠ¨æ¨¡å¼çš„ä¼˜åŠ¿ï¼š\nå¯ä»¥ç”¨æˆ·NATåˆ°è®¾å¤‡åé¢ï¼› æ•°æ®ç¼“å†²ï¼› å‡è½»æœåŠ¡å™¨çš„è´Ÿè½½ï¼ŒPollerè½®è¯¢é›¶è´Ÿè½½ï¼› æ›´åŠ å®‰å…¨ï¼Œä»£ç†ç«¯ä¸éœ€è¦ç›‘æµ‹ä»»ä½•ç«¯å£ã€‚ é™ä½ç›‘æ§é¡¹çš„è½®è¯¢æ—¶é—´ï¼› åˆ é™¤æ— ç”¨çš„ç›‘æ§é¡¹ã€‚\næœ¬æ–‡é“¾æ¥\nhttps://www.cnsre.cn/posts/210303161655/\nåŸæ–‡é“¾æ¥ ","description":"Zabbixç³»ç»Ÿåˆ°åº•è¯¥å¦‚ä½•ä¼˜åŒ–ï¼Ÿè‡ªå®šä¹‰ç›‘æ§æ¨¡æ¿ï¼›è°ƒä¼˜æ•°æ®åº“ä»¥è·å¾—æœ€ä½³æ€§èƒ½ï¼›è°ƒä¼˜Zabbix Serveré…ç½®ï¼›æ ¹æ®ç¡¬ä»¶çš„è§„æ ¼è®¾ç½®åˆç†çš„HouseKeeperï¼›ä½¿ç”¨æœ€æ–°çš„ï¼Œå¹¶ä¸”ç¨³å®šçš„ç‰ˆæœ¬ï¼›å¯¹Zabbixæ•°æ®åº“è¿›è¡Œè¡¨åˆ†åŒºï¼›ä¼˜åŒ–Zabbixçš„æ¶æ„","id":96,"section":"posts","tags":["zabbix"],"title":"Zabbix ç³»ç»Ÿåˆ°åº•åº”è¯¥æ€æ ·ä¼˜åŒ–ï¼Ÿ","uri":"http://www.cnsre.cn:80/posts/210303161655/"},{"content":"ğŸ“¢ å¿«æ¥ç•™è¨€å‘è¡¨ä½ çš„çœ‹æ³•å§~\n","description":"ç•…æ‰€æ¬²è¨€","id":97,"section":"","tags":null,"title":"ç•™è¨€","uri":"http://www.cnsre.cn:80/comment/"},{"content":"2020å¹´å‰ 2020å¹´å‰ä¸€ç›´éƒ½ä½¿ç”¨æœ‰é“äº‘ç¬”è®°æ¥ç¼–å†™è®°å½•æ–‡æ¡£ã€‚\n2020å¹´ 2020-04 2020-04-28 å…¥ä½åšå®¢å›­ï¼Œå‘å¸ƒ80å¤šç¯‡æ–‡ç« ç¬”è®°ã€‚\n2020-08 2020-08-03 æ­å»º Wordpress ç«™ç‚¹ã€‚\n2021å¹´ 2021-02 2021-02-04 è´­å…¥åŸŸå cdops.cnã€‚\næ”¾å¼ƒ wordpress å¼€å§‹ä½¿ç”¨ hugo æ­å»ºä¸ªäººåšå®¢ã€‚\n2021-03 2021-03-01 è´­å…¥åŸŸå cnsre.cnï¼Œzsre.cnã€‚\n2021-03-08 åšå®¢è°ƒæ•´å®Œæ¯•ï¼ŒSREè¿ç»´åšå®¢ æ­£å¼ä¸Šçº¿ã€‚\n2021-03-17 åšå®¢é¦–é¡µ SREè¿ç»´åšå®¢ è¢«ç™¾åº¦é¦–æ¬¡æ”¶å½•ã€‚\n2021-03-17 å¢åŠ åšå®¢ æ—¶é—´çº¿ åŠŸèƒ½ã€‚\n2021-03-31 å¢å¼ºåšå®¢è¯„è®ºåŠŸèƒ½ã€‚\n2021-07 2021-07-07 åšå®¢è½¬å…¥å›½å†…å¹¶å¤‡æ¡ˆæˆåŠŸã€‚\n2021-07-23 å‡çº§ hugo v0.79.0 è‡³ v0.85.0ã€‚\n2021-09 2021-09-24 æ”¹ç‰ˆåšå®¢ æ—¶é—´çº¿åŠŸèƒ½ã€‚\n2021-09-25 åšå®¢åŠ å…¥ CDN åŠŸèƒ½ã€‚\n2021-11 2021-11-11 åšå®¢è¿ç§»è‡³ kubernetesï¼Œå¹¶ä½¿ç”¨ jenkins è‡ªåŠ¨æ„å»ºã€‚\n2021-11-25 ä¸ªäººç½‘ç›˜ SREç½‘ç›˜ ä¸Šçº¿ã€‚\n2022-03 2022-03-04 åšå®¢è¯„è®ºç³»ç»Ÿ Valine åˆ‡æ¢è‡³ Walineã€‚\n2022-03-07 åšå®¢è¯„è®ºæ•°æ®è¿ç§»å®Œæˆã€‚\nä¼˜åŒ–åšå®¢éƒ¨åˆ†ç‰¹æ•ˆï¼šé¼ æ ‡ç‚¹å‡»ç‰¹æ•ˆã€é¡¶éƒ¨è·‘é©¬ç¯ç­‰ã€‚\n","description":"å…³äºSREè¿ç»´åšå®¢,SREè¿ç»´åšå®¢æ—¶é—´çº¿,SREè¿ç»´åšå®¢å†å²,SREè¿ç»´åšå®¢æ˜¯ä¸€ä¸ªä¸“æ³¨äºSREã€DevOpsã€è‡ªåŠ¨åŒ–è¿ç»´ã€Kubernetesã€Dockerçš„ä¸ªäººè¿ç»´åšå®¢ã€‚åšå®¢ä¸»è¦æœ‰ç³»ç»Ÿè¿ç»´ã€è„šæœ¬ç¼–ç¨‹ã€ç›‘æ§ã€devopsç­‰å†…å®¹ï¼Œæœ¬ç«™æ¶µç›–Linuxç³»ç»Ÿè¿ç»´ã€è‡ªåŠ¨åŒ–è¿ç»´ã€ç›‘æ§ã€è„šæœ¬ã€å®¹å™¨ã€è¿ç»´ç»éªŒã€äº‘è®¡ç®—ã€è™šæ‹ŸåŒ–ç­‰å†…å®¹ã€‚","id":98,"section":"","tags":null,"title":"SREè¿ç»´åšå®¢æ—¶é—´çº¿","uri":"http://www.cnsre.cn:80/timeline/"},{"content":"ğŸ‘‹å—¨ ï¼Œæ¬¢è¿æ¥åˆ°SREè¿ç»´åšå®¢ç½‘ç«™ï¼æˆ‘æ˜¯ä¸€åSREè¿ç»´å·¥ç¨‹å¸ˆï¼Œæ‹¥æœ‰å¤šå¹´çš„äº‘å¹³å°ä½¿ç”¨å’Œç³»ç»Ÿæ¶æ„è®¾è®¡ç»éªŒï¼Œæ“…é•¿ä½¿ç”¨å„ç§äº‘è®¡ç®—æŠ€æœ¯å’Œå·¥å…·è§£å†³æ•…éšœé—®é¢˜ï¼Œä¿è¯ç³»ç»Ÿçš„ç¨³å®šæ€§å’Œå¯ç”¨æ€§ã€‚åœ¨è¿™é‡Œï¼Œæˆ‘å°†ä¸å¤§å®¶åˆ†äº«æˆ‘çš„è¿ç»´ç»éªŒå’ŒæŠ€æœ¯ã€‚\nå…³äºåšä¸» ä½œä¸ºä¸€åè¿ç»´å·¥ç¨‹å¸ˆï¼Œæˆ‘æ‹¥æœ‰ä¸°å¯Œçš„äº‘å¹³å°ä½¿ç”¨ç»éªŒï¼ŒåŒ…æ‹¬ AWSã€é˜¿é‡Œäº‘ã€è…¾è®¯äº‘ç­‰ã€‚æˆ‘ç†Ÿç»ƒæŒæ¡å„ç§äº‘è®¡ç®—æŠ€æœ¯å’Œå·¥å…·ã€‚æ­¤å¤–ï¼Œæˆ‘è¿˜å…·å¤‡å¿«é€Ÿè§£å†³æ•…éšœé—®é¢˜çš„èƒ½åŠ›ï¼Œå¹¶èƒ½å¤Ÿä½¿ç”¨ç›‘æ§å’Œè‡ªåŠ¨åŒ–å·¥å…·ä¿è¯ç³»ç»Ÿçš„ç¨³å®šæ€§å’Œå¯ç”¨æ€§ã€‚\nåœ¨è¿ç»´æ–¹é¢ï¼Œæˆ‘å…·æœ‰ä¼˜ç§€çš„ç³»ç»Ÿæ¶æ„è®¾è®¡èƒ½åŠ›ï¼Œèƒ½å¤Ÿå®æ–½é«˜å¯ç”¨ã€é«˜æ•ˆç‡çš„äº‘è¿ç»´ç¯å¢ƒã€‚å¦å¤–ï¼Œæˆ‘è¿˜å…·å¤‡è‰¯å¥½çš„å›¢é˜Ÿåä½œèƒ½åŠ›å’Œæ²Ÿé€šèƒ½åŠ›ï¼Œèƒ½å¤Ÿä¸å¼€å‘äººå‘˜ã€é¡¹ç›®ç»ç†ç­‰å›¢é˜Ÿæˆå‘˜åè°ƒé…åˆã€‚\nğŸ§° å¸¸ç”¨çš„å·¥å…·\nå…³äºåšå®¢ æˆ‘çš„åšå®¢æ˜¯æˆ‘åœ¨è¿ç»´é¢†åŸŸçš„ç»éªŒæ€»ç»“å’ŒæŠ€æœ¯åˆ†äº«çš„å¹³å°ã€‚åšå®¢æ¡†æ¶æ˜¯åŸºäºHugo v0.85.0æ„å»ºï¼Œç›®å‰è¿è¡Œåœ¨Kubernetesä¸Šï¼Œå¹¶ä½¿ç”¨Hugo ä¸»é¢˜ Zzoã€‚\nåšå®¢æœ€åˆæ˜¯åŸºäºGitHub Pagesåˆ›å»ºçš„ï¼Œä½†ç”±äºå›½å†…è®¿é—®è¾ƒæ…¢ï¼Œæˆ‘ä½¿ç”¨äº†GitHub Pages + Vercel + Cloudflareçš„æ–¹å¼ï¼Œå¹¶è´­ä¹°äº†åŸŸåå¤‡æ¡ˆåˆ°äº†å›½å†…ï¼Œå¹¶ä½¿ç”¨å›½å†…çš„æœåŠ¡å™¨ã€‚\nåšå®¢å‘å±•å†å²å¦‚ä¸‹ï¼š\n2020å¹´04æœˆï¼šå…¥ä½åšå®¢å›­ï¼Œå‘å¸ƒ80å¤šç¯‡æ–‡ç« ç¬”è®°ã€‚ 2020å¹´08æœˆï¼šæ­å»º Wordpress ç«™ç‚¹ã€‚ 2021å¹´02æœˆï¼šè´­å…¥åŸŸåcdops.cnï¼Œæ”¾å¼ƒwordpresså¼€å§‹ä½¿ç”¨hugoæ­å»ºä¸ªäººåšå®¢ã€‚ 2021å¹´03æœˆï¼šè´­å…¥åŸŸåcnsre.cnï¼Œzsre.cnï¼Œå¹¶æ­£å¼ä¸Šçº¿SREè¿ç»´åšå®¢ã€‚ 2021å¹´03æœˆï¼šåšå®¢é¦–é¡µè¢«ç™¾åº¦é¦–æ¬¡æ”¶å½•ï¼Œå¢åŠ åšå®¢æ—¶é—´çº¿åŠŸèƒ½ï¼Œå¢å¼ºåšå®¢è¯„è®ºåŠŸèƒ½ã€‚ 2021å¹´07æœˆï¼šåšå®¢è½¬å…¥å›½å†…å¹¶å¤‡æ¡ˆæˆåŠŸï¼Œå‡çº§hugoè‡³ v0.85.0ã€‚ 2021å¹´09æœˆï¼šæ”¹ç‰ˆåšå®¢æ—¶é—´çº¿åŠŸèƒ½ï¼Œåšå®¢åŠ å…¥CDNåŠŸèƒ½ã€‚ 2021å¹´11æœˆï¼šåšå®¢è¿ç§»è‡³kubernetesï¼Œå¹¶ä½¿ç”¨jenkinsè‡ªåŠ¨æ„å»ºã€‚ä¸ªäººç½‘ç›˜SREç½‘ç›˜ä¸Šçº¿ã€‚ 2022å¹´03æœˆï¼šåšå®¢è¯„è®ºç³»ç»ŸValineåˆ‡æ¢è‡³Walineï¼Œä¼˜åŒ–åšå®¢éƒ¨åˆ†ç‰¹æ•ˆï¼ŒåŒ…æ‹¬é¼ æ ‡ç‚¹å‡»ç‰¹æ•ˆå’Œé¡¶éƒ¨è·‘é©¬ç¯ç­‰ã€‚ 2023å¹´02æœˆï¼šåšå®¢ä¸Šçº¿Chat-GPT WEB ç‰ˆæœ¬ã€‚ 2023å¹´05æœˆï¼šæ›´æ–°ç•™ç•™è¨€æ¿é¡µé¢ã€‚ ","description":"SREè¿ç»´åšå®¢ç½‘ç«™çš„ç‰¹ç‚¹å’Œä¼˜åŠ¿ä»‹ç»ã€‚åšä¸»çš„ä¸ªäººç®€ä»‹å’ŒèƒŒæ™¯ä»‹ç»ï¼Œå¸®åŠ©è¯»è€…æ›´å¥½äº†è§£åšä¸»ã€‚","id":99,"section":"","tags":null,"title":"SREè¿ç»´åšå®¢ç½‘ç«™ä»‹ç»","uri":"http://www.cnsre.cn:80/about/"},{"content":"å‹é“¾ç”³è¯·è¯´æ˜ æœ¬ç«™å±äºç½‘ç»œèµ„æºåˆ†äº«ã€æŠ€æœ¯äº¤æµç«™ç‚¹ï¼Œæ¬¢è¿ç«™é•¿ä»¬ç”³è¯·å‹é“¾æ·»åŠ ï¼ å‹é“¾ç”³è¯·ä¼˜å…ˆäºæŠ€æœ¯åˆ†äº«ç±»åšå®¢ç«™ç‚¹å‹é“¾ã€‚ ç”³è¯·é“¾æ¥å‰è¯·å…ˆæ·»åŠ æœ¬åšé“¾æ¥ã€‚ ä¸å®šæ—¶è¿›è¡Œå›è®¿å‹é“¾ã€‚ å¦‚é‡åˆ°é•¿æ—¶é—´æ— å“åº”æˆ–æ¶‰åŠè¿è§„å†…å®¹å°†ç»ˆæ­¢å‹é“¾ï¼Œç†Ÿä¸å¦è¡Œé€šçŸ¥! ç”³è¯·å‹é“¾ï¼Œè¯·åœ¨æœ¬ç«™ ç•™è¨€æ¿ ä¸­ç•™è¨€å†…å®¹æ ¼å¼å¦‚ä¸‹ï¼š ç½‘ç«™åç§°ï¼šSREè¿ç»´åšå®¢\nç½‘ç«™åœ°å€ï¼šwww.cnsre.cn\nç½‘ç«™è¯´æ˜ï¼šä¸“æ³¨SREè¿ç»´æŠ€æœ¯åˆ†äº«çš„åšå®¢\nç½‘ç«™Logoï¼šhttps://www.cnsre.cn/favicon.ico\nå‹æƒ…é“¾æ¥ ","description":"","id":100,"section":"","tags":null,"title":"å‹æƒ…é“¾æ¥","uri":"http://www.cnsre.cn:80/friends/"}]